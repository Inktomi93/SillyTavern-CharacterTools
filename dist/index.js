(()=>{"use strict";const e="character_tools",t="1.0.0",n=Object.freeze([{key:"description",label:"Description",scoreable:!0},{key:"personality",label:"Personality",scoreable:!0},{key:"first_mes",label:"First Message",scoreable:!0},{key:"scenario",label:"Scenario",scoreable:!0},{key:"mes_example",label:"Example Messages",scoreable:!0},{key:"system_prompt",label:"System Prompt",scoreable:!0},{key:"post_history_instructions",label:"Post-History Instructions",scoreable:!1},{key:"creator_notes",label:"Creator Notes",scoreable:!1}]),r=Object.freeze(["score","rewrite","analyze"]),s={score:"Score",rewrite:"Rewrite",analyze:"Analyze"},i={score:"fa-star-half-stroke",rewrite:"fa-pen-fancy",analyze:"fa-magnifying-glass-chart"},a="You are a creative writing assistant specializing in character development for roleplay and fiction. Analyze character cards and provide thoughtful, actionable feedback.\n\nAdapt your response style to the task:\n- For scoring: Be critical but fair, rate 1-10 with specific justifications\n- For rewrites: Preserve the character's core identity while improving weak areas\n- For analysis: Compare versions objectively, identify what was lost or gained\n- For refinement: Address specific issues from analysis while keeping improvements\n\nFocus on: writing quality, character depth, consistency, roleplay usability, and potential issues (contradictions, clichés, underdeveloped areas).\n\nAlways maintain the character's essential personality and unique traits. Improvements should enhance, not replace, what makes the character interesting.",o="You are refining a character card rewrite based on analysis feedback.\n\n## Original Character (Ground Truth)\n{{original_character}}\n\n## Current Rewrite (Iteration {{iteration_number}})\n{{current_rewrite}}\n\n## Analysis of Current Rewrite\n{{current_analysis}}\n\n{{#if score_results}}\n## Original Score Feedback (Reference)\n{{score_results}}\n{{/if}}\n\n---\n\n## Your Task\n\nCreate an improved version that:\n\n1. **Addresses Issues**: Fix the specific problems identified in the analysis\n2. **Preserves Wins**: Keep what the analysis said was working well\n3. **Maintains Soul**: The character must still feel like the original, just better\n4. **Avoids Regression**: Don't reintroduce problems that were already fixed\n\nOutput the complete refined character card with all fields. Mark significantly changed sections with [REFINED] at the start.\n\nDo NOT explain your changes - just output the improved character card.",c=Object.freeze([{id:"builtin_score_default",name:"Default Score",stages:["score"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Rate this character card on a scale of 1-10 for each populated field. For each field, provide:\n\n1. **Score** (1-10)\n2. **Strengths** - What works well\n3. **Weaknesses** - What needs improvement\n4. **Specific Suggestions** - Concrete changes to improve it\n\nAfter scoring all fields, provide:\n- **Overall Score** (weighted average, with First Message and Description weighted higher)\n- **Top 3 Priority Improvements** - The changes that would have the biggest impact\n- **Summary** - A brief overall assessment\n\nBe critical but constructive. Vague praise is useless. Specific, actionable feedback is gold."},{id:"builtin_score_quick",name:"Quick Score",stages:["score"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Give a quick assessment of this character card:\n\n1. Overall score (1-10)\n2. Three biggest strengths\n3. Three areas needing work\n4. One-sentence summary\n\nKeep it concise but useful."},{id:"builtin_rewrite_default",name:"Default Rewrite",stages:["rewrite"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Based on the scoring feedback, rewrite this character card to address the identified weaknesses while preserving its strengths.\n\nGuidelines:\n- Maintain the character's core personality and unique traits\n- Improve weak areas identified in the score\n- Keep the same general length unless brevity/expansion was specifically noted\n- Preserve any distinctive voice or style that works\n- Fix contradictions and fill gaps\n- Make the character more engaging for roleplay\n\nOutput the complete rewritten character card with all fields, using the same field structure as the original. Mark significantly changed sections with [REVISED] at the start.\n\n{{score_results}}"},{id:"builtin_rewrite_conservative",name:"Conservative Rewrite",stages:["rewrite"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Make minimal, surgical improvements to this character card. Only change what's clearly broken or weak.\n\nRules:\n- Change as little as possible\n- Preserve the author's voice completely\n- Only fix obvious issues (contradictions, grammar, clarity)\n- Do NOT add new content unless filling a critical gap\n- Do NOT change style or tone\n\nOutput only the fields you changed, with [ORIGINAL] and [REVISED] versions for comparison.\n\n{{score_results}}"},{id:"builtin_rewrite_expansive",name:"Expansive Rewrite",stages:["rewrite"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Significantly expand and enhance this character card. Add depth, detail, and richness.\n\nGoals:\n- Flesh out underdeveloped areas\n- Add sensory details and specific examples\n- Deepen personality with quirks, contradictions, history\n- Improve example messages with more variety\n- Make the character feel more three-dimensional\n\nDon't change the core concept, but make it shine. Output the complete expanded character card.\n\n{{score_results}}"},{id:"builtin_analyze_default",name:"Default Analyze",stages:["analyze"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:'Compare the original character card with the rewritten version. Analyze:\n\n## What Was Preserved\n- Core personality traits that remained intact\n- Distinctive elements that were kept\n- Voice and style consistency\n\n## What Was Lost\n- Any personality aspects that were diminished or removed\n- Unique quirks that disappeared\n- Tone shifts that changed the character\'s feel\n\n## What Was Gained\n- New depth or detail added\n- Improvements that enhance the character\n- Better clarity or consistency\n\n## Soul Check\nDoes the rewritten version still feel like the same character? Rate the "soul preservation" from 1-10 and explain.\n\n## Verdict\nState clearly: **ACCEPT** (ready to use), **NEEDS REFINEMENT** (good progress but has issues), or **REGRESSION** (worse than before).\n\n## Specific Issues to Address\nIf verdict is NEEDS REFINEMENT, list the specific problems that should be fixed in the next iteration.\n\n---\n\n### Original Character:\n{{original_character}}\n\n### Rewritten Version:\n{{rewrite_results}}\n\n### Score Feedback:\n{{score_results}}'},{id:"builtin_analyze_iteration",name:"Iteration Analyze",stages:["analyze"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"This is iteration {{iteration_number}} of refinement. Compare the current rewrite against the original.\n\n## Progress Check\n- What issues from previous analysis were addressed?\n- What new issues (if any) were introduced?\n- Is this version better, worse, or lateral move from the last?\n\n## Current State Assessment\n\n### Preserved from Original\nCore traits and elements that remain intact.\n\n### Still Missing or Lost\nThings from the original that should be restored.\n\n### Successfully Improved\nWhat's genuinely better now.\n\n### New Problems\nAny issues introduced by this iteration.\n\n## Soul Preservation Score\nRate 1-10: Does this still feel like the original character?\n\n## Verdict\n**ACCEPT** - Ready to use, no more iterations needed\n**NEEDS REFINEMENT** - Making progress, but specific issues remain\n**REGRESSION** - This iteration made things worse, consider reverting\n\n## Next Steps\nIf NEEDS REFINEMENT: List exactly what the next iteration should fix.\nIf REGRESSION: Explain what went wrong and what to preserve from previous version.\n\n---\n\n### Original Character:\n{{original_character}}\n\n### Current Rewrite (Iteration {{iteration_number}}):\n{{rewrite_results}}"},{id:"builtin_analyze_quick",name:"Quick Analyze",stages:["analyze"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Quick comparison of original vs rewrite:\n\n1. Soul preserved? (Yes/Partially/No)\n2. Best improvement made\n3. Biggest thing lost (if any)\n4. Verdict: ACCEPT / NEEDS REFINEMENT / REGRESSION\n\n{{original_character}}\n\n{{rewrite_results}}"},{id:"builtin_freeform",name:"Freeform",stages:[],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"[Enter your custom instructions here]"}]),l=Object.freeze([{id:"builtin_schema_score",name:"Default Score",stages:["score"],isBuiltin:!0,createdAt:0,updatedAt:0,schema:{name:"CharacterScore",strict:!0,value:{$schema:"http://json-schema.org/draft-04/schema#",type:"object",additionalProperties:!1,properties:{fieldScores:{type:"array",items:{type:"object",additionalProperties:!1,properties:{field:{type:"string"},score:{type:"number"},strengths:{type:"string"},weaknesses:{type:"string"},suggestions:{type:"string"}},required:["field","score","strengths","weaknesses","suggestions"]}},overallScore:{type:"number"},priorityImprovements:{type:"array",items:{type:"string"}},summary:{type:"string"}},required:["fieldScores","overallScore","priorityImprovements","summary"]}}},{id:"builtin_schema_quick_score",name:"Quick Score",stages:["score"],isBuiltin:!0,createdAt:0,updatedAt:0,schema:{name:"QuickScore",strict:!0,value:{$schema:"http://json-schema.org/draft-04/schema#",type:"object",additionalProperties:!1,properties:{overallScore:{type:"number"},strengths:{type:"array",items:{type:"string"}},weaknesses:{type:"array",items:{type:"string"}},summary:{type:"string"}},required:["overallScore","strengths","weaknesses","summary"]}}},{id:"builtin_schema_analyze",name:"Default Analyze",stages:["analyze"],isBuiltin:!0,createdAt:0,updatedAt:0,schema:{name:"CharacterAnalysis",strict:!0,value:{$schema:"http://json-schema.org/draft-04/schema#",type:"object",additionalProperties:!1,properties:{preserved:{type:"array",items:{type:"string"}},lost:{type:"array",items:{type:"string"}},gained:{type:"array",items:{type:"string"}},soulPreservationScore:{type:"number"},soulAssessment:{type:"string"},verdict:{type:"string",enum:["ACCEPT","NEEDS_REFINEMENT","REGRESSION"]},issuesToAddress:{type:"array",items:{type:"string"}},recommendations:{type:"array",items:{type:"string"}}},required:["preserved","lost","gained","soulPreservationScore","soulAssessment","verdict","issuesToAddress","recommendations"]}}}]),u={score:{promptPresetId:"builtin_score_default",customPrompt:"",schemaPresetId:"builtin_schema_score",customSchema:"",useStructuredOutput:!1},rewrite:{promptPresetId:"builtin_rewrite_default",customPrompt:"",schemaPresetId:null,customSchema:"",useStructuredOutput:!1},analyze:{promptPresetId:"builtin_analyze_default",customPrompt:"",schemaPresetId:"builtin_schema_analyze",customSchema:"",useStructuredOutput:!1}},d={source:"openrouter",model:"anthropic/claude-sonnet-4",temperature:1,maxTokens:4096,frequencyPenalty:0,presencePenalty:0,topP:1},p=Object.freeze({useCurrentSettings:!0,generationConfig:d,systemPrompt:a,promptPresets:[...c],schemaPresets:[...l],stageDefaults:u,refinementPrompt:o,debugMode:!1,settingsVersion:3}),f={ORIGINAL_CHARACTER:"{{original_character}}",SCORE_RESULTS:"{{score_results}}",REWRITE_RESULTS:"{{rewrite_results}}",CURRENT_REWRITE:"{{current_rewrite}}",CURRENT_ANALYSIS:"{{current_analysis}}",ITERATION_NUMBER:"{{iteration_number}}",CHARACTER_NAME:"{{char_name}}",USER_NAME:"{{user_name}}"};const m=[];function g(t,n,r){const s={timestamp:new Date,type:t,label:n,data:r};if(m.unshift(s),m.length>100&&m.pop(),"error"!==t){if(function(){try{return y().debugMode}catch(e){return!1}}()){const s=`[${e}:${t.toUpperCase()}]`;console.debug(s,n,r)}}else console.error(`[${e}:ERROR]`,n,r)}function h(e,t){g("error",e,t)}function _(){return JSON.stringify(function(){var e,t,n,r,s,i,a,o,c;const l=SillyTavern.getContext();let u;try{u=y()}catch(e){u={error:"Failed to load settings"}}return{extension:{settings:{useCurrentSettings:u.useCurrentSettings,debugMode:u.debugMode,generationConfig:u.generationConfig,systemPromptLength:(null===(e=u.systemPrompt)||void 0===e?void 0:e.length)||0,promptPresetCount:(null===(t=u.promptPresets)||void 0===t?void 0:t.length)||0,schemaPresetCount:(null===(n=u.schemaPresets)||void 0===n?void 0:n.length)||0}},sillytavern:{mainApi:l.mainApi,onlineStatus:l.onlineStatus,chatCompletionSource:null===(r=l.chatCompletionSettings)||void 0===r?void 0:r.chat_completion_source,currentModel:(null===(s=l.chatCompletionSettings)||void 0===s?void 0:s.openrouter_model)||(null===(i=l.chatCompletionSettings)||void 0===i?void 0:i.model_openai_select),maxContext:l.maxContext,characterCount:null!==(o=null===(a=l.characters)||void 0===a?void 0:a.length)&&void 0!==o?o:0,hasActiveChat:!!(null===(c=l.chat)||void 0===c?void 0:c.length)},logs:{total:m.length,errors:m.filter(e=>"error"===e.type).length,recent:m.slice(0,10).map(e=>({type:e.type,label:e.label,time:e.timestamp.toISOString()}))}}}(),null,2)}const v={2:e=>{const t=e;void 0!==t.useRawMode&&(e.useCurrentSettings=!t.useRawMode,delete t.useRawMode),void 0!==t.jsonSchema&&delete t.jsonSchema,void 0!==t.useStructuredOutput&&(e.stageDefaults||(e.stageDefaults=structuredClone(u)),e.stageDefaults.score.useStructuredOutput=!!t.useStructuredOutput,delete t.useStructuredOutput)},3:e=>{e.refinementPrompt||(e.refinementPrompt=o)}};function y(){const{extensionSettings:t,saveSettingsDebounced:n}=SillyTavern.getContext(),{lodash:r}=SillyTavern.libs;if(!t[e])return g("info","Initializing settings with defaults",null),t[e]=structuredClone(p),n(),t[e];const s=t[e],i=s.settingsVersion||1;let a=!1;i<3&&(a=function(e,t){let n=!1;for(let r=t+1;r<=3;r++){const t=v[r];t&&(g("info",`Running migration to v${r}`,null),t(e),n=!0)}return n}(s,i),s.settingsVersion=3);const o=r.merge(structuredClone(p),s),u=function(e){let t=!1;const n=new Set(e.promptPresets.map(e=>e.id));for(const r of c)n.has(r.id)||(e.promptPresets.push(structuredClone(r)),t=!0);const r=new Set(e.schemaPresets.map(e=>e.id));for(const n of l)r.has(n.id)||(e.schemaPresets.push(structuredClone(n)),t=!0);return t}(o);return a=a||u,t[e]=o,a&&n(),o}function $(t,n){const{extensionSettings:r,saveSettingsDebounced:s}=SillyTavern.getContext();r[e][t]=n,s(),g("info","Setting updated",{key:t,value:"object"==typeof n?"[object]":n})}function b(t){const{extensionSettings:n,saveSettingsDebounced:r}=SillyTavern.getContext(),s=n[e];s.generationConfig||(s.generationConfig=structuredClone(d)),s.generationConfig=Object.assign(Object.assign({},s.generationConfig),t),r(),g("info","Generation config updated",t)}function S(e){$("debugMode",e)}function w(e){const t=y();return e?t.promptPresets.filter(t=>0===t.stages.length||t.stages.includes(e)):t.promptPresets}function C(e){return y().promptPresets.find(t=>t.id===e)||null}function x(t){const{extensionSettings:n,saveSettingsDebounced:r}=SillyTavern.getContext(),s=n[e],{uuidv4:i}=SillyTavern.getContext(),a=Date.now(),o=Object.assign(Object.assign({},t),{id:`custom_prompt_${i()}`,isBuiltin:!1,createdAt:a,updatedAt:a});return s.promptPresets.push(o),r(),g("info","Prompt preset saved",{id:o.id,name:o.name}),o}function E(e){const t=y();return e?t.schemaPresets.filter(t=>0===t.stages.length||t.stages.includes(e)):t.schemaPresets}function P(e){return y().schemaPresets.find(t=>t.id===e)||null}function O(t){const{extensionSettings:n,saveSettingsDebounced:r}=SillyTavern.getContext(),s=n[e],{uuidv4:i}=SillyTavern.getContext(),a=k(t.schema),o=Date.now(),c=Object.assign(Object.assign({},t),{schema:a,id:`custom_schema_${i()}`,isBuiltin:!1,createdAt:o,updatedAt:o});return s.schemaPresets.push(c),r(),g("info","Schema preset saved",{id:c.id,name:c.name}),c}function k(e){const t=structuredClone(e);return A(t.value),t}function A(e){if("object"===e.type&&(e.additionalProperties=!1,e.properties&&"object"==typeof e.properties))for(const t of Object.values(e.properties))t&&"object"==typeof t&&A(t);if("array"===e.type&&e.items&&"object"==typeof e.items&&(Array.isArray(e.items)?e.items.forEach(e=>{e&&"object"==typeof e&&A(e)}):A(e.items)),e.anyOf&&Array.isArray(e.anyOf)&&e.anyOf.forEach(e=>{e&&"object"==typeof e&&A(e)}),e.allOf&&Array.isArray(e.allOf)&&e.allOf.forEach(e=>{e&&"object"==typeof e&&A(e)}),e.$defs&&"object"==typeof e.$defs)for(const t of Object.values(e.$defs))t&&"object"==typeof t&&A(t);if(e.definitions&&"object"==typeof e.definitions)for(const t of Object.values(e.definitions))t&&"object"==typeof t&&A(t)}var T=function(e,t,n,r){return new(n||(n=Promise))(function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,o)}c((r=r.apply(e,t||[])).next())})};const I=8,R=100,L=10,j=100,N=500,q=["date-time","time","date","duration","email","hostname","uri","ipv4","ipv6","uuid"],D=[0,1],M=["minimum","maximum","exclusiveMinimum","exclusiveMaximum","multipleOf"],H=["minLength","maxLength"],z=["maxItems","uniqueItems","contains","minContains","maxContains"],F=["minProperties","maxProperties","propertyNames","patternProperties"],V=["if","then","else","not","oneOf","dependentRequired","dependentSchemas","unevaluatedProperties","unevaluatedItems","$dynamicRef","$dynamicAnchor"],U=[{pattern:/\(\?[=!<]/,name:"lookahead/lookbehind assertions"},{pattern:/\\[1-9]/,name:"backreferences"},{pattern:/\\[bB]/,name:"word boundaries"}];function G(e){var t;if(!e.trim())return{valid:!0,schema:void 0};let n;try{n=JSON.parse(e)}catch(e){const t=e instanceof Error?e.message:"Invalid JSON",n=t.match(/position (\d+)/);return{valid:!1,error:`JSON syntax error${n?` (character ${n[1]})`:""}: ${t}`}}if("object"!=typeof n||null===n||Array.isArray(n))return{valid:!1,error:"Schema must be a JSON object, not "+(Array.isArray(n)?"array":typeof n)};const r=n;if("string"!=typeof r.name)return{valid:!1,error:"Missing required 'name' property (string)"};if(!r.name.trim())return{valid:!1,error:"'name' cannot be empty"};if(!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(r.name))return{valid:!1,error:`'name' must be a valid identifier (got '${r.name}'). Use letters, numbers, underscores; start with letter or underscore.`};if("object"!=typeof r.value||null===r.value||Array.isArray(r.value))return{valid:!1,error:"Missing or invalid 'value' property (must be object)"};const s=r.value;if("string"!=typeof s.type&&!s.anyOf&&!s.allOf&&!s.$ref)return{valid:!1,error:"'value' must have a 'type', 'anyOf', 'allOf', or '$ref'"};if(void 0!==r.strict&&"boolean"!=typeof r.strict)return{valid:!1,error:"'strict' must be a boolean if provided"};const i={errors:[],warnings:[],info:[],stats:{defCount:0,anyOfCount:0,totalAnyOfVariants:0,maxDepth:0,propertyCount:0,optionalFieldCount:0,enumCount:0},currentDepth:0,seenRefs:new Set,defs:{}};if(s.$defs&&"object"==typeof s.$defs?(i.defs=s.$defs,i.stats.defCount=Object.keys(i.defs).length):s.definitions&&"object"==typeof s.definitions&&(i.defs=s.definitions,i.stats.defCount=Object.keys(i.defs).length),i.stats.defCount>R&&i.errors.push(`Too many definitions: ${i.stats.defCount} (limit: ${R})`),B(s,"value",i),i.stats.optionalFieldCount>0){const e=i.stats.optionalFieldCount,t=i.stats.totalAnyOfVariants+2*e;e>10&&i.warnings.push(`${e} optional fields detected. Each spawns an implicit anyOf with null. Consider making fields required or reducing optionals.`),t>50&&i.warnings.push(`High anyOf count (~${t} including implicit nullables). May cause slow schema compilation or errors.`)}if(i.errors.length>0)return{valid:!1,error:i.errors.join("\n"),warnings:i.warnings.length>0?i.warnings:void 0};const a={name:r.name,strict:null===(t=r.strict)||void 0===t||t,value:s};return i.info.push(`Schema stats: ${i.stats.propertyCount} properties, ${i.stats.defCount} definitions, ${i.stats.anyOfCount} anyOf blocks, ${i.stats.optionalFieldCount} optional fields, max depth ${i.stats.maxDepth}`),{valid:!0,schema:a,warnings:i.warnings.length>0?i.warnings:void 0,info:i.info.length>0?i.info:void 0}}function B(e,t,n){if(n.currentDepth++,n.stats.maxDepth=Math.max(n.stats.maxDepth,n.currentDepth),n.currentDepth>L)return n.errors.push(`${t}: Exceeds maximum nesting depth of ${L}`),void n.currentDepth--;for(const r of V)void 0!==e[r]&&n.errors.push(`${t}: '${r}' is not supported`);for(const r of M)void 0!==e[r]&&n.warnings.push(`${t}: '${r}' will be ignored (not supported)`);for(const r of H)void 0!==e[r]&&n.warnings.push(`${t}: '${r}' will be ignored (not supported)`);for(const r of z)void 0!==e[r]&&n.warnings.push(`${t}: '${r}' will be ignored (not supported)`);for(const r of F)void 0!==e[r]&&n.warnings.push(`${t}: '${r}' will be ignored (not supported)`);if(e.$ref&&"string"==typeof e.$ref)return function(e,t,n){if(e.startsWith("http://")||e.startsWith("https://"))return void n.errors.push(`${t}: External $ref not supported ('${e}')`);if(n.seenRefs.has(e))return void n.info.push(`${t}: Circular reference to '${e}'`);n.seenRefs.add(e);const r=e.replace(/^#\/(\$defs|definitions)\//,"");n.defs[r]||n.errors.push(`${t}: Reference '${e}' not found in definitions`)}(e.$ref,t,n),void n.currentDepth--;const r=Array.isArray(e.type)?e.type:[e.type];for(const s of r)switch(s){case"object":J(e,t,n);break;case"array":W(e,t,n);break;case"string":Y(e,t,n);break;case"number":case"integer":K(e,t,n);break;case"boolean":case"null":break;default:!s||e.anyOf||e.allOf||n.warnings.push(`${t}: Unknown type '${s}'`)}e.anyOf&&Array.isArray(e.anyOf)&&function(e,t,n){n.stats.anyOfCount++,n.stats.totalAnyOfVariants+=e.length,e.length>I&&n.errors.push(`${t}: anyOf has ${e.length} variants (max: ${I})`);if(0===e.length)return void n.errors.push(`${t}: anyOf cannot be empty`);e.forEach((e,r)=>{e&&"object"==typeof e&&B(e,`${t}.anyOf[${r}]`,n)})}(e.anyOf,t,n),e.allOf&&Array.isArray(e.allOf)&&function(e,t,n){if(0===e.length)return void n.errors.push(`${t}: allOf cannot be empty`);e.forEach((e,r)=>{if(e&&"object"==typeof e){const s=e;s.$ref&&n.errors.push(`${t}.allOf[${r}]: allOf with $ref not supported`),B(s,`${t}.allOf[${r}]`,n)}})}(e.allOf,t,n),e.enum&&Array.isArray(e.enum)&&function(e,t,n){if(n.stats.enumCount++,0===e.length)return void n.errors.push(`${t}: enum cannot be empty`);e.length>N&&n.warnings.push(`${t}: enum has ${e.length} values (may be slow)`);for(let r=0;r<e.length;r++){const s=e[r],i=typeof s;if("string"!==i&&"number"!==i&&"boolean"!==i&&null!==s){n.errors.push(`${t}.enum[${r}]: Complex type not allowed in enum (got ${i}). Only string, number, boolean, null permitted.`);break}}const r=new Set;for(const s of e){const e=JSON.stringify(s);if(r.has(e)){n.warnings.push(`${t}: Duplicate value in enum: ${e}`);break}r.add(e)}}(e.enum,t,n),void 0!==e.const&&function(e,t,n){const r=typeof e;"string"!==r&&"number"!==r&&"boolean"!==r&&null!==e&&n.errors.push(`${t}: const must be string, number, boolean, or null (got ${r})`)}(e.const,t,n),n.currentDepth--}function J(e,t,n){if(!1!==e.additionalProperties&&n.warnings.push(`${t}: Missing 'additionalProperties: false' (REQUIRED for Anthropic)`),e.properties&&"object"==typeof e.properties){const r=e.properties,s=Object.keys(r).length;n.stats.propertyCount+=s,s>j&&n.warnings.push(`${t}: ${s} properties (may be slow, consider splitting)`);const i=e.required||[];for(const[e,s]of Object.entries(r))i.includes(e)||n.stats.optionalFieldCount++,s&&"object"==typeof s&&B(s,`${t}.${e}`,n)}}function W(e,t,n){if(void 0!==e.minItems){D.includes(e.minItems)||n.warnings.push(`${t}: 'minItems: ${e.minItems}' not supported (only 0 or 1 allowed)`)}e.items&&("object"!=typeof e.items||Array.isArray(e.items)?Array.isArray(e.items)&&e.items.forEach((e,r)=>{e&&"object"==typeof e&&B(e,`${t}.items[${r}]`,n)}):B(e.items,`${t}.items`,n)),e.prefixItems&&Array.isArray(e.prefixItems)&&e.prefixItems.forEach((e,r)=>{e&&"object"==typeof e&&B(e,`${t}.prefixItems[${r}]`,n)})}function Y(e,t,n){if(e.format&&"string"==typeof e.format){const r=q;r.includes(e.format)||n.warnings.push(`${t}: format '${e.format}' may not be supported. Supported: ${r.join(", ")}`)}e.pattern&&"string"==typeof e.pattern&&function(e,t,n){for(const{pattern:r,name:s}of U)r.test(e)&&n.errors.push(`${t}: Regex pattern uses unsupported feature: ${s}`);try{new RegExp(e)}catch(e){const r=e instanceof Error?e.message:"Invalid regex";n.errors.push(`${t}: Invalid regex pattern: ${r}`)}const r=/\{(\d+),(\d+)\}/g;let s;for(;null!==(s=r.exec(e));){const e=parseInt(s[1],10),r=parseInt(s[2],10);r-e>100&&n.warnings.push(`${t}: Large quantifier range {${e},${r}} may cause issues`)}}(e.pattern,t,n)}function K(e,t,n){}function Z(e){const t=structuredClone(e);return void 0===t.strict&&(t.strict=!0),Q(t.value),t}function Q(e){if("object"===e.type&&(e.additionalProperties=!1,e.properties&&"object"==typeof e.properties))for(const t of Object.values(e.properties))t&&"object"==typeof t&&Q(t);"array"===e.type&&e.items&&"object"==typeof e.items&&(Array.isArray(e.items)?e.items.forEach(e=>{e&&"object"==typeof e&&Q(e)}):Q(e.items)),e.anyOf&&Array.isArray(e.anyOf)&&e.anyOf.forEach(e=>{e&&"object"==typeof e&&Q(e)}),e.allOf&&Array.isArray(e.allOf)&&e.allOf.forEach(e=>{e&&"object"==typeof e&&Q(e)});const t=[];for(const n of M)void 0!==e[n]&&(t.push(`${n}: ${e[n]}`),delete e[n]);for(const n of H)void 0!==e[n]&&(t.push(`${n}: ${e[n]}`),delete e[n]);for(const n of z)void 0!==e[n]&&(t.push(`${n}: ${e[n]}`),delete e[n]);if(void 0!==e.minItems&&null!==e.minItems){const n=e.minItems;0!==n&&1!==n&&(t.push(`minItems: ${n}`),e.minItems=n>0?1:0)}if(t.length>0){const n=`[Constraints: ${t.join(", ")}]`;e.description?e.description=`${e.description} ${n}`:e.description=n}}function X(e){if(e.promptPresetId){const t=C(e.promptPresetId);if(t)return t.prompt;g("error","Prompt preset not found",{id:e.promptPresetId})}return e.customPrompt}function ee(e){const t=y().stageDefaults[e];return{promptPresetId:t.promptPresetId,customPrompt:t.customPrompt,schemaPresetId:t.schemaPresetId,customSchema:t.customSchema,useStructuredOutput:t.useStructuredOutput}}function te(e,t){const{lodash:n}=SillyTavern.libs,{substituteParams:r}=SillyTavern.getContext();let s=r(e);return s=function(e,t){const n=/\{\{#if\s+(\w+)\}\}([\s\S]*?)\{\{\/if\}\}/gi;return e.replace(n,(e,n,r)=>{var s,i,a,o,c;let l=!1;switch(n.toLowerCase()){case"score_results":l=!!(null===(s=t.scoreResults)||void 0===s?void 0:s.trim());break;case"rewrite_results":l=!!(null===(i=t.rewriteResults)||void 0===i?void 0:i.trim());break;case"current_rewrite":l=!!(null===(a=t.currentRewrite)||void 0===a?void 0:a.trim());break;case"current_analysis":l=!!(null===(o=t.currentAnalysis)||void 0===o?void 0:o.trim());break;case"original_character":l=!!(null===(c=t.originalCharacter)||void 0===c?void 0:c.trim());break;case"iteration_number":l=!!t.iterationNumber&&"0"!==t.iterationNumber;break;default:l=!1}return l?r:""})}(s,t),void 0!==t.originalCharacter&&(s=s.replace(new RegExp(n.escapeRegExp(f.ORIGINAL_CHARACTER),"gi"),t.originalCharacter)),void 0!==t.scoreResults&&(s=s.replace(new RegExp(n.escapeRegExp(f.SCORE_RESULTS),"gi"),t.scoreResults)),void 0!==t.rewriteResults&&(s=s.replace(new RegExp(n.escapeRegExp(f.REWRITE_RESULTS),"gi"),t.rewriteResults)),void 0!==t.currentRewrite&&(s=s.replace(new RegExp(n.escapeRegExp(f.CURRENT_REWRITE),"gi"),t.currentRewrite)),void 0!==t.currentAnalysis&&(s=s.replace(new RegExp(n.escapeRegExp(f.CURRENT_ANALYSIS),"gi"),t.currentAnalysis)),void 0!==t.iterationNumber&&(s=s.replace(new RegExp(n.escapeRegExp(f.ITERATION_NUMBER),"gi"),t.iterationNumber)),void 0!==t.charName&&(s=s.replace(new RegExp(n.escapeRegExp(f.CHARACTER_NAME),"gi"),t.charName)),void 0!==t.userName&&(s=s.replace(new RegExp(n.escapeRegExp(f.USER_NAME),"gi"),t.userName)),void 0!==t.charName&&(s=s.replace(/\{\{char\}\}/gi,t.charName)),void 0!==t.userName&&(s=s.replace(/\{\{user\}\}/gi,t.userName)),s}function ne(e){const t=[];for(const[n,r]of Object.entries(f))e.toLowerCase().includes(r.toLowerCase())&&t.push(n);return t}var re=function(e,t,n,r){return new(n||(n=Promise))(function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,o)}c((r=r.apply(e,t||[])).next())})};function se(){return{character:null,characterIndex:null,results:{score:null,rewrite:null,analyze:null},configs:{score:ee("score"),rewrite:ee("rewrite"),analyze:ee("analyze")},selectedStages:["score","rewrite"],currentStage:null,stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"},iterationCount:0,iterationHistory:[],isRefining:!1,exportData:null}}function ie(e,t,n){if(e.characterIndex===n&&null!==n)return e;const r=Object.assign(Object.assign({},e),{character:t,characterIndex:n,results:{score:null,rewrite:null,analyze:null},stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"},currentStage:null,iterationCount:0,iterationHistory:[],isRefining:!1,exportData:null});return g("state","Character set",{name:null==t?void 0:t.name,index:n,fieldsPopulated:t?ae(t).length:0}),r}function ae(e){return n.filter(t=>{const n=e[t.key];return n&&"string"==typeof n&&n.trim().length>0}).map(t=>{const n=e[t.key].trim();return{key:t.key,label:t.label,value:n,charCount:n.length,scoreable:t.scoreable}})}function oe(e){const t=ae(e).map(e=>`### ${e.label}\n${e.value}`);return`# CHARACTER: ${e.name}\n\n${t.join("\n\n")}`}function ce(e){return e.character?e.results.rewrite?e.results.analyze?{canRun:!0}:{canRun:!1,reason:"Run analyze first to identify issues"}:{canRun:!1,reason:"No rewrite to refine"}:{canRun:!1,reason:"No character selected"}}function le(e,t,n){return Object.assign(Object.assign({},e),{configs:Object.assign(Object.assign({},e.configs),{[t]:Object.assign(Object.assign({},e.configs[t]),n)})})}function ue(e,t,n){return g("error","Stage failed",{stage:t,error:n}),Object.assign(Object.assign({},e),{currentStage:null,stageStatus:Object.assign(Object.assign({},e.stageStatus),{[t]:"pending"})})}function de(e){const t=e.toUpperCase();if(t.includes("VERDICT")||t.includes('"VERDICT"')){if(t.includes("ACCEPT")&&!t.includes("NEEDS"))return"accept";if(t.includes("REGRESSION"))return"regression";if(t.includes("NEEDS_REFINEMENT")||t.includes("NEEDS REFINEMENT"))return"needs_refinement"}return t.includes("READY TO USE")||t.includes("NO MORE ITERATIONS")?"accept":t.includes("WORSE THAN")||t.includes("STEP BACKWARD")||t.includes("LOST MORE")?"regression":(t.includes("ISSUE")||t.includes("PROBLEM")||t.includes("SHOULD FIX"),"needs_refinement")}function pe(e){const t=function(e){if(!e.results.rewrite||!e.results.analyze)return null;const t=de(e.results.analyze.response);return{iteration:e.iterationCount,rewriteResponse:e.results.rewrite.response,rewritePreview:e.results.rewrite.response.substring(0,200),analysisResponse:e.results.analyze.response,analysisPreview:e.results.analyze.response.substring(0,200),verdict:t,timestamp:Date.now()}}(e);if(!t)return h("Cannot start refinement - missing rewrite or analyze",null),e;const n=[...e.iterationHistory,t];return n.length>20&&n.shift(),g("state","Starting refinement iteration",{iteration:e.iterationCount+1,previousVerdict:t.verdict}),Object.assign(Object.assign({},e),{iterationHistory:n,iterationCount:e.iterationCount+1,results:Object.assign(Object.assign({},e.results),{analyze:null}),stageStatus:Object.assign(Object.assign({},e.stageStatus),{analyze:"pending"}),isRefining:!0})}function fe(e){const t=function(e){try{let t;try{t=JSON.parse(e)}catch(n){const r=e.match(/```(?:json)?\s*([\s\S]*?)```/);if(!r)return null;t=JSON.parse(r[1].trim())}if("object"!=typeof t||null===t||Array.isArray(t))return null;const r=[];for(const[e,s]of Object.entries(t))if("string"==typeof s&&s.trim()){const t=n.find(t=>t.key===e||t.label.toLowerCase()===e.toLowerCase());r.push({key:(null==t?void 0:t.key)||e,label:(null==t?void 0:t.label)||me(e),value:s.trim()})}return 0===r.length?null:{fields:r,raw:e,parseMethod:"json"}}catch(e){return null}}(e);if(t)return t;const r=function(e){var t,r;const s=/^#{2,3}\s+(.+?)$/gm,i=[...e.matchAll(s)];if(0===i.length)return null;const a=[];for(let s=0;s<i.length;s++){const o=i[s],c=o[1].trim(),l=o.index+o[0].length,u=null!==(r=null===(t=i[s+1])||void 0===t?void 0:t.index)&&void 0!==r?r:e.length,d=e.slice(l,u).trim();if(!d)continue;const p=n.find(e=>e.label.toLowerCase()===c.toLowerCase()||e.key===c.toLowerCase().replace(/\s+/g,"_"));!p&&["summary","notes","changes","revised","original"].some(e=>c.toLowerCase().includes(e))||a.push({key:(null==p?void 0:p.key)||c.toLowerCase().replace(/\s+/g,"_"),label:(null==p?void 0:p.label)||c,value:d})}return 0===a.length?null:{fields:a,raw:e,parseMethod:"markdown"}}(e);if(r)return r;const s=function(e){const t=[];for(const r of n){const n=[new RegExp(`\\*\\*${r.label}:\\*\\*\\s*([\\s\\S]*?)(?=\\*\\*[A-Z]|$)`,"i"),new RegExp(`${r.label}:\\s*([\\s\\S]*?)(?=\\n[A-Z][a-z]+:|$)`,"i"),new RegExp(`\\[${r.label}\\]\\s*([\\s\\S]*?)(?=\\[[A-Z]|$)`,"i")];for(const s of n){const n=e.match(s);if(n&&n[1].trim()){t.push({key:r.key,label:r.label,value:n[1].trim()});break}}}return 0===t.length?null:{fields:t,raw:e,parseMethod:"heuristic"}}(e);return s||{fields:[{key:"content",label:"Content",value:e.trim()}],raw:e,parseMethod:"raw"}}function me(e){return e.replace(/_/g," ").replace(/([a-z])([A-Z])/g,"$1 $2").replace(/\b\w/g,e=>e.toUpperCase())}function ge(e,t){const n=e.selectedStages.indexOf(t);return-1===n||n>=e.selectedStages.length-1?null:e.selectedStages[n+1]}function he(e){return!!e.results.rewrite}function _e(e,t){var n,r,s,i;if(!e.character)return null;const a=X(e.configs[t]);if(!a.trim())return null;const o=oe(e.character),{name1:c}=SillyTavern.getContext(),l={originalCharacter:o,scoreResults:(null===(n=e.results.score)||void 0===n?void 0:n.response)||"",rewriteResults:(null===(r=e.results.rewrite)||void 0===r?void 0:r.response)||"",currentRewrite:(null===(s=e.results.rewrite)||void 0===s?void 0:s.response)||"",currentAnalysis:(null===(i=e.results.analyze)||void 0===i?void 0:i.response)||"",iterationNumber:String(e.iterationCount+1),charName:e.character.name,userName:c||"User"},u=ne(a),d=u.length>0,p=te(a,l);if(d){return u.includes("ORIGINAL_CHARACTER")?p:ye(t,e,o,p)}return g("info","No placeholders in prompt, auto-prepending character data",{stage:t}),ye(t,e,o,p)}function ve(e){var t;if(!e.character||!e.results.rewrite||!e.results.analyze)return null;const n=y().refinementPrompt,r=oe(e.character),{name1:s}=SillyTavern.getContext();return te(n,{originalCharacter:r,scoreResults:(null===(t=e.results.score)||void 0===t?void 0:t.response)||"",rewriteResults:e.results.rewrite.response,currentRewrite:e.results.rewrite.response,currentAnalysis:e.results.analyze.response,iterationNumber:String(e.iterationCount+1),charName:e.character.name,userName:s||"User"})}function ye(e,t,n,r){var s,i,a;const o=[],c="score"===e?"Analyze":"rewrite"===e?"Rewrite":"Compare";switch(o.push(`# Character to ${c}`,"",n),e){case"score":break;case"rewrite":(null===(s=t.results.score)||void 0===s?void 0:s.response)&&o.push("","---","","# Score Feedback","","Use this feedback to guide your rewrite:","",t.results.score.response);break;case"analyze":(null===(i=t.results.rewrite)||void 0===i?void 0:i.response)&&o.push("","---","","# Rewritten Version","","Compare this against the original:","",t.results.rewrite.response),(null===(a=t.results.score)||void 0===a?void 0:a.response)&&o.push("","---","","# Original Score Feedback","","Reference for what was identified as needing improvement:","",t.results.score.response)}return o.push("","---","","# Instructions","",r),o.join("\n")}function $e(e,t){return function(e){if(!e.useStructuredOutput)return null;if(e.schemaPresetId){const t=P(e.schemaPresetId);if(t)return t.schema;g("error","Schema preset not found",{id:e.schemaPresetId})}if(e.customSchema){const t=G(e.customSchema);if(t.valid&&t.schema)return t.schema;g("error","Custom schema invalid",{error:t.error})}return null}(e.configs[t])}function be(e){const t=function(e){if(!e.results.rewrite||!e.character)return null;const t=e.results.rewrite.response,n=[`# ${e.character.name} (Rewritten)`,"",`Generated: ${(new Date).toLocaleString()}`,`Iterations: ${e.iterationCount}`,"","---","",t];if(e.results.analyze&&n.push("","---","","## Final Analysis","",e.results.analyze.response),e.results.score&&n.push("","---","","## Original Score","",e.results.score.response),e.iterationHistory.length>0){n.push("","---","","## Iteration History","");for(const t of e.iterationHistory)n.push(`### Iteration ${t.iteration+1} - ${t.verdict.toUpperCase()}`,`${new Date(t.timestamp).toLocaleString()}`,"")}return n.join("\n")}(e);return Object.assign(Object.assign({},e),{exportData:t})}var Se=function(e,t,n,r){return new(n||(n=Promise))(function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,o)}c((r=r.apply(e,t||[])).next())})},we=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise(function(r,s){(function(e,t,n,r){Promise.resolve(r).then(function(t){e({value:t,done:n})},t)})(r,s,(t=e[n](t)).done,t.value)})}}};function Ce(){const{onlineStatus:e}=SillyTavern.getContext();return"Valid"===e||"Connected"===e}function xe(){var e,t,n;const r=SillyTavern.getContext(),s=y();return s.useCurrentSettings?{source:(null===(e=r.chatCompletionSettings)||void 0===e?void 0:e.chat_completion_source)||r.mainApi||"unknown",model:(null===(t=r.chatCompletionSettings)||void 0===t?void 0:t.openrouter_model)||(null===(n=r.chatCompletionSettings)||void 0===n?void 0:n.model_openai_select)||"unknown",isReady:Ce()}:{source:s.generationConfig.source,model:s.generationConfig.model,isReady:Ce()}}function Ee(e,t,n){return Se(this,void 0,void 0,function*(){const r=SillyTavern.getContext(),s=y();if(null==n?void 0:n.aborted)return{success:!1,error:"Generation cancelled"};if(!e.character)return{success:!1,error:"No character selected"};if(!Ce())return h("API not ready",{onlineStatus:r.onlineStatus}),{success:!1,error:"API is not connected. Check your connection settings."};const i=_e(e,t);if(!i)return{success:!1,error:"No prompt configured for this stage"};const a=e.configs[t].useStructuredOutput?$e(e,t):null,o=ke(i,e.character.name,r.name1||"User");g("info","Starting stage generation",{stage:t,character:e.character.name,useCurrentSettings:s.useCurrentSettings,useStructured:!!a,schemaName:null==a?void 0:a.name,promptLength:o.length});const c=yield Pe(s.systemPrompt,o,a,n,s.useCurrentSettings);return c.success&&a?function(e,t){try{const n=JSON.parse(e);if(t.value.required&&Array.isArray(t.value.required)){const r=t.value.required.filter(e=>!(e in n));if(r.length>0)return g("info","Structured response missing required fields, returning as unstructured",{missing:r,schemaName:t.name}),{success:!0,response:e,isStructured:!1}}return{success:!0,response:e,isStructured:!0}}catch(n){return g("info","Failed to parse structured response, returning as unstructured",{error:n.message,schemaName:t.name,responsePreview:e.substring(0,200)}),{success:!0,response:e,isStructured:!1}}}(c.response,a):c})}function Pe(e,t,n,r,s){return Se(this,void 0,void 0,function*(){try{let i;return i=s?yield function(e,t,n,r){return Se(this,void 0,void 0,function*(){const{generateRaw:s,substituteParams:i}=SillyTavern.getContext(),a=i(e);if(g("request","generateRaw request",{hasSchema:!!n,schemaName:null==n?void 0:n.name,systemPromptLength:a.length,userPromptLength:t.length}),null==r?void 0:r.aborted)throw new DOMException("Aborted","AbortError");const o=yield s({prompt:[{role:"system",content:a},{role:"user",content:t}],jsonSchema:n});if(null==r?void 0:r.aborted)throw new DOMException("Aborted","AbortError");const c=Oe(o);return g("response","generateRaw response",{type:typeof o,length:c.length,preview:c.substring(0,200)}),c})}(e,t,n,r):yield function(e,t,n,r){return Se(this,void 0,void 0,function*(){const{ChatCompletionService:s,substituteParams:i}=SillyTavern.getContext(),a=y().generationConfig,o={stream:!0,messages:[{role:"system",content:i(e)},{role:"user",content:t}],chat_completion_source:a.source,model:a.model,temperature:a.temperature,max_tokens:a.maxTokens,frequency_penalty:a.frequencyPenalty,presence_penalty:a.presencePenalty,top_p:a.topP};if(n&&(o.json_schema=n),g("request","ChatCompletionService request",{source:a.source,model:a.model,stream:!0,hasSchema:!!n}),null==r?void 0:r.aborted)throw new DOMException("Aborted","AbortError");const c=yield s.sendRequest(o);let l;if(g("response","ChatCompletionService result type",{type:typeof c,isFunction:"function"==typeof c,isGenerator:c&&"object"==typeof c&&Symbol.asyncIterator in c}),"function"==typeof c)l=yield function(e,t){return Se(this,void 0,void 0,function*(){var n,r,s,i;let a="",o=null;try{o=e();try{for(var c,l=!0,u=we(o);!(n=(c=yield u.next()).done);l=!0){i=c.value,l=!1;const e=i;if(null==t?void 0:t.aborted){g("info","Stream aborted",{textSoFar:a.length});try{yield o.return(void 0)}catch(e){}throw new DOMException("Aborted","AbortError")}const n=e;if("string"==typeof n.text&&(a=n.text),n.error)throw new Error(Oe(n.error))}}catch(e){r={error:e}}finally{try{l||n||!(s=u.return)||(yield s.call(u))}finally{if(r)throw r.error}}}catch(e){if("AbortError"===e.name)throw e;if(h("Stream consumption error",{error:e,textSoFar:a.length}),o)try{yield o.return(void 0)}catch(e){}if(a)return g("info","Returning partial response after stream error",{length:a.length}),a;throw e}return g("info","Stream consumed",{finalLength:a.length}),a})}(c,r);else if(c&&"object"==typeof c){const e=c;if(e.error)throw h("API returned error",c),new Error(`API error: ${JSON.stringify(c)}`);l=Oe(e.content||c)}else l=Oe(c);return g("response","Final response",{length:l.length,preview:l.substring(0,200)}),l})}(e,t,n,r),(null==r?void 0:r.aborted)?{success:!1,error:"Generation cancelled"}:i&&""!==i.trim()?(g("info","Generation complete",{responseLength:i.length,isStructured:!!n}),{success:!0,response:i,isStructured:!!n}):(h("Empty response",null),{success:!1,error:"Empty response from API"})}catch(e){if("AbortError"===e.name||(null==r?void 0:r.aborted))return g("info","Generation aborted",null),{success:!1,error:"Generation cancelled"};h("Generation exception",{message:e instanceof Error?e.message:String(e)});return{success:!1,error:e instanceof Error?e.message:String(e)}}})}function Oe(e){if("string"==typeof e)return e;if(null==e)return"";if("object"==typeof e)try{return JSON.stringify(e)}catch(t){return String(e)}return String(e)}function ke(e,t,n){return e.replace(/\{\{char\}\}/gi,t).replace(/\{\{user\}\}/gi,n)}var Ae=function(e,t,n,r){return new(n||(n=Promise))(function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,o)}c((r=r.apply(e,t||[])).next())})};let Te=null;function Ie(){return Te||(Te=new Map),Te}function Re(t){const{getThumbnailUrl:n}=SillyTavern.getContext(),r=ae(t),s=n("avatar",t.avatar);return`\n    <div class="${e}_char_preview" id="${e}_char_preview">\n      <div class="${e}_char_header">\n        <img\n          class="${e}_char_avatar"\n          src="${s}"\n          alt=""\n          onerror="this.src='/img/ai4.png'"\n        >\n        <div class="${e}_char_info">\n          <div class="${e}_char_name">${Ne(t.name)}</div>\n          <div class="${e}_char_meta">\n            ${r.length} fields • <span id="${e}_total_tokens">counting...</span>\n          </div>\n        </div>\n        <button id="${e}_char_clear" class="${e}_icon_btn" title="Clear selection">\n          <i class="fa-solid fa-xmark"></i>\n        </button>\n      </div>\n\n      <div class="${e}_char_fields">\n        ${r.map(t=>{return`\n    <div class="${e}_field_row">\n      <div class="${e}_field_header ${e}_field_toggle" data-field="${(n=t).key}">\n        <i class="fa-solid fa-chevron-right"></i>\n        <span class="${e}_field_label">${n.label}</span>\n        <span class="${e}_field_tokens" data-field="${n.key}">...</span>\n      </div>\n      <div class="${e}_field_content hidden" id="${e}_field_content_${n.key}">\n        <div class="${e}_field_text">${Ne(n.value)}</div>\n      </div>\n    </div>\n  `;var n}).join("")}\n      </div>\n    </div>\n  `}function Le(t,n){return Ae(this,void 0,void 0,function*(){const{getTokenCountAsync:r}=SillyTavern.getContext(),s=Ie(),i=n.map(e=>Ae(this,void 0,void 0,function*(){const t=function(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t&=t;return`${t}_${e.length}`}(e.value);if(s.has(t))return{field:e,tokens:s.get(t)};try{const n=yield r(e.value);return function(e,t){const n=Ie();if(n.size>=500){const e=n.keys().next().value;void 0!==e&&n.delete(e)}n.set(e,t)}(t,n),{field:e,tokens:n}}catch(t){return{field:e,tokens:null}}})),a=yield Promise.all(i);let o=0;for(const{field:n,tokens:r}of a){const s=t.querySelector(`.${e}_field_tokens[data-field="${n.key}"]`);s&&(null!==r?(o+=r,s.textContent=`${r.toLocaleString()}t`):s.textContent="?")}const c=t.querySelector(`#${e}_total_tokens`);c&&(c.textContent=`${o.toLocaleString()} tokens`)})}function je(t,n,r){const{getThumbnailUrl:s}=SillyTavern.getContext();if(0!==t.length){if(n.innerHTML=t.map(({char:t,index:n},i)=>{const a=s("avatar",t.avatar),o=i===r,c=(t.description||"No description").substring(0,80);return`\n      <div class="${e}_dropdown_item ${o?"selected":""}" data-index="${n}">\n        <img class="${e}_dropdown_avatar" src="${a}" alt="" onerror="this.src='/img/ai4.png'">\n        <div class="${e}_dropdown_info">\n          <span class="${e}_dropdown_name">${Ne(t.name)}</span>\n          <span class="${e}_dropdown_desc">${Ne(c)}${c.length>=80?"...":""}</span>\n        </div>\n      </div>\n    `}).join(""),r>=0){const t=n.querySelector(`.${e}_dropdown_item.selected`);null==t||t.scrollIntoView({block:"nearest"})}}else n.innerHTML=`<div class="${e}_dropdown_empty">No characters found</div>`}function Ne(e){const{DOMPurify:t}=SillyTavern.libs,n="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(n,{ALLOWED_TAGS:[]})}function qe(e){return n.filter(t=>{const n=e[t.key];return n&&"string"==typeof n&&n.trim().length>0}).map(t=>{const n=e[t.key].trim();return{key:t.key,label:t.label,value:n,charCount:n.length,scoreable:t.scoreable}})}function De(t,n,a,o){return`\n    <div class="${e}_pipeline_nav">\n      \x3c!-- Stage Selection --\x3e\n      <div class="${e}_stage_row">\n        ${r.map((o,c)=>function(t,n,r,a,o){const c=function(e){switch(e){case"complete":return"fa-check";case"running":return"fa-spinner fa-spin";case"skipped":return"fa-forward";default:return null}}(r);return`\n    <div class="${e}_stage_node ${a?"active":""} ${e}_stage_${r}">\n      <input\n        type="checkbox"\n        class="${e}_stage_checkbox"\n        id="${e}_stage_cb_${t}"\n        data-stage="${t}"\n        ${n?"checked":""}\n      >\n      <button\n        class="${e}_stage_btn ${a?"active":""}"\n        data-stage="${t}"\n        title="${s[t]}"\n      >\n        <i class="fa-solid ${i[t]}"></i>\n        <span>${s[t]}</span>\n        ${c?`<i class="fa-solid ${c} ${e}_status_icon"></i>`:""}\n      </button>\n      ${o?`<div class="${e}_stage_connector ${n?"active":""}"></div>`:""}\n    </div>\n  `}(o,t.includes(o),n[o],o===a,c<r.length-1)).join("")}\n      </div>\n\n      \x3c!-- Action Buttons --\x3e\n      <div class="${e}_pipeline_actions">\n        <button\n          id="${e}_run_selected_btn"\n          class="menu_button"\n          ${o?"":"disabled"}\n        >\n          <i class="fa-solid fa-play"></i>\n          <span>Run Selected</span>\n        </button>\n        <button\n          id="${e}_run_all_btn"\n          class="menu_button"\n          ${o?"":"disabled"}\n        >\n          <i class="fa-solid fa-forward"></i>\n          <span>Run All</span>\n        </button>\n        <button\n          id="${e}_reset_pipeline_btn"\n          class="menu_button"\n        >\n          <i class="fa-solid fa-rotate-left"></i>\n          <span>Reset</span>\n        </button>\n      </div>\n    </div>\n  `}var Me=function(e,t,n,r){return new(n||(n=Promise))(function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,o)}c((r=r.apply(e,t||[])).next())})};function He(){return Me(this,void 0,void 0,function*(){const{Popup:e,POPUP_RESULT:t}=SillyTavern.getContext(),n=yield e.show.input("Generate Schema",'Describe the structure you want (e.g., <q>"scores for each field 1-10, list of suggestions, overall rating"</q>):\n',"");if(null===n||n===t.CANCELLED||!n.trim())return null;ze(!0);try{toastr.info("Generating schema...");const e=yield function(e){return T(this,void 0,void 0,function*(){var t;const{generateRaw:n}=SillyTavern.getContext();if(!e.trim())return{success:!1,error:"Please describe what you want in the schema"};try{let r=(yield n({prompt:`Generate a JSON Schema for structured LLM output based on the user's description.\n\nRequirements:\n- Output ONLY valid JSON, no markdown, no explanation\n- Use this exact wrapper format: {"name": "SchemaName", "strict": true, "value": {...}}\n- The "value" must be a valid JSON Schema with "type": "object"\n- Add "additionalProperties": false to ALL object types (required for Anthropic)\n- All object properties should be in a "required" array unless explicitly optional\n- Use simple types: string, number, integer, boolean, array, object\n- For arrays, always specify "items" with a schema\n- Keep it minimal - only what the user asked for\n\nUser's description:\n\n${e}`,systemPrompt:"You are a JSON Schema expert. Output only valid JSON, nothing else."})).trim();r.startsWith("```")&&(r=r.replace(/^```(?:json)?\s*/,"").replace(/\s*```$/,""));const s=G(r);if(!s.valid)return{success:!1,error:`Generated schema is invalid: ${s.error}`,schema:r};if(null===(t=s.warnings)||void 0===t?void 0:t.length){const e=Z(s.schema);return{success:!0,schema:JSON.stringify(e,null,2)}}return{success:!0,schema:JSON.stringify(s.schema,null,2)}}catch(e){return{success:!1,error:`Generation failed: ${e.message}`}}})}(n);return e.success?(toastr.success("Schema generated!"),e.schema):(toastr.error(e.error||"Generation failed"),e.schema||null)}finally{ze(!1)}})}function ze(t){const n=document.querySelector(`.${e}_loading_overlay`);if(t&&!n){const t=document.createElement("div");t.className=`${e}_loading_overlay`,t.innerHTML=`\n            <div class="${e}_loading_content">\n                <i class="fa-solid fa-spinner fa-spin fa-2x"></i>\n                <p>Generating schema...</p>\n            </div>\n        `,document.body.appendChild(t)}else!t&&n&&n.remove()}function Fe(t,n,r,i){const a=w(n),o=E(n),c=t.querySelector(`#${e}_prompt_preset_select`);c&&(c.innerHTML=`<option value="">Custom</option>${Ve(a,r.promptPresetId)}`,c.value=r.promptPresetId||"",c.disabled=i);const l=t.querySelector(`#${e}_custom_prompt`);if(l){let n=r.customPrompt;if(r.promptPresetId){const e=C(r.promptPresetId);e&&(n=e.prompt)}l.value!==n&&(l.value=n),l.disabled=i;const s=t.querySelector(`.${e}_char_count`);s&&(s.textContent=`${n.length.toLocaleString()} chars`)}const u=t.querySelector(`#${e}_use_structured`);u&&(u.checked=r.useStructuredOutput,u.disabled=i);const d=t.querySelector(`.${e}_schema_section`);d&&d.classList.toggle("hidden",!r.useStructuredOutput);const p=t.querySelector(`#${e}_schema_preset_select`);p&&(p.innerHTML=`<option value="">Custom</option>${Ve(o,r.schemaPresetId)}`,p.value=r.schemaPresetId||"",p.disabled=i);const f=t.querySelector(`#${e}_custom_schema`);if(f){let e=r.customSchema;if(r.schemaPresetId){const t=P(r.schemaPresetId);t&&(e=JSON.stringify(t.schema,null,2))}f.value!==e&&(f.value=e),f.disabled=i}r.useStructuredOutput&&function(t,n){var r;const s=t.querySelector(`.${e}_schema_status`);s&&s.remove();if(!n.trim())return;const i=G(n);let a="";a=i.valid?(null===(r=i.warnings)||void 0===r?void 0:r.length)?`<div class="${e}_schema_status warning"><i class="fa-solid fa-triangle-exclamation"></i> ${i.warnings.length} warning(s)</div>`:`<div class="${e}_schema_status success"><i class="fa-solid fa-circle-check"></i> Valid schema</div>`:`<div class="${e}_schema_status error"><i class="fa-solid fa-circle-xmark"></i> ${Ue(i.error||"Invalid schema")}</div>`;const o=t.querySelector(`#${e}_custom_schema`);o&&o.insertAdjacentHTML("afterend",a)}(t,(null==f?void 0:f.value)||""),function(t,n){var r,s;const i=t.querySelector(`#${e}_validate_schema_btn`),a=t.querySelector(`#${e}_fix_schema_btn`),o=t.querySelector(`#${e}_format_schema_btn`),c=n.trim().length>0;i&&(i.disabled=!c);o&&(o.disabled=!c);if(a&&c){const e=G(n),t=(null!==(s=null===(r=e.warnings)||void 0===r?void 0:r.length)&&void 0!==s?s:0)>0||!e.valid;a.disabled=!t}else a&&(a.disabled=!0)}(t,(null==f?void 0:f.value)||"");const m=t.querySelector(`#${e}_run_stage_btn`);m&&(m.disabled=i,m.innerHTML=i?'<i class="fa-solid fa-spinner fa-spin"></i> Running...':`<i class="fa-solid fa-play"></i> Run ${s[n]} <kbd>Ctrl+Enter</kbd>`),function(t,n){var r,s;const i=t.querySelector(`#${e}_custom_prompt`),a=t.querySelector(`#${e}_custom_schema`),o=t.querySelector(`#${e}_save_prompt_preset_btn`),c=t.querySelector(`#${e}_save_schema_preset_btn`);if(o&&i){const e=i.value.trim(),t=n.promptPresetId&&(null===(r=C(n.promptPresetId))||void 0===r?void 0:r.prompt)||"",s=e.length>0,a=e!==t;o.disabled=!s||null!==n.promptPresetId&&!a}if(c&&a){const e=a.value.trim(),t=n.schemaPresetId?JSON.stringify(null===(s=P(n.schemaPresetId))||void 0===s?void 0:s.schema,null,2):"",r=e.length>0,i=e!==t,o=!!r&&G(e).valid;c.disabled=!r||!o||null!==n.schemaPresetId&&!i}}(t,r)}function Ve(e,t){return e.map(e=>{const n=e.id===t?"selected":"",r=e.isBuiltin?"📦":"📝";return`<option value="${e.id}" ${n}>${r} ${Ue(e.name)}</option>`}).join("")}function Ue(e){const{DOMPurify:t}=SillyTavern.libs;return t.sanitize(e,{ALLOWED_TAGS:[]})}function Ge(e,t){const{showdown:n,DOMPurify:r}=SillyTavern.libs,s="string"==typeof e?e:String(null!=e?e:""),i=`<div class="${t}_markdown_content">${new n.Converter({tables:!0,strikethrough:!0,simpleLineBreaks:!1,headerLevelStart:1,ghCodeBlocks:!0,tasklists:!0,openLinksInNewWindow:!0,emoji:!0,parseImgDimensions:!0,simplifiedAutoLink:!0}).makeHtml(s)}</div>`;return r.sanitize(i)}function Be(e,t,n){var r;const{DOMPurify:s}=SillyTavern.libs,i="string"==typeof e?e:String(null!=e?e:""),a=function(e){try{return JSON.parse(e)}catch(t){const n=e.match(/```(?:json)?\s*([\s\S]*?)```/);if(n)try{return JSON.parse(n[1].trim())}catch(e){return null}return null}}(i);if(!a||"object"!=typeof a)return Ge(i,n);const o=function(e,t,n){const r=function(e){const t=["overallscore","totalscore","overall","total","score","rating"];for(const n of t)for(const t of Object.keys(e))if(t.toLowerCase().replace(/_/g,"")===n&&"number"==typeof e[t])return t;return null}(e),s=r?e[r]:null,i=[];r&&"number"==typeof s&&i.push(function(e,t,n){const r=rt(e),s=st(t>10?t/10:t),i=Number.isInteger(t)?t:t.toFixed(1),a=t>10?100:10;return`\n    <div class="${n}_hero">\n      <div class="${n}_hero_label">${et(r)}</div>\n      <div class="${n}_hero_value" style="color: ${s}">\n        ${i}<span class="${n}_hero_max">/${a}</span>\n      </div>\n    </div>\n  `}(r,s,n));const a=t.properties||{},o=Object.keys(a).length>0?Object.keys(a):Object.keys(e);for(const t of o){if(t===r)continue;const s=e[t];if(void 0===s)continue;const o=a[t]||{type:tt(s)};i.push(Ye(t,s,o,n,0))}return`<div class="${n}_structured_content">${i.join("")}</div>`}(a,null!==(r=null==t?void 0:t.value)&&void 0!==r?r:Je(a),n);return s.sanitize(o)}function Je(e){if(null===e)return{type:"null"};if(Array.isArray(e))return{type:"array",items:e.length>0?Je(e[0]):{type:"string"}};if("object"==typeof e){const t={};for(const[n,r]of Object.entries(e))t[n]=Je(r);return{type:"object",properties:t}}return{type:typeof e}}const We=8;function Ye(e,t,n,r,s){if(s>We)return function(e,t){const{hljs:n}=SillyTavern.libs,r=JSON.stringify(e,null,2),s=n.highlight(r,{language:"json"}).value;return`<pre class="${t}_json"><code class="hljs">${s}</code></pre>`}(t,r);const i=rt(e),a=n.type||tt(t);if("array"===a&&Array.isArray(t))return function(e,t,n,r,s){if(0===t.length)return`\n      <div class="${r}_field">\n        <div class="${r}_field_label">${et(e)}</div>\n        <div class="${r}_field_value ${r}_empty">(none)</div>\n      </div>\n    `;const i=n.items||{type:tt(t[0])};if(t.every(nt)){const n=t.map(e=>`<li>${function(e,t){if("boolean"==typeof e)return Xe(e,t);if("number"==typeof e)return`<span class="${t}_num">${e.toLocaleString()}</span>`;return et(String(e))}(e,r)}</li>`).join("");return`\n      <div class="${r}_field">\n        <div class="${r}_field_label">${et(e)}</div>\n        <ol class="${r}_list">${n}</ol>\n      </div>\n    `}const a=t.map((e,t)=>"object"==typeof e&&null!==e?function(e,t,n,r){const s=t.properties||{},i=Object.keys(s).length>0?Object.keys(s):Object.keys(e),a=i.find(t=>"string"==typeof e[t]&&e[t].length<100),o=i.find(t=>"number"==typeof e[t]&&e[t]>=0&&e[t]<=100),c=i.find(t=>"string"==typeof e[t]&&e[t].length>=50&&t!==a);let l="";if(a||o){const t=a?`<span class="${n}_card_title">${et(String(e[a]))}</span>`:"",r=o?Qe(e[o],n):"";l=`<div class="${n}_card_header">${t}${r}</div>`}let u="";c&&(u=`<div class="${n}_card_body">${Ze(String(e[c]),n)}</div>`);const d=i.filter(e=>e!==a&&e!==o&&e!==c).map(t=>{const i=e[t];if(void 0===i)return"";return Ye(t,i,s[t]||{type:tt(i)},n,r+1)}).filter(Boolean).join(""),p=d?`<div class="${n}_card_extra">${d}</div>`:"";return`<div class="${n}_card">${l}${u}${p}</div>`}(e,i,r,s+1):`<div class="${r}_card">${Ke(e,i,r)}</div>`).join("");return`\n    <div class="${r}_field">\n      <div class="${r}_field_label">${et(e)}</div>\n      <div class="${r}_cards">${a}</div>\n    </div>\n  `}(i,t,n,r,s);if("object"===a&&"object"==typeof t&&null!==t)return function(e,t,n,r,s){const i=n.properties||{},a=(Object.keys(i).length>0?Object.keys(i):Object.keys(t)).map(e=>{const n=t[e];if(void 0===n)return"";return Ye(e,n,i[e]||{type:tt(n)},r,s+1)}).filter(Boolean).join("");return`\n    <div class="${r}_field">\n      <div class="${r}_field_label">${et(e)}</div>\n      <div class="${r}_nested">${a}</div>\n    </div>\n  `}(i,t,n,r,s);const o=Ke(t,n,r,e);return`\n    <div class="${r}_field">\n      <div class="${r}_field_label">${et(i)}</div>\n      <div class="${r}_field_value">${o}</div>\n    </div>\n  `}function Ke(e,t,n,r){if(null==e)return`<span class="${n}_null">—</span>`;switch(t.type||tt(e)){case"string":return function(e,t,n){if(!e.trim())return`<span class="${n}_empty">(empty)</span>`;const r=t.format;if("uri"===r||"url"===r||(s=e,/^https?:\/\//i.test(s))){const t=e.length>50?e.substring(0,47)+"...":e;return`<a href="${et(e)}" target="_blank" rel="noopener" class="${n}_link">${et(t)}</a>`}var s;if("email"===r||function(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}(e))return`<a href="mailto:${et(e)}" class="${n}_link">${et(e)}</a>`;if(e.length>100||e.includes("\n"))return Ze(e,n);return`<span>${et(e)}</span>`}(e,t,n);case"number":case"integer":return function(e,t,n,r){const s=String(t.title||t.description||r||"").toLowerCase();if(function(e,t){return!!["score","rating","rank","grade","level","confidence","quality"].some(t=>e.includes(t))||(!!(t>=0&&t<=10&&Number.isFinite(t))||!!(t>=0&&t<=100&&Number.isInteger(t)))}(s,e))return Qe(e,n);const i=e.toLocaleString(void 0,{maximumFractionDigits:2});return`<span class="${n}_num">${i}</span>`}(e,t,n,r);case"boolean":return Xe(e,n);default:return`<span>${et(String(e))}</span>`}}function Ze(e,t){return`<div class="${t}_text">${Ge(e,t)}</div>`}function Qe(e,t){return`<span class="${t}_score" style="color: ${st(e>10?e/10:e)}">${Number.isInteger(e)?e:e.toFixed(1)}<span class="${t}_score_max">/${e>10?100:10}</span></span>`}function Xe(e,t){return`<span class="${e?`${t}_yes`:`${t}_no`}"><i class="fa-solid ${e?"fa-check-circle":"fa-times-circle"}"></i> ${e?"Yes":"No"}</span>`}function et(e){const{DOMPurify:t}=SillyTavern.libs,n="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(n,{ALLOWED_TAGS:[]})}function tt(e){return null===e?"null":Array.isArray(e)?"array":typeof e}function nt(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e||null===e}function rt(e){return e.replace(/_/g," ").replace(/([a-z])([A-Z])/g,"$1 $2").replace(/\b\w/g,e=>e.toUpperCase())}function st(e){return e>=8?"var(--success, #2ecc71)":e>=5?"var(--warning, #f39c12)":"var(--failure, #e74c3c)"}function it(t){return`\n    <div class="${e}_results_loading">\n      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>\n      <p>Running ${s[t]}...</p>\n      <button id="${e}_cancel_btn" class="menu_button">\n        <i class="fa-solid fa-stop"></i>\n        <span>Cancel</span>\n      </button>\n    </div>\n  `}function at(t,n){let r=`Run ${s[t]} to see results`,i="fa-play";return"skipped"===n&&(r=`${s[t]} was skipped`,i="fa-forward"),`\n    <div class="${e}_results_placeholder">\n      <i class="fa-solid ${i}"></i>\n      <p>${r}</p>\n    </div>\n  `}function ot(t,n){const r=n.isStructured?Be(n.response,null,e):Ge(n.response,e),i=new Date(n.timestamp).toLocaleTimeString();let a="";if("analyze"===t){a=function(t){return`\n    <span class="${e}_badge ${e}_verdict_badge ${e}_verdict_${t}">\n      <i class="fa-solid ${{accept:"fa-check-circle",needs_refinement:"fa-wrench",regression:"fa-arrow-down"}[t]}"></i>\n      ${{accept:"Accept",needs_refinement:"Needs Work",regression:"Regression"}[t]}\n    </span>\n  `}(de(n.response))}return`\n    <div class="${e}_results_content">\n      \x3c!-- Toolbar --\x3e\n      <div class="${e}_results_toolbar">\n        <div class="${e}_results_info">\n          <span class="${e}_badge">${s[t]}</span>\n          ${a}\n          <span class="${e}_results_time">${i}</span>\n          ${n.locked?`<span class="${e}_badge ${e}_badge_locked"><i class="fa-solid fa-lock"></i> Locked</span>`:""}\n        </div>\n        <div class="${e}_results_actions">\n          \x3c!-- Always render BOTH buttons, use hidden class based on locked state --\x3e\n          <button id="${e}_lock_btn" class="${e}_icon_btn ${n.locked?"hidden":""}" title="Lock result">\n            <i class="fa-solid fa-lock"></i>\n          </button>\n          <button id="${e}_unlock_btn" class="${e}_icon_btn ${n.locked?"":"hidden"}" title="Unlock for editing">\n            <i class="fa-solid fa-lock-open"></i>\n          </button>\n          <button id="${e}_copy_btn" class="${e}_icon_btn" title="Copy to clipboard">\n            <i class="fa-solid fa-copy"></i>\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Content --\x3e\n      <div class="${e}_results_body">\n        ${r}\n      </div>\n\n      \x3c!-- Footer Actions --\x3e\n      <div class="${e}_results_footer" id="${e}_results_footer">\n        \x3c!-- Populated by updateResultsPanelState --\x3e\n      </div>\n    </div>\n  `}function ct(t,n,r,i,a,o,c){var l;const u=a&&"running"===i,d=r&&!u,p=!r&&!u;if(u)return void(t.innerHTML=it(n));if(p)return void(t.innerHTML=at(n,i));if(d){const s=t.querySelector(`.${e}_results_content`),i=null===(l=t.querySelector(`.${e}_results_time`))||void 0===l?void 0:l.textContent,a=new Date(r.timestamp).toLocaleTimeString();s&&i===a||(t.innerHTML=ot(n,r))}const f=t.querySelector(`#${e}_results_footer`);f&&r&&(f.innerHTML=function(t,n,r,i){const a=[];n.locked||a.push(`\n      <button id="${e}_regenerate_btn" class="menu_button">\n        <i class="fa-solid fa-rotate"></i>\n        <span>Regenerate</span>\n      </button>\n    `);"rewrite"===t&&i.character&&a.push(`\n      <button id="${e}_apply_btn" class="menu_button ${e}_apply_btn">\n        <i class="fa-solid fa-check-double"></i>\n        <span>Apply to Character</span>\n      </button>\n    `);if("analyze"===t){const t=de(n.response);if(ce(i).canRun){const n="needs_refinement"===t;a.push(`\n        <button id="${e}_refine_btn" class="menu_button ${n?e+"_refine_recommended":""}">\n          <i class="fa-solid fa-arrows-rotate"></i>\n          <span>Refine</span>\n          ${i.iterationCount>0?`<span class="${e}_iteration_badge">#${i.iterationCount+1}</span>`:""}\n        </button>\n      `)}if(i.results.rewrite&&!i.results.rewrite.locked){const n="accept"===t;a.push(`\n        <button id="${e}_accept_btn" class="menu_button ${n?e+"_accept_recommended":""}">\n          <i class="fa-solid fa-check"></i>\n          <span>Accept Rewrite</span>\n        </button>\n      `)}}r&&"analyze"!==t&&a.push(`\n      <button id="${e}_continue_btn" class="menu_button ${e}_continue_btn">\n        <i class="fa-solid fa-arrow-right"></i>\n        <span>Continue to ${s[r]}</span>\n      </button>\n    `);he(i)&&a.push(`\n      <button id="${e}_export_btn" class="menu_button">\n        <i class="fa-solid fa-file-export"></i>\n        <span>Export</span>\n      </button>\n    `);return`<div class="${e}_footer_actions">${a.join("")}</div>`}(n,r,o,c));const m=t.querySelector(`#${e}_lock_btn`),g=t.querySelector(`#${e}_unlock_btn`);m&&g&&(m.classList.toggle("hidden",!!(null==r?void 0:r.locked)),g.classList.toggle("hidden",!(null==r?void 0:r.locked)))}function lt(t,n,r){if(0===t.length&&0===n)return"";const s=r?0===t.length?`<div class="${e}_iteration_empty">No previous iterations</div>`:t.map((e,t)=>ut(e,t)).join(""):`<div class="${e}_iteration_loading">\n             <i class="fa-solid fa-spinner fa-spin"></i>\n             <span>Loading history...</span>\n           </div>`;return`\n    <div class="${e}_iteration_history" id="${e}_iteration_history">\n      <div class="${e}_iteration_header">\n        <i class="fa-solid fa-clock-rotate-left"></i>\n        <span>Iteration History</span>\n        <span class="${e}_iteration_count">${n>0?`Current: #${n+1}`:"Initial"}</span>\n      </div>\n      <div class="${e}_iteration_list">\n        ${s}\n      </div>\n    </div>\n  `}function ut(t,n){const r=dt(t.verdict),s=pt(t.verdict),i=new Date(t.timestamp).toLocaleTimeString();return`\n    <div class="${e}_iteration_item ${s}" data-index="${n}">\n      <div class="${e}_iteration_item_header">\n        <span class="${e}_iteration_num">#${t.iteration+1}</span>\n        <span class="${e}_iteration_verdict">\n          <i class="fa-solid ${r}"></i>\n          ${ft(t.verdict)}\n        </span>\n        <span class="${e}_iteration_time">${i}</span>\n      </div>\n      <div class="${e}_iteration_preview">\n        ${mt(t.rewritePreview)}...\n      </div>\n      <div class="${e}_iteration_actions">\n        <button\n          class="${e}_iteration_revert_btn menu_button"\n          data-index="${n}"\n          title="Revert to this version"\n        >\n          <i class="fa-solid fa-rotate-left"></i>\n          Revert\n        </button>\n        <button\n          class="${e}_iteration_view_btn menu_button"\n          data-index="${n}"\n          title="View full content"\n        >\n          <i class="fa-solid fa-eye"></i>\n          View\n        </button>\n      </div>\n    </div>\n  `}function dt(e){switch(e){case"accept":return"fa-check-circle";case"needs_refinement":return"fa-wrench";case"regression":return"fa-arrow-down";default:return"fa-question-circle"}}function pt(t){return`${e}_verdict_${t}`}function ft(e){switch(e){case"accept":return"Accepted";case"needs_refinement":return"Needs Work";case"regression":return"Regression";default:return"Unknown"}}function mt(e){const{DOMPurify:t}=SillyTavern.libs,n="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(n,{ALLOWED_TAGS:[]})}var gt=function(e,t,n,r){return new(n||(n=Promise))(function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,o)}c((r=r.apply(e,t||[])).next())})};function ht(n){return gt(this,void 0,void 0,function*(){const{Popup:r,POPUP_TYPE:s}=SillyTavern.getContext(),{DOMPurify:i}=SillyTavern.libs,c=function(){const n=y(),r=n.generationConfig,{moment:s}=SillyTavern.libs;return`\n    <div class="${e}_settings_modal" id="${e}_settings_modal">\n      <div class="${e}_settings_header">\n        <i class="fa-solid fa-gear"></i>\n        <span>Character Tools Settings</span>\n      </div>\n\n      \x3c!-- Generation Settings --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-microchip"></i>\n          <span>Generation</span>\n        </div>\n\n        <div class="${e}_settings_row">\n          <label class="${e}_checkbox_label">\n            <input\n              type="checkbox"\n              id="${e}_use_current_settings"\n              ${n.useCurrentSettings?"checked":""}\n            >\n            <span>Use Current SillyTavern Settings</span>\n          </label>\n        </div>\n\n        <div id="${e}_custom_gen_config" class="${n.useCurrentSettings?"hidden":""}">\n          <div class="${e}_settings_grid">\n            <div class="${e}_settings_field">\n              <label>Source</label>\n              <select id="${e}_gen_source" class="text_pole"></select>\n            </div>\n            <div class="${e}_settings_field">\n              <label>Model</label>\n              <select id="${e}_gen_model" class="text_pole"></select>\n            </div>\n          </div>\n\n          <div class="${e}_settings_grid ${e}_settings_grid_5">\n            <div class="${e}_settings_field">\n              <label>Temp</label>\n              <input type="number" id="${e}_gen_temp" class="text_pole" value="${r.temperature}" min="0" max="2" step="0.1">\n            </div>\n            <div class="${e}_settings_field">\n              <label>Max Tokens</label>\n              <input type="number" id="${e}_gen_tokens" class="text_pole" value="${r.maxTokens}" min="100" max="32000" step="100">\n            </div>\n            <div class="${e}_settings_field">\n              <label>Freq Pen</label>\n              <input type="number" id="${e}_gen_freq" class="text_pole" value="${r.frequencyPenalty}" min="-2" max="2" step="0.1">\n            </div>\n            <div class="${e}_settings_field">\n              <label>Pres Pen</label>\n              <input type="number" id="${e}_gen_pres" class="text_pole" value="${r.presencePenalty}" min="-2" max="2" step="0.1">\n            </div>\n            <div class="${e}_settings_field">\n              <label>Top P</label>\n              <input type="number" id="${e}_gen_top_p" class="text_pole" value="${r.topP}" min="0" max="1" step="0.05">\n            </div>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- System Prompt --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-message"></i>\n          <span>System Prompt</span>\n        </div>\n\n        <p class="${e}_settings_hint">Base instructions applied to all stages</p>\n\n        <textarea\n          id="${e}_system_prompt"\n          class="text_pole ${e}_system_prompt_textarea"\n          rows="6"\n        >${bt(n.systemPrompt)}</textarea>\n\n        <div class="${e}_settings_row_spread">\n          <span id="${e}_system_prompt_chars">${n.systemPrompt.length.toLocaleString()} chars</span>\n          <button id="${e}_reset_system_prompt" class="menu_button">\n            <i class="fa-solid fa-rotate-left"></i>\n            Reset\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Refinement Prompt --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-arrows-rotate"></i>\n          <span>Refinement Prompt</span>\n        </div>\n\n        <p class="${e}_settings_hint">Template for iterative refinement. Placeholders: {{original_character}}, {{current_rewrite}}, {{current_analysis}}, {{score_results}}, {{iteration_number}}</p>\n\n        <textarea\n          id="${e}_refinement_prompt"\n          class="text_pole ${e}_system_prompt_textarea"\n          rows="8"\n        >${bt(n.refinementPrompt)}</textarea>\n\n        <div class="${e}_settings_row_spread">\n          <span id="${e}_refinement_prompt_chars">${n.refinementPrompt.length.toLocaleString()} chars</span>\n          <button id="${e}_reset_refinement_prompt" class="menu_button">\n            <i class="fa-solid fa-rotate-left"></i>\n            Reset\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Preset Management --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-bookmark"></i>\n          <span>Presets</span>\n        </div>\n\n        <div class="${e}_presets_grid">\n          <div class="${e}_preset_column">\n            <h4>Prompt Presets</h4>\n            <div id="${e}_prompt_presets_list" class="${e}_preset_list">\n              ${_t("prompt")}\n            </div>\n          </div>\n          <div class="${e}_preset_column">\n            <h4>Schema Presets</h4>\n            <div id="${e}_schema_presets_list" class="${e}_preset_list">\n              ${_t("schema")}\n            </div>\n          </div>\n        </div>\n\n        <div class="${e}_settings_row_spread">\n          <button id="${e}_export_presets" class="menu_button">\n            <i class="fa-solid fa-file-export"></i>\n            Export Custom\n          </button>\n          <button id="${e}_import_presets" class="menu_button">\n            <i class="fa-solid fa-file-import"></i>\n            Import\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Keyboard Shortcuts --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-keyboard"></i>\n          <span>Keyboard Shortcuts</span>\n        </div>\n\n        <div class="${e}_shortcuts_list">\n          <div class="${e}_shortcut_item">\n            <kbd>Ctrl</kbd> + <kbd>Enter</kbd>\n            <span>Run current stage</span>\n          </div>\n          <div class="${e}_shortcut_item">\n            <kbd>Escape</kbd>\n            <span>Cancel generation</span>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Debug --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-bug"></i>\n          <span>Debug</span>\n        </div>\n\n        <div class="${e}_settings_row">\n          <label class="${e}_checkbox_label">\n            <input\n              type="checkbox"\n              id="${e}_debug_mode"\n              ${n.debugMode?"checked":""}\n            >\n            <span>Enable Debug Logging</span>\n          </label>\n        </div>\n\n        <div class="${e}_debug_actions">\n          <button id="${e}_view_logs" class="menu_button">\n            <i class="fa-solid fa-list"></i>\n            View Logs\n          </button>\n          <button id="${e}_clear_logs" class="menu_button">\n            <i class="fa-solid fa-trash"></i>\n            Clear\n          </button>\n          <button id="${e}_copy_debug_info" class="menu_button">\n            <i class="fa-solid fa-copy"></i>\n            Copy Info\n          </button>\n        </div>\n\n        <div id="${e}_debug_log_viewer" class="${e}_debug_log_viewer hidden">\n          <div id="${e}_debug_log_list" class="${e}_debug_log_list"></div>\n          <pre id="${e}_debug_log_detail" class="${e}_debug_log_detail">Select a log entry</pre>\n        </div>\n      </div>\n\n      \x3c!-- Footer --\x3e\n      <div class="${e}_settings_footer">\n        <span class="${e}_settings_version">v${t} • Last updated: ${s().format("YYYY-MM-DD HH:mm:ss")}</span>\n      </div>\n    </div>\n  `}();new r(i.sanitize(c),s.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:"Save & Close",cancelButton:!1}).show().then(()=>{null==n||n(),g("info","Settings modal closed",null)}),yield new Promise(e=>setTimeout(e,0)),function(){const t=document.getElementById(`${e}_settings_modal`);if(!t)return;const n=t.querySelector(`#${e}_use_current_settings`),r=t.querySelector(`#${e}_custom_gen_config`);null==n||n.addEventListener("change",()=>{$("useCurrentSettings",n.checked),null==r||r.classList.toggle("hidden",n.checked)});const s=t.querySelector(`#${e}_gen_source`),i=t.querySelector(`#${e}_gen_model`),c=t.querySelector(`#${e}_gen_temp`),l=t.querySelector(`#${e}_gen_tokens`),u=t.querySelector(`#${e}_gen_freq`),d=t.querySelector(`#${e}_gen_pres`),p=t.querySelector(`#${e}_gen_top_p`);null==s||s.addEventListener("change",()=>{b({source:s.value}),$t(s.value)}),null==i||i.addEventListener("change",()=>{b({model:i.value})});const f=(e,t,n=!1)=>{null==e||e.addEventListener("change",()=>{const r=n?parseInt(e.value,10):parseFloat(e.value);isNaN(r)||b({[t]:r})})};f(c,"temperature"),f(l,"maxTokens",!0),f(u,"frequencyPenalty"),f(d,"presencePenalty"),f(p,"topP");const h=t.querySelector(`#${e}_system_prompt`),v=t.querySelector(`#${e}_system_prompt_chars`),w=t.querySelector(`#${e}_reset_system_prompt`);null==h||h.addEventListener("input",()=>{$("systemPrompt",h.value),v&&(v.textContent=`${h.value.length.toLocaleString()} chars`)}),null==w||w.addEventListener("click",()=>{$("systemPrompt",a),h&&(h.value=a),v&&(v.textContent=`${a.length.toLocaleString()} chars`),toastr.info("System prompt reset to default")});const C=t.querySelector(`#${e}_refinement_prompt`),E=t.querySelector(`#${e}_refinement_prompt_chars`),P=t.querySelector(`#${e}_reset_refinement_prompt`);null==C||C.addEventListener("input",()=>{$("refinementPrompt",C.value),E&&(E.textContent=`${C.value.length.toLocaleString()} chars`)}),null==P||P.addEventListener("click",()=>{$("refinementPrompt",o),C&&(C.value=o),E&&(E.textContent=`${o.length.toLocaleString()} chars`),toastr.info("Refinement prompt reset to default")}),t.addEventListener("click",t=>{const n=t.target.closest(`.${e}_preset_delete`);if(n){const t=n.getAttribute("data-type"),r=n.getAttribute("data-id");t&&r&&function(t,n){const r="prompt"===t?function(t){var n;const{extensionSettings:r,saveSettingsDebounced:s}=SillyTavern.getContext(),i=r[e],a=i.promptPresets.findIndex(e=>e.id===t);if(-1===a)return null;if(i.promptPresets[a].isBuiltin)return g("error","Cannot delete builtin preset",{id:t}),null;i.promptPresets.splice(a,1);for(const e of["score","rewrite","analyze"])(null===(n=i.stageDefaults[e])||void 0===n?void 0:n.promptPresetId)===t&&(i.stageDefaults[e].promptPresetId=null);return s(),g("info","Prompt preset deleted",{id:t}),t}(n):function(t){var n;const{extensionSettings:r,saveSettingsDebounced:s}=SillyTavern.getContext(),i=r[e],a=i.schemaPresets.findIndex(e=>e.id===t);if(-1===a)return null;if(i.schemaPresets[a].isBuiltin)return g("error","Cannot delete builtin preset",{id:t}),null;i.schemaPresets.splice(a,1);for(const e of["score","rewrite","analyze"])(null===(n=i.stageDefaults[e])||void 0===n?void 0:n.schemaPresetId)===t&&(i.stageDefaults[e].schemaPresetId=null);return s(),g("info","Schema preset deleted",{id:t}),t}(n);r?(toastr.success("Preset deleted"),vt()):toastr.error("Cannot delete builtin preset")}(t,r)}});const k=t.querySelector(`#${e}_export_presets`),A=t.querySelector(`#${e}_import_presets`);null==k||k.addEventListener("click",()=>{const e=function(){const e=y(),t=e.promptPresets.filter(e=>!e.isBuiltin),n=e.schemaPresets.filter(e=>!e.isBuiltin);return JSON.stringify({version:3,exportedAt:(new Date).toISOString(),promptPresets:t,schemaPresets:n},null,2)}();navigator.clipboard.writeText(e),toastr.success("Custom presets copied to clipboard")}),null==A||A.addEventListener("click",()=>gt(this,void 0,void 0,function*(){try{const e=function(e){const t=[];let n=0,r=0;try{const s=JSON.parse(e);if(s.promptPresets&&Array.isArray(s.promptPresets))for(const e of s.promptPresets)try{e.name&&e.prompt&&(x({name:e.name,prompt:e.prompt,stages:e.stages||[]}),n++)}catch(n){t.push(`Failed to import prompt "${e.name}": ${n}`)}if(s.schemaPresets&&Array.isArray(s.schemaPresets))for(const e of s.schemaPresets)try{e.name&&e.schema&&(O({name:e.name,schema:e.schema,stages:e.stages||[]}),r++)}catch(n){t.push(`Failed to import schema "${e.name}": ${n}`)}}catch(e){t.push(`Failed to parse JSON: ${e}`)}return g("info","Presets imported",{promptsImported:n,schemasImported:r,errors:t}),{prompts:n,schemas:r,errors:t}}(yield navigator.clipboard.readText());e.errors.length>0?toastr.error(e.errors.join("\n")):(toastr.success(`Imported ${e.prompts} prompts, ${e.schemas} schemas`),vt())}catch(e){toastr.error("Failed to read clipboard")}}));const T=t.querySelector(`#${e}_debug_mode`),I=t.querySelector(`#${e}_view_logs`),R=t.querySelector(`#${e}_clear_logs`),L=t.querySelector(`#${e}_copy_debug_info`),j=t.querySelector(`#${e}_debug_log_viewer`);null==T||T.addEventListener("change",()=>{S(T.checked),toastr.info("Debug mode "+(T.checked?"enabled":"disabled"))}),null==I||I.addEventListener("click",()=>{null==j||j.classList.toggle("hidden"),(null==j?void 0:j.classList.contains("hidden"))||yt()}),null==R||R.addEventListener("click",()=>{m.length=0,yt(),toastr.info("Debug logs cleared")}),null==L||L.addEventListener("click",()=>{navigator.clipboard.writeText(_()),toastr.success("Debug info copied to clipboard")})}(),function(){const t=y();(function(t){const n=document.getElementById(`${e}_settings_modal`),r=null==n?void 0:n.querySelector(`#${e}_gen_source`);if(!r)return;r.innerHTML="";const s=document.getElementById("chat_completion_source");s&&Array.from(s.options).forEach(e=>{if(e.value){const t=document.createElement("option");t.value=e.value,t.textContent=e.textContent||e.value,r.appendChild(t)}});0===r.options.length&&["openrouter","openai","claude","makersuite","mistralai","groq"].forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,r.appendChild(t)});r.value=t})(t.generationConfig.source),$t(t.generationConfig.source,t.generationConfig.model)}(),g("info","Settings modal opened",null)})}function _t(t){const n="prompt"===t?w():E();return 0===n.length?`<div class="${e}_preset_empty">No presets</div>`:n.map(n=>`\n    <div class="${e}_preset_item ${n.isBuiltin?"builtin":""}" data-id="${n.id}">\n      <span class="${e}_preset_name">\n        ${n.isBuiltin?'<i class="fa-solid fa-lock"></i>':""}\n        ${bt(n.name)}\n      </span>\n      ${n.isBuiltin?"":`\n        <button class="${e}_preset_delete" data-type="${t}" data-id="${n.id}" title="Delete">\n          <i class="fa-solid fa-trash"></i>\n        </button>\n      `}\n    </div>\n  `).join("")}function vt(){const t=document.getElementById(`${e}_settings_modal`);if(!t)return;const n=t.querySelector(`#${e}_prompt_presets_list`),r=t.querySelector(`#${e}_schema_presets_list`);n&&(n.innerHTML=_t("prompt")),r&&(r.innerHTML=_t("schema"))}function yt(){const t=document.getElementById(`${e}_settings_modal`);if(!t)return;const n=t.querySelector(`#${e}_debug_log_list`),r=t.querySelector(`#${e}_debug_log_detail`);if(!n||!r)return;const s=[...m];n.innerHTML=s.length?s.map((t,n)=>`\n        <div class="${e}_debug_log_entry" data-index="${n}">\n          ${function(e){const t=e.timestamp.toLocaleTimeString();return`${{request:"📤",response:"📥",error:"❌",info:"ℹ️",state:"🔄"}[e.type]} [${t}] ${e.label}`}(t)}\n        </div>\n      `).join(""):`<div class="${e}_debug_log_empty">No logs</div>`,n.querySelectorAll(`.${e}_debug_log_entry`).forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.index||"0",10),n=s[t];n&&r&&(r.textContent=function(e){try{return null===e?"null":void 0===e?"undefined":"string"==typeof e?e:JSON.stringify(e,null,2)}catch(t){return String(e)}}(n.data))})})}function $t(t,n){const r=document.getElementById(`${e}_settings_modal`),s=null==r?void 0:r.querySelector(`#${e}_gen_model`);if(!s)return;s.innerHTML="";const i={openrouter:"model_openrouter_select",openai:"model_openai_select",claude:"model_claude_select",makersuite:"model_google_select",google:"model_google_select",mistralai:"model_mistralai_select",cohere:"model_cohere_select",perplexity:"model_perplexity_select",groq:"model_groq_select",ai21:"model_ai21_select",deepseek:"model_deepseek_select",custom:"model_custom_select"},a=i[t]?document.getElementById(i[t]):null;if(null==a?void 0:a.options.length)Array.from(a.options).forEach(e=>{if(e.value){const t=document.createElement("option");t.value=e.value,t.textContent=e.textContent||e.value,s.appendChild(t)}});else{const e=document.createElement("option");e.value=n||"",e.textContent=n||`No models for ${t}`,s.appendChild(e)}n&&Array.from(s.options).some(e=>e.value===n)?s.value=n:s.options.length&&(s.value=s.options[0].value,b({model:s.options[0].value}))}function bt(e){const{DOMPurify:t}=SillyTavern.libs,n="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(n,{ALLOWED_TAGS:[]})}var St=function(e,t,n,r){return new(n||(n=Promise))(function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,o)}c((r=r.apply(e,t||[])).next())})};function wt(t){const n=function(e){let t=5381;for(let n=0;n<e.length;n++)t=(t<<5)+t^e.charCodeAt(n);return(t>>>0).toString(36)}(`${t.avatar}::${t.name}`);return`${e}_history_${n}`}function Ct(e,t){return St(this,void 0,void 0,function*(){const{localforage:n}=SillyTavern.libs,r=wt(e);try{return yield n.setItem(r,{characterName:e.name,characterAvatar:e.avatar,history:t,savedAt:Date.now()}),g("info","Iteration history saved",{key:r,characterName:e.name,historyLength:t.length}),!0}catch(e){return h("Failed to save iteration history",{key:r,error:e}),!1}})}var xt=function(e,t,n,r){return new(n||(n=Promise))(function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,o)}c((r=r.apply(e,t||[])).next())})};let Et=null,Pt=null;const Ot=[];function kt(){const{eventSource:e,eventTypes:t}=SillyTavern.getContext(),n=()=>{g("info","API status changed",{isReady:Ce()}),At()},r=()=>{g("info","Main API changed",null),At(),Jt()},s=e=>{var t,n,r;const s=null!==(n=null===(t=e.detail)||void 0===t?void 0:t.character)&&void 0!==n?n:e.character,i=void 0!==(null===(r=e.detail)||void 0===r?void 0:r.id)?parseInt(e.detail.id,10):e.id;g("info","Character edited externally",{id:i,name:null==s?void 0:s.name}),Tt(i)},i=e=>{g("info","Character deleted",{id:e.id}),function(e){if(!Et)return;const t=Et.pipeline.characterIndex;if(null===t)return;if(t===e)It(),toastr.warning("Selected character was deleted");else if(t>e){const{characters:e}=SillyTavern.getContext(),n=e,r=t-1;r>=0&&r<n.length?(Et.pipeline=Object.assign(Object.assign({},Et.pipeline),{characterIndex:r,character:n[r]}),g("info","Character index adjusted after deletion",{oldIndex:t,newIndex:r})):It()}}(e.id)},a=()=>{g("info","OAI preset changed",null),Et&&Jt()},o=()=>{g("info","Chat completion source changed",null),At(),Jt()},c=()=>{g("info","Chat completion model changed",null),At(),Jt()};e.on(t.ONLINE_STATUS_CHANGED,n),e.on(t.MAIN_API_CHANGED,r),e.on(t.CHARACTER_EDITED,s),e.on(t.CHARACTER_DELETED,i),e.on(t.OAI_PRESET_CHANGED_AFTER,a),e.on(t.CHATCOMPLETION_SOURCE_CHANGED,o),e.on(t.CHATCOMPLETION_MODEL_CHANGED,c),Ot.push(()=>e.removeListener(t.ONLINE_STATUS_CHANGED,n),()=>e.removeListener(t.MAIN_API_CHANGED,r),()=>e.removeListener(t.CHARACTER_EDITED,s),()=>e.removeListener(t.CHARACTER_DELETED,i),()=>e.removeListener(t.OAI_PRESET_CHANGED_AFTER,a),()=>e.removeListener(t.CHATCOMPLETION_SOURCE_CHANGED,o),()=>e.removeListener(t.CHATCOMPLETION_MODEL_CHANGED,c)),g("info","Event listeners subscribed",{count:Ot.length})}function At(){if(!Pt)return;const t=xe(),n=Pt.querySelector(`.${e}_api_status`);if(n){n.className=`${e}_api_status ${t.isReady?"connected":"disconnected"}`;const r=n.querySelector("span");r&&(r.textContent=t.source)}zt()}function Tt(e){var t;if(!Et||null===Et.pipeline.characterIndex)return;const{characters:n}=SillyTavern.getContext(),r=n,s=Et.pipeline.characterIndex;if(void 0===e||e===s)if(s>=0&&s<r.length){const e=r[s];e.name===(null===(t=Et.pipeline.character)||void 0===t?void 0:t.name)?(Et.pipeline=Object.assign(Object.assign({},Et.pipeline),{character:e}),Ht(),Jt(),g("info","Character refreshed",{name:e.name})):It()}else It()}function It(){Et&&(g("info","Character invalidated, clearing selection",null),Et.pipeline=ie(Et.pipeline,null,null),Et.historyLoaded=!1,Mt(),toastr.info("Character selection cleared"))}let Rt=null;function Lt(){return xt(this,void 0,void 0,function*(){const{Popup:t,POPUP_TYPE:a}=SillyTavern.getContext(),{DOMPurify:o}=SillyTavern.libs;let c;jt=!1,Et={pipeline:se(),isGenerating:!1,isRefining:!1,abortController:null,activeStageView:"score",historyLoaded:!1,debouncedFunctions:[]};try{c=function(){const t=xe();return`\n    <div class="${e}_popup" id="${e}_popup">\n      \x3c!-- Header --\x3e\n      <div class="${e}_popup_header">\n        <div class="${e}_popup_title">\n          <i class="fa-solid fa-wand-magic-sparkles"></i>\n          <span>Character Tools</span>\n        </div>\n        <div class="${e}_popup_header_right">\n          <div class="${e}_api_status ${t.isReady?"connected":"disconnected"}">\n            <i class="fa-solid fa-circle"></i>\n            <span>${t.source}</span>\n          </div>\n          <button id="${e}_settings_btn" class="${e}_icon_btn" title="Settings">\n            <i class="fa-solid fa-gear"></i>\n          </button>\n          <button id="${e}_close_btn" class="${e}_icon_btn" title="Close">\n            <i class="fa-solid fa-xmark"></i>\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Character Section --\x3e\n      <div class="${e}_section" id="${e}_character_section">\n        <div class="${e}_section_header">\n          <i class="fa-solid fa-user"></i>\n          <span>Character</span>\n        </div>\n        <div id="${e}_character_select_container"></div>\n      </div>\n\n      \x3c!-- Pipeline Section --\x3e\n      <div class="${e}_section" id="${e}_pipeline_section">\n        <div class="${e}_section_header">\n          <i class="fa-solid fa-diagram-project"></i>\n          <span>Pipeline</span>\n        </div>\n        <div id="${e}_pipeline_nav_container"></div>\n      </div>\n\n      \x3c!-- Stage Config Section --\x3e\n      <div class="${e}_section" id="${e}_stage_section">\n        <div class="${e}_section_header">\n          <i class="fa-solid ${i.score}" id="${e}_stage_icon"></i>\n          <span id="${e}_stage_title">Score</span>\n        </div>\n        <div id="${e}_stage_config_container"></div>\n      </div>\n\n      \x3c!-- Results Section --\x3e\n      <div class="${e}_section ${e}_section_grow" id="${e}_results_section">\n        <div class="${e}_section_header">\n          <i class="fa-solid fa-file-lines"></i>\n          <span>Results</span>\n          <span id="${e}_iteration_indicator" class="${e}_iteration_indicator hidden"></span>\n        </div>\n        <div id="${e}_results_container"></div>\n        <div id="${e}_iteration_history_container"></div>\n      </div>\n    </div>\n  `}()}catch(e){return h("Failed to build popup content",e),toastr.error("Failed to open Character Tools. Check console for details."),void(Et=null)}if(new t(o.sanitize(c),a.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:!1,cancelButton:!1}).show().then(()=>{(null==Et?void 0:Et.abortController)&&Et.abortController.abort(),Et=null,Pt=null,jt=!1,Ot.forEach(e=>e()),Ot.length=0,g("info","Event listeners unsubscribed",null),Rt&&(document.removeEventListener("keydown",Rt),Rt=null),(null==Et?void 0:Et.debouncedFunctions)&&(Et.debouncedFunctions.forEach(e=>e.cancel()),Et.debouncedFunctions=[]),null==Te||Te.clear(),g("info","Popup closed",null)}),yield new Promise(e=>setTimeout(e,0)),Pt=document.getElementById(`${e}_popup`),!Pt)return h("Popup element not found after creation",null),toastr.error("Failed to initialize Character Tools popup."),void(Et=null);try{kt(),Rt=e=>{Et&&("Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),Et.isGenerating||Et.isRefining||qt(Et.activeStageView)),"Escape"===e.key&&(Et.isGenerating||Et.isRefining)&&Et.abortController&&Et.abortController.abort())},document.addEventListener("keydown",Rt);const{characters:t}=SillyTavern.getContext(),i=t;!function(t){var i,a;if(!Et||!Pt)return;const o=Pt.querySelector(`#${e}_character_select_container`);o&&(o.innerHTML=function(t,n){const r=null!==n?t[n]:null;return`\n    <div class="${e}_char_select">\n      \x3c!-- Search --\x3e\n      <div class="${e}_search_wrapper ${r?"hidden":""}">\n        <div class="${e}_search_container">\n          <i class="fa-solid fa-search ${e}_search_icon"></i>\n          <input\n            type="text"\n            id="${e}_char_search"\n            class="text_pole ${e}_search_input"\n            placeholder="Search characters..."\n            autocomplete="off"\n          >\n        </div>\n        <div id="${e}_char_dropdown" class="${e}_dropdown hidden"></div>\n      </div>\n\n      \x3c!-- Selected Character Preview --\x3e\n      ${r?Re(r):""}\n    </div>\n  `}(t,Et.pipeline.characterIndex),function(){if(!Pt||!Et)return;if(jt)return void g("info","Character select listeners already initialized, skipping",null);const{Fuse:t,lodash:n}=SillyTavern.libs,r=Pt.querySelector(`#${e}_character_select_container`);if(!r)return;const s=r.querySelector(`#${e}_char_search`),i=r.querySelector(`#${e}_char_dropdown`);if(!s||!i)return;jt=!0;let a=-1,o=[];const c=()=>{const{characters:n}=SillyTavern.getContext(),r=n.map((e,t)=>({char:e,index:t})).filter(({char:e})=>null==e?void 0:e.name),c=new t(r,{keys:["char.name","char.description"],threshold:.4,includeScore:!0,minMatchCharLength:1}),l=s.value.trim();if(!l)return i.classList.add("hidden"),void(o=[]);const u=c.search(l,{limit:10});if(o=u.map(e=>e.item),0===o.length)return i.innerHTML=`<div class="${e}_dropdown_empty">No characters found</div>`,void i.classList.remove("hidden");a=-1,je(o,i,-1),i.classList.remove("hidden")},l=n.debounce(c,150);Et.debouncedFunctions.push(l),s.addEventListener("input",l),s.addEventListener("keydown",e=>{0!==o.length&&("ArrowDown"===e.key?(e.preventDefault(),a=Math.min(a+1,o.length-1),je(o,i,a)):"ArrowUp"===e.key?(e.preventDefault(),a=Math.max(a-1,0),je(o,i,a)):"Enter"===e.key&&a>=0?(e.preventDefault(),Nt(o[a].char,o[a].index),i.classList.add("hidden"),s.value=""):"Escape"===e.key&&(i.classList.add("hidden"),s.value=""))});const u=e=>{s.contains(e.target)||i.contains(e.target)||i.classList.add("hidden")};document.addEventListener("click",u),Ot.push(()=>document.removeEventListener("click",u)),i.addEventListener("click",t=>{const n=t.target.closest(`.${e}_dropdown_item`);if(n){const e=parseInt(n.getAttribute("data-index")||"-1",10),t=o.find(t=>t.index===e);t&&(Nt(t.char,t.index),i.classList.add("hidden"),s.value="")}}),r.addEventListener("click",t=>{const n=t.target;if(n.closest(`#${e}_char_clear`)){if(!Et)return;return Et.pipeline=ie(Et.pipeline,null,null),Et.historyLoaded=!1,void Mt()}const s=n.closest(`.${e}_field_toggle`);if(s){const t=s.getAttribute("data-field"),n=r.querySelector(`#${e}_field_content_${t}`),i=s.querySelector("i");n&&i&&(n.classList.toggle("hidden"),i.classList.toggle("fa-chevron-right"),i.classList.toggle("fa-chevron-down"))}})}());const c=Pt.querySelector(`#${e}_pipeline_nav_container`);c&&(c.innerHTML=De(Et.pipeline.selectedStages,Et.pipeline.stageStatus,Et.activeStageView,!!Et.pipeline.character),function(){if(!Pt||!Et)return;const t=Pt.querySelector(`#${e}_pipeline_nav_container`);if(!t)return;t.addEventListener("change",t=>{const n=t.target;if(n.classList.contains(`${e}_stage_checkbox`)){const e=n.getAttribute("data-stage");e&&Et&&(Et.pipeline=function(e,t){const n=new Set(e.selectedStages);n.has(t)?n.delete(t):n.add(t);const s=r.filter(e=>n.has(e));return g("state","Stage toggled",{stage:t,selected:s}),Object.assign(Object.assign({},e),{selectedStages:s})}(Et.pipeline,e),zt())}}),t.addEventListener("click",t=>xt(this,void 0,void 0,function*(){const n=t.target.closest(`.${e}_stage_btn`);if(n&&Et){const e=n.getAttribute("data-stage");e&&(Et.activeStageView=e,Ft(),Ut(),Jt(),zt())}t.target.closest(`#${e}_run_selected_btn`)&&Dt();t.target.closest(`#${e}_run_all_btn`)&&function(){xt(this,void 0,void 0,function*(){Et&&(Et.pipeline.selectedStages=[...r],zt(),yield Dt())})}();if(t.target.closest(`#${e}_reset_pipeline_btn`)&&Et){const{Popup:e,POPUP_RESULT:t}=SillyTavern.getContext();if((yield e.show.confirm("Reset Pipeline?","This will clear all results and iteration history. Continue?"))!==t.AFFIRMATIVE)return;Et.pipeline=function(e,t=!1){const n=se();return t&&e.character&&(n.character=e.character,n.characterIndex=e.characterIndex),g("state","Pipeline reset",{keepCharacter:t,hasCharacter:!!n.character}),n}(Et.pipeline,!0),Et.historyLoaded=!0,Mt()}}))}());const l=Pt.querySelector(`#${e}_stage_config_container`);l&&(l.innerHTML=function(t,n,r){var i,a,o,c;const l=w(t),u=E(t);let d=n.customPrompt;if(n.promptPresetId){const e=C(n.promptPresetId);e&&(d=e.prompt)}let p=n.customSchema;if(n.schemaPresetId){const e=P(n.schemaPresetId);e&&(p=JSON.stringify(e.schema,null,2))}let f="",m={valid:!0};n.useStructuredOutput&&p.trim()&&(m=G(p),f=m.valid?(null===(i=m.warnings)||void 0===i?void 0:i.length)?`<div class="${e}_schema_status warning"><i class="fa-solid fa-triangle-exclamation"></i> ${m.warnings.length} warning(s)</div>`:`<div class="${e}_schema_status success"><i class="fa-solid fa-circle-check"></i> Valid schema</div>`:`<div class="${e}_schema_status error"><i class="fa-solid fa-circle-xmark"></i> ${Ue(m.error||"Invalid schema")}</div>`);let g='<i class="fa-solid fa-microchip"></i> Select a character',h="";r&&(g=`<i class="fa-solid fa-microchip"></i> ~${r.tokens.toLocaleString()} tokens (${r.percentage}%)`,r.percentage>80?h="danger":r.percentage>50&&(h="warning"));const _=n.promptPresetId?(null===(a=C(n.promptPresetId))||void 0===a?void 0:a.prompt)!==d:d.trim().length>0,v=n.schemaPresetId?JSON.stringify(null===(o=P(n.schemaPresetId))||void 0===o?void 0:o.schema,null,2)!==p:p.trim().length>0,y=n.useStructuredOutput&&p.trim()&&((null===(c=m.warnings)||void 0===c?void 0:c.length)||!m.valid);return`\n    <div class="${e}_stage_config">\n      \x3c!-- Prompt Section --\x3e\n      <div class="${e}_config_group">\n        <div class="${e}_config_header">\n          <span class="${e}_config_label">Prompt</span>\n          <div class="${e}_config_header_actions">\n            <button\n              id="${e}_save_prompt_preset_btn"\n              class="${e}_icon_btn"\n              title="Save as Preset"\n              ${_?"":"disabled"}\n            >\n              <i class="fa-solid fa-floppy-disk"></i>\n            </button>\n            <select id="${e}_prompt_preset_select" class="${e}_preset_select">\n              <option value="">Custom</option>\n              ${Ve(l,n.promptPresetId)}\n            </select>\n          </div>\n        </div>\n        <textarea\n          id="${e}_custom_prompt"\n          class="${e}_prompt_textarea text_pole"\n          placeholder="Enter your prompt for the ${s[t]} stage..."\n        >${Ue(d)}</textarea>\n        <div class="${e}_config_footer">\n          <span class="${e}_char_count">${d.length.toLocaleString()} chars</span>\n        </div>\n      </div>\n\n      \x3c!-- Structured Output Toggle --\x3e\n      <div class="${e}_config_group">\n        <label class="${e}_checkbox_label">\n          <input\n            type="checkbox"\n            id="${e}_use_structured"\n            ${n.useStructuredOutput?"checked":""}\n          >\n          <span>Use Structured Output (JSON Schema)</span>\n        </label>\n      </div>\n\n      \x3c!-- Schema Section --\x3e\n      <div class="${e}_schema_section ${n.useStructuredOutput?"":"hidden"}">\n        <div class="${e}_config_header">\n          <span class="${e}_config_label">JSON Schema</span>\n          <div class="${e}_config_header_actions">\n            <button\n              id="${e}_save_schema_preset_btn"\n              class="${e}_icon_btn"\n              title="Save as Preset"\n              ${v&&p.trim()?"":"disabled"}\n            >\n              <i class="fa-solid fa-floppy-disk"></i>\n            </button>\n            <select id="${e}_schema_preset_select" class="${e}_preset_select">\n              <option value="">Custom</option>\n              ${Ve(u,n.schemaPresetId)}\n            </select>\n          </div>\n        </div>\n        <textarea\n          id="${e}_custom_schema"\n          class="${e}_schema_textarea text_pole"\n          placeholder='{"name": "MySchema", "value": {"type": "object", ...}}'\n        >${Ue(p)}</textarea>\n        ${f}\n\n        \x3c!-- Schema Actions --\x3e\n        <div class="${e}_schema_actions">\n          <button\n            id="${e}_generate_schema_btn"\n            class="menu_button menu_button_icon"\n            title="Generate schema from description"\n          >\n            <i class="fa-solid fa-wand-magic-sparkles"></i>\n            <span>Generate</span>\n          </button>\n          <button\n            id="${e}_validate_schema_btn"\n            class="menu_button menu_button_icon"\n            title="Validate schema"\n            ${p.trim()?"":"disabled"}\n          >\n            <i class="fa-solid fa-check-double"></i>\n            <span>Validate</span>\n          </button>\n          <button\n            id="${e}_fix_schema_btn"\n            class="menu_button menu_button_icon"\n            title="Auto-fix schema (adds additionalProperties: false, etc.)"\n            ${y?"":"disabled"}\n          >\n            <i class="fa-solid fa-wrench"></i>\n            <span>Auto-Fix</span>\n          </button>\n          <button\n            id="${e}_format_schema_btn"\n            class="menu_button menu_button_icon"\n            title="Format/prettify JSON"\n            ${p.trim()?"":"disabled"}\n          >\n            <i class="fa-solid fa-align-left"></i>\n            <span>Format</span>\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Actions --\x3e\n      <div class="${e}_config_actions">\n        <div id="${e}_token_estimate" class="${e}_token_estimate ${h}">\n          ${g}\n        </div>\n      </div>\n    </div>\n  `}(Et.activeStageView,Et.pipeline.configs[Et.activeStageView],null),function(){if(!Pt||!Et)return;const t=Pt.querySelector(`#${e}_stage_config_container`);if(!t)return;t.addEventListener("change",t=>{const n=t.target;if(n.id===`${e}_prompt_preset_select`&&Et){const e=n.value||null;Et.pipeline=le(Et.pipeline,Et.activeStageView,{promptPresetId:e}),Vt(),Jt()}if(n.id===`${e}_schema_preset_select`&&Et){const e=n.value||null;Et.pipeline=le(Et.pipeline,Et.activeStageView,{schemaPresetId:e}),Vt()}});const{lodash:n}=SillyTavern.libs,r=n.debounce(t=>{if(!Et)return void g("info","Debounced input handler fired after popup closed, ignoring",null);const n=t.target;n.id===`${e}_custom_prompt`&&(Et.pipeline=le(Et.pipeline,Et.activeStageView,{customPrompt:n.value,promptPresetId:null}),Jt(),Vt()),n.id===`${e}_custom_schema`&&(Et.pipeline=le(Et.pipeline,Et.activeStageView,{customSchema:n.value,schemaPresetId:null}),Vt())},300);Et.debouncedFunctions.push(r),t.addEventListener("input",r),t.addEventListener("change",t=>{const n=t.target;n.id===`${e}_use_structured`&&Et&&(Et.pipeline=le(Et.pipeline,Et.activeStageView,{useStructuredOutput:n.checked}),Vt())}),t.addEventListener("click",t=>xt(this,void 0,void 0,function*(){const n=t.target;if(n.closest(`#${e}_run_stage_btn`)&&Et)return void qt(Et.activeStageView);if(n.closest(`#${e}_save_prompt_preset_btn`)&&Et){const t=null==Pt?void 0:Pt.querySelector(`#${e}_custom_prompt`);if(t){const e=yield function(e,t){return Me(this,void 0,void 0,function*(){const{Popup:n,POPUP_RESULT:r}=SillyTavern.getContext();if(!t.trim())return toastr.warning("No prompt content to save"),{success:!1};const i=yield n.show.input("Save Prompt Preset","Enter a name for this preset:",`Custom ${s[e]} Prompt`);if(null===i||i===r.CANCELLED)return{success:!1};if(!i.trim())return toastr.warning("Preset name cannot be empty"),{success:!1};try{const n=x({name:i.trim(),prompt:t,stages:[e]});return toastr.success(`Prompt preset "${i}" saved`),{success:!0,presetId:n.id}}catch(e){return toastr.error(`Failed to save preset: ${e.message}`),{success:!1}}})}(Et.activeStageView,t.value);e.success&&e.presetId&&(Et.pipeline=le(Et.pipeline,Et.activeStageView,{promptPresetId:e.presetId,customPrompt:""}),Vt())}return}if(n.closest(`#${e}_save_schema_preset_btn`)&&Et){const t=null==Pt?void 0:Pt.querySelector(`#${e}_custom_schema`);if(t){const e=yield function(e,t){return Me(this,void 0,void 0,function*(){const{Popup:n,POPUP_RESULT:r}=SillyTavern.getContext();if(!t.trim())return toastr.warning("No schema content to save"),{success:!1};const i=G(t);if(!i.valid)return toastr.error(`Invalid schema: ${i.error}`),{success:!1};const a=yield n.show.input("Save Schema Preset","Enter a name for this preset:",`Custom ${s[e]} Schema`);if(null===a||a===r.CANCELLED)return{success:!1};if(!a.trim())return toastr.warning("Preset name cannot be empty"),{success:!1};try{const t=O({name:a.trim(),schema:i.schema,stages:[e]});return toastr.success(`Schema preset "${a}" saved`),{success:!0,presetId:t.id}}catch(e){return toastr.error(`Failed to save preset: ${e.message}`),{success:!1}}})}(Et.activeStageView,t.value);e.success&&e.presetId&&(Et.pipeline=le(Et.pipeline,Et.activeStageView,{schemaPresetId:e.presetId,customSchema:""}),Vt())}return}if(n.closest(`#${e}_generate_schema_btn`)&&Et){const t=yield He();if(t){const n=null==Pt?void 0:Pt.querySelector(`#${e}_custom_schema`);n&&(n.value=t,Et.pipeline=le(Et.pipeline,Et.activeStageView,{customSchema:t,schemaPresetId:null}),Vt())}return}if(n.closest(`#${e}_validate_schema_btn`)&&Et){const t=null==Pt?void 0:Pt.querySelector(`#${e}_custom_schema`);return void(t&&(yield function(e){return Me(this,void 0,void 0,function*(){var t,n;if(!e.trim())return void toastr.warning("No schema to validate");const r=G(e);if(!r.valid)return void toastr.error(`Invalid: ${r.error}`);const{Popup:s,POPUP_TYPE:i}=SillyTavern.getContext();if(null===(t=r.warnings)||void 0===t?void 0:t.length)if(r.warnings.length>2){const e=`\n                <h3>Schema Valid with Warnings</h3>\n                <ul>\n                    ${r.warnings.map(e=>`<li>${e}</li>`).join("")}\n                </ul>\n            `;yield new s(e,i.TEXT,"",{wide:!1}).show()}else toastr.warning(`Valid with ${r.warnings.length} warning(s):\n${r.warnings.join("\n")}`);else if(null===(n=r.info)||void 0===n?void 0:n.length)if(r.info.length>2){const e=`\n                <h3>Schema Valid</h3>\n                <ul>\n                    ${r.info.map(e=>`<li>${e}</li>`).join("")}\n                </ul>\n            `;yield new s(e,i.TEXT,"",{wide:!1}).show()}else toastr.success(`Valid!\n${r.info.join("\n")}`);else toastr.success("Schema is valid!")})}(t.value)))}if(n.closest(`#${e}_fix_schema_btn`)&&Et){const t=null==Pt?void 0:Pt.querySelector(`#${e}_custom_schema`);if(t){const e=function(e){var t;if(!e.trim())return toastr.warning("No schema to fix"),null;const n=G(e);if(!n.schema)return toastr.error("Cannot fix: schema is not valid JSON or missing required structure"),null;try{const e=Z(n.schema),r=JSON.stringify(e,null,2),s=G(r);return s.valid?(null===(t=s.warnings)||void 0===t?void 0:t.length)?toastr.info(`Fixed! ${s.warnings.length} warning(s) remain`):toastr.success("Schema fixed successfully!"):toastr.warning("Auto-fix applied but schema still has issues"),r}catch(e){return toastr.error(`Fix failed: ${e.message}`),null}}(t.value);e&&(t.value=e,Et.pipeline=le(Et.pipeline,Et.activeStageView,{customSchema:e,schemaPresetId:null}),Vt())}return}if(n.closest(`#${e}_format_schema_btn`)&&Et){const t=null==Pt?void 0:Pt.querySelector(`#${e}_custom_schema`);if(t){const e=function(e){if(!e.trim())return toastr.warning("No schema to format"),null;try{const t=JSON.parse(e),n=JSON.stringify(t,null,2);return toastr.success("Schema formatted"),n}catch(e){return toastr.error(`Cannot format: ${e.message}`),null}}(t.value);e&&(t.value=e,Et.pipeline=le(Et.pipeline,Et.activeStageView,{customSchema:e,schemaPresetId:null}),Vt())}return}}))}());const u=Pt.querySelector(`#${e}_results_container`);u&&(u.innerHTML=(d=Et.activeStageView,p=Et.pipeline.results[Et.activeStageView],f=Et.pipeline.stageStatus[Et.activeStageView],Et.isGenerating&&"running"===f?it(d):p?ot(d,p):at(d,f)),function(){if(!Pt||!Et)return;const t=Pt.querySelector(`#${e}_results_container`);if(!t)return;t.addEventListener("click",t=>xt(this,void 0,void 0,function*(){const r=t.target;if(r.closest(`#${e}_regenerate_btn`)&&Et&&(Et.pipeline=function(e,t){return g("state","Stage result cleared",{stage:t}),Object.assign(Object.assign({},e),{results:Object.assign(Object.assign({},e.results),{[t]:null}),stageStatus:Object.assign(Object.assign({},e.stageStatus),{[t]:"pending"})})}(Et.pipeline,Et.activeStageView),qt(Et.activeStageView)),r.closest(`#${e}_lock_btn`)&&Et&&(Et.pipeline=function(e,t){const n=e.results[t];return n?(g("state","Stage locked",{stage:t}),Object.assign(Object.assign({},e),{results:Object.assign(Object.assign({},e.results),{[t]:Object.assign(Object.assign({},n),{locked:!0})})})):e}(Et.pipeline,Et.activeStageView),Ut()),r.closest(`#${e}_unlock_btn`)&&Et&&(Et.pipeline=function(e,t){const n=e.results[t];return n?(g("state","Stage unlocked",{stage:t}),Object.assign(Object.assign({},e),{results:Object.assign(Object.assign({},e.results),{[t]:Object.assign(Object.assign({},n),{locked:!1})})})):e}(Et.pipeline,Et.activeStageView),Ut()),r.closest(`#${e}_continue_btn`)&&Et){const e=ge(Et.pipeline,Et.activeStageView);e&&(Et.activeStageView=e,Ft(),Ut(),Jt())}var s;if(r.closest(`#${e}_apply_btn`)&&Et&&(yield function(){return xt(this,void 0,void 0,function*(){if(!Et||!Et.pipeline.results.rewrite||!Et.pipeline.character)return void toastr.warning("No rewrite to apply");const{Popup:t,POPUP_TYPE:r,POPUP_RESULT:s}=SillyTavern.getContext(),{DOMPurify:i}=SillyTavern.libs,a=fe(Et.pipeline.results.rewrite.response);let o=`<div class="${e}_apply_preview">`;if(o+=`<p><strong>Parse method:</strong> ${a.parseMethod}</p>`,0===a.fields.length)o+=`<p class="${e}_apply_warning">\n            <i class="fa-solid fa-triangle-exclamation"></i>\n            No recognized character fields found in the rewrite output.\n            The raw content will be copied to clipboard instead.\n        </p>`,o+=`<details><summary>Raw content preview</summary><pre>${i.sanitize(a.raw.substring(0,500))}...</pre></details>`;else{o+=`<p><strong>Fields to update (${a.fields.length}):</strong></p>`,o+="<ul>";for(const e of a.fields){const t=e.value.substring(0,100);o+=`<li><strong>${i.sanitize(e.label)}:</strong> ${i.sanitize(t)}${e.value.length>100?"...":""}</li>`}o+="</ul>"}o+="</div>";const c=new t(`\n        <h3>Apply Rewrite to Character?</h3>\n        <p>This will update <strong>${i.sanitize(Et.pipeline.character.name)}</strong> with the rewritten content.</p>\n        ${o}\n    `,r.CONFIRM,"",{wide:!0,okButton:a.fields.length>0?"Apply Changes":"Copy Raw Content",cancelButton:"Cancel"});if((yield c.show())!==s.AFFIRMATIVE)return;if(0===a.fields.length)return navigator.clipboard.writeText(a.raw),void toastr.info("Raw content copied to clipboard");const l=yield function(e,t){return re(this,void 0,void 0,function*(){if(!e.character||null===e.characterIndex)return{success:!1,error:"No character selected",updatedFields:[]};const{characters:r,unshallowCharacter:s,getRequestHeaders:i}=SillyTavern.getContext();try{yield s(e.characterIndex);const a=r[e.characterIndex];if(!a)return{success:!1,error:"Character not found after unshallow",updatedFields:[]};const o={},c=[];for(const e of t)n.find(t=>t.key===e.key)&&e.value.trim()&&(o[e.key]=e.value.trim(),c.push(e.label));if(0===c.length)return{success:!1,error:"No valid fields to update",updatedFields:[]};Object.assign(a,o);const l=yield fetch("/api/characters/edit",{method:"POST",headers:i(),body:JSON.stringify(Object.assign({avatar_url:a.avatar},a))});if(!l.ok){const e=yield l.text();return h("Failed to save character",{status:l.status,error:e}),{success:!1,error:`Save failed: ${l.status}`,updatedFields:[]}}return g("info","Character updated successfully",{name:a.name,updatedFields:c}),{success:!0,updatedFields:c}}catch(e){return h("Error applying rewrite to character",e),{success:!1,error:e.message,updatedFields:[]}}})}(Et.pipeline,a.fields);if(l.success){toastr.success(`Updated ${l.updatedFields.length} fields: ${l.updatedFields.join(", ")}`);const{eventSource:e}=SillyTavern.getContext();yield e.emit("character_tools_rewrite_applied",{characterName:Et.pipeline.character.name,characterIndex:Et.pipeline.characterIndex,updatedFields:l.updatedFields,iterationCount:Et.pipeline.iterationCount}),Tt()}else toastr.error(l.error||"Failed to apply changes")})}()),r.closest(`#${e}_refine_btn`)&&Et&&function(){xt(this,void 0,void 0,function*(){if(!Et||Et.isGenerating||Et.isRefining)return;if(!Ce())return void toastr.error("API is not connected");const t=ce(Et.pipeline);if(!t.canRun)return void toastr.warning(t.reason||"Cannot refine");const n=function(e){const t=[],n=[];e.character||t.push("No character selected"),e.results.rewrite||t.push("No rewrite to refine"),e.results.analyze||t.push("Run analyze first to identify issues");const{onlineStatus:r}=SillyTavern.getContext();"Valid"!==r&&"Connected"!==r&&t.push("API is not connected");const s=e.iterationHistory.length>0?e.iterationHistory[e.iterationHistory.length-1]:null;return"accept"===(null==s?void 0:s.verdict)&&n.push("Last analysis suggested accepting the rewrite"),e.iterationCount>=5&&n.push(`Already at iteration ${e.iterationCount+1} - consider accepting or starting fresh`),{valid:0===t.length,errors:t,warnings:n}}(Et.pipeline);if(!n.valid)return void toastr.error(n.errors.join("\n"));n.warnings.length>0&&toastr.warning(n.warnings.join("\n"));const r={iterationCount:Et.pipeline.iterationCount,iterationHistory:[...Et.pipeline.iterationHistory]};Et.pipeline=pe(Et.pipeline),Et.isRefining=!0,Et.abortController=new AbortController;const s=null==Pt?void 0:Pt.querySelector(`#${e}_results_container`);var i;s&&(s.innerHTML=(i=Et.pipeline.iterationCount,`\n    <div class="${e}_results_loading">\n      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>\n      <p>Refining (Iteration #${i+1})...</p>\n      <button id="${e}_cancel_btn" class="menu_button">\n        <i class="fa-solid fa-stop"></i>\n        <span>Cancel</span>\n      </button>\n    </div>\n  `)),Gt(),Bt();try{const e=yield function(e,t){return Se(this,void 0,void 0,function*(){const n=SillyTavern.getContext(),r=y();if(null==t?void 0:t.aborted)return{success:!1,error:"Generation cancelled"};if(!e.character)return{success:!1,error:"No character selected"};if(!e.results.rewrite||!e.results.analyze)return{success:!1,error:"Refinement requires both rewrite and analyze results"};if(!Ce())return h("API not ready",{onlineStatus:n.onlineStatus}),{success:!1,error:"API is not connected. Check your connection settings."};const s=ve(e);if(!s)return{success:!1,error:"Failed to build refinement prompt"};const i=ke(s,e.character.name,n.name1||"User");return g("info","Starting refinement generation",{iteration:e.iterationCount+1,character:e.character.name,promptLength:i.length}),yield Pe(r.systemPrompt,i,null,t,r.useCurrentSettings)})}(Et.pipeline,Et.abortController.signal);e.success?(Et.pipeline=function(e,t){const n=Object.assign(Object.assign({},t),{timestamp:Date.now(),locked:!1});return g("state","Refinement completed",{iteration:e.iterationCount,responseLength:t.response.length}),Object.assign(Object.assign({},e),{currentStage:null,results:Object.assign(Object.assign({},e.results),{rewrite:n}),stageStatus:Object.assign(Object.assign({},e.stageStatus),{rewrite:"complete",analyze:"pending"})})}(Et.pipeline,{response:e.response,isStructured:!1,promptUsed:"[Refinement prompt]",schemaUsed:null}),toastr.success(`Refinement #${Et.pipeline.iterationCount} complete`),Et.pipeline.character&&(yield Ct(Et.pipeline.character,Et.pipeline.iterationHistory)),Et.activeStageView="analyze"):(Et.pipeline=Object.assign(Object.assign({},Et.pipeline),{iterationCount:r.iterationCount,iterationHistory:r.iterationHistory}),"Generation cancelled"!==e.error&&toastr.error(e.error))}catch(e){Et.pipeline=Object.assign(Object.assign({},Et.pipeline),{iterationCount:r.iterationCount,iterationHistory:r.iterationHistory}),toastr.error(e.message)}finally{Et.isRefining=!1,Et.abortController=null,Mt()}})}(),r.closest(`#${e}_accept_btn`)&&Et&&(Et.pipeline=(s=Et.pipeline).results.rewrite?(g("state","Rewrite accepted as final",{iteration:s.iterationCount}),Object.assign(Object.assign({},s),{results:Object.assign(Object.assign({},s.results),{rewrite:Object.assign(Object.assign({},s.results.rewrite),{locked:!0})}),isRefining:!1})):s,toastr.success("Rewrite accepted as final"),Mt()),r.closest(`#${e}_copy_btn`)&&Et){const e=Et.pipeline.results[Et.activeStageView];e&&(navigator.clipboard.writeText(e.response),toastr.success("Copied to clipboard"))}r.closest(`#${e}_export_btn`)&&Et&&(Et.pipeline=be(Et.pipeline),Et.pipeline.exportData&&(navigator.clipboard.writeText(Et.pipeline.exportData),toastr.success("Export copied to clipboard"))),r.closest(`#${e}_cancel_btn`)&&(null==Et?void 0:Et.abortController)&&Et.abortController.abort()}))}());var d,p,f;const m=Pt.querySelector(`#${e}_iteration_history_container`);m&&(m.innerHTML=lt(Et.pipeline.iterationHistory,Et.pipeline.iterationCount,Et.historyLoaded),function(){if(!Pt||!Et)return;const t=Pt.querySelector(`#${e}_iteration_history_container`);if(!t)return;t.addEventListener("click",t=>xt(this,void 0,void 0,function*(){const n=t.target,r=n.closest(`.${e}_iteration_revert_btn`);if(r&&Et){const e=parseInt(r.getAttribute("data-index")||"-1",10);e>=0&&(yield function(e){return xt(this,void 0,void 0,function*(){if(!Et)return;const{Popup:t,POPUP_RESULT:n}=SillyTavern.getContext();(yield t.show.confirm("Revert to Previous Iteration?",`This will restore the rewrite from iteration #${e+1} and discard later changes.`))===n.AFFIRMATIVE&&(Et.pipeline=function(e,t){if(t<0||t>=e.iterationHistory.length)return h("Invalid iteration index",{iterationIndex:t,historyLength:e.iterationHistory.length}),e;const n=e.iterationHistory[t];g("state","Reverting to iteration",{iteration:n.iteration});const r={response:n.rewriteResponse,isStructured:!1,promptUsed:"[Restored from iteration history]",schemaUsed:null,timestamp:Date.now(),locked:!1},s=e.iterationHistory.slice(0,t);return Object.assign(Object.assign({},e),{results:Object.assign(Object.assign({},e.results),{rewrite:r,analyze:null}),stageStatus:Object.assign(Object.assign({},e.stageStatus),{rewrite:"complete",analyze:"pending"}),iterationCount:n.iteration,iterationHistory:s,isRefining:!0})}(Et.pipeline,e),toastr.info(`Reverted to iteration #${e+1}`),Et.pipeline.character&&(yield Ct(Et.pipeline.character,Et.pipeline.iterationHistory)),Mt())})}(e))}const s=n.closest(`.${e}_iteration_view_btn`);if(s&&Et){const t=parseInt(s.getAttribute("data-index")||"-1",10);t>=0&&t<Et.pipeline.iterationHistory.length&&function(t){xt(this,void 0,void 0,function*(){const{Popup:n,POPUP_TYPE:r}=SillyTavern.getContext(),{DOMPurify:s}=SillyTavern.libs,i=function(t){const{moment:n}=SillyTavern.libs;return`\n    <div class="${e}_iteration_view">\n      <div class="${e}_iteration_view_header">\n        <h3>Iteration #${t.iteration+1}</h3>\n        <span class="${e}_iteration_verdict ${pt(t.verdict)}">\n          <i class="fa-solid ${dt(t.verdict)}"></i>\n          ${ft(t.verdict)}\n        </span>\n        <span class="${e}_iteration_time">${n(t.timestamp).format("YYYY-MM-DD HH:mm:ss")}</span>\n      </div>\n\n      <div class="${e}_iteration_view_section">\n        <h4>Rewrite</h4>\n        <div class="${e}_iteration_view_content">\n          ${mt(t.rewriteResponse)}\n        </div>\n      </div>\n\n      <div class="${e}_iteration_view_section">\n        <h4>Analysis</h4>\n        <div class="${e}_iteration_view_content">\n          ${mt(t.analysisResponse)}\n        </div>\n      </div>\n    </div>\n  `}(t),a=new n(s.sanitize(i),r.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:"Close",cancelButton:!1});yield a.show()})}(Et.pipeline.iterationHistory[t])}}))}());null===(i=Pt.querySelector(`#${e}_settings_btn`))||void 0===i||i.addEventListener("click",()=>{ht(()=>{Et&&function(){if(!Et)return;for(const e of r){const t=Et.pipeline.configs[e];t.promptPresetId&&!C(t.promptPresetId)&&(g("info","Clearing deleted prompt preset reference",{stage:e,presetId:t.promptPresetId}),Et.pipeline=le(Et.pipeline,e,{promptPresetId:null})),t.schemaPresetId&&!P(t.schemaPresetId)&&(g("info","Clearing deleted schema preset reference",{stage:e,presetId:t.schemaPresetId}),Et.pipeline=le(Et.pipeline,e,{schemaPresetId:null}))}}(),Mt()})}),null===(a=Pt.querySelector(`#${e}_close_btn`))||void 0===a||a.addEventListener("click",()=>{const e=null==Pt?void 0:Pt.closest(".popup");if(e){const t=e.querySelector(".popup-button-cancel, .popup-button-ok");null==t||t.click()}})}(i),Mt(),g("info","Popup opened",{characterCount:i.length})}catch(e){h("Failed to initialize popup components",e),toastr.error("Character Tools opened but some features may not work.")}})}let jt=!1;function Nt(t,n){return xt(this,void 0,void 0,function*(){if(!Et)return;const r=n;Et.pipeline=ie(Et.pipeline,t,n),Et.historyLoaded=!1,Mt();const s=yield function(e){return St(this,void 0,void 0,function*(){const{localforage:t}=SillyTavern.libs,n=wt(e);try{const r=yield t.getItem(n);return r?r.characterName!==e.name||r.characterAvatar!==e.avatar?(g("info","Iteration history mismatch, ignoring",{key:n,storedName:r.characterName,currentName:e.name}),null):(g("info","Iteration history loaded",{key:n,characterName:e.name,historyLength:r.history.length,savedAt:new Date(r.savedAt).toISOString()}),r.history):(g("info","No iteration history found",{key:n}),null)}catch(e){return h("Failed to load iteration history",{key:n,error:e}),null}})}(t);Et&&Et.pipeline.characterIndex===r&&(s&&s.length>0&&(Et.pipeline=Object.assign(Object.assign({},Et.pipeline),{iterationHistory:s,iterationCount:s.length}),g("info","Loaded iteration history",{count:s.length})),Et.historyLoaded=!0,Bt()),setTimeout(()=>xt(this,void 0,void 0,function*(){if(!Pt||!(null==Et?void 0:Et.pipeline.character))return;if(Et.pipeline.characterIndex!==r)return;const t=Pt.querySelector(`#${e}_character_select_container`);if(t){const e=qe(Et.pipeline.character);yield Le(t,e)}}),50),g("info","Character selected",{name:t.name,index:n})})}function qt(e){return xt(this,void 0,void 0,function*(){if(!Et||Et.isGenerating||Et.isRefining)return;if(!Ce())return void toastr.error("API is not connected");const t=function(e,t){var n;if(!e.character)return{canRun:!1,reason:"No character selected"};switch(t){case"score":return{canRun:!0};case"rewrite":return e.selectedStages.includes("score")&&!(null===(n=e.results.score)||void 0===n?void 0:n.locked)?{canRun:!0,reason:"Score stage not complete - rewrite will run without score feedback"}:{canRun:!0};case"analyze":return e.results.rewrite?{canRun:!0}:{canRun:!1,reason:"Analyze requires rewrite results to compare"};default:return{canRun:!1,reason:"Unknown stage"}}}(Et.pipeline,e);if(!t.canRun)return void toastr.warning(t.reason||"Cannot run this stage");t.reason&&toastr.info(t.reason),Et.isGenerating=!0,Et.abortController=new AbortController,Et.pipeline=function(e,t){return g("state","Stage started",{stage:t}),Object.assign(Object.assign({},e),{currentStage:t,stageStatus:Object.assign(Object.assign({},e.stageStatus),{[t]:"running"})})}(Et.pipeline,e),Mt();const n=_e(Et.pipeline,e)||"",r=$e(Et.pipeline,e);try{const t=yield Ee(Et.pipeline,e,Et.abortController.signal);t.success?(Et.pipeline=function(e,t,n){const r=Object.assign(Object.assign({},n),{timestamp:Date.now(),locked:!1});g("state","Stage completed",{stage:t,responseLength:n.response.length,isStructured:n.isStructured});const s="analyze"===t&&null!==e.results.rewrite;return Object.assign(Object.assign({},e),{currentStage:null,stageStatus:Object.assign(Object.assign({},e.stageStatus),{[t]:"complete"}),results:Object.assign(Object.assign({},e.results),{[t]:r}),isRefining:s})}(Et.pipeline,e,{response:t.response,isStructured:t.isStructured,promptUsed:n,schemaUsed:r}),toastr.success(`${s[e]} complete`)):(Et.pipeline=ue(Et.pipeline,e,t.error),"Generation cancelled"!==t.error&&toastr.error(t.error))}catch(t){Et.pipeline=ue(Et.pipeline,e,t.message),toastr.error(t.message)}finally{Et.isGenerating=!1,Et.abortController=null,Mt()}})}function Dt(){return xt(this,void 0,void 0,function*(){if(!Et||Et.isGenerating||Et.isRefining)return;if(!Ce())return void toastr.error("API is not connected");const e=function(e){const t=[],n=[];e.character||t.push("No character selected"),0===e.selectedStages.length&&t.push("No stages selected");for(const r of e.selectedStages)X(e.configs[r]).trim()||t.push(`${r}: No prompt configured`),"rewrite"===r&&!e.results.score&&e.selectedStages.includes("score")&&n.push("Rewrite will run without score feedback (score not complete)"),"analyze"!==r||e.results.rewrite||t.push("Analyze requires rewrite results");const{onlineStatus:r}=SillyTavern.getContext();return"Valid"!==r&&"Connected"!==r&&t.push("API is not connected"),{valid:0===t.length,errors:t,warnings:n}}(Et.pipeline);if(e.valid){e.warnings.length>0&&toastr.warning(e.warnings.join("\n"));for(const e of Et.pipeline.selectedStages){const t=Et.pipeline.stageStatus[e];if("complete"===t||"skipped"===t)continue;if(Et.activeStageView=e,Ft(),yield qt(e),!Et)break;if("complete"!==Et.pipeline.stageStatus[e])break}}else toastr.error(e.errors.join("\n"))})}function Mt(){Ht(),zt(),Ft(),Ut(),Jt(),Gt(),Bt()}function Ht(){if(!Pt||!Et)return;const t=Pt.querySelector(`#${e}_character_select_container`);t&&function(t,n){const r=t.querySelector(`.${e}_search_wrapper`),s=t.querySelector(`#${e}_char_preview`);if(n){if(null==r||r.classList.add("hidden"),!s){const r=Re(n),s=t.querySelector(`.${e}_search_wrapper`);s&&s.insertAdjacentHTML("afterend",r)}}else{null==r||r.classList.remove("hidden"),null==s||s.remove();const n=t.querySelector(`#${e}_char_search`);n&&(n.value="")}}(t,Et.pipeline.character,Et.pipeline.characterIndex)}function zt(){if(!Pt||!Et)return;const t=Pt.querySelector(`#${e}_pipeline_nav_container`);t&&function(t,n,s,i,a,o){for(const a of r){const r=t.querySelector(`#${e}_stage_cb_${a}`),o=t.querySelector(`.${e}_stage_btn[data-stage="${a}"]`),c=t.querySelector(`.${e}_stage_node:has([data-stage="${a}"])`);if(r&&(r.checked=n.includes(a)),o&&o.classList.toggle("active",a===i),c){c.classList.toggle("active",a===i);for(const t of["pending","running","complete","skipped"])c.classList.toggle(`${e}_stage_${t}`,s[a]===t)}const l=null==c?void 0:c.querySelector(`.${e}_stage_connector`);null==l||l.classList.toggle("active",n.includes(a))}const c=t.querySelector(`#${e}_run_selected_btn`),l=t.querySelector(`#${e}_run_all_btn`),u=t.querySelector(`#${e}_reset_pipeline_btn`);c&&(c.disabled=!a||o),l&&(l.disabled=!a||o),u&&(u.disabled=o)}(t,Et.pipeline.selectedStages,Et.pipeline.stageStatus,Et.activeStageView,!!Et.pipeline.character&&Ce(),Et.isGenerating||Et.isRefining)}function Ft(){if(!Pt||!Et)return;const t=Pt.querySelector(`#${e}_stage_icon`),n=Pt.querySelector(`#${e}_stage_title`);t&&(t.className=`fa-solid ${i[Et.activeStageView]}`),n&&(n.textContent=s[Et.activeStageView]),Vt()}function Vt(){if(!Pt||!Et)return;const t=Pt.querySelector(`#${e}_stage_config_container`);t&&Fe(t,Et.activeStageView,Et.pipeline.configs[Et.activeStageView],Et.isGenerating||Et.isRefining)}function Ut(){if(!Pt||!Et)return;const t=Pt.querySelector(`#${e}_results_container`);t&&ct(t,Et.activeStageView,Et.pipeline.results[Et.activeStageView],Et.pipeline.stageStatus[Et.activeStageView],Et.isGenerating,ge(Et.pipeline,Et.activeStageView),Et.pipeline)}function Gt(){if(!Pt||!Et)return;const t=Pt.querySelector(`#${e}_iteration_indicator`);t&&(Et.pipeline.iterationCount>0||Et.pipeline.isRefining?(t.classList.remove("hidden"),t.innerHTML=`\n      <i class="fa-solid fa-arrows-rotate"></i>\n      Iteration #${Et.pipeline.iterationCount+1}\n    `):t.classList.add("hidden"))}function Bt(){if(!Pt||!Et)return;const t=Pt.querySelector(`#${e}_iteration_history_container`);t&&function(t,n,r,s){const i=t.querySelector(`#${e}_iteration_history`);if(!i&&(n.length>0||r>0)){const e=lt(n,r,s);t.insertAdjacentHTML("beforeend",e)}else if(i){const t=i.querySelector(`.${e}_iteration_count`);t&&(t.textContent=r>0?`Current: #${r+1}`:"Initial");const a=i.querySelector(`.${e}_iteration_list`);a&&(s?0===n.length?a.innerHTML=`<div class="${e}_iteration_empty">No previous iterations</div>`:a.innerHTML=n.map((e,t)=>ut(e,t)).join(""):a.innerHTML=`<div class="${e}_iteration_loading">\n                    <i class="fa-solid fa-spinner fa-spin"></i>\n                    <span>Loading history...</span>\n                </div>`)}}(t,Et.pipeline.iterationHistory,Et.pipeline.iterationCount,Et.historyLoaded)}function Jt(){return xt(this,void 0,void 0,function*(){if(!Pt||!Et)return;const t=Pt.querySelector(`#${e}_token_estimate`);if(!t)return;if(!Et.pipeline.character)return t.innerHTML='<i class="fa-solid fa-microchip"></i> Select a character',void(t.className=`${e}_token_estimate`);let n;if(t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>',t.className=`${e}_token_estimate`,n=Et.pipeline.isRefining&&Et.pipeline.results.rewrite&&Et.pipeline.results.analyze?yield function(e){return Se(this,void 0,void 0,function*(){const{getTokenCountAsync:t,maxContext:n}=SillyTavern.getContext(),r=y();if(!e.character||!e.results.rewrite||!e.results.analyze)return null;try{const s=ve(e);if(!s)return null;const i=r.systemPrompt+"\n\n"+s,a=yield t(i);return{promptTokens:a,contextSize:n,percentage:Math.round(a/n*100)}}catch(e){return h("Refinement token count failed",e),null}})}(Et.pipeline):yield function(e,t){return Se(this,void 0,void 0,function*(){const{getTokenCountAsync:n,maxContext:r}=SillyTavern.getContext(),s=y();if(!e.character)return null;try{const i=_e(e,t);if(!i)return null;const a=s.systemPrompt+"\n\n"+i,o=yield n(a);return{promptTokens:o,contextSize:r,percentage:Math.round(o/r*100)}}catch(e){return h("Token count failed",e),null}})}(Et.pipeline,Et.activeStageView),!Et||!Pt)return;if(!n)return t.innerHTML='<i class="fa-solid fa-microchip"></i> --',void(t.className=`${e}_token_estimate`);let r="";n.percentage>100?r="danger":n.percentage>80&&(r="warning"),t.innerHTML=`<i class="fa-solid fa-microchip"></i> ${n.promptTokens.toLocaleString()}t (${n.percentage}%)`,t.className=`${e}_token_estimate ${r}`})}var Wt=function(e,t,n,r){return new(n||(n=Promise))(function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,o)}c((r=r.apply(e,t||[])).next())})};function Yt(){return Wt(this,void 0,void 0,function*(){const{renderExtensionTemplateAsync:n}=SillyTavern.getContext(),r=document.getElementById("extensions_settings");if(r)try{const s=yield n("third-party/SillyTavern-CharacterTools","templates/panel",{version:t},!0),i=document.createElement("div");i.id=`${e}_wrapper`,i.innerHTML=s,r.appendChild(i),function(){const t=document.getElementById(`${e}_open_btn`);null==t||t.addEventListener("click",()=>{Lt()});const n=document.getElementById(`${e}_debug_toggle`);n&&(n.checked=y().debugMode,n.addEventListener("change",()=>{S(n.checked),toastr.info("Debug mode "+(n.checked?"enabled":"disabled"))}))}(),g("info","Panel initialized",null)}catch(e){h("Failed to load panel template",e)}else h("Extensions container not found",null)})}const{eventSource:Kt,eventTypes:Zt}=SillyTavern.getContext();Kt.on(Zt.APP_READY,function(){try{g("info","Extension initializing",{version:t}),Yt(),function(){const{eventSource:e,eventTypes:t}=SillyTavern.getContext();e.on(t.CHATCOMPLETION_SOURCE_CHANGED,()=>{g("info","Chat completion source changed",null)}),e.on(t.CHATCOMPLETION_MODEL_CHANGED,()=>{g("info","Chat completion model changed",null)}),g("info","Event listeners registered",null)}(),g("info","Extension loaded",y())}catch(e){h("Extension initialization failed",e),toastr.error("Character Tools failed to initialize. Check console for details.")}})})();
//# sourceMappingURL=index.js.map