(()=>{"use strict";const e="character_tools",t="third-party/SillyTavern-CharacterTools",n=3,r="1.0.0",s=Object.freeze([{key:"description",label:"Description",scoreable:!0},{key:"personality",label:"Personality",scoreable:!0},{key:"first_mes",label:"First Message",scoreable:!0},{key:"scenario",label:"Scenario",scoreable:!0},{key:"mes_example",label:"Example Messages",scoreable:!0},{key:"system_prompt",label:"System Prompt",scoreable:!0},{key:"post_history_instructions",label:"Post-History Instructions",scoreable:!1},{key:"creator_notes",label:"Creator Notes",scoreable:!1}]),i=Object.freeze(["score","rewrite","analyze"]),a={score:"Score",rewrite:"Rewrite",analyze:"Analyze"},o={score:"fa-star-half-stroke",rewrite:"fa-pen-fancy",analyze:"fa-magnifying-glass-chart"},c="You are a creative writing assistant specializing in character development for roleplay and fiction. Analyze character cards and provide thoughtful, actionable feedback.\n\nAdapt your response style to the task:\n- For scoring: Be critical but fair, rate 1-10 with specific justifications\n- For rewrites: Preserve the character's core identity while improving weak areas\n- For analysis: Compare versions objectively, identify what was lost or gained\n- For refinement: Address specific issues from analysis while keeping improvements\n\nFocus on: writing quality, character depth, consistency, roleplay usability, and potential issues (contradictions, clichés, underdeveloped areas).\n\nAlways maintain the character's essential personality and unique traits. Improvements should enhance, not replace, what makes the character interesting.",l="You are refining a character card rewrite based on analysis feedback.\n\n## Original Character (Ground Truth)\n{{original_character}}\n\n## Current Rewrite (Iteration {{iteration_number}})\n{{current_rewrite}}\n\n## Analysis of Current Rewrite\n{{current_analysis}}\n\n{{#if score_results}}\n## Original Score Feedback (Reference)\n{{score_results}}\n{{/if}}\n\n---\n\n## Your Task\n\nCreate an improved version that:\n\n1. **Addresses Issues**: Fix the specific problems identified in the analysis\n2. **Preserves Wins**: Keep what the analysis said was working well\n3. **Maintains Soul**: The character must still feel like the original, just better\n4. **Avoids Regression**: Don't reintroduce problems that were already fixed\n\nOutput the complete refined character card with all fields. Mark significantly changed sections with [REFINED] at the start.\n\nDo NOT explain your changes - just output the improved character card.",u=Object.freeze([{id:"builtin_score_default",name:"Default Score",stages:["score"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Rate this character card on a scale of 1-10 for each populated field. For each field, provide:\n\n1. **Score** (1-10)\n2. **Strengths** - What works well\n3. **Weaknesses** - What needs improvement\n4. **Specific Suggestions** - Concrete changes to improve it\n\nAfter scoring all fields, provide:\n- **Overall Score** (weighted average, with First Message and Description weighted higher)\n- **Top 3 Priority Improvements** - The changes that would have the biggest impact\n- **Summary** - A brief overall assessment\n\nBe critical but constructive. Vague praise is useless. Specific, actionable feedback is gold."},{id:"builtin_score_quick",name:"Quick Score",stages:["score"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Give a quick assessment of this character card:\n\n1. Overall score (1-10)\n2. Three biggest strengths\n3. Three areas needing work\n4. One-sentence summary\n\nKeep it concise but useful."},{id:"builtin_rewrite_default",name:"Default Rewrite",stages:["rewrite"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Based on the scoring feedback, rewrite this character card to address the identified weaknesses while preserving its strengths.\n\nGuidelines:\n- Maintain the character's core personality and unique traits\n- Improve weak areas identified in the score\n- Keep the same general length unless brevity/expansion was specifically noted\n- Preserve any distinctive voice or style that works\n- Fix contradictions and fill gaps\n- Make the character more engaging for roleplay\n\nOutput the complete rewritten character card with all fields, using the same field structure as the original. Mark significantly changed sections with [REVISED] at the start.\n\n{{score_results}}"},{id:"builtin_rewrite_conservative",name:"Conservative Rewrite",stages:["rewrite"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Make minimal, surgical improvements to this character card. Only change what's clearly broken or weak.\n\nRules:\n- Change as little as possible\n- Preserve the author's voice completely\n- Only fix obvious issues (contradictions, grammar, clarity)\n- Do NOT add new content unless filling a critical gap\n- Do NOT change style or tone\n\nOutput only the fields you changed, with [ORIGINAL] and [REVISED] versions for comparison.\n\n{{score_results}}"},{id:"builtin_rewrite_expansive",name:"Expansive Rewrite",stages:["rewrite"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Significantly expand and enhance this character card. Add depth, detail, and richness.\n\nGoals:\n- Flesh out underdeveloped areas\n- Add sensory details and specific examples\n- Deepen personality with quirks, contradictions, history\n- Improve example messages with more variety\n- Make the character feel more three-dimensional\n\nDon't change the core concept, but make it shine. Output the complete expanded character card.\n\n{{score_results}}"},{id:"builtin_analyze_default",name:"Default Analyze",stages:["analyze"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:'Compare the original character card with the rewritten version. Analyze:\n\n## What Was Preserved\n- Core personality traits that remained intact\n- Distinctive elements that were kept\n- Voice and style consistency\n\n## What Was Lost\n- Any personality aspects that were diminished or removed\n- Unique quirks that disappeared\n- Tone shifts that changed the character\'s feel\n\n## What Was Gained\n- New depth or detail added\n- Improvements that enhance the character\n- Better clarity or consistency\n\n## Soul Check\nDoes the rewritten version still feel like the same character? Rate the "soul preservation" from 1-10 and explain.\n\n## Verdict\nState clearly: **ACCEPT** (ready to use), **NEEDS REFINEMENT** (good progress but has issues), or **REGRESSION** (worse than before).\n\n## Specific Issues to Address\nIf verdict is NEEDS REFINEMENT, list the specific problems that should be fixed in the next iteration.\n\n---\n\n### Original Character:\n{{original_character}}\n\n### Rewritten Version:\n{{rewrite_results}}\n\n### Score Feedback:\n{{score_results}}'},{id:"builtin_analyze_iteration",name:"Iteration Analyze",stages:["analyze"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"This is iteration {{iteration_number}} of refinement. Compare the current rewrite against the original.\n\n## Progress Check\n- What issues from previous analysis were addressed?\n- What new issues (if any) were introduced?\n- Is this version better, worse, or lateral move from the last?\n\n## Current State Assessment\n\n### Preserved from Original\nCore traits and elements that remain intact.\n\n### Still Missing or Lost\nThings from the original that should be restored.\n\n### Successfully Improved\nWhat's genuinely better now.\n\n### New Problems\nAny issues introduced by this iteration.\n\n## Soul Preservation Score\nRate 1-10: Does this still feel like the original character?\n\n## Verdict\n**ACCEPT** - Ready to use, no more iterations needed\n**NEEDS REFINEMENT** - Making progress, but specific issues remain\n**REGRESSION** - This iteration made things worse, consider reverting\n\n## Next Steps\nIf NEEDS REFINEMENT: List exactly what the next iteration should fix.\nIf REGRESSION: Explain what went wrong and what to preserve from previous version.\n\n---\n\n### Original Character:\n{{original_character}}\n\n### Current Rewrite (Iteration {{iteration_number}}):\n{{rewrite_results}}"},{id:"builtin_analyze_quick",name:"Quick Analyze",stages:["analyze"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Quick comparison of original vs rewrite:\n\n1. Soul preserved? (Yes/Partially/No)\n2. Best improvement made\n3. Biggest thing lost (if any)\n4. Verdict: ACCEPT / NEEDS REFINEMENT / REGRESSION\n\n{{original_character}}\n\n{{rewrite_results}}"},{id:"builtin_freeform",name:"Freeform",stages:[],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"[Enter your custom instructions here]"}]),d=Object.freeze([{id:"builtin_schema_score",name:"Default Score",stages:["score"],isBuiltin:!0,createdAt:0,updatedAt:0,schema:{name:"CharacterScore",strict:!0,value:{$schema:"http://json-schema.org/draft-04/schema#",type:"object",additionalProperties:!1,properties:{fieldScores:{type:"array",items:{type:"object",additionalProperties:!1,properties:{field:{type:"string"},score:{type:"number"},strengths:{type:"string"},weaknesses:{type:"string"},suggestions:{type:"string"}},required:["field","score","strengths","weaknesses","suggestions"]}},overallScore:{type:"number"},priorityImprovements:{type:"array",items:{type:"string"}},summary:{type:"string"}},required:["fieldScores","overallScore","priorityImprovements","summary"]}}},{id:"builtin_schema_quick_score",name:"Quick Score",stages:["score"],isBuiltin:!0,createdAt:0,updatedAt:0,schema:{name:"QuickScore",strict:!0,value:{$schema:"http://json-schema.org/draft-04/schema#",type:"object",additionalProperties:!1,properties:{overallScore:{type:"number"},strengths:{type:"array",items:{type:"string"}},weaknesses:{type:"array",items:{type:"string"}},summary:{type:"string"}},required:["overallScore","strengths","weaknesses","summary"]}}},{id:"builtin_schema_analyze",name:"Default Analyze",stages:["analyze"],isBuiltin:!0,createdAt:0,updatedAt:0,schema:{name:"CharacterAnalysis",strict:!0,value:{$schema:"http://json-schema.org/draft-04/schema#",type:"object",additionalProperties:!1,properties:{preserved:{type:"array",items:{type:"string"}},lost:{type:"array",items:{type:"string"}},gained:{type:"array",items:{type:"string"}},soulPreservationScore:{type:"number"},soulAssessment:{type:"string"},verdict:{type:"string",enum:["ACCEPT","NEEDS_REFINEMENT","REGRESSION"]},issuesToAddress:{type:"array",items:{type:"string"}},recommendations:{type:"array",items:{type:"string"}}},required:["preserved","lost","gained","soulPreservationScore","soulAssessment","verdict","issuesToAddress","recommendations"]}}}]),p={score:{promptPresetId:"builtin_score_default",customPrompt:"",schemaPresetId:"builtin_schema_score",customSchema:"",useStructuredOutput:!1},rewrite:{promptPresetId:"builtin_rewrite_default",customPrompt:"",schemaPresetId:null,customSchema:"",useStructuredOutput:!1},analyze:{promptPresetId:"builtin_analyze_default",customPrompt:"",schemaPresetId:"builtin_schema_analyze",customSchema:"",useStructuredOutput:!1}},f={source:"openrouter",model:"anthropic/claude-sonnet-4",temperature:1,maxTokens:4096,frequencyPenalty:0,presencePenalty:0,topP:1},m=Object.freeze({useCurrentSettings:!0,generationConfig:f,systemPrompt:c,promptPresets:[...u],schemaPresets:[...d],stageDefaults:p,refinementPrompt:l,debugMode:!1,settingsVersion:n}),g={ORIGINAL_CHARACTER:"{{original_character}}",SCORE_RESULTS:"{{score_results}}",REWRITE_RESULTS:"{{rewrite_results}}",CURRENT_REWRITE:"{{current_rewrite}}",CURRENT_ANALYSIS:"{{current_analysis}}",ITERATION_NUMBER:"{{iteration_number}}",CHARACTER_NAME:"{{char_name}}",USER_NAME:"{{user_name}}"},h=100,_=20;const v=[];function y(t,n,r){const s={timestamp:new Date,type:t,label:n,data:r};if(v.unshift(s),v.length>h&&v.pop(),"error"!==t){if(function(){try{return w().debugMode}catch(e){return!1}}()){const s=`[${e}:${t.toUpperCase()}]`;switch(t){case"request":case"response":console.debug(s,n,r);break;default:console.log(s,n,r)}}}else console.error(`[${e}:ERROR]`,n,r)}function $(e,t){y("error",e,t)}function b(){return JSON.stringify(function(){var e,t,n,r,s,i,a,o,c;const l=SillyTavern.getContext();let u;try{u=w()}catch(e){u={error:"Failed to load settings"}}return{extension:{settings:{useCurrentSettings:u.useCurrentSettings,debugMode:u.debugMode,generationConfig:u.generationConfig,systemPromptLength:(null===(e=u.systemPrompt)||void 0===e?void 0:e.length)||0,promptPresetCount:(null===(t=u.promptPresets)||void 0===t?void 0:t.length)||0,schemaPresetCount:(null===(n=u.schemaPresets)||void 0===n?void 0:n.length)||0}},sillytavern:{mainApi:l.mainApi,onlineStatus:l.onlineStatus,chatCompletionSource:null===(r=l.chatCompletionSettings)||void 0===r?void 0:r.chat_completion_source,currentModel:(null===(s=l.chatCompletionSettings)||void 0===s?void 0:s.openrouter_model)||(null===(i=l.chatCompletionSettings)||void 0===i?void 0:i.model_openai_select),maxContext:l.maxContext,characterCount:null!==(o=null===(a=l.characters)||void 0===a?void 0:a.length)&&void 0!==o?o:0,hasActiveChat:!!(null===(c=l.chat)||void 0===c?void 0:c.length)},logs:{total:v.length,errors:v.filter((e=>"error"===e.type)).length,recent:v.slice(0,10).map((e=>({type:e.type,label:e.label,time:e.timestamp.toISOString()})))}}}(),null,2)}const S={2:e=>{const t=e;void 0!==t.useRawMode&&(e.useCurrentSettings=!t.useRawMode,delete t.useRawMode),void 0!==t.jsonSchema&&delete t.jsonSchema,void 0!==t.useStructuredOutput&&(e.stageDefaults||(e.stageDefaults=structuredClone(p)),e.stageDefaults.score.useStructuredOutput=!!t.useStructuredOutput,delete t.useStructuredOutput)},3:e=>{e.refinementPrompt||(e.refinementPrompt=l)}};function w(){const{extensionSettings:t,saveSettingsDebounced:r}=SillyTavern.getContext(),{lodash:s}=SillyTavern.libs;if(!t[e])return y("info","Initializing settings with defaults",null),t[e]=structuredClone(m),r(),t[e];const i=t[e],a=i.settingsVersion||1;let o=!1;a<n&&(o=function(e,t){let r=!1;for(let s=t+1;s<=n;s++){const t=S[s];t&&(y("info",`Running migration to v${s}`,null),t(e),r=!0)}return r}(i,a),i.settingsVersion=n);const c=s.merge(structuredClone(m),i),l=function(e){let t=!1;const n=new Set(e.promptPresets.map((e=>e.id)));for(const r of u)n.has(r.id)||(e.promptPresets.push(structuredClone(r)),t=!0);const r=new Set(e.schemaPresets.map((e=>e.id)));for(const n of d)r.has(n.id)||(e.schemaPresets.push(structuredClone(n)),t=!0);return t}(c);return o=o||l,t[e]=c,o&&r(),c}function C(t,n){const{extensionSettings:r,saveSettingsDebounced:s}=SillyTavern.getContext();r[e][t]=n,s(),y("info","Setting updated",{key:t,value:"object"==typeof n?"[object]":n})}function x(t){const{extensionSettings:n,saveSettingsDebounced:r}=SillyTavern.getContext(),s=n[e];s.generationConfig||(s.generationConfig=structuredClone(f)),s.generationConfig=Object.assign(Object.assign({},s.generationConfig),t),r(),y("info","Generation config updated",t)}function E(e){C("debugMode",e)}function P(e){const t=w();return e?t.promptPresets.filter((t=>0===t.stages.length||t.stages.includes(e))):t.promptPresets}function O(e){return w().promptPresets.find((t=>t.id===e))||null}function A(t){const{extensionSettings:n,saveSettingsDebounced:r}=SillyTavern.getContext(),s=n[e],{uuidv4:i}=SillyTavern.getContext(),a=Date.now(),o=Object.assign(Object.assign({},t),{id:`custom_prompt_${i()}`,isBuiltin:!1,createdAt:a,updatedAt:a});return s.promptPresets.push(o),r(),y("info","Prompt preset saved",{id:o.id,name:o.name}),o}function k(e){const t=w();return e?t.schemaPresets.filter((t=>0===t.stages.length||t.stages.includes(e))):t.schemaPresets}function T(e){return w().schemaPresets.find((t=>t.id===e))||null}function I(t){const{extensionSettings:n,saveSettingsDebounced:r}=SillyTavern.getContext(),s=n[e],{uuidv4:i}=SillyTavern.getContext(),a=R(t.schema),o=Date.now(),c=Object.assign(Object.assign({},t),{schema:a,id:`custom_schema_${i()}`,isBuiltin:!1,createdAt:o,updatedAt:o});return s.schemaPresets.push(c),r(),y("info","Schema preset saved",{id:c.id,name:c.name}),c}function R(e){const t=structuredClone(e);return L(t.value),t}function L(e){if("object"===e.type&&(e.additionalProperties=!1,e.properties&&"object"==typeof e.properties))for(const t of Object.values(e.properties))t&&"object"==typeof t&&L(t);if("array"===e.type&&e.items&&"object"==typeof e.items&&(Array.isArray(e.items)?e.items.forEach((e=>{e&&"object"==typeof e&&L(e)})):L(e.items)),e.anyOf&&Array.isArray(e.anyOf)&&e.anyOf.forEach((e=>{e&&"object"==typeof e&&L(e)})),e.allOf&&Array.isArray(e.allOf)&&e.allOf.forEach((e=>{e&&"object"==typeof e&&L(e)})),e.$defs&&"object"==typeof e.$defs)for(const t of Object.values(e.$defs))t&&"object"==typeof t&&L(t);if(e.definitions&&"object"==typeof e.definitions)for(const t of Object.values(e.definitions))t&&"object"==typeof t&&L(t)}var j=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};const N={MAX_ANYOF_VARIANTS:8,MAX_DEFS:100,MAX_NESTING_DEPTH:10,MAX_PROPERTIES_PER_OBJECT:100,MAX_ENUM_VALUES:500,SUPPORTED_STRING_FORMATS:["date-time","time","date","duration","email","hostname","uri","ipv4","ipv6","uuid"],SUPPORTED_MINMAX_ITEMS:[0,1]},q={numeric:["minimum","maximum","exclusiveMinimum","exclusiveMaximum","multipleOf"],string:["minLength","maxLength"],array:["maxItems","uniqueItems","contains","minContains","maxContains"],object:["minProperties","maxProperties","propertyNames","patternProperties"]},D=["if","then","else","not","oneOf","dependentRequired","dependentSchemas","unevaluatedProperties","unevaluatedItems","$dynamicRef","$dynamicAnchor"],M=[{pattern:/\(\?[=!<]/,name:"lookahead/lookbehind assertions"},{pattern:/\\[1-9]/,name:"backreferences"},{pattern:/\\[bB]/,name:"word boundaries"}],H='Generate a JSON Schema for structured LLM output based on the user\'s description.\n\nRequirements:\n- Output ONLY valid JSON, no markdown, no explanation\n- Use this exact wrapper format: {"name": "SchemaName", "strict": true, "value": {...}}\n- The "value" must be a valid JSON Schema with "type": "object"\n- Add "additionalProperties": false to ALL object types (required for Anthropic)\n- All object properties should be in a "required" array unless explicitly optional\n- Use simple types: string, number, integer, boolean, array, object\n- For arrays, always specify "items" with a schema\n- Keep it minimal - only what the user asked for\n\nUser\'s description:';function F(e){var t;if(!e.trim())return{valid:!0,schema:void 0};let n;try{n=JSON.parse(e)}catch(e){const t=e instanceof Error?e.message:"Invalid JSON",n=t.match(/position (\d+)/);return{valid:!1,error:`JSON syntax error${n?` (character ${n[1]})`:""}: ${t}`}}if("object"!=typeof n||null===n||Array.isArray(n))return{valid:!1,error:"Schema must be a JSON object, not "+(Array.isArray(n)?"array":typeof n)};const r=n;if("string"!=typeof r.name)return{valid:!1,error:"Missing required 'name' property (string)"};if(!r.name.trim())return{valid:!1,error:"'name' cannot be empty"};if(!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(r.name))return{valid:!1,error:`'name' must be a valid identifier (got '${r.name}'). Use letters, numbers, underscores; start with letter or underscore.`};if("object"!=typeof r.value||null===r.value||Array.isArray(r.value))return{valid:!1,error:"Missing or invalid 'value' property (must be object)"};const s=r.value;if("string"!=typeof s.type&&!s.anyOf&&!s.allOf&&!s.$ref)return{valid:!1,error:"'value' must have a 'type', 'anyOf', 'allOf', or '$ref'"};if(void 0!==r.strict&&"boolean"!=typeof r.strict)return{valid:!1,error:"'strict' must be a boolean if provided"};const i={errors:[],warnings:[],info:[],stats:{defCount:0,anyOfCount:0,totalAnyOfVariants:0,maxDepth:0,propertyCount:0,optionalFieldCount:0,enumCount:0},currentDepth:0,seenRefs:new Set,defs:{}};if(s.$defs&&"object"==typeof s.$defs?(i.defs=s.$defs,i.stats.defCount=Object.keys(i.defs).length):s.definitions&&"object"==typeof s.definitions&&(i.defs=s.definitions,i.stats.defCount=Object.keys(i.defs).length),i.stats.defCount>N.MAX_DEFS&&i.errors.push(`Too many definitions: ${i.stats.defCount} (limit: ${N.MAX_DEFS})`),z(s,"value",i),i.stats.optionalFieldCount>0){const e=i.stats.optionalFieldCount,t=i.stats.totalAnyOfVariants+2*e;e>10&&i.warnings.push(`${e} optional fields detected. Each spawns an implicit anyOf with null. Consider making fields required or reducing optionals.`),t>50&&i.warnings.push(`High anyOf count (~${t} including implicit nullables). May cause slow schema compilation or errors.`)}if(i.errors.length>0)return{valid:!1,error:i.errors.join("\n"),warnings:i.warnings.length>0?i.warnings:void 0};const a={name:r.name,strict:null===(t=r.strict)||void 0===t||t,value:s};return i.info.push(`Schema stats: ${i.stats.propertyCount} properties, ${i.stats.defCount} definitions, ${i.stats.anyOfCount} anyOf blocks, ${i.stats.optionalFieldCount} optional fields, max depth ${i.stats.maxDepth}`),{valid:!0,schema:a,warnings:i.warnings.length>0?i.warnings:void 0,info:i.info.length>0?i.info:void 0}}function z(e,t,n){if(n.currentDepth++,n.stats.maxDepth=Math.max(n.stats.maxDepth,n.currentDepth),n.currentDepth>N.MAX_NESTING_DEPTH)return n.errors.push(`${t}: Exceeds maximum nesting depth of ${N.MAX_NESTING_DEPTH}`),void n.currentDepth--;for(const r of D)void 0!==e[r]&&n.errors.push(`${t}: '${r}' is not supported`);for(const r of q.numeric)void 0!==e[r]&&n.warnings.push(`${t}: '${r}' will be ignored (not supported)`);for(const r of q.string)void 0!==e[r]&&n.warnings.push(`${t}: '${r}' will be ignored (not supported)`);for(const r of q.array)void 0!==e[r]&&n.warnings.push(`${t}: '${r}' will be ignored (not supported)`);for(const r of q.object)void 0!==e[r]&&n.warnings.push(`${t}: '${r}' will be ignored (not supported)`);if(e.$ref&&"string"==typeof e.$ref)return function(e,t,n){if(e.startsWith("http://")||e.startsWith("https://"))return void n.errors.push(`${t}: External $ref not supported ('${e}')`);if(n.seenRefs.has(e))return void n.info.push(`${t}: Circular reference to '${e}'`);n.seenRefs.add(e);const r=e.replace(/^#\/(\$defs|definitions)\//,"");n.defs[r]||n.errors.push(`${t}: Reference '${e}' not found in definitions`)}(e.$ref,t,n),void n.currentDepth--;const r=Array.isArray(e.type)?e.type:[e.type];for(const s of r)switch(s){case"object":V(e,t,n);break;case"array":U(e,t,n);break;case"string":G(e,t,n);break;case"number":case"integer":e,t,n;break;case"boolean":case"null":break;default:!s||e.anyOf||e.allOf||n.warnings.push(`${t}: Unknown type '${s}'`)}e.anyOf&&Array.isArray(e.anyOf)&&function(e,t,n){n.stats.anyOfCount++,n.stats.totalAnyOfVariants+=e.length,e.length>N.MAX_ANYOF_VARIANTS&&n.errors.push(`${t}: anyOf has ${e.length} variants (max: ${N.MAX_ANYOF_VARIANTS})`);if(0===e.length)return void n.errors.push(`${t}: anyOf cannot be empty`);e.forEach(((e,r)=>{e&&"object"==typeof e&&z(e,`${t}.anyOf[${r}]`,n)}))}(e.anyOf,t,n),e.allOf&&Array.isArray(e.allOf)&&function(e,t,n){if(0===e.length)return void n.errors.push(`${t}: allOf cannot be empty`);e.forEach(((e,r)=>{if(e&&"object"==typeof e){const s=e;s.$ref&&n.errors.push(`${t}.allOf[${r}]: allOf with $ref not supported`),z(s,`${t}.allOf[${r}]`,n)}}))}(e.allOf,t,n),e.enum&&Array.isArray(e.enum)&&function(e,t,n){if(n.stats.enumCount++,0===e.length)return void n.errors.push(`${t}: enum cannot be empty`);e.length>N.MAX_ENUM_VALUES&&n.warnings.push(`${t}: enum has ${e.length} values (may be slow)`);for(let r=0;r<e.length;r++){const s=e[r],i=typeof s;if("string"!==i&&"number"!==i&&"boolean"!==i&&null!==s){n.errors.push(`${t}.enum[${r}]: Complex type not allowed in enum (got ${i}). Only string, number, boolean, null permitted.`);break}}const r=new Set;for(const s of e){const e=JSON.stringify(s);if(r.has(e)){n.warnings.push(`${t}: Duplicate value in enum: ${e}`);break}r.add(e)}}(e.enum,t,n),void 0!==e.const&&function(e,t,n){const r=typeof e;"string"!==r&&"number"!==r&&"boolean"!==r&&null!==e&&n.errors.push(`${t}: const must be string, number, boolean, or null (got ${r})`)}(e.const,t,n),n.currentDepth--}function V(e,t,n){if(!1!==e.additionalProperties&&n.warnings.push(`${t}: Missing 'additionalProperties: false' (REQUIRED for Anthropic)`),e.properties&&"object"==typeof e.properties){const r=e.properties,s=Object.keys(r).length;n.stats.propertyCount+=s,s>N.MAX_PROPERTIES_PER_OBJECT&&n.warnings.push(`${t}: ${s} properties (may be slow, consider splitting)`);const i=e.required||[];for(const[e,s]of Object.entries(r))i.includes(e)||n.stats.optionalFieldCount++,s&&"object"==typeof s&&z(s,`${t}.${e}`,n)}}function U(e,t,n){if(void 0!==e.minItems){N.SUPPORTED_MINMAX_ITEMS.includes(e.minItems)||n.warnings.push(`${t}: 'minItems: ${e.minItems}' not supported (only 0 or 1 allowed)`)}e.items&&("object"!=typeof e.items||Array.isArray(e.items)?Array.isArray(e.items)&&e.items.forEach(((e,r)=>{e&&"object"==typeof e&&z(e,`${t}.items[${r}]`,n)})):z(e.items,`${t}.items`,n)),e.prefixItems&&Array.isArray(e.prefixItems)&&e.prefixItems.forEach(((e,r)=>{e&&"object"==typeof e&&z(e,`${t}.prefixItems[${r}]`,n)}))}function G(e,t,n){if(e.format&&"string"==typeof e.format){const r=N.SUPPORTED_STRING_FORMATS;r.includes(e.format)||n.warnings.push(`${t}: format '${e.format}' may not be supported. Supported: ${r.join(", ")}`)}e.pattern&&"string"==typeof e.pattern&&function(e,t,n){for(const{pattern:r,name:s}of M)r.test(e)&&n.errors.push(`${t}: Regex pattern uses unsupported feature: ${s}`);try{new RegExp(e)}catch(e){const r=e instanceof Error?e.message:"Invalid regex";n.errors.push(`${t}: Invalid regex pattern: ${r}`)}const r=/\{(\d+),(\d+)\}/g;let s;for(;null!==(s=r.exec(e));){const e=parseInt(s[1],10),r=parseInt(s[2],10);r-e>100&&n.warnings.push(`${t}: Large quantifier range {${e},${r}} may cause issues`)}}(e.pattern,t,n)}function B(e){const t=structuredClone(e);return void 0===t.strict&&(t.strict=!0),J(t.value),t}function J(e){if("object"===e.type&&(e.additionalProperties=!1,e.properties&&"object"==typeof e.properties))for(const t of Object.values(e.properties))t&&"object"==typeof t&&J(t);"array"===e.type&&e.items&&"object"==typeof e.items&&(Array.isArray(e.items)?e.items.forEach((e=>{e&&"object"==typeof e&&J(e)})):J(e.items)),e.anyOf&&Array.isArray(e.anyOf)&&e.anyOf.forEach((e=>{e&&"object"==typeof e&&J(e)})),e.allOf&&Array.isArray(e.allOf)&&e.allOf.forEach((e=>{e&&"object"==typeof e&&J(e)}));const t=[];for(const n of q.numeric)void 0!==e[n]&&(t.push(`${n}: ${e[n]}`),delete e[n]);for(const n of q.string)void 0!==e[n]&&(t.push(`${n}: ${e[n]}`),delete e[n]);for(const n of q.array)void 0!==e[n]&&(t.push(`${n}: ${e[n]}`),delete e[n]);if(void 0!==e.minItems&&null!==e.minItems){const n=e.minItems;0!==n&&1!==n&&(t.push(`minItems: ${n}`),e.minItems=n>0?1:0)}if(t.length>0){const n=`[Constraints: ${t.join(", ")}]`;e.description?e.description=`${e.description} ${n}`:e.description=n}}function W(e){if(e.promptPresetId){const t=O(e.promptPresetId);if(t)return t.prompt;y("error","Prompt preset not found",{id:e.promptPresetId})}return e.customPrompt}function Y(e){const t=w().stageDefaults[e];return{promptPresetId:t.promptPresetId,customPrompt:t.customPrompt,schemaPresetId:t.schemaPresetId,customSchema:t.customSchema,useStructuredOutput:t.useStructuredOutput}}function X(e,t){const{lodash:n}=SillyTavern.libs,{substituteParams:r}=SillyTavern.getContext();let s=r(e);return s=function(e,t){const n=/\{\{#if\s+(\w+)\}\}([\s\S]*?)\{\{\/if\}\}/gi;return e.replace(n,((e,n,r)=>{var s,i,a,o,c;let l=!1;switch(n.toLowerCase()){case"score_results":l=!!(null===(s=t.scoreResults)||void 0===s?void 0:s.trim());break;case"rewrite_results":l=!!(null===(i=t.rewriteResults)||void 0===i?void 0:i.trim());break;case"current_rewrite":l=!!(null===(a=t.currentRewrite)||void 0===a?void 0:a.trim());break;case"current_analysis":l=!!(null===(o=t.currentAnalysis)||void 0===o?void 0:o.trim());break;case"original_character":l=!!(null===(c=t.originalCharacter)||void 0===c?void 0:c.trim());break;case"iteration_number":l=!!t.iterationNumber&&"0"!==t.iterationNumber;break;default:l=!1}return l?r:""}))}(s,t),void 0!==t.originalCharacter&&(s=s.replace(new RegExp(n.escapeRegExp(g.ORIGINAL_CHARACTER),"gi"),t.originalCharacter)),void 0!==t.scoreResults&&(s=s.replace(new RegExp(n.escapeRegExp(g.SCORE_RESULTS),"gi"),t.scoreResults)),void 0!==t.rewriteResults&&(s=s.replace(new RegExp(n.escapeRegExp(g.REWRITE_RESULTS),"gi"),t.rewriteResults)),void 0!==t.currentRewrite&&(s=s.replace(new RegExp(n.escapeRegExp(g.CURRENT_REWRITE),"gi"),t.currentRewrite)),void 0!==t.currentAnalysis&&(s=s.replace(new RegExp(n.escapeRegExp(g.CURRENT_ANALYSIS),"gi"),t.currentAnalysis)),void 0!==t.iterationNumber&&(s=s.replace(new RegExp(n.escapeRegExp(g.ITERATION_NUMBER),"gi"),t.iterationNumber)),void 0!==t.charName&&(s=s.replace(new RegExp(n.escapeRegExp(g.CHARACTER_NAME),"gi"),t.charName)),void 0!==t.userName&&(s=s.replace(new RegExp(n.escapeRegExp(g.USER_NAME),"gi"),t.userName)),void 0!==t.charName&&(s=s.replace(/\{\{char\}\}/gi,t.charName)),void 0!==t.userName&&(s=s.replace(/\{\{user\}\}/gi,t.userName)),s}function K(e){const t=[];for(const[n,r]of Object.entries(g))e.toLowerCase().includes(r.toLowerCase())&&t.push(n);return t}var Z=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};function Q(){return{character:null,characterIndex:null,results:{score:null,rewrite:null,analyze:null},configs:{score:Y("score"),rewrite:Y("rewrite"),analyze:Y("analyze")},selectedStages:["score","rewrite"],currentStage:null,stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"},iterationCount:0,iterationHistory:[],isRefining:!1,exportData:null}}function ee(e,t,n){if(e.characterIndex===n&&null!==n)return e;const r=Object.assign(Object.assign({},e),{character:t,characterIndex:n,results:{score:null,rewrite:null,analyze:null},stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"},currentStage:null,iterationCount:0,iterationHistory:[],isRefining:!1,exportData:null});return y("state","Character set",{name:null==t?void 0:t.name,index:n,fieldsPopulated:t?te(t).length:0}),r}function te(e){return s.filter((t=>{const n=e[t.key];return n&&"string"==typeof n&&n.trim().length>0})).map((t=>{const n=e[t.key].trim();return{key:t.key,label:t.label,value:n,charCount:n.length,scoreable:t.scoreable}}))}function ne(e){const t=te(e).map((e=>`### ${e.label}\n${e.value}`));return`# CHARACTER: ${e.name}\n\n${t.join("\n\n")}`}function re(e){return e.character?e.results.rewrite?e.results.analyze?{canRun:!0}:{canRun:!1,reason:"Run analyze first to identify issues"}:{canRun:!1,reason:"No rewrite to refine"}:{canRun:!1,reason:"No character selected"}}function se(e,t,n){return Object.assign(Object.assign({},e),{configs:Object.assign(Object.assign({},e.configs),{[t]:Object.assign(Object.assign({},e.configs[t]),n)})})}function ie(e,t,n){return y("state","Stage failed",{stage:t,error:n}),Object.assign(Object.assign({},e),{currentStage:null,stageStatus:Object.assign(Object.assign({},e.stageStatus),{[t]:"pending"})})}function ae(e){const t=e.toUpperCase();if(t.includes("VERDICT")||t.includes('"VERDICT"')){if(t.includes("ACCEPT")&&!t.includes("NEEDS"))return"accept";if(t.includes("REGRESSION"))return"regression";if(t.includes("NEEDS_REFINEMENT")||t.includes("NEEDS REFINEMENT"))return"needs_refinement"}return t.includes("READY TO USE")||t.includes("NO MORE ITERATIONS")?"accept":t.includes("WORSE THAN")||t.includes("STEP BACKWARD")||t.includes("LOST MORE")?"regression":(t.includes("ISSUE")||t.includes("PROBLEM")||t.includes("SHOULD FIX"),"needs_refinement")}function oe(e){const t=function(e){if(!e.results.rewrite||!e.results.analyze)return null;const t=ae(e.results.analyze.response);return{iteration:e.iterationCount,rewriteResponse:e.results.rewrite.response,rewritePreview:e.results.rewrite.response.substring(0,200),analysisResponse:e.results.analyze.response,analysisPreview:e.results.analyze.response.substring(0,200),verdict:t,timestamp:Date.now()}}(e);if(!t)return $("Cannot start refinement - missing rewrite or analyze",null),e;const n=[...e.iterationHistory,t];return n.length>_&&n.shift(),y("state","Starting refinement iteration",{iteration:e.iterationCount+1,previousVerdict:t.verdict}),Object.assign(Object.assign({},e),{iterationHistory:n,iterationCount:e.iterationCount+1,results:Object.assign(Object.assign({},e.results),{analyze:null}),stageStatus:Object.assign(Object.assign({},e.stageStatus),{analyze:"pending"}),isRefining:!0})}function ce(e){const t=function(e){try{let t;try{t=JSON.parse(e)}catch(n){const r=e.match(/```(?:json)?\s*([\s\S]*?)```/);if(!r)return null;t=JSON.parse(r[1].trim())}if("object"!=typeof t||null===t||Array.isArray(t))return null;const n=[];for(const[e,r]of Object.entries(t))if("string"==typeof r&&r.trim()){const t=s.find((t=>t.key===e||t.label.toLowerCase()===e.toLowerCase()));n.push({key:(null==t?void 0:t.key)||e,label:(null==t?void 0:t.label)||le(e),value:r.trim()})}return 0===n.length?null:{fields:n,raw:e,parseMethod:"json"}}catch(e){return null}}(e);if(t)return t;const n=function(e){var t,n;const r=/^#{2,3}\s+(.+?)$/gm,i=[...e.matchAll(r)];if(0===i.length)return null;const a=[];for(let r=0;r<i.length;r++){const o=i[r],c=o[1].trim(),l=o.index+o[0].length,u=null!==(n=null===(t=i[r+1])||void 0===t?void 0:t.index)&&void 0!==n?n:e.length,d=e.slice(l,u).trim();if(!d)continue;const p=s.find((e=>e.label.toLowerCase()===c.toLowerCase()||e.key===c.toLowerCase().replace(/\s+/g,"_")));!p&&["summary","notes","changes","revised","original"].some((e=>c.toLowerCase().includes(e)))||a.push({key:(null==p?void 0:p.key)||c.toLowerCase().replace(/\s+/g,"_"),label:(null==p?void 0:p.label)||c,value:d})}return 0===a.length?null:{fields:a,raw:e,parseMethod:"markdown"}}(e);if(n)return n;const r=function(e){const t=[];for(const n of s){const r=[new RegExp(`\\*\\*${n.label}:\\*\\*\\s*([\\s\\S]*?)(?=\\*\\*[A-Z]|$)`,"i"),new RegExp(`${n.label}:\\s*([\\s\\S]*?)(?=\\n[A-Z][a-z]+:|$)`,"i"),new RegExp(`\\[${n.label}\\]\\s*([\\s\\S]*?)(?=\\[[A-Z]|$)`,"i")];for(const s of r){const r=e.match(s);if(r&&r[1].trim()){t.push({key:n.key,label:n.label,value:r[1].trim()});break}}}return 0===t.length?null:{fields:t,raw:e,parseMethod:"heuristic"}}(e);return r||{fields:[{key:"content",label:"Content",value:e.trim()}],raw:e,parseMethod:"raw"}}function le(e){return e.replace(/_/g," ").replace(/([a-z])([A-Z])/g,"$1 $2").replace(/\b\w/g,(e=>e.toUpperCase()))}function ue(e,t){const n=e.selectedStages.indexOf(t);return-1===n||n>=e.selectedStages.length-1?null:e.selectedStages[n+1]}function de(e){return!!e.results.rewrite}function pe(e,t){var n,r,s,i;if(!e.character)return null;const a=W(e.configs[t]);if(!a.trim())return null;const o=ne(e.character),{name1:c}=SillyTavern.getContext(),l={originalCharacter:o,scoreResults:(null===(n=e.results.score)||void 0===n?void 0:n.response)||"",rewriteResults:(null===(r=e.results.rewrite)||void 0===r?void 0:r.response)||"",currentRewrite:(null===(s=e.results.rewrite)||void 0===s?void 0:s.response)||"",currentAnalysis:(null===(i=e.results.analyze)||void 0===i?void 0:i.response)||"",iterationNumber:String(e.iterationCount+1),charName:e.character.name,userName:c||"User"},u=K(a),d=u.length>0,p=X(a,l);if(d){return u.includes("ORIGINAL_CHARACTER")?p:me(t,e,o,p)}return y("info","No placeholders in prompt, auto-prepending character data",{stage:t}),me(t,e,o,p)}function fe(e){var t;if(!e.character||!e.results.rewrite||!e.results.analyze)return null;const n=w().refinementPrompt,r=ne(e.character),{name1:s}=SillyTavern.getContext();return X(n,{originalCharacter:r,scoreResults:(null===(t=e.results.score)||void 0===t?void 0:t.response)||"",rewriteResults:e.results.rewrite.response,currentRewrite:e.results.rewrite.response,currentAnalysis:e.results.analyze.response,iterationNumber:String(e.iterationCount+1),charName:e.character.name,userName:s||"User"})}function me(e,t,n,r){var s,i,a;const o=[],c="score"===e?"Analyze":"rewrite"===e?"Rewrite":"Compare";switch(o.push(`# Character to ${c}`,"",n),e){case"score":break;case"rewrite":(null===(s=t.results.score)||void 0===s?void 0:s.response)&&o.push("","---","","# Score Feedback","","Use this feedback to guide your rewrite:","",t.results.score.response);break;case"analyze":(null===(i=t.results.rewrite)||void 0===i?void 0:i.response)&&o.push("","---","","# Rewritten Version","","Compare this against the original:","",t.results.rewrite.response),(null===(a=t.results.score)||void 0===a?void 0:a.response)&&o.push("","---","","# Original Score Feedback","","Reference for what was identified as needing improvement:","",t.results.score.response)}return o.push("","---","","# Instructions","",r),o.join("\n")}function ge(e,t){return function(e){if(!e.useStructuredOutput)return null;if(e.schemaPresetId){const t=T(e.schemaPresetId);if(t)return t.schema;y("error","Schema preset not found",{id:e.schemaPresetId})}if(e.customSchema){const t=F(e.customSchema);if(t.valid&&t.schema)return t.schema;y("error","Custom schema invalid",{error:t.error})}return null}(e.configs[t])}function he(e){const t=function(e){if(!e.results.rewrite||!e.character)return null;const t=e.results.rewrite.response,n=[`# ${e.character.name} (Rewritten)`,"",`Generated: ${(new Date).toLocaleString()}`,`Iterations: ${e.iterationCount}`,"","---","",t];if(e.results.analyze&&n.push("","---","","## Final Analysis","",e.results.analyze.response),e.results.score&&n.push("","---","","## Original Score","",e.results.score.response),e.iterationHistory.length>0){n.push("","---","","## Iteration History","");for(const t of e.iterationHistory)n.push(`### Iteration ${t.iteration+1} - ${t.verdict.toUpperCase()}`,`${new Date(t.timestamp).toLocaleString()}`,"")}return n.join("\n")}(e);return Object.assign(Object.assign({},e),{exportData:t})}var _e=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))},ve=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,s){(function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)})(r,s,(t=e[n](t)).done,t.value)}))}}};function ye(){const{onlineStatus:e}=SillyTavern.getContext();return"Valid"===e||"Connected"===e}function $e(){var e,t,n;const r=SillyTavern.getContext(),s=w();return s.useCurrentSettings?{source:(null===(e=r.chatCompletionSettings)||void 0===e?void 0:e.chat_completion_source)||r.mainApi||"unknown",model:(null===(t=r.chatCompletionSettings)||void 0===t?void 0:t.openrouter_model)||(null===(n=r.chatCompletionSettings)||void 0===n?void 0:n.model_openai_select)||"unknown",isReady:ye()}:{source:s.generationConfig.source,model:s.generationConfig.model,isReady:ye()}}function be(e,t,n){return _e(this,void 0,void 0,(function*(){const r=SillyTavern.getContext(),s=w();if(null==n?void 0:n.aborted)return{success:!1,error:"Generation cancelled"};if(!e.character)return{success:!1,error:"No character selected"};if(!ye())return $("API not ready",{onlineStatus:r.onlineStatus}),{success:!1,error:"API is not connected. Check your connection settings."};const i=pe(e,t);if(!i)return{success:!1,error:"No prompt configured for this stage"};const a=e.configs[t].useStructuredOutput?ge(e,t):null,o=Ce(i,e.character.name,r.name1||"User");y("info","Starting stage generation",{stage:t,character:e.character.name,useCurrentSettings:s.useCurrentSettings,useStructured:!!a,schemaName:null==a?void 0:a.name,promptLength:o.length});const c=yield Se(s.systemPrompt,o,a,n,s.useCurrentSettings);return c.success&&a?function(e,t){try{const n=JSON.parse(e);if(t.value.required&&Array.isArray(t.value.required)){const r=t.value.required.filter((e=>!(e in n)));if(r.length>0)return y("info","Structured response missing required fields, returning as unstructured",{missing:r,schemaName:t.name}),{success:!0,response:e,isStructured:!1}}return{success:!0,response:e,isStructured:!0}}catch(n){return y("info","Failed to parse structured response, returning as unstructured",{error:n.message,schemaName:t.name,responsePreview:e.substring(0,200)}),{success:!0,response:e,isStructured:!1}}}(c.response,a):c}))}function Se(e,t,n,r,s){return _e(this,void 0,void 0,(function*(){try{let i;return i=s?yield function(e,t,n,r){return _e(this,void 0,void 0,(function*(){const{generateRaw:s,substituteParams:i}=SillyTavern.getContext(),a=i(e);if(y("request","generateRaw request",{hasSchema:!!n,schemaName:null==n?void 0:n.name,systemPromptLength:a.length,userPromptLength:t.length}),null==r?void 0:r.aborted)throw new DOMException("Aborted","AbortError");const o=yield s({prompt:[{role:"system",content:a},{role:"user",content:t}],jsonSchema:n});if(null==r?void 0:r.aborted)throw new DOMException("Aborted","AbortError");const c=we(o);return y("response","generateRaw response",{type:typeof o,length:c.length,preview:c.substring(0,200)}),c}))}(e,t,n,r):yield function(e,t,n,r){return _e(this,void 0,void 0,(function*(){const{ChatCompletionService:s,substituteParams:i}=SillyTavern.getContext(),a=w().generationConfig,o={stream:!0,messages:[{role:"system",content:i(e)},{role:"user",content:t}],chat_completion_source:a.source,model:a.model,temperature:a.temperature,max_tokens:a.maxTokens,frequency_penalty:a.frequencyPenalty,presence_penalty:a.presencePenalty,top_p:a.topP};if(n&&(o.json_schema=n),y("request","ChatCompletionService request",{source:a.source,model:a.model,stream:!0,hasSchema:!!n}),null==r?void 0:r.aborted)throw new DOMException("Aborted","AbortError");const c=yield s.sendRequest(o);let l;if(y("response","ChatCompletionService result type",{type:typeof c,isFunction:"function"==typeof c,isGenerator:c&&"object"==typeof c&&Symbol.asyncIterator in c}),"function"==typeof c)l=yield function(e,t){return _e(this,void 0,void 0,(function*(){var n,r,s,i;let a="",o=null;try{o=e();try{for(var c,l=!0,u=ve(o);!(n=(c=yield u.next()).done);l=!0){i=c.value,l=!1;const e=i;if(null==t?void 0:t.aborted){y("info","Stream aborted",{textSoFar:a.length});try{yield o.return(void 0)}catch(e){}throw new DOMException("Aborted","AbortError")}const n=e;if("string"==typeof n.text&&(a=n.text),n.error)throw new Error(we(n.error))}}catch(e){r={error:e}}finally{try{l||n||!(s=u.return)||(yield s.call(u))}finally{if(r)throw r.error}}}catch(e){if("AbortError"===e.name)throw e;if($("Stream consumption error",{error:e,textSoFar:a.length}),o)try{yield o.return(void 0)}catch(e){}if(a)return y("info","Returning partial response after stream error",{length:a.length}),a;throw e}return y("info","Stream consumed",{finalLength:a.length}),a}))}(c,r);else if(c&&"object"==typeof c){const e=c;if(e.error)throw $("API returned error",c),new Error(`API error: ${JSON.stringify(c)}`);l=we(e.content||c)}else l=we(c);return y("response","Final response",{length:l.length,preview:l.substring(0,200)}),l}))}(e,t,n,r),(null==r?void 0:r.aborted)?{success:!1,error:"Generation cancelled"}:i&&""!==i.trim()?(y("info","Generation complete",{responseLength:i.length,isStructured:!!n}),{success:!0,response:i,isStructured:!!n}):($("Empty response",null),{success:!1,error:"Empty response from API"})}catch(e){if("AbortError"===e.name||(null==r?void 0:r.aborted))return y("info","Generation aborted",null),{success:!1,error:"Generation cancelled"};$("Generation exception",{message:e instanceof Error?e.message:String(e)});return{success:!1,error:e instanceof Error?e.message:String(e)}}}))}function we(e){if("string"==typeof e)return e;if(null==e)return"";if("object"==typeof e)try{return JSON.stringify(e)}catch(t){return String(e)}return String(e)}function Ce(e,t,n){return e.replace(/\{\{char\}\}/gi,t).replace(/\{\{user\}\}/gi,n)}var xe=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};const Ee=500;let Pe=null;function Oe(){return Pe||(Pe=new Map),Pe}function Ae(t){const{getThumbnailUrl:n}=SillyTavern.getContext(),r=te(t),s=n("avatar",t.avatar);return`\n    <div class="${e}_char_preview" id="${e}_char_preview">\n      <div class="${e}_char_header">\n        <img\n          class="${e}_char_avatar"\n          src="${s}"\n          alt=""\n          onerror="this.src='/img/ai4.png'"\n        >\n        <div class="${e}_char_info">\n          <div class="${e}_char_name">${Ie(t.name)}</div>\n          <div class="${e}_char_meta">\n            ${r.length} fields • <span id="${e}_total_tokens">counting...</span>\n          </div>\n        </div>\n        <button id="${e}_char_clear" class="${e}_icon_btn" title="Clear selection">\n          <i class="fa-solid fa-xmark"></i>\n        </button>\n      </div>\n\n      <div class="${e}_char_fields">\n        ${r.map((t=>{return`\n    <div class="${e}_field_row">\n      <div class="${e}_field_header ${e}_field_toggle" data-field="${(n=t).key}">\n        <i class="fa-solid fa-chevron-right"></i>\n        <span class="${e}_field_label">${n.label}</span>\n        <span class="${e}_field_tokens" data-field="${n.key}">...</span>\n      </div>\n      <div class="${e}_field_content hidden" id="${e}_field_content_${n.key}">\n        <div class="${e}_field_text">${Ie(n.value)}</div>\n      </div>\n    </div>\n  `;var n})).join("")}\n      </div>\n    </div>\n  `}function ke(t,n){return xe(this,void 0,void 0,(function*(){const{getTokenCountAsync:r}=SillyTavern.getContext(),s=Oe(),i=n.map((e=>xe(this,void 0,void 0,(function*(){const t=function(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return`${t}_${e.length}`}(e.value);if(s.has(t))return{field:e,tokens:s.get(t)};try{const n=yield r(e.value);return function(e,t){const n=Oe();if(n.size>=Ee){const e=n.keys().next().value;void 0!==e&&n.delete(e)}n.set(e,t)}(t,n),{field:e,tokens:n}}catch(t){return{field:e,tokens:null}}})))),a=yield Promise.all(i);let o=0;for(const{field:n,tokens:r}of a){const s=t.querySelector(`.${e}_field_tokens[data-field="${n.key}"]`);s&&(null!==r?(o+=r,s.textContent=`${r.toLocaleString()}t`):s.textContent="?")}const c=t.querySelector(`#${e}_total_tokens`);c&&(c.textContent=`${o.toLocaleString()} tokens`)}))}function Te(t,n,r){const{getThumbnailUrl:s}=SillyTavern.getContext();if(0!==t.length){if(n.innerHTML=t.map((({char:t,index:n},i)=>{const a=s("avatar",t.avatar),o=i===r,c=(t.description||"No description").substring(0,80);return`\n      <div class="${e}_dropdown_item ${o?"selected":""}" data-index="${n}">\n        <img class="${e}_dropdown_avatar" src="${a}" alt="" onerror="this.src='/img/ai4.png'">\n        <div class="${e}_dropdown_info">\n          <span class="${e}_dropdown_name">${Ie(t.name)}</span>\n          <span class="${e}_dropdown_desc">${Ie(c)}${c.length>=80?"...":""}</span>\n        </div>\n      </div>\n    `})).join(""),r>=0){const t=n.querySelector(`.${e}_dropdown_item.selected`);null==t||t.scrollIntoView({block:"nearest"})}}else n.innerHTML=`<div class="${e}_dropdown_empty">No characters found</div>`}function Ie(e){const{DOMPurify:t}=SillyTavern.libs,n="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(n,{ALLOWED_TAGS:[]})}function Re(e){return s.filter((t=>{const n=e[t.key];return n&&"string"==typeof n&&n.trim().length>0})).map((t=>{const n=e[t.key].trim();return{key:t.key,label:t.label,value:n,charCount:n.length,scoreable:t.scoreable}}))}function Le(t,n,r,s){return`\n    <div class="${e}_pipeline_nav">\n      \x3c!-- Stage Selection --\x3e\n      <div class="${e}_stage_row">\n        ${i.map(((s,c)=>function(t,n,r,s,i){const c=function(e){switch(e){case"complete":return"fa-check";case"running":return"fa-spinner fa-spin";case"skipped":return"fa-forward";default:return null}}(r);return`\n    <div class="${e}_stage_node ${s?"active":""} ${e}_stage_${r}">\n      <input\n        type="checkbox"\n        class="${e}_stage_checkbox"\n        id="${e}_stage_cb_${t}"\n        data-stage="${t}"\n        ${n?"checked":""}\n      >\n      <button\n        class="${e}_stage_btn ${s?"active":""}"\n        data-stage="${t}"\n        title="${a[t]}"\n      >\n        <i class="fa-solid ${o[t]}"></i>\n        <span>${a[t]}</span>\n        ${c?`<i class="fa-solid ${c} ${e}_status_icon"></i>`:""}\n      </button>\n      ${i?`<div class="${e}_stage_connector ${n?"active":""}"></div>`:""}\n    </div>\n  `}(s,t.includes(s),n[s],s===r,c<i.length-1))).join("")}\n      </div>\n\n      \x3c!-- Action Buttons --\x3e\n      <div class="${e}_pipeline_actions">\n        <button\n          id="${e}_run_selected_btn"\n          class="menu_button"\n          ${s?"":"disabled"}\n        >\n          <i class="fa-solid fa-play"></i>\n          <span>Run Selected</span>\n        </button>\n        <button\n          id="${e}_run_all_btn"\n          class="menu_button"\n          ${s?"":"disabled"}\n        >\n          <i class="fa-solid fa-forward"></i>\n          <span>Run All</span>\n        </button>\n        <button\n          id="${e}_reset_pipeline_btn"\n          class="menu_button"\n        >\n          <i class="fa-solid fa-rotate-left"></i>\n          <span>Reset</span>\n        </button>\n      </div>\n    </div>\n  `}var je=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};function Ne(){return je(this,void 0,void 0,(function*(){const{Popup:e,POPUP_RESULT:t}=SillyTavern.getContext(),n=yield e.show.input("Generate Schema",'Describe the structure you want (e.g., <q>"scores for each field 1-10, list of suggestions, overall rating"</q>):\n',"");if(null===n||n===t.CANCELLED||!n.trim())return null;qe(!0);try{toastr.info("Generating schema...");const e=yield function(e){return j(this,void 0,void 0,(function*(){var t;const{generateRaw:n}=SillyTavern.getContext();if(!e.trim())return{success:!1,error:"Please describe what you want in the schema"};try{let r=(yield n({prompt:`${H}\n\n${e}`,systemPrompt:"You are a JSON Schema expert. Output only valid JSON, nothing else."})).trim();r.startsWith("```")&&(r=r.replace(/^```(?:json)?\s*/,"").replace(/\s*```$/,""));const s=F(r);if(!s.valid)return{success:!1,error:`Generated schema is invalid: ${s.error}`,schema:r};if(null===(t=s.warnings)||void 0===t?void 0:t.length){const e=B(s.schema);return{success:!0,schema:JSON.stringify(e,null,2)}}return{success:!0,schema:JSON.stringify(s.schema,null,2)}}catch(e){return{success:!1,error:`Generation failed: ${e.message}`}}}))}(n);return e.success?(toastr.success("Schema generated!"),e.schema):(toastr.error(e.error||"Generation failed"),e.schema||null)}finally{qe(!1)}}))}function qe(t){const n=document.querySelector(`.${e}_loading_overlay`);if(t&&!n){const t=document.createElement("div");t.className=`${e}_loading_overlay`,t.innerHTML=`\n            <div class="${e}_loading_content">\n                <i class="fa-solid fa-spinner fa-spin fa-2x"></i>\n                <p>Generating schema...</p>\n            </div>\n        `,document.body.appendChild(t)}else!t&&n&&n.remove()}function De(t,n,r,s){const i=P(n),o=k(n),c=t.querySelector(`#${e}_prompt_preset_select`);c&&(c.innerHTML=`<option value="">Custom</option>${Me(i,r.promptPresetId)}`,c.value=r.promptPresetId||"",c.disabled=s);const l=t.querySelector(`#${e}_custom_prompt`);if(l){let n=r.customPrompt;if(r.promptPresetId){const e=O(r.promptPresetId);e&&(n=e.prompt)}l.value!==n&&(l.value=n),l.disabled=s;const i=t.querySelector(`.${e}_char_count`);i&&(i.textContent=`${n.length.toLocaleString()} chars`)}const u=t.querySelector(`#${e}_use_structured`);u&&(u.checked=r.useStructuredOutput,u.disabled=s);const d=t.querySelector(`.${e}_schema_section`);d&&d.classList.toggle("hidden",!r.useStructuredOutput);const p=t.querySelector(`#${e}_schema_preset_select`);p&&(p.innerHTML=`<option value="">Custom</option>${Me(o,r.schemaPresetId)}`,p.value=r.schemaPresetId||"",p.disabled=s);const f=t.querySelector(`#${e}_custom_schema`);if(f){let e=r.customSchema;if(r.schemaPresetId){const t=T(r.schemaPresetId);t&&(e=JSON.stringify(t.schema,null,2))}f.value!==e&&(f.value=e),f.disabled=s}r.useStructuredOutput&&function(t,n){var r;const s=t.querySelector(`.${e}_schema_status`);s&&s.remove();if(!n.trim())return;const i=F(n);let a="";a=i.valid?(null===(r=i.warnings)||void 0===r?void 0:r.length)?`<div class="${e}_schema_status warning"><i class="fa-solid fa-triangle-exclamation"></i> ${i.warnings.length} warning(s)</div>`:`<div class="${e}_schema_status success"><i class="fa-solid fa-circle-check"></i> Valid schema</div>`:`<div class="${e}_schema_status error"><i class="fa-solid fa-circle-xmark"></i> ${He(i.error||"Invalid schema")}</div>`;const o=t.querySelector(`#${e}_custom_schema`);o&&o.insertAdjacentHTML("afterend",a)}(t,(null==f?void 0:f.value)||""),function(t,n){var r,s;const i=t.querySelector(`#${e}_validate_schema_btn`),a=t.querySelector(`#${e}_fix_schema_btn`),o=t.querySelector(`#${e}_format_schema_btn`),c=n.trim().length>0;i&&(i.disabled=!c);o&&(o.disabled=!c);if(a&&c){const e=F(n),t=(null!==(s=null===(r=e.warnings)||void 0===r?void 0:r.length)&&void 0!==s?s:0)>0||!e.valid;a.disabled=!t}else a&&(a.disabled=!0)}(t,(null==f?void 0:f.value)||"");const m=t.querySelector(`#${e}_run_stage_btn`);m&&(m.disabled=s,m.innerHTML=s?'<i class="fa-solid fa-spinner fa-spin"></i> Running...':`<i class="fa-solid fa-play"></i> Run ${a[n]} <kbd>Ctrl+Enter</kbd>`),function(t,n){var r,s;const i=t.querySelector(`#${e}_custom_prompt`),a=t.querySelector(`#${e}_custom_schema`),o=t.querySelector(`#${e}_save_prompt_preset_btn`),c=t.querySelector(`#${e}_save_schema_preset_btn`);if(o&&i){const e=i.value.trim(),t=n.promptPresetId&&(null===(r=O(n.promptPresetId))||void 0===r?void 0:r.prompt)||"",s=e.length>0,a=e!==t;o.disabled=!s||null!==n.promptPresetId&&!a}if(c&&a){const e=a.value.trim(),t=n.schemaPresetId?JSON.stringify(null===(s=T(n.schemaPresetId))||void 0===s?void 0:s.schema,null,2):"",r=e.length>0,i=e!==t,o=!!r&&F(e).valid;c.disabled=!r||!o||null!==n.schemaPresetId&&!i}}(t,r)}function Me(e,t){return e.map((e=>{const n=e.id===t?"selected":"",r=e.isBuiltin?"📦":"📝";return`<option value="${e.id}" ${n}>${r} ${He(e.name)}</option>`})).join("")}function He(e){const{DOMPurify:t}=SillyTavern.libs;return t.sanitize(e,{ALLOWED_TAGS:[]})}function Fe(e,t){const{showdown:n,DOMPurify:r}=SillyTavern.libs,s="string"==typeof e?e:String(null!=e?e:""),i=`<div class="${t}_markdown_content">${new n.Converter({tables:!0,strikethrough:!0,simpleLineBreaks:!1,headerLevelStart:1,ghCodeBlocks:!0,tasklists:!0,openLinksInNewWindow:!0,emoji:!0,parseImgDimensions:!0,simplifiedAutoLink:!0}).makeHtml(s)}</div>`;return r.sanitize(i)}function ze(e,t,n){var r;const{DOMPurify:s}=SillyTavern.libs,i="string"==typeof e?e:String(null!=e?e:""),a=function(e){try{return JSON.parse(e)}catch(t){const n=e.match(/```(?:json)?\s*([\s\S]*?)```/);if(n)try{return JSON.parse(n[1].trim())}catch(e){return null}return null}}(i);if(!a||"object"!=typeof a)return Fe(i,n);const o=function(e,t,n){const r=function(e){const t=["overallscore","totalscore","overall","total","score","rating"];for(const n of t)for(const t of Object.keys(e))if(t.toLowerCase().replace(/_/g,"")===n&&"number"==typeof e[t])return t;return null}(e),s=r?e[r]:null,i=[];r&&"number"==typeof s&&i.push(function(e,t,n){const r=Qe(e),s=et(t>10?t/10:t),i=Number.isInteger(t)?t:t.toFixed(1),a=t>10?100:10;return`\n    <div class="${n}_hero">\n      <div class="${n}_hero_label">${Xe(r)}</div>\n      <div class="${n}_hero_value" style="color: ${s}">\n        ${i}<span class="${n}_hero_max">/${a}</span>\n      </div>\n    </div>\n  `}(r,s,n));const a=t.properties||{},o=Object.keys(a).length>0?Object.keys(a):Object.keys(e);for(const t of o){if(t===r)continue;const s=e[t];if(void 0===s)continue;const o=a[t]||{type:Ke(s)};i.push(Ge(t,s,o,n,0))}return`<div class="${n}_structured_content">${i.join("")}</div>`}(a,null!==(r=null==t?void 0:t.value)&&void 0!==r?r:Ve(a),n);return s.sanitize(o)}function Ve(e){if(null===e)return{type:"null"};if(Array.isArray(e))return{type:"array",items:e.length>0?Ve(e[0]):{type:"string"}};if("object"==typeof e){const t={};for(const[n,r]of Object.entries(e))t[n]=Ve(r);return{type:"object",properties:t}}return{type:typeof e}}const Ue=8;function Ge(e,t,n,r,s){if(s>Ue)return function(e,t){const{hljs:n}=SillyTavern.libs,r=JSON.stringify(e,null,2),s=n.highlight(r,{language:"json"}).value;return`<pre class="${t}_json"><code class="hljs">${s}</code></pre>`}(t,r);const i=Qe(e),a=n.type||Ke(t);if("array"===a&&Array.isArray(t))return function(e,t,n,r,s){if(0===t.length)return`\n      <div class="${r}_field">\n        <div class="${r}_field_label">${Xe(e)}</div>\n        <div class="${r}_field_value ${r}_empty">(none)</div>\n      </div>\n    `;const i=n.items||{type:Ke(t[0])};if(t.every(Ze)){const n=t.map((e=>`<li>${function(e,t){if("boolean"==typeof e)return Ye(e,t);if("number"==typeof e)return`<span class="${t}_num">${e.toLocaleString()}</span>`;return Xe(String(e))}(e,r)}</li>`)).join("");return`\n      <div class="${r}_field">\n        <div class="${r}_field_label">${Xe(e)}</div>\n        <ol class="${r}_list">${n}</ol>\n      </div>\n    `}const a=t.map(((e,t)=>"object"==typeof e&&null!==e?function(e,t,n,r,s){const i=t.properties||{},a=Object.keys(i).length>0?Object.keys(i):Object.keys(e),o=a.find((t=>"string"==typeof e[t]&&e[t].length<100)),c=a.find((t=>"number"==typeof e[t]&&e[t]>=0&&e[t]<=100)),l=a.find((t=>"string"==typeof e[t]&&e[t].length>=50&&t!==o));let u="";if(o||c){const t=o?`<span class="${n}_card_title">${Xe(String(e[o]))}</span>`:"",r=c?We(e[c],n):"";u=`<div class="${n}_card_header">${t}${r}</div>`}let d="";l&&(d=`<div class="${n}_card_body">${Je(String(e[l]),n)}</div>`);const p=a.filter((e=>e!==o&&e!==c&&e!==l)).map((t=>{const s=e[t];if(void 0===s)return"";return Ge(t,s,i[t]||{type:Ke(s)},n,r+1)})).filter(Boolean).join(""),f=p?`<div class="${n}_card_extra">${p}</div>`:"";return`<div class="${n}_card">${u}${d}${f}</div>`}(e,i,r,s+1):`<div class="${r}_card">${Be(e,i,r)}</div>`)).join("");return`\n    <div class="${r}_field">\n      <div class="${r}_field_label">${Xe(e)}</div>\n      <div class="${r}_cards">${a}</div>\n    </div>\n  `}(i,t,n,r,s);if("object"===a&&"object"==typeof t&&null!==t)return function(e,t,n,r,s){const i=n.properties||{},a=(Object.keys(i).length>0?Object.keys(i):Object.keys(t)).map((e=>{const n=t[e];if(void 0===n)return"";return Ge(e,n,i[e]||{type:Ke(n)},r,s+1)})).filter(Boolean).join("");return`\n    <div class="${r}_field">\n      <div class="${r}_field_label">${Xe(e)}</div>\n      <div class="${r}_nested">${a}</div>\n    </div>\n  `}(i,t,n,r,s);const o=Be(t,n,r,e);return`\n    <div class="${r}_field">\n      <div class="${r}_field_label">${Xe(i)}</div>\n      <div class="${r}_field_value">${o}</div>\n    </div>\n  `}function Be(e,t,n,r){if(null==e)return`<span class="${n}_null">—</span>`;switch(t.type||Ke(e)){case"string":return function(e,t,n){if(!e.trim())return`<span class="${n}_empty">(empty)</span>`;const r=t.format;if("uri"===r||"url"===r||(s=e,/^https?:\/\//i.test(s))){const t=e.length>50?e.substring(0,47)+"...":e;return`<a href="${Xe(e)}" target="_blank" rel="noopener" class="${n}_link">${Xe(t)}</a>`}var s;if("email"===r||function(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}(e))return`<a href="mailto:${Xe(e)}" class="${n}_link">${Xe(e)}</a>`;if(e.length>100||e.includes("\n"))return Je(e,n);return`<span>${Xe(e)}</span>`}(e,t,n);case"number":case"integer":return function(e,t,n,r){const s=String(t.title||t.description||r||"").toLowerCase();if(function(e,t){return!!["score","rating","rank","grade","level","confidence","quality"].some((t=>e.includes(t)))||(!!(t>=0&&t<=10&&Number.isFinite(t))||!!(t>=0&&t<=100&&Number.isInteger(t)))}(s,e))return We(e,n);const i=e.toLocaleString(void 0,{maximumFractionDigits:2});return`<span class="${n}_num">${i}</span>`}(e,t,n,r);case"boolean":return Ye(e,n);default:return`<span>${Xe(String(e))}</span>`}}function Je(e,t){return`<div class="${t}_text">${Fe(e,t)}</div>`}function We(e,t){return`<span class="${t}_score" style="color: ${et(e>10?e/10:e)}">${Number.isInteger(e)?e:e.toFixed(1)}<span class="${t}_score_max">/${e>10?100:10}</span></span>`}function Ye(e,t){return`<span class="${e?`${t}_yes`:`${t}_no`}"><i class="fa-solid ${e?"fa-check-circle":"fa-times-circle"}"></i> ${e?"Yes":"No"}</span>`}function Xe(e){const{DOMPurify:t}=SillyTavern.libs,n="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(n,{ALLOWED_TAGS:[]})}function Ke(e){return null===e?"null":Array.isArray(e)?"array":typeof e}function Ze(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e||null===e}function Qe(e){return e.replace(/_/g," ").replace(/([a-z])([A-Z])/g,"$1 $2").replace(/\b\w/g,(e=>e.toUpperCase()))}function et(e){return e>=8?"var(--success, #2ecc71)":e>=5?"var(--warning, #f39c12)":"var(--failure, #e74c3c)"}function tt(t){return`\n    <div class="${e}_results_loading">\n      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>\n      <p>Running ${a[t]}...</p>\n      <button id="${e}_cancel_btn" class="menu_button">\n        <i class="fa-solid fa-stop"></i>\n        <span>Cancel</span>\n      </button>\n    </div>\n  `}function nt(t,n){let r=`Run ${a[t]} to see results`,s="fa-play";return"skipped"===n&&(r=`${a[t]} was skipped`,s="fa-forward"),`\n    <div class="${e}_results_placeholder">\n      <i class="fa-solid ${s}"></i>\n      <p>${r}</p>\n    </div>\n  `}function rt(t,n){const r=n.isStructured?ze(n.response,null,e):Fe(n.response,e),s=new Date(n.timestamp).toLocaleTimeString();let i="";if("analyze"===t){i=function(t){return`\n    <span class="${e}_badge ${e}_verdict_badge ${e}_verdict_${t}">\n      <i class="fa-solid ${{accept:"fa-check-circle",needs_refinement:"fa-wrench",regression:"fa-arrow-down"}[t]}"></i>\n      ${{accept:"Accept",needs_refinement:"Needs Work",regression:"Regression"}[t]}\n    </span>\n  `}(ae(n.response))}return`\n    <div class="${e}_results_content">\n      \x3c!-- Toolbar --\x3e\n      <div class="${e}_results_toolbar">\n        <div class="${e}_results_info">\n          <span class="${e}_badge">${a[t]}</span>\n          ${i}\n          <span class="${e}_results_time">${s}</span>\n          ${n.locked?`<span class="${e}_badge ${e}_badge_locked"><i class="fa-solid fa-lock"></i> Locked</span>`:""}\n        </div>\n        <div class="${e}_results_actions">\n          \x3c!-- Always render BOTH buttons, use hidden class based on locked state --\x3e\n          <button id="${e}_lock_btn" class="${e}_icon_btn ${n.locked?"hidden":""}" title="Lock result">\n            <i class="fa-solid fa-lock"></i>\n          </button>\n          <button id="${e}_unlock_btn" class="${e}_icon_btn ${n.locked?"":"hidden"}" title="Unlock for editing">\n            <i class="fa-solid fa-lock-open"></i>\n          </button>\n          <button id="${e}_copy_btn" class="${e}_icon_btn" title="Copy to clipboard">\n            <i class="fa-solid fa-copy"></i>\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Content --\x3e\n      <div class="${e}_results_body">\n        ${r}\n      </div>\n\n      \x3c!-- Footer Actions --\x3e\n      <div class="${e}_results_footer" id="${e}_results_footer">\n        \x3c!-- Populated by updateResultsPanelState --\x3e\n      </div>\n    </div>\n  `}function st(t,n,r,s,i,o,c){var l;const u=i&&"running"===s,d=r&&!u,p=!r&&!u;if(u)return void(t.innerHTML=tt(n));if(p)return void(t.innerHTML=nt(n,s));if(d){const s=t.querySelector(`.${e}_results_content`),i=null===(l=t.querySelector(`.${e}_results_time`))||void 0===l?void 0:l.textContent,a=new Date(r.timestamp).toLocaleTimeString();s&&i===a||(t.innerHTML=rt(n,r))}const f=t.querySelector(`#${e}_results_footer`);f&&r&&(f.innerHTML=function(t,n,r,s){const i=[];n.locked||i.push(`\n      <button id="${e}_regenerate_btn" class="menu_button">\n        <i class="fa-solid fa-rotate"></i>\n        <span>Regenerate</span>\n      </button>\n    `);"rewrite"===t&&s.character&&i.push(`\n      <button id="${e}_apply_btn" class="menu_button ${e}_apply_btn">\n        <i class="fa-solid fa-check-double"></i>\n        <span>Apply to Character</span>\n      </button>\n    `);if("analyze"===t){const t=ae(n.response);if(re(s).canRun){const n="needs_refinement"===t;i.push(`\n        <button id="${e}_refine_btn" class="menu_button ${n?e+"_refine_recommended":""}">\n          <i class="fa-solid fa-arrows-rotate"></i>\n          <span>Refine</span>\n          ${s.iterationCount>0?`<span class="${e}_iteration_badge">#${s.iterationCount+1}</span>`:""}\n        </button>\n      `)}if(s.results.rewrite&&!s.results.rewrite.locked){const n="accept"===t;i.push(`\n        <button id="${e}_accept_btn" class="menu_button ${n?e+"_accept_recommended":""}">\n          <i class="fa-solid fa-check"></i>\n          <span>Accept Rewrite</span>\n        </button>\n      `)}}r&&"analyze"!==t&&i.push(`\n      <button id="${e}_continue_btn" class="menu_button ${e}_continue_btn">\n        <i class="fa-solid fa-arrow-right"></i>\n        <span>Continue to ${a[r]}</span>\n      </button>\n    `);de(s)&&i.push(`\n      <button id="${e}_export_btn" class="menu_button">\n        <i class="fa-solid fa-file-export"></i>\n        <span>Export</span>\n      </button>\n    `);return`<div class="${e}_footer_actions">${i.join("")}</div>`}(n,r,o,c));const m=t.querySelector(`#${e}_lock_btn`),g=t.querySelector(`#${e}_unlock_btn`);m&&g&&(m.classList.toggle("hidden",!!(null==r?void 0:r.locked)),g.classList.toggle("hidden",!(null==r?void 0:r.locked)))}function it(t,n,r){if(0===t.length&&0===n)return"";const s=r?0===t.length?`<div class="${e}_iteration_empty">No previous iterations</div>`:t.map(((e,t)=>at(e,t))).join(""):`<div class="${e}_iteration_loading">\n             <i class="fa-solid fa-spinner fa-spin"></i>\n             <span>Loading history...</span>\n           </div>`;return`\n    <div class="${e}_iteration_history" id="${e}_iteration_history">\n      <div class="${e}_iteration_header">\n        <i class="fa-solid fa-clock-rotate-left"></i>\n        <span>Iteration History</span>\n        <span class="${e}_iteration_count">${n>0?`Current: #${n+1}`:"Initial"}</span>\n      </div>\n      <div class="${e}_iteration_list">\n        ${s}\n      </div>\n    </div>\n  `}function at(t,n){const r=ot(t.verdict),s=ct(t.verdict),i=new Date(t.timestamp).toLocaleTimeString();return`\n    <div class="${e}_iteration_item ${s}" data-index="${n}">\n      <div class="${e}_iteration_item_header">\n        <span class="${e}_iteration_num">#${t.iteration+1}</span>\n        <span class="${e}_iteration_verdict">\n          <i class="fa-solid ${r}"></i>\n          ${lt(t.verdict)}\n        </span>\n        <span class="${e}_iteration_time">${i}</span>\n      </div>\n      <div class="${e}_iteration_preview">\n        ${ut(t.rewritePreview)}...\n      </div>\n      <div class="${e}_iteration_actions">\n        <button\n          class="${e}_iteration_revert_btn menu_button"\n          data-index="${n}"\n          title="Revert to this version"\n        >\n          <i class="fa-solid fa-rotate-left"></i>\n          Revert\n        </button>\n        <button\n          class="${e}_iteration_view_btn menu_button"\n          data-index="${n}"\n          title="View full content"\n        >\n          <i class="fa-solid fa-eye"></i>\n          View\n        </button>\n      </div>\n    </div>\n  `}function ot(e){switch(e){case"accept":return"fa-check-circle";case"needs_refinement":return"fa-wrench";case"regression":return"fa-arrow-down";default:return"fa-question-circle"}}function ct(t){return`${e}_verdict_${t}`}function lt(e){switch(e){case"accept":return"Accepted";case"needs_refinement":return"Needs Work";case"regression":return"Regression";default:return"Unknown"}}function ut(e){const{DOMPurify:t}=SillyTavern.libs,n="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(n,{ALLOWED_TAGS:[]})}var dt=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};function pt(t){return dt(this,void 0,void 0,(function*(){const{Popup:s,POPUP_TYPE:i}=SillyTavern.getContext(),{DOMPurify:a}=SillyTavern.libs,o=function(){const t=w(),n=t.generationConfig,{moment:s}=SillyTavern.libs;return`\n    <div class="${e}_settings_modal" id="${e}_settings_modal">\n      <div class="${e}_settings_header">\n        <i class="fa-solid fa-gear"></i>\n        <span>Character Tools Settings</span>\n      </div>\n\n      \x3c!-- Generation Settings --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-microchip"></i>\n          <span>Generation</span>\n        </div>\n\n        <div class="${e}_settings_row">\n          <label class="${e}_checkbox_label">\n            <input\n              type="checkbox"\n              id="${e}_use_current_settings"\n              ${t.useCurrentSettings?"checked":""}\n            >\n            <span>Use Current SillyTavern Settings</span>\n          </label>\n        </div>\n\n        <div id="${e}_custom_gen_config" class="${t.useCurrentSettings?"hidden":""}">\n          <div class="${e}_settings_grid">\n            <div class="${e}_settings_field">\n              <label>Source</label>\n              <select id="${e}_gen_source" class="text_pole"></select>\n            </div>\n            <div class="${e}_settings_field">\n              <label>Model</label>\n              <select id="${e}_gen_model" class="text_pole"></select>\n            </div>\n          </div>\n\n          <div class="${e}_settings_grid ${e}_settings_grid_5">\n            <div class="${e}_settings_field">\n              <label>Temp</label>\n              <input type="number" id="${e}_gen_temp" class="text_pole" value="${n.temperature}" min="0" max="2" step="0.1">\n            </div>\n            <div class="${e}_settings_field">\n              <label>Max Tokens</label>\n              <input type="number" id="${e}_gen_tokens" class="text_pole" value="${n.maxTokens}" min="100" max="32000" step="100">\n            </div>\n            <div class="${e}_settings_field">\n              <label>Freq Pen</label>\n              <input type="number" id="${e}_gen_freq" class="text_pole" value="${n.frequencyPenalty}" min="-2" max="2" step="0.1">\n            </div>\n            <div class="${e}_settings_field">\n              <label>Pres Pen</label>\n              <input type="number" id="${e}_gen_pres" class="text_pole" value="${n.presencePenalty}" min="-2" max="2" step="0.1">\n            </div>\n            <div class="${e}_settings_field">\n              <label>Top P</label>\n              <input type="number" id="${e}_gen_top_p" class="text_pole" value="${n.topP}" min="0" max="1" step="0.05">\n            </div>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- System Prompt --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-message"></i>\n          <span>System Prompt</span>\n        </div>\n\n        <p class="${e}_settings_hint">Base instructions applied to all stages</p>\n\n        <textarea\n          id="${e}_system_prompt"\n          class="text_pole ${e}_system_prompt_textarea"\n          rows="6"\n        >${_t(t.systemPrompt)}</textarea>\n\n        <div class="${e}_settings_row_spread">\n          <span id="${e}_system_prompt_chars">${t.systemPrompt.length.toLocaleString()} chars</span>\n          <button id="${e}_reset_system_prompt" class="menu_button">\n            <i class="fa-solid fa-rotate-left"></i>\n            Reset\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Refinement Prompt --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-arrows-rotate"></i>\n          <span>Refinement Prompt</span>\n        </div>\n\n        <p class="${e}_settings_hint">Template for iterative refinement. Placeholders: {{original_character}}, {{current_rewrite}}, {{current_analysis}}, {{score_results}}, {{iteration_number}}</p>\n\n        <textarea\n          id="${e}_refinement_prompt"\n          class="text_pole ${e}_system_prompt_textarea"\n          rows="8"\n        >${_t(t.refinementPrompt)}</textarea>\n\n        <div class="${e}_settings_row_spread">\n          <span id="${e}_refinement_prompt_chars">${t.refinementPrompt.length.toLocaleString()} chars</span>\n          <button id="${e}_reset_refinement_prompt" class="menu_button">\n            <i class="fa-solid fa-rotate-left"></i>\n            Reset\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Preset Management --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-bookmark"></i>\n          <span>Presets</span>\n        </div>\n\n        <div class="${e}_presets_grid">\n          <div class="${e}_preset_column">\n            <h4>Prompt Presets</h4>\n            <div id="${e}_prompt_presets_list" class="${e}_preset_list">\n              ${ft("prompt")}\n            </div>\n          </div>\n          <div class="${e}_preset_column">\n            <h4>Schema Presets</h4>\n            <div id="${e}_schema_presets_list" class="${e}_preset_list">\n              ${ft("schema")}\n            </div>\n          </div>\n        </div>\n\n        <div class="${e}_settings_row_spread">\n          <button id="${e}_export_presets" class="menu_button">\n            <i class="fa-solid fa-file-export"></i>\n            Export Custom\n          </button>\n          <button id="${e}_import_presets" class="menu_button">\n            <i class="fa-solid fa-file-import"></i>\n            Import\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Keyboard Shortcuts --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-keyboard"></i>\n          <span>Keyboard Shortcuts</span>\n        </div>\n\n        <div class="${e}_shortcuts_list">\n          <div class="${e}_shortcut_item">\n            <kbd>Ctrl</kbd> + <kbd>Enter</kbd>\n            <span>Run current stage</span>\n          </div>\n          <div class="${e}_shortcut_item">\n            <kbd>Escape</kbd>\n            <span>Cancel generation</span>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Debug --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-bug"></i>\n          <span>Debug</span>\n        </div>\n\n        <div class="${e}_settings_row">\n          <label class="${e}_checkbox_label">\n            <input\n              type="checkbox"\n              id="${e}_debug_mode"\n              ${t.debugMode?"checked":""}\n            >\n            <span>Enable Debug Logging</span>\n          </label>\n        </div>\n\n        <div class="${e}_debug_actions">\n          <button id="${e}_view_logs" class="menu_button">\n            <i class="fa-solid fa-list"></i>\n            View Logs\n          </button>\n          <button id="${e}_clear_logs" class="menu_button">\n            <i class="fa-solid fa-trash"></i>\n            Clear\n          </button>\n          <button id="${e}_copy_debug_info" class="menu_button">\n            <i class="fa-solid fa-copy"></i>\n            Copy Info\n          </button>\n        </div>\n\n        <div id="${e}_debug_log_viewer" class="${e}_debug_log_viewer hidden">\n          <div id="${e}_debug_log_list" class="${e}_debug_log_list"></div>\n          <pre id="${e}_debug_log_detail" class="${e}_debug_log_detail">Select a log entry</pre>\n        </div>\n      </div>\n\n      \x3c!-- Footer --\x3e\n      <div class="${e}_settings_footer">\n        <span class="${e}_settings_version">v${r} • Last updated: ${s().format("YYYY-MM-DD HH:mm:ss")}</span>\n      </div>\n    </div>\n  `}();new s(a.sanitize(o),i.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:"Save & Close",cancelButton:!1}).show().then((()=>{null==t||t(),y("info","Settings modal closed",null)})),yield new Promise((e=>setTimeout(e,0))),function(){const t=document.getElementById(`${e}_settings_modal`);if(!t)return;const r=t.querySelector(`#${e}_use_current_settings`),s=t.querySelector(`#${e}_custom_gen_config`);null==r||r.addEventListener("change",(()=>{C("useCurrentSettings",r.checked),null==s||s.classList.toggle("hidden",r.checked)}));const i=t.querySelector(`#${e}_gen_source`),a=t.querySelector(`#${e}_gen_model`),o=t.querySelector(`#${e}_gen_temp`),u=t.querySelector(`#${e}_gen_tokens`),d=t.querySelector(`#${e}_gen_freq`),p=t.querySelector(`#${e}_gen_pres`),f=t.querySelector(`#${e}_gen_top_p`);null==i||i.addEventListener("change",(()=>{x({source:i.value}),ht(i.value)})),null==a||a.addEventListener("change",(()=>{x({model:a.value})}));const m=(e,t,n=!1)=>{null==e||e.addEventListener("change",(()=>{const r=n?parseInt(e.value,10):parseFloat(e.value);isNaN(r)||x({[t]:r})}))};m(o,"temperature"),m(u,"maxTokens",!0),m(d,"frequencyPenalty"),m(p,"presencePenalty"),m(f,"topP");const g=t.querySelector(`#${e}_system_prompt`),h=t.querySelector(`#${e}_system_prompt_chars`),_=t.querySelector(`#${e}_reset_system_prompt`);null==g||g.addEventListener("input",(()=>{C("systemPrompt",g.value),h&&(h.textContent=`${g.value.length.toLocaleString()} chars`)})),null==_||_.addEventListener("click",(()=>{C("systemPrompt",c),g&&(g.value=c),h&&(h.textContent=`${c.length.toLocaleString()} chars`),toastr.info("System prompt reset to default")}));const $=t.querySelector(`#${e}_refinement_prompt`),S=t.querySelector(`#${e}_refinement_prompt_chars`),P=t.querySelector(`#${e}_reset_refinement_prompt`);null==$||$.addEventListener("input",(()=>{C("refinementPrompt",$.value),S&&(S.textContent=`${$.value.length.toLocaleString()} chars`)})),null==P||P.addEventListener("click",(()=>{C("refinementPrompt",l),$&&($.value=l),S&&(S.textContent=`${l.length.toLocaleString()} chars`),toastr.info("Refinement prompt reset to default")})),t.addEventListener("click",(t=>{const n=t.target.closest(`.${e}_preset_delete`);if(n){const t=n.getAttribute("data-type"),r=n.getAttribute("data-id");t&&r&&function(t,n){const r="prompt"===t?function(t){var n;const{extensionSettings:r,saveSettingsDebounced:s}=SillyTavern.getContext(),i=r[e],a=i.promptPresets.findIndex((e=>e.id===t));if(-1===a)return null;if(i.promptPresets[a].isBuiltin)return y("error","Cannot delete builtin preset",{id:t}),null;i.promptPresets.splice(a,1);for(const e of["score","rewrite","analyze"])(null===(n=i.stageDefaults[e])||void 0===n?void 0:n.promptPresetId)===t&&(i.stageDefaults[e].promptPresetId=null);return s(),y("info","Prompt preset deleted",{id:t}),t}(n):function(t){var n;const{extensionSettings:r,saveSettingsDebounced:s}=SillyTavern.getContext(),i=r[e],a=i.schemaPresets.findIndex((e=>e.id===t));if(-1===a)return null;if(i.schemaPresets[a].isBuiltin)return y("error","Cannot delete builtin preset",{id:t}),null;i.schemaPresets.splice(a,1);for(const e of["score","rewrite","analyze"])(null===(n=i.stageDefaults[e])||void 0===n?void 0:n.schemaPresetId)===t&&(i.stageDefaults[e].schemaPresetId=null);return s(),y("info","Schema preset deleted",{id:t}),t}(n);r?(toastr.success("Preset deleted"),mt()):toastr.error("Cannot delete builtin preset")}(t,r)}}));const O=t.querySelector(`#${e}_export_presets`),k=t.querySelector(`#${e}_import_presets`);null==O||O.addEventListener("click",(()=>{const e=function(){const e=w(),t=e.promptPresets.filter((e=>!e.isBuiltin)),r=e.schemaPresets.filter((e=>!e.isBuiltin));return JSON.stringify({version:n,exportedAt:(new Date).toISOString(),promptPresets:t,schemaPresets:r},null,2)}();navigator.clipboard.writeText(e),toastr.success("Custom presets copied to clipboard")})),null==k||k.addEventListener("click",(()=>dt(this,void 0,void 0,(function*(){try{const e=function(e){const t=[];let n=0,r=0;try{const s=JSON.parse(e);if(s.promptPresets&&Array.isArray(s.promptPresets))for(const e of s.promptPresets)try{e.name&&e.prompt&&(A({name:e.name,prompt:e.prompt,stages:e.stages||[]}),n++)}catch(n){t.push(`Failed to import prompt "${e.name}": ${n}`)}if(s.schemaPresets&&Array.isArray(s.schemaPresets))for(const e of s.schemaPresets)try{e.name&&e.schema&&(I({name:e.name,schema:e.schema,stages:e.stages||[]}),r++)}catch(n){t.push(`Failed to import schema "${e.name}": ${n}`)}}catch(e){t.push(`Failed to parse JSON: ${e}`)}return y("info","Presets imported",{promptsImported:n,schemasImported:r,errors:t}),{prompts:n,schemas:r,errors:t}}(yield navigator.clipboard.readText());e.errors.length>0?toastr.error(e.errors.join("\n")):(toastr.success(`Imported ${e.prompts} prompts, ${e.schemas} schemas`),mt())}catch(e){toastr.error("Failed to read clipboard")}}))));const T=t.querySelector(`#${e}_debug_mode`),R=t.querySelector(`#${e}_view_logs`),L=t.querySelector(`#${e}_clear_logs`),j=t.querySelector(`#${e}_copy_debug_info`),N=t.querySelector(`#${e}_debug_log_viewer`);null==T||T.addEventListener("change",(()=>{E(T.checked),toastr.info("Debug mode "+(T.checked?"enabled":"disabled"))})),null==R||R.addEventListener("click",(()=>{null==N||N.classList.toggle("hidden"),(null==N?void 0:N.classList.contains("hidden"))||gt()})),null==L||L.addEventListener("click",(()=>{v.length=0,gt(),toastr.info("Debug logs cleared")})),null==j||j.addEventListener("click",(()=>{navigator.clipboard.writeText(b()),toastr.success("Debug info copied to clipboard")}))}(),function(){const t=w();(function(t){const n=document.getElementById(`${e}_settings_modal`),r=null==n?void 0:n.querySelector(`#${e}_gen_source`);if(!r)return;r.innerHTML="";const s=document.getElementById("chat_completion_source");s&&Array.from(s.options).forEach((e=>{if(e.value){const t=document.createElement("option");t.value=e.value,t.textContent=e.textContent||e.value,r.appendChild(t)}}));0===r.options.length&&["openrouter","openai","claude","makersuite","mistralai","groq"].forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,r.appendChild(t)}));r.value=t})(t.generationConfig.source),ht(t.generationConfig.source,t.generationConfig.model)}(),y("info","Settings modal opened",null)}))}function ft(t){const n="prompt"===t?P():k();return 0===n.length?`<div class="${e}_preset_empty">No presets</div>`:n.map((n=>`\n    <div class="${e}_preset_item ${n.isBuiltin?"builtin":""}" data-id="${n.id}">\n      <span class="${e}_preset_name">\n        ${n.isBuiltin?'<i class="fa-solid fa-lock"></i>':""}\n        ${_t(n.name)}\n      </span>\n      ${n.isBuiltin?"":`\n        <button class="${e}_preset_delete" data-type="${t}" data-id="${n.id}" title="Delete">\n          <i class="fa-solid fa-trash"></i>\n        </button>\n      `}\n    </div>\n  `)).join("")}function mt(){const t=document.getElementById(`${e}_settings_modal`);if(!t)return;const n=t.querySelector(`#${e}_prompt_presets_list`),r=t.querySelector(`#${e}_schema_presets_list`);n&&(n.innerHTML=ft("prompt")),r&&(r.innerHTML=ft("schema"))}function gt(){const t=document.getElementById(`${e}_settings_modal`);if(!t)return;const n=t.querySelector(`#${e}_debug_log_list`),r=t.querySelector(`#${e}_debug_log_detail`);if(!n||!r)return;const s=[...v];n.innerHTML=s.length?s.map(((t,n)=>`\n        <div class="${e}_debug_log_entry" data-index="${n}">\n          ${function(e){const t=e.timestamp.toLocaleTimeString();return`${{request:"📤",response:"📥",error:"❌",info:"ℹ️",state:"🔄"}[e.type]} [${t}] ${e.label}`}(t)}\n        </div>\n      `)).join(""):`<div class="${e}_debug_log_empty">No logs</div>`,n.querySelectorAll(`.${e}_debug_log_entry`).forEach((e=>{e.addEventListener("click",(()=>{const t=parseInt(e.dataset.index||"0",10),n=s[t];n&&r&&(r.textContent=function(e){try{return null===e?"null":void 0===e?"undefined":"string"==typeof e?e:JSON.stringify(e,null,2)}catch(t){return String(e)}}(n.data))}))}))}function ht(t,n){const r=document.getElementById(`${e}_settings_modal`),s=null==r?void 0:r.querySelector(`#${e}_gen_model`);if(!s)return;s.innerHTML="";const i={openrouter:"model_openrouter_select",openai:"model_openai_select",claude:"model_claude_select",makersuite:"model_google_select",google:"model_google_select",mistralai:"model_mistralai_select",cohere:"model_cohere_select",perplexity:"model_perplexity_select",groq:"model_groq_select",ai21:"model_ai21_select",deepseek:"model_deepseek_select",custom:"model_custom_select"},a=i[t]?document.getElementById(i[t]):null;if(null==a?void 0:a.options.length)Array.from(a.options).forEach((e=>{if(e.value){const t=document.createElement("option");t.value=e.value,t.textContent=e.textContent||e.value,s.appendChild(t)}}));else{const e=document.createElement("option");e.value=n||"",e.textContent=n||`No models for ${t}`,s.appendChild(e)}n&&Array.from(s.options).some((e=>e.value===n))?s.value=n:s.options.length&&(s.value=s.options[0].value,x({model:s.options[0].value}))}function _t(e){const{DOMPurify:t}=SillyTavern.libs,n="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(n,{ALLOWED_TAGS:[]})}var vt=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};function yt(t){const n=function(e){let t=5381;for(let n=0;n<e.length;n++)t=(t<<5)+t^e.charCodeAt(n);return(t>>>0).toString(36)}(`${t.avatar}::${t.name}`);return`${e}_history_${n}`}function $t(e,t){return vt(this,void 0,void 0,(function*(){const{localforage:n}=SillyTavern.libs,r=yt(e);try{return yield n.setItem(r,{characterName:e.name,characterAvatar:e.avatar,history:t,savedAt:Date.now()}),y("info","Iteration history saved",{key:r,characterName:e.name,historyLength:t.length}),!0}catch(e){return $("Failed to save iteration history",{key:r,error:e}),!1}}))}var bt=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};let St=null,wt=null;const Ct=[];function xt(){const{eventSource:e,eventTypes:t}=SillyTavern.getContext(),n=()=>{y("info","API status changed",{isReady:ye()}),Et()},r=()=>{y("info","Main API changed",null),Et(),Vt()},s=e=>{var t,n,r;const s=null!==(n=null===(t=e.detail)||void 0===t?void 0:t.character)&&void 0!==n?n:e.character,i=void 0!==(null===(r=e.detail)||void 0===r?void 0:r.id)?parseInt(e.detail.id,10):e.id;y("info","Character edited externally",{id:i,name:null==s?void 0:s.name}),Pt(i)},i=e=>{y("info","Character deleted",{id:e.id}),function(e){if(!St)return;const t=St.pipeline.characterIndex;if(null===t)return;if(t===e)Ot(),toastr.warning("Selected character was deleted");else if(t>e){const{characters:e}=SillyTavern.getContext(),n=e,r=t-1;r>=0&&r<n.length?(St.pipeline=Object.assign(Object.assign({},St.pipeline),{characterIndex:r,character:n[r]}),y("info","Character index adjusted after deletion",{oldIndex:t,newIndex:r})):Ot()}}(e.id)},a=()=>{y("info","OAI preset changed",null),St&&Vt()},o=()=>{y("info","Chat completion source changed",null),Et(),Vt()},c=()=>{y("info","Chat completion model changed",null),Et(),Vt()};e.on(t.ONLINE_STATUS_CHANGED,n),e.on(t.MAIN_API_CHANGED,r),e.on(t.CHARACTER_EDITED,s),e.on(t.CHARACTER_DELETED,i),e.on(t.OAI_PRESET_CHANGED_AFTER,a),e.on(t.CHATCOMPLETION_SOURCE_CHANGED,o),e.on(t.CHATCOMPLETION_MODEL_CHANGED,c),Ct.push((()=>e.removeListener(t.ONLINE_STATUS_CHANGED,n)),(()=>e.removeListener(t.MAIN_API_CHANGED,r)),(()=>e.removeListener(t.CHARACTER_EDITED,s)),(()=>e.removeListener(t.CHARACTER_DELETED,i)),(()=>e.removeListener(t.OAI_PRESET_CHANGED_AFTER,a)),(()=>e.removeListener(t.CHATCOMPLETION_SOURCE_CHANGED,o)),(()=>e.removeListener(t.CHATCOMPLETION_MODEL_CHANGED,c))),y("info","Event listeners subscribed",{count:Ct.length})}function Et(){if(!wt)return;const t=$e(),n=wt.querySelector(`.${e}_api_status`);if(n){n.className=`${e}_api_status ${t.isReady?"connected":"disconnected"}`;const r=n.querySelector("span");r&&(r.textContent=t.source)}qt()}function Pt(e){var t;if(!St||null===St.pipeline.characterIndex)return;const{characters:n}=SillyTavern.getContext(),r=n,s=St.pipeline.characterIndex;if(void 0===e||e===s)if(s>=0&&s<r.length){const e=r[s];e.name===(null===(t=St.pipeline.character)||void 0===t?void 0:t.name)?(St.pipeline=Object.assign(Object.assign({},St.pipeline),{character:e}),Nt(),Vt(),y("info","Character refreshed",{name:e.name})):Ot()}else Ot()}function Ot(){St&&(y("info","Character invalidated, clearing selection",null),St.pipeline=ee(St.pipeline,null,null),St.historyLoaded=!1,jt(),toastr.info("Character selection cleared"))}let At=null;function kt(){return bt(this,void 0,void 0,(function*(){const{Popup:t,POPUP_TYPE:n}=SillyTavern.getContext(),{DOMPurify:r}=SillyTavern.libs;Tt=!1,St={pipeline:Q(),isGenerating:!1,isRefining:!1,abortController:null,activeStageView:"score",historyLoaded:!1,debouncedFunctions:[]};const c=function(){const t=$e();return`\n    <div class="${e}_popup" id="${e}_popup">\n      \x3c!-- Header --\x3e\n      <div class="${e}_popup_header">\n        <div class="${e}_popup_title">\n          <i class="fa-solid fa-wand-magic-sparkles"></i>\n          <span>Character Tools</span>\n        </div>\n        <div class="${e}_popup_header_right">\n          <div class="${e}_api_status ${t.isReady?"connected":"disconnected"}">\n            <i class="fa-solid fa-circle"></i>\n            <span>${t.source}</span>\n          </div>\n          <button id="${e}_settings_btn" class="${e}_icon_btn" title="Settings">\n            <i class="fa-solid fa-gear"></i>\n          </button>\n          <button id="${e}_close_btn" class="${e}_icon_btn" title="Close">\n            <i class="fa-solid fa-xmark"></i>\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Character Section --\x3e\n      <div class="${e}_section" id="${e}_character_section">\n        <div class="${e}_section_header">\n          <i class="fa-solid fa-user"></i>\n          <span>Character</span>\n        </div>\n        <div id="${e}_character_select_container"></div>\n      </div>\n\n      \x3c!-- Pipeline Section --\x3e\n      <div class="${e}_section" id="${e}_pipeline_section">\n        <div class="${e}_section_header">\n          <i class="fa-solid fa-diagram-project"></i>\n          <span>Pipeline</span>\n        </div>\n        <div id="${e}_pipeline_nav_container"></div>\n      </div>\n\n      \x3c!-- Stage Config Section --\x3e\n      <div class="${e}_section" id="${e}_stage_section">\n        <div class="${e}_section_header">\n          <i class="fa-solid ${o.score}" id="${e}_stage_icon"></i>\n          <span id="${e}_stage_title">Score</span>\n        </div>\n        <div id="${e}_stage_config_container"></div>\n      </div>\n\n      \x3c!-- Results Section --\x3e\n      <div class="${e}_section ${e}_section_grow" id="${e}_results_section">\n        <div class="${e}_section_header">\n          <i class="fa-solid fa-file-lines"></i>\n          <span>Results</span>\n          <span id="${e}_iteration_indicator" class="${e}_iteration_indicator hidden"></span>\n        </div>\n        <div id="${e}_results_container"></div>\n        <div id="${e}_iteration_history_container"></div>\n      </div>\n    </div>\n  `}();new t(r.sanitize(c),n.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:!1,cancelButton:!1}).show().then((()=>{(null==St?void 0:St.abortController)&&St.abortController.abort(),St=null,wt=null,Tt=!1,Ct.forEach((e=>e())),Ct.length=0,y("info","Event listeners unsubscribed",null),At&&(document.removeEventListener("keydown",At),At=null),(null==St?void 0:St.debouncedFunctions)&&(St.debouncedFunctions.forEach((e=>e.cancel())),St.debouncedFunctions=[]),null==Pe||Pe.clear(),y("info","Popup closed",null)})),yield new Promise((e=>setTimeout(e,0))),wt=document.getElementById(`${e}_popup`),xt(),At=e=>{St&&("Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),St.isGenerating||St.isRefining||Rt(St.activeStageView)),"Escape"===e.key&&(St.isGenerating||St.isRefining)&&St.abortController&&St.abortController.abort())},document.addEventListener("keydown",At);const{characters:l}=SillyTavern.getContext(),u=l;!function(t){var n,r;if(!St||!wt)return;const o=wt.querySelector(`#${e}_character_select_container`);o&&(o.innerHTML=function(t,n){const r=null!==n?t[n]:null;return`\n    <div class="${e}_char_select">\n      \x3c!-- Search --\x3e\n      <div class="${e}_search_wrapper ${r?"hidden":""}">\n        <div class="${e}_search_container">\n          <i class="fa-solid fa-search ${e}_search_icon"></i>\n          <input\n            type="text"\n            id="${e}_char_search"\n            class="text_pole ${e}_search_input"\n            placeholder="Search characters..."\n            autocomplete="off"\n          >\n        </div>\n        <div id="${e}_char_dropdown" class="${e}_dropdown hidden"></div>\n      </div>\n\n      \x3c!-- Selected Character Preview --\x3e\n      ${r?Ae(r):""}\n    </div>\n  `}(t,St.pipeline.characterIndex),function(){if(!wt||!St)return;if(Tt)return void y("info","Character select listeners already initialized, skipping",null);const{Fuse:t,lodash:n}=SillyTavern.libs,r=wt.querySelector(`#${e}_character_select_container`);if(!r)return;const s=r.querySelector(`#${e}_char_search`),i=r.querySelector(`#${e}_char_dropdown`);if(!s||!i)return;Tt=!0;let a=-1,o=[];const c=()=>{const{characters:n}=SillyTavern.getContext(),r=n.map(((e,t)=>({char:e,index:t}))).filter((({char:e})=>null==e?void 0:e.name)),c=new t(r,{keys:["char.name","char.description"],threshold:.4,includeScore:!0,minMatchCharLength:1}),l=s.value.trim();if(!l)return i.classList.add("hidden"),void(o=[]);const u=c.search(l,{limit:10});if(o=u.map((e=>e.item)),0===o.length)return i.innerHTML=`<div class="${e}_dropdown_empty">No characters found</div>`,void i.classList.remove("hidden");a=-1,Te(o,i,-1),i.classList.remove("hidden")},l=n.debounce(c,150);St.debouncedFunctions.push(l),s.addEventListener("input",l),s.addEventListener("keydown",(e=>{0!==o.length&&("ArrowDown"===e.key?(e.preventDefault(),a=Math.min(a+1,o.length-1),Te(o,i,a)):"ArrowUp"===e.key?(e.preventDefault(),a=Math.max(a-1,0),Te(o,i,a)):"Enter"===e.key&&a>=0?(e.preventDefault(),It(o[a].char,o[a].index),i.classList.add("hidden"),s.value=""):"Escape"===e.key&&(i.classList.add("hidden"),s.value=""))}));const u=e=>{s.contains(e.target)||i.contains(e.target)||i.classList.add("hidden")};document.addEventListener("click",u),Ct.push((()=>document.removeEventListener("click",u))),i.addEventListener("click",(t=>{const n=t.target.closest(`.${e}_dropdown_item`);if(n){const e=parseInt(n.getAttribute("data-index")||"-1",10),t=o.find((t=>t.index===e));t&&(It(t.char,t.index),i.classList.add("hidden"),s.value="")}})),r.addEventListener("click",(t=>{const n=t.target;if(n.closest(`#${e}_char_clear`)){if(!St)return;return St.pipeline=ee(St.pipeline,null,null),St.historyLoaded=!1,void jt()}const s=n.closest(`.${e}_field_toggle`);if(s){const t=s.getAttribute("data-field"),n=r.querySelector(`#${e}_field_content_${t}`),i=s.querySelector("i");n&&i&&(n.classList.toggle("hidden"),i.classList.toggle("fa-chevron-right"),i.classList.toggle("fa-chevron-down"))}}))}());const c=wt.querySelector(`#${e}_pipeline_nav_container`);c&&(c.innerHTML=Le(St.pipeline.selectedStages,St.pipeline.stageStatus,St.activeStageView,!!St.pipeline.character),function(){if(!wt||!St)return;const t=wt.querySelector(`#${e}_pipeline_nav_container`);if(!t)return;t.addEventListener("change",(t=>{const n=t.target;if(n.classList.contains(`${e}_stage_checkbox`)){const e=n.getAttribute("data-stage");e&&St&&(St.pipeline=function(e,t){const n=new Set(e.selectedStages);n.has(t)?n.delete(t):n.add(t);const r=i.filter((e=>n.has(e)));return y("state","Stage toggled",{stage:t,selected:r}),Object.assign(Object.assign({},e),{selectedStages:r})}(St.pipeline,e),qt())}})),t.addEventListener("click",(t=>bt(this,void 0,void 0,(function*(){const n=t.target.closest(`.${e}_stage_btn`);if(n&&St){const e=n.getAttribute("data-stage");e&&(St.activeStageView=e,Dt(),Ht(),Vt(),qt())}t.target.closest(`#${e}_run_selected_btn`)&&Lt();t.target.closest(`#${e}_run_all_btn`)&&function(){bt(this,void 0,void 0,(function*(){St&&(St.pipeline.selectedStages=[...i],qt(),yield Lt())}))}();if(t.target.closest(`#${e}_reset_pipeline_btn`)&&St){const{Popup:e,POPUP_RESULT:t}=SillyTavern.getContext();if((yield e.show.confirm("Reset Pipeline?","This will clear all results and iteration history. Continue?"))!==t.AFFIRMATIVE)return;St.pipeline=function(e,t=!1){const n=Q();return t&&e.character&&(n.character=e.character,n.characterIndex=e.characterIndex),y("state","Pipeline reset",{keepCharacter:t,hasCharacter:!!n.character}),n}(St.pipeline,!0),St.historyLoaded=!0,jt()}}))))}());const l=wt.querySelector(`#${e}_stage_config_container`);l&&(l.innerHTML=function(t,n,r){var s,i,o,c;const l=P(t),u=k(t);let d=n.customPrompt;if(n.promptPresetId){const e=O(n.promptPresetId);e&&(d=e.prompt)}let p=n.customSchema;if(n.schemaPresetId){const e=T(n.schemaPresetId);e&&(p=JSON.stringify(e.schema,null,2))}let f="",m={valid:!0};n.useStructuredOutput&&p.trim()&&(m=F(p),f=m.valid?(null===(s=m.warnings)||void 0===s?void 0:s.length)?`<div class="${e}_schema_status warning"><i class="fa-solid fa-triangle-exclamation"></i> ${m.warnings.length} warning(s)</div>`:`<div class="${e}_schema_status success"><i class="fa-solid fa-circle-check"></i> Valid schema</div>`:`<div class="${e}_schema_status error"><i class="fa-solid fa-circle-xmark"></i> ${He(m.error||"Invalid schema")}</div>`);let g='<i class="fa-solid fa-microchip"></i> Select a character',h="";r&&(g=`<i class="fa-solid fa-microchip"></i> ~${r.tokens.toLocaleString()} tokens (${r.percentage}%)`,r.percentage>80?h="danger":r.percentage>50&&(h="warning"));const _=n.promptPresetId?(null===(i=O(n.promptPresetId))||void 0===i?void 0:i.prompt)!==d:d.trim().length>0,v=n.schemaPresetId?JSON.stringify(null===(o=T(n.schemaPresetId))||void 0===o?void 0:o.schema,null,2)!==p:p.trim().length>0,y=n.useStructuredOutput&&p.trim()&&((null===(c=m.warnings)||void 0===c?void 0:c.length)||!m.valid);return`\n    <div class="${e}_stage_config">\n      \x3c!-- Prompt Section --\x3e\n      <div class="${e}_config_group">\n        <div class="${e}_config_header">\n          <span class="${e}_config_label">Prompt</span>\n          <div class="${e}_config_header_actions">\n            <button\n              id="${e}_save_prompt_preset_btn"\n              class="${e}_icon_btn"\n              title="Save as Preset"\n              ${_?"":"disabled"}\n            >\n              <i class="fa-solid fa-floppy-disk"></i>\n            </button>\n            <select id="${e}_prompt_preset_select" class="${e}_preset_select">\n              <option value="">Custom</option>\n              ${Me(l,n.promptPresetId)}\n            </select>\n          </div>\n        </div>\n        <textarea\n          id="${e}_custom_prompt"\n          class="${e}_prompt_textarea text_pole"\n          placeholder="Enter your prompt for the ${a[t]} stage..."\n        >${He(d)}</textarea>\n        <div class="${e}_config_footer">\n          <span class="${e}_char_count">${d.length.toLocaleString()} chars</span>\n        </div>\n      </div>\n\n      \x3c!-- Structured Output Toggle --\x3e\n      <div class="${e}_config_group">\n        <label class="${e}_checkbox_label">\n          <input\n            type="checkbox"\n            id="${e}_use_structured"\n            ${n.useStructuredOutput?"checked":""}\n          >\n          <span>Use Structured Output (JSON Schema)</span>\n        </label>\n      </div>\n\n      \x3c!-- Schema Section --\x3e\n      <div class="${e}_schema_section ${n.useStructuredOutput?"":"hidden"}">\n        <div class="${e}_config_header">\n          <span class="${e}_config_label">JSON Schema</span>\n          <div class="${e}_config_header_actions">\n            <button\n              id="${e}_save_schema_preset_btn"\n              class="${e}_icon_btn"\n              title="Save as Preset"\n              ${v&&p.trim()?"":"disabled"}\n            >\n              <i class="fa-solid fa-floppy-disk"></i>\n            </button>\n            <select id="${e}_schema_preset_select" class="${e}_preset_select">\n              <option value="">Custom</option>\n              ${Me(u,n.schemaPresetId)}\n            </select>\n          </div>\n        </div>\n        <textarea\n          id="${e}_custom_schema"\n          class="${e}_schema_textarea text_pole"\n          placeholder='{"name": "MySchema", "value": {"type": "object", ...}}'\n        >${He(p)}</textarea>\n        ${f}\n\n        \x3c!-- Schema Actions --\x3e\n        <div class="${e}_schema_actions">\n          <button\n            id="${e}_generate_schema_btn"\n            class="menu_button menu_button_icon"\n            title="Generate schema from description"\n          >\n            <i class="fa-solid fa-wand-magic-sparkles"></i>\n            <span>Generate</span>\n          </button>\n          <button\n            id="${e}_validate_schema_btn"\n            class="menu_button menu_button_icon"\n            title="Validate schema"\n            ${p.trim()?"":"disabled"}\n          >\n            <i class="fa-solid fa-check-double"></i>\n            <span>Validate</span>\n          </button>\n          <button\n            id="${e}_fix_schema_btn"\n            class="menu_button menu_button_icon"\n            title="Auto-fix schema (adds additionalProperties: false, etc.)"\n            ${y?"":"disabled"}\n          >\n            <i class="fa-solid fa-wrench"></i>\n            <span>Auto-Fix</span>\n          </button>\n          <button\n            id="${e}_format_schema_btn"\n            class="menu_button menu_button_icon"\n            title="Format/prettify JSON"\n            ${p.trim()?"":"disabled"}\n          >\n            <i class="fa-solid fa-align-left"></i>\n            <span>Format</span>\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Actions --\x3e\n      <div class="${e}_config_actions">\n        <div id="${e}_token_estimate" class="${e}_token_estimate ${h}">\n          ${g}\n        </div>\n      </div>\n    </div>\n  `}(St.activeStageView,St.pipeline.configs[St.activeStageView],null),function(){if(!wt||!St)return;const t=wt.querySelector(`#${e}_stage_config_container`);if(!t)return;t.addEventListener("change",(t=>{const n=t.target;if(n.id===`${e}_prompt_preset_select`&&St){const e=n.value||null;St.pipeline=se(St.pipeline,St.activeStageView,{promptPresetId:e}),Mt(),Vt()}if(n.id===`${e}_schema_preset_select`&&St){const e=n.value||null;St.pipeline=se(St.pipeline,St.activeStageView,{schemaPresetId:e}),Mt()}}));const{lodash:n}=SillyTavern.libs,r=n.debounce((t=>{const n=t.target;n.id===`${e}_custom_prompt`&&St&&(St.pipeline=se(St.pipeline,St.activeStageView,{customPrompt:n.value,promptPresetId:null}),Vt(),Mt()),n.id===`${e}_custom_schema`&&St&&(St.pipeline=se(St.pipeline,St.activeStageView,{customSchema:n.value,schemaPresetId:null}),Mt())}),300);St.debouncedFunctions.push(r),t.addEventListener("input",r),t.addEventListener("change",(t=>{const n=t.target;n.id===`${e}_use_structured`&&St&&(St.pipeline=se(St.pipeline,St.activeStageView,{useStructuredOutput:n.checked}),Mt())})),t.addEventListener("click",(t=>bt(this,void 0,void 0,(function*(){const n=t.target;if(n.closest(`#${e}_run_stage_btn`)&&St)return void Rt(St.activeStageView);if(n.closest(`#${e}_save_prompt_preset_btn`)&&St){const t=null==wt?void 0:wt.querySelector(`#${e}_custom_prompt`);if(t){const e=yield function(e,t){return je(this,void 0,void 0,(function*(){const{Popup:n,POPUP_RESULT:r}=SillyTavern.getContext();if(!t.trim())return toastr.warning("No prompt content to save"),{success:!1};const s=yield n.show.input("Save Prompt Preset","Enter a name for this preset:",`Custom ${a[e]} Prompt`);if(null===s||s===r.CANCELLED)return{success:!1};if(!s.trim())return toastr.warning("Preset name cannot be empty"),{success:!1};try{const n=A({name:s.trim(),prompt:t,stages:[e]});return toastr.success(`Prompt preset "${s}" saved`),{success:!0,presetId:n.id}}catch(e){return toastr.error(`Failed to save preset: ${e.message}`),{success:!1}}}))}(St.activeStageView,t.value);e.success&&e.presetId&&(St.pipeline=se(St.pipeline,St.activeStageView,{promptPresetId:e.presetId,customPrompt:""}),Mt())}return}if(n.closest(`#${e}_save_schema_preset_btn`)&&St){const t=null==wt?void 0:wt.querySelector(`#${e}_custom_schema`);if(t){const e=yield function(e,t){return je(this,void 0,void 0,(function*(){const{Popup:n,POPUP_RESULT:r}=SillyTavern.getContext();if(!t.trim())return toastr.warning("No schema content to save"),{success:!1};const s=F(t);if(!s.valid)return toastr.error(`Invalid schema: ${s.error}`),{success:!1};const i=yield n.show.input("Save Schema Preset","Enter a name for this preset:",`Custom ${a[e]} Schema`);if(null===i||i===r.CANCELLED)return{success:!1};if(!i.trim())return toastr.warning("Preset name cannot be empty"),{success:!1};try{const t=I({name:i.trim(),schema:s.schema,stages:[e]});return toastr.success(`Schema preset "${i}" saved`),{success:!0,presetId:t.id}}catch(e){return toastr.error(`Failed to save preset: ${e.message}`),{success:!1}}}))}(St.activeStageView,t.value);e.success&&e.presetId&&(St.pipeline=se(St.pipeline,St.activeStageView,{schemaPresetId:e.presetId,customSchema:""}),Mt())}return}if(n.closest(`#${e}_generate_schema_btn`)&&St){const t=yield Ne();if(t){const n=null==wt?void 0:wt.querySelector(`#${e}_custom_schema`);n&&(n.value=t,St.pipeline=se(St.pipeline,St.activeStageView,{customSchema:t,schemaPresetId:null}),Mt())}return}if(n.closest(`#${e}_validate_schema_btn`)&&St){const t=null==wt?void 0:wt.querySelector(`#${e}_custom_schema`);return void(t&&(yield function(e){return je(this,void 0,void 0,(function*(){var t,n;if(!e.trim())return void toastr.warning("No schema to validate");const r=F(e);if(!r.valid)return void toastr.error(`Invalid: ${r.error}`);const{Popup:s,POPUP_TYPE:i}=SillyTavern.getContext();if(null===(t=r.warnings)||void 0===t?void 0:t.length)if(r.warnings.length>2){const e=`\n                <h3>Schema Valid with Warnings</h3>\n                <ul>\n                    ${r.warnings.map((e=>`<li>${e}</li>`)).join("")}\n                </ul>\n            `;yield new s(e,i.TEXT,"",{wide:!1}).show()}else toastr.warning(`Valid with ${r.warnings.length} warning(s):\n${r.warnings.join("\n")}`);else if(null===(n=r.info)||void 0===n?void 0:n.length)if(r.info.length>2){const e=`\n                <h3>Schema Valid</h3>\n                <ul>\n                    ${r.info.map((e=>`<li>${e}</li>`)).join("")}\n                </ul>\n            `;yield new s(e,i.TEXT,"",{wide:!1}).show()}else toastr.success(`Valid!\n${r.info.join("\n")}`);else toastr.success("Schema is valid!")}))}(t.value)))}if(n.closest(`#${e}_fix_schema_btn`)&&St){const t=null==wt?void 0:wt.querySelector(`#${e}_custom_schema`);if(t){const e=function(e){var t;if(!e.trim())return toastr.warning("No schema to fix"),null;const n=F(e);if(!n.schema)return toastr.error("Cannot fix: schema is not valid JSON or missing required structure"),null;try{const e=B(n.schema),r=JSON.stringify(e,null,2),s=F(r);return s.valid?(null===(t=s.warnings)||void 0===t?void 0:t.length)?toastr.info(`Fixed! ${s.warnings.length} warning(s) remain`):toastr.success("Schema fixed successfully!"):toastr.warning("Auto-fix applied but schema still has issues"),r}catch(e){return toastr.error(`Fix failed: ${e.message}`),null}}(t.value);e&&(t.value=e,St.pipeline=se(St.pipeline,St.activeStageView,{customSchema:e,schemaPresetId:null}),Mt())}return}if(n.closest(`#${e}_format_schema_btn`)&&St){const t=null==wt?void 0:wt.querySelector(`#${e}_custom_schema`);if(t){const e=function(e){if(!e.trim())return toastr.warning("No schema to format"),null;try{const t=JSON.parse(e),n=JSON.stringify(t,null,2);return toastr.success("Schema formatted"),n}catch(e){return toastr.error(`Cannot format: ${e.message}`),null}}(t.value);e&&(t.value=e,St.pipeline=se(St.pipeline,St.activeStageView,{customSchema:e,schemaPresetId:null}),Mt())}}else;}))))}());const u=wt.querySelector(`#${e}_results_container`);u&&(u.innerHTML=(d=St.activeStageView,p=St.pipeline.results[St.activeStageView],f=St.pipeline.stageStatus[St.activeStageView],St.isGenerating&&"running"===f?tt(d):p?rt(d,p):nt(d,f)),function(){if(!wt||!St)return;const t=wt.querySelector(`#${e}_results_container`);if(!t)return;t.addEventListener("click",(t=>bt(this,void 0,void 0,(function*(){const n=t.target;if(n.closest(`#${e}_regenerate_btn`)&&St&&(St.pipeline=function(e,t){return y("state","Stage result cleared",{stage:t}),Object.assign(Object.assign({},e),{results:Object.assign(Object.assign({},e.results),{[t]:null}),stageStatus:Object.assign(Object.assign({},e.stageStatus),{[t]:"pending"})})}(St.pipeline,St.activeStageView),Rt(St.activeStageView)),n.closest(`#${e}_lock_btn`)&&St&&(St.pipeline=function(e,t){const n=e.results[t];return n?(y("state","Stage locked",{stage:t}),Object.assign(Object.assign({},e),{results:Object.assign(Object.assign({},e.results),{[t]:Object.assign(Object.assign({},n),{locked:!0})})})):e}(St.pipeline,St.activeStageView),Ht()),n.closest(`#${e}_unlock_btn`)&&St&&(St.pipeline=function(e,t){const n=e.results[t];return n?(y("state","Stage unlocked",{stage:t}),Object.assign(Object.assign({},e),{results:Object.assign(Object.assign({},e.results),{[t]:Object.assign(Object.assign({},n),{locked:!1})})})):e}(St.pipeline,St.activeStageView),Ht()),n.closest(`#${e}_continue_btn`)&&St){const e=ue(St.pipeline,St.activeStageView);e&&(St.activeStageView=e,Dt(),Ht(),Vt())}var r;if(n.closest(`#${e}_apply_btn`)&&St&&(yield function(){return bt(this,void 0,void 0,(function*(){if(!St||!St.pipeline.results.rewrite||!St.pipeline.character)return void toastr.warning("No rewrite to apply");const{Popup:t,POPUP_TYPE:n,POPUP_RESULT:r}=SillyTavern.getContext(),{DOMPurify:i}=SillyTavern.libs,a=ce(St.pipeline.results.rewrite.response);let o=`<div class="${e}_apply_preview">`;if(o+=`<p><strong>Parse method:</strong> ${a.parseMethod}</p>`,0===a.fields.length)o+=`<p class="${e}_apply_warning">\n            <i class="fa-solid fa-triangle-exclamation"></i>\n            No recognized character fields found in the rewrite output.\n            The raw content will be copied to clipboard instead.\n        </p>`,o+=`<details><summary>Raw content preview</summary><pre>${i.sanitize(a.raw.substring(0,500))}...</pre></details>`;else{o+=`<p><strong>Fields to update (${a.fields.length}):</strong></p>`,o+="<ul>";for(const e of a.fields){const t=e.value.substring(0,100);o+=`<li><strong>${i.sanitize(e.label)}:</strong> ${i.sanitize(t)}${e.value.length>100?"...":""}</li>`}o+="</ul>"}o+="</div>";const c=new t(`\n        <h3>Apply Rewrite to Character?</h3>\n        <p>This will update <strong>${i.sanitize(St.pipeline.character.name)}</strong> with the rewritten content.</p>\n        ${o}\n    `,n.CONFIRM,"",{wide:!0,okButton:a.fields.length>0?"Apply Changes":"Copy Raw Content",cancelButton:"Cancel"});if((yield c.show())!==r.AFFIRMATIVE)return;if(0===a.fields.length)return navigator.clipboard.writeText(a.raw),void toastr.info("Raw content copied to clipboard");const l=yield function(e,t){return Z(this,void 0,void 0,(function*(){if(!e.character||null===e.characterIndex)return{success:!1,error:"No character selected",updatedFields:[]};const{characters:n,unshallowCharacter:r,getRequestHeaders:i}=SillyTavern.getContext();try{yield r(e.characterIndex);const a=n[e.characterIndex];if(!a)return{success:!1,error:"Character not found after unshallow",updatedFields:[]};const o={},c=[];for(const e of t)s.find((t=>t.key===e.key))&&e.value.trim()&&(o[e.key]=e.value.trim(),c.push(e.label));if(0===c.length)return{success:!1,error:"No valid fields to update",updatedFields:[]};Object.assign(a,o);const l=yield fetch("/api/characters/edit",{method:"POST",headers:i(),body:JSON.stringify(Object.assign({avatar_url:a.avatar},a))});if(!l.ok){const e=yield l.text();return $("Failed to save character",{status:l.status,error:e}),{success:!1,error:`Save failed: ${l.status}`,updatedFields:[]}}return y("info","Character updated successfully",{name:a.name,updatedFields:c}),{success:!0,updatedFields:c}}catch(e){return $("Error applying rewrite to character",e),{success:!1,error:e.message,updatedFields:[]}}}))}(St.pipeline,a.fields);if(l.success){toastr.success(`Updated ${l.updatedFields.length} fields: ${l.updatedFields.join(", ")}`);const{eventSource:e}=SillyTavern.getContext();yield e.emit("character_tools_rewrite_applied",{characterName:St.pipeline.character.name,characterIndex:St.pipeline.characterIndex,updatedFields:l.updatedFields,iterationCount:St.pipeline.iterationCount}),Pt()}else toastr.error(l.error||"Failed to apply changes")}))}()),n.closest(`#${e}_refine_btn`)&&St&&function(){bt(this,void 0,void 0,(function*(){if(!St||St.isGenerating||St.isRefining)return;if(!ye())return void toastr.error("API is not connected");const t=re(St.pipeline);if(!t.canRun)return void toastr.warning(t.reason||"Cannot refine");const n=function(e){const t=[],n=[];e.character||t.push("No character selected"),e.results.rewrite||t.push("No rewrite to refine"),e.results.analyze||t.push("Run analyze first to identify issues");const{onlineStatus:r}=SillyTavern.getContext();"Valid"!==r&&"Connected"!==r&&t.push("API is not connected");const s=e.iterationHistory.length>0?e.iterationHistory[e.iterationHistory.length-1]:null;return"accept"===(null==s?void 0:s.verdict)&&n.push("Last analysis suggested accepting the rewrite"),e.iterationCount>=5&&n.push(`Already at iteration ${e.iterationCount+1} - consider accepting or starting fresh`),{valid:0===t.length,errors:t,warnings:n}}(St.pipeline);if(!n.valid)return void toastr.error(n.errors.join("\n"));n.warnings.length>0&&toastr.warning(n.warnings.join("\n"));const r={iterationCount:St.pipeline.iterationCount,iterationHistory:[...St.pipeline.iterationHistory]};St.pipeline=oe(St.pipeline),St.isRefining=!0,St.abortController=new AbortController;const s=null==wt?void 0:wt.querySelector(`#${e}_results_container`);var i;s&&(s.innerHTML=(i=St.pipeline.iterationCount,`\n    <div class="${e}_results_loading">\n      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>\n      <p>Refining (Iteration #${i+1})...</p>\n      <button id="${e}_cancel_btn" class="menu_button">\n        <i class="fa-solid fa-stop"></i>\n        <span>Cancel</span>\n      </button>\n    </div>\n  `)),Ft(),zt();try{const e=yield function(e,t){return _e(this,void 0,void 0,(function*(){const n=SillyTavern.getContext(),r=w();if(null==t?void 0:t.aborted)return{success:!1,error:"Generation cancelled"};if(!e.character)return{success:!1,error:"No character selected"};if(!e.results.rewrite||!e.results.analyze)return{success:!1,error:"Refinement requires both rewrite and analyze results"};if(!ye())return $("API not ready",{onlineStatus:n.onlineStatus}),{success:!1,error:"API is not connected. Check your connection settings."};const s=fe(e);if(!s)return{success:!1,error:"Failed to build refinement prompt"};const i=Ce(s,e.character.name,n.name1||"User");return y("info","Starting refinement generation",{iteration:e.iterationCount+1,character:e.character.name,promptLength:i.length}),yield Se(r.systemPrompt,i,null,t,r.useCurrentSettings)}))}(St.pipeline,St.abortController.signal);e.success?(St.pipeline=function(e,t){const n=Object.assign(Object.assign({},t),{timestamp:Date.now(),locked:!1});return y("state","Refinement completed",{iteration:e.iterationCount,responseLength:t.response.length}),Object.assign(Object.assign({},e),{currentStage:null,results:Object.assign(Object.assign({},e.results),{rewrite:n}),stageStatus:Object.assign(Object.assign({},e.stageStatus),{rewrite:"complete",analyze:"pending"})})}(St.pipeline,{response:e.response,isStructured:!1,promptUsed:"[Refinement prompt]",schemaUsed:null}),toastr.success(`Refinement #${St.pipeline.iterationCount} complete`),St.pipeline.character&&(yield $t(St.pipeline.character,St.pipeline.iterationHistory)),St.activeStageView="analyze"):(St.pipeline=Object.assign(Object.assign({},St.pipeline),{iterationCount:r.iterationCount,iterationHistory:r.iterationHistory}),"Generation cancelled"!==e.error&&toastr.error(e.error))}catch(e){St.pipeline=Object.assign(Object.assign({},St.pipeline),{iterationCount:r.iterationCount,iterationHistory:r.iterationHistory}),toastr.error(e.message)}finally{St.isRefining=!1,St.abortController=null,jt()}}))}(),n.closest(`#${e}_accept_btn`)&&St&&(St.pipeline=(r=St.pipeline).results.rewrite?(y("state","Rewrite accepted as final",{iteration:r.iterationCount}),Object.assign(Object.assign({},r),{results:Object.assign(Object.assign({},r.results),{rewrite:Object.assign(Object.assign({},r.results.rewrite),{locked:!0})}),isRefining:!1})):r,toastr.success("Rewrite accepted as final"),jt()),n.closest(`#${e}_copy_btn`)&&St){const e=St.pipeline.results[St.activeStageView];e&&(navigator.clipboard.writeText(e.response),toastr.success("Copied to clipboard"))}n.closest(`#${e}_export_btn`)&&St&&(St.pipeline=he(St.pipeline),St.pipeline.exportData&&(navigator.clipboard.writeText(St.pipeline.exportData),toastr.success("Export copied to clipboard"))),n.closest(`#${e}_cancel_btn`)&&(null==St?void 0:St.abortController)&&St.abortController.abort()}))))}());var d,p,f;const m=wt.querySelector(`#${e}_iteration_history_container`);m&&(m.innerHTML=it(St.pipeline.iterationHistory,St.pipeline.iterationCount,St.historyLoaded),function(){if(!wt||!St)return;const t=wt.querySelector(`#${e}_iteration_history_container`);if(!t)return;t.addEventListener("click",(t=>bt(this,void 0,void 0,(function*(){const n=t.target,r=n.closest(`.${e}_iteration_revert_btn`);if(r&&St){const e=parseInt(r.getAttribute("data-index")||"-1",10);e>=0&&(yield function(e){return bt(this,void 0,void 0,(function*(){if(!St)return;const{Popup:t,POPUP_RESULT:n}=SillyTavern.getContext();(yield t.show.confirm("Revert to Previous Iteration?",`This will restore the rewrite from iteration #${e+1} and discard later changes.`))===n.AFFIRMATIVE&&(St.pipeline=function(e,t){if(t<0||t>=e.iterationHistory.length)return $("Invalid iteration index",{iterationIndex:t,historyLength:e.iterationHistory.length}),e;const n=e.iterationHistory[t];y("state","Reverting to iteration",{iteration:n.iteration});const r={response:n.rewriteResponse,isStructured:!1,promptUsed:"[Restored from iteration history]",schemaUsed:null,timestamp:Date.now(),locked:!1},s=e.iterationHistory.slice(0,t);return Object.assign(Object.assign({},e),{results:Object.assign(Object.assign({},e.results),{rewrite:r,analyze:null}),stageStatus:Object.assign(Object.assign({},e.stageStatus),{rewrite:"complete",analyze:"pending"}),iterationCount:n.iteration,iterationHistory:s,isRefining:!0})}(St.pipeline,e),toastr.info(`Reverted to iteration #${e+1}`),St.pipeline.character&&(yield $t(St.pipeline.character,St.pipeline.iterationHistory)),jt())}))}(e))}const s=n.closest(`.${e}_iteration_view_btn`);if(s&&St){const t=parseInt(s.getAttribute("data-index")||"-1",10);t>=0&&t<St.pipeline.iterationHistory.length&&function(t){bt(this,void 0,void 0,(function*(){const{Popup:n,POPUP_TYPE:r}=SillyTavern.getContext(),{DOMPurify:s}=SillyTavern.libs,i=function(t){const{moment:n}=SillyTavern.libs;return`\n    <div class="${e}_iteration_view">\n      <div class="${e}_iteration_view_header">\n        <h3>Iteration #${t.iteration+1}</h3>\n        <span class="${e}_iteration_verdict ${ct(t.verdict)}">\n          <i class="fa-solid ${ot(t.verdict)}"></i>\n          ${lt(t.verdict)}\n        </span>\n        <span class="${e}_iteration_time">${n(t.timestamp).format("YYYY-MM-DD HH:mm:ss")}</span>\n      </div>\n\n      <div class="${e}_iteration_view_section">\n        <h4>Rewrite</h4>\n        <div class="${e}_iteration_view_content">\n          ${ut(t.rewriteResponse)}\n        </div>\n      </div>\n\n      <div class="${e}_iteration_view_section">\n        <h4>Analysis</h4>\n        <div class="${e}_iteration_view_content">\n          ${ut(t.analysisResponse)}\n        </div>\n      </div>\n    </div>\n  `}(t),a=new n(s.sanitize(i),r.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:"Close",cancelButton:!1});yield a.show()}))}(St.pipeline.iterationHistory[t])}}))))}());null===(n=wt.querySelector(`#${e}_settings_btn`))||void 0===n||n.addEventListener("click",(()=>{pt((()=>{St&&function(){if(!St)return;for(const e of i){const t=St.pipeline.configs[e];t.promptPresetId&&!O(t.promptPresetId)&&(y("info","Clearing deleted prompt preset reference",{stage:e,presetId:t.promptPresetId}),St.pipeline=se(St.pipeline,e,{promptPresetId:null})),t.schemaPresetId&&!T(t.schemaPresetId)&&(y("info","Clearing deleted schema preset reference",{stage:e,presetId:t.schemaPresetId}),St.pipeline=se(St.pipeline,e,{schemaPresetId:null}))}}(),jt()}))})),null===(r=wt.querySelector(`#${e}_close_btn`))||void 0===r||r.addEventListener("click",(()=>{const e=null==wt?void 0:wt.closest(".popup");if(e){const t=e.querySelector(".popup-button-cancel, .popup-button-ok");null==t||t.click()}}))}(u),jt(),y("info","Popup opened",{characterCount:u.length})}))}let Tt=!1;function It(t,n){return bt(this,void 0,void 0,(function*(){if(!St)return;const r=n;St.pipeline=ee(St.pipeline,t,n),St.historyLoaded=!1,jt();const s=yield function(e){return vt(this,void 0,void 0,(function*(){const{localforage:t}=SillyTavern.libs,n=yt(e);try{const r=yield t.getItem(n);return r?r.characterName!==e.name||r.characterAvatar!==e.avatar?(y("info","Iteration history mismatch, ignoring",{key:n,storedName:r.characterName,currentName:e.name}),null):(y("info","Iteration history loaded",{key:n,characterName:e.name,historyLength:r.history.length,savedAt:new Date(r.savedAt).toISOString()}),r.history):(y("info","No iteration history found",{key:n}),null)}catch(e){return $("Failed to load iteration history",{key:n,error:e}),null}}))}(t);St&&St.pipeline.characterIndex===r&&(s&&s.length>0&&(St.pipeline=Object.assign(Object.assign({},St.pipeline),{iterationHistory:s,iterationCount:s.length}),y("info","Loaded iteration history",{count:s.length})),St.historyLoaded=!0,zt()),setTimeout((()=>bt(this,void 0,void 0,(function*(){if(!wt||!(null==St?void 0:St.pipeline.character))return;if(St.pipeline.characterIndex!==r)return;const t=wt.querySelector(`#${e}_character_select_container`);if(t){const e=Re(St.pipeline.character);yield ke(t,e)}}))),50),y("info","Character selected",{name:t.name,index:n})}))}function Rt(e){return bt(this,void 0,void 0,(function*(){if(!St||St.isGenerating||St.isRefining)return;if(!ye())return void toastr.error("API is not connected");const t=function(e,t){var n;if(!e.character)return{canRun:!1,reason:"No character selected"};switch(t){case"score":return{canRun:!0};case"rewrite":return e.selectedStages.includes("score")&&!(null===(n=e.results.score)||void 0===n?void 0:n.locked)?{canRun:!0,reason:"Score stage not complete - rewrite will run without score feedback"}:{canRun:!0};case"analyze":return e.results.rewrite?{canRun:!0}:{canRun:!1,reason:"Analyze requires rewrite results to compare"};default:return{canRun:!1,reason:"Unknown stage"}}}(St.pipeline,e);if(!t.canRun)return void toastr.warning(t.reason||"Cannot run this stage");t.reason&&toastr.info(t.reason),St.isGenerating=!0,St.abortController=new AbortController,St.pipeline=function(e,t){return y("state","Stage started",{stage:t}),Object.assign(Object.assign({},e),{currentStage:t,stageStatus:Object.assign(Object.assign({},e.stageStatus),{[t]:"running"})})}(St.pipeline,e),jt();const n=pe(St.pipeline,e)||"",r=ge(St.pipeline,e);try{const t=yield be(St.pipeline,e,St.abortController.signal);t.success?(St.pipeline=function(e,t,n){const r=Object.assign(Object.assign({},n),{timestamp:Date.now(),locked:!1});y("state","Stage completed",{stage:t,responseLength:n.response.length,isStructured:n.isStructured});const s="analyze"===t&&null!==e.results.rewrite;return Object.assign(Object.assign({},e),{currentStage:null,stageStatus:Object.assign(Object.assign({},e.stageStatus),{[t]:"complete"}),results:Object.assign(Object.assign({},e.results),{[t]:r}),isRefining:s})}(St.pipeline,e,{response:t.response,isStructured:t.isStructured,promptUsed:n,schemaUsed:r}),toastr.success(`${a[e]} complete`)):(St.pipeline=ie(St.pipeline,e,t.error),"Generation cancelled"!==t.error&&toastr.error(t.error))}catch(t){St.pipeline=ie(St.pipeline,e,t.message),toastr.error(t.message)}finally{St.isGenerating=!1,St.abortController=null,jt()}}))}function Lt(){return bt(this,void 0,void 0,(function*(){if(!St||St.isGenerating||St.isRefining)return;if(!ye())return void toastr.error("API is not connected");const e=function(e){const t=[],n=[];e.character||t.push("No character selected"),0===e.selectedStages.length&&t.push("No stages selected");for(const r of e.selectedStages)W(e.configs[r]).trim()||t.push(`${r}: No prompt configured`),"rewrite"===r&&!e.results.score&&e.selectedStages.includes("score")&&n.push("Rewrite will run without score feedback (score not complete)"),"analyze"!==r||e.results.rewrite||t.push("Analyze requires rewrite results");const{onlineStatus:r}=SillyTavern.getContext();return"Valid"!==r&&"Connected"!==r&&t.push("API is not connected"),{valid:0===t.length,errors:t,warnings:n}}(St.pipeline);if(e.valid){e.warnings.length>0&&toastr.warning(e.warnings.join("\n"));for(const e of St.pipeline.selectedStages){const t=St.pipeline.stageStatus[e];if("complete"===t||"skipped"===t)continue;if(St.activeStageView=e,Dt(),yield Rt(e),!St)break;if("complete"!==St.pipeline.stageStatus[e])break}}else toastr.error(e.errors.join("\n"))}))}function jt(){Nt(),qt(),Dt(),Ht(),Vt(),Ft(),zt()}function Nt(){if(!wt||!St)return;const t=wt.querySelector(`#${e}_character_select_container`);t&&function(t,n,r){const s=t.querySelector(`.${e}_search_wrapper`),i=t.querySelector(`#${e}_char_preview`);if(n){if(null==s||s.classList.add("hidden"),!i){const r=Ae(n),s=t.querySelector(`.${e}_search_wrapper`);s&&s.insertAdjacentHTML("afterend",r)}}else{null==s||s.classList.remove("hidden"),null==i||i.remove();const n=t.querySelector(`#${e}_char_search`);n&&(n.value="")}}(t,St.pipeline.character,St.pipeline.characterIndex)}function qt(){if(!wt||!St)return;const t=wt.querySelector(`#${e}_pipeline_nav_container`);t&&function(t,n,r,s,a,o){for(const a of i){const i=t.querySelector(`#${e}_stage_cb_${a}`),o=t.querySelector(`.${e}_stage_btn[data-stage="${a}"]`),c=t.querySelector(`.${e}_stage_node:has([data-stage="${a}"])`);if(i&&(i.checked=n.includes(a)),o&&o.classList.toggle("active",a===s),c){c.classList.toggle("active",a===s);for(const t of["pending","running","complete","skipped"])c.classList.toggle(`${e}_stage_${t}`,r[a]===t)}const l=null==c?void 0:c.querySelector(`.${e}_stage_connector`);null==l||l.classList.toggle("active",n.includes(a))}const c=t.querySelector(`#${e}_run_selected_btn`),l=t.querySelector(`#${e}_run_all_btn`),u=t.querySelector(`#${e}_reset_pipeline_btn`);c&&(c.disabled=!a||o),l&&(l.disabled=!a||o),u&&(u.disabled=o)}(t,St.pipeline.selectedStages,St.pipeline.stageStatus,St.activeStageView,!!St.pipeline.character&&ye(),St.isGenerating||St.isRefining)}function Dt(){if(!wt||!St)return;const t=wt.querySelector(`#${e}_stage_icon`),n=wt.querySelector(`#${e}_stage_title`);t&&(t.className=`fa-solid ${o[St.activeStageView]}`),n&&(n.textContent=a[St.activeStageView]),Mt()}function Mt(){if(!wt||!St)return;const t=wt.querySelector(`#${e}_stage_config_container`);t&&De(t,St.activeStageView,St.pipeline.configs[St.activeStageView],St.isGenerating||St.isRefining)}function Ht(){if(!wt||!St)return;const t=wt.querySelector(`#${e}_results_container`);t&&st(t,St.activeStageView,St.pipeline.results[St.activeStageView],St.pipeline.stageStatus[St.activeStageView],St.isGenerating,ue(St.pipeline,St.activeStageView),St.pipeline)}function Ft(){if(!wt||!St)return;const t=wt.querySelector(`#${e}_iteration_indicator`);t&&(St.pipeline.iterationCount>0||St.pipeline.isRefining?(t.classList.remove("hidden"),t.innerHTML=`\n      <i class="fa-solid fa-arrows-rotate"></i>\n      Iteration #${St.pipeline.iterationCount+1}\n    `):t.classList.add("hidden"))}function zt(){if(!wt||!St)return;const t=wt.querySelector(`#${e}_iteration_history_container`);t&&function(t,n,r,s){const i=t.querySelector(`#${e}_iteration_history`);if(!i&&(n.length>0||r>0)){const e=it(n,r,s);t.insertAdjacentHTML("beforeend",e)}else if(i){const t=i.querySelector(`.${e}_iteration_count`);t&&(t.textContent=r>0?`Current: #${r+1}`:"Initial");const a=i.querySelector(`.${e}_iteration_list`);a&&(s?0===n.length?a.innerHTML=`<div class="${e}_iteration_empty">No previous iterations</div>`:a.innerHTML=n.map(((e,t)=>at(e,t))).join(""):a.innerHTML=`<div class="${e}_iteration_loading">\n                    <i class="fa-solid fa-spinner fa-spin"></i>\n                    <span>Loading history...</span>\n                </div>`)}}(t,St.pipeline.iterationHistory,St.pipeline.iterationCount,St.historyLoaded)}function Vt(){return bt(this,void 0,void 0,(function*(){if(!wt||!St)return;const t=wt.querySelector(`#${e}_token_estimate`);if(!t)return;if(!St.pipeline.character)return t.innerHTML='<i class="fa-solid fa-microchip"></i> Select a character',void(t.className=`${e}_token_estimate`);let n;if(t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>',t.className=`${e}_token_estimate`,n=St.pipeline.isRefining&&St.pipeline.results.rewrite&&St.pipeline.results.analyze?yield function(e){return _e(this,void 0,void 0,(function*(){const{getTokenCountAsync:t,maxContext:n}=SillyTavern.getContext(),r=w();if(!e.character||!e.results.rewrite||!e.results.analyze)return null;try{const s=fe(e);if(!s)return null;const i=r.systemPrompt+"\n\n"+s,a=yield t(i);return{promptTokens:a,contextSize:n,percentage:Math.round(a/n*100)}}catch(e){return $("Refinement token count failed",e),null}}))}(St.pipeline):yield function(e,t){return _e(this,void 0,void 0,(function*(){const{getTokenCountAsync:n,maxContext:r}=SillyTavern.getContext(),s=w();if(!e.character)return null;try{const i=pe(e,t);if(!i)return null;const a=s.systemPrompt+"\n\n"+i,o=yield n(a);return{promptTokens:o,contextSize:r,percentage:Math.round(o/r*100)}}catch(e){return $("Token count failed",e),null}}))}(St.pipeline,St.activeStageView),!St||!wt)return;if(!n)return t.innerHTML='<i class="fa-solid fa-microchip"></i> --',void(t.className=`${e}_token_estimate`);let r="";n.percentage>100?r="danger":n.percentage>80&&(r="warning"),t.innerHTML=`<i class="fa-solid fa-microchip"></i> ${n.promptTokens.toLocaleString()}t (${n.percentage}%)`,t.className=`${e}_token_estimate ${r}`}))}var Ut=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};function Gt(){return Ut(this,void 0,void 0,(function*(){const{renderExtensionTemplateAsync:n}=SillyTavern.getContext(),r=document.getElementById("extensions_settings");if(r)try{const s=yield n(t,"templates/panel",{},!0),i=document.createElement("div");i.id=`${e}_wrapper`,i.innerHTML=s,r.appendChild(i),function(){const t=document.getElementById(`${e}_open_btn`);null==t||t.addEventListener("click",(()=>{kt()}));const n=document.getElementById(`${e}_debug_toggle`);n&&(n.checked=w().debugMode,n.addEventListener("change",(()=>{E(n.checked),toastr.info("Debug mode "+(n.checked?"enabled":"disabled"))})))}(),y("info","Panel initialized",null)}catch(e){$("Failed to load panel template",e)}else $("Extensions container not found",null)}))}const{eventSource:Bt,eventTypes:Jt}=SillyTavern.getContext();Bt.on(Jt.APP_READY,(function(){try{y("info","Extension initializing",{version:r}),Gt(),function(){const{eventSource:e,eventTypes:t}=SillyTavern.getContext();e.on(t.CHATCOMPLETION_SOURCE_CHANGED,(()=>{y("info","Chat completion source changed",null)})),e.on(t.CHATCOMPLETION_MODEL_CHANGED,(()=>{y("info","Chat completion model changed",null)})),y("info","Event listeners registered",null)}(),y("info","Extension loaded",w())}catch(e){$("Extension initialization failed",e),toastr.error("Character Tools failed to initialize. Check console for details.")}}))})();
//# sourceMappingURL=index.js.map