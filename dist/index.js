(()=>{"use strict";const e="character_tools",t="third-party/my-extension",n=3,s=Object.freeze([{key:"description",label:"Description",scoreable:!0},{key:"personality",label:"Personality",scoreable:!0},{key:"first_mes",label:"First Message",scoreable:!0},{key:"scenario",label:"Scenario",scoreable:!0},{key:"mes_example",label:"Example Messages",scoreable:!0},{key:"system_prompt",label:"System Prompt",scoreable:!0},{key:"post_history_instructions",label:"Post-History Instructions",scoreable:!1},{key:"creator_notes",label:"Creator Notes",scoreable:!1}]),r=Object.freeze(["score","rewrite","analyze"]),i={score:"Score",rewrite:"Rewrite",analyze:"Analyze"},a={score:"fa-star-half-stroke",rewrite:"fa-pen-fancy",analyze:"fa-magnifying-glass-chart"},o="You are a creative writing assistant specializing in character development for roleplay and fiction. Analyze character cards and provide thoughtful, actionable feedback.\n\nAdapt your response style to the task:\n- For scoring: Be critical but fair, rate 1-10 with specific justifications\n- For rewrites: Preserve the character's core identity while improving weak areas\n- For analysis: Compare versions objectively, identify what was lost or gained\n- For refinement: Address specific issues from analysis while keeping improvements\n\nFocus on: writing quality, character depth, consistency, roleplay usability, and potential issues (contradictions, clichés, underdeveloped areas).\n\nAlways maintain the character's essential personality and unique traits. Improvements should enhance, not replace, what makes the character interesting.",c="You are refining a character card rewrite based on analysis feedback.\n\n## Original Character (Ground Truth)\n{{original_character}}\n\n## Current Rewrite (Iteration {{iteration_number}})\n{{current_rewrite}}\n\n## Analysis of Current Rewrite\n{{current_analysis}}\n\n{{#if score_results}}\n## Original Score Feedback (Reference)\n{{score_results}}\n{{/if}}\n\n---\n\n## Your Task\n\nCreate an improved version that:\n\n1. **Addresses Issues**: Fix the specific problems identified in the analysis\n2. **Preserves Wins**: Keep what the analysis said was working well\n3. **Maintains Soul**: The character must still feel like the original, just better\n4. **Avoids Regression**: Don't reintroduce problems that were already fixed\n\nOutput the complete refined character card with all fields. Mark significantly changed sections with [REFINED] at the start.\n\nDo NOT explain your changes - just output the improved character card.",l=Object.freeze([{id:"builtin_score_default",name:"Default Score",stages:["score"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Rate this character card on a scale of 1-10 for each populated field. For each field, provide:\n\n1. **Score** (1-10)\n2. **Strengths** - What works well\n3. **Weaknesses** - What needs improvement\n4. **Specific Suggestions** - Concrete changes to improve it\n\nAfter scoring all fields, provide:\n- **Overall Score** (weighted average, with First Message and Description weighted higher)\n- **Top 3 Priority Improvements** - The changes that would have the biggest impact\n- **Summary** - A brief overall assessment\n\nBe critical but constructive. Vague praise is useless. Specific, actionable feedback is gold."},{id:"builtin_score_quick",name:"Quick Score",stages:["score"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Give a quick assessment of this character card:\n\n1. Overall score (1-10)\n2. Three biggest strengths\n3. Three areas needing work\n4. One-sentence summary\n\nKeep it concise but useful."},{id:"builtin_rewrite_default",name:"Default Rewrite",stages:["rewrite"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Based on the scoring feedback, rewrite this character card to address the identified weaknesses while preserving its strengths.\n\nGuidelines:\n- Maintain the character's core personality and unique traits\n- Improve weak areas identified in the score\n- Keep the same general length unless brevity/expansion was specifically noted\n- Preserve any distinctive voice or style that works\n- Fix contradictions and fill gaps\n- Make the character more engaging for roleplay\n\nOutput the complete rewritten character card with all fields, using the same field structure as the original. Mark significantly changed sections with [REVISED] at the start.\n\n{{score_results}}"},{id:"builtin_rewrite_conservative",name:"Conservative Rewrite",stages:["rewrite"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Make minimal, surgical improvements to this character card. Only change what's clearly broken or weak.\n\nRules:\n- Change as little as possible\n- Preserve the author's voice completely\n- Only fix obvious issues (contradictions, grammar, clarity)\n- Do NOT add new content unless filling a critical gap\n- Do NOT change style or tone\n\nOutput only the fields you changed, with [ORIGINAL] and [REVISED] versions for comparison.\n\n{{score_results}}"},{id:"builtin_rewrite_expansive",name:"Expansive Rewrite",stages:["rewrite"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Significantly expand and enhance this character card. Add depth, detail, and richness.\n\nGoals:\n- Flesh out underdeveloped areas\n- Add sensory details and specific examples\n- Deepen personality with quirks, contradictions, history\n- Improve example messages with more variety\n- Make the character feel more three-dimensional\n\nDon't change the core concept, but make it shine. Output the complete expanded character card.\n\n{{score_results}}"},{id:"builtin_analyze_default",name:"Default Analyze",stages:["analyze"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:'Compare the original character card with the rewritten version. Analyze:\n\n## What Was Preserved\n- Core personality traits that remained intact\n- Distinctive elements that were kept\n- Voice and style consistency\n\n## What Was Lost\n- Any personality aspects that were diminished or removed\n- Unique quirks that disappeared\n- Tone shifts that changed the character\'s feel\n\n## What Was Gained\n- New depth or detail added\n- Improvements that enhance the character\n- Better clarity or consistency\n\n## Soul Check\nDoes the rewritten version still feel like the same character? Rate the "soul preservation" from 1-10 and explain.\n\n## Verdict\nState clearly: **ACCEPT** (ready to use), **NEEDS REFINEMENT** (good progress but has issues), or **REGRESSION** (worse than before).\n\n## Specific Issues to Address\nIf verdict is NEEDS REFINEMENT, list the specific problems that should be fixed in the next iteration.\n\n---\n\n### Original Character:\n{{original_character}}\n\n### Rewritten Version:\n{{rewrite_results}}\n\n### Score Feedback:\n{{score_results}}'},{id:"builtin_analyze_iteration",name:"Iteration Analyze",stages:["analyze"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"This is iteration {{iteration_number}} of refinement. Compare the current rewrite against the original.\n\n## Progress Check\n- What issues from previous analysis were addressed?\n- What new issues (if any) were introduced?\n- Is this version better, worse, or lateral move from the last?\n\n## Current State Assessment\n\n### Preserved from Original\nCore traits and elements that remain intact.\n\n### Still Missing or Lost\nThings from the original that should be restored.\n\n### Successfully Improved\nWhat's genuinely better now.\n\n### New Problems\nAny issues introduced by this iteration.\n\n## Soul Preservation Score\nRate 1-10: Does this still feel like the original character?\n\n## Verdict\n**ACCEPT** - Ready to use, no more iterations needed\n**NEEDS REFINEMENT** - Making progress, but specific issues remain\n**REGRESSION** - This iteration made things worse, consider reverting\n\n## Next Steps\nIf NEEDS REFINEMENT: List exactly what the next iteration should fix.\nIf REGRESSION: Explain what went wrong and what to preserve from previous version.\n\n---\n\n### Original Character:\n{{original_character}}\n\n### Current Rewrite (Iteration {{iteration_number}}):\n{{rewrite_results}}"},{id:"builtin_analyze_quick",name:"Quick Analyze",stages:["analyze"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Quick comparison of original vs rewrite:\n\n1. Soul preserved? (Yes/Partially/No)\n2. Best improvement made\n3. Biggest thing lost (if any)\n4. Verdict: ACCEPT / NEEDS REFINEMENT / REGRESSION\n\n{{original_character}}\n\n{{rewrite_results}}"},{id:"builtin_freeform",name:"Freeform",stages:[],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"[Enter your custom instructions here]"}]),u=Object.freeze([{id:"builtin_schema_score",name:"Default Score",stages:["score"],isBuiltin:!0,createdAt:0,updatedAt:0,schema:{name:"CharacterScore",strict:!0,value:{$schema:"http://json-schema.org/draft-04/schema#",type:"object",additionalProperties:!1,properties:{fieldScores:{type:"array",items:{type:"object",additionalProperties:!1,properties:{field:{type:"string"},score:{type:"number"},strengths:{type:"string"},weaknesses:{type:"string"},suggestions:{type:"string"}},required:["field","score","strengths","weaknesses","suggestions"]}},overallScore:{type:"number"},priorityImprovements:{type:"array",items:{type:"string"}},summary:{type:"string"}},required:["fieldScores","overallScore","priorityImprovements","summary"]}}},{id:"builtin_schema_quick_score",name:"Quick Score",stages:["score"],isBuiltin:!0,createdAt:0,updatedAt:0,schema:{name:"QuickScore",strict:!0,value:{$schema:"http://json-schema.org/draft-04/schema#",type:"object",additionalProperties:!1,properties:{overallScore:{type:"number"},strengths:{type:"array",items:{type:"string"}},weaknesses:{type:"array",items:{type:"string"}},summary:{type:"string"}},required:["overallScore","strengths","weaknesses","summary"]}}},{id:"builtin_schema_analyze",name:"Default Analyze",stages:["analyze"],isBuiltin:!0,createdAt:0,updatedAt:0,schema:{name:"CharacterAnalysis",strict:!0,value:{$schema:"http://json-schema.org/draft-04/schema#",type:"object",additionalProperties:!1,properties:{preserved:{type:"array",items:{type:"string"}},lost:{type:"array",items:{type:"string"}},gained:{type:"array",items:{type:"string"}},soulPreservationScore:{type:"number"},soulAssessment:{type:"string"},verdict:{type:"string",enum:["ACCEPT","NEEDS_REFINEMENT","REGRESSION"]},issuesToAddress:{type:"array",items:{type:"string"}},recommendations:{type:"array",items:{type:"string"}}},required:["preserved","lost","gained","soulPreservationScore","soulAssessment","verdict","issuesToAddress","recommendations"]}}}]),d={score:{promptPresetId:"builtin_score_default",customPrompt:"",schemaPresetId:"builtin_schema_score",customSchema:"",useStructuredOutput:!1},rewrite:{promptPresetId:"builtin_rewrite_default",customPrompt:"",schemaPresetId:null,customSchema:"",useStructuredOutput:!1},analyze:{promptPresetId:"builtin_analyze_default",customPrompt:"",schemaPresetId:"builtin_schema_analyze",customSchema:"",useStructuredOutput:!1}},p={source:"openrouter",model:"anthropic/claude-sonnet-4",temperature:1,maxTokens:4096,frequencyPenalty:0,presencePenalty:0,topP:1},f=Object.freeze({useCurrentSettings:!0,generationConfig:p,systemPrompt:o,promptPresets:[...l],schemaPresets:[...u],stageDefaults:d,refinementPrompt:c,debugMode:!1,settingsVersion:n}),m={ORIGINAL_CHARACTER:"{{original_character}}",SCORE_RESULTS:"{{score_results}}",REWRITE_RESULTS:"{{rewrite_results}}",CURRENT_REWRITE:"{{current_rewrite}}",CURRENT_ANALYSIS:"{{current_analysis}}",ITERATION_NUMBER:"{{iteration_number}}",CHARACTER_NAME:"{{char_name}}",USER_NAME:"{{user_name}}"},g=100,_=20;const h=[];function v(t,n,s){const r={timestamp:new Date,type:t,label:n,data:s};if(h.unshift(r),h.length>g&&h.pop(),function(){try{return $().debugMode}catch(e){return!1}}()){const r=`[${e}:${t.toUpperCase()}]`;switch(t){case"error":console.error(r,n,s);break;case"request":case"response":console.debug(r,n,s);break;default:console.log(r,n,s)}}}function y(){return JSON.stringify(function(){var e,t,n,s,r,i,a,o,c;const l=SillyTavern.getContext();let u;try{u=$()}catch(e){u={error:"Failed to load settings"}}return{extension:{settings:{useCurrentSettings:u.useCurrentSettings,debugMode:u.debugMode,generationConfig:u.generationConfig,systemPromptLength:(null===(e=u.systemPrompt)||void 0===e?void 0:e.length)||0,promptPresetCount:(null===(t=u.promptPresets)||void 0===t?void 0:t.length)||0,schemaPresetCount:(null===(n=u.schemaPresets)||void 0===n?void 0:n.length)||0}},sillytavern:{mainApi:l.mainApi,onlineStatus:l.onlineStatus,chatCompletionSource:null===(s=l.chatCompletionSettings)||void 0===s?void 0:s.chat_completion_source,currentModel:(null===(r=l.chatCompletionSettings)||void 0===r?void 0:r.openrouter_model)||(null===(i=l.chatCompletionSettings)||void 0===i?void 0:i.model_openai_select),maxContext:l.maxContext,characterCount:null!==(o=null===(a=l.characters)||void 0===a?void 0:a.length)&&void 0!==o?o:0,hasActiveChat:!!(null===(c=l.chat)||void 0===c?void 0:c.length)},logs:{total:h.length,errors:h.filter((e=>"error"===e.type)).length,recent:h.slice(0,10).map((e=>({type:e.type,label:e.label,time:e.timestamp.toISOString()})))}}}(),null,2)}function $(){const{extensionSettings:t,saveSettingsDebounced:s}=SillyTavern.getContext();if(!t[e])return v("info","Initializing settings with defaults",null),t[e]=structuredClone(f),s(),t[e];const r=t[e];let i=!1;return(!r.settingsVersion||r.settingsVersion<n)&&(i=function(e){const t=e.settingsVersion||1;v("info","Migrating settings",{from:t,to:n});let s=!1;if(t<2){void 0!==e.useRawMode&&(e.useCurrentSettings=!e.useRawMode,delete e.useRawMode);const t=e.jsonSchema;t&&"object"==typeof t&&delete e.jsonSchema;const n=e.useStructuredOutput;void 0!==n&&(e.stageDefaults||(e.stageDefaults=structuredClone(d)),e.stageDefaults.score.useStructuredOutput=n,delete e.useStructuredOutput),s=!0}if(t<3){e.refinementPrompt||(e.refinementPrompt=c);const t=new Set(e.promptPresets.map((e=>e.id)));for(const n of l)t.has(n.id)||e.promptPresets.push(structuredClone(n));s=!0}return e.settingsVersion=n,s}(r)),i=function(e){let t=!1;if(e.generationConfig){const n=e.generationConfig;void 0===n.frequencyPenalty&&(n.frequencyPenalty=0,t=!0),void 0===n.presencePenalty&&(n.presencePenalty=0,t=!0),void 0===n.topP&&(n.topP=1,t=!0)}else e.generationConfig=structuredClone(p),t=!0;void 0===e.systemPrompt&&(e.systemPrompt=o,t=!0);void 0===e.refinementPrompt&&(e.refinementPrompt=c,t=!0);if(e.promptPresets){const n=new Set(e.promptPresets.map((e=>e.id)));for(const s of l)n.has(s.id)||(e.promptPresets.push(structuredClone(s)),t=!0)}else e.promptPresets=[...l],t=!0;if(e.schemaPresets){const n=new Set(e.schemaPresets.map((e=>e.id)));for(const s of u)n.has(s.id)||(e.schemaPresets.push(structuredClone(s)),t=!0)}else e.schemaPresets=[...u],t=!0;if(e.stageDefaults)for(const n of["score","rewrite","analyze"])e.stageDefaults[n]||(e.stageDefaults[n]=structuredClone(d[n]),t=!0);else e.stageDefaults=structuredClone(d),t=!0;void 0===e.debugMode&&(e.debugMode=!1,t=!0);void 0===e.useCurrentSettings&&(e.useCurrentSettings=!0,t=!0);return t}(r)||i,i&&s(),r}function b(t,n){const{extensionSettings:s,saveSettingsDebounced:r}=SillyTavern.getContext();s[e][t]=n,r(),v("info","Setting updated",{key:t,value:"object"==typeof n?"[object]":n})}function S(t){const{extensionSettings:n,saveSettingsDebounced:s}=SillyTavern.getContext(),r=n[e];r.generationConfig||(r.generationConfig=structuredClone(p)),r.generationConfig=Object.assign(Object.assign({},r.generationConfig),t),s(),v("info","Generation config updated",t)}function w(e){b("debugMode",e)}function C(e){const t=$();return e?t.promptPresets.filter((t=>0===t.stages.length||t.stages.includes(e))):t.promptPresets}function x(e){return $().promptPresets.find((t=>t.id===e))||null}function P(t){const{extensionSettings:n,saveSettingsDebounced:s}=SillyTavern.getContext(),r=n[e],{uuidv4:i}=SillyTavern.getContext(),a=Date.now(),o=Object.assign(Object.assign({},t),{id:`custom_prompt_${i()}`,isBuiltin:!1,createdAt:a,updatedAt:a});return r.promptPresets.push(o),s(),v("info","Prompt preset saved",{id:o.id,name:o.name}),o}function E(e){const t=$();return e?t.schemaPresets.filter((t=>0===t.stages.length||t.stages.includes(e))):t.schemaPresets}function O(e){return $().schemaPresets.find((t=>t.id===e))||null}function A(t){const{extensionSettings:n,saveSettingsDebounced:s}=SillyTavern.getContext(),r=n[e],{uuidv4:i}=SillyTavern.getContext(),a=k(t.schema),o=Date.now(),c=Object.assign(Object.assign({},t),{schema:a,id:`custom_schema_${i()}`,isBuiltin:!1,createdAt:o,updatedAt:o});return r.schemaPresets.push(c),s(),v("info","Schema preset saved",{id:c.id,name:c.name}),c}function k(e){const t=structuredClone(e);return R(t.value),t}function R(e){if("object"===e.type&&(e.additionalProperties=!1,e.properties&&"object"==typeof e.properties))for(const t of Object.values(e.properties))t&&"object"==typeof t&&R(t);if("array"===e.type&&e.items&&"object"==typeof e.items&&(Array.isArray(e.items)?e.items.forEach((e=>{e&&"object"==typeof e&&R(e)})):R(e.items)),e.anyOf&&Array.isArray(e.anyOf)&&e.anyOf.forEach((e=>{e&&"object"==typeof e&&R(e)})),e.allOf&&Array.isArray(e.allOf)&&e.allOf.forEach((e=>{e&&"object"==typeof e&&R(e)})),e.$defs&&"object"==typeof e.$defs)for(const t of Object.values(e.$defs))t&&"object"==typeof t&&R(t);if(e.definitions&&"object"==typeof e.definitions)for(const t of Object.values(e.definitions))t&&"object"==typeof t&&R(t)}var T=function(e,t,n,s){return new(n||(n=Promise))((function(r,i){function a(e){try{c(s.next(e))}catch(e){i(e)}}function o(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((s=s.apply(e,t||[])).next())}))};const I={MAX_ANYOF_VARIANTS:8,MAX_DEFS:100,MAX_NESTING_DEPTH:10,MAX_PROPERTIES_PER_OBJECT:100,MAX_ENUM_VALUES:500,SUPPORTED_STRING_FORMATS:["date-time","time","date","duration","email","hostname","uri","ipv4","ipv6","uuid"],SUPPORTED_MINMAX_ITEMS:[0,1]},j={numeric:["minimum","maximum","exclusiveMinimum","exclusiveMaximum","multipleOf"],string:["minLength","maxLength"],array:["maxItems","uniqueItems","contains","minContains","maxContains"],object:["minProperties","maxProperties","propertyNames","patternProperties"]},L=["if","then","else","not","oneOf","dependentRequired","dependentSchemas","unevaluatedProperties","unevaluatedItems","$dynamicRef","$dynamicAnchor"],N=[{pattern:/\(\?[=!<]/,name:"lookahead/lookbehind assertions"},{pattern:/\\[1-9]/,name:"backreferences"},{pattern:/\\[bB]/,name:"word boundaries"}],D='Generate a JSON Schema for structured LLM output based on the user\'s description.\n\nRequirements:\n- Output ONLY valid JSON, no markdown, no explanation\n- Use this exact wrapper format: {"name": "SchemaName", "strict": true, "value": {...}}\n- The "value" must be a valid JSON Schema with "type": "object"\n- Add "additionalProperties": false to ALL object types (required for Anthropic)\n- All object properties should be in a "required" array unless explicitly optional\n- Use simple types: string, number, integer, boolean, array, object\n- For arrays, always specify "items" with a schema\n- Keep it minimal - only what the user asked for\n\nUser\'s description:';function q(e){var t;if(!e.trim())return{valid:!0,schema:void 0};let n;try{n=JSON.parse(e)}catch(e){const t=e instanceof Error?e.message:"Invalid JSON",n=t.match(/position (\d+)/);return{valid:!1,error:`JSON syntax error${n?` (character ${n[1]})`:""}: ${t}`}}if("object"!=typeof n||null===n||Array.isArray(n))return{valid:!1,error:"Schema must be a JSON object, not "+(Array.isArray(n)?"array":typeof n)};const s=n;if("string"!=typeof s.name)return{valid:!1,error:"Missing required 'name' property (string)"};if(!s.name.trim())return{valid:!1,error:"'name' cannot be empty"};if(!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(s.name))return{valid:!1,error:`'name' must be a valid identifier (got '${s.name}'). Use letters, numbers, underscores; start with letter or underscore.`};if("object"!=typeof s.value||null===s.value||Array.isArray(s.value))return{valid:!1,error:"Missing or invalid 'value' property (must be object)"};const r=s.value;if("string"!=typeof r.type&&!r.anyOf&&!r.allOf&&!r.$ref)return{valid:!1,error:"'value' must have a 'type', 'anyOf', 'allOf', or '$ref'"};if(void 0!==s.strict&&"boolean"!=typeof s.strict)return{valid:!1,error:"'strict' must be a boolean if provided"};const i={errors:[],warnings:[],info:[],stats:{defCount:0,anyOfCount:0,totalAnyOfVariants:0,maxDepth:0,propertyCount:0,optionalFieldCount:0,enumCount:0},currentDepth:0,seenRefs:new Set,defs:{}};if(r.$defs&&"object"==typeof r.$defs?(i.defs=r.$defs,i.stats.defCount=Object.keys(i.defs).length):r.definitions&&"object"==typeof r.definitions&&(i.defs=r.definitions,i.stats.defCount=Object.keys(i.defs).length),i.stats.defCount>I.MAX_DEFS&&i.errors.push(`Too many definitions: ${i.stats.defCount} (limit: ${I.MAX_DEFS})`),M(r,"value",i),i.stats.optionalFieldCount>0){const e=i.stats.optionalFieldCount,t=i.stats.totalAnyOfVariants+2*e;e>10&&i.warnings.push(`${e} optional fields detected. Each spawns an implicit anyOf with null. Consider making fields required or reducing optionals.`),t>50&&i.warnings.push(`High anyOf count (~${t} including implicit nullables). May cause slow schema compilation or errors.`)}if(i.errors.length>0)return{valid:!1,error:i.errors.join("\n"),warnings:i.warnings.length>0?i.warnings:void 0};const a={name:s.name,strict:null===(t=s.strict)||void 0===t||t,value:r};return i.info.push(`Schema stats: ${i.stats.propertyCount} properties, ${i.stats.defCount} definitions, ${i.stats.anyOfCount} anyOf blocks, ${i.stats.optionalFieldCount} optional fields, max depth ${i.stats.maxDepth}`),{valid:!0,schema:a,warnings:i.warnings.length>0?i.warnings:void 0,info:i.info.length>0?i.info:void 0}}function M(e,t,n){if(n.currentDepth++,n.stats.maxDepth=Math.max(n.stats.maxDepth,n.currentDepth),n.currentDepth>I.MAX_NESTING_DEPTH)return n.errors.push(`${t}: Exceeds maximum nesting depth of ${I.MAX_NESTING_DEPTH}`),void n.currentDepth--;for(const s of L)void 0!==e[s]&&n.errors.push(`${t}: '${s}' is not supported`);for(const s of j.numeric)void 0!==e[s]&&n.warnings.push(`${t}: '${s}' will be ignored (not supported)`);for(const s of j.string)void 0!==e[s]&&n.warnings.push(`${t}: '${s}' will be ignored (not supported)`);for(const s of j.array)void 0!==e[s]&&n.warnings.push(`${t}: '${s}' will be ignored (not supported)`);for(const s of j.object)void 0!==e[s]&&n.warnings.push(`${t}: '${s}' will be ignored (not supported)`);if(e.$ref&&"string"==typeof e.$ref)return function(e,t,n){if(e.startsWith("http://")||e.startsWith("https://"))return void n.errors.push(`${t}: External $ref not supported ('${e}')`);if(n.seenRefs.has(e))return void n.info.push(`${t}: Circular reference to '${e}'`);n.seenRefs.add(e);const s=e.replace(/^#\/(\$defs|definitions)\//,"");n.defs[s]||n.errors.push(`${t}: Reference '${e}' not found in definitions`)}(e.$ref,t,n),void n.currentDepth--;const s=Array.isArray(e.type)?e.type:[e.type];for(const r of s)switch(r){case"object":z(e,t,n);break;case"array":H(e,t,n);break;case"string":V(e,t,n);break;case"number":case"integer":case"boolean":case"null":break;default:!r||e.anyOf||e.allOf||n.warnings.push(`${t}: Unknown type '${r}'`)}e.anyOf&&Array.isArray(e.anyOf)&&function(e,t,n){n.stats.anyOfCount++,n.stats.totalAnyOfVariants+=e.length,e.length>I.MAX_ANYOF_VARIANTS&&n.errors.push(`${t}: anyOf has ${e.length} variants (max: ${I.MAX_ANYOF_VARIANTS})`);if(0===e.length)return void n.errors.push(`${t}: anyOf cannot be empty`);e.forEach(((e,s)=>{e&&"object"==typeof e&&M(e,`${t}.anyOf[${s}]`,n)}))}(e.anyOf,t,n),e.allOf&&Array.isArray(e.allOf)&&function(e,t,n){if(0===e.length)return void n.errors.push(`${t}: allOf cannot be empty`);e.forEach(((e,s)=>{if(e&&"object"==typeof e){const r=e;r.$ref&&n.errors.push(`${t}.allOf[${s}]: allOf with $ref not supported`),M(r,`${t}.allOf[${s}]`,n)}}))}(e.allOf,t,n),e.enum&&Array.isArray(e.enum)&&function(e,t,n){if(n.stats.enumCount++,0===e.length)return void n.errors.push(`${t}: enum cannot be empty`);e.length>I.MAX_ENUM_VALUES&&n.warnings.push(`${t}: enum has ${e.length} values (may be slow)`);for(let s=0;s<e.length;s++){const r=e[s],i=typeof r;if("string"!==i&&"number"!==i&&"boolean"!==i&&null!==r){n.errors.push(`${t}.enum[${s}]: Complex type not allowed in enum (got ${i}). Only string, number, boolean, null permitted.`);break}}const s=new Set;for(const r of e){const e=JSON.stringify(r);if(s.has(e)){n.warnings.push(`${t}: Duplicate value in enum: ${e}`);break}s.add(e)}}(e.enum,t,n),void 0!==e.const&&function(e,t,n){const s=typeof e;"string"!==s&&"number"!==s&&"boolean"!==s&&null!==e&&n.errors.push(`${t}: const must be string, number, boolean, or null (got ${s})`)}(e.const,t,n),n.currentDepth--}function z(e,t,n){if(!1!==e.additionalProperties&&n.warnings.push(`${t}: Missing 'additionalProperties: false' (REQUIRED for Anthropic)`),e.properties&&"object"==typeof e.properties){const s=e.properties,r=Object.keys(s).length;n.stats.propertyCount+=r,r>I.MAX_PROPERTIES_PER_OBJECT&&n.warnings.push(`${t}: ${r} properties (may be slow, consider splitting)`);const i=e.required||[];for(const[e,r]of Object.entries(s))i.includes(e)||n.stats.optionalFieldCount++,r&&"object"==typeof r&&M(r,`${t}.${e}`,n)}}function H(e,t,n){if(void 0!==e.minItems){I.SUPPORTED_MINMAX_ITEMS.includes(e.minItems)||n.warnings.push(`${t}: 'minItems: ${e.minItems}' not supported (only 0 or 1 allowed)`)}e.items&&("object"!=typeof e.items||Array.isArray(e.items)?Array.isArray(e.items)&&e.items.forEach(((e,s)=>{e&&"object"==typeof e&&M(e,`${t}.items[${s}]`,n)})):M(e.items,`${t}.items`,n)),e.prefixItems&&Array.isArray(e.prefixItems)&&e.prefixItems.forEach(((e,s)=>{e&&"object"==typeof e&&M(e,`${t}.prefixItems[${s}]`,n)}))}function V(e,t,n){if(e.format&&"string"==typeof e.format){const s=I.SUPPORTED_STRING_FORMATS;s.includes(e.format)||n.warnings.push(`${t}: format '${e.format}' may not be supported. Supported: ${s.join(", ")}`)}e.pattern&&"string"==typeof e.pattern&&function(e,t,n){for(const{pattern:s,name:r}of N)s.test(e)&&n.errors.push(`${t}: Regex pattern uses unsupported feature: ${r}`);try{new RegExp(e)}catch(e){const s=e instanceof Error?e.message:"Invalid regex";n.errors.push(`${t}: Invalid regex pattern: ${s}`)}const s=/\{(\d+),(\d+)\}/g;let r;for(;null!==(r=s.exec(e));){const e=parseInt(r[1],10),s=parseInt(r[2],10);s-e>100&&n.warnings.push(`${t}: Large quantifier range {${e},${s}} may cause issues`)}}(e.pattern,t,n)}function F(e){const t=structuredClone(e);return void 0===t.strict&&(t.strict=!0),U(t.value),t}function U(e){if("object"===e.type&&(e.additionalProperties=!1,e.properties&&"object"==typeof e.properties))for(const t of Object.values(e.properties))t&&"object"==typeof t&&U(t);"array"===e.type&&e.items&&"object"==typeof e.items&&(Array.isArray(e.items)?e.items.forEach((e=>{e&&"object"==typeof e&&U(e)})):U(e.items)),e.anyOf&&Array.isArray(e.anyOf)&&e.anyOf.forEach((e=>{e&&"object"==typeof e&&U(e)})),e.allOf&&Array.isArray(e.allOf)&&e.allOf.forEach((e=>{e&&"object"==typeof e&&U(e)}));const t=[];for(const n of j.numeric)void 0!==e[n]&&(t.push(`${n}: ${e[n]}`),delete e[n]);for(const n of j.string)void 0!==e[n]&&(t.push(`${n}: ${e[n]}`),delete e[n]);for(const n of j.array)void 0!==e[n]&&(t.push(`${n}: ${e[n]}`),delete e[n]);if(void 0!==e.minItems&&null!==e.minItems){const n=e.minItems;0!==n&&1!==n&&(t.push(`minItems: ${n}`),e.minItems=n>0?1:0)}if(t.length>0){const n=`[Constraints: ${t.join(", ")}]`;e.description?e.description=`${e.description} ${n}`:e.description=n}}function G(e){if(e.promptPresetId){const t=x(e.promptPresetId);if(t)return t.prompt;v("error","Prompt preset not found",{id:e.promptPresetId})}return e.customPrompt}function B(e){const t=$().stageDefaults[e];return{promptPresetId:t.promptPresetId,customPrompt:t.customPrompt,schemaPresetId:t.schemaPresetId,customSchema:t.customSchema,useStructuredOutput:t.useStructuredOutput}}function J(e,t){const{substituteParams:n}=SillyTavern.getContext();let s=n(e);return s=function(e,t){const n=/\{\{#if\s+(\w+)\}\}([\s\S]*?)\{\{\/if\}\}/gi;return e.replace(n,((e,n,s)=>{var r,i,a,o,c;let l=!1;switch(n.toLowerCase()){case"score_results":l=!!(null===(r=t.scoreResults)||void 0===r?void 0:r.trim());break;case"rewrite_results":l=!!(null===(i=t.rewriteResults)||void 0===i?void 0:i.trim());break;case"current_rewrite":l=!!(null===(a=t.currentRewrite)||void 0===a?void 0:a.trim());break;case"current_analysis":l=!!(null===(o=t.currentAnalysis)||void 0===o?void 0:o.trim());break;case"original_character":l=!!(null===(c=t.originalCharacter)||void 0===c?void 0:c.trim());break;case"iteration_number":l=!!t.iterationNumber&&"0"!==t.iterationNumber;break;default:l=!1}return l?s:""}))}(s,t),void 0!==t.originalCharacter&&(s=s.replace(new RegExp(W(m.ORIGINAL_CHARACTER),"gi"),t.originalCharacter)),void 0!==t.scoreResults&&(s=s.replace(new RegExp(W(m.SCORE_RESULTS),"gi"),t.scoreResults)),void 0!==t.rewriteResults&&(s=s.replace(new RegExp(W(m.REWRITE_RESULTS),"gi"),t.rewriteResults)),void 0!==t.currentRewrite&&(s=s.replace(new RegExp(W(m.CURRENT_REWRITE),"gi"),t.currentRewrite)),void 0!==t.currentAnalysis&&(s=s.replace(new RegExp(W(m.CURRENT_ANALYSIS),"gi"),t.currentAnalysis)),void 0!==t.iterationNumber&&(s=s.replace(new RegExp(W(m.ITERATION_NUMBER),"gi"),t.iterationNumber)),void 0!==t.charName&&(s=s.replace(new RegExp(W(m.CHARACTER_NAME),"gi"),t.charName)),void 0!==t.userName&&(s=s.replace(new RegExp(W(m.USER_NAME),"gi"),t.userName)),void 0!==t.charName&&(s=s.replace(/\{\{char\}\}/gi,t.charName)),void 0!==t.userName&&(s=s.replace(/\{\{user\}\}/gi,t.userName)),s}function W(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function X(){return{character:null,characterIndex:null,results:{score:null,rewrite:null,analyze:null},configs:{score:B("score"),rewrite:B("rewrite"),analyze:B("analyze")},selectedStages:["score","rewrite"],currentStage:null,stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"},iterationCount:0,iterationHistory:[],isRefining:!1,exportData:null}}function Y(e,t,n){if(e.characterIndex===n&&null!==n)return e;const s=Object.assign(Object.assign({},e),{character:t,characterIndex:n,results:{score:null,rewrite:null,analyze:null},stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"},currentStage:null,iterationCount:0,iterationHistory:[],isRefining:!1,exportData:null});return v("state","Character set",{name:null==t?void 0:t.name,index:n,fieldsPopulated:t?K(t).length:0}),s}function K(e){return s.filter((t=>{const n=e[t.key];return n&&"string"==typeof n&&n.trim().length>0})).map((t=>{const n=e[t.key].trim();return{key:t.key,label:t.label,value:n,charCount:n.length,scoreable:t.scoreable}}))}function Q(e){const t=K(e).map((e=>`### ${e.label}\n${e.value}`));return`# CHARACTER: ${e.name}\n\n${t.join("\n\n")}`}function Z(e){return e.character?e.results.rewrite?e.results.analyze?{canRun:!0}:{canRun:!1,reason:"Run analyze first to identify issues"}:{canRun:!1,reason:"No rewrite to refine"}:{canRun:!1,reason:"No character selected"}}function ee(e,t,n){return Object.assign(Object.assign({},e),{configs:Object.assign(Object.assign({},e.configs),{[t]:Object.assign(Object.assign({},e.configs[t]),n)})})}function te(e,t,n){return v("state","Stage failed",{stage:t,error:n}),Object.assign(Object.assign({},e),{currentStage:null,stageStatus:Object.assign(Object.assign({},e.stageStatus),{[t]:"pending"})})}function ne(e){const t=e.toUpperCase();if(t.includes("VERDICT")||t.includes('"VERDICT"')){if(t.includes("ACCEPT")&&!t.includes("NEEDS"))return"accept";if(t.includes("REGRESSION"))return"regression";if(t.includes("NEEDS_REFINEMENT")||t.includes("NEEDS REFINEMENT"))return"needs_refinement"}return t.includes("READY TO USE")||t.includes("NO MORE ITERATIONS")?"accept":t.includes("WORSE THAN")||t.includes("STEP BACKWARD")||t.includes("LOST MORE")?"regression":(t.includes("ISSUE")||t.includes("PROBLEM")||t.includes("SHOULD FIX"),"needs_refinement")}function se(e){const t=function(e){if(!e.results.rewrite||!e.results.analyze)return null;const t=ne(e.results.analyze.response);return{iteration:e.iterationCount,rewriteResponse:e.results.rewrite.response,rewritePreview:e.results.rewrite.response.substring(0,200),analysisResponse:e.results.analyze.response,analysisPreview:e.results.analyze.response.substring(0,200),verdict:t,timestamp:Date.now()}}(e);if(!t)return v("error","Cannot start refinement - missing rewrite or analyze",null),e;const n=[...e.iterationHistory,t];return n.length>_&&n.shift(),v("state","Starting refinement iteration",{iteration:e.iterationCount+1,previousVerdict:t.verdict}),Object.assign(Object.assign({},e),{iterationHistory:n,iterationCount:e.iterationCount+1,results:Object.assign(Object.assign({},e.results),{analyze:null}),stageStatus:Object.assign(Object.assign({},e.stageStatus),{analyze:"pending"}),isRefining:!0})}function re(e,t){const n=e.selectedStages.indexOf(t);return-1===n||n>=e.selectedStages.length-1?null:e.selectedStages[n+1]}function ie(e){return!!e.results.rewrite}function ae(e,t){var n,s,r,i;if(!e.character)return null;const a=G(e.configs[t]);if(!a.trim())return null;const o=Q(e.character),{name1:c}=SillyTavern.getContext(),l={originalCharacter:o,scoreResults:(null===(n=e.results.score)||void 0===n?void 0:n.response)||"",rewriteResults:(null===(s=e.results.rewrite)||void 0===s?void 0:s.response)||"",currentRewrite:(null===(r=e.results.rewrite)||void 0===r?void 0:r.response)||"",currentAnalysis:(null===(i=e.results.analyze)||void 0===i?void 0:i.response)||"",iterationNumber:String(e.iterationCount+1),charName:e.character.name,userName:c||"User"},u=a.toLowerCase(),d=u.includes("{{original_character}}"),p=u.includes("{{score_results}}"),f=u.includes("{{rewrite_results}}"),m=J(a,l),g=function(e,t,n,s,r){switch(e){case"score":return t;case"rewrite":return!!t&&!(r.results.score&&!n);case"analyze":return!!t&&(!(r.results.rewrite&&!s)&&!(r.results.score&&!n));default:return!1}}(t,d,p,f,e);return g?m:function(e,t,n,s,r){var i,a,o;const c=[];if(!r.usesCharacterPlaceholder){const t="score"===e?"Analyze":"rewrite"===e?"Rewrite":"Compare";c.push(`# Character to ${t}`,"",n)}switch(e){case"score":break;case"rewrite":(null===(i=t.results.score)||void 0===i?void 0:i.response)&&!r.usesScorePlaceholder&&c.push("","---","","# Score Feedback","","Use this feedback to guide your rewrite:","",t.results.score.response);break;case"analyze":(null===(a=t.results.rewrite)||void 0===a?void 0:a.response)&&!r.usesRewritePlaceholder&&c.push("","---","","# Rewritten Version","","Compare this against the original:","",t.results.rewrite.response),(null===(o=t.results.score)||void 0===o?void 0:o.response)&&!r.usesScorePlaceholder&&c.push("","---","","# Original Score Feedback","","Reference for what was identified as needing improvement:","",t.results.score.response)}return c.push("","---","","# Instructions","",s),c.join("\n")}(t,e,o,m,{usesCharacterPlaceholder:d,usesScorePlaceholder:p,usesRewritePlaceholder:f})}function oe(e){var t;if(!e.character||!e.results.rewrite||!e.results.analyze)return null;const n=$().refinementPrompt,s=Q(e.character),{name1:r}=SillyTavern.getContext();return J(n,{originalCharacter:s,scoreResults:(null===(t=e.results.score)||void 0===t?void 0:t.response)||"",rewriteResults:e.results.rewrite.response,currentRewrite:e.results.rewrite.response,currentAnalysis:e.results.analyze.response,iterationNumber:String(e.iterationCount+1),charName:e.character.name,userName:r||"User"})}function ce(e,t){return function(e){if(!e.useStructuredOutput)return null;if(e.schemaPresetId){const t=O(e.schemaPresetId);if(t)return t.schema;v("error","Schema preset not found",{id:e.schemaPresetId})}if(e.customSchema){const t=q(e.customSchema);if(t.valid&&t.schema)return t.schema;v("error","Custom schema invalid",{error:t.error})}return null}(e.configs[t])}function le(e){const t=function(e){if(!e.results.rewrite||!e.character)return null;const t=e.results.rewrite.response,n=[`# ${e.character.name} (Rewritten)`,"",`Generated: ${(new Date).toLocaleString()}`,`Iterations: ${e.iterationCount}`,"","---","",t];if(e.results.analyze&&n.push("","---","","## Final Analysis","",e.results.analyze.response),e.results.score&&n.push("","---","","## Original Score","",e.results.score.response),e.iterationHistory.length>0){n.push("","---","","## Iteration History","");for(const t of e.iterationHistory)n.push(`### Iteration ${t.iteration+1} - ${t.verdict.toUpperCase()}`,`${new Date(t.timestamp).toLocaleString()}`,"")}return n.join("\n")}(e);return Object.assign(Object.assign({},e),{exportData:t})}var ue=function(e,t,n,s){return new(n||(n=Promise))((function(r,i){function a(e){try{c(s.next(e))}catch(e){i(e)}}function o(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((s=s.apply(e,t||[])).next())}))},de=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},s("next"),s("throw"),s("return"),t[Symbol.asyncIterator]=function(){return this},t);function s(n){t[n]=e[n]&&function(t){return new Promise((function(s,r){(function(e,t,n,s){Promise.resolve(s).then((function(t){e({value:t,done:n})}),t)})(s,r,(t=e[n](t)).done,t.value)}))}}};function pe(){const{onlineStatus:e}=SillyTavern.getContext();return"Valid"===e||"Connected"===e}function fe(){var e,t,n;const s=SillyTavern.getContext(),r=$();return r.useCurrentSettings?{source:(null===(e=s.chatCompletionSettings)||void 0===e?void 0:e.chat_completion_source)||s.mainApi||"unknown",model:(null===(t=s.chatCompletionSettings)||void 0===t?void 0:t.openrouter_model)||(null===(n=s.chatCompletionSettings)||void 0===n?void 0:n.model_openai_select)||"unknown",isReady:pe()}:{source:r.generationConfig.source,model:r.generationConfig.model,isReady:pe()}}function me(e,t,n,s,r){return ue(this,void 0,void 0,(function*(){try{let i;return i=r?yield function(e,t,n,s){return ue(this,void 0,void 0,(function*(){const{generateRaw:r,substituteParams:i}=SillyTavern.getContext(),a=i(e);if(v("request","generateRaw request",{hasSchema:!!n,schemaName:null==n?void 0:n.name,systemPromptLength:a.length,userPromptLength:t.length}),null==s?void 0:s.aborted)throw new DOMException("Aborted","AbortError");const o=yield r({prompt:[{role:"system",content:a},{role:"user",content:t}],jsonSchema:n});if(null==s?void 0:s.aborted)throw new DOMException("Aborted","AbortError");const c=ge(o);return v("response","generateRaw response",{type:typeof o,length:c.length,preview:c.substring(0,200)}),c}))}(e,t,n,s):yield function(e,t,n,s){return ue(this,void 0,void 0,(function*(){const{ChatCompletionService:r,substituteParams:i}=SillyTavern.getContext(),a=$().generationConfig,o={stream:!0,messages:[{role:"system",content:i(e)},{role:"user",content:t}],chat_completion_source:a.source,model:a.model,temperature:a.temperature,max_tokens:a.maxTokens,frequency_penalty:a.frequencyPenalty,presence_penalty:a.presencePenalty,top_p:a.topP};if(n&&(o.json_schema=n),v("request","ChatCompletionService request",{source:a.source,model:a.model,stream:!0,hasSchema:!!n}),null==s?void 0:s.aborted)throw new DOMException("Aborted","AbortError");const c=yield r.sendRequest(o);let l;if(v("response","ChatCompletionService result type",{type:typeof c,isFunction:"function"==typeof c,isGenerator:c&&"object"==typeof c&&Symbol.asyncIterator in c}),"function"==typeof c)l=yield function(e,t){return ue(this,void 0,void 0,(function*(){var n,s,r,i;let a="";try{const u=e();try{for(var o,c=!0,l=de(u);!(n=(o=yield l.next()).done);c=!0){i=o.value,c=!1;const e=i;if(null==t?void 0:t.aborted)throw v("info","Stream aborted",{textSoFar:a.length}),new DOMException("Aborted","AbortError");const n=e;if("string"==typeof n.text&&(a=n.text),n.error)throw new Error(ge(n.error))}}catch(e){s={error:e}}finally{try{c||n||!(r=l.return)||(yield r.call(l))}finally{if(s)throw s.error}}}catch(e){if("AbortError"===e.name)throw e;if(v("error","Stream consumption error",{error:e,textSoFar:a.length}),a)return v("info","Returning partial response after stream error",{length:a.length}),a;throw e}return v("info","Stream consumed",{finalLength:a.length}),a}))}(c,s);else if(c&&"object"==typeof c){const e=c;if(e.error)throw v("error","API returned error",c),new Error(`API error: ${JSON.stringify(c)}`);l=ge(e.content||c)}else l=ge(c);return v("response","Final response",{length:l.length,preview:l.substring(0,200)}),l}))}(e,t,n,s),(null==s?void 0:s.aborted)?{success:!1,error:"Generation cancelled"}:i&&""!==i.trim()?(v("info","Generation complete",{responseLength:i.length,isStructured:!!n}),{success:!0,response:i,isStructured:!!n}):(v("error","Empty response",null),{success:!1,error:"Empty response from API"})}catch(e){if("AbortError"===e.name||(null==s?void 0:s.aborted))return v("info","Generation aborted",null),{success:!1,error:"Generation cancelled"};v("error","Generation exception",{message:e instanceof Error?e.message:String(e)});return{success:!1,error:e instanceof Error?e.message:String(e)}}}))}function ge(e){if("string"==typeof e)return e;if(null==e)return"";if("object"==typeof e)try{return JSON.stringify(e)}catch(t){return String(e)}return String(e)}function _e(e,t,n){return e.replace(/\{\{char\}\}/gi,t).replace(/\{\{user\}\}/gi,n)}function he(e){return s.filter((t=>{const n=e[t.key];return n&&"string"==typeof n&&n.trim().length>0})).map((t=>{const n=e[t.key].trim();return{key:t.key,label:t.label,value:n,charCount:n.length,scoreable:t.scoreable}}))}var ve=function(e,t,n,s){return new(n||(n=Promise))((function(r,i){function a(e){try{c(s.next(e))}catch(e){i(e)}}function o(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((s=s.apply(e,t||[])).next())}))};function ye(t){const{getThumbnailUrl:n}=SillyTavern.getContext(),s=he(t),r=n("avatar",t.avatar);return`\n    <div class="${e}_char_preview" id="${e}_char_preview">\n      <div class="${e}_char_header">\n        <img\n          class="${e}_char_avatar"\n          src="${r}"\n          alt=""\n          onerror="this.src='/img/ai4.png'"\n        >\n        <div class="${e}_char_info">\n          <div class="${e}_char_name">${be(t.name)}</div>\n          <div class="${e}_char_meta">\n            ${s.length} fields • <span id="${e}_total_tokens">counting...</span>\n          </div>\n        </div>\n        <button id="${e}_char_clear" class="${e}_icon_btn" title="Clear selection">\n          <i class="fa-solid fa-xmark"></i>\n        </button>\n      </div>\n\n      <div class="${e}_char_fields">\n        ${s.map((t=>{return`\n    <div class="${e}_field_row">\n      <div class="${e}_field_header ${e}_field_toggle" data-field="${(n=t).key}">\n        <i class="fa-solid fa-chevron-right"></i>\n        <span class="${e}_field_label">${n.label}</span>\n        <span class="${e}_field_tokens" data-field="${n.key}">...</span>\n      </div>\n      <div class="${e}_field_content hidden" id="${e}_field_content_${n.key}">\n        <div class="${e}_field_text">${be(n.value)}</div>\n      </div>\n    </div>\n  `;var n})).join("")}\n      </div>\n    </div>\n  `}function $e(t,n,s){const{getThumbnailUrl:r}=SillyTavern.getContext();0!==t.length?n.innerHTML=t.map((({char:t,index:n},i)=>{const a=r("avatar",t.avatar),o=i===s,c=(t.description||"No description").substring(0,80);return`\n      <div class="${e}_dropdown_item ${o?"selected":""}" data-index="${n}">\n        <img class="${e}_dropdown_avatar" src="${a}" alt="" onerror="this.src='/img/ai4.png'">\n        <div class="${e}_dropdown_info">\n          <span class="${e}_dropdown_name">${be(t.name)}</span>\n          <span class="${e}_dropdown_desc">${be(c)}${c.length>=80?"...":""}</span>\n        </div>\n      </div>\n    `})).join(""):n.innerHTML=`<div class="${e}_dropdown_empty">No characters found</div>`}function be(e){const{DOMPurify:t}=SillyTavern.libs,n="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(n,{ALLOWED_TAGS:[]})}function Se(t,n,s,o){return`\n    <div class="${e}_pipeline_nav">\n      \x3c!-- Stage Selection --\x3e\n      <div class="${e}_stage_row">\n        ${r.map(((o,c)=>function(t,n,s,r,o){const c=function(e){switch(e){case"complete":return"fa-check";case"running":return"fa-spinner fa-spin";case"skipped":return"fa-forward";default:return null}}(s);return`\n    <div class="${e}_stage_node ${r?"active":""} ${e}_stage_${s}">\n      <input\n        type="checkbox"\n        class="${e}_stage_checkbox"\n        id="${e}_stage_cb_${t}"\n        data-stage="${t}"\n        ${n?"checked":""}\n      >\n      <button\n        class="${e}_stage_btn ${r?"active":""}"\n        data-stage="${t}"\n        title="${i[t]}"\n      >\n        <i class="fa-solid ${a[t]}"></i>\n        <span>${i[t]}</span>\n        ${c?`<i class="fa-solid ${c} ${e}_status_icon"></i>`:""}\n      </button>\n      ${o?`<div class="${e}_stage_connector ${n?"active":""}"></div>`:""}\n    </div>\n  `}(o,t.includes(o),n[o],o===s,c<r.length-1))).join("")}\n      </div>\n\n      \x3c!-- Action Buttons --\x3e\n      <div class="${e}_pipeline_actions">\n        <button\n          id="${e}_run_selected_btn"\n          class="menu_button"\n          ${o?"":"disabled"}\n        >\n          <i class="fa-solid fa-play"></i>\n          <span>Run Selected</span>\n        </button>\n        <button\n          id="${e}_run_all_btn"\n          class="menu_button"\n          ${o?"":"disabled"}\n        >\n          <i class="fa-solid fa-forward"></i>\n          <span>Run All</span>\n        </button>\n        <button\n          id="${e}_reset_pipeline_btn"\n          class="menu_button"\n        >\n          <i class="fa-solid fa-rotate-left"></i>\n          <span>Reset</span>\n        </button>\n      </div>\n    </div>\n  `}var we=function(e,t,n,s){return new(n||(n=Promise))((function(r,i){function a(e){try{c(s.next(e))}catch(e){i(e)}}function o(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((s=s.apply(e,t||[])).next())}))};function Ce(){return we(this,void 0,void 0,(function*(){const{Popup:e,POPUP_RESULT:t}=SillyTavern.getContext(),n=yield e.show.input("Generate Schema",'Describe the structure you want (e.g., <q>"scores for each field 1-10, list of suggestions, overall rating"</q>):\n',"");if(null===n||n===t.CANCELLED||!n.trim())return null;toastr.info("Generating schema...");const s=yield function(e){return T(this,void 0,void 0,(function*(){var t;const{generateRaw:n}=SillyTavern.getContext();if(!e.trim())return{success:!1,error:"Please describe what you want in the schema"};try{let s=(yield n({prompt:`${D}\n\n${e}`,systemPrompt:"You are a JSON Schema expert. Output only valid JSON, nothing else."})).trim();s.startsWith("```")&&(s=s.replace(/^```(?:json)?\s*/,"").replace(/\s*```$/,""));const r=q(s);if(!r.valid)return{success:!1,error:`Generated schema is invalid: ${r.error}`,schema:s};if(null===(t=r.warnings)||void 0===t?void 0:t.length){const e=F(r.schema);return{success:!0,schema:JSON.stringify(e,null,2)}}return{success:!0,schema:JSON.stringify(r.schema,null,2)}}catch(e){return{success:!1,error:`Generation failed: ${e.message}`}}}))}(n);return s.success?(toastr.success("Schema generated!"),s.schema):(toastr.error(s.error||"Generation failed"),s.schema||null)}))}function xe(t,n,s,r){const a=C(n),o=E(n),c=t.querySelector(`#${e}_prompt_preset_select`);c&&(c.innerHTML=`<option value="">Custom</option>${Pe(a,s.promptPresetId)}`,c.value=s.promptPresetId||"",c.disabled=r);const l=t.querySelector(`#${e}_custom_prompt`);if(l){let n=s.customPrompt;if(s.promptPresetId){const e=x(s.promptPresetId);e&&(n=e.prompt)}l.value!==n&&(l.value=n),l.disabled=r;const i=t.querySelector(`.${e}_char_count`);i&&(i.textContent=`${n.length.toLocaleString()} chars`)}const u=t.querySelector(`#${e}_use_structured`);u&&(u.checked=s.useStructuredOutput,u.disabled=r);const d=t.querySelector(`.${e}_schema_section`);d&&d.classList.toggle("hidden",!s.useStructuredOutput);const p=t.querySelector(`#${e}_schema_preset_select`);p&&(p.innerHTML=`<option value="">Custom</option>${Pe(o,s.schemaPresetId)}`,p.value=s.schemaPresetId||"",p.disabled=r);const f=t.querySelector(`#${e}_custom_schema`);if(f){let e=s.customSchema;if(s.schemaPresetId){const t=O(s.schemaPresetId);t&&(e=JSON.stringify(t.schema,null,2))}f.value!==e&&(f.value=e),f.disabled=r}s.useStructuredOutput&&function(t,n){var s;const r=t.querySelector(`.${e}_schema_status`);r&&r.remove();if(!n.trim())return;const i=q(n);let a="";a=i.valid?(null===(s=i.warnings)||void 0===s?void 0:s.length)?`<div class="${e}_schema_status warning"><i class="fa-solid fa-triangle-exclamation"></i> ${i.warnings.length} warning(s)</div>`:`<div class="${e}_schema_status success"><i class="fa-solid fa-circle-check"></i> Valid schema</div>`:`<div class="${e}_schema_status error"><i class="fa-solid fa-circle-xmark"></i> ${Ee(i.error||"Invalid schema")}</div>`;const o=t.querySelector(`#${e}_custom_schema`);o&&o.insertAdjacentHTML("afterend",a)}(t,(null==f?void 0:f.value)||""),function(t,n){var s,r;const i=t.querySelector(`#${e}_validate_schema_btn`),a=t.querySelector(`#${e}_fix_schema_btn`),o=t.querySelector(`#${e}_format_schema_btn`),c=n.trim().length>0;i&&(i.disabled=!c);o&&(o.disabled=!c);if(a&&c){const e=q(n),t=(null!==(r=null===(s=e.warnings)||void 0===s?void 0:s.length)&&void 0!==r?r:0)>0||!e.valid;a.disabled=!t}else a&&(a.disabled=!0)}(t,(null==f?void 0:f.value)||"");const m=t.querySelector(`#${e}_run_stage_btn`);m&&(m.disabled=r,m.innerHTML=r?'<i class="fa-solid fa-spinner fa-spin"></i> Running...':`<i class="fa-solid fa-play"></i> Run ${i[n]} <kbd>Ctrl+Enter</kbd>`),function(t,n){var s,r;const i=t.querySelector(`#${e}_custom_prompt`),a=t.querySelector(`#${e}_custom_schema`),o=t.querySelector(`#${e}_save_prompt_preset_btn`),c=t.querySelector(`#${e}_save_schema_preset_btn`);if(o&&i){const e=i.value.trim(),t=n.promptPresetId&&(null===(s=x(n.promptPresetId))||void 0===s?void 0:s.prompt)||"",r=e.length>0,a=e!==t;o.disabled=!r||null!==n.promptPresetId&&!a}if(c&&a){const e=a.value.trim(),t=n.schemaPresetId?JSON.stringify(null===(r=O(n.schemaPresetId))||void 0===r?void 0:r.schema,null,2):"",s=e.length>0,i=e!==t,o=!!s&&q(e).valid;c.disabled=!s||!o||null!==n.schemaPresetId&&!i}}(t,s)}function Pe(e,t){return e.map((e=>{const n=e.id===t?"selected":"",s=e.isBuiltin?"📦":"📝";return`<option value="${e.id}" ${n}>${s} ${Ee(e.name)}</option>`})).join("")}function Ee(e){const{DOMPurify:t}=SillyTavern.libs;return t.sanitize(e,{ALLOWED_TAGS:[]})}function Oe(e,t){const{showdown:n,DOMPurify:s}=SillyTavern.libs,r="string"==typeof e?e:String(null!=e?e:""),i=`<div class="${t}_markdown_content">${new n.Converter({tables:!0,strikethrough:!0,simpleLineBreaks:!1,headerLevelStart:1,ghCodeBlocks:!0,tasklists:!0,openLinksInNewWindow:!0,emoji:!0,parseImgDimensions:!0,simplifiedAutoLink:!0}).makeHtml(r)}</div>`;return s.sanitize(i)}function Ae(e,t,n){var s;const{DOMPurify:r}=SillyTavern.libs,i="string"==typeof e?e:String(null!=e?e:""),a=function(e){try{return JSON.parse(e)}catch(t){const n=e.match(/```(?:json)?\s*([\s\S]*?)```/);if(n)try{return JSON.parse(n[1].trim())}catch(e){return null}return null}}(i);if(!a||"object"!=typeof a)return Oe(i,n);const o=function(e,t,n){const s=function(e){const t=["overallscore","totalscore","overall","total","score","rating"];for(const n of t)for(const t of Object.keys(e))if(t.toLowerCase().replace(/_/g,"")===n&&"number"==typeof e[t])return t;return null}(e),r=s?e[s]:null,i=[];s&&"number"==typeof r&&i.push(function(e,t,n){const s=ze(e),r=He(t>10?t/10:t),i=Number.isInteger(t)?t:t.toFixed(1),a=t>10?100:10;return`\n    <div class="${n}_hero">\n      <div class="${n}_hero_label">${De(s)}</div>\n      <div class="${n}_hero_value" style="color: ${r}">\n        ${i}<span class="${n}_hero_max">/${a}</span>\n      </div>\n    </div>\n  `}(s,r,n));const a=t.properties||{},o=Object.keys(a).length>0?Object.keys(a):Object.keys(e);for(const t of o){if(t===s)continue;const r=e[t];if(void 0===r)continue;const o=a[t]||{type:qe(r)};i.push(Te(t,r,o,n,0))}return`<div class="${n}_structured_content">${i.join("")}</div>`}(a,null!==(s=null==t?void 0:t.value)&&void 0!==s?s:ke(a),n);return r.sanitize(o)}function ke(e){if(null===e)return{type:"null"};if(Array.isArray(e))return{type:"array",items:e.length>0?ke(e[0]):{type:"string"}};if("object"==typeof e){const t={};for(const[n,s]of Object.entries(e))t[n]=ke(s);return{type:"object",properties:t}}return{type:typeof e}}const Re=8;function Te(e,t,n,s,r){if(r>Re)return function(e,t){const{hljs:n}=SillyTavern.libs,s=JSON.stringify(e,null,2),r=n.highlight(s,{language:"json"}).value;return`<pre class="${t}_json"><code class="hljs">${r}</code></pre>`}(t,s);const i=ze(e),a=n.type||qe(t);if("array"===a&&Array.isArray(t))return function(e,t,n,s,r){if(0===t.length)return`\n      <div class="${s}_field">\n        <div class="${s}_field_label">${De(e)}</div>\n        <div class="${s}_field_value ${s}_empty">(none)</div>\n      </div>\n    `;const i=n.items||{type:qe(t[0])};if(t.every(Me)){const n=t.map((e=>`<li>${function(e,t){if("boolean"==typeof e)return Ne(e,t);if("number"==typeof e)return`<span class="${t}_num">${e.toLocaleString()}</span>`;return De(String(e))}(e,s)}</li>`)).join("");return`\n      <div class="${s}_field">\n        <div class="${s}_field_label">${De(e)}</div>\n        <ol class="${s}_list">${n}</ol>\n      </div>\n    `}const a=t.map(((e,t)=>"object"==typeof e&&null!==e?function(e,t,n,s,r){const i=t.properties||{},a=Object.keys(i).length>0?Object.keys(i):Object.keys(e),o=a.find((t=>"string"==typeof e[t]&&e[t].length<100)),c=a.find((t=>"number"==typeof e[t]&&e[t]>=0&&e[t]<=100)),l=a.find((t=>"string"==typeof e[t]&&e[t].length>=50&&t!==o));let u="";if(o||c){const t=o?`<span class="${n}_card_title">${De(String(e[o]))}</span>`:"",s=c?Le(e[c],n):"";u=`<div class="${n}_card_header">${t}${s}</div>`}let d="";l&&(d=`<div class="${n}_card_body">${je(String(e[l]),n)}</div>`);const p=a.filter((e=>e!==o&&e!==c&&e!==l)).map((t=>{const r=e[t];if(void 0===r)return"";return Te(t,r,i[t]||{type:qe(r)},n,s+1)})).filter(Boolean).join(""),f=p?`<div class="${n}_card_extra">${p}</div>`:"";return`<div class="${n}_card">${u}${d}${f}</div>`}(e,i,s,r+1):`<div class="${s}_card">${Ie(e,i,s)}</div>`)).join("");return`\n    <div class="${s}_field">\n      <div class="${s}_field_label">${De(e)}</div>\n      <div class="${s}_cards">${a}</div>\n    </div>\n  `}(i,t,n,s,r);if("object"===a&&"object"==typeof t&&null!==t)return function(e,t,n,s,r){const i=n.properties||{},a=(Object.keys(i).length>0?Object.keys(i):Object.keys(t)).map((e=>{const n=t[e];if(void 0===n)return"";return Te(e,n,i[e]||{type:qe(n)},s,r+1)})).filter(Boolean).join("");return`\n    <div class="${s}_field">\n      <div class="${s}_field_label">${De(e)}</div>\n      <div class="${s}_nested">${a}</div>\n    </div>\n  `}(i,t,n,s,r);const o=Ie(t,n,s,e);return`\n    <div class="${s}_field">\n      <div class="${s}_field_label">${De(i)}</div>\n      <div class="${s}_field_value">${o}</div>\n    </div>\n  `}function Ie(e,t,n,s){if(null==e)return`<span class="${n}_null">—</span>`;switch(t.type||qe(e)){case"string":return function(e,t,n){if(!e.trim())return`<span class="${n}_empty">(empty)</span>`;const s=t.format;if("uri"===s||"url"===s||(r=e,/^https?:\/\//i.test(r))){const t=e.length>50?e.substring(0,47)+"...":e;return`<a href="${De(e)}" target="_blank" rel="noopener" class="${n}_link">${De(t)}</a>`}var r;if("email"===s||function(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}(e))return`<a href="mailto:${De(e)}" class="${n}_link">${De(e)}</a>`;if(e.length>100||e.includes("\n"))return je(e,n);return`<span>${De(e)}</span>`}(e,t,n);case"number":case"integer":return function(e,t,n,s){const r=String(t.title||t.description||s||"").toLowerCase();if(function(e,t){return!!["score","rating","rank","grade","level","confidence","quality"].some((t=>e.includes(t)))||(!!(t>=0&&t<=10&&Number.isFinite(t))||!!(t>=0&&t<=100&&Number.isInteger(t)))}(r,e))return Le(e,n);const i=e.toLocaleString(void 0,{maximumFractionDigits:2});return`<span class="${n}_num">${i}</span>`}(e,t,n,s);case"boolean":return Ne(e,n);default:return`<span>${De(String(e))}</span>`}}function je(e,t){return`<div class="${t}_text">${Oe(e,t)}</div>`}function Le(e,t){return`<span class="${t}_score" style="color: ${He(e>10?e/10:e)}">${Number.isInteger(e)?e:e.toFixed(1)}<span class="${t}_score_max">/${e>10?100:10}</span></span>`}function Ne(e,t){return`<span class="${e?`${t}_yes`:`${t}_no`}"><i class="fa-solid ${e?"fa-check-circle":"fa-times-circle"}"></i> ${e?"Yes":"No"}</span>`}function De(e){const{DOMPurify:t}=SillyTavern.libs,n="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(n,{ALLOWED_TAGS:[]})}function qe(e){return null===e?"null":Array.isArray(e)?"array":typeof e}function Me(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e||null===e}function ze(e){return e.replace(/_/g," ").replace(/([a-z])([A-Z])/g,"$1 $2").replace(/\b\w/g,(e=>e.toUpperCase()))}function He(e){return e>=8?"var(--success, #2ecc71)":e>=5?"var(--warning, #f39c12)":"var(--failure, #e74c3c)"}function Ve(t){return`\n    <div class="${e}_results_loading">\n      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>\n      <p>Running ${i[t]}...</p>\n      <button id="${e}_cancel_btn" class="menu_button">\n        <i class="fa-solid fa-stop"></i>\n        <span>Cancel</span>\n      </button>\n    </div>\n  `}function Fe(t,n){let s=`Run ${i[t]} to see results`,r="fa-play";return"skipped"===n&&(s=`${i[t]} was skipped`,r="fa-forward"),`\n    <div class="${e}_results_placeholder">\n      <i class="fa-solid ${r}"></i>\n      <p>${s}</p>\n    </div>\n  `}function Ue(t,n){const s=n.isStructured?Ae(n.response,null,e):Oe(n.response,e),r=new Date(n.timestamp).toLocaleTimeString();let a="";if("analyze"===t){a=function(t){return`\n    <span class="${e}_badge ${e}_verdict_badge ${e}_verdict_${t}">\n      <i class="fa-solid ${{accept:"fa-check-circle",needs_refinement:"fa-wrench",regression:"fa-arrow-down"}[t]}"></i>\n      ${{accept:"Accept",needs_refinement:"Needs Work",regression:"Regression"}[t]}\n    </span>\n  `}(ne(n.response))}return`\n    <div class="${e}_results_content">\n      \x3c!-- Toolbar --\x3e\n      <div class="${e}_results_toolbar">\n        <div class="${e}_results_info">\n          <span class="${e}_badge">${i[t]}</span>\n          ${a}\n          <span class="${e}_results_time">${r}</span>\n          ${n.locked?`<span class="${e}_badge ${e}_badge_locked"><i class="fa-solid fa-lock"></i> Locked</span>`:""}\n        </div>\n        <div class="${e}_results_actions">\n          ${n.locked?`<button id="${e}_unlock_btn" class="${e}_icon_btn" title="Unlock for editing">\n                <i class="fa-solid fa-lock-open"></i>\n              </button>`:`<button id="${e}_lock_btn" class="${e}_icon_btn" title="Lock result">\n                <i class="fa-solid fa-lock"></i>\n              </button>`}\n          <button id="${e}_copy_btn" class="${e}_icon_btn" title="Copy to clipboard">\n            <i class="fa-solid fa-copy"></i>\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Content --\x3e\n      <div class="${e}_results_body">\n        ${s}\n      </div>\n\n      \x3c!-- Footer Actions --\x3e\n      <div class="${e}_results_footer" id="${e}_results_footer">\n        \x3c!-- Populated by updateResultsPanelState --\x3e\n      </div>\n    </div>\n  `}function Ge(t,n,s,r,a,o,c){var l;const u=a&&"running"===r,d=s&&!u,p=!s&&!u;if(u)return void(t.innerHTML=Ve(n));if(p)return void(t.innerHTML=Fe(n,r));if(d){const r=t.querySelector(`.${e}_results_content`),i=null===(l=t.querySelector(`.${e}_results_time`))||void 0===l?void 0:l.textContent,a=new Date(s.timestamp).toLocaleTimeString();r&&i===a||(t.innerHTML=Ue(n,s))}const f=t.querySelector(`#${e}_results_footer`);f&&s&&(f.innerHTML=function(t,n,s,r){const a=[];n.locked||a.push(`\n      <button id="${e}_regenerate_btn" class="menu_button">\n        <i class="fa-solid fa-rotate"></i>\n        <span>Regenerate</span>\n      </button>\n    `);if("analyze"===t){const t=ne(n.response);if(Z(r).canRun){const n="needs_refinement"===t;a.push(`\n        <button id="${e}_refine_btn" class="menu_button ${n?e+"_refine_recommended":""}">\n          <i class="fa-solid fa-arrows-rotate"></i>\n          <span>Refine</span>\n          ${r.iterationCount>0?`<span class="${e}_iteration_badge">#${r.iterationCount+1}</span>`:""}\n        </button>\n      `)}if(r.results.rewrite&&!r.results.rewrite.locked){const n="accept"===t;a.push(`\n        <button id="${e}_accept_btn" class="menu_button ${n?e+"_accept_recommended":""}">\n          <i class="fa-solid fa-check"></i>\n          <span>Accept Rewrite</span>\n        </button>\n      `)}}s&&"analyze"!==t&&a.push(`\n      <button id="${e}_continue_btn" class="menu_button ${e}_continue_btn">\n        <i class="fa-solid fa-arrow-right"></i>\n        <span>Continue to ${i[s]}</span>\n      </button>\n    `);ie(r)&&a.push(`\n      <button id="${e}_export_btn" class="menu_button">\n        <i class="fa-solid fa-file-export"></i>\n        <span>Export</span>\n      </button>\n    `);return`<div class="${e}_footer_actions">${a.join("")}</div>`}(n,s,o,c));const m=t.querySelector(`#${e}_lock_btn`),g=t.querySelector(`#${e}_unlock_btn`);(null==s?void 0:s.locked)?(null==m||m.classList.add("hidden"),null==g||g.classList.remove("hidden")):(null==m||m.classList.remove("hidden"),null==g||g.classList.add("hidden"))}function Be(t,n,s){return 0===t.length&&0===n?"":`\n    <div class="${e}_iteration_history" id="${e}_iteration_history">\n      <div class="${e}_iteration_header">\n        <i class="fa-solid fa-clock-rotate-left"></i>\n        <span>Iteration History</span>\n        <span class="${e}_iteration_count">${n>0?`Current: #${n+1}`:"Initial"}</span>\n      </div>\n      <div class="${e}_iteration_list">\n        ${0===t.length?`<div class="${e}_iteration_empty">No previous iterations</div>`:t.map(((e,n)=>Je(e,n,t.length))).join("")}\n      </div>\n    </div>\n  `}function Je(t,n,s){const r=We(t.verdict),i=Xe(t.verdict),a=new Date(t.timestamp).toLocaleTimeString();return`\n    <div class="${e}_iteration_item ${i}" data-index="${n}">\n      <div class="${e}_iteration_item_header">\n        <span class="${e}_iteration_num">#${t.iteration+1}</span>\n        <span class="${e}_iteration_verdict">\n          <i class="fa-solid ${r}"></i>\n          ${Ye(t.verdict)}\n        </span>\n        <span class="${e}_iteration_time">${a}</span>\n      </div>\n      <div class="${e}_iteration_preview">\n        ${Ke(t.rewritePreview)}...\n      </div>\n      <div class="${e}_iteration_actions">\n        <button\n          class="${e}_iteration_revert_btn menu_button"\n          data-index="${n}"\n          title="Revert to this version"\n        >\n          <i class="fa-solid fa-rotate-left"></i>\n          Revert\n        </button>\n        <button\n          class="${e}_iteration_view_btn menu_button"\n          data-index="${n}"\n          title="View full content"\n        >\n          <i class="fa-solid fa-eye"></i>\n          View\n        </button>\n      </div>\n    </div>\n  `}function We(e){switch(e){case"accept":return"fa-check-circle";case"needs_refinement":return"fa-wrench";case"regression":return"fa-arrow-down";default:return"fa-question-circle"}}function Xe(t){return`${e}_verdict_${t}`}function Ye(e){switch(e){case"accept":return"Accepted";case"needs_refinement":return"Needs Work";case"regression":return"Regression";default:return"Unknown"}}function Ke(e){const{DOMPurify:t}=SillyTavern.libs,n="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(n,{ALLOWED_TAGS:[]})}var Qe=function(e,t,n,s){return new(n||(n=Promise))((function(r,i){function a(e){try{c(s.next(e))}catch(e){i(e)}}function o(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((s=s.apply(e,t||[])).next())}))};function Ze(t){return Qe(this,void 0,void 0,(function*(){const{Popup:s,POPUP_TYPE:r}=SillyTavern.getContext(),{DOMPurify:i}=SillyTavern.libs,a=function(){const t=$(),n=t.generationConfig;return`\n    <div class="${e}_settings_modal" id="${e}_settings_modal">\n      <div class="${e}_settings_header">\n        <i class="fa-solid fa-gear"></i>\n        <span>Character Tools Settings</span>\n      </div>\n\n      \x3c!-- Generation Settings --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-microchip"></i>\n          <span>Generation</span>\n        </div>\n\n        <div class="${e}_settings_row">\n          <label class="${e}_checkbox_label">\n            <input\n              type="checkbox"\n              id="${e}_use_current_settings"\n              ${t.useCurrentSettings?"checked":""}\n            >\n            <span>Use Current SillyTavern Settings</span>\n          </label>\n        </div>\n\n        <div id="${e}_custom_gen_config" class="${t.useCurrentSettings?"hidden":""}">\n          <div class="${e}_settings_grid">\n            <div class="${e}_settings_field">\n              <label>Source</label>\n              <select id="${e}_gen_source" class="text_pole"></select>\n            </div>\n            <div class="${e}_settings_field">\n              <label>Model</label>\n              <select id="${e}_gen_model" class="text_pole"></select>\n            </div>\n          </div>\n\n          <div class="${e}_settings_grid ${e}_settings_grid_5">\n            <div class="${e}_settings_field">\n              <label>Temp</label>\n              <input type="number" id="${e}_gen_temp" class="text_pole" value="${n.temperature}" min="0" max="2" step="0.1">\n            </div>\n            <div class="${e}_settings_field">\n              <label>Max Tokens</label>\n              <input type="number" id="${e}_gen_tokens" class="text_pole" value="${n.maxTokens}" min="100" max="32000" step="100">\n            </div>\n            <div class="${e}_settings_field">\n              <label>Freq Pen</label>\n              <input type="number" id="${e}_gen_freq" class="text_pole" value="${n.frequencyPenalty}" min="-2" max="2" step="0.1">\n            </div>\n            <div class="${e}_settings_field">\n              <label>Pres Pen</label>\n              <input type="number" id="${e}_gen_pres" class="text_pole" value="${n.presencePenalty}" min="-2" max="2" step="0.1">\n            </div>\n            <div class="${e}_settings_field">\n              <label>Top P</label>\n              <input type="number" id="${e}_gen_top_p" class="text_pole" value="${n.topP}" min="0" max="1" step="0.05">\n            </div>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- System Prompt --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-message"></i>\n          <span>System Prompt</span>\n        </div>\n\n        <p class="${e}_settings_hint">Base instructions applied to all stages</p>\n\n        <textarea\n          id="${e}_system_prompt"\n          class="text_pole ${e}_system_prompt_textarea"\n          rows="6"\n        >${rt(t.systemPrompt)}</textarea>\n\n        <div class="${e}_settings_row_spread">\n          <span id="${e}_system_prompt_chars">${t.systemPrompt.length.toLocaleString()} chars</span>\n          <button id="${e}_reset_system_prompt" class="menu_button">\n            <i class="fa-solid fa-rotate-left"></i>\n            Reset\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Refinement Prompt --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-arrows-rotate"></i>\n          <span>Refinement Prompt</span>\n        </div>\n\n        <p class="${e}_settings_hint">Template for iterative refinement. Placeholders: {{original_character}}, {{current_rewrite}}, {{current_analysis}}, {{score_results}}, {{iteration_number}}</p>\n\n        <textarea\n          id="${e}_refinement_prompt"\n          class="text_pole ${e}_system_prompt_textarea"\n          rows="8"\n        >${rt(t.refinementPrompt)}</textarea>\n\n        <div class="${e}_settings_row_spread">\n          <span id="${e}_refinement_prompt_chars">${t.refinementPrompt.length.toLocaleString()} chars</span>\n          <button id="${e}_reset_refinement_prompt" class="menu_button">\n            <i class="fa-solid fa-rotate-left"></i>\n            Reset\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Preset Management --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-bookmark"></i>\n          <span>Presets</span>\n        </div>\n\n        <div class="${e}_presets_grid">\n          <div class="${e}_preset_column">\n            <h4>Prompt Presets</h4>\n            <div id="${e}_prompt_presets_list" class="${e}_preset_list">\n              ${et("prompt")}\n            </div>\n          </div>\n          <div class="${e}_preset_column">\n            <h4>Schema Presets</h4>\n            <div id="${e}_schema_presets_list" class="${e}_preset_list">\n              ${et("schema")}\n            </div>\n          </div>\n        </div>\n\n        <div class="${e}_settings_row_spread">\n          <button id="${e}_export_presets" class="menu_button">\n            <i class="fa-solid fa-file-export"></i>\n            Export Custom\n          </button>\n          <button id="${e}_import_presets" class="menu_button">\n            <i class="fa-solid fa-file-import"></i>\n            Import\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Debug --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-bug"></i>\n          <span>Debug</span>\n        </div>\n\n        <div class="${e}_settings_row">\n          <label class="${e}_checkbox_label">\n            <input\n              type="checkbox"\n              id="${e}_debug_mode"\n              ${t.debugMode?"checked":""}\n            >\n            <span>Enable Debug Logging</span>\n          </label>\n        </div>\n\n        <div class="${e}_debug_actions">\n          <button id="${e}_view_logs" class="menu_button">\n            <i class="fa-solid fa-list"></i>\n            View Logs\n          </button>\n          <button id="${e}_clear_logs" class="menu_button">\n            <i class="fa-solid fa-trash"></i>\n            Clear\n          </button>\n          <button id="${e}_copy_debug_info" class="menu_button">\n            <i class="fa-solid fa-copy"></i>\n            Copy Info\n          </button>\n        </div>\n\n        <div id="${e}_debug_log_viewer" class="${e}_debug_log_viewer hidden">\n          <div id="${e}_debug_log_list" class="${e}_debug_log_list"></div>\n          <pre id="${e}_debug_log_detail" class="${e}_debug_log_detail">Select a log entry</pre>\n        </div>\n      </div>\n    </div>\n  `}();new s(i.sanitize(a),r.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:"Save & Close",cancelButton:!1}).show().then((()=>{null==t||t(),v("info","Settings modal closed",null)})),yield new Promise((e=>setTimeout(e,0))),function(){const t=document.getElementById(`${e}_settings_modal`);if(!t)return;const s=t.querySelector(`#${e}_use_current_settings`),r=t.querySelector(`#${e}_custom_gen_config`);null==s||s.addEventListener("change",(()=>{b("useCurrentSettings",s.checked),null==r||r.classList.toggle("hidden",s.checked)}));const i=t.querySelector(`#${e}_gen_source`),a=t.querySelector(`#${e}_gen_model`),l=t.querySelector(`#${e}_gen_temp`),u=t.querySelector(`#${e}_gen_tokens`),d=t.querySelector(`#${e}_gen_freq`),p=t.querySelector(`#${e}_gen_pres`),f=t.querySelector(`#${e}_gen_top_p`);null==i||i.addEventListener("change",(()=>{S({source:i.value}),st(i.value)})),null==a||a.addEventListener("change",(()=>{S({model:a.value})}));const m=(e,t,n=!1)=>{null==e||e.addEventListener("change",(()=>{const s=n?parseInt(e.value,10):parseFloat(e.value);isNaN(s)||S({[t]:s})}))};m(l,"temperature"),m(u,"maxTokens",!0),m(d,"frequencyPenalty"),m(p,"presencePenalty"),m(f,"topP");const g=t.querySelector(`#${e}_system_prompt`),_=t.querySelector(`#${e}_system_prompt_chars`),C=t.querySelector(`#${e}_reset_system_prompt`);null==g||g.addEventListener("input",(()=>{b("systemPrompt",g.value),_&&(_.textContent=`${g.value.length.toLocaleString()} chars`)})),null==C||C.addEventListener("click",(()=>{b("systemPrompt",o),g&&(g.value=o),_&&(_.textContent=`${o.length.toLocaleString()} chars`),toastr.info("System prompt reset to default")}));const x=t.querySelector(`#${e}_refinement_prompt`),E=t.querySelector(`#${e}_refinement_prompt_chars`),O=t.querySelector(`#${e}_reset_refinement_prompt`);null==x||x.addEventListener("input",(()=>{b("refinementPrompt",x.value),E&&(E.textContent=`${x.value.length.toLocaleString()} chars`)})),null==O||O.addEventListener("click",(()=>{b("refinementPrompt",c),x&&(x.value=c),E&&(E.textContent=`${c.length.toLocaleString()} chars`),toastr.info("Refinement prompt reset to default")})),t.addEventListener("click",(t=>{const n=t.target.closest(`.${e}_preset_delete`);if(n){const t=n.getAttribute("data-type"),s=n.getAttribute("data-id");t&&s&&function(t,n){const s="prompt"===t?function(t){var n;const{extensionSettings:s,saveSettingsDebounced:r}=SillyTavern.getContext(),i=s[e],a=i.promptPresets.findIndex((e=>e.id===t));if(-1===a)return!1;if(i.promptPresets[a].isBuiltin)return v("error","Cannot delete builtin preset",{id:t}),!1;i.promptPresets.splice(a,1);for(const e of["score","rewrite","analyze"])(null===(n=i.stageDefaults[e])||void 0===n?void 0:n.promptPresetId)===t&&(i.stageDefaults[e].promptPresetId=null);return r(),v("info","Prompt preset deleted",{id:t}),!0}(n):function(t){var n;const{extensionSettings:s,saveSettingsDebounced:r}=SillyTavern.getContext(),i=s[e],a=i.schemaPresets.findIndex((e=>e.id===t));if(-1===a)return!1;if(i.schemaPresets[a].isBuiltin)return v("error","Cannot delete builtin preset",{id:t}),!1;i.schemaPresets.splice(a,1);for(const e of["score","rewrite","analyze"])(null===(n=i.stageDefaults[e])||void 0===n?void 0:n.schemaPresetId)===t&&(i.stageDefaults[e].schemaPresetId=null);return r(),v("info","Schema preset deleted",{id:t}),!0}(n);s?(toastr.success("Preset deleted"),tt()):toastr.error("Cannot delete builtin preset")}(t,s)}}));const k=t.querySelector(`#${e}_export_presets`),R=t.querySelector(`#${e}_import_presets`);null==k||k.addEventListener("click",(()=>{const e=function(){const e=$(),t=e.promptPresets.filter((e=>!e.isBuiltin)),s=e.schemaPresets.filter((e=>!e.isBuiltin));return JSON.stringify({version:n,exportedAt:(new Date).toISOString(),promptPresets:t,schemaPresets:s},null,2)}();navigator.clipboard.writeText(e),toastr.success("Custom presets copied to clipboard")})),null==R||R.addEventListener("click",(()=>Qe(this,void 0,void 0,(function*(){try{const e=function(e){const t=[];let n=0,s=0;try{const r=JSON.parse(e);if(r.promptPresets&&Array.isArray(r.promptPresets))for(const e of r.promptPresets)try{e.name&&e.prompt&&(P({name:e.name,prompt:e.prompt,stages:e.stages||[]}),n++)}catch(n){t.push(`Failed to import prompt "${e.name}": ${n}`)}if(r.schemaPresets&&Array.isArray(r.schemaPresets))for(const e of r.schemaPresets)try{e.name&&e.schema&&(A({name:e.name,schema:e.schema,stages:e.stages||[]}),s++)}catch(n){t.push(`Failed to import schema "${e.name}": ${n}`)}}catch(e){t.push(`Failed to parse JSON: ${e}`)}return v("info","Presets imported",{promptsImported:n,schemasImported:s,errors:t}),{prompts:n,schemas:s,errors:t}}(yield navigator.clipboard.readText());e.errors.length>0?toastr.error(e.errors.join("\n")):(toastr.success(`Imported ${e.prompts} prompts, ${e.schemas} schemas`),tt())}catch(e){toastr.error("Failed to read clipboard")}}))));const T=t.querySelector(`#${e}_debug_mode`),I=t.querySelector(`#${e}_view_logs`),j=t.querySelector(`#${e}_clear_logs`),L=t.querySelector(`#${e}_copy_debug_info`),N=t.querySelector(`#${e}_debug_log_viewer`);null==T||T.addEventListener("change",(()=>{w(T.checked),toastr.info("Debug mode "+(T.checked?"enabled":"disabled"))})),null==I||I.addEventListener("click",(()=>{null==N||N.classList.toggle("hidden"),(null==N?void 0:N.classList.contains("hidden"))||nt()})),null==j||j.addEventListener("click",(()=>{h.length=0,nt(),toastr.info("Debug logs cleared")})),null==L||L.addEventListener("click",(()=>{navigator.clipboard.writeText(y()),toastr.success("Debug info copied to clipboard")}))}(),function(){const t=$();(function(t){const n=document.getElementById(`${e}_settings_modal`),s=null==n?void 0:n.querySelector(`#${e}_gen_source`);if(!s)return;s.innerHTML="";const r=document.getElementById("chat_completion_source");r&&Array.from(r.options).forEach((e=>{if(e.value){const t=document.createElement("option");t.value=e.value,t.textContent=e.textContent||e.value,s.appendChild(t)}}));0===s.options.length&&["openrouter","openai","claude","makersuite","mistralai","groq"].forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,s.appendChild(t)}));s.value=t})(t.generationConfig.source),st(t.generationConfig.source,t.generationConfig.model)}(),v("info","Settings modal opened",null)}))}function et(t){const n="prompt"===t?C():E();return 0===n.length?`<div class="${e}_preset_empty">No presets</div>`:n.map((n=>`\n    <div class="${e}_preset_item ${n.isBuiltin?"builtin":""}" data-id="${n.id}">\n      <span class="${e}_preset_name">\n        ${n.isBuiltin?'<i class="fa-solid fa-lock"></i>':""}\n        ${rt(n.name)}\n      </span>\n      ${n.isBuiltin?"":`\n        <button class="${e}_preset_delete" data-type="${t}" data-id="${n.id}" title="Delete">\n          <i class="fa-solid fa-trash"></i>\n        </button>\n      `}\n    </div>\n  `)).join("")}function tt(){const t=document.getElementById(`${e}_settings_modal`);if(!t)return;const n=t.querySelector(`#${e}_prompt_presets_list`),s=t.querySelector(`#${e}_schema_presets_list`);n&&(n.innerHTML=et("prompt")),s&&(s.innerHTML=et("schema"))}function nt(){const t=document.getElementById(`${e}_settings_modal`);if(!t)return;const n=t.querySelector(`#${e}_debug_log_list`),s=t.querySelector(`#${e}_debug_log_detail`);if(!n||!s)return;const r=[...h];n.innerHTML=r.length?r.map(((t,n)=>`\n        <div class="${e}_debug_log_entry" data-index="${n}">\n          ${function(e){const t=e.timestamp.toLocaleTimeString();return`${{request:"📤",response:"📥",error:"❌",info:"ℹ️",state:"🔄"}[e.type]} [${t}] ${e.label}`}(t)}\n        </div>\n      `)).join(""):`<div class="${e}_debug_log_empty">No logs</div>`,n.querySelectorAll(`.${e}_debug_log_entry`).forEach((e=>{e.addEventListener("click",(()=>{const t=parseInt(e.dataset.index||"0",10),n=r[t];n&&s&&(s.textContent=function(e){try{return null===e?"null":void 0===e?"undefined":"string"==typeof e?e:JSON.stringify(e,null,2)}catch(t){return String(e)}}(n.data))}))}))}function st(t,n){const s=document.getElementById(`${e}_settings_modal`),r=null==s?void 0:s.querySelector(`#${e}_gen_model`);if(!r)return;r.innerHTML="";const i={openrouter:"model_openrouter_select",openai:"model_openai_select",claude:"model_claude_select",makersuite:"model_google_select",google:"model_google_select",mistralai:"model_mistralai_select",cohere:"model_cohere_select",perplexity:"model_perplexity_select",groq:"model_groq_select",ai21:"model_ai21_select",deepseek:"model_deepseek_select",custom:"model_custom_select"},a=i[t]?document.getElementById(i[t]):null;if(null==a?void 0:a.options.length)Array.from(a.options).forEach((e=>{if(e.value){const t=document.createElement("option");t.value=e.value,t.textContent=e.textContent||e.value,r.appendChild(t)}}));else{const e=document.createElement("option");e.value=n||"",e.textContent=n||`No models for ${t}`,r.appendChild(e)}n&&Array.from(r.options).some((e=>e.value===n))?r.value=n:r.options.length&&(r.value=r.options[0].value,S({model:r.options[0].value}))}function rt(e){const{DOMPurify:t}=SillyTavern.libs,n="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(n,{ALLOWED_TAGS:[]})}var it=function(e,t,n,s){return new(n||(n=Promise))((function(r,i){function a(e){try{c(s.next(e))}catch(e){i(e)}}function o(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((s=s.apply(e,t||[])).next())}))};let at=null,ot=null;const ct=[];function lt(){const{eventSource:e,eventTypes:t}=SillyTavern.getContext(),n=()=>{v("info","API status changed",{isReady:pe()}),ut()},s=()=>{v("info","Character edited externally",null),function(){var e;if(!at||null===at.pipeline.characterIndex)return;const{characters:t}=SillyTavern.getContext(),n=t,s=at.pipeline.characterIndex;if(at.characters=n,s>=0&&s<n.length){const t=n[s];t.name===(null===(e=at.pipeline.character)||void 0===e?void 0:e.name)?(at.pipeline=Object.assign(Object.assign({},at.pipeline),{character:t}),$t(),Et(),v("info","Character refreshed",{name:t.name})):dt()}else dt()}()},r=e=>{v("info","Character deleted",{id:e.id}),function(e){if(!at)return;const t=at.pipeline.characterIndex;if(null===t)return;if(t===e)dt(),toastr.warning("Selected character was deleted");else if(t>e){const e=t-1,{characters:n}=SillyTavern.getContext(),s=n;e>=0&&e<s.length?(at.pipeline=Object.assign(Object.assign({},at.pipeline),{characterIndex:e,character:s[e]}),at.characters=s,v("info","Character index adjusted after deletion",{oldIndex:t,newIndex:e})):dt()}}(e.id)},i=()=>{v("info","OAI preset changed",null),at&&Et()},a=()=>{v("info","Chat completion source changed",null),ut(),Et()},o=()=>{v("info","Chat completion model changed",null),ut(),Et()};e.on(t.ONLINE_STATUS_CHANGED,n),e.on(t.CHARACTER_EDITED,s),e.on(t.CHARACTER_DELETED,r),e.on(t.OAI_PRESET_CHANGED_AFTER,i),e.on(t.CHATCOMPLETION_SOURCE_CHANGED,a),e.on(t.CHATCOMPLETION_MODEL_CHANGED,o),ct.push((()=>e.removeListener(t.ONLINE_STATUS_CHANGED,n)),(()=>e.removeListener(t.CHARACTER_EDITED,s)),(()=>e.removeListener(t.CHARACTER_DELETED,r)),(()=>e.removeListener(t.OAI_PRESET_CHANGED_AFTER,i)),(()=>e.removeListener(t.CHATCOMPLETION_SOURCE_CHANGED,a)),(()=>e.removeListener(t.CHATCOMPLETION_MODEL_CHANGED,o))),v("info","Event listeners subscribed",{count:ct.length})}function ut(){if(!ot)return;const t=fe(),n=ot.querySelector(`.${e}_api_status`);if(n){n.className=`${e}_api_status ${t.isReady?"connected":"disconnected"}`;const s=n.querySelector("span");s&&(s.textContent=t.source)}bt()}function dt(){at&&(v("info","Character invalidated, clearing selection",null),at.pipeline=Y(at.pipeline,null,null),yt(),toastr.info("Character selection cleared"))}let pt=null,ft=null;function mt(){return it(this,void 0,void 0,(function*(){const{Popup:t,POPUP_TYPE:n,characters:s}=SillyTavern.getContext(),{DOMPurify:o}=SillyTavern.libs,c=s;at={pipeline:X(),isGenerating:!1,isRefining:!1,abortController:null,activeStageView:"score",characters:c};const l=function(){const t=fe();return`\n    <div class="${e}_popup" id="${e}_popup">\n      \x3c!-- Header --\x3e\n      <div class="${e}_popup_header">\n        <div class="${e}_popup_title">\n          <i class="fa-solid fa-wand-magic-sparkles"></i>\n          <span>Character Tools</span>\n        </div>\n        <div class="${e}_popup_header_right">\n          <div class="${e}_api_status ${t.isReady?"connected":"disconnected"}">\n            <i class="fa-solid fa-circle"></i>\n            <span>${t.source}</span>\n          </div>\n          <button id="${e}_settings_btn" class="${e}_icon_btn" title="Settings">\n            <i class="fa-solid fa-gear"></i>\n          </button>\n          <button id="${e}_close_btn" class="${e}_icon_btn" title="Close">\n            <i class="fa-solid fa-xmark"></i>\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Character Section --\x3e\n      <div class="${e}_section" id="${e}_character_section">\n        <div class="${e}_section_header">\n          <i class="fa-solid fa-user"></i>\n          <span>Character</span>\n        </div>\n        <div id="${e}_character_select_container"></div>\n      </div>\n\n      \x3c!-- Pipeline Section --\x3e\n      <div class="${e}_section" id="${e}_pipeline_section">\n        <div class="${e}_section_header">\n          <i class="fa-solid fa-diagram-project"></i>\n          <span>Pipeline</span>\n        </div>\n        <div id="${e}_pipeline_nav_container"></div>\n      </div>\n\n      \x3c!-- Stage Config Section --\x3e\n      <div class="${e}_section" id="${e}_stage_section">\n        <div class="${e}_section_header">\n          <i class="fa-solid ${a.score}" id="${e}_stage_icon"></i>\n          <span id="${e}_stage_title">Score</span>\n        </div>\n        <div id="${e}_stage_config_container"></div>\n      </div>\n\n      \x3c!-- Results Section --\x3e\n      <div class="${e}_section ${e}_section_grow" id="${e}_results_section">\n        <div class="${e}_section_header">\n          <i class="fa-solid fa-file-lines"></i>\n          <span>Results</span>\n          <span id="${e}_iteration_indicator" class="${e}_iteration_indicator hidden"></span>\n        </div>\n        <div id="${e}_results_container"></div>\n        <div id="${e}_iteration_history_container"></div>\n      </div>\n    </div>\n  `}();new t(o.sanitize(l),n.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:!1,cancelButton:!1}).show().then((()=>{(null==at?void 0:at.abortController)&&at.abortController.abort(),at=null,ot=null,ct.forEach((e=>e())),ct.length=0,v("info","Event listeners unsubscribed",null),ft&&(document.removeEventListener("keydown",ft),ft=null),pt&&(document.removeEventListener("click",pt),pt=null),v("info","Popup closed",null)})),yield new Promise((e=>setTimeout(e,0))),ot=document.getElementById(`${e}_popup`),lt(),ft=e=>{at&&("Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),at.isGenerating||at.isRefining||ht(at.activeStageView)),"Escape"===e.key&&(at.isGenerating||at.isRefining)&&at.abortController&&at.abortController.abort())},document.addEventListener("keydown",ft),function(t){var n,s;if(!at||!ot)return;const a=ot.querySelector(`#${e}_character_select_container`);a&&(a.innerHTML=function(t,n){const s=null!==n?t[n]:null;return`\n    <div class="${e}_char_select">\n      \x3c!-- Search --\x3e\n      <div class="${e}_search_wrapper ${s?"hidden":""}">\n        <div class="${e}_search_container">\n          <i class="fa-solid fa-search ${e}_search_icon"></i>\n          <input\n            type="text"\n            id="${e}_char_search"\n            class="text_pole ${e}_search_input"\n            placeholder="Search characters..."\n            autocomplete="off"\n          >\n        </div>\n        <div id="${e}_char_dropdown" class="${e}_dropdown hidden"></div>\n      </div>\n\n      \x3c!-- Selected Character Preview --\x3e\n      ${s?ye(s):""}\n    </div>\n  `}(t,at.pipeline.characterIndex),function(t){if(!ot)return;const{Fuse:n,lodash:s}=SillyTavern.libs,r=ot.querySelector(`#${e}_character_select_container`);if(!r)return;const i=r.querySelector(`#${e}_char_search`),a=r.querySelector(`#${e}_char_dropdown`);if(!i||!a)return;let o=-1,c=[];const l=()=>{const s=((null==at?void 0:at.characters)||t).map(((e,t)=>({char:e,index:t}))).filter((({char:e})=>null==e?void 0:e.name)),r=new n(s,{keys:["char.name","char.description"],threshold:.4,includeScore:!0,minMatchCharLength:1}),l=i.value.trim();if(!l)return a.classList.add("hidden"),void(c=[]);const u=r.search(l,{limit:10});if(c=u.map((e=>e.item)),0===c.length)return a.innerHTML=`<div class="${e}_dropdown_empty">No characters found</div>`,void a.classList.remove("hidden");o=-1,$e(c,a,-1),a.classList.remove("hidden")},u=s.debounce(l,150);i.addEventListener("input",u),i.addEventListener("keydown",(e=>{0!==c.length&&("ArrowDown"===e.key?(e.preventDefault(),o=Math.min(o+1,c.length-1),$e(c,a,o)):"ArrowUp"===e.key?(e.preventDefault(),o=Math.max(o-1,0),$e(c,a,o)):"Enter"===e.key&&o>=0?(e.preventDefault(),gt(c[o].char,c[o].index),a.classList.add("hidden"),i.value=""):"Escape"===e.key&&(a.classList.add("hidden"),i.value=""))})),pt=e=>{i.contains(e.target)||a.contains(e.target)||a.classList.add("hidden")},document.addEventListener("click",pt),a.addEventListener("click",(t=>{const n=t.target.closest(`.${e}_dropdown_item`);if(n){const e=parseInt(n.getAttribute("data-index")||"-1",10),t=c.find((t=>t.index===e));t&&(gt(t.char,t.index),a.classList.add("hidden"),i.value="")}})),r.addEventListener("click",(t=>{const n=t.target;if(n.closest(`#${e}_char_clear`)){if(!at)return;return at.pipeline=Y(at.pipeline,null,null),void yt()}const s=n.closest(`.${e}_field_toggle`);if(s){const t=s.getAttribute("data-field"),n=r.querySelector(`#${e}_field_content_${t}`),i=s.querySelector("i");n&&i&&(n.classList.toggle("hidden"),i.classList.toggle("fa-chevron-right"),i.classList.toggle("fa-chevron-down"))}}))}(t));const o=ot.querySelector(`#${e}_pipeline_nav_container`);o&&(o.innerHTML=Se(at.pipeline.selectedStages,at.pipeline.stageStatus,at.activeStageView,!!at.pipeline.character),function(){if(!ot||!at)return;const t=ot.querySelector(`#${e}_pipeline_nav_container`);if(!t)return;t.addEventListener("change",(t=>{const n=t.target;if(n.classList.contains(`${e}_stage_checkbox`)){const e=n.getAttribute("data-stage");e&&at&&(at.pipeline=function(e,t){const n=new Set(e.selectedStages);n.has(t)?n.delete(t):n.add(t);const s=r.filter((e=>n.has(e)));return v("state","Stage toggled",{stage:t,selected:s}),Object.assign(Object.assign({},e),{selectedStages:s})}(at.pipeline,e),bt())}})),t.addEventListener("click",(t=>{const n=t.target.closest(`.${e}_stage_btn`);if(n&&at){const e=n.getAttribute("data-stage");e&&(at.activeStageView=e,St(),Ct(),Et(),bt())}t.target.closest(`#${e}_run_selected_btn`)&&vt();t.target.closest(`#${e}_run_all_btn`)&&function(){it(this,void 0,void 0,(function*(){at&&(at.pipeline.selectedStages=[...r],bt(),yield vt())}))}();t.target.closest(`#${e}_reset_pipeline_btn`)&&at&&(at.pipeline=function(e,t=!1){const n=X();return t&&e.character&&(n.character=e.character,n.characterIndex=e.characterIndex),v("state","Pipeline reset",{keepCharacter:t,hasCharacter:!!n.character}),n}(at.pipeline,!0),yt())}))}());const c=ot.querySelector(`#${e}_stage_config_container`);c&&(c.innerHTML=function(t,n,s){var r,a,o,c;const l=C(t),u=E(t);let d=n.customPrompt;if(n.promptPresetId){const e=x(n.promptPresetId);e&&(d=e.prompt)}let p=n.customSchema;if(n.schemaPresetId){const e=O(n.schemaPresetId);e&&(p=JSON.stringify(e.schema,null,2))}let f="",m={valid:!0};n.useStructuredOutput&&p.trim()&&(m=q(p),f=m.valid?(null===(r=m.warnings)||void 0===r?void 0:r.length)?`<div class="${e}_schema_status warning"><i class="fa-solid fa-triangle-exclamation"></i> ${m.warnings.length} warning(s)</div>`:`<div class="${e}_schema_status success"><i class="fa-solid fa-circle-check"></i> Valid schema</div>`:`<div class="${e}_schema_status error"><i class="fa-solid fa-circle-xmark"></i> ${Ee(m.error||"Invalid schema")}</div>`);let g='<i class="fa-solid fa-microchip"></i> Select a character',_="";s&&(g=`<i class="fa-solid fa-microchip"></i> ~${s.tokens.toLocaleString()} tokens (${s.percentage}%)`,s.percentage>80?_="danger":s.percentage>50&&(_="warning"));const h=n.promptPresetId?(null===(a=x(n.promptPresetId))||void 0===a?void 0:a.prompt)!==d:d.trim().length>0,v=n.schemaPresetId?JSON.stringify(null===(o=O(n.schemaPresetId))||void 0===o?void 0:o.schema,null,2)!==p:p.trim().length>0,y=n.useStructuredOutput&&p.trim()&&((null===(c=m.warnings)||void 0===c?void 0:c.length)||!m.valid);return`\n    <div class="${e}_stage_config">\n      \x3c!-- Prompt Section --\x3e\n      <div class="${e}_config_group">\n        <div class="${e}_config_header">\n          <span class="${e}_config_label">Prompt</span>\n          <div class="${e}_config_header_actions">\n            <button\n              id="${e}_save_prompt_preset_btn"\n              class="${e}_icon_btn"\n              title="Save as Preset"\n              ${h?"":"disabled"}\n            >\n              <i class="fa-solid fa-floppy-disk"></i>\n            </button>\n            <select id="${e}_prompt_preset_select" class="${e}_preset_select">\n              <option value="">Custom</option>\n              ${Pe(l,n.promptPresetId)}\n            </select>\n          </div>\n        </div>\n        <textarea\n          id="${e}_custom_prompt"\n          class="${e}_prompt_textarea text_pole"\n          placeholder="Enter your prompt for the ${i[t]} stage..."\n        >${Ee(d)}</textarea>\n        <div class="${e}_config_footer">\n          <span class="${e}_char_count">${d.length.toLocaleString()} chars</span>\n        </div>\n      </div>\n\n      \x3c!-- Structured Output Toggle --\x3e\n      <div class="${e}_config_group">\n        <label class="${e}_checkbox_label">\n          <input\n            type="checkbox"\n            id="${e}_use_structured"\n            ${n.useStructuredOutput?"checked":""}\n          >\n          <span>Use Structured Output (JSON Schema)</span>\n        </label>\n      </div>\n\n      \x3c!-- Schema Section --\x3e\n      <div class="${e}_schema_section ${n.useStructuredOutput?"":"hidden"}">\n        <div class="${e}_config_header">\n          <span class="${e}_config_label">JSON Schema</span>\n          <div class="${e}_config_header_actions">\n            <button\n              id="${e}_save_schema_preset_btn"\n              class="${e}_icon_btn"\n              title="Save as Preset"\n              ${v&&p.trim()?"":"disabled"}\n            >\n              <i class="fa-solid fa-floppy-disk"></i>\n            </button>\n            <select id="${e}_schema_preset_select" class="${e}_preset_select">\n              <option value="">Custom</option>\n              ${Pe(u,n.schemaPresetId)}\n            </select>\n          </div>\n        </div>\n        <textarea\n          id="${e}_custom_schema"\n          class="${e}_schema_textarea text_pole"\n          placeholder='{"name": "MySchema", "value": {"type": "object", ...}}'\n        >${Ee(p)}</textarea>\n        ${f}\n\n        \x3c!-- Schema Actions --\x3e\n        <div class="${e}_schema_actions">\n          <button\n            id="${e}_generate_schema_btn"\n            class="menu_button menu_button_icon"\n            title="Generate schema from description"\n          >\n            <i class="fa-solid fa-wand-magic-sparkles"></i>\n            <span>Generate</span>\n          </button>\n          <button\n            id="${e}_validate_schema_btn"\n            class="menu_button menu_button_icon"\n            title="Validate schema"\n            ${p.trim()?"":"disabled"}\n          >\n            <i class="fa-solid fa-check-double"></i>\n            <span>Validate</span>\n          </button>\n          <button\n            id="${e}_fix_schema_btn"\n            class="menu_button menu_button_icon"\n            title="Auto-fix schema (adds additionalProperties: false, etc.)"\n            ${y?"":"disabled"}\n          >\n            <i class="fa-solid fa-wrench"></i>\n            <span>Auto-Fix</span>\n          </button>\n          <button\n            id="${e}_format_schema_btn"\n            class="menu_button menu_button_icon"\n            title="Format/prettify JSON"\n            ${p.trim()?"":"disabled"}\n          >\n            <i class="fa-solid fa-align-left"></i>\n            <span>Format</span>\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Actions --\x3e\n      <div class="${e}_config_actions">\n        <div id="${e}_token_estimate" class="${e}_token_estimate ${_}">\n          ${g}\n        </div>\n      </div>\n    </div>\n  `}(at.activeStageView,at.pipeline.configs[at.activeStageView],null),function(){if(!ot||!at)return;const t=ot.querySelector(`#${e}_stage_config_container`);if(!t)return;t.addEventListener("change",(t=>{const n=t.target;if(n.id===`${e}_prompt_preset_select`&&at){const e=n.value||null;at.pipeline=ee(at.pipeline,at.activeStageView,{promptPresetId:e}),wt(),Et()}if(n.id===`${e}_schema_preset_select`&&at){const e=n.value||null;at.pipeline=ee(at.pipeline,at.activeStageView,{schemaPresetId:e}),wt()}}));const{lodash:n}=SillyTavern.libs;t.addEventListener("input",n.debounce((t=>{const n=t.target;n.id===`${e}_custom_prompt`&&at&&(at.pipeline=ee(at.pipeline,at.activeStageView,{customPrompt:n.value,promptPresetId:null}),Et(),wt()),n.id===`${e}_custom_schema`&&at&&(at.pipeline=ee(at.pipeline,at.activeStageView,{customSchema:n.value,schemaPresetId:null}),wt())}),300)),t.addEventListener("change",(t=>{const n=t.target;n.id===`${e}_use_structured`&&at&&(at.pipeline=ee(at.pipeline,at.activeStageView,{useStructuredOutput:n.checked}),wt())})),t.addEventListener("click",(t=>it(this,void 0,void 0,(function*(){const n=t.target;if(n.closest(`#${e}_run_stage_btn`)&&at)return void ht(at.activeStageView);if(n.closest(`#${e}_save_prompt_preset_btn`)&&at){const t=null==ot?void 0:ot.querySelector(`#${e}_custom_prompt`);if(t){const e=yield function(e,t){return we(this,void 0,void 0,(function*(){const{Popup:n,POPUP_RESULT:s}=SillyTavern.getContext();if(!t.trim())return toastr.warning("No prompt content to save"),{success:!1};const r=yield n.show.input("Save Prompt Preset","Enter a name for this preset:",`Custom ${i[e]} Prompt`);if(null===r||r===s.CANCELLED)return{success:!1};if(!r.trim())return toastr.warning("Preset name cannot be empty"),{success:!1};try{const n=P({name:r.trim(),prompt:t,stages:[e]});return toastr.success(`Prompt preset "${r}" saved`),{success:!0,presetId:n.id}}catch(e){return toastr.error(`Failed to save preset: ${e.message}`),{success:!1}}}))}(at.activeStageView,t.value);e.success&&e.presetId&&(at.pipeline=ee(at.pipeline,at.activeStageView,{promptPresetId:e.presetId,customPrompt:""}),wt())}return}if(n.closest(`#${e}_save_schema_preset_btn`)&&at){const t=null==ot?void 0:ot.querySelector(`#${e}_custom_schema`);if(t){const e=yield function(e,t){return we(this,void 0,void 0,(function*(){const{Popup:n,POPUP_RESULT:s}=SillyTavern.getContext();if(!t.trim())return toastr.warning("No schema content to save"),{success:!1};const r=q(t);if(!r.valid)return toastr.error(`Invalid schema: ${r.error}`),{success:!1};const a=yield n.show.input("Save Schema Preset","Enter a name for this preset:",`Custom ${i[e]} Schema`);if(null===a||a===s.CANCELLED)return{success:!1};if(!a.trim())return toastr.warning("Preset name cannot be empty"),{success:!1};try{const t=A({name:a.trim(),schema:r.schema,stages:[e]});return toastr.success(`Schema preset "${a}" saved`),{success:!0,presetId:t.id}}catch(e){return toastr.error(`Failed to save preset: ${e.message}`),{success:!1}}}))}(at.activeStageView,t.value);e.success&&e.presetId&&(at.pipeline=ee(at.pipeline,at.activeStageView,{schemaPresetId:e.presetId,customSchema:""}),wt())}return}if(n.closest(`#${e}_generate_schema_btn`)&&at){const t=yield Ce();if(t){const n=null==ot?void 0:ot.querySelector(`#${e}_custom_schema`);n&&(n.value=t,at.pipeline=ee(at.pipeline,at.activeStageView,{customSchema:t,schemaPresetId:null}),wt())}return}if(n.closest(`#${e}_validate_schema_btn`)&&at){const t=null==ot?void 0:ot.querySelector(`#${e}_custom_schema`);return void(t&&function(e){var t,n;if(!e.trim())return void toastr.warning("No schema to validate");const s=q(e);s.valid?(null===(t=s.warnings)||void 0===t?void 0:t.length)?toastr.warning(`Valid with ${s.warnings.length} warning(s):\n${s.warnings.join("\n")}`):(null===(n=s.info)||void 0===n?void 0:n.length)?toastr.success(`Valid!\n${s.info.join("\n")}`):toastr.success("Schema is valid!"):toastr.error(`Invalid: ${s.error}`)}(t.value))}if(n.closest(`#${e}_fix_schema_btn`)&&at){const t=null==ot?void 0:ot.querySelector(`#${e}_custom_schema`);if(t){const e=function(e){var t;if(!e.trim())return toastr.warning("No schema to fix"),null;const n=q(e);if(!n.schema)return toastr.error("Cannot fix: schema is not valid JSON or missing required structure"),null;try{const e=F(n.schema),s=JSON.stringify(e,null,2),r=q(s);return r.valid?(null===(t=r.warnings)||void 0===t?void 0:t.length)?toastr.info(`Fixed! ${r.warnings.length} warning(s) remain`):toastr.success("Schema fixed successfully!"):toastr.warning("Auto-fix applied but schema still has issues"),s}catch(e){return toastr.error(`Fix failed: ${e.message}`),null}}(t.value);e&&(t.value=e,at.pipeline=ee(at.pipeline,at.activeStageView,{customSchema:e,schemaPresetId:null}),wt())}return}if(n.closest(`#${e}_format_schema_btn`)&&at){const t=null==ot?void 0:ot.querySelector(`#${e}_custom_schema`);if(t){const e=function(e){if(!e.trim())return toastr.warning("No schema to format"),null;try{const t=JSON.parse(e),n=JSON.stringify(t,null,2);return toastr.success("Schema formatted"),n}catch(e){return toastr.error(`Cannot format: ${e.message}`),null}}(t.value);e&&(t.value=e,at.pipeline=ee(at.pipeline,at.activeStageView,{customSchema:e,schemaPresetId:null}),wt())}}else;}))))}());const l=ot.querySelector(`#${e}_results_container`);l&&(l.innerHTML=(u=at.activeStageView,d=at.pipeline.results[at.activeStageView],p=at.pipeline.stageStatus[at.activeStageView],at.isGenerating&&"running"===p?Ve(u):d?Ue(u,d):Fe(u,p)),function(){if(!ot||!at)return;const t=ot.querySelector(`#${e}_results_container`);if(!t)return;t.addEventListener("click",(t=>{const n=t.target;if(n.closest(`#${e}_regenerate_btn`)&&at&&(at.pipeline=function(e,t){return v("state","Stage result cleared",{stage:t}),Object.assign(Object.assign({},e),{results:Object.assign(Object.assign({},e.results),{[t]:null}),stageStatus:Object.assign(Object.assign({},e.stageStatus),{[t]:"pending"})})}(at.pipeline,at.activeStageView),ht(at.activeStageView)),n.closest(`#${e}_lock_btn`)&&at&&(at.pipeline=function(e,t){const n=e.results[t];return n?(v("state","Stage locked",{stage:t}),Object.assign(Object.assign({},e),{results:Object.assign(Object.assign({},e.results),{[t]:Object.assign(Object.assign({},n),{locked:!0})})})):e}(at.pipeline,at.activeStageView),Ct()),n.closest(`#${e}_unlock_btn`)&&at&&(at.pipeline=function(e,t){const n=e.results[t];return n?(v("state","Stage unlocked",{stage:t}),Object.assign(Object.assign({},e),{results:Object.assign(Object.assign({},e.results),{[t]:Object.assign(Object.assign({},n),{locked:!1})})})):e}(at.pipeline,at.activeStageView),Ct()),n.closest(`#${e}_continue_btn`)&&at){const e=re(at.pipeline,at.activeStageView);e&&(at.activeStageView=e,St(),Ct(),Et())}var s;if(n.closest(`#${e}_refine_btn`)&&at&&function(){it(this,void 0,void 0,(function*(){if(!at||at.isGenerating||at.isRefining)return;if(!pe())return void toastr.error("API is not connected");const t=Z(at.pipeline);if(!t.canRun)return void toastr.warning(t.reason||"Cannot refine");const n=function(e){const t=[],n=[];e.character||t.push("No character selected"),e.results.rewrite||t.push("No rewrite to refine"),e.results.analyze||t.push("Run analyze first to identify issues");const{onlineStatus:s}=SillyTavern.getContext();"Valid"!==s&&"Connected"!==s&&t.push("API is not connected");const r=e.iterationHistory.length>0?e.iterationHistory[e.iterationHistory.length-1]:null;return"accept"===(null==r?void 0:r.verdict)&&n.push("Last analysis suggested accepting the rewrite"),e.iterationCount>=5&&n.push(`Already at iteration ${e.iterationCount+1} - consider accepting or starting fresh`),{valid:0===t.length,errors:t,warnings:n}}(at.pipeline);if(!n.valid)return void toastr.error(n.errors.join("\n"));n.warnings.length>0&&toastr.warning(n.warnings.join("\n")),at.pipeline=se(at.pipeline),at.isRefining=!0,at.abortController=new AbortController;const s=null==ot?void 0:ot.querySelector(`#${e}_results_container`);var r;s&&(s.innerHTML=(r=at.pipeline.iterationCount,`\n    <div class="${e}_results_loading">\n      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>\n      <p>Refining (Iteration #${r+1})...</p>\n      <button id="${e}_cancel_btn" class="menu_button">\n        <i class="fa-solid fa-stop"></i>\n        <span>Cancel</span>\n      </button>\n    </div>\n  `)),xt(),Pt();try{const e=yield function(e,t){return ue(this,void 0,void 0,(function*(){const n=SillyTavern.getContext(),s=$();if(null==t?void 0:t.aborted)return{success:!1,error:"Generation cancelled"};if(!e.character)return{success:!1,error:"No character selected"};if(!e.results.rewrite||!e.results.analyze)return{success:!1,error:"Refinement requires both rewrite and analyze results"};if(!pe())return v("error","API not ready",{onlineStatus:n.onlineStatus}),{success:!1,error:"API is not connected. Check your connection settings."};const r=oe(e);if(!r)return{success:!1,error:"Failed to build refinement prompt"};const i=_e(r,e.character.name,n.name1||"User");return v("info","Starting refinement generation",{iteration:e.iterationCount+1,character:e.character.name,promptLength:i.length}),yield me(s.systemPrompt,i,null,t,s.useCurrentSettings)}))}(at.pipeline,at.abortController.signal);e.success?(at.pipeline=function(e,t){const n=Object.assign(Object.assign({},t),{timestamp:Date.now(),locked:!1});return v("state","Refinement completed",{iteration:e.iterationCount,responseLength:t.response.length}),Object.assign(Object.assign({},e),{currentStage:null,results:Object.assign(Object.assign({},e.results),{rewrite:n}),stageStatus:Object.assign(Object.assign({},e.stageStatus),{rewrite:"complete",analyze:"pending"})})}(at.pipeline,{response:e.response,isStructured:!1,promptUsed:"[Refinement prompt]",schemaUsed:null}),toastr.success(`Refinement #${at.pipeline.iterationCount} complete`),at.activeStageView="analyze"):"Generation cancelled"!==e.error&&toastr.error(e.error)}catch(e){toastr.error(e.message)}finally{at.isRefining=!1,at.abortController=null,yt()}}))}(),n.closest(`#${e}_accept_btn`)&&at&&(at.pipeline=(s=at.pipeline).results.rewrite?(v("state","Rewrite accepted as final",{iteration:s.iterationCount}),Object.assign(Object.assign({},s),{results:Object.assign(Object.assign({},s.results),{rewrite:Object.assign(Object.assign({},s.results.rewrite),{locked:!0})}),isRefining:!1})):s,toastr.success("Rewrite accepted as final"),yt()),n.closest(`#${e}_copy_btn`)&&at){const e=at.pipeline.results[at.activeStageView];e&&(navigator.clipboard.writeText(e.response),toastr.success("Copied to clipboard"))}n.closest(`#${e}_export_btn`)&&at&&(at.pipeline=le(at.pipeline),at.pipeline.exportData&&(navigator.clipboard.writeText(at.pipeline.exportData),toastr.success("Export copied to clipboard"))),n.closest(`#${e}_cancel_btn`)&&(null==at?void 0:at.abortController)&&at.abortController.abort()}))}());var u,d,p;const f=ot.querySelector(`#${e}_iteration_history_container`);f&&(f.innerHTML=Be(at.pipeline.iterationHistory,at.pipeline.iterationCount),function(){if(!ot||!at)return;const t=ot.querySelector(`#${e}_iteration_history_container`);if(!t)return;t.addEventListener("click",(t=>it(this,void 0,void 0,(function*(){const n=t.target,s=n.closest(`.${e}_iteration_revert_btn`);if(s&&at){const e=parseInt(s.getAttribute("data-index")||"-1",10);e>=0&&(yield _t(e))}const r=n.closest(`.${e}_iteration_view_btn`);if(r&&at){const t=parseInt(r.getAttribute("data-index")||"-1",10);t>=0&&t<at.pipeline.iterationHistory.length&&function(t){it(this,void 0,void 0,(function*(){const{Popup:n,POPUP_TYPE:s}=SillyTavern.getContext(),{DOMPurify:r}=SillyTavern.libs,i=function(t){return`\n    <div class="${e}_iteration_view">\n      <div class="${e}_iteration_view_header">\n        <h3>Iteration #${t.iteration+1}</h3>\n        <span class="${e}_iteration_verdict ${Xe(t.verdict)}">\n          <i class="fa-solid ${We(t.verdict)}"></i>\n          ${Ye(t.verdict)}\n        </span>\n        <span class="${e}_iteration_time">${new Date(t.timestamp).toLocaleString()}</span>\n      </div>\n\n      <div class="${e}_iteration_view_section">\n        <h4>Rewrite</h4>\n        <div class="${e}_iteration_view_content">\n          ${Ke(t.rewriteResponse)}\n        </div>\n      </div>\n\n      <div class="${e}_iteration_view_section">\n        <h4>Analysis</h4>\n        <div class="${e}_iteration_view_content">\n          ${Ke(t.analysisResponse)}\n        </div>\n      </div>\n    </div>\n  `}(t),a=new n(r.sanitize(i),s.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:"Close",cancelButton:!1});yield a.show()}))}(at.pipeline.iterationHistory[t])}}))))}());null===(n=ot.querySelector(`#${e}_settings_btn`))||void 0===n||n.addEventListener("click",(()=>{Ze((()=>{yt()}))})),null===(s=ot.querySelector(`#${e}_close_btn`))||void 0===s||s.addEventListener("click",(()=>{const e=null==ot?void 0:ot.closest(".popup");if(e){const t=e.querySelector(".popup-button-cancel, .popup-button-ok");null==t||t.click()}}))}(c),yt(),v("info","Popup opened",{characterCount:c.length})}))}function gt(t,n){at&&(at.pipeline=Y(at.pipeline,t,n),yt(),setTimeout((()=>it(this,void 0,void 0,(function*(){if(!ot||!(null==at?void 0:at.pipeline.character))return;const t=ot.querySelector(`#${e}_character_select_container`);if(t){const n=he(at.pipeline.character);yield function(t,n){return ve(this,void 0,void 0,(function*(){const{getTokenCountAsync:s}=SillyTavern.getContext();let r=0;for(const i of n){const n=t.querySelector(`.${e}_field_tokens[data-field="${i.key}"]`);if(n)try{const e=yield s(i.value);r+=e,n.textContent=`${e.toLocaleString()}t`}catch(e){n.textContent="?"}}const i=t.querySelector(`#${e}_total_tokens`);i&&(i.textContent=`${r.toLocaleString()} tokens`)}))}(t,n)}}))),50),v("info","Character selected",{name:t.name,index:n}))}function _t(e){return it(this,void 0,void 0,(function*(){if(!at)return;const{Popup:t,POPUP_RESULT:n}=SillyTavern.getContext();(yield t.show.confirm("Revert to Previous Iteration?",`This will restore the rewrite from iteration #${e+1} and discard later changes.`))===n.AFFIRMATIVE&&(at.pipeline=function(e,t){if(t<0||t>=e.iterationHistory.length)return v("error","Invalid iteration index",{iterationIndex:t,historyLength:e.iterationHistory.length}),e;const n=e.iterationHistory[t];v("state","Reverting to iteration",{iteration:n.iteration});const s={response:n.rewriteResponse,isStructured:!1,promptUsed:"[Restored from iteration history]",schemaUsed:null,timestamp:Date.now(),locked:!1},r=e.iterationHistory.slice(0,t);return Object.assign(Object.assign({},e),{results:Object.assign(Object.assign({},e.results),{rewrite:s,analyze:null}),stageStatus:Object.assign(Object.assign({},e.stageStatus),{rewrite:"complete",analyze:"pending"}),iterationCount:n.iteration,iterationHistory:r,isRefining:!0})}(at.pipeline,e),toastr.info(`Reverted to iteration #${e+1}`),yt())}))}function ht(e){return it(this,void 0,void 0,(function*(){if(!at||at.isGenerating||at.isRefining)return;if(!pe())return void toastr.error("API is not connected");const t=function(e,t){var n;if(!e.character)return{canRun:!1,reason:"No character selected"};switch(t){case"score":return{canRun:!0};case"rewrite":return e.selectedStages.includes("score")&&!(null===(n=e.results.score)||void 0===n?void 0:n.locked)?{canRun:!0,reason:"Score stage not complete - rewrite will run without score feedback"}:{canRun:!0};case"analyze":return e.results.rewrite?{canRun:!0}:{canRun:!1,reason:"Analyze requires rewrite results to compare"};default:return{canRun:!1,reason:"Unknown stage"}}}(at.pipeline,e);if(!t.canRun)return void toastr.warning(t.reason||"Cannot run this stage");t.reason&&toastr.info(t.reason),at.isGenerating=!0,at.abortController=new AbortController,at.pipeline=function(e,t){return v("state","Stage started",{stage:t}),Object.assign(Object.assign({},e),{currentStage:t,stageStatus:Object.assign(Object.assign({},e.stageStatus),{[t]:"running"})})}(at.pipeline,e),yt();const n=ae(at.pipeline,e)||"",s=ce(at.pipeline,e);try{const t=yield function(e,t,n){return ue(this,void 0,void 0,(function*(){const s=SillyTavern.getContext(),r=$();if(null==n?void 0:n.aborted)return{success:!1,error:"Generation cancelled"};if(!e.character)return{success:!1,error:"No character selected"};if(!pe())return v("error","API not ready",{onlineStatus:s.onlineStatus}),{success:!1,error:"API is not connected. Check your connection settings."};const i=ae(e,t);if(!i)return{success:!1,error:"No prompt configured for this stage"};const a=e.configs[t].useStructuredOutput?ce(e,t):null,o=_e(i,e.character.name,s.name1||"User");return v("info","Starting stage generation",{stage:t,character:e.character.name,useCurrentSettings:r.useCurrentSettings,useStructured:!!a,schemaName:null==a?void 0:a.name,promptLength:o.length}),yield me(r.systemPrompt,o,a,n,r.useCurrentSettings)}))}(at.pipeline,e,at.abortController.signal);t.success?(at.pipeline=function(e,t,n){const s=Object.assign(Object.assign({},n),{timestamp:Date.now(),locked:!1});v("state","Stage completed",{stage:t,responseLength:n.response.length,isStructured:n.isStructured});const r="analyze"===t&&null!==e.results.rewrite;return Object.assign(Object.assign({},e),{currentStage:null,stageStatus:Object.assign(Object.assign({},e.stageStatus),{[t]:"complete"}),results:Object.assign(Object.assign({},e.results),{[t]:s}),isRefining:r})}(at.pipeline,e,{response:t.response,isStructured:t.isStructured,promptUsed:n,schemaUsed:s}),toastr.success(`${i[e]} complete`)):(at.pipeline=te(at.pipeline,e,t.error),"Generation cancelled"!==t.error&&toastr.error(t.error))}catch(t){at.pipeline=te(at.pipeline,e,t.message),toastr.error(t.message)}finally{at.isGenerating=!1,at.abortController=null,yt()}}))}function vt(){return it(this,void 0,void 0,(function*(){if(!at||at.isGenerating||at.isRefining)return;if(!pe())return void toastr.error("API is not connected");const e=function(e){const t=[],n=[];e.character||t.push("No character selected"),0===e.selectedStages.length&&t.push("No stages selected");for(const s of e.selectedStages)G(e.configs[s]).trim()||t.push(`${s}: No prompt configured`),"rewrite"===s&&!e.results.score&&e.selectedStages.includes("score")&&n.push("Rewrite will run without score feedback (score not complete)"),"analyze"!==s||e.results.rewrite||t.push("Analyze requires rewrite results");const{onlineStatus:s}=SillyTavern.getContext();return"Valid"!==s&&"Connected"!==s&&t.push("API is not connected"),{valid:0===t.length,errors:t,warnings:n}}(at.pipeline);if(e.valid){e.warnings.length>0&&toastr.warning(e.warnings.join("\n"));for(const e of at.pipeline.selectedStages){const t=at.pipeline.stageStatus[e];if("complete"===t||"skipped"===t)continue;if(at.activeStageView=e,St(),yield ht(e),!at)break;if("complete"!==at.pipeline.stageStatus[e])break}}else toastr.error(e.errors.join("\n"))}))}function yt(){$t(),bt(),St(),Ct(),Et(),xt(),Pt()}function $t(){if(!ot||!at)return;const t=ot.querySelector(`#${e}_character_select_container`);t&&function(t,n,s){const r=t.querySelector(`.${e}_search_wrapper`),i=t.querySelector(`#${e}_char_preview`);if(n){if(null==r||r.classList.add("hidden"),!i){const s=ye(n),r=t.querySelector(`.${e}_search_wrapper`);r&&r.insertAdjacentHTML("afterend",s)}}else{null==r||r.classList.remove("hidden"),null==i||i.remove();const n=t.querySelector(`#${e}_char_search`);n&&(n.value="")}}(t,at.pipeline.character,at.pipeline.characterIndex)}function bt(){if(!ot||!at)return;const t=ot.querySelector(`#${e}_pipeline_nav_container`);t&&function(t,n,s,i,a,o){for(const a of r){const r=t.querySelector(`#${e}_stage_cb_${a}`),o=t.querySelector(`.${e}_stage_btn[data-stage="${a}"]`),c=t.querySelector(`.${e}_stage_node:has([data-stage="${a}"])`);if(r&&(r.checked=n.includes(a)),o&&o.classList.toggle("active",a===i),c){c.classList.toggle("active",a===i);for(const t of["pending","running","complete","skipped"])c.classList.toggle(`${e}_stage_${t}`,s[a]===t)}const l=null==c?void 0:c.querySelector(`.${e}_stage_connector`);null==l||l.classList.toggle("active",n.includes(a))}const c=t.querySelector(`#${e}_run_selected_btn`),l=t.querySelector(`#${e}_run_all_btn`),u=t.querySelector(`#${e}_reset_pipeline_btn`);c&&(c.disabled=!a||o),l&&(l.disabled=!a||o),u&&(u.disabled=o)}(t,at.pipeline.selectedStages,at.pipeline.stageStatus,at.activeStageView,!!at.pipeline.character&&pe(),at.isGenerating||at.isRefining)}function St(){if(!ot||!at)return;const t=ot.querySelector(`#${e}_stage_icon`),n=ot.querySelector(`#${e}_stage_title`);t&&(t.className=`fa-solid ${a[at.activeStageView]}`),n&&(n.textContent=i[at.activeStageView]),wt()}function wt(){if(!ot||!at)return;const t=ot.querySelector(`#${e}_stage_config_container`);t&&xe(t,at.activeStageView,at.pipeline.configs[at.activeStageView],at.isGenerating||at.isRefining)}function Ct(){if(!ot||!at)return;const t=ot.querySelector(`#${e}_results_container`);t&&Ge(t,at.activeStageView,at.pipeline.results[at.activeStageView],at.pipeline.stageStatus[at.activeStageView],at.isGenerating,re(at.pipeline,at.activeStageView),at.pipeline)}function xt(){if(!ot||!at)return;const t=ot.querySelector(`#${e}_iteration_indicator`);t&&(at.pipeline.iterationCount>0||at.pipeline.isRefining?(t.classList.remove("hidden"),t.innerHTML=`\n      <i class="fa-solid fa-arrows-rotate"></i>\n      Iteration #${at.pipeline.iterationCount+1}\n    `):t.classList.add("hidden"))}function Pt(){if(!ot||!at)return;const t=ot.querySelector(`#${e}_iteration_history_container`);t&&function(t,n,s){const r=t.querySelector(`#${e}_iteration_history`);if(!r&&(n.length>0||s>0)){const e=Be(n,s);t.insertAdjacentHTML("beforeend",e)}else if(r){const t=r.querySelector(`.${e}_iteration_count`);t&&(t.textContent=s>0?`Current: #${s+1}`:"Initial");const i=r.querySelector(`.${e}_iteration_list`);i&&(0===n.length?i.innerHTML=`<div class="${e}_iteration_empty">No previous iterations</div>`:i.innerHTML=n.map(((e,t)=>Je(e,t,n.length))).join(""))}}(t,at.pipeline.iterationHistory,at.pipeline.iterationCount)}function Et(){return it(this,void 0,void 0,(function*(){if(!ot||!at)return;const t=ot.querySelector(`#${e}_token_estimate`);if(!t)return;if(!at.pipeline.character)return t.innerHTML='<i class="fa-solid fa-microchip"></i> Select a character',void(t.className=`${e}_token_estimate`);let n;if(t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>',t.className=`${e}_token_estimate`,n=at.pipeline.isRefining&&at.pipeline.results.rewrite&&at.pipeline.results.analyze?yield function(e){return ue(this,void 0,void 0,(function*(){const{getTokenCountAsync:t,maxContext:n}=SillyTavern.getContext(),s=$();if(!e.character||!e.results.rewrite||!e.results.analyze)return null;try{const r=oe(e);if(!r)return null;const i=s.systemPrompt+"\n\n"+r,a=yield t(i);return{promptTokens:a,contextSize:n,percentage:Math.round(a/n*100)}}catch(e){return v("error","Refinement token count failed",e),null}}))}(at.pipeline):yield function(e,t){return ue(this,void 0,void 0,(function*(){const{getTokenCountAsync:n,maxContext:s}=SillyTavern.getContext(),r=$();if(!e.character)return null;try{const i=ae(e,t);if(!i)return null;const a=r.systemPrompt+"\n\n"+i,o=yield n(a);return{promptTokens:o,contextSize:s,percentage:Math.round(o/s*100)}}catch(e){return v("error","Token count failed",e),null}}))}(at.pipeline,at.activeStageView),!at||!ot)return;if(!n)return t.innerHTML='<i class="fa-solid fa-microchip"></i> --',void(t.className=`${e}_token_estimate`);let s="";n.percentage>100?s="danger":n.percentage>80&&(s="warning"),t.innerHTML=`<i class="fa-solid fa-microchip"></i> ${n.promptTokens.toLocaleString()}t (${n.percentage}%)`,t.className=`${e}_token_estimate ${s}`}))}var Ot=function(e,t,n,s){return new(n||(n=Promise))((function(r,i){function a(e){try{c(s.next(e))}catch(e){i(e)}}function o(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((s=s.apply(e,t||[])).next())}))};function At(){return Ot(this,void 0,void 0,(function*(){const{renderExtensionTemplateAsync:n}=SillyTavern.getContext(),s=document.getElementById("extensions_settings");if(s)try{const r=yield n(t,"templates/panel",{},!0),i=document.createElement("div");i.id=`${e}_wrapper`,i.innerHTML=r,s.appendChild(i),function(){const t=document.getElementById(`${e}_open_btn`);null==t||t.addEventListener("click",(()=>{mt()}));const n=document.getElementById(`${e}_debug_toggle`);n&&(n.checked=$().debugMode,n.addEventListener("change",(()=>{w(n.checked),toastr.info("Debug mode "+(n.checked?"enabled":"disabled"))})))}(),v("info","Panel initialized",null)}catch(t){console.error(`[${e}] Failed to load panel template:`,t)}else console.error(`[${e}] Extensions container not found`)}))}const{eventSource:kt,eventTypes:Rt}=SillyTavern.getContext();kt.on(Rt.APP_READY,(function(){v("info","Extension initializing",{version:"2.0.0"}),At(),function(){const{eventSource:e,eventTypes:t}=SillyTavern.getContext();e.on(t.CHATCOMPLETION_SOURCE_CHANGED,(()=>{v("info","Chat completion source changed",null)})),e.on(t.CHATCOMPLETION_MODEL_CHANGED,(()=>{v("info","Chat completion model changed",null)})),v("info","Event listeners registered",null)}(),v("info","Extension loaded",$())}))})();