(()=>{"use strict";const e="character_tools",t="1.0.0",n=Object.freeze([{key:"description",label:"Description",path:"description",type:"string"},{key:"personality",label:"Personality",path:"personality",type:"string"},{key:"first_mes",label:"First Message",path:"first_mes",type:"string"},{key:"scenario",label:"Scenario",path:"scenario",type:"string"},{key:"mes_example",label:"Example Messages",path:"mes_example",type:"string"},{key:"system_prompt",label:"System Prompt",path:"data.system_prompt",type:"string"},{key:"post_history_instructions",label:"Post-History Instructions",path:"data.post_history_instructions",type:"string"},{key:"creator_notes",label:"Creator Notes",path:"data.creator_notes",type:"string"},{key:"alternate_greetings",label:"Alternate Greetings",path:"data.alternate_greetings",type:"array"},{key:"depth_prompt",label:"Depth Prompt",path:"data.extensions.depth_prompt",type:"object"},{key:"character_book",label:"Character Lorebook",path:"data.character_book",type:"object"}]),s=Object.freeze(["score","rewrite","analyze"]),r={score:"Score",rewrite:"Rewrite",analyze:"Analyze"},i={score:"fa-star-half-stroke",rewrite:"fa-pen-fancy",analyze:"fa-magnifying-glass-chart"},a="You are a character card analyst and writer. You help improve roleplay character cards by providing specific, actionable feedback and high-quality rewrites.\n\nKey principles:\n- Preserve the character's core identity and unique traits\n- Be specific - vague feedback is useless\n- Quality over quantity - concise and impactful\n- Maintain consistency across all fields",o="You are refining a character card based on analysis feedback. Your goal is to address identified issues while preserving what works.\n\nKey principles:\n- Fix specific problems from the analysis\n- Keep improvements from previous iterations\n- Maintain the character's essential identity\n- Don't reintroduce previously fixed issues",c=Object.freeze([{id:"builtin_score_default",name:"Default Score",stages:["score"],isBuiltin:!0,presetVersion:1,createdAt:0,updatedAt:0,prompt:"Rate this character card on a scale of 1-10 for each field provided. For each field:\n\n1. **Score** (1-10)\n2. **Strengths** - What works well\n3. **Weaknesses** - What needs improvement\n4. **Specific Suggestions** - Concrete changes\n\nAfter scoring all fields, provide:\n- **Overall Score** (weighted average)\n- **Top 3 Priority Improvements**\n- **Summary**\n\nBe critical but constructive. Specific, actionable feedback."},{id:"builtin_score_quick",name:"Quick Score",stages:["score"],isBuiltin:!0,presetVersion:1,createdAt:0,updatedAt:0,prompt:"Give a quick assessment:\n\n1. Overall score (1-10)\n2. Three biggest strengths\n3. Three areas needing work\n4. One-sentence summary\n\nKeep it concise but useful."},{id:"builtin_rewrite_default",name:"Default Rewrite",stages:["rewrite"],isBuiltin:!0,presetVersion:1,createdAt:0,updatedAt:0,prompt:"Rewrite this character card to address the weaknesses identified while preserving its strengths.\n\nGuidelines:\n- Maintain the character's core personality and unique traits\n- Improve weak areas identified in the feedback\n- Keep similar length unless brevity/expansion was noted\n- Preserve distinctive voice or style that works\n- Fix contradictions and fill gaps\n\nOutput the complete rewritten character with all fields."},{id:"builtin_rewrite_conservative",name:"Conservative Rewrite",stages:["rewrite"],isBuiltin:!0,presetVersion:1,createdAt:0,updatedAt:0,prompt:"Make minimal, surgical improvements. Only change what's clearly broken or weak.\n\nRules:\n- Change as little as possible\n- Preserve the author's voice completely\n- Only fix obvious issues (contradictions, grammar, clarity)\n- Do NOT add new content unless filling a critical gap\n- Do NOT change style or tone\n\nOutput only the fields you changed, with [ORIGINAL] and [REVISED] versions for comparison."},{id:"builtin_rewrite_expansive",name:"Expansive Rewrite",stages:["rewrite"],isBuiltin:!0,presetVersion:1,createdAt:0,updatedAt:0,prompt:"Significantly expand and enhance this character card. Add depth, detail, and richness.\n\nGoals:\n- Flesh out underdeveloped areas\n- Add sensory details and specific examples\n- Deepen personality with quirks, contradictions, history\n- Improve example messages with more variety\n- Make the character feel more three-dimensional\n\nDon't change the core concept, but make it shine. Output the complete expanded character card."},{id:"builtin_analyze_default",name:"Default Analyze",stages:["analyze"],isBuiltin:!0,presetVersion:1,createdAt:0,updatedAt:0,prompt:"Compare the original character card with the rewritten version.\n\n## What Was Preserved\nCore traits, distinctive elements, voice consistency\n\n## What Was Lost\nDiminished personality aspects, missing quirks, tone shifts\n\n## What Was Gained\nNew depth, improvements, better clarity\n\n## Soul Check\nDoes the rewrite still feel like the same character? Rate 1-10.\n\n## Verdict\nState clearly: **ACCEPT** (ready to use), **NEEDS_REFINEMENT** (has issues), or **REGRESSION** (worse than before)\n\n## Issues to Address\nIf NEEDS_REFINEMENT, list specific problems for next iteration."},{id:"builtin_analyze_iteration",name:"Iteration Analyze",stages:["analyze"],isBuiltin:!0,presetVersion:1,createdAt:0,updatedAt:0,prompt:"Compare the current rewrite against the original.\n\n## Progress Check\n- What issues from previous analysis were addressed?\n- What new issues (if any) were introduced?\n- Is this version better, worse, or lateral move?\n\n## Current State\n- Preserved from Original\n- Still Missing or Lost\n- Successfully Improved\n- New Problems\n\n## Soul Preservation Score (1-10)\n\n## Verdict\n**ACCEPT** - Ready, no more iterations needed\n**NEEDS_REFINEMENT** - Progress, but issues remain\n**REGRESSION** - Made things worse\n\n## Next Steps\nIf NEEDS_REFINEMENT: What to fix next.\nIf REGRESSION: What went wrong."},{id:"builtin_analyze_quick",name:"Quick Analyze",stages:["analyze"],isBuiltin:!0,presetVersion:1,createdAt:0,updatedAt:0,prompt:"Quick comparison:\n\n1. Soul preserved? (Yes/Partially/No)\n2. Best improvement made\n3. Biggest thing lost (if any)\n4. Verdict: ACCEPT / NEEDS_REFINEMENT / REGRESSION"},{id:"builtin_freeform",name:"Freeform",stages:[],isBuiltin:!0,presetVersion:1,createdAt:0,updatedAt:0,prompt:""}]),l=Object.freeze([{id:"builtin_schema_score",name:"Default Score",stages:["score"],isBuiltin:!0,presetVersion:1,createdAt:0,updatedAt:0,schema:{name:"CharacterScore",strict:!0,value:{$schema:"http://json-schema.org/draft-04/schema#",type:"object",additionalProperties:!1,properties:{fieldScores:{type:"array",items:{type:"object",additionalProperties:!1,properties:{field:{type:"string"},score:{type:"number"},strengths:{type:"string"},weaknesses:{type:"string"},suggestions:{type:"string"}},required:["field","score","strengths","weaknesses","suggestions"]}},overallScore:{type:"number"},priorityImprovements:{type:"array",items:{type:"string"}},summary:{type:"string"}},required:["fieldScores","overallScore","priorityImprovements","summary"]}}},{id:"builtin_schema_quick_score",name:"Quick Score",stages:["score"],isBuiltin:!0,presetVersion:1,createdAt:0,updatedAt:0,schema:{name:"QuickScore",strict:!0,value:{$schema:"http://json-schema.org/draft-04/schema#",type:"object",additionalProperties:!1,properties:{overallScore:{type:"number"},strengths:{type:"array",items:{type:"string"}},weaknesses:{type:"array",items:{type:"string"}},summary:{type:"string"}},required:["overallScore","strengths","weaknesses","summary"]}}},{id:"builtin_schema_analyze",name:"Default Analyze",stages:["analyze"],isBuiltin:!0,presetVersion:1,createdAt:0,updatedAt:0,schema:{name:"CharacterAnalysis",strict:!0,value:{$schema:"http://json-schema.org/draft-04/schema#",type:"object",additionalProperties:!1,properties:{preserved:{type:"array",items:{type:"string"}},lost:{type:"array",items:{type:"string"}},gained:{type:"array",items:{type:"string"}},soulPreservationScore:{type:"number"},soulAssessment:{type:"string"},verdict:{type:"string",enum:["ACCEPT","NEEDS_REFINEMENT","REGRESSION"]},issuesToAddress:{type:"array",items:{type:"string"}},recommendations:{type:"array",items:{type:"string"}}},required:["preserved","lost","gained","soulPreservationScore","soulAssessment","verdict","issuesToAddress","recommendations"]}}}]),u={score:{promptPresetId:"builtin_score_default",customPrompt:"",schemaPresetId:"builtin_schema_score",customSchema:"",useStructuredOutput:!1},rewrite:{promptPresetId:"builtin_rewrite_default",customPrompt:"",schemaPresetId:null,customSchema:"",useStructuredOutput:!1},analyze:{promptPresetId:"builtin_analyze_default",customPrompt:"",schemaPresetId:"builtin_schema_analyze",customSchema:"",useStructuredOutput:!1}},d={source:"openrouter",model:"anthropic/claude-sonnet-4",temperature:1,maxTokens:4096,frequencyPenalty:0,presencePenalty:0,topP:1},p=Object.freeze({useCurrentSettings:!0,generationConfig:d,baseSystemPrompt:a,userSystemPrompt:"",baseRefinementPrompt:o,userRefinementPrompt:"",stageSystemPrompts:{score:"",rewrite:"",analyze:""},promptPresets:[...c],schemaPresets:[...l],stageDefaults:u,debugMode:!1,settingsVersion:4}),f={ORIGINAL_CHARACTER:"{{original_character}}",SCORE_RESULTS:"{{score_results}}",REWRITE_RESULTS:"{{rewrite_results}}",CURRENT_REWRITE:"{{current_rewrite}}",CURRENT_ANALYSIS:"{{current_analysis}}",ITERATION_NUMBER:"{{iteration_number}}",CHARACTER_NAME:"{{char_name}}",USER_NAME:"{{user_name}}"},m=[];function _(t,n,s){const r={timestamp:new Date,type:t,label:n,data:s};if(m.unshift(r),m.length>100&&m.pop(),"error"!==t){if(function(){try{return y().debugMode}catch(e){return!1}}()){const r=`[${e}:${t.toUpperCase()}]`;console.debug(r,n,s)}}else console.error(`[${e}:ERROR]`,n,s)}function g(e,t){_("error",e,t)}function h(){return JSON.stringify(function(){var e,t,n,s,r,i,a,o,c,l,u,d;const p=SillyTavern.getContext();let f;try{f=y()}catch(e){f={error:"Failed to load settings"}}return{extension:{settings:{useCurrentSettings:f.useCurrentSettings,debugMode:f.debugMode,generationConfig:f.generationConfig,baseSystemPromptLength:(null===(e=f.baseSystemPrompt)||void 0===e?void 0:e.length)||0,userSystemPromptLength:(null===(t=f.userSystemPrompt)||void 0===t?void 0:t.length)||0,baseRefinementPromptLength:(null===(n=f.baseRefinementPrompt)||void 0===n?void 0:n.length)||0,userRefinementPromptLength:(null===(s=f.userRefinementPrompt)||void 0===s?void 0:s.length)||0,promptPresetCount:(null===(r=f.promptPresets)||void 0===r?void 0:r.length)||0,schemaPresetCount:(null===(i=f.schemaPresets)||void 0===i?void 0:i.length)||0}},sillytavern:{mainApi:p.mainApi,onlineStatus:p.onlineStatus,chatCompletionSource:null===(a=p.chatCompletionSettings)||void 0===a?void 0:a.chat_completion_source,currentModel:(null===(o=p.chatCompletionSettings)||void 0===o?void 0:o.openrouter_model)||(null===(c=p.chatCompletionSettings)||void 0===c?void 0:c.model_openai_select),maxContext:p.maxContext,characterCount:null!==(u=null===(l=p.characters)||void 0===l?void 0:l.length)&&void 0!==u?u:0,hasActiveChat:!!(null===(d=p.chat)||void 0===d?void 0:d.length)},logs:{total:m.length,errors:m.filter(e=>"error"===e.type).length,recent:m.slice(0,10).map(e=>({type:e.type,label:e.label,time:e.timestamp.toISOString()}))}}}(),null,2)}const v={2:e=>{const t=e;void 0!==t.useRawMode&&(e.useCurrentSettings=!t.useRawMode,delete t.useRawMode),void 0!==t.jsonSchema&&delete t.jsonSchema,void 0!==t.useStructuredOutput&&(e.stageDefaults||(e.stageDefaults=structuredClone(u)),e.stageDefaults.score.useStructuredOutput=!!t.useStructuredOutput,delete t.useStructuredOutput)},3:e=>{},4:e=>{const t=e;if(void 0!==t.systemPrompt){const n=t.systemPrompt;n&&n.trim()&&(e.userSystemPrompt=n),e.baseSystemPrompt=a,delete t.systemPrompt}if(void 0!==t.refinementPrompt){const n=t.refinementPrompt;n&&n.trim()&&(e.userRefinementPrompt=n),e.baseRefinementPrompt=o,delete t.refinementPrompt}if(e.stageSystemPrompts||(e.stageSystemPrompts={score:"",rewrite:"",analyze:""}),e.promptPresets)for(const t of e.promptPresets)void 0===t.presetVersion&&(t.presetVersion=0);if(e.schemaPresets)for(const t of e.schemaPresets)void 0===t.presetVersion&&(t.presetVersion=0)}};function y(){const{extensionSettings:t,saveSettingsDebounced:n}=SillyTavern.getContext(),{lodash:s}=SillyTavern.libs;if(!t[e])return _("info","Initializing settings with defaults",null),t[e]=structuredClone(p),n(),t[e];const r=t[e],i=r.settingsVersion||1;let a=!1;i<4&&(a=function(e,t){let n=!1;for(let s=t+1;s<=4;s++){const t=v[s];t&&(_("info",`Running migration to v${s}`,null),t(e),n=!0)}return n}(r,i),r.settingsVersion=4);const o=s.merge(structuredClone(p),r),u=function(e){let t=!1;const n=new Set(e.promptPresets.map(e=>e.id));for(const s of c)n.has(s.id)||(e.promptPresets.push(structuredClone(s)),t=!0);const s=new Set(e.schemaPresets.map(e=>e.id));for(const n of l)s.has(n.id)||(e.schemaPresets.push(structuredClone(n)),t=!0);return t}(o);return a=a||u,t[e]=o,a&&n(),o}function $(t,n){const{extensionSettings:s,saveSettingsDebounced:r}=SillyTavern.getContext();s[e][t]=n,r(),_("info","Setting updated",{key:t,value:"object"==typeof n?"[object]":n})}function b(t){const{extensionSettings:n,saveSettingsDebounced:s}=SillyTavern.getContext(),r=n[e];r.generationConfig||(r.generationConfig=structuredClone(d)),r.generationConfig=Object.assign(Object.assign({},r.generationConfig),t),s(),_("info","Generation config updated",t)}function S(e){var t,n,s,r;const i=y(),a=[];return(null===(t=i.baseSystemPrompt)||void 0===t?void 0:t.trim())&&a.push(i.baseSystemPrompt.trim()),(null===(n=i.userSystemPrompt)||void 0===n?void 0:n.trim())&&a.push(i.userSystemPrompt.trim()),e&&(null===(r=null===(s=i.stageSystemPrompts)||void 0===s?void 0:s[e])||void 0===r?void 0:r.trim())&&a.push(i.stageSystemPrompts[e].trim()),a.join("\n\n")}function w(t,n){const{extensionSettings:s,saveSettingsDebounced:r}=SillyTavern.getContext(),i=s[e];i.stageSystemPrompts||(i.stageSystemPrompts={score:"",rewrite:"",analyze:""}),i.stageSystemPrompts[t]=n,r()}function C(e){$("debugMode",e)}function x(e){const t=y();return e?t.promptPresets.filter(t=>0===t.stages.length||t.stages.includes(e)):t.promptPresets}function E(e){return y().promptPresets.find(t=>t.id===e)||null}function P(t){const{extensionSettings:n,saveSettingsDebounced:s}=SillyTavern.getContext(),r=n[e],{uuidv4:i}=SillyTavern.getContext(),a=Date.now(),o=Object.assign(Object.assign({},t),{id:`custom_prompt_${i()}`,isBuiltin:!1,presetVersion:1,createdAt:a,updatedAt:a});return r.promptPresets.push(o),s(),_("info","Prompt preset saved",{id:o.id,name:o.name}),o}function A(e){const t=y();return e?t.schemaPresets.filter(t=>0===t.stages.length||t.stages.includes(e)):t.schemaPresets}function R(e){return y().schemaPresets.find(t=>t.id===e)||null}function O(t){const{extensionSettings:n,saveSettingsDebounced:s}=SillyTavern.getContext(),r=n[e],{uuidv4:i}=SillyTavern.getContext(),a=k(t.schema),o=Date.now(),c=Object.assign(Object.assign({},t),{schema:a,id:`custom_schema_${i()}`,isBuiltin:!1,presetVersion:1,createdAt:o,updatedAt:o});return r.schemaPresets.push(c),s(),_("info","Schema preset saved",{id:c.id,name:c.name}),c}function k(e){const t=structuredClone(e);return I(t.value),t}function I(e){if("object"===e.type&&(e.additionalProperties=!1,e.properties&&"object"==typeof e.properties))for(const t of Object.values(e.properties))t&&"object"==typeof t&&I(t);if("array"===e.type&&e.items&&"object"==typeof e.items&&(Array.isArray(e.items)?e.items.forEach(e=>{e&&"object"==typeof e&&I(e)}):I(e.items)),e.anyOf&&Array.isArray(e.anyOf)&&e.anyOf.forEach(e=>{e&&"object"==typeof e&&I(e)}),e.allOf&&Array.isArray(e.allOf)&&e.allOf.forEach(e=>{e&&"object"==typeof e&&I(e)}),e.$defs&&"object"==typeof e.$defs)for(const t of Object.values(e.$defs))t&&"object"==typeof t&&I(t);if(e.definitions&&"object"==typeof e.definitions)for(const t of Object.values(e.definitions))t&&"object"==typeof t&&I(t)}var T=function(e,t,n,s){return new(n||(n=Promise))(function(r,i){function a(e){try{c(s.next(e))}catch(e){i(e)}}function o(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,o)}c((s=s.apply(e,t||[])).next())})};const L=8,j=100,N=10,q=100,D=500,M=["date-time","time","date","duration","email","hostname","uri","ipv4","ipv6","uuid"],z=[0,1],H=["minimum","maximum","exclusiveMinimum","exclusiveMaximum","multipleOf"],V=["minLength","maxLength"],F=["maxItems","uniqueItems","contains","minContains","maxContains"],U=["minProperties","maxProperties","propertyNames","patternProperties"],G=["if","then","else","not","oneOf","dependentRequired","dependentSchemas","unevaluatedProperties","unevaluatedItems","$dynamicRef","$dynamicAnchor"],B=[{pattern:/\(\?[=!<]/,name:"lookahead/lookbehind assertions"},{pattern:/\\[1-9]/,name:"backreferences"},{pattern:/\\[bB]/,name:"word boundaries"}];function Y(e){var t;if(!e.trim())return{valid:!0,schema:void 0};let n;try{n=JSON.parse(e)}catch(e){const t=e instanceof Error?e.message:"Invalid JSON",n=t.match(/position (\d+)/);return{valid:!1,error:`JSON syntax error${n?` (character ${n[1]})`:""}: ${t}`}}if("object"!=typeof n||null===n||Array.isArray(n))return{valid:!1,error:"Schema must be a JSON object, not "+(Array.isArray(n)?"array":typeof n)};const s=n;if("string"!=typeof s.name)return{valid:!1,error:"Missing required 'name' property (string)"};if(!s.name.trim())return{valid:!1,error:"'name' cannot be empty"};if(!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(s.name))return{valid:!1,error:`'name' must be a valid identifier (got '${s.name}'). Use letters, numbers, underscores; start with letter or underscore.`};if("object"!=typeof s.value||null===s.value||Array.isArray(s.value))return{valid:!1,error:"Missing or invalid 'value' property (must be object)"};const r=s.value;if("string"!=typeof r.type&&!r.anyOf&&!r.allOf&&!r.$ref)return{valid:!1,error:"'value' must have a 'type', 'anyOf', 'allOf', or '$ref'"};if(void 0!==s.strict&&"boolean"!=typeof s.strict)return{valid:!1,error:"'strict' must be a boolean if provided"};const i={errors:[],warnings:[],info:[],stats:{defCount:0,anyOfCount:0,totalAnyOfVariants:0,maxDepth:0,propertyCount:0,optionalFieldCount:0,enumCount:0},currentDepth:0,seenRefs:new Set,defs:{}};if(r.$defs&&"object"==typeof r.$defs?(i.defs=r.$defs,i.stats.defCount=Object.keys(i.defs).length):r.definitions&&"object"==typeof r.definitions&&(i.defs=r.definitions,i.stats.defCount=Object.keys(i.defs).length),i.stats.defCount>j&&i.errors.push(`Too many definitions: ${i.stats.defCount} (limit: ${j})`),W(r,"value",i),i.stats.optionalFieldCount>0){const e=i.stats.optionalFieldCount,t=i.stats.totalAnyOfVariants+2*e;e>10&&i.warnings.push(`${e} optional fields detected. Each spawns an implicit anyOf with null. Consider making fields required or reducing optionals.`),t>50&&i.warnings.push(`High anyOf count (~${t} including implicit nullables). May cause slow schema compilation or errors.`)}if(i.errors.length>0)return{valid:!1,error:i.errors.join("\n"),warnings:i.warnings.length>0?i.warnings:void 0};const a={name:s.name,strict:null===(t=s.strict)||void 0===t||t,value:r};return i.info.push(`Schema stats: ${i.stats.propertyCount} properties, ${i.stats.defCount} definitions, ${i.stats.anyOfCount} anyOf blocks, ${i.stats.optionalFieldCount} optional fields, max depth ${i.stats.maxDepth}`),{valid:!0,schema:a,warnings:i.warnings.length>0?i.warnings:void 0,info:i.info.length>0?i.info:void 0}}function W(e,t,n){if(n.currentDepth++,n.stats.maxDepth=Math.max(n.stats.maxDepth,n.currentDepth),n.currentDepth>N)return n.errors.push(`${t}: Exceeds maximum nesting depth of ${N}`),void n.currentDepth--;for(const s of G)void 0!==e[s]&&n.errors.push(`${t}: '${s}' is not supported`);for(const s of H)void 0!==e[s]&&n.warnings.push(`${t}: '${s}' will be ignored (not supported)`);for(const s of V)void 0!==e[s]&&n.warnings.push(`${t}: '${s}' will be ignored (not supported)`);for(const s of F)void 0!==e[s]&&n.warnings.push(`${t}: '${s}' will be ignored (not supported)`);for(const s of U)void 0!==e[s]&&n.warnings.push(`${t}: '${s}' will be ignored (not supported)`);if(e.$ref&&"string"==typeof e.$ref)return function(e,t,n){if(e.startsWith("http://")||e.startsWith("https://"))return void n.errors.push(`${t}: External $ref not supported ('${e}')`);if(n.seenRefs.has(e))return void n.info.push(`${t}: Circular reference to '${e}'`);n.seenRefs.add(e);const s=e.replace(/^#\/(\$defs|definitions)\//,"");n.defs[s]||n.errors.push(`${t}: Reference '${e}' not found in definitions`)}(e.$ref,t,n),void n.currentDepth--;const s=Array.isArray(e.type)?e.type:[e.type];for(const r of s)switch(r){case"object":J(e,t,n);break;case"array":K(e,t,n);break;case"string":Q(e,t,n);break;case"number":case"integer":X(e,t,n);break;case"boolean":case"null":break;default:!r||e.anyOf||e.allOf||n.warnings.push(`${t}: Unknown type '${r}'`)}e.anyOf&&Array.isArray(e.anyOf)&&function(e,t,n){n.stats.anyOfCount++,n.stats.totalAnyOfVariants+=e.length,e.length>L&&n.errors.push(`${t}: anyOf has ${e.length} variants (max: ${L})`);if(0===e.length)return void n.errors.push(`${t}: anyOf cannot be empty`);e.forEach((e,s)=>{e&&"object"==typeof e&&W(e,`${t}.anyOf[${s}]`,n)})}(e.anyOf,t,n),e.allOf&&Array.isArray(e.allOf)&&function(e,t,n){if(0===e.length)return void n.errors.push(`${t}: allOf cannot be empty`);e.forEach((e,s)=>{if(e&&"object"==typeof e){const r=e;r.$ref&&n.errors.push(`${t}.allOf[${s}]: allOf with $ref not supported`),W(r,`${t}.allOf[${s}]`,n)}})}(e.allOf,t,n),e.enum&&Array.isArray(e.enum)&&function(e,t,n){if(n.stats.enumCount++,0===e.length)return void n.errors.push(`${t}: enum cannot be empty`);e.length>D&&n.warnings.push(`${t}: enum has ${e.length} values (may be slow)`);for(let s=0;s<e.length;s++){const r=e[s],i=typeof r;if("string"!==i&&"number"!==i&&"boolean"!==i&&null!==r){n.errors.push(`${t}.enum[${s}]: Complex type not allowed in enum (got ${i}). Only string, number, boolean, null permitted.`);break}}const s=new Set;for(const r of e){const e=JSON.stringify(r);if(s.has(e)){n.warnings.push(`${t}: Duplicate value in enum: ${e}`);break}s.add(e)}}(e.enum,t,n),void 0!==e.const&&function(e,t,n){const s=typeof e;"string"!==s&&"number"!==s&&"boolean"!==s&&null!==e&&n.errors.push(`${t}: const must be string, number, boolean, or null (got ${s})`)}(e.const,t,n),n.currentDepth--}function J(e,t,n){if(!1!==e.additionalProperties&&n.warnings.push(`${t}: Missing 'additionalProperties: false' (REQUIRED for Anthropic)`),e.properties&&"object"==typeof e.properties){const s=e.properties,r=Object.keys(s).length;n.stats.propertyCount+=r,r>q&&n.warnings.push(`${t}: ${r} properties (may be slow, consider splitting)`);const i=e.required||[];for(const[e,r]of Object.entries(s))i.includes(e)||n.stats.optionalFieldCount++,r&&"object"==typeof r&&W(r,`${t}.${e}`,n)}}function K(e,t,n){if(void 0!==e.minItems){z.includes(e.minItems)||n.warnings.push(`${t}: 'minItems: ${e.minItems}' not supported (only 0 or 1 allowed)`)}e.items&&("object"!=typeof e.items||Array.isArray(e.items)?Array.isArray(e.items)&&e.items.forEach((e,s)=>{e&&"object"==typeof e&&W(e,`${t}.items[${s}]`,n)}):W(e.items,`${t}.items`,n)),e.prefixItems&&Array.isArray(e.prefixItems)&&e.prefixItems.forEach((e,s)=>{e&&"object"==typeof e&&W(e,`${t}.prefixItems[${s}]`,n)})}function Q(e,t,n){if(e.format&&"string"==typeof e.format){const s=M;s.includes(e.format)||n.warnings.push(`${t}: format '${e.format}' may not be supported. Supported: ${s.join(", ")}`)}e.pattern&&"string"==typeof e.pattern&&function(e,t,n){for(const{pattern:s,name:r}of B)s.test(e)&&n.errors.push(`${t}: Regex pattern uses unsupported feature: ${r}`);try{new RegExp(e)}catch(e){const s=e instanceof Error?e.message:"Invalid regex";n.errors.push(`${t}: Invalid regex pattern: ${s}`)}const s=/\{(\d+),(\d+)\}/g;let r;for(;null!==(r=s.exec(e));){const e=parseInt(r[1],10),s=parseInt(r[2],10);s-e>100&&n.warnings.push(`${t}: Large quantifier range {${e},${s}} may cause issues`)}}(e.pattern,t,n)}function X(e,t,n){}function Z(e){const t=structuredClone(e);return void 0===t.strict&&(t.strict=!0),ee(t.value),t}function ee(e){if("object"===e.type&&(e.additionalProperties=!1,e.properties&&"object"==typeof e.properties))for(const t of Object.values(e.properties))t&&"object"==typeof t&&ee(t);"array"===e.type&&e.items&&"object"==typeof e.items&&(Array.isArray(e.items)?e.items.forEach(e=>{e&&"object"==typeof e&&ee(e)}):ee(e.items)),e.anyOf&&Array.isArray(e.anyOf)&&e.anyOf.forEach(e=>{e&&"object"==typeof e&&ee(e)}),e.allOf&&Array.isArray(e.allOf)&&e.allOf.forEach(e=>{e&&"object"==typeof e&&ee(e)});const t=[];for(const n of H)void 0!==e[n]&&(t.push(`${n}: ${e[n]}`),delete e[n]);for(const n of V)void 0!==e[n]&&(t.push(`${n}: ${e[n]}`),delete e[n]);for(const n of F)void 0!==e[n]&&(t.push(`${n}: ${e[n]}`),delete e[n]);if(void 0!==e.minItems&&null!==e.minItems){const n=e.minItems;0!==n&&1!==n&&(t.push(`minItems: ${n}`),e.minItems=n>0?1:0)}if(t.length>0){const n=`[Constraints: ${t.join(", ")}]`;e.description?e.description=`${e.description} ${n}`:e.description=n}}function te(e){const t=y().stageDefaults[e];return{promptPresetId:t.promptPresetId,customPrompt:t.customPrompt,schemaPresetId:t.schemaPresetId,customSchema:t.customSchema,useStructuredOutput:t.useStructuredOutput}}function ne(e,t){const{lodash:n}=SillyTavern.libs,{substituteParams:s}=SillyTavern.getContext();let r=s(e);return r=function(e,t){const n=/\{\{#if\s+(\w+)\}\}([\s\S]*?)\{\{\/if\}\}/gi;return e.replace(n,(e,n,s)=>{var r,i,a,o,c;let l=!1;switch(n.toLowerCase()){case"score_results":l=!!(null===(r=t.scoreResults)||void 0===r?void 0:r.trim());break;case"rewrite_results":l=!!(null===(i=t.rewriteResults)||void 0===i?void 0:i.trim());break;case"current_rewrite":l=!!(null===(a=t.currentRewrite)||void 0===a?void 0:a.trim());break;case"current_analysis":l=!!(null===(o=t.currentAnalysis)||void 0===o?void 0:o.trim());break;case"original_character":l=!!(null===(c=t.originalCharacter)||void 0===c?void 0:c.trim());break;case"iteration_number":l=!!t.iterationNumber&&"0"!==t.iterationNumber;break;default:l=!1}return l?s:""})}(r,t),void 0!==t.originalCharacter&&(r=r.replace(new RegExp(n.escapeRegExp(f.ORIGINAL_CHARACTER),"gi"),t.originalCharacter)),void 0!==t.scoreResults&&(r=r.replace(new RegExp(n.escapeRegExp(f.SCORE_RESULTS),"gi"),t.scoreResults)),void 0!==t.rewriteResults&&(r=r.replace(new RegExp(n.escapeRegExp(f.REWRITE_RESULTS),"gi"),t.rewriteResults)),void 0!==t.currentRewrite&&(r=r.replace(new RegExp(n.escapeRegExp(f.CURRENT_REWRITE),"gi"),t.currentRewrite)),void 0!==t.currentAnalysis&&(r=r.replace(new RegExp(n.escapeRegExp(f.CURRENT_ANALYSIS),"gi"),t.currentAnalysis)),void 0!==t.iterationNumber&&(r=r.replace(new RegExp(n.escapeRegExp(f.ITERATION_NUMBER),"gi"),t.iterationNumber)),void 0!==t.charName&&(r=r.replace(new RegExp(n.escapeRegExp(f.CHARACTER_NAME),"gi"),t.charName)),void 0!==t.userName&&(r=r.replace(new RegExp(n.escapeRegExp(f.USER_NAME),"gi"),t.userName)),void 0!==t.charName&&(r=r.replace(/\{\{char\}\}/gi,t.charName)),void 0!==t.userName&&(r=r.replace(/\{\{user\}\}/gi,t.userName)),r}function se(e){const t=[];for(const[n,s]of Object.entries(f))e.toLowerCase().includes(s.toLowerCase())&&t.push(n);return t}function re(e,t){const n=t.split(".");let s=e;for(const e of n){if(null==s||"object"!=typeof s)return;s=s[e]}return s}function ie(e,t){if(null==e)return!1;switch(t){case"array":return Array.isArray(e)&&e.length>0;case"object":return"object"==typeof e&&("prompt"in e&&"string"==typeof e.prompt?e.prompt.trim().length>0:"entries"in e&&Array.isArray(e.entries)?e.entries.length>0:Object.keys(e).length>0);default:return"string"==typeof e&&e.trim().length>0}}function ae(e,t){switch(t.type||"string"){case"array":return Array.isArray(e)?e.map((e,t)=>`${t+1}. ${String(e).trim()}`).join("\n"):"";case"object":return function(e,t){var n,s;if(!e||"object"!=typeof e)return"";switch(t){case"depth_prompt":{const t=e;return(null===(n=t.prompt)||void 0===n?void 0:n.trim())?`[Depth: ${t.depth}, Role: ${t.role}]\n${t.prompt.trim()}`:""}case"character_book":{const t=e;if(!(null===(s=t.entries)||void 0===s?void 0:s.length))return"";const n=[];t.name&&n.push(`Lorebook: ${t.name}`),n.push(`Entries: ${t.entries.length}`),n.push("");for(const e of t.entries){const t=e.enabled?"✓":"✗",s=e.keys.slice(0,5).join(", "),r=e.keys.length>5?` (+${e.keys.length-5} more)`:"",i=e.comment||`Entry ${e.id}`;if(n.push(`${t} ${i}: [${s}${r}]`),e.content){const t=e.content.trim().substring(0,100),s=e.content.length>100?"...":"";n.push(`   ${t}${s}`)}}return n.join("\n")}default:try{return JSON.stringify(e,null,2)}catch(e){return"[Complex Object]"}}}(e,t.key);default:return"string"==typeof e?e.trim():String(e)}}function oe(e){const t=[];for(const s of n){const n=s.type||"string";let r=re(e,s.path);if(ie(r,n)||s.path.includes(".")||(r=e[s.key]),"creator_notes"===s.key&&!ie(r,n)){const t=e.creatorcomment;t&&"string"==typeof t&&t.trim()&&(r=t)}if(!ie(r,n))continue;const i=ae(r,s);i&&t.push({key:s.key,label:s.label,value:i,rawValue:r,charCount:i.length,type:s.type})}return t}function ce(e,t){const n=[],s=oe(e);for(const e of s){const s=t[e.key];if(s&&(!Array.isArray(s)||0!==s.length))if("alternate_greetings"===e.key&&Array.isArray(s)){const t=e.rawValue,r=s.filter(e=>e>=0&&e<t.length).map(e=>`**Greeting ${e+1}:**\n${t[e].trim()}`).join("\n\n");r&&n.push(`### ${e.label}\n\n${r}`)}else n.push(`### ${e.label}\n\n${e.value}`)}return 0===n.length?`# CHARACTER: ${e.name}\n\n(No fields selected)`:`# CHARACTER: ${e.name}\n\n${n.join("\n\n")}`}function le(){return{character:null,characterIndex:null,results:{score:null,rewrite:null,analyze:null},configs:{score:te("score"),rewrite:te("rewrite"),analyze:te("analyze")},selectedStages:["score","rewrite"],currentStage:null,stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"},iterationCount:0,iterationHistory:[],isRefining:!1,selectedFields:{},exportData:null}}function ue(e){const t=oe(e),n={};for(const e of t)"alternate_greetings"===e.key&&Array.isArray(e.rawValue)?n[e.key]=e.rawValue.map((e,t)=>t):n[e.key]=!0;return n}function de(e,t,n){return Object.assign(Object.assign({},e),{selectedFields:Object.assign(Object.assign({},e.selectedFields),{[t]:n})})}function pe(e,t,n){if(e.characterIndex===n&&null!==n)return e;const s=Object.assign(Object.assign({},e),{character:t,characterIndex:n,results:{score:null,rewrite:null,analyze:null},stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"},currentStage:null,iterationCount:0,iterationHistory:[],isRefining:!1,selectedFields:t?ue(t):{},exportData:null});return _("state","Character set",{name:null==t?void 0:t.name,index:n,fieldsPopulated:t?oe(t).length:0}),s}function fe(e){return e.character?e.results.rewrite?e.results.rewrite.locked?{canRun:!1,reason:"Rewrite is accepted as final"}:e.results.analyze?{canRun:!0}:{canRun:!1,reason:"Run analyze first to identify issues"}:{canRun:!1,reason:"No rewrite to refine"}:{canRun:!1,reason:"No character selected"}}function me(e,t,n){return Object.assign(Object.assign({},e),{configs:Object.assign(Object.assign({},e.configs),{[t]:Object.assign(Object.assign({},e.configs[t]),n)})})}function _e(e,t,n){const s=Object.assign(Object.assign({},n),{timestamp:Date.now(),locked:!1});_("state","Stage completed",{stage:t,responseLength:n.response.length,isStructured:n.isStructured});const r="analyze"===t&&null!==e.results.rewrite;return Object.assign(Object.assign({},e),{currentStage:null,stageStatus:Object.assign(Object.assign({},e.stageStatus),{[t]:"complete"}),results:Object.assign(Object.assign({},e.results),{[t]:s}),isRefining:r})}function ge(e,t,n){return _("error","Stage failed",{stage:t,error:n}),Object.assign(Object.assign({},e),{currentStage:null,stageStatus:Object.assign(Object.assign({},e.stageStatus),{[t]:"pending"})})}function he(e){const t=e.toUpperCase();if(t.includes("VERDICT")||t.includes('"VERDICT"')){if(t.includes("ACCEPT")&&!t.includes("NEEDS"))return"accept";if(t.includes("REGRESSION"))return"regression";if(t.includes("NEEDS_REFINEMENT")||t.includes("NEEDS REFINEMENT"))return"needs_refinement"}return t.includes("READY TO USE")||t.includes("NO MORE ITERATIONS")?"accept":t.includes("WORSE THAN")||t.includes("STEP BACKWARD")||t.includes("LOST MORE")?"regression":(t.includes("ISSUE")||t.includes("PROBLEM")||t.includes("SHOULD FIX"),"needs_refinement")}function ve(e){const t=function(e){if(!e.results.rewrite||!e.results.analyze)return null;const t=he(e.results.analyze.response);return{iteration:e.iterationCount,rewriteResponse:e.results.rewrite.response,rewritePreview:e.results.rewrite.response.substring(0,200),analysisResponse:e.results.analyze.response,analysisPreview:e.results.analyze.response.substring(0,200),verdict:t,timestamp:Date.now()}}(e);if(!t)return g("Cannot start refinement - missing rewrite or analyze",null),e;const n=[...e.iterationHistory,t];return n.length>20&&n.shift(),_("state","Starting refinement iteration",{iteration:e.iterationCount+1,previousVerdict:t.verdict}),Object.assign(Object.assign({},e),{iterationHistory:n,iterationCount:e.iterationCount+1,results:Object.assign(Object.assign({},e.results),{analyze:null}),stageStatus:Object.assign(Object.assign({},e.stageStatus),{analyze:"pending"}),isRefining:!0})}function ye(e,t){var n,s,r,i,a,o;if(!e.character)return null;const c=function(e){if(e.promptPresetId){const t=E(e.promptPresetId);if(t)return t.prompt;_("error","Prompt preset not found",{id:e.promptPresetId})}return e.customPrompt}(e.configs[t]);if(!c.trim())return null;const l=se(c),u=ce(e.character,e.selectedFields),{name1:d}=SillyTavern.getContext(),p=ne(c,{originalCharacter:u,scoreResults:(null===(n=e.results.score)||void 0===n?void 0:n.response)||"",rewriteResults:(null===(s=e.results.rewrite)||void 0===s?void 0:s.response)||"",currentRewrite:(null===(r=e.results.rewrite)||void 0===r?void 0:r.response)||"",currentAnalysis:(null===(i=e.results.analyze)||void 0===i?void 0:i.response)||"",iterationNumber:String(e.iterationCount+1),charName:e.character.name,userName:d||"User"}),f=[];if(l.includes("ORIGINAL_CHARACTER")||f.push(`## Character\n\n${u}`),"score"!==t&&(null===(a=e.results.score)||void 0===a?void 0:a.response)&&(l.includes("SCORE_RESULTS")||f.push(`## Score Feedback\n\n${e.results.score.response}`)),"analyze"===t&&(null===(o=e.results.rewrite)||void 0===o?void 0:o.response)){l.includes("REWRITE_RESULTS")||l.includes("CURRENT_REWRITE")||f.push(`## Rewritten Version\n\n${e.results.rewrite.response}`)}const m=[];return f.length>0&&(m.push("# Input Data\n"),m.push(f.join("\n\n---\n\n")),m.push("\n\n---\n")),m.push("# Instructions\n\n"),m.push(p),m.join("")}function $e(e){var t,n;if(!e.character||!e.results.rewrite||!e.results.analyze)return null;const s=function(){var e,t;const n=y(),s=[];return(null===(e=n.baseRefinementPrompt)||void 0===e?void 0:e.trim())&&s.push(n.baseRefinementPrompt.trim()),(null===(t=n.userRefinementPrompt)||void 0===t?void 0:t.trim())&&s.push(n.userRefinementPrompt.trim()),s.join("\n\n")}(),r=se(s),i=ce(e.character,e.selectedFields),{name1:a}=SillyTavern.getContext(),o=ne(s,{originalCharacter:i,scoreResults:(null===(t=e.results.score)||void 0===t?void 0:t.response)||"",rewriteResults:e.results.rewrite.response,currentRewrite:e.results.rewrite.response,currentAnalysis:e.results.analyze.response,iterationNumber:String(e.iterationCount+1),charName:e.character.name,userName:a||"User"}),c=[];r.includes("ORIGINAL_CHARACTER")||c.push(`## Original Character (Ground Truth)\n\n${i}`);r.includes("CURRENT_REWRITE")||r.includes("REWRITE_RESULTS")||c.push(`## Current Rewrite (Iteration ${e.iterationCount+1})\n\n${e.results.rewrite.response}`),r.includes("CURRENT_ANALYSIS")||c.push(`## Analysis of Current Rewrite\n\n${e.results.analyze.response}`),(null===(n=e.results.score)||void 0===n?void 0:n.response)&&!r.includes("SCORE_RESULTS")&&c.push(`## Original Score Feedback\n\n${e.results.score.response}`);const l=[];return c.length>0&&(l.push("# Input Data\n"),l.push(c.join("\n\n---\n\n")),l.push("\n\n---\n")),l.push("# Refinement Instructions\n\n"),l.push(o),l.join("")}function be(e,t){return function(e){if(!e.useStructuredOutput)return null;if(e.schemaPresetId){const t=R(e.schemaPresetId);if(t)return t.schema;_("error","Schema preset not found",{id:e.schemaPresetId})}if(e.customSchema){const t=Y(e.customSchema);if(t.valid&&t.schema)return t.schema;_("error","Custom schema invalid",{error:t.error})}return null}(e.configs[t])}function Se(e){if(!e.results.rewrite||!e.character)return null;const{moment:t}=SillyTavern.libs,s=["\x3c!-- CharacterTools Export v1 --\x3e","",`# ${e.character.name} - Character Tools Session`,"",`**Exported:** ${t().format("YYYY-MM-DD HH:mm:ss")}`,`**Iterations:** ${e.iterationCount}`,""];s.push("## Fields Included"),s.push("");for(const[t,r]of Object.entries(e.selectedFields))if(!0===r){const e=n.find(e=>e.key===t);s.push(`- ${(null==e?void 0:e.label)||t}`)}else if(Array.isArray(r)&&r.length>0){const e=n.find(e=>e.key===t);s.push(`- ${(null==e?void 0:e.label)||t} (items: ${r.map(e=>e+1).join(", ")})`)}if(s.push(""),e.results.score&&(s.push("---"),s.push(""),s.push("## Score Results"),s.push(""),s.push(e.results.score.response),s.push("")),e.results.rewrite&&(s.push("---"),s.push(""),s.push("## Rewrite Results"),s.push(""),s.push(e.results.rewrite.response),s.push("")),e.results.analyze&&(s.push("---"),s.push(""),s.push("## Analysis Results"),s.push(""),s.push(e.results.analyze.response),s.push("")),e.iterationHistory.length>0){s.push("---"),s.push(""),s.push("## Iteration History"),s.push("");for(const n of e.iterationHistory)s.push(`### Iteration ${n.iteration+1} - ${n.verdict.toUpperCase()}`),s.push(`*${t(n.timestamp).format("YYYY-MM-DD HH:mm:ss")}*`),s.push(""),s.push("#### Rewrite"),s.push(""),s.push(n.rewriteResponse),s.push(""),s.push("#### Analysis"),s.push(""),s.push(n.analysisResponse),s.push("")}return s.join("\n")}function we(e,t){const n=e.selectedStages.indexOf(t);return-1===n||n>=e.selectedStages.length-1?null:e.selectedStages[n+1]}function Ce(e){return!!e.results.rewrite}var xe=function(e,t,n,s){return new(n||(n=Promise))(function(r,i){function a(e){try{c(s.next(e))}catch(e){i(e)}}function o(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,o)}c((s=s.apply(e,t||[])).next())})},Ee=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},s("next"),s("throw"),s("return"),t[Symbol.asyncIterator]=function(){return this},t);function s(n){t[n]=e[n]&&function(t){return new Promise(function(s,r){(function(e,t,n,s){Promise.resolve(s).then(function(t){e({value:t,done:n})},t)})(s,r,(t=e[n](t)).done,t.value)})}}};function Pe(){const{onlineStatus:e}=SillyTavern.getContext();return"Valid"===e||"Connected"===e}function Ae(){var e,t,n;const s=SillyTavern.getContext(),r=y();return r.useCurrentSettings?{source:(null===(e=s.chatCompletionSettings)||void 0===e?void 0:e.chat_completion_source)||s.mainApi||"unknown",model:(null===(t=s.chatCompletionSettings)||void 0===t?void 0:t.openrouter_model)||(null===(n=s.chatCompletionSettings)||void 0===n?void 0:n.model_openai_select)||"unknown",isReady:Pe()}:{source:r.generationConfig.source,model:r.generationConfig.model,isReady:Pe()}}function Re(e,t,n){return xe(this,void 0,void 0,function*(){const s=SillyTavern.getContext(),r=y();if(null==n?void 0:n.aborted)return{success:!1,error:"Generation cancelled"};if(!e.character)return{success:!1,error:"No character selected"};if(!Pe())return g("API not ready",{onlineStatus:s.onlineStatus}),{success:!1,error:"API is not connected. Check your connection settings."};const i=ye(e,t);if(!i)return{success:!1,error:"No prompt configured for this stage"};const a=e.configs[t].useStructuredOutput?be(e,t):null,o=Ie(i,e.character.name,s.name1||"User"),c=S(t);_("info","Starting stage generation",{stage:t,character:e.character.name,useCurrentSettings:r.useCurrentSettings,useStructured:!!a,schemaName:null==a?void 0:a.name,promptLength:o.length,systemPromptLength:c.length});const l=yield Oe(c,o,a,n,r.useCurrentSettings);return l.success&&a?function(e,t){try{const n=JSON.parse(e);if(t.value.required&&Array.isArray(t.value.required)){const s=t.value.required.filter(e=>!(e in n));if(s.length>0)return _("info","Structured response missing required fields, returning as unstructured",{missing:s,schemaName:t.name}),{success:!0,response:e,isStructured:!1}}return{success:!0,response:e,isStructured:!0}}catch(n){return _("info","Failed to parse structured response, returning as unstructured",{error:n.message,schemaName:t.name,responsePreview:e.substring(0,200)}),{success:!0,response:e,isStructured:!1}}}(l.response,a):l})}function Oe(e,t,n,s,r){return xe(this,void 0,void 0,function*(){try{let i;return i=r?yield function(e,t,n,s){return xe(this,void 0,void 0,function*(){const{generateRaw:r,substituteParams:i}=SillyTavern.getContext(),a=i(e);if(_("request","generateRaw request",{hasSchema:!!n,schemaName:null==n?void 0:n.name,systemPromptLength:a.length,userPromptLength:t.length}),null==s?void 0:s.aborted)throw new DOMException("Aborted","AbortError");const o=yield r({prompt:[{role:"system",content:a},{role:"user",content:t}],jsonSchema:n});if(null==s?void 0:s.aborted)throw new DOMException("Aborted","AbortError");const c=ke(o);return _("response","generateRaw response",{type:typeof o,length:c.length,preview:c.substring(0,200)}),c})}(e,t,n,s):yield function(e,t,n,s){return xe(this,void 0,void 0,function*(){const{ChatCompletionService:r,substituteParams:i}=SillyTavern.getContext(),a=y().generationConfig,o={stream:!0,messages:[{role:"system",content:i(e)},{role:"user",content:t}],chat_completion_source:a.source,model:a.model,temperature:a.temperature,max_tokens:a.maxTokens,frequency_penalty:a.frequencyPenalty,presence_penalty:a.presencePenalty,top_p:a.topP};if(n&&(o.json_schema=n),_("request","ChatCompletionService request",{source:a.source,model:a.model,stream:!0,hasSchema:!!n}),null==s?void 0:s.aborted)throw new DOMException("Aborted","AbortError");const c=yield r.sendRequest(o);let l;if(_("response","ChatCompletionService result type",{type:typeof c,isFunction:"function"==typeof c,isGenerator:c&&"object"==typeof c&&Symbol.asyncIterator in c}),"function"==typeof c)l=yield function(e,t){return xe(this,void 0,void 0,function*(){var n,s,r,i;let a="",o=null;try{o=e();try{for(var c,l=!0,u=Ee(o);!(n=(c=yield u.next()).done);l=!0){i=c.value,l=!1;const e=i;if(null==t?void 0:t.aborted){_("info","Stream aborted",{textSoFar:a.length});try{yield o.return(void 0)}catch(e){}throw new DOMException("Aborted","AbortError")}const n=e;if("string"==typeof n.text&&(a=n.text),n.error)throw new Error(ke(n.error))}}catch(e){s={error:e}}finally{try{l||n||!(r=u.return)||(yield r.call(u))}finally{if(s)throw s.error}}}catch(e){if("AbortError"===e.name)throw e;if(g("Stream consumption error",{error:e,textSoFar:a.length}),o)try{yield o.return(void 0)}catch(e){}if(a)return _("info","Returning partial response after stream error",{length:a.length}),a;throw e}return _("info","Stream consumed",{finalLength:a.length}),a})}(c,s);else if(c&&"object"==typeof c){const e=c;if(e.error)throw g("API returned error",c),new Error(`API error: ${JSON.stringify(c)}`);l=ke(e.content||c)}else l=ke(c);return _("response","Final response",{length:l.length,preview:l.substring(0,200)}),l})}(e,t,n,s),(null==s?void 0:s.aborted)?{success:!1,error:"Generation cancelled"}:i&&""!==i.trim()?(_("info","Generation complete",{responseLength:i.length,isStructured:!!n}),{success:!0,response:i,isStructured:!!n}):(g("Empty response",null),{success:!1,error:"Empty response from API"})}catch(e){if("AbortError"===e.name||(null==s?void 0:s.aborted))return _("info","Generation aborted",null),{success:!1,error:"Generation cancelled"};g("Generation exception",{message:e instanceof Error?e.message:String(e)});return{success:!1,error:e instanceof Error?e.message:String(e)}}})}function ke(e){if("string"==typeof e)return e;if(null==e)return"";if("object"==typeof e)try{return JSON.stringify(e)}catch(t){return String(e)}return String(e)}function Ie(e,t,n){return e.replace(/\{\{char\}\}/gi,t).replace(/\{\{user\}\}/gi,n)}var Te=function(e,t,n,s){return new(n||(n=Promise))(function(r,i){function a(e){try{c(s.next(e))}catch(e){i(e)}}function o(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,o)}c((s=s.apply(e,t||[])).next())})};let Le=null;function je(){return Le||(Le=new Map),Le}function Ne(t,n){const{getThumbnailUrl:s}=SillyTavern.getContext(),r=oe(t),i=s("avatar",t.avatar),a=Object.entries(n).filter(([,e])=>!0===e||Array.isArray(e)&&e.length>0).length;return`\n    <div class="${e}_char_preview" id="${e}_char_preview">\n      <div class="${e}_char_header">\n        <img\n          class="${e}_char_avatar"\n          src="${i}"\n          alt=""\n          onerror="this.src='/img/ai4.png'"\n        >\n        <div class="${e}_char_info">\n          <div class="${e}_char_name">${ze(t.name)}</div>\n          <div class="${e}_char_meta">\n            ${a}/${r.length} fields • <span id="${e}_total_tokens">counting...</span>\n          </div>\n        </div>\n        <button id="${e}_select_all_fields" class="${e}_icon_btn" title="Select all fields">\n          <i class="fa-solid fa-check-double"></i>\n        </button>\n        <button id="${e}_select_none_fields" class="${e}_icon_btn" title="Deselect all fields">\n          <i class="fa-solid fa-square"></i>\n        </button>\n        <button id="${e}_char_clear" class="${e}_icon_btn" title="Clear selection">\n          <i class="fa-solid fa-xmark"></i>\n        </button>\n      </div>\n\n      <div class="${e}_char_fields">\n        ${r.map(t=>function(t,n){const s="alternate_greetings"===t.key;let r;if(s){const e=n[t.key];r=Array.isArray(e)&&e.length>0}else r=!!n[t.key];return`\n    <div class="${e}_field_row">\n      <div class="${e}_field_header">\n        <input\n          type="checkbox"\n          class="${e}_field_checkbox"\n          data-field="${t.key}"\n          ${r?"checked":""}\n          ${s?'data-is-array="true"':""}\n        >\n        <div class="${e}_field_toggle" data-field="${t.key}">\n          <i class="fa-solid fa-chevron-right"></i>\n          <span class="${e}_field_label">${t.label}</span>\n        </div>\n        <span class="${e}_field_tokens" data-field="${t.key}">...</span>\n      </div>\n      <div class="${e}_field_content hidden" id="${e}_field_content_${t.key}">\n        ${s?function(t,n){const s=t.rawValue,r=n[t.key]||[];if(!s||0===s.length)return`<div class="${e}_field_text">(No alternate greetings)</div>`;return`\n    <div class="${e}_alt_greetings">\n      ${s.map((n,s)=>{const i=n.substring(0,150),a=n.length>150;return`\n          <div class="${e}_alt_greeting_item">\n            <input\n              type="checkbox"\n              class="${e}_alt_greeting_checkbox"\n              data-field="${t.key}"\n              data-index="${s}"\n              ${r.includes(s)?"checked":""}\n            >\n            <div class="${e}_alt_greeting_content">\n              <span class="${e}_alt_greeting_label">Greeting ${s+1}</span>\n              <div class="${e}_alt_greeting_preview">${ze(i)}${a?"...":""}</div>\n            </div>\n          </div>\n        `}).join("")}\n    </div>\n  `}(t,n):function(t){return`<div class="${e}_field_text">${ze(t.value)}</div>`}(t)}\n      </div>\n    </div>\n  `}(t,n)).join("")}\n      </div>\n    </div>\n  `}function qe(t,n,s,r){const i=t.querySelector(`.${e}_search_wrapper`),a=t.querySelector(`#${e}_char_preview`);if(n)if(null==i||i.classList.add("hidden"),a)!function(t,n){t.querySelectorAll(`.${e}_field_checkbox`).forEach(e=>{const t=e,s=t.dataset.field;if("true"===t.dataset.isArray){const e=n[s];t.checked=Array.isArray(e)&&e.length>0}else t.checked=!!n[s]}),t.querySelectorAll(`.${e}_alt_greeting_checkbox`).forEach(e=>{const t=e,s=t.dataset.field,r=parseInt(t.dataset.index,10),i=n[s];t.checked=Array.isArray(i)&&i.includes(r)})}(t,r),function(t,n,s){const r=oe(n),i=Object.entries(s).filter(([,e])=>!0===e||Array.isArray(e)&&e.length>0).length,a=t.querySelector(`.${e}_char_meta`);if(a){const t=a.querySelector(`#${e}_total_tokens`),n=(null==t?void 0:t.textContent)||"counting...";a.innerHTML=`${i}/${r.length} fields • <span id="${e}_total_tokens">${n}</span>`}}(t,n,r);else{const s=Ne(n,r),i=t.querySelector(`.${e}_search_wrapper`);i&&i.insertAdjacentHTML("afterend",s)}else{null==i||i.classList.remove("hidden"),null==a||a.remove();const n=t.querySelector(`#${e}_char_search`);n&&(n.value="")}}function De(t,n){return Te(this,void 0,void 0,function*(){const{getTokenCountAsync:s}=SillyTavern.getContext(),r=je(),i=n.map(e=>Te(this,void 0,void 0,function*(){const t=function(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t&=t;return`${t}_${e.length}`}(e.value);if(r.has(t))return{field:e,tokens:r.get(t)};try{const n=yield s(e.value);return function(e,t){const n=je();if(n.size>=500){const e=n.keys().next().value;void 0!==e&&n.delete(e)}n.set(e,t)}(t,n),{field:e,tokens:n}}catch(t){return{field:e,tokens:null}}})),a=yield Promise.all(i);let o=0;for(const{field:n,tokens:s}of a){const r=t.querySelector(`.${e}_field_tokens[data-field="${n.key}"]`);r&&(null!==s?(o+=s,r.textContent=`${s.toLocaleString()}t`):r.textContent="?")}const c=t.querySelector(`#${e}_total_tokens`);c&&(c.textContent=`${o.toLocaleString()} tokens`)})}function Me(t,n,s){const{getThumbnailUrl:r}=SillyTavern.getContext();if(0!==t.length){if(n.innerHTML=t.map(({char:t,index:n},i)=>{const a=r("avatar",t.avatar),o=i===s,c=(t.description||"No description").substring(0,80);return`\n      <div class="${e}_dropdown_item ${o?"selected":""}" data-index="${n}">\n        <img class="${e}_dropdown_avatar" src="${a}" alt="" onerror="this.src='/img/ai4.png'">\n        <div class="${e}_dropdown_info">\n          <span class="${e}_dropdown_name">${ze(t.name)}</span>\n          <span class="${e}_dropdown_desc">${ze(c)}${c.length>=80?"...":""}</span>\n        </div>\n      </div>\n    `}).join(""),s>=0){const t=n.querySelector(`.${e}_dropdown_item.selected`);null==t||t.scrollIntoView({block:"nearest"})}}else n.innerHTML=`<div class="${e}_dropdown_empty">No characters found</div>`}function ze(e){const{DOMPurify:t}=SillyTavern.libs,n="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(n,{ALLOWED_TAGS:[]})}function He(t,n,a,o){return`\n    <div class="${e}_pipeline_nav">\n      \x3c!-- Stage Selection --\x3e\n      <div class="${e}_stage_row">\n        ${s.map((o,c)=>function(t,n,s,a,o){const c=function(e){switch(e){case"complete":return"fa-check";case"running":return"fa-spinner fa-spin";case"skipped":return"fa-forward";default:return null}}(s);return`\n    <div class="${e}_stage_node ${a?"active":""} ${e}_stage_${s}">\n      <input\n        type="checkbox"\n        class="${e}_stage_checkbox"\n        id="${e}_stage_cb_${t}"\n        data-stage="${t}"\n        ${n?"checked":""}\n      >\n      <button\n        class="${e}_stage_btn ${a?"active":""}"\n        data-stage="${t}"\n        title="${r[t]}"\n      >\n        <i class="fa-solid ${i[t]}"></i>\n        <span>${r[t]}</span>\n        ${c?`<i class="fa-solid ${c} ${e}_status_icon"></i>`:""}\n      </button>\n      ${o?`<div class="${e}_stage_connector ${n?"active":""}"></div>`:""}\n    </div>\n  `}(o,t.includes(o),n[o],o===a,c<s.length-1)).join("")}\n      </div>\n\n      \x3c!-- Action Buttons --\x3e\n      <div class="${e}_pipeline_actions">\n        <button\n          id="${e}_run_selected_btn"\n          class="menu_button"\n          ${o?"":"disabled"}\n        >\n          <i class="fa-solid fa-play"></i>\n          <span>Run Stage</span>\n        </button>\n        <button\n          id="${e}_run_all_btn"\n          class="menu_button"\n          ${o?"":"disabled"}\n        >\n          <i class="fa-solid fa-forward"></i>\n          <span>Run Selected</span>\n        </button>\n        <button\n          id="${e}_reset_pipeline_btn"\n          class="menu_button"\n        >\n          <i class="fa-solid fa-rotate-left"></i>\n          <span>Reset</span>\n        </button>\n      </div>\n    </div>\n  `}var Ve=function(e,t,n,s){return new(n||(n=Promise))(function(r,i){function a(e){try{c(s.next(e))}catch(e){i(e)}}function o(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,o)}c((s=s.apply(e,t||[])).next())})};function Fe(){return Ve(this,void 0,void 0,function*(){const{Popup:e,POPUP_RESULT:t}=SillyTavern.getContext(),n=yield e.show.input("Generate Schema",'Describe the structure you want (e.g., <q>"scores for each field 1-10, list of suggestions, overall rating"</q>):\n',"");if(null===n||n===t.CANCELLED||!n.trim())return null;Ue(!0);try{toastr.info("Generating schema...");const e=yield function(e){return T(this,void 0,void 0,function*(){var t;const{generateRaw:n}=SillyTavern.getContext();if(!e.trim())return{success:!1,error:"Please describe what you want in the schema"};try{let s=(yield n({prompt:`Generate a JSON Schema for structured LLM output based on the user's description.\n\nExample input: "rating 1-10, list of issues, summary"\nExample output: {"name": "Analysis", "strict": true, "value": {"type": "object", "additionalProperties": false, "properties": {"rating": {"type": "number"}, "issues": {"type": "array", "items": {"type": "string"}}, "summary": {"type": "string"}}, "required": ["rating", "issues", "summary"]}}\n\nRequirements:\n- Output ONLY valid JSON, no markdown, no explanation\n- Use this exact wrapper format: {"name": "SchemaName", "strict": true, "value": {...}}\n- The "value" must be a valid JSON Schema with "type": "object"\n- Add "additionalProperties": false to ALL object types (required for Anthropic)\n- All object properties should be in a "required" array unless explicitly optional\n- Use simple types: string, number, integer, boolean, array, object\n- For arrays, always specify "items" with a schema\n- Keep it minimal - only what the user asked for\n\nUser's description:\n\n${e}`,systemPrompt:"You are a JSON Schema expert. Output only valid JSON, nothing else."})).trim();s.startsWith("```")&&(s=s.replace(/^```(?:json)?\s*/,"").replace(/\s*```$/,""));const r=Y(s);if(!r.valid)return{success:!1,error:`Generated schema is invalid: ${r.error}`,schema:s};if(null===(t=r.warnings)||void 0===t?void 0:t.length){const e=Z(r.schema);return{success:!0,schema:JSON.stringify(e,null,2)}}return{success:!0,schema:JSON.stringify(r.schema,null,2)}}catch(e){return{success:!1,error:`Generation failed: ${e.message}`}}})}(n);return e.success?(toastr.success("Schema generated!"),e.schema):(toastr.error(e.error||"Generation failed"),e.schema||null)}finally{Ue(!1)}})}function Ue(t){const n=document.querySelector(`.${e}_loading_overlay`);if(t&&!n){const t=document.createElement("div");t.className=`${e}_loading_overlay`,t.innerHTML=`\n            <div class="${e}_loading_content">\n                <i class="fa-solid fa-spinner fa-spin fa-2x"></i>\n                <p>Generating schema...</p>\n            </div>\n        `,document.body.appendChild(t)}else!t&&n&&n.remove()}function Ge(t,n,s,r,i){const a=x(n),o=A(n),c=t.querySelector(`#${e}_prompt_preset_select`);c&&(c.innerHTML=`<option value="">Custom</option>${Be(a,s.promptPresetId)}`,c.value=s.promptPresetId||"",c.disabled=r);const l=t.querySelector(`#${e}_custom_prompt`);if(l){let n=s.customPrompt;if(s.promptPresetId){const e=E(s.promptPresetId);e&&(n=e.prompt)}l.value!==n&&(l.value=n),l.disabled=r;const i=t.querySelector(`.${e}_char_count`);i&&(i.textContent=`${n.length.toLocaleString()} chars`)}const u=t.querySelector(`#${e}_use_structured`);u&&(u.checked=s.useStructuredOutput,u.disabled=r);const d=t.querySelector(`.${e}_schema_section`);d&&d.classList.toggle("hidden",!s.useStructuredOutput);const p=t.querySelector(`#${e}_schema_preset_select`);p&&(p.innerHTML=`<option value="">Custom</option>${Be(o,s.schemaPresetId)}`,p.value=s.schemaPresetId||"",p.disabled=r);const f=t.querySelector(`#${e}_custom_schema`);if(f){let e=s.customSchema;if(s.schemaPresetId){const t=R(s.schemaPresetId);t&&(e=JSON.stringify(t.schema,null,2))}f.value!==e&&(f.value=e),f.disabled=r}s.useStructuredOutput&&function(t,n){var s;const r=t.querySelector(`.${e}_schema_status`);r&&r.remove();if(!n.trim())return;const i=Y(n);let a="";a=i.valid?(null===(s=i.warnings)||void 0===s?void 0:s.length)?`<div class="${e}_schema_status warning"><i class="fa-solid fa-triangle-exclamation"></i> ${i.warnings.length} warning(s)</div>`:`<div class="${e}_schema_status success"><i class="fa-solid fa-circle-check"></i> Valid schema</div>`:`<div class="${e}_schema_status error"><i class="fa-solid fa-circle-xmark"></i> ${Ye(i.error||"Invalid schema")}</div>`;const o=t.querySelector(`#${e}_custom_schema`);o&&o.insertAdjacentHTML("afterend",a)}(t,(null==f?void 0:f.value)||""),function(t,n){var s,r;const i=t.querySelector(`#${e}_validate_schema_btn`),a=t.querySelector(`#${e}_fix_schema_btn`),o=t.querySelector(`#${e}_format_schema_btn`),c=n.trim().length>0;i&&(i.disabled=!c);o&&(o.disabled=!c);if(a&&c){const e=Y(n),t=(null!==(r=null===(s=e.warnings)||void 0===s?void 0:s.length)&&void 0!==r?r:0)>0||!e.valid;a.disabled=!t}else a&&(a.disabled=!0)}(t,(null==f?void 0:f.value)||"");const m=t.querySelector(`#${e}_preview_prompt_btn`);m&&(m.disabled=r||!i),function(t,n){var s,r;const i=t.querySelector(`#${e}_custom_prompt`),a=t.querySelector(`#${e}_custom_schema`),o=t.querySelector(`#${e}_save_prompt_preset_btn`),c=t.querySelector(`#${e}_save_schema_preset_btn`);if(o&&i){const e=i.value.trim(),t=n.promptPresetId&&(null===(s=E(n.promptPresetId))||void 0===s?void 0:s.prompt)||"",r=e.length>0,a=e!==t;o.disabled=!r||null!==n.promptPresetId&&!a}if(c&&a){const e=a.value.trim(),t=n.schemaPresetId?JSON.stringify(null===(r=R(n.schemaPresetId))||void 0===r?void 0:r.schema,null,2):"",s=e.length>0,i=e!==t,o=!!s&&Y(e).valid;c.disabled=!s||!o||null!==n.schemaPresetId&&!i}}(t,s)}function Be(e,t){return e.map(e=>{const n=e.id===t?"selected":"",s=e.isBuiltin?"📦":"📝";return`<option value="${e.id}" ${n}>${s} ${Ye(e.name)}</option>`}).join("")}function Ye(e){const{DOMPurify:t}=SillyTavern.libs;return t.sanitize(e,{ALLOWED_TAGS:[]})}function We(e,t){const{showdown:n,DOMPurify:s}=SillyTavern.libs,r="string"==typeof e?e:String(null!=e?e:""),i=`<div class="${t}_markdown_content">${new n.Converter({tables:!0,strikethrough:!0,simpleLineBreaks:!1,headerLevelStart:1,ghCodeBlocks:!0,tasklists:!0,openLinksInNewWindow:!0,emoji:!0,parseImgDimensions:!0,simplifiedAutoLink:!0}).makeHtml(r)}</div>`;return s.sanitize(i)}function Je(e,t,n){var s;const{DOMPurify:r}=SillyTavern.libs,i="string"==typeof e?e:String(null!=e?e:""),a=function(e){try{return JSON.parse(e)}catch(t){const n=e.match(/```(?:json)?\s*([\s\S]*?)```/);if(n)try{return JSON.parse(n[1].trim())}catch(e){return null}return null}}(i);if(!a||"object"!=typeof a)return We(i,n);const o=function(e,t,n){const s=function(e){const t=["overallscore","totalscore","overall","total","score","rating"];for(const n of t)for(const t of Object.keys(e))if(t.toLowerCase().replace(/_/g,"")===n&&"number"==typeof e[t])return t;return null}(e),r=s?e[s]:null,i=[];s&&"number"==typeof r&&i.push(function(e,t,n){const s=at(e),r=ot(t>10?t/10:t),i=Number.isInteger(t)?t:t.toFixed(1),a=t>10?100:10;return`\n    <div class="${n}_hero">\n      <div class="${n}_hero_label">${st(s)}</div>\n      <div class="${n}_hero_value" style="color: ${r}">\n        ${i}<span class="${n}_hero_max">/${a}</span>\n      </div>\n    </div>\n  `}(s,r,n));const a=t.properties||{},o=Object.keys(a).length>0?Object.keys(a):Object.keys(e);for(const t of o){if(t===s)continue;const r=e[t];if(void 0===r)continue;const o=a[t]||{type:rt(r)};i.push(Xe(t,r,o,n,0))}return`<div class="${n}_structured_content">${i.join("")}</div>`}(a,null!==(s=null==t?void 0:t.value)&&void 0!==s?s:Ke(a),n);return r.sanitize(o)}function Ke(e){if(null===e)return{type:"null"};if(Array.isArray(e))return{type:"array",items:e.length>0?Ke(e[0]):{type:"string"}};if("object"==typeof e){const t={};for(const[n,s]of Object.entries(e))t[n]=Ke(s);return{type:"object",properties:t}}return{type:typeof e}}const Qe=8;function Xe(e,t,n,s,r){if(r>Qe)return function(e,t){const{hljs:n}=SillyTavern.libs,s=JSON.stringify(e,null,2),r=n.highlight(s,{language:"json"}).value;return`<pre class="${t}_json"><code class="hljs">${r}</code></pre>`}(t,s);const i=at(e),a=n.type||rt(t);if("array"===a&&Array.isArray(t))return function(e,t,n,s,r){if(0===t.length)return`\n      <div class="${s}_field">\n        <div class="${s}_field_label">${st(e)}</div>\n        <div class="${s}_field_value ${s}_empty">(none)</div>\n      </div>\n    `;const i=n.items||{type:rt(t[0])};if(t.every(it)){const n=t.map(e=>`<li>${function(e,t){if("boolean"==typeof e)return nt(e,t);if("number"==typeof e)return`<span class="${t}_num">${e.toLocaleString()}</span>`;return st(String(e))}(e,s)}</li>`).join("");return`\n      <div class="${s}_field">\n        <div class="${s}_field_label">${st(e)}</div>\n        <ol class="${s}_list">${n}</ol>\n      </div>\n    `}const a=t.map((e,t)=>"object"==typeof e&&null!==e?function(e,t,n,s){const r=t.properties||{},i=Object.keys(r).length>0?Object.keys(r):Object.keys(e),a=i.find(t=>"string"==typeof e[t]&&e[t].length<100),o=i.find(t=>"number"==typeof e[t]&&e[t]>=0&&e[t]<=100),c=i.find(t=>"string"==typeof e[t]&&e[t].length>=50&&t!==a);let l="";if(a||o){const t=a?`<span class="${n}_card_title">${st(String(e[a]))}</span>`:"",s=o?tt(e[o],n):"";l=`<div class="${n}_card_header">${t}${s}</div>`}let u="";c&&(u=`<div class="${n}_card_body">${et(String(e[c]),n)}</div>`);const d=i.filter(e=>e!==a&&e!==o&&e!==c).map(t=>{const i=e[t];if(void 0===i)return"";return Xe(t,i,r[t]||{type:rt(i)},n,s+1)}).filter(Boolean).join(""),p=d?`<div class="${n}_card_extra">${d}</div>`:"";return`<div class="${n}_card">${l}${u}${p}</div>`}(e,i,s,r+1):`<div class="${s}_card">${Ze(e,i,s)}</div>`).join("");return`\n    <div class="${s}_field">\n      <div class="${s}_field_label">${st(e)}</div>\n      <div class="${s}_cards">${a}</div>\n    </div>\n  `}(i,t,n,s,r);if("object"===a&&"object"==typeof t&&null!==t)return function(e,t,n,s,r){const i=n.properties||{},a=(Object.keys(i).length>0?Object.keys(i):Object.keys(t)).map(e=>{const n=t[e];if(void 0===n)return"";return Xe(e,n,i[e]||{type:rt(n)},s,r+1)}).filter(Boolean).join("");return`\n    <div class="${s}_field">\n      <div class="${s}_field_label">${st(e)}</div>\n      <div class="${s}_nested">${a}</div>\n    </div>\n  `}(i,t,n,s,r);const o=Ze(t,n,s,e);return`\n    <div class="${s}_field">\n      <div class="${s}_field_label">${st(i)}</div>\n      <div class="${s}_field_value">${o}</div>\n    </div>\n  `}function Ze(e,t,n,s){if(null==e)return`<span class="${n}_null">—</span>`;switch(t.type||rt(e)){case"string":return function(e,t,n){if(!e.trim())return`<span class="${n}_empty">(empty)</span>`;const s=t.format;if("uri"===s||"url"===s||(r=e,/^https?:\/\//i.test(r))){const t=e.length>50?e.substring(0,47)+"...":e;return`<a href="${st(e)}" target="_blank" rel="noopener" class="${n}_link">${st(t)}</a>`}var r;if("email"===s||function(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}(e))return`<a href="mailto:${st(e)}" class="${n}_link">${st(e)}</a>`;if(e.length>100||e.includes("\n"))return et(e,n);return`<span>${st(e)}</span>`}(e,t,n);case"number":case"integer":return function(e,t,n,s){const r=String(t.title||t.description||s||"").toLowerCase();if(function(e,t){return!!["score","rating","rank","grade","level","confidence","quality"].some(t=>e.includes(t))||(!!(t>=0&&t<=10&&Number.isFinite(t))||!!(t>=0&&t<=100&&Number.isInteger(t)))}(r,e))return tt(e,n);const i=e.toLocaleString(void 0,{maximumFractionDigits:2});return`<span class="${n}_num">${i}</span>`}(e,t,n,s);case"boolean":return nt(e,n);default:return`<span>${st(String(e))}</span>`}}function et(e,t){return`<div class="${t}_text">${We(e,t)}</div>`}function tt(e,t){return`<span class="${t}_score" style="color: ${ot(e>10?e/10:e)}">${Number.isInteger(e)?e:e.toFixed(1)}<span class="${t}_score_max">/${e>10?100:10}</span></span>`}function nt(e,t){return`<span class="${e?`${t}_yes`:`${t}_no`}"><i class="fa-solid ${e?"fa-check-circle":"fa-times-circle"}"></i> ${e?"Yes":"No"}</span>`}function st(e){const{DOMPurify:t}=SillyTavern.libs,n="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(n,{ALLOWED_TAGS:[]})}function rt(e){return null===e?"null":Array.isArray(e)?"array":typeof e}function it(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e||null===e}function at(e){return e.replace(/_/g," ").replace(/([a-z])([A-Z])/g,"$1 $2").replace(/\b\w/g,e=>e.toUpperCase())}function ot(e){return e>=8?"var(--success, #2ecc71)":e>=5?"var(--warning, #f39c12)":"var(--failure, #e74c3c)"}function ct(t){return`\n    <div class="${e}_results_loading">\n      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>\n      <p>Running ${r[t]}...</p>\n      <button id="${e}_cancel_btn" class="menu_button">\n        <i class="fa-solid fa-stop"></i>\n        <span>Cancel</span>\n      </button>\n    </div>\n  `}function lt(t,n){let s=`Run ${r[t]} to see results`,i="fa-play";return"skipped"===n&&(s=`${r[t]} was skipped`,i="fa-forward"),`\n    <div class="${e}_results_placeholder">\n      <i class="fa-solid ${i}"></i>\n      <p>${s}</p>\n    </div>\n  `}function ut(t,n){const s=n.isStructured?Je(n.response,null,e):We(n.response,e),i=new Date(n.timestamp).toLocaleTimeString();let a="";if("analyze"===t){a=function(t){return`\n    <span class="${e}_badge ${e}_verdict_badge ${e}_verdict_${t}">\n      <i class="fa-solid ${{accept:"fa-check-circle",needs_refinement:"fa-wrench",regression:"fa-arrow-down"}[t]}"></i>\n      ${{accept:"Accept",needs_refinement:"Needs Work",regression:"Regression"}[t]}\n    </span>\n  `}(he(n.response))}return`\n    <div class="${e}_results_content">\n      \x3c!-- Toolbar --\x3e\n      <div class="${e}_results_toolbar">\n        <div class="${e}_results_info">\n          <span class="${e}_badge">${r[t]}</span>\n          ${a}\n          <span class="${e}_results_time">${i}</span>\n          ${n.locked?`<span class="${e}_badge ${e}_badge_locked"><i class="fa-solid fa-lock"></i> Locked</span>`:""}\n        </div>\n        <div class="${e}_results_actions">\n          \x3c!-- Always render BOTH buttons, use hidden class based on locked state --\x3e\n          <button id="${e}_lock_btn" class="${e}_icon_btn ${n.locked?"hidden":""}" title="Lock result">\n            <i class="fa-solid fa-lock-open"></i>  \x3c!-- CHANGED: Show open lock when unlocked --\x3e\n          </button>\n          <button id="${e}_unlock_btn" class="${e}_icon_btn ${n.locked?"":"hidden"}" title="Unlock for editing">\n            <i class="fa-solid fa-lock"></i>  \x3c!-- CHANGED: Show closed lock when locked --\x3e\n          </button>\n          <button id="${e}_copy_btn" class="${e}_icon_btn" title="Copy to clipboard">\n            <i class="fa-solid fa-copy"></i>\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Content --\x3e\n      <div class="${e}_results_body">\n        ${s}\n      </div>\n\n      \x3c!-- Footer Actions --\x3e\n      <div class="${e}_results_footer" id="${e}_results_footer">\n        \x3c!-- Populated by updateResultsPanelState --\x3e\n      </div>\n    </div>\n  `}function dt(t,n,s,i,a,o,c){var l;const u=a&&"running"===i,d=s&&!u,p=!s&&!u;if(u)return void(t.innerHTML=ct(n));if(p)return void(t.innerHTML=lt(n,i));if(d){const r=t.querySelector(`.${e}_results_content`),i=null===(l=t.querySelector(`.${e}_results_time`))||void 0===l?void 0:l.textContent,a=new Date(s.timestamp).toLocaleTimeString();r&&i===a||(t.innerHTML=ut(n,s))}const f=t.querySelector(`#${e}_results_footer`);f&&s&&(f.innerHTML=function(t,n,s,i){const a=[];n.locked||a.push(`\n      <button id="${e}_regenerate_btn" class="menu_button">\n        <i class="fa-solid fa-rotate"></i>\n        <span>Regenerate</span>\n      </button>\n    `);"rewrite"===t&&i.isRefining&&!i.results.analyze&&a.push(`\n      <button id="${e}_run_analyze_btn" class="menu_button ${e}_continue_btn">\n        <i class="fa-solid fa-magnifying-glass-chart"></i>\n        <span>Analyze This Rewrite</span>\n      </button>\n    `);if("analyze"===t){const t=he(n.response);if(fe(i).canRun){const n="needs_refinement"===t;a.push(`\n        <button id="${e}_refine_btn" class="menu_button ${n?e+"_refine_recommended":""}">\n          <i class="fa-solid fa-arrows-rotate"></i>\n          <span>Refine</span>\n          ${i.iterationCount>0?`<span class="${e}_iteration_badge">#${i.iterationCount+1}</span>`:""}\n        </button>\n      `)}if(i.results.rewrite&&!i.results.rewrite.locked){const n="accept"===t;a.push(`\n        <button id="${e}_accept_btn" class="menu_button ${n?e+"_accept_recommended":""}">\n          <i class="fa-solid fa-check"></i>\n          <span>Accept Rewrite</span>\n        </button>\n      `)}}!s||"analyze"===t||"rewrite"===t&&i.isRefining||a.push(`\n      <button id="${e}_continue_btn" class="menu_button ${e}_continue_btn">\n        <i class="fa-solid fa-arrow-right"></i>\n        <span>Continue to ${r[s]}</span>\n      </button>\n    `);Ce(i)&&a.push(`\n      <button id="${e}_export_btn" class="menu_button">\n        <i class="fa-solid fa-file-export"></i>\n        <span>Export</span>\n      </button>\n    `);return`<div class="${e}_footer_actions">${a.join("")}</div>`}(n,s,o,c));const m=t.querySelector(`#${e}_lock_btn`),_=t.querySelector(`#${e}_unlock_btn`);m&&_&&(m.classList.toggle("hidden",!!(null==s?void 0:s.locked)),_.classList.toggle("hidden",!(null==s?void 0:s.locked)))}function pt(t,n,s){if(0===t.length&&0===n)return"";const r=s?0===t.length?`<div class="${e}_iteration_empty">No previous iterations</div>`:t.map((e,t)=>ft(e,t)).join(""):`<div class="${e}_iteration_loading">\n             <i class="fa-solid fa-spinner fa-spin"></i>\n             <span>Loading history...</span>\n           </div>`;return`\n    <div class="${e}_iteration_history" id="${e}_iteration_history">\n      <div class="${e}_iteration_header">\n        <i class="fa-solid fa-clock-rotate-left"></i>\n        <span>Iteration History</span>\n        <span class="${e}_iteration_count">${n>0?`Current: #${n+1}`:"Initial"}</span>\n      </div>\n      <div class="${e}_iteration_list">\n        ${r}\n      </div>\n    </div>\n  `}function ft(t,n){const s=mt(t.verdict),r=_t(t.verdict),i=new Date(t.timestamp).toLocaleTimeString();return`\n    <div class="${e}_iteration_item ${r}" data-index="${n}">\n      <div class="${e}_iteration_item_header">\n        <span class="${e}_iteration_num">#${t.iteration+1}</span>\n        <span class="${e}_iteration_verdict">\n          <i class="fa-solid ${s}"></i>\n          ${gt(t.verdict)}\n        </span>\n        <span class="${e}_iteration_time">${i}</span>\n      </div>\n      <div class="${e}_iteration_preview">\n        ${ht(t.rewritePreview)}...\n      </div>\n      <div class="${e}_iteration_actions">\n        <button\n          class="${e}_iteration_revert_btn menu_button"\n          data-index="${n}"\n          title="Revert to this version"\n        >\n          <i class="fa-solid fa-rotate-left"></i>\n          Revert\n        </button>\n        <button\n          class="${e}_iteration_view_btn menu_button"\n          data-index="${n}"\n          title="View full content"\n        >\n          <i class="fa-solid fa-eye"></i>\n          View\n        </button>\n      </div>\n    </div>\n  `}function mt(e){switch(e){case"accept":return"fa-check-circle";case"needs_refinement":return"fa-wrench";case"regression":return"fa-arrow-down";default:return"fa-question-circle"}}function _t(t){return`${e}_verdict_${t}`}function gt(e){switch(e){case"accept":return"Accepted";case"needs_refinement":return"Needs Work";case"regression":return"Regression";default:return"Unknown"}}function ht(e){const{DOMPurify:t}=SillyTavern.libs,n="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(n,{ALLOWED_TAGS:[]})}var vt=function(e,t,n,s){return new(n||(n=Promise))(function(r,i){function a(e){try{c(s.next(e))}catch(e){i(e)}}function o(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,o)}c((s=s.apply(e,t||[])).next())})};function yt(n){return vt(this,void 0,void 0,function*(){const{Popup:s,POPUP_TYPE:r}=SillyTavern.getContext(),{DOMPurify:i}=SillyTavern.libs,c=function(){const n=y(),s=n.generationConfig,{moment:r}=SillyTavern.libs;return`\n    <div class="${e}_settings_modal" id="${e}_settings_modal">\n      <div class="${e}_settings_header">\n        <i class="fa-solid fa-gear"></i>\n        <span>Character Tools Settings</span>\n      </div>\n\n      \x3c!-- Generation Settings --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-microchip"></i>\n          <span>Generation</span>\n        </div>\n\n        <div class="${e}_settings_row">\n          <label class="${e}_checkbox_label">\n            <input\n              type="checkbox"\n              id="${e}_use_current_settings"\n              ${n.useCurrentSettings?"checked":""}\n            >\n            <span>Use Current SillyTavern Settings</span>\n          </label>\n        </div>\n\n        <div id="${e}_custom_gen_config" class="${n.useCurrentSettings?"hidden":""}">\n          <div class="${e}_settings_grid">\n            <div class="${e}_settings_field">\n              <label>Source</label>\n              <select id="${e}_gen_source" class="text_pole"></select>\n            </div>\n            <div class="${e}_settings_field">\n              <label>Model</label>\n              <select id="${e}_gen_model" class="text_pole"></select>\n            </div>\n          </div>\n\n          <div class="${e}_settings_grid ${e}_settings_grid_5">\n            <div class="${e}_settings_field">\n              <label>Temp</label>\n              <input type="number" id="${e}_gen_temp" class="text_pole" value="${s.temperature}" min="0" max="2" step="0.1">\n            </div>\n            <div class="${e}_settings_field">\n              <label>Max Tokens</label>\n              <input type="number" id="${e}_gen_tokens" class="text_pole" value="${s.maxTokens}" min="100" max="32000" step="100">\n            </div>\n            <div class="${e}_settings_field">\n              <label>Freq Pen</label>\n              <input type="number" id="${e}_gen_freq" class="text_pole" value="${s.frequencyPenalty}" min="-2" max="2" step="0.1">\n            </div>\n            <div class="${e}_settings_field">\n              <label>Pres Pen</label>\n              <input type="number" id="${e}_gen_pres" class="text_pole" value="${s.presencePenalty}" min="-2" max="2" step="0.1">\n            </div>\n            <div class="${e}_settings_field">\n              <label>Top P</label>\n              <input type="number" id="${e}_gen_top_p" class="text_pole" value="${s.topP}" min="0" max="1" step="0.05">\n            </div>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- System Prompt --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-message"></i>\n          <span>System Prompt</span>\n        </div>\n\n        <p class="${e}_settings_hint">\n          The system prompt is sent with every generation. Base prompt provides core instructions,\n          your additions are appended after.\n        </p>\n\n        \x3c!-- User additions (main) --\x3e\n        <div class="${e}_settings_subsection">\n          <label class="${e}_settings_label">Your Additions</label>\n          <textarea\n            id="${e}_user_system_prompt"\n            class="text_pole ${e}_system_prompt_textarea"\n            rows="4"\n            placeholder="Add your custom instructions here..."\n          >${Ct(n.userSystemPrompt||"")}</textarea>\n          <div class="${e}_settings_row_spread">\n            <span id="${e}_user_system_prompt_chars">${(n.userSystemPrompt||"").length} chars</span>\n            <button id="${e}_clear_user_system_prompt" class="menu_button">\n              <i class="fa-solid fa-eraser"></i>\n              Clear\n            </button>\n          </div>\n        </div>\n\n        \x3c!-- Base prompt (collapsible advanced) --\x3e\n        <details class="${e}_settings_advanced">\n          <summary>\n            <i class="fa-solid fa-caret-right"></i>\n            Base Prompt (Advanced)\n          </summary>\n          <div class="${e}_settings_advanced_content">\n            <p class="${e}_settings_hint ${e}_settings_warning">\n              ⚠️ Editing the base prompt may affect all stages. Reset to restore defaults.\n            </p>\n            <textarea\n              id="${e}_base_system_prompt"\n              class="text_pole ${e}_system_prompt_textarea"\n              rows="6"\n            >${Ct(n.baseSystemPrompt||"")}</textarea>\n            <div class="${e}_settings_row_spread">\n              <span id="${e}_base_system_prompt_chars">${(n.baseSystemPrompt||"").length} chars</span>\n              <button id="${e}_reset_base_system_prompt" class="menu_button">\n                <i class="fa-solid fa-rotate-left"></i>\n                Reset\n              </button>\n            </div>\n          </div>\n        </details>\n\n      \x3c!-- Refinement Prompt --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-arrows-rotate"></i>\n          <span>Refinement Prompt</span>\n        </div>\n\n        <p class="${e}_settings_hint">\n          Instructions for the refinement loop. Base provides core guidance, your additions are appended.\n        </p>\n\n        \x3c!-- User additions --\x3e\n        <div class="${e}_settings_subsection">\n          <label class="${e}_settings_label">Your Additions</label>\n          <textarea\n            id="${e}_user_refinement_prompt"\n            class="text_pole ${e}_system_prompt_textarea"\n            rows="4"\n            placeholder="Add your refinement instructions here..."\n          >${Ct(n.userRefinementPrompt||"")}</textarea>\n          <div class="${e}_settings_row_spread">\n            <span id="${e}_user_refinement_prompt_chars">${(n.userRefinementPrompt||"").length} chars</span>\n            <button id="${e}_clear_user_refinement_prompt" class="menu_button">\n              <i class="fa-solid fa-eraser"></i>\n              Clear\n            </button>\n          </div>\n        </div>\n\n        \x3c!-- Base prompt (collapsible) --\x3e\n        <details class="${e}_settings_advanced">\n          <summary>\n            <i class="fa-solid fa-caret-right"></i>\n            Base Prompt (Advanced)\n          </summary>\n          <div class="${e}_settings_advanced_content">\n            <textarea\n              id="${e}_base_refinement_prompt"\n              class="text_pole ${e}_system_prompt_textarea"\n              rows="6"\n            >${Ct(n.baseRefinementPrompt||"")}</textarea>\n            <div class="${e}_settings_row_spread">\n              <span id="${e}_base_refinement_prompt_chars">${(n.baseRefinementPrompt||"").length} chars</span>\n              <button id="${e}_reset_base_refinement_prompt" class="menu_button">\n                <i class="fa-solid fa-rotate-left"></i>\n                Reset\n              </button>\n            </div>\n          </div>\n        </details>\n      </div>\n\n      \x3c!-- Preset Management --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-bookmark"></i>\n          <span>Presets</span>\n        </div>\n\n        <div class="${e}_presets_grid">\n          <div class="${e}_preset_column">\n            <h4>Prompt Presets</h4>\n            <div id="${e}_prompt_presets_list" class="${e}_preset_list">\n              ${$t("prompt")}\n            </div>\n          </div>\n          <div class="${e}_preset_column">\n            <h4>Schema Presets</h4>\n            <div id="${e}_schema_presets_list" class="${e}_preset_list">\n              ${$t("schema")}\n            </div>\n          </div>\n        </div>\n\n        <div class="${e}_settings_row_spread">\n          <button id="${e}_export_presets" class="menu_button">\n            <i class="fa-solid fa-file-export"></i>\n            Export Custom\n          </button>\n          <button id="${e}_import_presets" class="menu_button">\n            <i class="fa-solid fa-file-import"></i>\n            Import\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Keyboard Shortcuts --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-keyboard"></i>\n          <span>Keyboard Shortcuts</span>\n        </div>\n\n        <div class="${e}_shortcuts_list">\n          <div class="${e}_shortcut_item">\n            <kbd>Ctrl</kbd> + <kbd>Enter</kbd>\n            <span>Run current stage</span>\n          </div>\n          <div class="${e}_shortcut_item">\n            <kbd>Escape</kbd>\n            <span>Cancel generation</span>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Debug --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-bug"></i>\n          <span>Debug</span>\n        </div>\n\n        <div class="${e}_settings_row">\n          <label class="${e}_checkbox_label">\n            <input\n              type="checkbox"\n              id="${e}_debug_mode"\n              ${n.debugMode?"checked":""}\n            >\n            <span>Enable Debug Logging</span>\n          </label>\n        </div>\n\n        <div class="${e}_debug_actions">\n          <button id="${e}_view_logs" class="menu_button">\n            <i class="fa-solid fa-list"></i>\n            View Logs\n          </button>\n          <button id="${e}_clear_logs" class="menu_button">\n            <i class="fa-solid fa-trash"></i>\n            Clear\n          </button>\n          <button id="${e}_copy_debug_info" class="menu_button">\n            <i class="fa-solid fa-copy"></i>\n            Copy Info\n          </button>\n        </div>\n\n        <div id="${e}_debug_log_viewer" class="${e}_debug_log_viewer hidden">\n          <div id="${e}_debug_log_list" class="${e}_debug_log_list"></div>\n          <pre id="${e}_debug_log_detail" class="${e}_debug_log_detail">Select a log entry</pre>\n        </div>\n      </div>\n\n      \x3c!-- Footer --\x3e\n      <div class="${e}_settings_footer">\n        <span class="${e}_settings_version">v${t} • Last updated: ${r().format("YYYY-MM-DD HH:mm:ss")}</span>\n      </div>\n    </div>\n  `}();new s(i.sanitize(c),r.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:"Save & Close",cancelButton:!1}).show().then(()=>{null==n||n(),_("info","Settings modal closed",null)}),yield new Promise(e=>setTimeout(e,0)),function(){const t=document.getElementById(`${e}_settings_modal`);if(!t)return;const n=t.querySelector(`#${e}_use_current_settings`),s=t.querySelector(`#${e}_custom_gen_config`);null==n||n.addEventListener("change",()=>{$("useCurrentSettings",n.checked),null==s||s.classList.toggle("hidden",n.checked)});const r=t.querySelector(`#${e}_gen_source`),i=t.querySelector(`#${e}_gen_model`),c=t.querySelector(`#${e}_gen_temp`),l=t.querySelector(`#${e}_gen_tokens`),u=t.querySelector(`#${e}_gen_freq`),d=t.querySelector(`#${e}_gen_pres`),p=t.querySelector(`#${e}_gen_top_p`);null==r||r.addEventListener("change",()=>{b({source:r.value}),wt(r.value)}),null==i||i.addEventListener("change",()=>{b({model:i.value})});const f=(e,t,n=!1)=>{null==e||e.addEventListener("change",()=>{const s=n?parseInt(e.value,10):parseFloat(e.value);isNaN(s)||b({[t]:s})})};f(c,"temperature"),f(l,"maxTokens",!0),f(u,"frequencyPenalty"),f(d,"presencePenalty"),f(p,"topP");const g=t.querySelector(`#${e}_user_system_prompt`),v=t.querySelector(`#${e}_user_system_prompt_chars`),S=t.querySelector(`#${e}_clear_user_system_prompt`);null==g||g.addEventListener("input",()=>{$("userSystemPrompt",g.value),v&&(v.textContent=`${g.value.length} chars`)}),null==S||S.addEventListener("click",()=>{$("userSystemPrompt",""),g&&(g.value=""),v&&(v.textContent="0 chars"),toastr.info("User system prompt cleared")});const x=t.querySelector(`#${e}_base_system_prompt`),E=t.querySelector(`#${e}_base_system_prompt_chars`),A=t.querySelector(`#${e}_reset_base_system_prompt`);null==x||x.addEventListener("input",()=>{$("baseSystemPrompt",x.value),E&&(E.textContent=`${x.value.length} chars`)}),null==A||A.addEventListener("click",()=>{$("baseSystemPrompt",a),x&&(x.value=a),E&&(E.textContent="363 chars"),toastr.info("Base system prompt reset to default")});for(const n of["score","rewrite","analyze"]){const s=t.querySelector(`#${e}_stage_system_prompt_${n}`);null==s||s.addEventListener("input",()=>{w(n,s.value)})}const R=t.querySelector(`#${e}_user_refinement_prompt`),k=t.querySelector(`#${e}_user_refinement_prompt_chars`),I=t.querySelector(`#${e}_clear_user_refinement_prompt`);null==R||R.addEventListener("input",()=>{$("userRefinementPrompt",R.value),k&&(k.textContent=`${R.value.length} chars`)}),null==I||I.addEventListener("click",()=>{$("userRefinementPrompt",""),R&&(R.value=""),k&&(k.textContent="0 chars"),toastr.info("User refinement prompt cleared")});const T=t.querySelector(`#${e}_base_refinement_prompt`),L=t.querySelector(`#${e}_base_refinement_prompt_chars`),j=t.querySelector(`#${e}_reset_base_refinement_prompt`);null==T||T.addEventListener("input",()=>{$("baseRefinementPrompt",T.value),L&&(L.textContent=`${T.value.length} chars`)}),null==j||j.addEventListener("click",()=>{$("baseRefinementPrompt",o),T&&(T.value=o),L&&(L.textContent="326 chars"),toastr.info("Base refinement prompt reset to default")}),t.addEventListener("click",t=>{const n=t.target.closest(`.${e}_preset_delete`);if(n){const t=n.getAttribute("data-type"),s=n.getAttribute("data-id");t&&s&&function(t,n){const s="prompt"===t?function(t){var n;const{extensionSettings:s,saveSettingsDebounced:r}=SillyTavern.getContext(),i=s[e],a=i.promptPresets.findIndex(e=>e.id===t);if(-1===a)return null;if(i.promptPresets[a].isBuiltin)return _("error","Cannot delete builtin preset",{id:t}),null;i.promptPresets.splice(a,1);for(const e of["score","rewrite","analyze"])(null===(n=i.stageDefaults[e])||void 0===n?void 0:n.promptPresetId)===t&&(i.stageDefaults[e].promptPresetId=null);return r(),_("info","Prompt preset deleted",{id:t}),t}(n):function(t){var n;const{extensionSettings:s,saveSettingsDebounced:r}=SillyTavern.getContext(),i=s[e],a=i.schemaPresets.findIndex(e=>e.id===t);if(-1===a)return null;if(i.schemaPresets[a].isBuiltin)return _("error","Cannot delete builtin preset",{id:t}),null;i.schemaPresets.splice(a,1);for(const e of["score","rewrite","analyze"])(null===(n=i.stageDefaults[e])||void 0===n?void 0:n.schemaPresetId)===t&&(i.stageDefaults[e].schemaPresetId=null);return r(),_("info","Schema preset deleted",{id:t}),t}(n);s?(toastr.success("Preset deleted"),bt()):toastr.error("Cannot delete builtin preset")}(t,s)}});const N=t.querySelector(`#${e}_export_presets`),q=t.querySelector(`#${e}_import_presets`);null==N||N.addEventListener("click",()=>{const e=function(){const e=y(),t=e.promptPresets.filter(e=>!e.isBuiltin),n=e.schemaPresets.filter(e=>!e.isBuiltin);return JSON.stringify({version:4,exportedAt:(new Date).toISOString(),promptPresets:t,schemaPresets:n},null,2)}();navigator.clipboard.writeText(e),toastr.success("Custom presets copied to clipboard")}),null==q||q.addEventListener("click",()=>vt(this,void 0,void 0,function*(){try{const e=function(e){const t=[];let n=0,s=0;try{const r=JSON.parse(e);if(r.promptPresets&&Array.isArray(r.promptPresets))for(const e of r.promptPresets)try{e.name&&e.prompt&&(P({name:e.name,prompt:e.prompt,stages:e.stages||[]}),n++)}catch(n){t.push(`Failed to import prompt "${e.name}": ${n}`)}if(r.schemaPresets&&Array.isArray(r.schemaPresets))for(const e of r.schemaPresets)try{e.name&&e.schema&&(O({name:e.name,schema:e.schema,stages:e.stages||[]}),s++)}catch(n){t.push(`Failed to import schema "${e.name}": ${n}`)}}catch(e){t.push(`Failed to parse JSON: ${e}`)}return _("info","Presets imported",{promptsImported:n,schemasImported:s,errors:t}),{prompts:n,schemas:s,errors:t}}(yield navigator.clipboard.readText());e.errors.length>0?toastr.error(e.errors.join("\n")):(toastr.success(`Imported ${e.prompts} prompts, ${e.schemas} schemas`),bt())}catch(e){toastr.error("Failed to read clipboard")}}));const D=t.querySelector(`#${e}_debug_mode`),M=t.querySelector(`#${e}_view_logs`),z=t.querySelector(`#${e}_clear_logs`),H=t.querySelector(`#${e}_copy_debug_info`),V=t.querySelector(`#${e}_debug_log_viewer`);null==D||D.addEventListener("change",()=>{C(D.checked),toastr.info("Debug mode "+(D.checked?"enabled":"disabled"))}),null==M||M.addEventListener("click",()=>{null==V||V.classList.toggle("hidden"),(null==V?void 0:V.classList.contains("hidden"))||St()}),null==z||z.addEventListener("click",()=>{m.length=0,St(),toastr.info("Debug logs cleared")}),null==H||H.addEventListener("click",()=>{navigator.clipboard.writeText(h()),toastr.success("Debug info copied to clipboard")})}(),function(){const t=y();(function(t){const n=document.getElementById(`${e}_settings_modal`),s=null==n?void 0:n.querySelector(`#${e}_gen_source`);if(!s)return;s.innerHTML="";const r=document.getElementById("chat_completion_source");r&&Array.from(r.options).forEach(e=>{if(e.value){const t=document.createElement("option");t.value=e.value,t.textContent=e.textContent||e.value,s.appendChild(t)}});0===s.options.length&&["openrouter","openai","claude","makersuite","mistralai","groq"].forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,s.appendChild(t)});s.value=t})(t.generationConfig.source),wt(t.generationConfig.source,t.generationConfig.model)}(),_("info","Settings modal opened",null)})}function $t(t){const n="prompt"===t?x():A();return 0===n.length?`<div class="${e}_preset_empty">No presets</div>`:n.map(n=>`\n    <div class="${e}_preset_item ${n.isBuiltin?"builtin":""}" data-id="${n.id}">\n      <span class="${e}_preset_name">\n        ${n.isBuiltin?'<i class="fa-solid fa-lock"></i>':""}\n        ${Ct(n.name)}\n      </span>\n      ${n.isBuiltin?"":`\n        <button class="${e}_preset_delete" data-type="${t}" data-id="${n.id}" title="Delete">\n          <i class="fa-solid fa-trash"></i>\n        </button>\n      `}\n    </div>\n  `).join("")}function bt(){const t=document.getElementById(`${e}_settings_modal`);if(!t)return;const n=t.querySelector(`#${e}_prompt_presets_list`),s=t.querySelector(`#${e}_schema_presets_list`);n&&(n.innerHTML=$t("prompt")),s&&(s.innerHTML=$t("schema"))}function St(){const t=document.getElementById(`${e}_settings_modal`);if(!t)return;const n=t.querySelector(`#${e}_debug_log_list`),s=t.querySelector(`#${e}_debug_log_detail`);if(!n||!s)return;const r=[...m];n.innerHTML=r.length?r.map((t,n)=>`\n        <div class="${e}_debug_log_entry" data-index="${n}">\n          ${function(e){const t=e.timestamp.toLocaleTimeString();return`${{request:"📤",response:"📥",error:"❌",info:"ℹ️",state:"🔄"}[e.type]} [${t}] ${e.label}`}(t)}\n        </div>\n      `).join(""):`<div class="${e}_debug_log_empty">No logs</div>`,n.querySelectorAll(`.${e}_debug_log_entry`).forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.index||"0",10),n=r[t];n&&s&&(s.textContent=function(e){try{return null===e?"null":void 0===e?"undefined":"string"==typeof e?e:JSON.stringify(e,null,2)}catch(t){return String(e)}}(n.data))})})}function wt(t,n){const s=document.getElementById(`${e}_settings_modal`),r=null==s?void 0:s.querySelector(`#${e}_gen_model`);if(!r)return;r.innerHTML="";const i={openrouter:"model_openrouter_select",openai:"model_openai_select",claude:"model_claude_select",makersuite:"model_google_select",google:"model_google_select",mistralai:"model_mistralai_select",cohere:"model_cohere_select",perplexity:"model_perplexity_select",groq:"model_groq_select",ai21:"model_ai21_select",deepseek:"model_deepseek_select",custom:"model_custom_select"},a=i[t]?document.getElementById(i[t]):null;if(null==a?void 0:a.options.length)Array.from(a.options).forEach(e=>{if(e.value){const t=document.createElement("option");t.value=e.value,t.textContent=e.textContent||e.value,r.appendChild(t)}});else{const e=document.createElement("option");e.value=n||"",e.textContent=n||`No models for ${t}`,r.appendChild(e)}n&&Array.from(r.options).some(e=>e.value===n)?r.value=n:r.options.length&&(r.value=r.options[0].value,b({model:r.options[0].value}))}function Ct(e){const{DOMPurify:t}=SillyTavern.libs,n="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(n,{ALLOWED_TAGS:[]})}var xt=function(e,t,n,s){return new(n||(n=Promise))(function(r,i){function a(e){try{c(s.next(e))}catch(e){i(e)}}function o(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,o)}c((s=s.apply(e,t||[])).next())})};function Et(t){const n=function(e){let t=5381;for(let n=0;n<e.length;n++)t=(t<<5)+t^e.charCodeAt(n);return(t>>>0).toString(36)}(`${t.avatar}::${t.name}`);return`${e}_history_${n}`}function Pt(e,t){return xt(this,void 0,void 0,function*(){const{localforage:n}=SillyTavern.libs,s=Et(e);try{return yield n.setItem(s,{characterName:e.name,characterAvatar:e.avatar,history:t,savedAt:Date.now()}),_("info","Iteration history saved",{key:s,characterName:e.name,historyLength:t.length}),!0}catch(e){return g("Failed to save iteration history",{key:s,error:e}),!1}})}var At=function(e,t,n,s){return new(n||(n=Promise))(function(r,i){function a(e){try{c(s.next(e))}catch(e){i(e)}}function o(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,o)}c((s=s.apply(e,t||[])).next())})};let Rt=null,Ot=null;const kt=[];function It(){const{eventSource:e,eventTypes:t}=SillyTavern.getContext(),n=()=>{_("info","API status changed",{isReady:Pe()}),Tt()},s=()=>{_("info","Main API changed",null),Tt(),Wt()},r=e=>{var t,n,s;const r=null!==(n=null===(t=e.detail)||void 0===t?void 0:t.character)&&void 0!==n?n:e.character,i=void 0!==(null===(s=e.detail)||void 0===s?void 0:s.id)?parseInt(e.detail.id,10):e.id;_("info","Character edited externally",{id:i,name:null==r?void 0:r.name}),function(e){var t;if(!Rt||null===Rt.pipeline.characterIndex)return;const{characters:n}=SillyTavern.getContext(),s=n,r=Rt.pipeline.characterIndex;if(void 0!==e&&e!==r)return;if(r>=0&&r<s.length){const e=s[r];e.name===(null===(t=Rt.pipeline.character)||void 0===t?void 0:t.name)?(Rt.pipeline=Object.assign(Object.assign({},Rt.pipeline),{character:e}),Ht(),Wt(),_("info","Character refreshed",{name:e.name})):Lt()}else Lt()}(i)},i=e=>{_("info","Character deleted",{id:e.id}),function(e){if(!Rt)return;const t=Rt.pipeline.characterIndex;if(null===t)return;if(t===e)Lt(),toastr.warning("Selected character was deleted");else if(t>e){const{characters:e}=SillyTavern.getContext(),n=e,s=t-1;s>=0&&s<n.length?(Rt.pipeline=Object.assign(Object.assign({},Rt.pipeline),{characterIndex:s,character:n[s]}),_("info","Character index adjusted after deletion",{oldIndex:t,newIndex:s})):Lt()}}(e.id)},a=()=>{_("info","OAI preset changed",null),Rt&&Wt()},o=()=>{_("info","Chat completion source changed",null),Tt(),Wt()},c=()=>{_("info","Chat completion model changed",null),Tt(),Wt()};e.on(t.ONLINE_STATUS_CHANGED,n),e.on(t.MAIN_API_CHANGED,s),e.on(t.CHARACTER_EDITED,r),e.on(t.CHARACTER_DELETED,i),e.on(t.OAI_PRESET_CHANGED_AFTER,a),e.on(t.CHATCOMPLETION_SOURCE_CHANGED,o),e.on(t.CHATCOMPLETION_MODEL_CHANGED,c),kt.push(()=>e.removeListener(t.ONLINE_STATUS_CHANGED,n),()=>e.removeListener(t.MAIN_API_CHANGED,s),()=>e.removeListener(t.CHARACTER_EDITED,r),()=>e.removeListener(t.CHARACTER_DELETED,i),()=>e.removeListener(t.OAI_PRESET_CHANGED_AFTER,a),()=>e.removeListener(t.CHATCOMPLETION_SOURCE_CHANGED,o),()=>e.removeListener(t.CHATCOMPLETION_MODEL_CHANGED,c)),_("info","Event listeners subscribed",{count:kt.length})}function Tt(){if(!Ot)return;const t=Ae(),n=Ot.querySelector(`.${e}_api_status`);if(n){n.className=`${e}_api_status ${t.isReady?"connected":"disconnected"}`;const s=n.querySelector("span");s&&(s.textContent=t.source)}Vt()}function Lt(){Rt&&(Rt.abortController&&Rt.abortController.abort(),_("info","Character invalidated, clearing selection",null),Rt.pipeline=pe(Rt.pipeline,null,null),Rt.isGenerating=!1,Rt.isRefining=!1,Rt.abortController=null,Rt.historyLoaded=!1,zt(),toastr.info("Character selection cleared"))}let jt=null;function Nt(){return At(this,void 0,void 0,function*(){const{Popup:t,POPUP_TYPE:n}=SillyTavern.getContext(),{DOMPurify:a}=SillyTavern.libs;let o;qt=!1,Rt={pipeline:le(),isGenerating:!1,isRefining:!1,abortController:null,activeStageView:"score",historyLoaded:!1,debouncedFunctions:[]};try{o=function(){const t=Ae();return`\n    <div class="${e}_popup" id="${e}_popup">\n      \x3c!-- Header --\x3e\n      <div class="${e}_popup_header">\n        <div class="${e}_popup_title">\n          <i class="fa-solid fa-wand-magic-sparkles"></i>\n          <span>Character Tools</span>\n        </div>\n        <div class="${e}_popup_header_right">\n          <div class="${e}_api_status ${t.isReady?"connected":"disconnected"}">\n            <i class="fa-solid fa-circle"></i>\n            <span>${t.source}</span>\n          </div>\n          <button id="${e}_settings_btn" class="${e}_icon_btn" title="Settings">\n            <i class="fa-solid fa-gear"></i>\n          </button>\n          <button id="${e}_close_btn" class="${e}_icon_btn" title="Close">\n            <i class="fa-solid fa-xmark"></i>\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Character Section --\x3e\n      <div class="${e}_section" id="${e}_character_section">\n        <div class="${e}_section_header">\n          <i class="fa-solid fa-user"></i>\n          <span>Character</span>\n        </div>\n        <div id="${e}_character_select_container"></div>\n      </div>\n\n      \x3c!-- Pipeline Section --\x3e\n      <div class="${e}_section" id="${e}_pipeline_section">\n        <div class="${e}_section_header">\n          <i class="fa-solid fa-diagram-project"></i>\n          <span>Pipeline</span>\n        </div>\n        <div id="${e}_pipeline_nav_container"></div>\n      </div>\n\n      \x3c!-- Stage Config Section --\x3e\n      <div class="${e}_section" id="${e}_stage_section">\n        <div class="${e}_section_header">\n          <i class="fa-solid ${i.score}" id="${e}_stage_icon"></i>\n          <span id="${e}_stage_title">Score</span>\n        </div>\n        <div id="${e}_stage_config_container"></div>\n      </div>\n\n      \x3c!-- Results Section --\x3e\n      <div class="${e}_section ${e}_section_grow" id="${e}_results_section">\n        <div class="${e}_section_header">\n          <i class="fa-solid fa-file-lines"></i>\n          <span>Results</span>\n          <span id="${e}_iteration_indicator" class="${e}_iteration_indicator hidden"></span>\n        </div>\n        <div id="${e}_results_container"></div>\n        <div id="${e}_iteration_history_container"></div>\n      </div>\n    </div>\n  `}()}catch(e){return g("Failed to build popup content",e),toastr.error("Failed to open Character Tools. Check console for details."),void(Rt=null)}if(new t(a.sanitize(o),n.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:!1,cancelButton:!1}).show().then(()=>{(null==Rt?void 0:Rt.abortController)&&Rt.abortController.abort(),kt.forEach(e=>e()),kt.length=0,_("info","Event listeners unsubscribed",null),jt&&(document.removeEventListener("keydown",jt),jt=null),(null==Rt?void 0:Rt.debouncedFunctions)&&(Rt.debouncedFunctions.forEach(e=>e.cancel()),Rt.debouncedFunctions=[]),null==Le||Le.clear(),Rt=null,Ot=null,qt=!1,_("info","Popup closed",null)}),yield new Promise(e=>setTimeout(e,0)),Ot=document.getElementById(`${e}_popup`),!Ot)return g("Popup element not found after creation",null),toastr.error("Failed to initialize Character Tools popup."),void(Rt=null);try{It(),jt=e=>{Rt&&("Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),Rt.isGenerating||Rt.isRefining||Mt(Rt.activeStageView)),"Escape"===e.key&&(Rt.isGenerating||Rt.isRefining)&&Rt.abortController&&Rt.abortController.abort())},document.addEventListener("keydown",jt);const{characters:t}=SillyTavern.getContext(),n=t;!function(t){var n,i;if(!Rt||!Ot)return;const a=Ot.querySelector(`#${e}_character_select_container`);a&&(a.innerHTML=function(t,n,s){const r=null!==n?t[n]:null;return`\n    <div class="${e}_char_select">\n      \x3c!-- Search --\x3e\n      <div class="${e}_search_wrapper ${r?"hidden":""}">\n        <div class="${e}_search_container">\n          <i class="fa-solid fa-search ${e}_search_icon"></i>\n          <input\n            type="text"\n            id="${e}_char_search"\n            class="text_pole ${e}_search_input"\n            placeholder="Search characters..."\n            autocomplete="off"\n          >\n        </div>\n        <div id="${e}_char_dropdown" class="${e}_dropdown hidden"></div>\n      </div>\n\n      \x3c!-- Selected Character Preview --\x3e\n      ${r?Ne(r,s):""}\n    </div>\n  `}(t,Rt.pipeline.characterIndex,Rt.pipeline.selectedFields),function(){if(!Ot||!Rt)return;if(qt)return void _("info","Character select listeners already initialized, skipping",null);const{Fuse:t,lodash:n}=SillyTavern.libs,s=Ot.querySelector(`#${e}_character_select_container`);if(!s)return;const r=s.querySelector(`#${e}_char_search`),i=s.querySelector(`#${e}_char_dropdown`);if(!r||!i)return;qt=!0;let a=-1,o=[];const c=()=>{const{characters:n}=SillyTavern.getContext(),s=n.map((e,t)=>({char:e,index:t})).filter(({char:e})=>null==e?void 0:e.name),c=new t(s,{keys:["char.name","char.description"],threshold:.4,includeScore:!0,minMatchCharLength:1}),l=r.value.trim();if(!l)return i.classList.add("hidden"),void(o=[]);const u=c.search(l,{limit:10});if(o=u.map(e=>e.item),0===o.length)return i.innerHTML=`<div class="${e}_dropdown_empty">No characters found</div>`,void i.classList.remove("hidden");a=-1,Me(o,i,-1),i.classList.remove("hidden")},l=n.debounce(c,150);Rt.debouncedFunctions.push(l),r.addEventListener("input",l),r.addEventListener("keydown",e=>{0!==o.length&&("ArrowDown"===e.key?(e.preventDefault(),a=Math.min(a+1,o.length-1),Me(o,i,a)):"ArrowUp"===e.key?(e.preventDefault(),a=Math.max(a-1,0),Me(o,i,a)):"Enter"===e.key&&a>=0?(e.preventDefault(),Dt(o[a].char,o[a].index),i.classList.add("hidden"),r.value=""):"Escape"===e.key&&(i.classList.add("hidden"),r.value=""))});const u=e=>{r.contains(e.target)||i.contains(e.target)||i.classList.add("hidden")};document.addEventListener("click",u),kt.push(()=>document.removeEventListener("click",u)),i.addEventListener("click",t=>{const n=t.target.closest(`.${e}_dropdown_item`);if(n){const e=parseInt(n.getAttribute("data-index")||"-1",10),t=o.find(t=>t.index===e);t&&(Dt(t.char,t.index),i.classList.add("hidden"),r.value="")}}),s.addEventListener("click",t=>{const n=t.target;if(n.closest(`#${e}_char_clear`)){if(!Rt)return;return Rt.pipeline=pe(Rt.pipeline,null,null),Rt.historyLoaded=!1,void zt()}if(n.closest(`#${e}_select_all_fields`)&&(null==Rt?void 0:Rt.pipeline.character))return Rt.pipeline=(r=Rt.pipeline).character?Object.assign(Object.assign({},r),{selectedFields:ue(r.character)}):r,Ht(),void Wt();var r;if(n.closest(`#${e}_select_none_fields`)&&Rt)return Rt.pipeline=function(e){return Object.assign(Object.assign({},e),{selectedFields:{}})}(Rt.pipeline),Ht(),void Wt();const i=n.closest(`.${e}_field_toggle`);if(i){const t=i.getAttribute("data-field"),n=s.querySelector(`#${e}_field_content_${t}`),r=i.querySelector("i");n&&r&&(n.classList.toggle("hidden"),r.classList.toggle("fa-chevron-right"),r.classList.toggle("fa-chevron-down"))}}),s.addEventListener("change",t=>{const n=t.target;if(n.classList.contains(`${e}_field_checkbox`)&&Rt){const e=n.dataset.field;if("true"===n.dataset.isArray){const t=oe(Rt.pipeline.character).find(t=>t.key===e);if(t&&Array.isArray(t.rawValue)){const s=n.checked?t.rawValue.map((e,t)=>t):[];Rt.pipeline=de(Rt.pipeline,e,s)}}else Rt.pipeline=de(Rt.pipeline,e,n.checked);return Ht(),void Wt()}if(n.classList.contains(`${e}_alt_greeting_checkbox`)&&Rt){const e=n.dataset.field,t=parseInt(n.dataset.index,10),s=Rt.pipeline.selectedFields[e]||[];let r;return r=n.checked?[...s,t].sort((e,t)=>e-t):s.filter(e=>e!==t),Rt.pipeline=de(Rt.pipeline,e,r),Ht(),void Wt()}})}());const o=Ot.querySelector(`#${e}_pipeline_nav_container`);o&&(o.innerHTML=He(Rt.pipeline.selectedStages,Rt.pipeline.stageStatus,Rt.activeStageView,!!Rt.pipeline.character),function(){if(!Ot||!Rt)return;const t=Ot.querySelector(`#${e}_pipeline_nav_container`);if(!t)return;t.addEventListener("change",t=>{const n=t.target;if(n.classList.contains(`${e}_stage_checkbox`)){const e=n.getAttribute("data-stage");e&&Rt&&(Rt.pipeline=function(e,t){const n=new Set(e.selectedStages);n.has(t)?n.delete(t):n.add(t);const r=s.filter(e=>n.has(e));return _("state","Stage toggled",{stage:t,selected:r}),Object.assign(Object.assign({},e),{selectedStages:r})}(Rt.pipeline,e),Vt(),Gt())}}),t.addEventListener("click",t=>At(this,void 0,void 0,function*(){const n=t.target.closest(`.${e}_stage_btn`);if(n&&Rt){const e=n.getAttribute("data-stage");e&&(Rt.activeStageView=e,Ft(),Gt(),Wt(),Vt())}t.target.closest(`#${e}_run_selected_btn`)&&Rt&&Mt(Rt.activeStageView);t.target.closest(`#${e}_run_all_btn`)&&Rt&&function(){At(this,void 0,void 0,function*(){Rt&&(Rt.pipeline=function(e,t){const n=s.filter(e=>t.includes(e));return Object.assign(Object.assign({},e),{selectedStages:n})}(Rt.pipeline,[...s]),Vt(),Gt(),yield function(){return At(this,void 0,void 0,function*(){if(!Rt||Rt.isGenerating||Rt.isRefining)return;if(!Pe())return void toastr.error("API is not connected");if(!Rt.pipeline.character)return void toastr.error("No character selected");if(Object.values(Rt.pipeline.selectedFields).some(e=>!0===e||Array.isArray(e)&&e.length>0))if(0!==Rt.pipeline.selectedStages.length)for(const e of Rt.pipeline.selectedStages){const t=Rt.pipeline.stageStatus[e];if("complete"===t||"skipped"===t)continue;if(Rt.activeStageView=e,Ft(),Vt(),Gt(),yield Mt(e),!Rt)break;if("complete"!==Rt.pipeline.stageStatus[e])break}else toastr.error("No stages selected");else toastr.error("No fields selected")})}())})}();if(t.target.closest(`#${e}_reset_pipeline_btn`)&&Rt){const{Popup:e,POPUP_RESULT:t}=SillyTavern.getContext();if((yield e.show.confirm("Reset Pipeline?","This will clear all results and iteration history. Continue?"))!==t.AFFIRMATIVE)return;Rt.pipeline=function(e,t=!1){const n=le();return t&&e.character&&(n.character=e.character,n.characterIndex=e.characterIndex,n.selectedFields=e.selectedFields),_("state","Pipeline reset",{keepCharacter:t,hasCharacter:!!n.character}),n}(Rt.pipeline,!0),Rt.historyLoaded=!0,zt()}}))}());const c=Ot.querySelector(`#${e}_stage_config_container`);c&&(c.innerHTML=function(t,n,s,i){var a,o,c,l;const u=x(t),d=A(t);let p=n.customPrompt;if(n.promptPresetId){const e=E(n.promptPresetId);e&&(p=e.prompt)}let f=n.customSchema;if(n.schemaPresetId){const e=R(n.schemaPresetId);e&&(f=JSON.stringify(e.schema,null,2))}let m="",_={valid:!0};n.useStructuredOutput&&f.trim()&&(_=Y(f),m=_.valid?(null===(a=_.warnings)||void 0===a?void 0:a.length)?`<div class="${e}_schema_status warning"><i class="fa-solid fa-triangle-exclamation"></i> ${_.warnings.length} warning(s)</div>`:`<div class="${e}_schema_status success"><i class="fa-solid fa-circle-check"></i> Valid schema</div>`:`<div class="${e}_schema_status error"><i class="fa-solid fa-circle-xmark"></i> ${Ye(_.error||"Invalid schema")}</div>`);let g='<i class="fa-solid fa-microchip"></i> Select a character',h="";s&&(g=`<i class="fa-solid fa-microchip"></i> ~${s.tokens.toLocaleString()} tokens (${s.percentage}%)`,s.percentage>80?h="danger":s.percentage>50&&(h="warning"));const v=n.promptPresetId?(null===(o=E(n.promptPresetId))||void 0===o?void 0:o.prompt)!==p:p.trim().length>0,y=n.schemaPresetId?JSON.stringify(null===(c=R(n.schemaPresetId))||void 0===c?void 0:c.schema,null,2)!==f:f.trim().length>0,$=n.useStructuredOutput&&f.trim()&&((null===(l=_.warnings)||void 0===l?void 0:l.length)||!_.valid);return`\n    <div class="${e}_stage_config">\n      \x3c!-- Prompt Section --\x3e\n      <div class="${e}_config_group">\n        <div class="${e}_config_header">\n          <span class="${e}_config_label">Prompt</span>\n          <div class="${e}_config_header_actions">\n            <button\n              id="${e}_save_prompt_preset_btn"\n              class="${e}_icon_btn"\n              title="Save as Preset"\n              ${v?"":"disabled"}\n            >\n              <i class="fa-solid fa-floppy-disk"></i>\n            </button>\n            <select id="${e}_prompt_preset_select" class="${e}_preset_select">\n              <option value="">Custom</option>\n              ${Be(u,n.promptPresetId)}\n            </select>\n          </div>\n        </div>\n        <textarea\n          id="${e}_custom_prompt"\n          class="${e}_prompt_textarea text_pole"\n          placeholder="Enter your prompt for the ${r[t]} stage..."\n        >${Ye(p)}</textarea>\n        <div class="${e}_config_footer">\n          <span class="${e}_char_count">${p.length.toLocaleString()} chars</span>\n        </div>\n      </div>\n\n      \x3c!-- Structured Output Toggle --\x3e\n      <div class="${e}_config_group">\n        <label class="${e}_checkbox_label">\n          <input\n            type="checkbox"\n            id="${e}_use_structured"\n            ${n.useStructuredOutput?"checked":""}\n          >\n          <span>Use Structured Output (JSON Schema)</span>\n        </label>\n      </div>\n\n      \x3c!-- Schema Section --\x3e\n      <div class="${e}_schema_section ${n.useStructuredOutput?"":"hidden"}">\n        <div class="${e}_config_header">\n          <span class="${e}_config_label">JSON Schema</span>\n          <div class="${e}_config_header_actions">\n            <button\n              id="${e}_save_schema_preset_btn"\n              class="${e}_icon_btn"\n              title="Save as Preset"\n              ${y&&f.trim()?"":"disabled"}\n            >\n              <i class="fa-solid fa-floppy-disk"></i>\n            </button>\n            <select id="${e}_schema_preset_select" class="${e}_preset_select">\n              <option value="">Custom</option>\n              ${Be(d,n.schemaPresetId)}\n            </select>\n          </div>\n        </div>\n        <textarea\n          id="${e}_custom_schema"\n          class="${e}_schema_textarea text_pole"\n          placeholder='{"name": "MySchema", "value": {"type": "object", ...}}'\n        >${Ye(f)}</textarea>\n        ${m}\n\n        \x3c!-- Schema Actions --\x3e\n        <div class="${e}_schema_actions">\n          <button\n            id="${e}_generate_schema_btn"\n            class="menu_button menu_button_icon"\n            title="Generate schema from description"\n          >\n            <i class="fa-solid fa-wand-magic-sparkles"></i>\n            <span>Generate</span>\n          </button>\n          <button\n            id="${e}_validate_schema_btn"\n            class="menu_button menu_button_icon"\n            title="Validate schema"\n            ${f.trim()?"":"disabled"}\n          >\n            <i class="fa-solid fa-check-double"></i>\n            <span>Validate</span>\n          </button>\n          <button\n            id="${e}_fix_schema_btn"\n            class="menu_button menu_button_icon"\n            title="Auto-fix schema"\n            ${$?"":"disabled"}\n          >\n            <i class="fa-solid fa-wrench"></i>\n            <span>Auto-Fix</span>\n          </button>\n          <button\n            id="${e}_format_schema_btn"\n            class="menu_button menu_button_icon"\n            title="Format/prettify JSON"\n            ${f.trim()?"":"disabled"}\n          >\n            <i class="fa-solid fa-align-left"></i>\n            <span>Format</span>\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Actions --\x3e\n      <div class="${e}_config_actions">\n        <div id="${e}_token_estimate" class="${e}_token_estimate ${h}">\n          ${g}\n        </div>\n        <button\n          id="${e}_preview_prompt_btn"\n          class="menu_button"\n          title="Preview the complete prompt that will be sent"\n          ${i?"":"disabled"}\n        >\n          <i class="fa-solid fa-eye"></i>\n          <span>Preview</span>\n        </button>\n      </div>\n    </div>\n  `}(Rt.activeStageView,Rt.pipeline.configs[Rt.activeStageView],null,!!Rt.pipeline.character),function(){if(!Ot||!Rt)return;const t=Ot.querySelector(`#${e}_stage_config_container`);if(!t)return;t.addEventListener("change",t=>{const n=t.target;if(n.id===`${e}_prompt_preset_select`&&Rt){const e=n.value||null;Rt.pipeline=me(Rt.pipeline,Rt.activeStageView,{promptPresetId:e}),Ut(),Wt()}if(n.id===`${e}_schema_preset_select`&&Rt){const e=n.value||null;Rt.pipeline=me(Rt.pipeline,Rt.activeStageView,{schemaPresetId:e}),Ut()}});const{lodash:n}=SillyTavern.libs,s=n.debounce(t=>{if(!Rt)return void _("info","Debounced input handler fired after popup closed, ignoring",null);const n=t.target;n.id===`${e}_custom_prompt`&&(Rt.pipeline=me(Rt.pipeline,Rt.activeStageView,{customPrompt:n.value,promptPresetId:null}),Wt(),Ut()),n.id===`${e}_custom_schema`&&(Rt.pipeline=me(Rt.pipeline,Rt.activeStageView,{customSchema:n.value,schemaPresetId:null}),Ut())},300);Rt.debouncedFunctions.push(s),t.addEventListener("input",s),t.addEventListener("change",t=>{const n=t.target;n.id===`${e}_use_structured`&&Rt&&(Rt.pipeline=me(Rt.pipeline,Rt.activeStageView,{useStructuredOutput:n.checked}),Ut())}),t.addEventListener("click",t=>At(this,void 0,void 0,function*(){const n=t.target;if(n.closest(`#${e}_run_stage_btn`)&&Rt)return void Mt(Rt.activeStageView);if(n.closest(`#${e}_preview_prompt_btn`)&&Rt)return void(yield function(){return At(this,void 0,void 0,function*(){if(!(null==Rt?void 0:Rt.pipeline.character))return void toastr.warning("Select a character first");const{Popup:t,POPUP_TYPE:n,getTokenCountAsync:s}=SillyTavern.getContext(),{DOMPurify:i}=SillyTavern.libs,a=Rt.activeStageView,o=ye(Rt.pipeline,a),c=S(a);if(!o)return void toastr.warning("No prompt configured");const l=yield s(o),u=yield s(c),d=l+u,p=`\n      <div class="${e}_prompt_preview">\n        <h3>Prompt Preview - ${r[a]}</h3>\n\n        <div class="${e}_preview_section">\n          <div class="${e}_preview_header">\n            <h4>System Prompt</h4>\n            <span class="${e}_preview_tokens">${u.toLocaleString()} tokens</span>\n          </div>\n          <pre class="${e}_preview_content">${i.sanitize(c,{ALLOWED_TAGS:[]})}</pre>\n        </div>\n\n        <div class="${e}_preview_section">\n          <div class="${e}_preview_header">\n            <h4>Stage Prompt</h4>\n            <span class="${e}_preview_tokens">${l.toLocaleString()} tokens</span>\n          </div>\n          <pre class="${e}_preview_content">${i.sanitize(o,{ALLOWED_TAGS:[]})}</pre>\n        </div>\n\n        <div class="${e}_preview_total">\n          <strong>Total: ${d.toLocaleString()} tokens</strong>\n        </div>\n      </div>\n    `;yield new t(i.sanitize(p),n.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:"Close",cancelButton:!1}).show()})}());if(n.closest(`#${e}_save_prompt_preset_btn`)&&Rt){const t=null==Ot?void 0:Ot.querySelector(`#${e}_custom_prompt`);if(t){const e=yield function(e,t){return Ve(this,void 0,void 0,function*(){const{Popup:n,POPUP_RESULT:s}=SillyTavern.getContext();if(!t.trim())return toastr.warning("No prompt content to save"),{success:!1};const i=yield n.show.input("Save Prompt Preset","Enter a name for this preset:",`Custom ${r[e]} Prompt`);if(null===i||i===s.CANCELLED)return{success:!1};if(!i.trim())return toastr.warning("Preset name cannot be empty"),{success:!1};try{const n=P({name:i.trim(),prompt:t,stages:[e]});return toastr.success(`Prompt preset "${i}" saved`),{success:!0,presetId:n.id}}catch(e){return toastr.error(`Failed to save preset: ${e.message}`),{success:!1}}})}(Rt.activeStageView,t.value);e.success&&e.presetId&&(Rt.pipeline=me(Rt.pipeline,Rt.activeStageView,{promptPresetId:e.presetId,customPrompt:""}),Ut())}return}if(n.closest(`#${e}_save_schema_preset_btn`)&&Rt){const t=null==Ot?void 0:Ot.querySelector(`#${e}_custom_schema`);if(t){const e=yield function(e,t){return Ve(this,void 0,void 0,function*(){const{Popup:n,POPUP_RESULT:s}=SillyTavern.getContext();if(!t.trim())return toastr.warning("No schema content to save"),{success:!1};const i=Y(t);if(!i.valid)return toastr.error(`Invalid schema: ${i.error}`),{success:!1};const a=yield n.show.input("Save Schema Preset","Enter a name for this preset:",`Custom ${r[e]} Schema`);if(null===a||a===s.CANCELLED)return{success:!1};if(!a.trim())return toastr.warning("Preset name cannot be empty"),{success:!1};try{const t=O({name:a.trim(),schema:i.schema,stages:[e]});return toastr.success(`Schema preset "${a}" saved`),{success:!0,presetId:t.id}}catch(e){return toastr.error(`Failed to save preset: ${e.message}`),{success:!1}}})}(Rt.activeStageView,t.value);e.success&&e.presetId&&(Rt.pipeline=me(Rt.pipeline,Rt.activeStageView,{schemaPresetId:e.presetId,customSchema:""}),Ut())}return}if(n.closest(`#${e}_generate_schema_btn`)&&Rt){const t=yield Fe();if(t){const n=null==Ot?void 0:Ot.querySelector(`#${e}_custom_schema`);n&&(n.value=t,Rt.pipeline=me(Rt.pipeline,Rt.activeStageView,{customSchema:t,schemaPresetId:null}),Ut())}return}if(n.closest(`#${e}_validate_schema_btn`)&&Rt){const t=null==Ot?void 0:Ot.querySelector(`#${e}_custom_schema`);return void(t&&(yield function(e){return Ve(this,void 0,void 0,function*(){var t,n;if(!e.trim())return void toastr.warning("No schema to validate");const s=Y(e);if(!s.valid)return void toastr.error(`Invalid: ${s.error}`);const{Popup:r,POPUP_TYPE:i}=SillyTavern.getContext();if(null===(t=s.warnings)||void 0===t?void 0:t.length)if(s.warnings.length>2){const e=`\n                <h3>Schema Valid with Warnings</h3>\n                <ul>\n                    ${s.warnings.map(e=>`<li>${e}</li>`).join("")}\n                </ul>\n            `;yield new r(e,i.TEXT,"",{wide:!1}).show()}else toastr.warning(`Valid with ${s.warnings.length} warning(s):\n${s.warnings.join("\n")}`);else if(null===(n=s.info)||void 0===n?void 0:n.length)if(s.info.length>2){const e=`\n                <h3>Schema Valid</h3>\n                <ul>\n                    ${s.info.map(e=>`<li>${e}</li>`).join("")}\n                </ul>\n            `;yield new r(e,i.TEXT,"",{wide:!1}).show()}else toastr.success(`Valid!\n${s.info.join("\n")}`);else toastr.success("Schema is valid!")})}(t.value)))}if(n.closest(`#${e}_fix_schema_btn`)&&Rt){const t=null==Ot?void 0:Ot.querySelector(`#${e}_custom_schema`);if(t){const e=function(e){var t;if(!e.trim())return toastr.warning("No schema to fix"),null;const n=Y(e);if(!n.schema)return toastr.error("Cannot fix: schema is not valid JSON or missing required structure"),null;try{const e=Z(n.schema),s=JSON.stringify(e,null,2),r=Y(s);return r.valid?(null===(t=r.warnings)||void 0===t?void 0:t.length)?toastr.info(`Fixed! ${r.warnings.length} warning(s) remain`):toastr.success("Schema fixed successfully!"):toastr.warning("Auto-fix applied but schema still has issues"),s}catch(e){return toastr.error(`Fix failed: ${e.message}`),null}}(t.value);e&&(t.value=e,Rt.pipeline=me(Rt.pipeline,Rt.activeStageView,{customSchema:e,schemaPresetId:null}),Ut())}return}if(n.closest(`#${e}_format_schema_btn`)&&Rt){const t=null==Ot?void 0:Ot.querySelector(`#${e}_custom_schema`);if(t){const e=function(e){if(!e.trim())return toastr.warning("No schema to format"),null;try{const t=JSON.parse(e),n=JSON.stringify(t,null,2);return toastr.success("Schema formatted"),n}catch(e){return toastr.error(`Cannot format: ${e.message}`),null}}(t.value);e&&(t.value=e,Rt.pipeline=me(Rt.pipeline,Rt.activeStageView,{customSchema:e,schemaPresetId:null}),Ut())}return}}))}());const l=Ot.querySelector(`#${e}_results_container`);l&&(l.innerHTML=(u=Rt.activeStageView,d=Rt.pipeline.results[Rt.activeStageView],p=Rt.pipeline.stageStatus[Rt.activeStageView],Rt.isGenerating&&"running"===p?ct(u):d?ut(u,d):lt(u,p)),function(){if(!Ot||!Rt)return;const t=Ot.querySelector(`#${e}_results_container`);if(!t)return;t.addEventListener("click",t=>At(this,void 0,void 0,function*(){const n=t.target;if(n.closest(`#${e}_regenerate_btn`)&&Rt&&(Rt.pipeline=function(e,t){return _("state","Stage result cleared",{stage:t}),Object.assign(Object.assign({},e),{results:Object.assign(Object.assign({},e.results),{[t]:null}),stageStatus:Object.assign(Object.assign({},e.stageStatus),{[t]:"pending"})})}(Rt.pipeline,Rt.activeStageView),Mt(Rt.activeStageView)),n.closest(`#${e}_lock_btn`)&&Rt&&(Rt.pipeline=function(e,t){const n=e.results[t];return n?(_("state","Stage locked",{stage:t}),Object.assign(Object.assign({},e),{results:Object.assign(Object.assign({},e.results),{[t]:Object.assign(Object.assign({},n),{locked:!0})})})):e}(Rt.pipeline,Rt.activeStageView),Gt()),n.closest(`#${e}_unlock_btn`)&&Rt&&(Rt.pipeline=function(e,t){const n=e.results[t];return n?(_("state","Stage unlocked",{stage:t}),Object.assign(Object.assign({},e),{results:Object.assign(Object.assign({},e.results),{[t]:Object.assign(Object.assign({},n),{locked:!1})})})):e}(Rt.pipeline,Rt.activeStageView),Gt()),n.closest(`#${e}_continue_btn`)&&Rt){const e=we(Rt.pipeline,Rt.activeStageView);e&&(Rt.activeStageView=e,Ft(),Gt(),Wt(),Vt())}var s;if(n.closest(`#${e}_run_analyze_btn`)&&Rt&&(Rt.activeStageView="analyze",Ft(),Gt(),Vt(),Mt("analyze")),n.closest(`#${e}_refine_btn`)&&Rt&&function(){At(this,void 0,void 0,function*(){if(!Rt||Rt.isGenerating||Rt.isRefining)return;if(!Pe())return void toastr.error("API is not connected");const t=fe(Rt.pipeline);if(!t.canRun)return void toastr.warning(t.reason||"Cannot refine");const n=function(e){const t=[],n=[];e.character||t.push("No character selected"),e.results.rewrite||t.push("No rewrite to refine"),e.results.analyze||t.push("Run analyze first to identify issues");const{onlineStatus:s}=SillyTavern.getContext();"Valid"!==s&&"Connected"!==s&&t.push("API is not connected");const r=e.iterationHistory.length>0?e.iterationHistory[e.iterationHistory.length-1]:null;return"accept"===(null==r?void 0:r.verdict)&&n.push("Last analysis suggested accepting the rewrite"),e.iterationCount>=5&&n.push(`Already at iteration ${e.iterationCount+1} - consider accepting or starting fresh`),{valid:0===t.length,errors:t,warnings:n}}(Rt.pipeline);if(!n.valid)return void toastr.error(n.errors.join("\n"));n.warnings.length>0&&toastr.warning(n.warnings.join("\n"));const s=Object.assign(Object.assign({},Rt.pipeline),{results:Object.assign({},Rt.pipeline.results)}),r={iterationCount:Rt.pipeline.iterationCount,iterationHistory:[...Rt.pipeline.iterationHistory],analyzeResult:Rt.pipeline.results.analyze};Rt.pipeline=ve(Rt.pipeline),Rt.isRefining=!0,Rt.abortController=new AbortController;const i=null==Ot?void 0:Ot.querySelector(`#${e}_results_container`);var a;i&&(i.innerHTML=(a=Rt.pipeline.iterationCount,`\n    <div class="${e}_results_loading">\n      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>\n      <p>Refining (Iteration #${a+1})...</p>\n      <button id="${e}_cancel_btn" class="menu_button">\n        <i class="fa-solid fa-stop"></i>\n        <span>Cancel</span>\n      </button>\n    </div>\n  `)),Bt(),Yt();try{const e=yield function(e,t){return xe(this,void 0,void 0,function*(){const n=SillyTavern.getContext(),s=y();if(null==t?void 0:t.aborted)return{success:!1,error:"Generation cancelled"};if(!e.character)return{success:!1,error:"No character selected"};if(!e.results.rewrite||!e.results.analyze)return{success:!1,error:"Refinement requires both rewrite and analyze results"};if(!Pe())return g("API not ready",{onlineStatus:n.onlineStatus}),{success:!1,error:"API is not connected. Check your connection settings."};const r=$e(e);if(!r)return{success:!1,error:"Failed to build refinement prompt"};const i=Ie(r,e.character.name,n.name1||"User"),a=S("rewrite");return _("info","Starting refinement generation",{iteration:e.iterationCount+1,character:e.character.name,promptLength:i.length}),yield Oe(a,i,null,t,s.useCurrentSettings)})}(s,Rt.abortController.signal);e.success?(Rt.pipeline=function(e,t){const n=Object.assign(Object.assign({},t),{timestamp:Date.now(),locked:!1});return _("state","Refinement completed",{iteration:e.iterationCount,responseLength:t.response.length}),Object.assign(Object.assign({},e),{currentStage:null,results:Object.assign(Object.assign({},e.results),{rewrite:n}),stageStatus:Object.assign(Object.assign({},e.stageStatus),{rewrite:"complete",analyze:"pending"})})}(Rt.pipeline,{response:e.response,isStructured:!1,promptUsed:"[Refinement prompt]",schemaUsed:null}),toastr.success(`Refinement #${Rt.pipeline.iterationCount} complete`),Rt.pipeline.character&&(yield Pt(Rt.pipeline.character,Rt.pipeline.iterationHistory)),Rt.activeStageView="rewrite"):(Rt.pipeline=Object.assign(Object.assign({},Rt.pipeline),{iterationCount:r.iterationCount,iterationHistory:r.iterationHistory,results:Object.assign(Object.assign({},Rt.pipeline.results),{analyze:r.analyzeResult}),stageStatus:Object.assign(Object.assign({},Rt.pipeline.stageStatus),{analyze:"complete"}),isRefining:r.iterationCount>0}),"Generation cancelled"!==e.error&&toastr.error(e.error))}catch(e){Rt.pipeline=Object.assign(Object.assign({},Rt.pipeline),{iterationCount:r.iterationCount,iterationHistory:r.iterationHistory,results:Object.assign(Object.assign({},Rt.pipeline.results),{analyze:r.analyzeResult}),stageStatus:Object.assign(Object.assign({},Rt.pipeline.stageStatus),{analyze:"complete"}),isRefining:r.iterationCount>0}),toastr.error(e.message)}finally{Rt.isRefining=!1,Rt.abortController=null,zt()}})}(),n.closest(`#${e}_accept_btn`)&&Rt&&(Rt.pipeline=(s=Rt.pipeline).results.rewrite?(_("state","Rewrite accepted as final",{iteration:s.iterationCount}),Object.assign(Object.assign({},s),{results:Object.assign(Object.assign({},s.results),{rewrite:Object.assign(Object.assign({},s.results.rewrite),{locked:!0})}),isRefining:!1})):s,toastr.success("Rewrite accepted as final"),zt()),n.closest(`#${e}_copy_btn`)&&Rt){const e=Rt.pipeline.results[Rt.activeStageView];e&&(yield navigator.clipboard.writeText(e.response),toastr.success("Copied to clipboard"))}n.closest(`#${e}_export_btn`)&&Rt&&function(){if(!(null==Rt?void 0:Rt.pipeline.character))return;const{moment:e}=SillyTavern.libs,t=Rt.pipeline,n=t.character,s=Se(t);if(!s)return void toastr.error("Nothing to export");const r=new Blob([s],{type:"text/markdown"}),i=URL.createObjectURL(r),a=document.createElement("a");a.href=i,a.download=`${(null==n?void 0:n.name.replace(/[^a-z0-9]/gi,"_"))||"character"}_session_${e().format("YYYYMMDD_HHmmss")}.md`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i),toastr.success("Session exported")}(),n.closest(`#${e}_cancel_btn`)&&(null==Rt?void 0:Rt.abortController)&&Rt.abortController.abort()}))}());var u,d,p;const f=Ot.querySelector(`#${e}_iteration_history_container`);f&&(f.innerHTML=pt(Rt.pipeline.iterationHistory,Rt.pipeline.iterationCount,Rt.historyLoaded),function(){if(!Ot||!Rt)return;const t=Ot.querySelector(`#${e}_iteration_history_container`);if(!t)return;t.addEventListener("click",t=>At(this,void 0,void 0,function*(){const n=t.target,s=n.closest(`.${e}_iteration_revert_btn`);if(s&&Rt){const e=parseInt(s.getAttribute("data-index")||"-1",10);e>=0&&(yield function(e){return At(this,void 0,void 0,function*(){if(!Rt)return;const{Popup:t,POPUP_RESULT:n}=SillyTavern.getContext();(yield t.show.confirm("Revert to Previous Iteration?",`This will restore the rewrite from iteration #${e+1} and discard later changes.`))===n.AFFIRMATIVE&&(Rt.pipeline=function(e,t){if(t<0||t>=e.iterationHistory.length)return g("Invalid iteration index",{iterationIndex:t,historyLength:e.iterationHistory.length}),e;const n=e.iterationHistory[t];_("state","Reverting to iteration",{iteration:n.iteration});const s={response:n.rewriteResponse,isStructured:!1,promptUsed:"[Restored from iteration history]",schemaUsed:null,timestamp:Date.now(),locked:!1},r=e.iterationHistory.slice(0,t);return Object.assign(Object.assign({},e),{results:Object.assign(Object.assign({},e.results),{rewrite:s,analyze:null}),stageStatus:Object.assign(Object.assign({},e.stageStatus),{rewrite:"complete",analyze:"pending"}),iterationCount:n.iteration,iterationHistory:r,isRefining:!0})}(Rt.pipeline,e),Rt.activeStageView="rewrite",toastr.info(`Reverted to iteration #${e+1}`),Rt.pipeline.character&&(yield Pt(Rt.pipeline.character,Rt.pipeline.iterationHistory)),zt())})}(e))}const r=n.closest(`.${e}_iteration_view_btn`);if(r&&Rt){const t=parseInt(r.getAttribute("data-index")||"-1",10);t>=0&&t<Rt.pipeline.iterationHistory.length&&function(t){At(this,void 0,void 0,function*(){const{Popup:n,POPUP_TYPE:s}=SillyTavern.getContext(),{DOMPurify:r}=SillyTavern.libs,i=function(t){const{moment:n}=SillyTavern.libs;return`\n    <div class="${e}_iteration_view">\n      <div class="${e}_iteration_view_header">\n        <h3>Iteration #${t.iteration+1}</h3>\n        <span class="${e}_iteration_verdict ${_t(t.verdict)}">\n          <i class="fa-solid ${mt(t.verdict)}"></i>\n          ${gt(t.verdict)}\n        </span>\n        <span class="${e}_iteration_time">${n(t.timestamp).format("YYYY-MM-DD HH:mm:ss")}</span>\n      </div>\n\n      <div class="${e}_iteration_view_section">\n        <h4>Rewrite</h4>\n        <div class="${e}_iteration_view_content">\n          ${ht(t.rewriteResponse)}\n        </div>\n      </div>\n\n      <div class="${e}_iteration_view_section">\n        <h4>Analysis</h4>\n        <div class="${e}_iteration_view_content">\n          ${ht(t.analysisResponse)}\n        </div>\n      </div>\n    </div>\n  `}(t),a=new n(r.sanitize(i),s.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:"Close",cancelButton:!1});yield a.show()})}(Rt.pipeline.iterationHistory[t])}}))}());null===(n=Ot.querySelector(`#${e}_settings_btn`))||void 0===n||n.addEventListener("click",()=>{yt(()=>{Rt&&function(){if(!Rt)return;for(const e of s){const t=Rt.pipeline.configs[e];t.promptPresetId&&!E(t.promptPresetId)&&(_("info","Clearing deleted prompt preset reference",{stage:e,presetId:t.promptPresetId}),Rt.pipeline=me(Rt.pipeline,e,{promptPresetId:null})),t.schemaPresetId&&!R(t.schemaPresetId)&&(_("info","Clearing deleted schema preset reference",{stage:e,presetId:t.schemaPresetId}),Rt.pipeline=me(Rt.pipeline,e,{schemaPresetId:null}))}}(),zt()})}),null===(i=Ot.querySelector(`#${e}_close_btn`))||void 0===i||i.addEventListener("click",()=>{const e=null==Ot?void 0:Ot.closest(".popup");if(e){const t=e.querySelector(".popup-button-cancel, .popup-button-ok");null==t||t.click()}})}(n),zt(),_("info","Popup opened",{characterCount:n.length})}catch(e){g("Failed to initialize popup components",e),toastr.error("Character Tools opened but some features may not work.")}})}let qt=!1;function Dt(t,n){return At(this,void 0,void 0,function*(){if(!Rt)return;const s=n;Rt.pipeline=pe(Rt.pipeline,t,n),Rt.historyLoaded=!1,zt();const r=yield function(e){return xt(this,void 0,void 0,function*(){const{localforage:t}=SillyTavern.libs,n=Et(e);try{const s=yield t.getItem(n);return s?s.characterName!==e.name||s.characterAvatar!==e.avatar?(_("info","Iteration history mismatch, ignoring",{key:n,storedName:s.characterName,currentName:e.name}),null):(_("info","Iteration history loaded",{key:n,characterName:e.name,historyLength:s.history.length,savedAt:new Date(s.savedAt).toISOString()}),s.history):(_("info","No iteration history found",{key:n}),null)}catch(e){return g("Failed to load iteration history",{key:n,error:e}),null}})}(t);Rt&&Rt.pipeline.characterIndex===s&&(r&&r.length>0&&(Rt.pipeline=Object.assign(Object.assign({},Rt.pipeline),{iterationHistory:r,iterationCount:r.length}),_("info","Loaded iteration history",{count:r.length})),Rt.historyLoaded=!0,Yt()),setTimeout(()=>At(this,void 0,void 0,function*(){if(!Ot||!(null==Rt?void 0:Rt.pipeline.character))return;if(Rt.pipeline.characterIndex!==s)return;const t=Ot.querySelector(`#${e}_character_select_container`);if(t){const e=oe(Rt.pipeline.character);yield De(t,e)}}),50),_("info","Character selected",{name:t.name,index:n})})}function Mt(e){return At(this,void 0,void 0,function*(){if(!Rt||Rt.isGenerating||Rt.isRefining)return;if(!Pe())return void toastr.error("API is not connected");const t=function(e,t){if(!e.character)return{canRun:!1,reason:"No character selected"};if(!Object.values(e.selectedFields).some(e=>!0===e||Array.isArray(e)&&e.length>0))return{canRun:!1,reason:"No fields selected"};switch(t){case"score":return{canRun:!0};case"rewrite":return e.selectedStages.includes("score")&&!e.results.score?{canRun:!0,reason:"Score stage not complete - rewrite will run without score feedback"}:{canRun:!0};case"analyze":return e.results.rewrite?{canRun:!0}:{canRun:!1,reason:"Analyze requires rewrite results to compare"};default:return{canRun:!1,reason:"Unknown stage"}}}(Rt.pipeline,e);if(!t.canRun)return void toastr.warning(t.reason||"Cannot run this stage");t.reason&&toastr.info(t.reason),Rt.isGenerating=!0,Rt.abortController=new AbortController,Rt.pipeline=function(e,t){return _("state","Stage started",{stage:t}),Object.assign(Object.assign({},e),{currentStage:t,stageStatus:Object.assign(Object.assign({},e.stageStatus),{[t]:"running"})})}(Rt.pipeline,e),zt();const n=ye(Rt.pipeline,e)||"",s=be(Rt.pipeline,e);try{const t=yield Re(Rt.pipeline,e,Rt.abortController.signal);t.success?(Rt.pipeline=_e(Rt.pipeline,e,{response:t.response,isStructured:t.isStructured,promptUsed:n,schemaUsed:s}),toastr.success(`${r[e]} complete`)):(Rt.pipeline=ge(Rt.pipeline,e,t.error),"Generation cancelled"!==t.error&&toastr.error(t.error))}catch(t){Rt.pipeline=ge(Rt.pipeline,e,t.message),toastr.error(t.message)}finally{Rt.isGenerating=!1,Rt.abortController=null,zt()}})}function zt(){Ht(),Vt(),Ft(),Gt(),Wt(),Bt(),Yt()}function Ht(){if(!Ot||!Rt)return;const t=Ot.querySelector(`#${e}_character_select_container`);t&&qe(t,Rt.pipeline.character,Rt.pipeline.characterIndex,Rt.pipeline.selectedFields)}function Vt(){if(!Ot||!Rt)return;const t=Ot.querySelector(`#${e}_pipeline_nav_container`);t&&function(t,n,r,i,a,o){for(const a of s){const s=t.querySelector(`#${e}_stage_cb_${a}`),o=t.querySelector(`.${e}_stage_btn[data-stage="${a}"]`),c=t.querySelector(`.${e}_stage_node:has([data-stage="${a}"])`);if(s&&(s.checked=n.includes(a)),o&&o.classList.toggle("active",a===i),c){c.classList.toggle("active",a===i);for(const t of["pending","running","complete","skipped"])c.classList.toggle(`${e}_stage_${t}`,r[a]===t)}const l=null==c?void 0:c.querySelector(`.${e}_stage_connector`);null==l||l.classList.toggle("active",n.includes(a))}const c=t.querySelector(`#${e}_run_selected_btn`),l=t.querySelector(`#${e}_run_all_btn`),u=t.querySelector(`#${e}_reset_pipeline_btn`);c&&(c.disabled=!a||o),l&&(l.disabled=!a||o),u&&(u.disabled=o)}(t,Rt.pipeline.selectedStages,Rt.pipeline.stageStatus,Rt.activeStageView,!!Rt.pipeline.character&&Pe(),Rt.isGenerating||Rt.isRefining)}function Ft(){if(!Ot||!Rt)return;const t=Ot.querySelector(`#${e}_stage_icon`),n=Ot.querySelector(`#${e}_stage_title`);t&&(t.className=`fa-solid ${i[Rt.activeStageView]}`),n&&(n.textContent=r[Rt.activeStageView]),Ut()}function Ut(){if(!Ot||!Rt)return;const t=Ot.querySelector(`#${e}_stage_config_container`);t&&Ge(t,Rt.activeStageView,Rt.pipeline.configs[Rt.activeStageView],Rt.isGenerating||Rt.isRefining,!!Rt.pipeline.character)}function Gt(){if(!Ot||!Rt)return;const t=Ot.querySelector(`#${e}_results_container`);t&&dt(t,Rt.activeStageView,Rt.pipeline.results[Rt.activeStageView],Rt.pipeline.stageStatus[Rt.activeStageView],Rt.isGenerating,we(Rt.pipeline,Rt.activeStageView),Rt.pipeline)}function Bt(){if(!Ot||!Rt)return;const t=Ot.querySelector(`#${e}_iteration_indicator`);t&&(Rt.pipeline.iterationCount>0||Rt.pipeline.isRefining?(t.classList.remove("hidden"),t.innerHTML=`\n      <i class="fa-solid fa-arrows-rotate"></i>\n      Iteration #${Rt.pipeline.iterationCount+1}\n    `):t.classList.add("hidden"))}function Yt(){if(!Ot||!Rt)return;const t=Ot.querySelector(`#${e}_iteration_history_container`);t&&function(t,n,s,r){const i=t.querySelector(`#${e}_iteration_history`);if(!i&&(n.length>0||s>0)){const e=pt(n,s,r);t.insertAdjacentHTML("beforeend",e)}else if(i){const t=i.querySelector(`.${e}_iteration_count`);t&&(t.textContent=s>0?`Current: #${s+1}`:"Initial");const a=i.querySelector(`.${e}_iteration_list`);a&&(r?0===n.length?a.innerHTML=`<div class="${e}_iteration_empty">No previous iterations</div>`:a.innerHTML=n.map((e,t)=>ft(e,t)).join(""):a.innerHTML=`<div class="${e}_iteration_loading">\n                    <i class="fa-solid fa-spinner fa-spin"></i>\n                    <span>Loading history...</span>\n                </div>`)}}(t,Rt.pipeline.iterationHistory,Rt.pipeline.iterationCount,Rt.historyLoaded)}function Wt(){return At(this,void 0,void 0,function*(){if(!Ot||!Rt)return;const t=Ot.querySelector(`#${e}_token_estimate`);if(!t)return;if(!Rt.pipeline.character)return t.innerHTML='<i class="fa-solid fa-microchip"></i> Select a character',void(t.className=`${e}_token_estimate`);let n;if(t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>',t.className=`${e}_token_estimate`,n=Rt.pipeline.isRefining&&Rt.pipeline.results.rewrite&&Rt.pipeline.results.analyze?yield function(e){return xe(this,void 0,void 0,function*(){const{getTokenCountAsync:t,maxContext:n}=SillyTavern.getContext();if(!e.character||!e.results.rewrite||!e.results.analyze)return null;try{const s=$e(e);if(!s)return null;const r=S("rewrite")+"\n\n"+s,i=yield t(r);return{promptTokens:i,contextSize:n,percentage:Math.round(i/n*100)}}catch(e){return g("Refinement token count failed",e),null}})}(Rt.pipeline):yield function(e,t){return xe(this,void 0,void 0,function*(){const{getTokenCountAsync:n,maxContext:s}=SillyTavern.getContext();if(!e.character)return null;try{const r=ye(e,t);if(!r)return null;const i=S(t)+"\n\n"+r,a=yield n(i);return{promptTokens:a,contextSize:s,percentage:Math.round(a/s*100)}}catch(e){return g("Token count failed",e),null}})}(Rt.pipeline,Rt.activeStageView),!Rt||!Ot)return;if(!n)return t.innerHTML='<i class="fa-solid fa-microchip"></i> --',void(t.className=`${e}_token_estimate`);let s="";n.percentage>100?s="danger":n.percentage>80&&(s="warning"),t.innerHTML=`<i class="fa-solid fa-microchip"></i> ${n.promptTokens.toLocaleString()}t (${n.percentage}%)`,t.className=`${e}_token_estimate ${s}`})}var Jt=function(e,t,n,s){return new(n||(n=Promise))(function(r,i){function a(e){try{c(s.next(e))}catch(e){i(e)}}function o(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,o)}c((s=s.apply(e,t||[])).next())})};function Kt(){return Jt(this,void 0,void 0,function*(){const{renderExtensionTemplateAsync:n}=SillyTavern.getContext(),s=document.getElementById("extensions_settings");if(s)try{const r=yield n("third-party/SillyTavern-CharacterTools","templates/panel",{version:t},!0),i=document.createElement("div");i.id=`${e}_wrapper`,i.className="extension_container",i.innerHTML=r,s.appendChild(i),function(){const t=document.getElementById(`${e}_open_btn`);null==t||t.addEventListener("click",()=>{Nt()});const n=document.getElementById(`${e}_debug_toggle`);n&&(n.checked=y().debugMode,n.addEventListener("change",()=>{C(n.checked),toastr.info("Debug mode "+(n.checked?"enabled":"disabled"))}))}(),_("info","Panel initialized",null)}catch(e){g("Failed to load panel template",e)}else g("Extensions container not found",null)})}function Qt(){const e=[],t={name:"TestChar",avatar:"test.png",description:"ORIGINAL_MARKER_A1B2C3 - A test character",personality:"Test personality",first_mes:"Hello test",mes_example:"",scenario:""};let n=le();n=pe(n,t,0),n=Object.assign(Object.assign({},n),{selectedFields:ue(t)});const s=ye(n,"score");(null==s?void 0:s.includes("ORIGINAL_MARKER_A1B2C3"))?console.log("✓ Score prompt includes original character"):e.push("FAIL: Score prompt missing original character marker"),n=_e(n,"score",{response:"SCORE_MARKER_X9Y8Z7 - Score feedback here",isStructured:!1,promptUsed:s||"",schemaUsed:null});const r=ye(n,"rewrite");(null==r?void 0:r.includes("ORIGINAL_MARKER_A1B2C3"))?console.log("✓ Rewrite prompt includes original character"):e.push("FAIL: Rewrite prompt missing original character marker"),(null==r?void 0:r.includes("SCORE_MARKER_X9Y8Z7"))?console.log("✓ Rewrite prompt includes score results"):e.push("FAIL: Rewrite prompt missing score results marker"),n=_e(n,"rewrite",{response:"REWRITE_MARKER_P4Q5R6 - Rewritten character here",isStructured:!1,promptUsed:r||"",schemaUsed:null});const i=ye(n,"analyze");(null==i?void 0:i.includes("ORIGINAL_MARKER_A1B2C3"))?console.log("✓ Analyze prompt includes original character"):e.push("FAIL: Analyze prompt missing original character marker"),(null==i?void 0:i.includes("REWRITE_MARKER_P4Q5R6"))?console.log("✓ Analyze prompt includes rewrite results"):e.push("FAIL: Analyze prompt missing rewrite results marker"),n=_e(n,"analyze",{response:"ANALYZE_MARKER_M1N2O3 - Analysis here",isStructured:!1,promptUsed:i||"",schemaUsed:null});const a=$e(n);return(null==a?void 0:a.includes("ORIGINAL_MARKER_A1B2C3"))?console.log("✓ Refinement prompt includes original character"):e.push("FAIL: Refinement prompt missing original character marker"),(null==a?void 0:a.includes("REWRITE_MARKER_P4Q5R6"))?console.log("✓ Refinement prompt includes current rewrite"):e.push("FAIL: Refinement prompt missing current rewrite marker"),(null==a?void 0:a.includes("ANALYZE_MARKER_M1N2O3"))?console.log("✓ Refinement prompt includes analysis"):e.push("FAIL: Refinement prompt missing analysis marker"),console.log("\n=== PIPELINE FLOW TEST RESULTS ==="),0===e.length?(console.log("✓ ALL TESTS PASSED"),{passed:!0,errors:[]}):(console.error("✗ FAILURES:"),e.forEach(e=>console.error("  "+e)),{passed:!1,errors:e})}const{eventSource:Xt,eventTypes:Zt}=SillyTavern.getContext();Xt.on(Zt.APP_READY,function(){try{_("info","Extension initializing",{version:t}),Kt(),function(){const{eventSource:e,eventTypes:t}=SillyTavern.getContext();e.on(t.CHATCOMPLETION_SOURCE_CHANGED,()=>{_("info","Chat completion source changed",null)}),e.on(t.CHATCOMPLETION_MODEL_CHANGED,()=>{_("info","Chat completion model changed",null)}),_("info","Event listeners registered",null)}(),y().debugMode&&(window.testPipelineFlow=Qt,_("info","Test utilities loaded: window.testPipelineFlow()",null)),_("info","Extension loaded",y())}catch(e){g("Extension initialization failed",e),toastr.error("Character Tools failed to initialize. Check console for details.")}})})();
//# sourceMappingURL=index.js.map