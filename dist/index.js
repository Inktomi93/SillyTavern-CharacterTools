(()=>{"use strict";const e="character_tools",t="third-party/my-extension",n=3,r=Object.freeze([{key:"description",label:"Description",scoreable:!0},{key:"personality",label:"Personality",scoreable:!0},{key:"first_mes",label:"First Message",scoreable:!0},{key:"scenario",label:"Scenario",scoreable:!0},{key:"mes_example",label:"Example Messages",scoreable:!0},{key:"system_prompt",label:"System Prompt",scoreable:!0},{key:"post_history_instructions",label:"Post-History Instructions",scoreable:!1},{key:"creator_notes",label:"Creator Notes",scoreable:!1}]),s=Object.freeze(["score","rewrite","analyze"]),i={score:"Score",rewrite:"Rewrite",analyze:"Analyze"},a={score:"fa-star-half-stroke",rewrite:"fa-pen-fancy",analyze:"fa-magnifying-glass-chart"},o="You are a creative writing assistant specializing in character development for roleplay and fiction. Analyze character cards and provide thoughtful, actionable feedback.\n\nAdapt your response style to the task:\n- For scoring: Be critical but fair, rate 1-10 with specific justifications\n- For rewrites: Preserve the character's core identity while improving weak areas\n- For analysis: Compare versions objectively, identify what was lost or gained\n- For refinement: Address specific issues from analysis while keeping improvements\n\nFocus on: writing quality, character depth, consistency, roleplay usability, and potential issues (contradictions, clichés, underdeveloped areas).\n\nAlways maintain the character's essential personality and unique traits. Improvements should enhance, not replace, what makes the character interesting.",c="You are refining a character card rewrite based on analysis feedback.\n\n## Original Character (Ground Truth)\n{{original_character}}\n\n## Current Rewrite (Iteration {{iteration_number}})\n{{current_rewrite}}\n\n## Analysis of Current Rewrite\n{{current_analysis}}\n\n{{#if score_results}}\n## Original Score Feedback (Reference)\n{{score_results}}\n{{/if}}\n\n---\n\n## Your Task\n\nCreate an improved version that:\n\n1. **Addresses Issues**: Fix the specific problems identified in the analysis\n2. **Preserves Wins**: Keep what the analysis said was working well\n3. **Maintains Soul**: The character must still feel like the original, just better\n4. **Avoids Regression**: Don't reintroduce problems that were already fixed\n\nOutput the complete refined character card with all fields. Mark significantly changed sections with [REFINED] at the start.\n\nDo NOT explain your changes - just output the improved character card.",l=Object.freeze([{id:"builtin_score_default",name:"Default Score",stages:["score"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Rate this character card on a scale of 1-10 for each populated field. For each field, provide:\n\n1. **Score** (1-10)\n2. **Strengths** - What works well\n3. **Weaknesses** - What needs improvement\n4. **Specific Suggestions** - Concrete changes to improve it\n\nAfter scoring all fields, provide:\n- **Overall Score** (weighted average, with First Message and Description weighted higher)\n- **Top 3 Priority Improvements** - The changes that would have the biggest impact\n- **Summary** - A brief overall assessment\n\nBe critical but constructive. Vague praise is useless. Specific, actionable feedback is gold."},{id:"builtin_score_quick",name:"Quick Score",stages:["score"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Give a quick assessment of this character card:\n\n1. Overall score (1-10)\n2. Three biggest strengths\n3. Three areas needing work\n4. One-sentence summary\n\nKeep it concise but useful."},{id:"builtin_rewrite_default",name:"Default Rewrite",stages:["rewrite"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Based on the scoring feedback, rewrite this character card to address the identified weaknesses while preserving its strengths.\n\nGuidelines:\n- Maintain the character's core personality and unique traits\n- Improve weak areas identified in the score\n- Keep the same general length unless brevity/expansion was specifically noted\n- Preserve any distinctive voice or style that works\n- Fix contradictions and fill gaps\n- Make the character more engaging for roleplay\n\nOutput the complete rewritten character card with all fields, using the same field structure as the original. Mark significantly changed sections with [REVISED] at the start.\n\n{{score_results}}"},{id:"builtin_rewrite_conservative",name:"Conservative Rewrite",stages:["rewrite"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Make minimal, surgical improvements to this character card. Only change what's clearly broken or weak.\n\nRules:\n- Change as little as possible\n- Preserve the author's voice completely\n- Only fix obvious issues (contradictions, grammar, clarity)\n- Do NOT add new content unless filling a critical gap\n- Do NOT change style or tone\n\nOutput only the fields you changed, with [ORIGINAL] and [REVISED] versions for comparison.\n\n{{score_results}}"},{id:"builtin_rewrite_expansive",name:"Expansive Rewrite",stages:["rewrite"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Significantly expand and enhance this character card. Add depth, detail, and richness.\n\nGoals:\n- Flesh out underdeveloped areas\n- Add sensory details and specific examples\n- Deepen personality with quirks, contradictions, history\n- Improve example messages with more variety\n- Make the character feel more three-dimensional\n\nDon't change the core concept, but make it shine. Output the complete expanded character card.\n\n{{score_results}}"},{id:"builtin_analyze_default",name:"Default Analyze",stages:["analyze"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:'Compare the original character card with the rewritten version. Analyze:\n\n## What Was Preserved\n- Core personality traits that remained intact\n- Distinctive elements that were kept\n- Voice and style consistency\n\n## What Was Lost\n- Any personality aspects that were diminished or removed\n- Unique quirks that disappeared\n- Tone shifts that changed the character\'s feel\n\n## What Was Gained\n- New depth or detail added\n- Improvements that enhance the character\n- Better clarity or consistency\n\n## Soul Check\nDoes the rewritten version still feel like the same character? Rate the "soul preservation" from 1-10 and explain.\n\n## Verdict\nState clearly: **ACCEPT** (ready to use), **NEEDS REFINEMENT** (good progress but has issues), or **REGRESSION** (worse than before).\n\n## Specific Issues to Address\nIf verdict is NEEDS REFINEMENT, list the specific problems that should be fixed in the next iteration.\n\n---\n\n### Original Character:\n{{original_character}}\n\n### Rewritten Version:\n{{rewrite_results}}\n\n### Score Feedback:\n{{score_results}}'},{id:"builtin_analyze_iteration",name:"Iteration Analyze",stages:["analyze"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"This is iteration {{iteration_number}} of refinement. Compare the current rewrite against the original.\n\n## Progress Check\n- What issues from previous analysis were addressed?\n- What new issues (if any) were introduced?\n- Is this version better, worse, or lateral move from the last?\n\n## Current State Assessment\n\n### Preserved from Original\nCore traits and elements that remain intact.\n\n### Still Missing or Lost\nThings from the original that should be restored.\n\n### Successfully Improved\nWhat's genuinely better now.\n\n### New Problems\nAny issues introduced by this iteration.\n\n## Soul Preservation Score\nRate 1-10: Does this still feel like the original character?\n\n## Verdict\n**ACCEPT** - Ready to use, no more iterations needed\n**NEEDS REFINEMENT** - Making progress, but specific issues remain\n**REGRESSION** - This iteration made things worse, consider reverting\n\n## Next Steps\nIf NEEDS REFINEMENT: List exactly what the next iteration should fix.\nIf REGRESSION: Explain what went wrong and what to preserve from previous version.\n\n---\n\n### Original Character:\n{{original_character}}\n\n### Current Rewrite (Iteration {{iteration_number}}):\n{{rewrite_results}}"},{id:"builtin_analyze_quick",name:"Quick Analyze",stages:["analyze"],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"Quick comparison of original vs rewrite:\n\n1. Soul preserved? (Yes/Partially/No)\n2. Best improvement made\n3. Biggest thing lost (if any)\n4. Verdict: ACCEPT / NEEDS REFINEMENT / REGRESSION\n\n{{original_character}}\n\n{{rewrite_results}}"},{id:"builtin_freeform",name:"Freeform",stages:[],isBuiltin:!0,createdAt:0,updatedAt:0,prompt:"[Enter your custom instructions here]"}]),u=Object.freeze([{id:"builtin_schema_score",name:"Default Score",stages:["score"],isBuiltin:!0,createdAt:0,updatedAt:0,schema:{name:"CharacterScore",strict:!0,value:{$schema:"http://json-schema.org/draft-04/schema#",type:"object",additionalProperties:!1,properties:{fieldScores:{type:"array",items:{type:"object",additionalProperties:!1,properties:{field:{type:"string"},score:{type:"number"},strengths:{type:"string"},weaknesses:{type:"string"},suggestions:{type:"string"}},required:["field","score","strengths","weaknesses","suggestions"]}},overallScore:{type:"number"},priorityImprovements:{type:"array",items:{type:"string"}},summary:{type:"string"}},required:["fieldScores","overallScore","priorityImprovements","summary"]}}},{id:"builtin_schema_quick_score",name:"Quick Score",stages:["score"],isBuiltin:!0,createdAt:0,updatedAt:0,schema:{name:"QuickScore",strict:!0,value:{$schema:"http://json-schema.org/draft-04/schema#",type:"object",additionalProperties:!1,properties:{overallScore:{type:"number"},strengths:{type:"array",items:{type:"string"}},weaknesses:{type:"array",items:{type:"string"}},summary:{type:"string"}},required:["overallScore","strengths","weaknesses","summary"]}}},{id:"builtin_schema_analyze",name:"Default Analyze",stages:["analyze"],isBuiltin:!0,createdAt:0,updatedAt:0,schema:{name:"CharacterAnalysis",strict:!0,value:{$schema:"http://json-schema.org/draft-04/schema#",type:"object",additionalProperties:!1,properties:{preserved:{type:"array",items:{type:"string"}},lost:{type:"array",items:{type:"string"}},gained:{type:"array",items:{type:"string"}},soulPreservationScore:{type:"number"},soulAssessment:{type:"string"},verdict:{type:"string",enum:["ACCEPT","NEEDS_REFINEMENT","REGRESSION"]},issuesToAddress:{type:"array",items:{type:"string"}},recommendations:{type:"array",items:{type:"string"}}},required:["preserved","lost","gained","soulPreservationScore","soulAssessment","verdict","issuesToAddress","recommendations"]}}}]),d={score:{promptPresetId:"builtin_score_default",customPrompt:"",schemaPresetId:"builtin_schema_score",customSchema:"",useStructuredOutput:!1},rewrite:{promptPresetId:"builtin_rewrite_default",customPrompt:"",schemaPresetId:null,customSchema:"",useStructuredOutput:!1},analyze:{promptPresetId:"builtin_analyze_default",customPrompt:"",schemaPresetId:"builtin_schema_analyze",customSchema:"",useStructuredOutput:!1}},p={source:"openrouter",model:"anthropic/claude-sonnet-4",temperature:1,maxTokens:4096,frequencyPenalty:0,presencePenalty:0,topP:1},f=Object.freeze({useCurrentSettings:!0,generationConfig:p,systemPrompt:o,promptPresets:[...l],schemaPresets:[...u],stageDefaults:d,refinementPrompt:c,debugMode:!1,settingsVersion:n}),m={ORIGINAL_CHARACTER:"{{original_character}}",SCORE_RESULTS:"{{score_results}}",REWRITE_RESULTS:"{{rewrite_results}}",CURRENT_REWRITE:"{{current_rewrite}}",CURRENT_ANALYSIS:"{{current_analysis}}",ITERATION_NUMBER:"{{iteration_number}}",CHARACTER_NAME:"{{char_name}}",USER_NAME:"{{user_name}}"},g=100,h=20;const _=[];function v(t,n,r){const s={timestamp:new Date,type:t,label:n,data:r};if(_.unshift(s),_.length>g&&_.pop(),"error"!==t){if(function(){try{return S().debugMode}catch(e){return!1}}()){const s=`[${e}:${t.toUpperCase()}]`;switch(t){case"request":case"response":console.debug(s,n,r);break;default:console.log(s,n,r)}}}else console.error(`[${e}:ERROR]`,n,r)}function y(e,t){v("error",e,t)}function $(){return JSON.stringify(function(){var e,t,n,r,s,i,a,o,c;const l=SillyTavern.getContext();let u;try{u=S()}catch(e){u={error:"Failed to load settings"}}return{extension:{settings:{useCurrentSettings:u.useCurrentSettings,debugMode:u.debugMode,generationConfig:u.generationConfig,systemPromptLength:(null===(e=u.systemPrompt)||void 0===e?void 0:e.length)||0,promptPresetCount:(null===(t=u.promptPresets)||void 0===t?void 0:t.length)||0,schemaPresetCount:(null===(n=u.schemaPresets)||void 0===n?void 0:n.length)||0}},sillytavern:{mainApi:l.mainApi,onlineStatus:l.onlineStatus,chatCompletionSource:null===(r=l.chatCompletionSettings)||void 0===r?void 0:r.chat_completion_source,currentModel:(null===(s=l.chatCompletionSettings)||void 0===s?void 0:s.openrouter_model)||(null===(i=l.chatCompletionSettings)||void 0===i?void 0:i.model_openai_select),maxContext:l.maxContext,characterCount:null!==(o=null===(a=l.characters)||void 0===a?void 0:a.length)&&void 0!==o?o:0,hasActiveChat:!!(null===(c=l.chat)||void 0===c?void 0:c.length)},logs:{total:_.length,errors:_.filter((e=>"error"===e.type)).length,recent:_.slice(0,10).map((e=>({type:e.type,label:e.label,time:e.timestamp.toISOString()})))}}}(),null,2)}const b={2:e=>{const t=e;void 0!==t.useRawMode&&(e.useCurrentSettings=!t.useRawMode,delete t.useRawMode),void 0!==t.jsonSchema&&delete t.jsonSchema,void 0!==t.useStructuredOutput&&(e.stageDefaults||(e.stageDefaults=structuredClone(d)),e.stageDefaults.score.useStructuredOutput=!!t.useStructuredOutput,delete t.useStructuredOutput)},3:e=>{e.refinementPrompt||(e.refinementPrompt=c)}};function S(){const{extensionSettings:t,saveSettingsDebounced:r}=SillyTavern.getContext(),{lodash:s}=SillyTavern.libs;if(!t[e])return v("info","Initializing settings with defaults",null),t[e]=structuredClone(f),r(),t[e];const i=t[e],a=i.settingsVersion||1;let o=!1;a<n&&(o=function(e,t){let r=!1;for(let s=t+1;s<=n;s++){const t=b[s];t&&(v("info",`Running migration to v${s}`,null),t(e),r=!0)}return r}(i,a),i.settingsVersion=n);const c=s.merge(structuredClone(f),i),d=function(e){let t=!1;const n=new Set(e.promptPresets.map((e=>e.id)));for(const r of l)n.has(r.id)||(e.promptPresets.push(structuredClone(r)),t=!0);const r=new Set(e.schemaPresets.map((e=>e.id)));for(const n of u)r.has(n.id)||(e.schemaPresets.push(structuredClone(n)),t=!0);return t}(c);return o=o||d,t[e]=c,o&&r(),c}function w(t,n){const{extensionSettings:r,saveSettingsDebounced:s}=SillyTavern.getContext();r[e][t]=n,s(),v("info","Setting updated",{key:t,value:"object"==typeof n?"[object]":n})}function C(t){const{extensionSettings:n,saveSettingsDebounced:r}=SillyTavern.getContext(),s=n[e];s.generationConfig||(s.generationConfig=structuredClone(p)),s.generationConfig=Object.assign(Object.assign({},s.generationConfig),t),r(),v("info","Generation config updated",t)}function x(e){w("debugMode",e)}function E(e){const t=S();return e?t.promptPresets.filter((t=>0===t.stages.length||t.stages.includes(e))):t.promptPresets}function P(e){return S().promptPresets.find((t=>t.id===e))||null}function O(t){const{extensionSettings:n,saveSettingsDebounced:r}=SillyTavern.getContext(),s=n[e],{uuidv4:i}=SillyTavern.getContext(),a=Date.now(),o=Object.assign(Object.assign({},t),{id:`custom_prompt_${i()}`,isBuiltin:!1,createdAt:a,updatedAt:a});return s.promptPresets.push(o),r(),v("info","Prompt preset saved",{id:o.id,name:o.name}),o}function A(e){const t=S();return e?t.schemaPresets.filter((t=>0===t.stages.length||t.stages.includes(e))):t.schemaPresets}function k(e){return S().schemaPresets.find((t=>t.id===e))||null}function T(t){const{extensionSettings:n,saveSettingsDebounced:r}=SillyTavern.getContext(),s=n[e],{uuidv4:i}=SillyTavern.getContext(),a=R(t.schema),o=Date.now(),c=Object.assign(Object.assign({},t),{schema:a,id:`custom_schema_${i()}`,isBuiltin:!1,createdAt:o,updatedAt:o});return s.schemaPresets.push(c),r(),v("info","Schema preset saved",{id:c.id,name:c.name}),c}function R(e){const t=structuredClone(e);return I(t.value),t}function I(e){if("object"===e.type&&(e.additionalProperties=!1,e.properties&&"object"==typeof e.properties))for(const t of Object.values(e.properties))t&&"object"==typeof t&&I(t);if("array"===e.type&&e.items&&"object"==typeof e.items&&(Array.isArray(e.items)?e.items.forEach((e=>{e&&"object"==typeof e&&I(e)})):I(e.items)),e.anyOf&&Array.isArray(e.anyOf)&&e.anyOf.forEach((e=>{e&&"object"==typeof e&&I(e)})),e.allOf&&Array.isArray(e.allOf)&&e.allOf.forEach((e=>{e&&"object"==typeof e&&I(e)})),e.$defs&&"object"==typeof e.$defs)for(const t of Object.values(e.$defs))t&&"object"==typeof t&&I(t);if(e.definitions&&"object"==typeof e.definitions)for(const t of Object.values(e.definitions))t&&"object"==typeof t&&I(t)}var L=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};const j={MAX_ANYOF_VARIANTS:8,MAX_DEFS:100,MAX_NESTING_DEPTH:10,MAX_PROPERTIES_PER_OBJECT:100,MAX_ENUM_VALUES:500,SUPPORTED_STRING_FORMATS:["date-time","time","date","duration","email","hostname","uri","ipv4","ipv6","uuid"],SUPPORTED_MINMAX_ITEMS:[0,1]},N={numeric:["minimum","maximum","exclusiveMinimum","exclusiveMaximum","multipleOf"],string:["minLength","maxLength"],array:["maxItems","uniqueItems","contains","minContains","maxContains"],object:["minProperties","maxProperties","propertyNames","patternProperties"]},q=["if","then","else","not","oneOf","dependentRequired","dependentSchemas","unevaluatedProperties","unevaluatedItems","$dynamicRef","$dynamicAnchor"],D=[{pattern:/\(\?[=!<]/,name:"lookahead/lookbehind assertions"},{pattern:/\\[1-9]/,name:"backreferences"},{pattern:/\\[bB]/,name:"word boundaries"}],M='Generate a JSON Schema for structured LLM output based on the user\'s description.\n\nRequirements:\n- Output ONLY valid JSON, no markdown, no explanation\n- Use this exact wrapper format: {"name": "SchemaName", "strict": true, "value": {...}}\n- The "value" must be a valid JSON Schema with "type": "object"\n- Add "additionalProperties": false to ALL object types (required for Anthropic)\n- All object properties should be in a "required" array unless explicitly optional\n- Use simple types: string, number, integer, boolean, array, object\n- For arrays, always specify "items" with a schema\n- Keep it minimal - only what the user asked for\n\nUser\'s description:';function H(e){var t;if(!e.trim())return{valid:!0,schema:void 0};let n;try{n=JSON.parse(e)}catch(e){const t=e instanceof Error?e.message:"Invalid JSON",n=t.match(/position (\d+)/);return{valid:!1,error:`JSON syntax error${n?` (character ${n[1]})`:""}: ${t}`}}if("object"!=typeof n||null===n||Array.isArray(n))return{valid:!1,error:"Schema must be a JSON object, not "+(Array.isArray(n)?"array":typeof n)};const r=n;if("string"!=typeof r.name)return{valid:!1,error:"Missing required 'name' property (string)"};if(!r.name.trim())return{valid:!1,error:"'name' cannot be empty"};if(!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(r.name))return{valid:!1,error:`'name' must be a valid identifier (got '${r.name}'). Use letters, numbers, underscores; start with letter or underscore.`};if("object"!=typeof r.value||null===r.value||Array.isArray(r.value))return{valid:!1,error:"Missing or invalid 'value' property (must be object)"};const s=r.value;if("string"!=typeof s.type&&!s.anyOf&&!s.allOf&&!s.$ref)return{valid:!1,error:"'value' must have a 'type', 'anyOf', 'allOf', or '$ref'"};if(void 0!==r.strict&&"boolean"!=typeof r.strict)return{valid:!1,error:"'strict' must be a boolean if provided"};const i={errors:[],warnings:[],info:[],stats:{defCount:0,anyOfCount:0,totalAnyOfVariants:0,maxDepth:0,propertyCount:0,optionalFieldCount:0,enumCount:0},currentDepth:0,seenRefs:new Set,defs:{}};if(s.$defs&&"object"==typeof s.$defs?(i.defs=s.$defs,i.stats.defCount=Object.keys(i.defs).length):s.definitions&&"object"==typeof s.definitions&&(i.defs=s.definitions,i.stats.defCount=Object.keys(i.defs).length),i.stats.defCount>j.MAX_DEFS&&i.errors.push(`Too many definitions: ${i.stats.defCount} (limit: ${j.MAX_DEFS})`),F(s,"value",i),i.stats.optionalFieldCount>0){const e=i.stats.optionalFieldCount,t=i.stats.totalAnyOfVariants+2*e;e>10&&i.warnings.push(`${e} optional fields detected. Each spawns an implicit anyOf with null. Consider making fields required or reducing optionals.`),t>50&&i.warnings.push(`High anyOf count (~${t} including implicit nullables). May cause slow schema compilation or errors.`)}if(i.errors.length>0)return{valid:!1,error:i.errors.join("\n"),warnings:i.warnings.length>0?i.warnings:void 0};const a={name:r.name,strict:null===(t=r.strict)||void 0===t||t,value:s};return i.info.push(`Schema stats: ${i.stats.propertyCount} properties, ${i.stats.defCount} definitions, ${i.stats.anyOfCount} anyOf blocks, ${i.stats.optionalFieldCount} optional fields, max depth ${i.stats.maxDepth}`),{valid:!0,schema:a,warnings:i.warnings.length>0?i.warnings:void 0,info:i.info.length>0?i.info:void 0}}function F(e,t,n){if(n.currentDepth++,n.stats.maxDepth=Math.max(n.stats.maxDepth,n.currentDepth),n.currentDepth>j.MAX_NESTING_DEPTH)return n.errors.push(`${t}: Exceeds maximum nesting depth of ${j.MAX_NESTING_DEPTH}`),void n.currentDepth--;for(const r of q)void 0!==e[r]&&n.errors.push(`${t}: '${r}' is not supported`);for(const r of N.numeric)void 0!==e[r]&&n.warnings.push(`${t}: '${r}' will be ignored (not supported)`);for(const r of N.string)void 0!==e[r]&&n.warnings.push(`${t}: '${r}' will be ignored (not supported)`);for(const r of N.array)void 0!==e[r]&&n.warnings.push(`${t}: '${r}' will be ignored (not supported)`);for(const r of N.object)void 0!==e[r]&&n.warnings.push(`${t}: '${r}' will be ignored (not supported)`);if(e.$ref&&"string"==typeof e.$ref)return function(e,t,n){if(e.startsWith("http://")||e.startsWith("https://"))return void n.errors.push(`${t}: External $ref not supported ('${e}')`);if(n.seenRefs.has(e))return void n.info.push(`${t}: Circular reference to '${e}'`);n.seenRefs.add(e);const r=e.replace(/^#\/(\$defs|definitions)\//,"");n.defs[r]||n.errors.push(`${t}: Reference '${e}' not found in definitions`)}(e.$ref,t,n),void n.currentDepth--;const r=Array.isArray(e.type)?e.type:[e.type];for(const s of r)switch(s){case"object":z(e,t,n);break;case"array":V(e,t,n);break;case"string":U(e,t,n);break;case"number":case"integer":e,t,n;break;case"boolean":case"null":break;default:!s||e.anyOf||e.allOf||n.warnings.push(`${t}: Unknown type '${s}'`)}e.anyOf&&Array.isArray(e.anyOf)&&function(e,t,n){n.stats.anyOfCount++,n.stats.totalAnyOfVariants+=e.length,e.length>j.MAX_ANYOF_VARIANTS&&n.errors.push(`${t}: anyOf has ${e.length} variants (max: ${j.MAX_ANYOF_VARIANTS})`);if(0===e.length)return void n.errors.push(`${t}: anyOf cannot be empty`);e.forEach(((e,r)=>{e&&"object"==typeof e&&F(e,`${t}.anyOf[${r}]`,n)}))}(e.anyOf,t,n),e.allOf&&Array.isArray(e.allOf)&&function(e,t,n){if(0===e.length)return void n.errors.push(`${t}: allOf cannot be empty`);e.forEach(((e,r)=>{if(e&&"object"==typeof e){const s=e;s.$ref&&n.errors.push(`${t}.allOf[${r}]: allOf with $ref not supported`),F(s,`${t}.allOf[${r}]`,n)}}))}(e.allOf,t,n),e.enum&&Array.isArray(e.enum)&&function(e,t,n){if(n.stats.enumCount++,0===e.length)return void n.errors.push(`${t}: enum cannot be empty`);e.length>j.MAX_ENUM_VALUES&&n.warnings.push(`${t}: enum has ${e.length} values (may be slow)`);for(let r=0;r<e.length;r++){const s=e[r],i=typeof s;if("string"!==i&&"number"!==i&&"boolean"!==i&&null!==s){n.errors.push(`${t}.enum[${r}]: Complex type not allowed in enum (got ${i}). Only string, number, boolean, null permitted.`);break}}const r=new Set;for(const s of e){const e=JSON.stringify(s);if(r.has(e)){n.warnings.push(`${t}: Duplicate value in enum: ${e}`);break}r.add(e)}}(e.enum,t,n),void 0!==e.const&&function(e,t,n){const r=typeof e;"string"!==r&&"number"!==r&&"boolean"!==r&&null!==e&&n.errors.push(`${t}: const must be string, number, boolean, or null (got ${r})`)}(e.const,t,n),n.currentDepth--}function z(e,t,n){if(!1!==e.additionalProperties&&n.warnings.push(`${t}: Missing 'additionalProperties: false' (REQUIRED for Anthropic)`),e.properties&&"object"==typeof e.properties){const r=e.properties,s=Object.keys(r).length;n.stats.propertyCount+=s,s>j.MAX_PROPERTIES_PER_OBJECT&&n.warnings.push(`${t}: ${s} properties (may be slow, consider splitting)`);const i=e.required||[];for(const[e,s]of Object.entries(r))i.includes(e)||n.stats.optionalFieldCount++,s&&"object"==typeof s&&F(s,`${t}.${e}`,n)}}function V(e,t,n){if(void 0!==e.minItems){j.SUPPORTED_MINMAX_ITEMS.includes(e.minItems)||n.warnings.push(`${t}: 'minItems: ${e.minItems}' not supported (only 0 or 1 allowed)`)}e.items&&("object"!=typeof e.items||Array.isArray(e.items)?Array.isArray(e.items)&&e.items.forEach(((e,r)=>{e&&"object"==typeof e&&F(e,`${t}.items[${r}]`,n)})):F(e.items,`${t}.items`,n)),e.prefixItems&&Array.isArray(e.prefixItems)&&e.prefixItems.forEach(((e,r)=>{e&&"object"==typeof e&&F(e,`${t}.prefixItems[${r}]`,n)}))}function U(e,t,n){if(e.format&&"string"==typeof e.format){const r=j.SUPPORTED_STRING_FORMATS;r.includes(e.format)||n.warnings.push(`${t}: format '${e.format}' may not be supported. Supported: ${r.join(", ")}`)}e.pattern&&"string"==typeof e.pattern&&function(e,t,n){for(const{pattern:r,name:s}of D)r.test(e)&&n.errors.push(`${t}: Regex pattern uses unsupported feature: ${s}`);try{new RegExp(e)}catch(e){const r=e instanceof Error?e.message:"Invalid regex";n.errors.push(`${t}: Invalid regex pattern: ${r}`)}const r=/\{(\d+),(\d+)\}/g;let s;for(;null!==(s=r.exec(e));){const e=parseInt(s[1],10),r=parseInt(s[2],10);r-e>100&&n.warnings.push(`${t}: Large quantifier range {${e},${r}} may cause issues`)}}(e.pattern,t,n)}function G(e){const t=structuredClone(e);return void 0===t.strict&&(t.strict=!0),B(t.value),t}function B(e){if("object"===e.type&&(e.additionalProperties=!1,e.properties&&"object"==typeof e.properties))for(const t of Object.values(e.properties))t&&"object"==typeof t&&B(t);"array"===e.type&&e.items&&"object"==typeof e.items&&(Array.isArray(e.items)?e.items.forEach((e=>{e&&"object"==typeof e&&B(e)})):B(e.items)),e.anyOf&&Array.isArray(e.anyOf)&&e.anyOf.forEach((e=>{e&&"object"==typeof e&&B(e)})),e.allOf&&Array.isArray(e.allOf)&&e.allOf.forEach((e=>{e&&"object"==typeof e&&B(e)}));const t=[];for(const n of N.numeric)void 0!==e[n]&&(t.push(`${n}: ${e[n]}`),delete e[n]);for(const n of N.string)void 0!==e[n]&&(t.push(`${n}: ${e[n]}`),delete e[n]);for(const n of N.array)void 0!==e[n]&&(t.push(`${n}: ${e[n]}`),delete e[n]);if(void 0!==e.minItems&&null!==e.minItems){const n=e.minItems;0!==n&&1!==n&&(t.push(`minItems: ${n}`),e.minItems=n>0?1:0)}if(t.length>0){const n=`[Constraints: ${t.join(", ")}]`;e.description?e.description=`${e.description} ${n}`:e.description=n}}function J(e){if(e.promptPresetId){const t=P(e.promptPresetId);if(t)return t.prompt;v("error","Prompt preset not found",{id:e.promptPresetId})}return e.customPrompt}function W(e){const t=S().stageDefaults[e];return{promptPresetId:t.promptPresetId,customPrompt:t.customPrompt,schemaPresetId:t.schemaPresetId,customSchema:t.customSchema,useStructuredOutput:t.useStructuredOutput}}function Y(e,t){const{lodash:n}=SillyTavern.libs,{substituteParams:r}=SillyTavern.getContext();let s=r(e);return s=function(e,t){const n=/\{\{#if\s+(\w+)\}\}([\s\S]*?)\{\{\/if\}\}/gi;return e.replace(n,((e,n,r)=>{var s,i,a,o,c;let l=!1;switch(n.toLowerCase()){case"score_results":l=!!(null===(s=t.scoreResults)||void 0===s?void 0:s.trim());break;case"rewrite_results":l=!!(null===(i=t.rewriteResults)||void 0===i?void 0:i.trim());break;case"current_rewrite":l=!!(null===(a=t.currentRewrite)||void 0===a?void 0:a.trim());break;case"current_analysis":l=!!(null===(o=t.currentAnalysis)||void 0===o?void 0:o.trim());break;case"original_character":l=!!(null===(c=t.originalCharacter)||void 0===c?void 0:c.trim());break;case"iteration_number":l=!!t.iterationNumber&&"0"!==t.iterationNumber;break;default:l=!1}return l?r:""}))}(s,t),void 0!==t.originalCharacter&&(s=s.replace(new RegExp(n.escapeRegExp(m.ORIGINAL_CHARACTER),"gi"),t.originalCharacter)),void 0!==t.scoreResults&&(s=s.replace(new RegExp(n.escapeRegExp(m.SCORE_RESULTS),"gi"),t.scoreResults)),void 0!==t.rewriteResults&&(s=s.replace(new RegExp(n.escapeRegExp(m.REWRITE_RESULTS),"gi"),t.rewriteResults)),void 0!==t.currentRewrite&&(s=s.replace(new RegExp(n.escapeRegExp(m.CURRENT_REWRITE),"gi"),t.currentRewrite)),void 0!==t.currentAnalysis&&(s=s.replace(new RegExp(n.escapeRegExp(m.CURRENT_ANALYSIS),"gi"),t.currentAnalysis)),void 0!==t.iterationNumber&&(s=s.replace(new RegExp(n.escapeRegExp(m.ITERATION_NUMBER),"gi"),t.iterationNumber)),void 0!==t.charName&&(s=s.replace(new RegExp(n.escapeRegExp(m.CHARACTER_NAME),"gi"),t.charName)),void 0!==t.userName&&(s=s.replace(new RegExp(n.escapeRegExp(m.USER_NAME),"gi"),t.userName)),void 0!==t.charName&&(s=s.replace(/\{\{char\}\}/gi,t.charName)),void 0!==t.userName&&(s=s.replace(/\{\{user\}\}/gi,t.userName)),s}function X(e){const t=[];for(const[n,r]of Object.entries(m))e.toLowerCase().includes(r.toLowerCase())&&t.push(n);return t}var K=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};function Z(){return{character:null,characterIndex:null,results:{score:null,rewrite:null,analyze:null},configs:{score:W("score"),rewrite:W("rewrite"),analyze:W("analyze")},selectedStages:["score","rewrite"],currentStage:null,stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"},iterationCount:0,iterationHistory:[],isRefining:!1,exportData:null}}function Q(e,t,n){if(e.characterIndex===n&&null!==n)return e;const r=Object.assign(Object.assign({},e),{character:t,characterIndex:n,results:{score:null,rewrite:null,analyze:null},stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"},currentStage:null,iterationCount:0,iterationHistory:[],isRefining:!1,exportData:null});return v("state","Character set",{name:null==t?void 0:t.name,index:n,fieldsPopulated:t?ee(t).length:0}),r}function ee(e){return r.filter((t=>{const n=e[t.key];return n&&"string"==typeof n&&n.trim().length>0})).map((t=>{const n=e[t.key].trim();return{key:t.key,label:t.label,value:n,charCount:n.length,scoreable:t.scoreable}}))}function te(e){const t=ee(e).map((e=>`### ${e.label}\n${e.value}`));return`# CHARACTER: ${e.name}\n\n${t.join("\n\n")}`}function ne(e){return e.character?e.results.rewrite?e.results.analyze?{canRun:!0}:{canRun:!1,reason:"Run analyze first to identify issues"}:{canRun:!1,reason:"No rewrite to refine"}:{canRun:!1,reason:"No character selected"}}function re(e,t,n){return Object.assign(Object.assign({},e),{configs:Object.assign(Object.assign({},e.configs),{[t]:Object.assign(Object.assign({},e.configs[t]),n)})})}function se(e,t,n){return v("state","Stage failed",{stage:t,error:n}),Object.assign(Object.assign({},e),{currentStage:null,stageStatus:Object.assign(Object.assign({},e.stageStatus),{[t]:"pending"})})}function ie(e){const t=e.toUpperCase();if(t.includes("VERDICT")||t.includes('"VERDICT"')){if(t.includes("ACCEPT")&&!t.includes("NEEDS"))return"accept";if(t.includes("REGRESSION"))return"regression";if(t.includes("NEEDS_REFINEMENT")||t.includes("NEEDS REFINEMENT"))return"needs_refinement"}return t.includes("READY TO USE")||t.includes("NO MORE ITERATIONS")?"accept":t.includes("WORSE THAN")||t.includes("STEP BACKWARD")||t.includes("LOST MORE")?"regression":(t.includes("ISSUE")||t.includes("PROBLEM")||t.includes("SHOULD FIX"),"needs_refinement")}function ae(e){const t=function(e){if(!e.results.rewrite||!e.results.analyze)return null;const t=ie(e.results.analyze.response);return{iteration:e.iterationCount,rewriteResponse:e.results.rewrite.response,rewritePreview:e.results.rewrite.response.substring(0,200),analysisResponse:e.results.analyze.response,analysisPreview:e.results.analyze.response.substring(0,200),verdict:t,timestamp:Date.now()}}(e);if(!t)return y("Cannot start refinement - missing rewrite or analyze",null),e;const n=[...e.iterationHistory,t];return n.length>h&&n.shift(),v("state","Starting refinement iteration",{iteration:e.iterationCount+1,previousVerdict:t.verdict}),Object.assign(Object.assign({},e),{iterationHistory:n,iterationCount:e.iterationCount+1,results:Object.assign(Object.assign({},e.results),{analyze:null}),stageStatus:Object.assign(Object.assign({},e.stageStatus),{analyze:"pending"}),isRefining:!0})}function oe(e){const t=function(e){try{let t;try{t=JSON.parse(e)}catch(n){const r=e.match(/```(?:json)?\s*([\s\S]*?)```/);if(!r)return null;t=JSON.parse(r[1].trim())}if("object"!=typeof t||null===t||Array.isArray(t))return null;const n=[];for(const[e,s]of Object.entries(t))if("string"==typeof s&&s.trim()){const t=r.find((t=>t.key===e||t.label.toLowerCase()===e.toLowerCase()));n.push({key:(null==t?void 0:t.key)||e,label:(null==t?void 0:t.label)||ce(e),value:s.trim()})}return 0===n.length?null:{fields:n,raw:e,parseMethod:"json"}}catch(e){return null}}(e);if(t)return t;const n=function(e){var t,n;const s=/^#{2,3}\s+(.+?)$/gm,i=[...e.matchAll(s)];if(0===i.length)return null;const a=[];for(let s=0;s<i.length;s++){const o=i[s],c=o[1].trim(),l=o.index+o[0].length,u=null!==(n=null===(t=i[s+1])||void 0===t?void 0:t.index)&&void 0!==n?n:e.length,d=e.slice(l,u).trim();if(!d)continue;const p=r.find((e=>e.label.toLowerCase()===c.toLowerCase()||e.key===c.toLowerCase().replace(/\s+/g,"_")));!p&&["summary","notes","changes","revised","original"].some((e=>c.toLowerCase().includes(e)))||a.push({key:(null==p?void 0:p.key)||c.toLowerCase().replace(/\s+/g,"_"),label:(null==p?void 0:p.label)||c,value:d})}return 0===a.length?null:{fields:a,raw:e,parseMethod:"markdown"}}(e);if(n)return n;const s=function(e){const t=[];for(const n of r){const r=[new RegExp(`\\*\\*${n.label}:\\*\\*\\s*([\\s\\S]*?)(?=\\*\\*[A-Z]|$)`,"i"),new RegExp(`${n.label}:\\s*([\\s\\S]*?)(?=\\n[A-Z][a-z]+:|$)`,"i"),new RegExp(`\\[${n.label}\\]\\s*([\\s\\S]*?)(?=\\[[A-Z]|$)`,"i")];for(const s of r){const r=e.match(s);if(r&&r[1].trim()){t.push({key:n.key,label:n.label,value:r[1].trim()});break}}}return 0===t.length?null:{fields:t,raw:e,parseMethod:"heuristic"}}(e);return s||{fields:[{key:"content",label:"Content",value:e.trim()}],raw:e,parseMethod:"raw"}}function ce(e){return e.replace(/_/g," ").replace(/([a-z])([A-Z])/g,"$1 $2").replace(/\b\w/g,(e=>e.toUpperCase()))}function le(e,t){const n=e.selectedStages.indexOf(t);return-1===n||n>=e.selectedStages.length-1?null:e.selectedStages[n+1]}function ue(e){return!!e.results.rewrite}function de(e,t){var n,r,s,i;if(!e.character)return null;const a=J(e.configs[t]);if(!a.trim())return null;const o=te(e.character),{name1:c}=SillyTavern.getContext(),l={originalCharacter:o,scoreResults:(null===(n=e.results.score)||void 0===n?void 0:n.response)||"",rewriteResults:(null===(r=e.results.rewrite)||void 0===r?void 0:r.response)||"",currentRewrite:(null===(s=e.results.rewrite)||void 0===s?void 0:s.response)||"",currentAnalysis:(null===(i=e.results.analyze)||void 0===i?void 0:i.response)||"",iterationNumber:String(e.iterationCount+1),charName:e.character.name,userName:c||"User"},u=X(a),d=u.length>0,p=Y(a,l);if(d){return u.includes("ORIGINAL_CHARACTER")?p:fe(t,e,o,p)}return v("info","No placeholders in prompt, auto-prepending character data",{stage:t}),fe(t,e,o,p)}function pe(e){var t;if(!e.character||!e.results.rewrite||!e.results.analyze)return null;const n=S().refinementPrompt,r=te(e.character),{name1:s}=SillyTavern.getContext();return Y(n,{originalCharacter:r,scoreResults:(null===(t=e.results.score)||void 0===t?void 0:t.response)||"",rewriteResults:e.results.rewrite.response,currentRewrite:e.results.rewrite.response,currentAnalysis:e.results.analyze.response,iterationNumber:String(e.iterationCount+1),charName:e.character.name,userName:s||"User"})}function fe(e,t,n,r){var s,i,a;const o=[],c="score"===e?"Analyze":"rewrite"===e?"Rewrite":"Compare";switch(o.push(`# Character to ${c}`,"",n),e){case"score":break;case"rewrite":(null===(s=t.results.score)||void 0===s?void 0:s.response)&&o.push("","---","","# Score Feedback","","Use this feedback to guide your rewrite:","",t.results.score.response);break;case"analyze":(null===(i=t.results.rewrite)||void 0===i?void 0:i.response)&&o.push("","---","","# Rewritten Version","","Compare this against the original:","",t.results.rewrite.response),(null===(a=t.results.score)||void 0===a?void 0:a.response)&&o.push("","---","","# Original Score Feedback","","Reference for what was identified as needing improvement:","",t.results.score.response)}return o.push("","---","","# Instructions","",r),o.join("\n")}function me(e,t){return function(e){if(!e.useStructuredOutput)return null;if(e.schemaPresetId){const t=k(e.schemaPresetId);if(t)return t.schema;v("error","Schema preset not found",{id:e.schemaPresetId})}if(e.customSchema){const t=H(e.customSchema);if(t.valid&&t.schema)return t.schema;v("error","Custom schema invalid",{error:t.error})}return null}(e.configs[t])}function ge(e){const t=function(e){if(!e.results.rewrite||!e.character)return null;const t=e.results.rewrite.response,n=[`# ${e.character.name} (Rewritten)`,"",`Generated: ${(new Date).toLocaleString()}`,`Iterations: ${e.iterationCount}`,"","---","",t];if(e.results.analyze&&n.push("","---","","## Final Analysis","",e.results.analyze.response),e.results.score&&n.push("","---","","## Original Score","",e.results.score.response),e.iterationHistory.length>0){n.push("","---","","## Iteration History","");for(const t of e.iterationHistory)n.push(`### Iteration ${t.iteration+1} - ${t.verdict.toUpperCase()}`,`${new Date(t.timestamp).toLocaleString()}`,"")}return n.join("\n")}(e);return Object.assign(Object.assign({},e),{exportData:t})}var he=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))},_e=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,s){(function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)})(r,s,(t=e[n](t)).done,t.value)}))}}};function ve(){const{onlineStatus:e}=SillyTavern.getContext();return"Valid"===e||"Connected"===e}function ye(){var e,t,n;const r=SillyTavern.getContext(),s=S();return s.useCurrentSettings?{source:(null===(e=r.chatCompletionSettings)||void 0===e?void 0:e.chat_completion_source)||r.mainApi||"unknown",model:(null===(t=r.chatCompletionSettings)||void 0===t?void 0:t.openrouter_model)||(null===(n=r.chatCompletionSettings)||void 0===n?void 0:n.model_openai_select)||"unknown",isReady:ve()}:{source:s.generationConfig.source,model:s.generationConfig.model,isReady:ve()}}function $e(e,t,n){return he(this,void 0,void 0,(function*(){const r=SillyTavern.getContext(),s=S();if(null==n?void 0:n.aborted)return{success:!1,error:"Generation cancelled"};if(!e.character)return{success:!1,error:"No character selected"};if(!ve())return y("API not ready",{onlineStatus:r.onlineStatus}),{success:!1,error:"API is not connected. Check your connection settings."};const i=de(e,t);if(!i)return{success:!1,error:"No prompt configured for this stage"};const a=e.configs[t].useStructuredOutput?me(e,t):null,o=we(i,e.character.name,r.name1||"User");v("info","Starting stage generation",{stage:t,character:e.character.name,useCurrentSettings:s.useCurrentSettings,useStructured:!!a,schemaName:null==a?void 0:a.name,promptLength:o.length});const c=yield be(s.systemPrompt,o,a,n,s.useCurrentSettings);return c.success&&a?function(e,t){try{const n=JSON.parse(e);if(t.value.required&&Array.isArray(t.value.required)){const r=t.value.required.filter((e=>!(e in n)));if(r.length>0)return v("info","Structured response missing required fields, returning as unstructured",{missing:r,schemaName:t.name}),{success:!0,response:e,isStructured:!1}}return{success:!0,response:e,isStructured:!0}}catch(n){return v("info","Failed to parse structured response, returning as unstructured",{error:n.message,schemaName:t.name,responsePreview:e.substring(0,200)}),{success:!0,response:e,isStructured:!1}}}(c.response,a):c}))}function be(e,t,n,r,s){return he(this,void 0,void 0,(function*(){try{let i;return i=s?yield function(e,t,n,r){return he(this,void 0,void 0,(function*(){const{generateRaw:s,substituteParams:i}=SillyTavern.getContext(),a=i(e);if(v("request","generateRaw request",{hasSchema:!!n,schemaName:null==n?void 0:n.name,systemPromptLength:a.length,userPromptLength:t.length}),null==r?void 0:r.aborted)throw new DOMException("Aborted","AbortError");const o=yield s({prompt:[{role:"system",content:a},{role:"user",content:t}],jsonSchema:n});if(null==r?void 0:r.aborted)throw new DOMException("Aborted","AbortError");const c=Se(o);return v("response","generateRaw response",{type:typeof o,length:c.length,preview:c.substring(0,200)}),c}))}(e,t,n,r):yield function(e,t,n,r){return he(this,void 0,void 0,(function*(){const{ChatCompletionService:s,substituteParams:i}=SillyTavern.getContext(),a=S().generationConfig,o={stream:!0,messages:[{role:"system",content:i(e)},{role:"user",content:t}],chat_completion_source:a.source,model:a.model,temperature:a.temperature,max_tokens:a.maxTokens,frequency_penalty:a.frequencyPenalty,presence_penalty:a.presencePenalty,top_p:a.topP};if(n&&(o.json_schema=n),v("request","ChatCompletionService request",{source:a.source,model:a.model,stream:!0,hasSchema:!!n}),null==r?void 0:r.aborted)throw new DOMException("Aborted","AbortError");const c=yield s.sendRequest(o);let l;if(v("response","ChatCompletionService result type",{type:typeof c,isFunction:"function"==typeof c,isGenerator:c&&"object"==typeof c&&Symbol.asyncIterator in c}),"function"==typeof c)l=yield function(e,t){return he(this,void 0,void 0,(function*(){var n,r,s,i;let a="";try{const u=e();try{for(var o,c=!0,l=_e(u);!(n=(o=yield l.next()).done);c=!0){i=o.value,c=!1;const e=i;if(null==t?void 0:t.aborted)throw v("info","Stream aborted",{textSoFar:a.length}),new DOMException("Aborted","AbortError");const n=e;if("string"==typeof n.text&&(a=n.text),n.error)throw new Error(Se(n.error))}}catch(e){r={error:e}}finally{try{c||n||!(s=l.return)||(yield s.call(l))}finally{if(r)throw r.error}}}catch(e){if("AbortError"===e.name)throw e;if(y("Stream consumption error",{error:e,textSoFar:a.length}),a)return v("info","Returning partial response after stream error",{length:a.length}),a;throw e}return v("info","Stream consumed",{finalLength:a.length}),a}))}(c,r);else if(c&&"object"==typeof c){const e=c;if(e.error)throw y("API returned error",c),new Error(`API error: ${JSON.stringify(c)}`);l=Se(e.content||c)}else l=Se(c);return v("response","Final response",{length:l.length,preview:l.substring(0,200)}),l}))}(e,t,n,r),(null==r?void 0:r.aborted)?{success:!1,error:"Generation cancelled"}:i&&""!==i.trim()?(v("info","Generation complete",{responseLength:i.length,isStructured:!!n}),{success:!0,response:i,isStructured:!!n}):(y("Empty response",null),{success:!1,error:"Empty response from API"})}catch(e){if("AbortError"===e.name||(null==r?void 0:r.aborted))return v("info","Generation aborted",null),{success:!1,error:"Generation cancelled"};y("Generation exception",{message:e instanceof Error?e.message:String(e)});return{success:!1,error:e instanceof Error?e.message:String(e)}}}))}function Se(e){if("string"==typeof e)return e;if(null==e)return"";if("object"==typeof e)try{return JSON.stringify(e)}catch(t){return String(e)}return String(e)}function we(e,t,n){return e.replace(/\{\{char\}\}/gi,t).replace(/\{\{user\}\}/gi,n)}var Ce=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};const xe=new Map;function Ee(t){const{getThumbnailUrl:n}=SillyTavern.getContext(),r=ee(t),s=n("avatar",t.avatar);return`\n    <div class="${e}_char_preview" id="${e}_char_preview">\n      <div class="${e}_char_header">\n        <img\n          class="${e}_char_avatar"\n          src="${s}"\n          alt=""\n          onerror="this.src='/img/ai4.png'"\n        >\n        <div class="${e}_char_info">\n          <div class="${e}_char_name">${Oe(t.name)}</div>\n          <div class="${e}_char_meta">\n            ${r.length} fields • <span id="${e}_total_tokens">counting...</span>\n          </div>\n        </div>\n        <button id="${e}_char_clear" class="${e}_icon_btn" title="Clear selection">\n          <i class="fa-solid fa-xmark"></i>\n        </button>\n      </div>\n\n      <div class="${e}_char_fields">\n        ${r.map((t=>{return`\n    <div class="${e}_field_row">\n      <div class="${e}_field_header ${e}_field_toggle" data-field="${(n=t).key}">\n        <i class="fa-solid fa-chevron-right"></i>\n        <span class="${e}_field_label">${n.label}</span>\n        <span class="${e}_field_tokens" data-field="${n.key}">...</span>\n      </div>\n      <div class="${e}_field_content hidden" id="${e}_field_content_${n.key}">\n        <div class="${e}_field_text">${Oe(n.value)}</div>\n      </div>\n    </div>\n  `;var n})).join("")}\n      </div>\n    </div>\n  `}function Pe(t,n,r){const{getThumbnailUrl:s}=SillyTavern.getContext();if(0!==t.length){if(n.innerHTML=t.map((({char:t,index:n},i)=>{const a=s("avatar",t.avatar),o=i===r,c=(t.description||"No description").substring(0,80);return`\n      <div class="${e}_dropdown_item ${o?"selected":""}" data-index="${n}">\n        <img class="${e}_dropdown_avatar" src="${a}" alt="" onerror="this.src='/img/ai4.png'">\n        <div class="${e}_dropdown_info">\n          <span class="${e}_dropdown_name">${Oe(t.name)}</span>\n          <span class="${e}_dropdown_desc">${Oe(c)}${c.length>=80?"...":""}</span>\n        </div>\n      </div>\n    `})).join(""),r>=0){const t=n.querySelector(`.${e}_dropdown_item.selected`);null==t||t.scrollIntoView({block:"nearest"})}}else n.innerHTML=`<div class="${e}_dropdown_empty">No characters found</div>`}function Oe(e){const{DOMPurify:t}=SillyTavern.libs,n="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(n,{ALLOWED_TAGS:[]})}function Ae(e){return r.filter((t=>{const n=e[t.key];return n&&"string"==typeof n&&n.trim().length>0})).map((t=>{const n=e[t.key].trim();return{key:t.key,label:t.label,value:n,charCount:n.length,scoreable:t.scoreable}}))}function ke(t,n,r,o){return`\n    <div class="${e}_pipeline_nav">\n      \x3c!-- Stage Selection --\x3e\n      <div class="${e}_stage_row">\n        ${s.map(((o,c)=>function(t,n,r,s,o){const c=function(e){switch(e){case"complete":return"fa-check";case"running":return"fa-spinner fa-spin";case"skipped":return"fa-forward";default:return null}}(r);return`\n    <div class="${e}_stage_node ${s?"active":""} ${e}_stage_${r}">\n      <input\n        type="checkbox"\n        class="${e}_stage_checkbox"\n        id="${e}_stage_cb_${t}"\n        data-stage="${t}"\n        ${n?"checked":""}\n      >\n      <button\n        class="${e}_stage_btn ${s?"active":""}"\n        data-stage="${t}"\n        title="${i[t]}"\n      >\n        <i class="fa-solid ${a[t]}"></i>\n        <span>${i[t]}</span>\n        ${c?`<i class="fa-solid ${c} ${e}_status_icon"></i>`:""}\n      </button>\n      ${o?`<div class="${e}_stage_connector ${n?"active":""}"></div>`:""}\n    </div>\n  `}(o,t.includes(o),n[o],o===r,c<s.length-1))).join("")}\n      </div>\n\n      \x3c!-- Action Buttons --\x3e\n      <div class="${e}_pipeline_actions">\n        <button\n          id="${e}_run_selected_btn"\n          class="menu_button"\n          ${o?"":"disabled"}\n        >\n          <i class="fa-solid fa-play"></i>\n          <span>Run Selected</span>\n        </button>\n        <button\n          id="${e}_run_all_btn"\n          class="menu_button"\n          ${o?"":"disabled"}\n        >\n          <i class="fa-solid fa-forward"></i>\n          <span>Run All</span>\n        </button>\n        <button\n          id="${e}_reset_pipeline_btn"\n          class="menu_button"\n        >\n          <i class="fa-solid fa-rotate-left"></i>\n          <span>Reset</span>\n        </button>\n      </div>\n    </div>\n  `}var Te=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};function Re(){return Te(this,void 0,void 0,(function*(){const{Popup:e,POPUP_RESULT:t}=SillyTavern.getContext(),n=yield e.show.input("Generate Schema",'Describe the structure you want (e.g., <q>"scores for each field 1-10, list of suggestions, overall rating"</q>):\n',"");if(null===n||n===t.CANCELLED||!n.trim())return null;Ie(!0);try{toastr.info("Generating schema...");const e=yield function(e){return L(this,void 0,void 0,(function*(){var t;const{generateRaw:n}=SillyTavern.getContext();if(!e.trim())return{success:!1,error:"Please describe what you want in the schema"};try{let r=(yield n({prompt:`${M}\n\n${e}`,systemPrompt:"You are a JSON Schema expert. Output only valid JSON, nothing else."})).trim();r.startsWith("```")&&(r=r.replace(/^```(?:json)?\s*/,"").replace(/\s*```$/,""));const s=H(r);if(!s.valid)return{success:!1,error:`Generated schema is invalid: ${s.error}`,schema:r};if(null===(t=s.warnings)||void 0===t?void 0:t.length){const e=G(s.schema);return{success:!0,schema:JSON.stringify(e,null,2)}}return{success:!0,schema:JSON.stringify(s.schema,null,2)}}catch(e){return{success:!1,error:`Generation failed: ${e.message}`}}}))}(n);return e.success?(toastr.success("Schema generated!"),e.schema):(toastr.error(e.error||"Generation failed"),e.schema||null)}finally{Ie(!1)}}))}function Ie(t){const n=document.querySelector(`.${e}_loading_overlay`);if(t&&!n){const t=document.createElement("div");t.className=`${e}_loading_overlay`,t.innerHTML=`\n            <div class="${e}_loading_content">\n                <i class="fa-solid fa-spinner fa-spin fa-2x"></i>\n                <p>Generating schema...</p>\n            </div>\n        `,document.body.appendChild(t)}else!t&&n&&n.remove()}function Le(t,n,r,s){const a=E(n),o=A(n),c=t.querySelector(`#${e}_prompt_preset_select`);c&&(c.innerHTML=`<option value="">Custom</option>${je(a,r.promptPresetId)}`,c.value=r.promptPresetId||"",c.disabled=s);const l=t.querySelector(`#${e}_custom_prompt`);if(l){let n=r.customPrompt;if(r.promptPresetId){const e=P(r.promptPresetId);e&&(n=e.prompt)}l.value!==n&&(l.value=n),l.disabled=s;const i=t.querySelector(`.${e}_char_count`);i&&(i.textContent=`${n.length.toLocaleString()} chars`)}const u=t.querySelector(`#${e}_use_structured`);u&&(u.checked=r.useStructuredOutput,u.disabled=s);const d=t.querySelector(`.${e}_schema_section`);d&&d.classList.toggle("hidden",!r.useStructuredOutput);const p=t.querySelector(`#${e}_schema_preset_select`);p&&(p.innerHTML=`<option value="">Custom</option>${je(o,r.schemaPresetId)}`,p.value=r.schemaPresetId||"",p.disabled=s);const f=t.querySelector(`#${e}_custom_schema`);if(f){let e=r.customSchema;if(r.schemaPresetId){const t=k(r.schemaPresetId);t&&(e=JSON.stringify(t.schema,null,2))}f.value!==e&&(f.value=e),f.disabled=s}r.useStructuredOutput&&function(t,n){var r;const s=t.querySelector(`.${e}_schema_status`);s&&s.remove();if(!n.trim())return;const i=H(n);let a="";a=i.valid?(null===(r=i.warnings)||void 0===r?void 0:r.length)?`<div class="${e}_schema_status warning"><i class="fa-solid fa-triangle-exclamation"></i> ${i.warnings.length} warning(s)</div>`:`<div class="${e}_schema_status success"><i class="fa-solid fa-circle-check"></i> Valid schema</div>`:`<div class="${e}_schema_status error"><i class="fa-solid fa-circle-xmark"></i> ${Ne(i.error||"Invalid schema")}</div>`;const o=t.querySelector(`#${e}_custom_schema`);o&&o.insertAdjacentHTML("afterend",a)}(t,(null==f?void 0:f.value)||""),function(t,n){var r,s;const i=t.querySelector(`#${e}_validate_schema_btn`),a=t.querySelector(`#${e}_fix_schema_btn`),o=t.querySelector(`#${e}_format_schema_btn`),c=n.trim().length>0;i&&(i.disabled=!c);o&&(o.disabled=!c);if(a&&c){const e=H(n),t=(null!==(s=null===(r=e.warnings)||void 0===r?void 0:r.length)&&void 0!==s?s:0)>0||!e.valid;a.disabled=!t}else a&&(a.disabled=!0)}(t,(null==f?void 0:f.value)||"");const m=t.querySelector(`#${e}_run_stage_btn`);m&&(m.disabled=s,m.innerHTML=s?'<i class="fa-solid fa-spinner fa-spin"></i> Running...':`<i class="fa-solid fa-play"></i> Run ${i[n]} <kbd>Ctrl+Enter</kbd>`),function(t,n){var r,s;const i=t.querySelector(`#${e}_custom_prompt`),a=t.querySelector(`#${e}_custom_schema`),o=t.querySelector(`#${e}_save_prompt_preset_btn`),c=t.querySelector(`#${e}_save_schema_preset_btn`);if(o&&i){const e=i.value.trim(),t=n.promptPresetId&&(null===(r=P(n.promptPresetId))||void 0===r?void 0:r.prompt)||"",s=e.length>0,a=e!==t;o.disabled=!s||null!==n.promptPresetId&&!a}if(c&&a){const e=a.value.trim(),t=n.schemaPresetId?JSON.stringify(null===(s=k(n.schemaPresetId))||void 0===s?void 0:s.schema,null,2):"",r=e.length>0,i=e!==t,o=!!r&&H(e).valid;c.disabled=!r||!o||null!==n.schemaPresetId&&!i}}(t,r)}function je(e,t){return e.map((e=>{const n=e.id===t?"selected":"",r=e.isBuiltin?"📦":"📝";return`<option value="${e.id}" ${n}>${r} ${Ne(e.name)}</option>`})).join("")}function Ne(e){const{DOMPurify:t}=SillyTavern.libs;return t.sanitize(e,{ALLOWED_TAGS:[]})}function qe(e,t){const{showdown:n,DOMPurify:r}=SillyTavern.libs,s="string"==typeof e?e:String(null!=e?e:""),i=`<div class="${t}_markdown_content">${new n.Converter({tables:!0,strikethrough:!0,simpleLineBreaks:!1,headerLevelStart:1,ghCodeBlocks:!0,tasklists:!0,openLinksInNewWindow:!0,emoji:!0,parseImgDimensions:!0,simplifiedAutoLink:!0}).makeHtml(s)}</div>`;return r.sanitize(i)}function De(e,t,n){var r;const{DOMPurify:s}=SillyTavern.libs,i="string"==typeof e?e:String(null!=e?e:""),a=function(e){try{return JSON.parse(e)}catch(t){const n=e.match(/```(?:json)?\s*([\s\S]*?)```/);if(n)try{return JSON.parse(n[1].trim())}catch(e){return null}return null}}(i);if(!a||"object"!=typeof a)return qe(i,n);const o=function(e,t,n){const r=function(e){const t=["overallscore","totalscore","overall","total","score","rating"];for(const n of t)for(const t of Object.keys(e))if(t.toLowerCase().replace(/_/g,"")===n&&"number"==typeof e[t])return t;return null}(e),s=r?e[r]:null,i=[];r&&"number"==typeof s&&i.push(function(e,t,n){const r=Ye(e),s=Xe(t>10?t/10:t),i=Number.isInteger(t)?t:t.toFixed(1),a=t>10?100:10;return`\n    <div class="${n}_hero">\n      <div class="${n}_hero_label">${Be(r)}</div>\n      <div class="${n}_hero_value" style="color: ${s}">\n        ${i}<span class="${n}_hero_max">/${a}</span>\n      </div>\n    </div>\n  `}(r,s,n));const a=t.properties||{},o=Object.keys(a).length>0?Object.keys(a):Object.keys(e);for(const t of o){if(t===r)continue;const s=e[t];if(void 0===s)continue;const o=a[t]||{type:Je(s)};i.push(Fe(t,s,o,n,0))}return`<div class="${n}_structured_content">${i.join("")}</div>`}(a,null!==(r=null==t?void 0:t.value)&&void 0!==r?r:Me(a),n);return s.sanitize(o)}function Me(e){if(null===e)return{type:"null"};if(Array.isArray(e))return{type:"array",items:e.length>0?Me(e[0]):{type:"string"}};if("object"==typeof e){const t={};for(const[n,r]of Object.entries(e))t[n]=Me(r);return{type:"object",properties:t}}return{type:typeof e}}const He=8;function Fe(e,t,n,r,s){if(s>He)return function(e,t){const{hljs:n}=SillyTavern.libs,r=JSON.stringify(e,null,2),s=n.highlight(r,{language:"json"}).value;return`<pre class="${t}_json"><code class="hljs">${s}</code></pre>`}(t,r);const i=Ye(e),a=n.type||Je(t);if("array"===a&&Array.isArray(t))return function(e,t,n,r,s){if(0===t.length)return`\n      <div class="${r}_field">\n        <div class="${r}_field_label">${Be(e)}</div>\n        <div class="${r}_field_value ${r}_empty">(none)</div>\n      </div>\n    `;const i=n.items||{type:Je(t[0])};if(t.every(We)){const n=t.map((e=>`<li>${function(e,t){if("boolean"==typeof e)return Ge(e,t);if("number"==typeof e)return`<span class="${t}_num">${e.toLocaleString()}</span>`;return Be(String(e))}(e,r)}</li>`)).join("");return`\n      <div class="${r}_field">\n        <div class="${r}_field_label">${Be(e)}</div>\n        <ol class="${r}_list">${n}</ol>\n      </div>\n    `}const a=t.map(((e,t)=>"object"==typeof e&&null!==e?function(e,t,n,r,s){const i=t.properties||{},a=Object.keys(i).length>0?Object.keys(i):Object.keys(e),o=a.find((t=>"string"==typeof e[t]&&e[t].length<100)),c=a.find((t=>"number"==typeof e[t]&&e[t]>=0&&e[t]<=100)),l=a.find((t=>"string"==typeof e[t]&&e[t].length>=50&&t!==o));let u="";if(o||c){const t=o?`<span class="${n}_card_title">${Be(String(e[o]))}</span>`:"",r=c?Ue(e[c],n):"";u=`<div class="${n}_card_header">${t}${r}</div>`}let d="";l&&(d=`<div class="${n}_card_body">${Ve(String(e[l]),n)}</div>`);const p=a.filter((e=>e!==o&&e!==c&&e!==l)).map((t=>{const s=e[t];if(void 0===s)return"";return Fe(t,s,i[t]||{type:Je(s)},n,r+1)})).filter(Boolean).join(""),f=p?`<div class="${n}_card_extra">${p}</div>`:"";return`<div class="${n}_card">${u}${d}${f}</div>`}(e,i,r,s+1):`<div class="${r}_card">${ze(e,i,r)}</div>`)).join("");return`\n    <div class="${r}_field">\n      <div class="${r}_field_label">${Be(e)}</div>\n      <div class="${r}_cards">${a}</div>\n    </div>\n  `}(i,t,n,r,s);if("object"===a&&"object"==typeof t&&null!==t)return function(e,t,n,r,s){const i=n.properties||{},a=(Object.keys(i).length>0?Object.keys(i):Object.keys(t)).map((e=>{const n=t[e];if(void 0===n)return"";return Fe(e,n,i[e]||{type:Je(n)},r,s+1)})).filter(Boolean).join("");return`\n    <div class="${r}_field">\n      <div class="${r}_field_label">${Be(e)}</div>\n      <div class="${r}_nested">${a}</div>\n    </div>\n  `}(i,t,n,r,s);const o=ze(t,n,r,e);return`\n    <div class="${r}_field">\n      <div class="${r}_field_label">${Be(i)}</div>\n      <div class="${r}_field_value">${o}</div>\n    </div>\n  `}function ze(e,t,n,r){if(null==e)return`<span class="${n}_null">—</span>`;switch(t.type||Je(e)){case"string":return function(e,t,n){if(!e.trim())return`<span class="${n}_empty">(empty)</span>`;const r=t.format;if("uri"===r||"url"===r||(s=e,/^https?:\/\//i.test(s))){const t=e.length>50?e.substring(0,47)+"...":e;return`<a href="${Be(e)}" target="_blank" rel="noopener" class="${n}_link">${Be(t)}</a>`}var s;if("email"===r||function(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}(e))return`<a href="mailto:${Be(e)}" class="${n}_link">${Be(e)}</a>`;if(e.length>100||e.includes("\n"))return Ve(e,n);return`<span>${Be(e)}</span>`}(e,t,n);case"number":case"integer":return function(e,t,n,r){const s=String(t.title||t.description||r||"").toLowerCase();if(function(e,t){return!!["score","rating","rank","grade","level","confidence","quality"].some((t=>e.includes(t)))||(!!(t>=0&&t<=10&&Number.isFinite(t))||!!(t>=0&&t<=100&&Number.isInteger(t)))}(s,e))return Ue(e,n);const i=e.toLocaleString(void 0,{maximumFractionDigits:2});return`<span class="${n}_num">${i}</span>`}(e,t,n,r);case"boolean":return Ge(e,n);default:return`<span>${Be(String(e))}</span>`}}function Ve(e,t){return`<div class="${t}_text">${qe(e,t)}</div>`}function Ue(e,t){return`<span class="${t}_score" style="color: ${Xe(e>10?e/10:e)}">${Number.isInteger(e)?e:e.toFixed(1)}<span class="${t}_score_max">/${e>10?100:10}</span></span>`}function Ge(e,t){return`<span class="${e?`${t}_yes`:`${t}_no`}"><i class="fa-solid ${e?"fa-check-circle":"fa-times-circle"}"></i> ${e?"Yes":"No"}</span>`}function Be(e){const{DOMPurify:t}=SillyTavern.libs,n="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(n,{ALLOWED_TAGS:[]})}function Je(e){return null===e?"null":Array.isArray(e)?"array":typeof e}function We(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e||null===e}function Ye(e){return e.replace(/_/g," ").replace(/([a-z])([A-Z])/g,"$1 $2").replace(/\b\w/g,(e=>e.toUpperCase()))}function Xe(e){return e>=8?"var(--success, #2ecc71)":e>=5?"var(--warning, #f39c12)":"var(--failure, #e74c3c)"}function Ke(t){return`\n    <div class="${e}_results_loading">\n      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>\n      <p>Running ${i[t]}...</p>\n      <button id="${e}_cancel_btn" class="menu_button">\n        <i class="fa-solid fa-stop"></i>\n        <span>Cancel</span>\n      </button>\n    </div>\n  `}function Ze(t,n){let r=`Run ${i[t]} to see results`,s="fa-play";return"skipped"===n&&(r=`${i[t]} was skipped`,s="fa-forward"),`\n    <div class="${e}_results_placeholder">\n      <i class="fa-solid ${s}"></i>\n      <p>${r}</p>\n    </div>\n  `}function Qe(t,n){const r=n.isStructured?De(n.response,null,e):qe(n.response,e),s=new Date(n.timestamp).toLocaleTimeString();let a="";if("analyze"===t){a=function(t){return`\n    <span class="${e}_badge ${e}_verdict_badge ${e}_verdict_${t}">\n      <i class="fa-solid ${{accept:"fa-check-circle",needs_refinement:"fa-wrench",regression:"fa-arrow-down"}[t]}"></i>\n      ${{accept:"Accept",needs_refinement:"Needs Work",regression:"Regression"}[t]}\n    </span>\n  `}(ie(n.response))}return`\n    <div class="${e}_results_content">\n      \x3c!-- Toolbar --\x3e\n      <div class="${e}_results_toolbar">\n        <div class="${e}_results_info">\n          <span class="${e}_badge">${i[t]}</span>\n          ${a}\n          <span class="${e}_results_time">${s}</span>\n          ${n.locked?`<span class="${e}_badge ${e}_badge_locked"><i class="fa-solid fa-lock"></i> Locked</span>`:""}\n        </div>\n        <div class="${e}_results_actions">\n          \x3c!-- Always render BOTH buttons, use hidden class based on locked state --\x3e\n          <button id="${e}_lock_btn" class="${e}_icon_btn ${n.locked?"hidden":""}" title="Lock result">\n            <i class="fa-solid fa-lock"></i>\n          </button>\n          <button id="${e}_unlock_btn" class="${e}_icon_btn ${n.locked?"":"hidden"}" title="Unlock for editing">\n            <i class="fa-solid fa-lock-open"></i>\n          </button>\n          <button id="${e}_copy_btn" class="${e}_icon_btn" title="Copy to clipboard">\n            <i class="fa-solid fa-copy"></i>\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Content --\x3e\n      <div class="${e}_results_body">\n        ${r}\n      </div>\n\n      \x3c!-- Footer Actions --\x3e\n      <div class="${e}_results_footer" id="${e}_results_footer">\n        \x3c!-- Populated by updateResultsPanelState --\x3e\n      </div>\n    </div>\n  `}function et(t,n,r,s,a,o,c){var l;const u=a&&"running"===s,d=r&&!u,p=!r&&!u;if(u)return void(t.innerHTML=Ke(n));if(p)return void(t.innerHTML=Ze(n,s));if(d){const s=t.querySelector(`.${e}_results_content`),i=null===(l=t.querySelector(`.${e}_results_time`))||void 0===l?void 0:l.textContent,a=new Date(r.timestamp).toLocaleTimeString();s&&i===a||(t.innerHTML=Qe(n,r))}const f=t.querySelector(`#${e}_results_footer`);f&&r&&(f.innerHTML=function(t,n,r,s){const a=[];n.locked||a.push(`\n      <button id="${e}_regenerate_btn" class="menu_button">\n        <i class="fa-solid fa-rotate"></i>\n        <span>Regenerate</span>\n      </button>\n    `);"rewrite"===t&&s.character&&a.push(`\n      <button id="${e}_apply_btn" class="menu_button ${e}_apply_btn">\n        <i class="fa-solid fa-check-double"></i>\n        <span>Apply to Character</span>\n      </button>\n    `);if("analyze"===t){const t=ie(n.response);if(ne(s).canRun){const n="needs_refinement"===t;a.push(`\n        <button id="${e}_refine_btn" class="menu_button ${n?e+"_refine_recommended":""}">\n          <i class="fa-solid fa-arrows-rotate"></i>\n          <span>Refine</span>\n          ${s.iterationCount>0?`<span class="${e}_iteration_badge">#${s.iterationCount+1}</span>`:""}\n        </button>\n      `)}if(s.results.rewrite&&!s.results.rewrite.locked){const n="accept"===t;a.push(`\n        <button id="${e}_accept_btn" class="menu_button ${n?e+"_accept_recommended":""}">\n          <i class="fa-solid fa-check"></i>\n          <span>Accept Rewrite</span>\n        </button>\n      `)}}r&&"analyze"!==t&&a.push(`\n      <button id="${e}_continue_btn" class="menu_button ${e}_continue_btn">\n        <i class="fa-solid fa-arrow-right"></i>\n        <span>Continue to ${i[r]}</span>\n      </button>\n    `);ue(s)&&a.push(`\n      <button id="${e}_export_btn" class="menu_button">\n        <i class="fa-solid fa-file-export"></i>\n        <span>Export</span>\n      </button>\n    `);return`<div class="${e}_footer_actions">${a.join("")}</div>`}(n,r,o,c));const m=t.querySelector(`#${e}_lock_btn`),g=t.querySelector(`#${e}_unlock_btn`);m&&g&&(m.classList.toggle("hidden",!!(null==r?void 0:r.locked)),g.classList.toggle("hidden",!(null==r?void 0:r.locked)))}function tt(t,n,r){if(0===t.length&&0===n)return"";const s=r?0===t.length?`<div class="${e}_iteration_empty">No previous iterations</div>`:t.map(((e,t)=>nt(e,t))).join(""):`<div class="${e}_iteration_loading">\n             <i class="fa-solid fa-spinner fa-spin"></i>\n             <span>Loading history...</span>\n           </div>`;return`\n    <div class="${e}_iteration_history" id="${e}_iteration_history">\n      <div class="${e}_iteration_header">\n        <i class="fa-solid fa-clock-rotate-left"></i>\n        <span>Iteration History</span>\n        <span class="${e}_iteration_count">${n>0?`Current: #${n+1}`:"Initial"}</span>\n      </div>\n      <div class="${e}_iteration_list">\n        ${s}\n      </div>\n    </div>\n  `}function nt(t,n){const r=rt(t.verdict),s=st(t.verdict),i=new Date(t.timestamp).toLocaleTimeString();return`\n    <div class="${e}_iteration_item ${s}" data-index="${n}">\n      <div class="${e}_iteration_item_header">\n        <span class="${e}_iteration_num">#${t.iteration+1}</span>\n        <span class="${e}_iteration_verdict">\n          <i class="fa-solid ${r}"></i>\n          ${it(t.verdict)}\n        </span>\n        <span class="${e}_iteration_time">${i}</span>\n      </div>\n      <div class="${e}_iteration_preview">\n        ${at(t.rewritePreview)}...\n      </div>\n      <div class="${e}_iteration_actions">\n        <button\n          class="${e}_iteration_revert_btn menu_button"\n          data-index="${n}"\n          title="Revert to this version"\n        >\n          <i class="fa-solid fa-rotate-left"></i>\n          Revert\n        </button>\n        <button\n          class="${e}_iteration_view_btn menu_button"\n          data-index="${n}"\n          title="View full content"\n        >\n          <i class="fa-solid fa-eye"></i>\n          View\n        </button>\n      </div>\n    </div>\n  `}function rt(e){switch(e){case"accept":return"fa-check-circle";case"needs_refinement":return"fa-wrench";case"regression":return"fa-arrow-down";default:return"fa-question-circle"}}function st(t){return`${e}_verdict_${t}`}function it(e){switch(e){case"accept":return"Accepted";case"needs_refinement":return"Needs Work";case"regression":return"Regression";default:return"Unknown"}}function at(e){const{DOMPurify:t}=SillyTavern.libs,n="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(n,{ALLOWED_TAGS:[]})}var ot=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};function ct(t){return ot(this,void 0,void 0,(function*(){const{Popup:r,POPUP_TYPE:s}=SillyTavern.getContext(),{DOMPurify:i}=SillyTavern.libs,a=function(){const t=S(),n=t.generationConfig,{moment:r}=SillyTavern.libs;return`\n    <div class="${e}_settings_modal" id="${e}_settings_modal">\n      <div class="${e}_settings_header">\n        <i class="fa-solid fa-gear"></i>\n        <span>Character Tools Settings</span>\n      </div>\n\n      \x3c!-- Generation Settings --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-microchip"></i>\n          <span>Generation</span>\n        </div>\n\n        <div class="${e}_settings_row">\n          <label class="${e}_checkbox_label">\n            <input\n              type="checkbox"\n              id="${e}_use_current_settings"\n              ${t.useCurrentSettings?"checked":""}\n            >\n            <span>Use Current SillyTavern Settings</span>\n          </label>\n        </div>\n\n        <div id="${e}_custom_gen_config" class="${t.useCurrentSettings?"hidden":""}">\n          <div class="${e}_settings_grid">\n            <div class="${e}_settings_field">\n              <label>Source</label>\n              <select id="${e}_gen_source" class="text_pole"></select>\n            </div>\n            <div class="${e}_settings_field">\n              <label>Model</label>\n              <select id="${e}_gen_model" class="text_pole"></select>\n            </div>\n          </div>\n\n          <div class="${e}_settings_grid ${e}_settings_grid_5">\n            <div class="${e}_settings_field">\n              <label>Temp</label>\n              <input type="number" id="${e}_gen_temp" class="text_pole" value="${n.temperature}" min="0" max="2" step="0.1">\n            </div>\n            <div class="${e}_settings_field">\n              <label>Max Tokens</label>\n              <input type="number" id="${e}_gen_tokens" class="text_pole" value="${n.maxTokens}" min="100" max="32000" step="100">\n            </div>\n            <div class="${e}_settings_field">\n              <label>Freq Pen</label>\n              <input type="number" id="${e}_gen_freq" class="text_pole" value="${n.frequencyPenalty}" min="-2" max="2" step="0.1">\n            </div>\n            <div class="${e}_settings_field">\n              <label>Pres Pen</label>\n              <input type="number" id="${e}_gen_pres" class="text_pole" value="${n.presencePenalty}" min="-2" max="2" step="0.1">\n            </div>\n            <div class="${e}_settings_field">\n              <label>Top P</label>\n              <input type="number" id="${e}_gen_top_p" class="text_pole" value="${n.topP}" min="0" max="1" step="0.05">\n            </div>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- System Prompt --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-message"></i>\n          <span>System Prompt</span>\n        </div>\n\n        <p class="${e}_settings_hint">Base instructions applied to all stages</p>\n\n        <textarea\n          id="${e}_system_prompt"\n          class="text_pole ${e}_system_prompt_textarea"\n          rows="6"\n        >${ft(t.systemPrompt)}</textarea>\n\n        <div class="${e}_settings_row_spread">\n          <span id="${e}_system_prompt_chars">${t.systemPrompt.length.toLocaleString()} chars</span>\n          <button id="${e}_reset_system_prompt" class="menu_button">\n            <i class="fa-solid fa-rotate-left"></i>\n            Reset\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Refinement Prompt --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-arrows-rotate"></i>\n          <span>Refinement Prompt</span>\n        </div>\n\n        <p class="${e}_settings_hint">Template for iterative refinement. Placeholders: {{original_character}}, {{current_rewrite}}, {{current_analysis}}, {{score_results}}, {{iteration_number}}</p>\n\n        <textarea\n          id="${e}_refinement_prompt"\n          class="text_pole ${e}_system_prompt_textarea"\n          rows="8"\n        >${ft(t.refinementPrompt)}</textarea>\n\n        <div class="${e}_settings_row_spread">\n          <span id="${e}_refinement_prompt_chars">${t.refinementPrompt.length.toLocaleString()} chars</span>\n          <button id="${e}_reset_refinement_prompt" class="menu_button">\n            <i class="fa-solid fa-rotate-left"></i>\n            Reset\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Preset Management --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-bookmark"></i>\n          <span>Presets</span>\n        </div>\n\n        <div class="${e}_presets_grid">\n          <div class="${e}_preset_column">\n            <h4>Prompt Presets</h4>\n            <div id="${e}_prompt_presets_list" class="${e}_preset_list">\n              ${lt("prompt")}\n            </div>\n          </div>\n          <div class="${e}_preset_column">\n            <h4>Schema Presets</h4>\n            <div id="${e}_schema_presets_list" class="${e}_preset_list">\n              ${lt("schema")}\n            </div>\n          </div>\n        </div>\n\n        <div class="${e}_settings_row_spread">\n          <button id="${e}_export_presets" class="menu_button">\n            <i class="fa-solid fa-file-export"></i>\n            Export Custom\n          </button>\n          <button id="${e}_import_presets" class="menu_button">\n            <i class="fa-solid fa-file-import"></i>\n            Import\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Keyboard Shortcuts --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-keyboard"></i>\n          <span>Keyboard Shortcuts</span>\n        </div>\n\n        <div class="${e}_shortcuts_list">\n          <div class="${e}_shortcut_item">\n            <kbd>Ctrl</kbd> + <kbd>Enter</kbd>\n            <span>Run current stage</span>\n          </div>\n          <div class="${e}_shortcut_item">\n            <kbd>Escape</kbd>\n            <span>Cancel generation</span>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Debug --\x3e\n      <div class="${e}_settings_section">\n        <div class="${e}_settings_section_header">\n          <i class="fa-solid fa-bug"></i>\n          <span>Debug</span>\n        </div>\n\n        <div class="${e}_settings_row">\n          <label class="${e}_checkbox_label">\n            <input\n              type="checkbox"\n              id="${e}_debug_mode"\n              ${t.debugMode?"checked":""}\n            >\n            <span>Enable Debug Logging</span>\n          </label>\n        </div>\n\n        <div class="${e}_debug_actions">\n          <button id="${e}_view_logs" class="menu_button">\n            <i class="fa-solid fa-list"></i>\n            View Logs\n          </button>\n          <button id="${e}_clear_logs" class="menu_button">\n            <i class="fa-solid fa-trash"></i>\n            Clear\n          </button>\n          <button id="${e}_copy_debug_info" class="menu_button">\n            <i class="fa-solid fa-copy"></i>\n            Copy Info\n          </button>\n        </div>\n\n        <div id="${e}_debug_log_viewer" class="${e}_debug_log_viewer hidden">\n          <div id="${e}_debug_log_list" class="${e}_debug_log_list"></div>\n          <pre id="${e}_debug_log_detail" class="${e}_debug_log_detail">Select a log entry</pre>\n        </div>\n      </div>\n\n      \x3c!-- Footer --\x3e\n      <div class="${e}_settings_footer">\n        <span class="${e}_settings_version">v1.0.0 • Last updated: ${r().format("YYYY-MM-DD HH:mm:ss")}</span>\n      </div>\n    </div>\n  `}();new r(i.sanitize(a),s.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:"Save & Close",cancelButton:!1}).show().then((()=>{null==t||t(),v("info","Settings modal closed",null)})),yield new Promise((e=>setTimeout(e,0))),function(){const t=document.getElementById(`${e}_settings_modal`);if(!t)return;const r=t.querySelector(`#${e}_use_current_settings`),s=t.querySelector(`#${e}_custom_gen_config`);null==r||r.addEventListener("change",(()=>{w("useCurrentSettings",r.checked),null==s||s.classList.toggle("hidden",r.checked)}));const i=t.querySelector(`#${e}_gen_source`),a=t.querySelector(`#${e}_gen_model`),l=t.querySelector(`#${e}_gen_temp`),u=t.querySelector(`#${e}_gen_tokens`),d=t.querySelector(`#${e}_gen_freq`),p=t.querySelector(`#${e}_gen_pres`),f=t.querySelector(`#${e}_gen_top_p`);null==i||i.addEventListener("change",(()=>{C({source:i.value}),pt(i.value)})),null==a||a.addEventListener("change",(()=>{C({model:a.value})}));const m=(e,t,n=!1)=>{null==e||e.addEventListener("change",(()=>{const r=n?parseInt(e.value,10):parseFloat(e.value);isNaN(r)||C({[t]:r})}))};m(l,"temperature"),m(u,"maxTokens",!0),m(d,"frequencyPenalty"),m(p,"presencePenalty"),m(f,"topP");const g=t.querySelector(`#${e}_system_prompt`),h=t.querySelector(`#${e}_system_prompt_chars`),y=t.querySelector(`#${e}_reset_system_prompt`);null==g||g.addEventListener("input",(()=>{w("systemPrompt",g.value),h&&(h.textContent=`${g.value.length.toLocaleString()} chars`)})),null==y||y.addEventListener("click",(()=>{w("systemPrompt",o),g&&(g.value=o),h&&(h.textContent=`${o.length.toLocaleString()} chars`),toastr.info("System prompt reset to default")}));const b=t.querySelector(`#${e}_refinement_prompt`),E=t.querySelector(`#${e}_refinement_prompt_chars`),P=t.querySelector(`#${e}_reset_refinement_prompt`);null==b||b.addEventListener("input",(()=>{w("refinementPrompt",b.value),E&&(E.textContent=`${b.value.length.toLocaleString()} chars`)})),null==P||P.addEventListener("click",(()=>{w("refinementPrompt",c),b&&(b.value=c),E&&(E.textContent=`${c.length.toLocaleString()} chars`),toastr.info("Refinement prompt reset to default")})),t.addEventListener("click",(t=>{const n=t.target.closest(`.${e}_preset_delete`);if(n){const t=n.getAttribute("data-type"),r=n.getAttribute("data-id");t&&r&&function(t,n){const r="prompt"===t?function(t){var n;const{extensionSettings:r,saveSettingsDebounced:s}=SillyTavern.getContext(),i=r[e],a=i.promptPresets.findIndex((e=>e.id===t));if(-1===a)return null;if(i.promptPresets[a].isBuiltin)return v("error","Cannot delete builtin preset",{id:t}),null;i.promptPresets.splice(a,1);for(const e of["score","rewrite","analyze"])(null===(n=i.stageDefaults[e])||void 0===n?void 0:n.promptPresetId)===t&&(i.stageDefaults[e].promptPresetId=null);return s(),v("info","Prompt preset deleted",{id:t}),t}(n):function(t){var n;const{extensionSettings:r,saveSettingsDebounced:s}=SillyTavern.getContext(),i=r[e],a=i.schemaPresets.findIndex((e=>e.id===t));if(-1===a)return null;if(i.schemaPresets[a].isBuiltin)return v("error","Cannot delete builtin preset",{id:t}),null;i.schemaPresets.splice(a,1);for(const e of["score","rewrite","analyze"])(null===(n=i.stageDefaults[e])||void 0===n?void 0:n.schemaPresetId)===t&&(i.stageDefaults[e].schemaPresetId=null);return s(),v("info","Schema preset deleted",{id:t}),t}(n);r?(toastr.success("Preset deleted"),ut()):toastr.error("Cannot delete builtin preset")}(t,r)}}));const A=t.querySelector(`#${e}_export_presets`),k=t.querySelector(`#${e}_import_presets`);null==A||A.addEventListener("click",(()=>{const e=function(){const e=S(),t=e.promptPresets.filter((e=>!e.isBuiltin)),r=e.schemaPresets.filter((e=>!e.isBuiltin));return JSON.stringify({version:n,exportedAt:(new Date).toISOString(),promptPresets:t,schemaPresets:r},null,2)}();navigator.clipboard.writeText(e),toastr.success("Custom presets copied to clipboard")})),null==k||k.addEventListener("click",(()=>ot(this,void 0,void 0,(function*(){try{const e=function(e){const t=[];let n=0,r=0;try{const s=JSON.parse(e);if(s.promptPresets&&Array.isArray(s.promptPresets))for(const e of s.promptPresets)try{e.name&&e.prompt&&(O({name:e.name,prompt:e.prompt,stages:e.stages||[]}),n++)}catch(n){t.push(`Failed to import prompt "${e.name}": ${n}`)}if(s.schemaPresets&&Array.isArray(s.schemaPresets))for(const e of s.schemaPresets)try{e.name&&e.schema&&(T({name:e.name,schema:e.schema,stages:e.stages||[]}),r++)}catch(n){t.push(`Failed to import schema "${e.name}": ${n}`)}}catch(e){t.push(`Failed to parse JSON: ${e}`)}return v("info","Presets imported",{promptsImported:n,schemasImported:r,errors:t}),{prompts:n,schemas:r,errors:t}}(yield navigator.clipboard.readText());e.errors.length>0?toastr.error(e.errors.join("\n")):(toastr.success(`Imported ${e.prompts} prompts, ${e.schemas} schemas`),ut())}catch(e){toastr.error("Failed to read clipboard")}}))));const R=t.querySelector(`#${e}_debug_mode`),I=t.querySelector(`#${e}_view_logs`),L=t.querySelector(`#${e}_clear_logs`),j=t.querySelector(`#${e}_copy_debug_info`),N=t.querySelector(`#${e}_debug_log_viewer`);null==R||R.addEventListener("change",(()=>{x(R.checked),toastr.info("Debug mode "+(R.checked?"enabled":"disabled"))})),null==I||I.addEventListener("click",(()=>{null==N||N.classList.toggle("hidden"),(null==N?void 0:N.classList.contains("hidden"))||dt()})),null==L||L.addEventListener("click",(()=>{_.length=0,dt(),toastr.info("Debug logs cleared")})),null==j||j.addEventListener("click",(()=>{navigator.clipboard.writeText($()),toastr.success("Debug info copied to clipboard")}))}(),function(){const t=S();(function(t){const n=document.getElementById(`${e}_settings_modal`),r=null==n?void 0:n.querySelector(`#${e}_gen_source`);if(!r)return;r.innerHTML="";const s=document.getElementById("chat_completion_source");s&&Array.from(s.options).forEach((e=>{if(e.value){const t=document.createElement("option");t.value=e.value,t.textContent=e.textContent||e.value,r.appendChild(t)}}));0===r.options.length&&["openrouter","openai","claude","makersuite","mistralai","groq"].forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,r.appendChild(t)}));r.value=t})(t.generationConfig.source),pt(t.generationConfig.source,t.generationConfig.model)}(),v("info","Settings modal opened",null)}))}function lt(t){const n="prompt"===t?E():A();return 0===n.length?`<div class="${e}_preset_empty">No presets</div>`:n.map((n=>`\n    <div class="${e}_preset_item ${n.isBuiltin?"builtin":""}" data-id="${n.id}">\n      <span class="${e}_preset_name">\n        ${n.isBuiltin?'<i class="fa-solid fa-lock"></i>':""}\n        ${ft(n.name)}\n      </span>\n      ${n.isBuiltin?"":`\n        <button class="${e}_preset_delete" data-type="${t}" data-id="${n.id}" title="Delete">\n          <i class="fa-solid fa-trash"></i>\n        </button>\n      `}\n    </div>\n  `)).join("")}function ut(){const t=document.getElementById(`${e}_settings_modal`);if(!t)return;const n=t.querySelector(`#${e}_prompt_presets_list`),r=t.querySelector(`#${e}_schema_presets_list`);n&&(n.innerHTML=lt("prompt")),r&&(r.innerHTML=lt("schema"))}function dt(){const t=document.getElementById(`${e}_settings_modal`);if(!t)return;const n=t.querySelector(`#${e}_debug_log_list`),r=t.querySelector(`#${e}_debug_log_detail`);if(!n||!r)return;const s=[..._];n.innerHTML=s.length?s.map(((t,n)=>`\n        <div class="${e}_debug_log_entry" data-index="${n}">\n          ${function(e){const t=e.timestamp.toLocaleTimeString();return`${{request:"📤",response:"📥",error:"❌",info:"ℹ️",state:"🔄"}[e.type]} [${t}] ${e.label}`}(t)}\n        </div>\n      `)).join(""):`<div class="${e}_debug_log_empty">No logs</div>`,n.querySelectorAll(`.${e}_debug_log_entry`).forEach((e=>{e.addEventListener("click",(()=>{const t=parseInt(e.dataset.index||"0",10),n=s[t];n&&r&&(r.textContent=function(e){try{return null===e?"null":void 0===e?"undefined":"string"==typeof e?e:JSON.stringify(e,null,2)}catch(t){return String(e)}}(n.data))}))}))}function pt(t,n){const r=document.getElementById(`${e}_settings_modal`),s=null==r?void 0:r.querySelector(`#${e}_gen_model`);if(!s)return;s.innerHTML="";const i={openrouter:"model_openrouter_select",openai:"model_openai_select",claude:"model_claude_select",makersuite:"model_google_select",google:"model_google_select",mistralai:"model_mistralai_select",cohere:"model_cohere_select",perplexity:"model_perplexity_select",groq:"model_groq_select",ai21:"model_ai21_select",deepseek:"model_deepseek_select",custom:"model_custom_select"},a=i[t]?document.getElementById(i[t]):null;if(null==a?void 0:a.options.length)Array.from(a.options).forEach((e=>{if(e.value){const t=document.createElement("option");t.value=e.value,t.textContent=e.textContent||e.value,s.appendChild(t)}}));else{const e=document.createElement("option");e.value=n||"",e.textContent=n||`No models for ${t}`,s.appendChild(e)}n&&Array.from(s.options).some((e=>e.value===n))?s.value=n:s.options.length&&(s.value=s.options[0].value,C({model:s.options[0].value}))}function ft(e){const{DOMPurify:t}=SillyTavern.libs,n="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(n,{ALLOWED_TAGS:[]})}var mt=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};function gt(t){const n=t.name.replace(/[^a-zA-Z0-9_-]/g,"_"),r=t.avatar.replace(/[^a-zA-Z0-9_-]/g,"_");return`${e}_history_${r}_${n}`}function ht(e,t){return mt(this,void 0,void 0,(function*(){const{localforage:n}=SillyTavern.libs,r=gt(e);try{return yield n.setItem(r,{characterName:e.name,characterAvatar:e.avatar,history:t,savedAt:Date.now()}),v("info","Iteration history saved",{key:r,characterName:e.name,historyLength:t.length}),!0}catch(e){return y("Failed to save iteration history",{key:r,error:e}),!1}}))}var _t=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};let vt=null,yt=null;const $t=[];function bt(){const{eventSource:e,eventTypes:t}=SillyTavern.getContext(),n=()=>{v("info","API status changed",{isReady:ve()}),St()},r=()=>{v("info","Main API changed",null),St(),Mt()},s=e=>{var t,n,r;const s=null!==(n=null===(t=e.detail)||void 0===t?void 0:t.character)&&void 0!==n?n:e.character,i=void 0!==(null===(r=e.detail)||void 0===r?void 0:r.id)?parseInt(e.detail.id,10):e.id;v("info","Character edited externally",{id:i,name:null==s?void 0:s.name}),wt(i)},i=e=>{v("info","Character deleted",{id:e.id}),function(e){if(!vt)return;const t=vt.pipeline.characterIndex;if(null===t)return;if(t===e)Ct(),toastr.warning("Selected character was deleted");else if(t>e){const{characters:e}=SillyTavern.getContext(),n=e,r=t-1;r>=0&&r<n.length?(vt.pipeline=Object.assign(Object.assign({},vt.pipeline),{characterIndex:r,character:n[r]}),v("info","Character index adjusted after deletion",{oldIndex:t,newIndex:r})):Ct()}}(e.id)},a=()=>{v("info","OAI preset changed",null),vt&&Mt()},o=()=>{v("info","Chat completion source changed",null),St(),Mt()},c=()=>{v("info","Chat completion model changed",null),St(),Mt()};e.on(t.ONLINE_STATUS_CHANGED,n),e.on(t.MAIN_API_CHANGED,r),e.on(t.CHARACTER_EDITED,s),e.on(t.CHARACTER_DELETED,i),e.on(t.OAI_PRESET_CHANGED_AFTER,a),e.on(t.CHATCOMPLETION_SOURCE_CHANGED,o),e.on(t.CHATCOMPLETION_MODEL_CHANGED,c),$t.push((()=>e.removeListener(t.ONLINE_STATUS_CHANGED,n)),(()=>e.removeListener(t.MAIN_API_CHANGED,r)),(()=>e.removeListener(t.CHARACTER_EDITED,s)),(()=>e.removeListener(t.CHARACTER_DELETED,i)),(()=>e.removeListener(t.OAI_PRESET_CHANGED_AFTER,a)),(()=>e.removeListener(t.CHATCOMPLETION_SOURCE_CHANGED,o)),(()=>e.removeListener(t.CHATCOMPLETION_MODEL_CHANGED,c))),v("info","Event listeners subscribed",{count:$t.length})}function St(){if(!yt)return;const t=ye(),n=yt.querySelector(`.${e}_api_status`);if(n){n.className=`${e}_api_status ${t.isReady?"connected":"disconnected"}`;const r=n.querySelector("span");r&&(r.textContent=t.source)}It()}function wt(e){var t;if(!vt||null===vt.pipeline.characterIndex)return;const{characters:n}=SillyTavern.getContext(),r=n,s=vt.pipeline.characterIndex;if(void 0===e||e===s)if(s>=0&&s<r.length){const e=r[s];e.name===(null===(t=vt.pipeline.character)||void 0===t?void 0:t.name)?(vt.pipeline=Object.assign(Object.assign({},vt.pipeline),{character:e}),Rt(),Mt(),v("info","Character refreshed",{name:e.name})):Ct()}else Ct()}function Ct(){vt&&(v("info","Character invalidated, clearing selection",null),vt.pipeline=Q(vt.pipeline,null,null),vt.historyLoaded=!1,Tt(),toastr.info("Character selection cleared"))}let xt=null,Et=null;function Pt(){return _t(this,void 0,void 0,(function*(){const{Popup:t,POPUP_TYPE:n}=SillyTavern.getContext(),{DOMPurify:o}=SillyTavern.libs;vt={pipeline:Z(),isGenerating:!1,isRefining:!1,abortController:null,activeStageView:"score",historyLoaded:!1,debouncedFunctions:[]};const c=function(){const t=ye();return`\n    <div class="${e}_popup" id="${e}_popup">\n      \x3c!-- Header --\x3e\n      <div class="${e}_popup_header">\n        <div class="${e}_popup_title">\n          <i class="fa-solid fa-wand-magic-sparkles"></i>\n          <span>Character Tools</span>\n        </div>\n        <div class="${e}_popup_header_right">\n          <div class="${e}_api_status ${t.isReady?"connected":"disconnected"}">\n            <i class="fa-solid fa-circle"></i>\n            <span>${t.source}</span>\n          </div>\n          <button id="${e}_settings_btn" class="${e}_icon_btn" title="Settings">\n            <i class="fa-solid fa-gear"></i>\n          </button>\n          <button id="${e}_close_btn" class="${e}_icon_btn" title="Close">\n            <i class="fa-solid fa-xmark"></i>\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Character Section --\x3e\n      <div class="${e}_section" id="${e}_character_section">\n        <div class="${e}_section_header">\n          <i class="fa-solid fa-user"></i>\n          <span>Character</span>\n        </div>\n        <div id="${e}_character_select_container"></div>\n      </div>\n\n      \x3c!-- Pipeline Section --\x3e\n      <div class="${e}_section" id="${e}_pipeline_section">\n        <div class="${e}_section_header">\n          <i class="fa-solid fa-diagram-project"></i>\n          <span>Pipeline</span>\n        </div>\n        <div id="${e}_pipeline_nav_container"></div>\n      </div>\n\n      \x3c!-- Stage Config Section --\x3e\n      <div class="${e}_section" id="${e}_stage_section">\n        <div class="${e}_section_header">\n          <i class="fa-solid ${a.score}" id="${e}_stage_icon"></i>\n          <span id="${e}_stage_title">Score</span>\n        </div>\n        <div id="${e}_stage_config_container"></div>\n      </div>\n\n      \x3c!-- Results Section --\x3e\n      <div class="${e}_section ${e}_section_grow" id="${e}_results_section">\n        <div class="${e}_section_header">\n          <i class="fa-solid fa-file-lines"></i>\n          <span>Results</span>\n          <span id="${e}_iteration_indicator" class="${e}_iteration_indicator hidden"></span>\n        </div>\n        <div id="${e}_results_container"></div>\n        <div id="${e}_iteration_history_container"></div>\n      </div>\n    </div>\n  `}();new t(o.sanitize(c),n.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:!1,cancelButton:!1}).show().then((()=>{(null==vt?void 0:vt.abortController)&&vt.abortController.abort(),vt=null,yt=null,$t.forEach((e=>e())),$t.length=0,v("info","Event listeners unsubscribed",null),Et&&(document.removeEventListener("keydown",Et),Et=null),xt&&(document.removeEventListener("click",xt),xt=null),(null==vt?void 0:vt.debouncedFunctions)&&(vt.debouncedFunctions.forEach((e=>e.cancel())),vt.debouncedFunctions=[]),v("info","Popup closed",null)})),yield new Promise((e=>setTimeout(e,0))),yt=document.getElementById(`${e}_popup`),bt(),Et=e=>{vt&&("Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),vt.isGenerating||vt.isRefining||At(vt.activeStageView)),"Escape"===e.key&&(vt.isGenerating||vt.isRefining)&&vt.abortController&&vt.abortController.abort())},document.addEventListener("keydown",Et);const{characters:l}=SillyTavern.getContext(),u=l;!function(t){var n,a;if(!vt||!yt)return;const o=yt.querySelector(`#${e}_character_select_container`);o&&(o.innerHTML=function(t,n){const r=null!==n?t[n]:null;return`\n    <div class="${e}_char_select">\n      \x3c!-- Search --\x3e\n      <div class="${e}_search_wrapper ${r?"hidden":""}">\n        <div class="${e}_search_container">\n          <i class="fa-solid fa-search ${e}_search_icon"></i>\n          <input\n            type="text"\n            id="${e}_char_search"\n            class="text_pole ${e}_search_input"\n            placeholder="Search characters..."\n            autocomplete="off"\n          >\n        </div>\n        <div id="${e}_char_dropdown" class="${e}_dropdown hidden"></div>\n      </div>\n\n      \x3c!-- Selected Character Preview --\x3e\n      ${r?Ee(r):""}\n    </div>\n  `}(t,vt.pipeline.characterIndex),function(){if(!yt||!vt)return;const{Fuse:t,lodash:n}=SillyTavern.libs,r=yt.querySelector(`#${e}_character_select_container`);if(!r)return;const s=r.querySelector(`#${e}_char_search`),i=r.querySelector(`#${e}_char_dropdown`);if(!s||!i)return;let a=-1,o=[];const c=()=>{const{characters:n}=SillyTavern.getContext(),r=n.map(((e,t)=>({char:e,index:t}))).filter((({char:e})=>null==e?void 0:e.name)),c=new t(r,{keys:["char.name","char.description"],threshold:.4,includeScore:!0,minMatchCharLength:1}),l=s.value.trim();if(!l)return i.classList.add("hidden"),void(o=[]);const u=c.search(l,{limit:10});if(o=u.map((e=>e.item)),0===o.length)return i.innerHTML=`<div class="${e}_dropdown_empty">No characters found</div>`,void i.classList.remove("hidden");a=-1,Pe(o,i,-1),i.classList.remove("hidden")},l=n.debounce(c,150);vt.debouncedFunctions.push(l),s.addEventListener("input",l),s.addEventListener("keydown",(e=>{0!==o.length&&("ArrowDown"===e.key?(e.preventDefault(),a=Math.min(a+1,o.length-1),Pe(o,i,a)):"ArrowUp"===e.key?(e.preventDefault(),a=Math.max(a-1,0),Pe(o,i,a)):"Enter"===e.key&&a>=0?(e.preventDefault(),Ot(o[a].char,o[a].index),i.classList.add("hidden"),s.value=""):"Escape"===e.key&&(i.classList.add("hidden"),s.value=""))})),xt=e=>{s.contains(e.target)||i.contains(e.target)||i.classList.add("hidden")},document.addEventListener("click",xt),i.addEventListener("click",(t=>{const n=t.target.closest(`.${e}_dropdown_item`);if(n){const e=parseInt(n.getAttribute("data-index")||"-1",10),t=o.find((t=>t.index===e));t&&(Ot(t.char,t.index),i.classList.add("hidden"),s.value="")}})),r.addEventListener("click",(t=>{const n=t.target;if(n.closest(`#${e}_char_clear`)){if(!vt)return;return vt.pipeline=Q(vt.pipeline,null,null),vt.historyLoaded=!1,void Tt()}const s=n.closest(`.${e}_field_toggle`);if(s){const t=s.getAttribute("data-field"),n=r.querySelector(`#${e}_field_content_${t}`),i=s.querySelector("i");n&&i&&(n.classList.toggle("hidden"),i.classList.toggle("fa-chevron-right"),i.classList.toggle("fa-chevron-down"))}}))}());const c=yt.querySelector(`#${e}_pipeline_nav_container`);c&&(c.innerHTML=ke(vt.pipeline.selectedStages,vt.pipeline.stageStatus,vt.activeStageView,!!vt.pipeline.character),function(){if(!yt||!vt)return;const t=yt.querySelector(`#${e}_pipeline_nav_container`);if(!t)return;t.addEventListener("change",(t=>{const n=t.target;if(n.classList.contains(`${e}_stage_checkbox`)){const e=n.getAttribute("data-stage");e&&vt&&(vt.pipeline=function(e,t){const n=new Set(e.selectedStages);n.has(t)?n.delete(t):n.add(t);const r=s.filter((e=>n.has(e)));return v("state","Stage toggled",{stage:t,selected:r}),Object.assign(Object.assign({},e),{selectedStages:r})}(vt.pipeline,e),It())}})),t.addEventListener("click",(t=>_t(this,void 0,void 0,(function*(){const n=t.target.closest(`.${e}_stage_btn`);if(n&&vt){const e=n.getAttribute("data-stage");e&&(vt.activeStageView=e,Lt(),Nt(),Mt(),It())}t.target.closest(`#${e}_run_selected_btn`)&&kt();t.target.closest(`#${e}_run_all_btn`)&&function(){_t(this,void 0,void 0,(function*(){vt&&(vt.pipeline.selectedStages=[...s],It(),yield kt())}))}();if(t.target.closest(`#${e}_reset_pipeline_btn`)&&vt){const{Popup:e,POPUP_RESULT:t}=SillyTavern.getContext();if((yield e.show.confirm("Reset Pipeline?","This will clear all results and iteration history. Continue?"))!==t.AFFIRMATIVE)return;vt.pipeline=function(e,t=!1){const n=Z();return t&&e.character&&(n.character=e.character,n.characterIndex=e.characterIndex),v("state","Pipeline reset",{keepCharacter:t,hasCharacter:!!n.character}),n}(vt.pipeline,!0),vt.historyLoaded=!0,Tt()}}))))}());const l=yt.querySelector(`#${e}_stage_config_container`);l&&(l.innerHTML=function(t,n,r){var s,a,o,c;const l=E(t),u=A(t);let d=n.customPrompt;if(n.promptPresetId){const e=P(n.promptPresetId);e&&(d=e.prompt)}let p=n.customSchema;if(n.schemaPresetId){const e=k(n.schemaPresetId);e&&(p=JSON.stringify(e.schema,null,2))}let f="",m={valid:!0};n.useStructuredOutput&&p.trim()&&(m=H(p),f=m.valid?(null===(s=m.warnings)||void 0===s?void 0:s.length)?`<div class="${e}_schema_status warning"><i class="fa-solid fa-triangle-exclamation"></i> ${m.warnings.length} warning(s)</div>`:`<div class="${e}_schema_status success"><i class="fa-solid fa-circle-check"></i> Valid schema</div>`:`<div class="${e}_schema_status error"><i class="fa-solid fa-circle-xmark"></i> ${Ne(m.error||"Invalid schema")}</div>`);let g='<i class="fa-solid fa-microchip"></i> Select a character',h="";r&&(g=`<i class="fa-solid fa-microchip"></i> ~${r.tokens.toLocaleString()} tokens (${r.percentage}%)`,r.percentage>80?h="danger":r.percentage>50&&(h="warning"));const _=n.promptPresetId?(null===(a=P(n.promptPresetId))||void 0===a?void 0:a.prompt)!==d:d.trim().length>0,v=n.schemaPresetId?JSON.stringify(null===(o=k(n.schemaPresetId))||void 0===o?void 0:o.schema,null,2)!==p:p.trim().length>0,y=n.useStructuredOutput&&p.trim()&&((null===(c=m.warnings)||void 0===c?void 0:c.length)||!m.valid);return`\n    <div class="${e}_stage_config">\n      \x3c!-- Prompt Section --\x3e\n      <div class="${e}_config_group">\n        <div class="${e}_config_header">\n          <span class="${e}_config_label">Prompt</span>\n          <div class="${e}_config_header_actions">\n            <button\n              id="${e}_save_prompt_preset_btn"\n              class="${e}_icon_btn"\n              title="Save as Preset"\n              ${_?"":"disabled"}\n            >\n              <i class="fa-solid fa-floppy-disk"></i>\n            </button>\n            <select id="${e}_prompt_preset_select" class="${e}_preset_select">\n              <option value="">Custom</option>\n              ${je(l,n.promptPresetId)}\n            </select>\n          </div>\n        </div>\n        <textarea\n          id="${e}_custom_prompt"\n          class="${e}_prompt_textarea text_pole"\n          placeholder="Enter your prompt for the ${i[t]} stage..."\n        >${Ne(d)}</textarea>\n        <div class="${e}_config_footer">\n          <span class="${e}_char_count">${d.length.toLocaleString()} chars</span>\n        </div>\n      </div>\n\n      \x3c!-- Structured Output Toggle --\x3e\n      <div class="${e}_config_group">\n        <label class="${e}_checkbox_label">\n          <input\n            type="checkbox"\n            id="${e}_use_structured"\n            ${n.useStructuredOutput?"checked":""}\n          >\n          <span>Use Structured Output (JSON Schema)</span>\n        </label>\n      </div>\n\n      \x3c!-- Schema Section --\x3e\n      <div class="${e}_schema_section ${n.useStructuredOutput?"":"hidden"}">\n        <div class="${e}_config_header">\n          <span class="${e}_config_label">JSON Schema</span>\n          <div class="${e}_config_header_actions">\n            <button\n              id="${e}_save_schema_preset_btn"\n              class="${e}_icon_btn"\n              title="Save as Preset"\n              ${v&&p.trim()?"":"disabled"}\n            >\n              <i class="fa-solid fa-floppy-disk"></i>\n            </button>\n            <select id="${e}_schema_preset_select" class="${e}_preset_select">\n              <option value="">Custom</option>\n              ${je(u,n.schemaPresetId)}\n            </select>\n          </div>\n        </div>\n        <textarea\n          id="${e}_custom_schema"\n          class="${e}_schema_textarea text_pole"\n          placeholder='{"name": "MySchema", "value": {"type": "object", ...}}'\n        >${Ne(p)}</textarea>\n        ${f}\n\n        \x3c!-- Schema Actions --\x3e\n        <div class="${e}_schema_actions">\n          <button\n            id="${e}_generate_schema_btn"\n            class="menu_button menu_button_icon"\n            title="Generate schema from description"\n          >\n            <i class="fa-solid fa-wand-magic-sparkles"></i>\n            <span>Generate</span>\n          </button>\n          <button\n            id="${e}_validate_schema_btn"\n            class="menu_button menu_button_icon"\n            title="Validate schema"\n            ${p.trim()?"":"disabled"}\n          >\n            <i class="fa-solid fa-check-double"></i>\n            <span>Validate</span>\n          </button>\n          <button\n            id="${e}_fix_schema_btn"\n            class="menu_button menu_button_icon"\n            title="Auto-fix schema (adds additionalProperties: false, etc.)"\n            ${y?"":"disabled"}\n          >\n            <i class="fa-solid fa-wrench"></i>\n            <span>Auto-Fix</span>\n          </button>\n          <button\n            id="${e}_format_schema_btn"\n            class="menu_button menu_button_icon"\n            title="Format/prettify JSON"\n            ${p.trim()?"":"disabled"}\n          >\n            <i class="fa-solid fa-align-left"></i>\n            <span>Format</span>\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- Actions --\x3e\n      <div class="${e}_config_actions">\n        <div id="${e}_token_estimate" class="${e}_token_estimate ${h}">\n          ${g}\n        </div>\n      </div>\n    </div>\n  `}(vt.activeStageView,vt.pipeline.configs[vt.activeStageView],null),function(){if(!yt||!vt)return;const t=yt.querySelector(`#${e}_stage_config_container`);if(!t)return;t.addEventListener("change",(t=>{const n=t.target;if(n.id===`${e}_prompt_preset_select`&&vt){const e=n.value||null;vt.pipeline=re(vt.pipeline,vt.activeStageView,{promptPresetId:e}),jt(),Mt()}if(n.id===`${e}_schema_preset_select`&&vt){const e=n.value||null;vt.pipeline=re(vt.pipeline,vt.activeStageView,{schemaPresetId:e}),jt()}}));const{lodash:n}=SillyTavern.libs,r=n.debounce((t=>{const n=t.target;n.id===`${e}_custom_prompt`&&vt&&(vt.pipeline=re(vt.pipeline,vt.activeStageView,{customPrompt:n.value,promptPresetId:null}),Mt(),jt()),n.id===`${e}_custom_schema`&&vt&&(vt.pipeline=re(vt.pipeline,vt.activeStageView,{customSchema:n.value,schemaPresetId:null}),jt())}),300);vt.debouncedFunctions.push(r),t.addEventListener("input",r),t.addEventListener("change",(t=>{const n=t.target;n.id===`${e}_use_structured`&&vt&&(vt.pipeline=re(vt.pipeline,vt.activeStageView,{useStructuredOutput:n.checked}),jt())})),t.addEventListener("click",(t=>_t(this,void 0,void 0,(function*(){const n=t.target;if(n.closest(`#${e}_run_stage_btn`)&&vt)return void At(vt.activeStageView);if(n.closest(`#${e}_save_prompt_preset_btn`)&&vt){const t=null==yt?void 0:yt.querySelector(`#${e}_custom_prompt`);if(t){const e=yield function(e,t){return Te(this,void 0,void 0,(function*(){const{Popup:n,POPUP_RESULT:r}=SillyTavern.getContext();if(!t.trim())return toastr.warning("No prompt content to save"),{success:!1};const s=yield n.show.input("Save Prompt Preset","Enter a name for this preset:",`Custom ${i[e]} Prompt`);if(null===s||s===r.CANCELLED)return{success:!1};if(!s.trim())return toastr.warning("Preset name cannot be empty"),{success:!1};try{const n=O({name:s.trim(),prompt:t,stages:[e]});return toastr.success(`Prompt preset "${s}" saved`),{success:!0,presetId:n.id}}catch(e){return toastr.error(`Failed to save preset: ${e.message}`),{success:!1}}}))}(vt.activeStageView,t.value);e.success&&e.presetId&&(vt.pipeline=re(vt.pipeline,vt.activeStageView,{promptPresetId:e.presetId,customPrompt:""}),jt())}return}if(n.closest(`#${e}_save_schema_preset_btn`)&&vt){const t=null==yt?void 0:yt.querySelector(`#${e}_custom_schema`);if(t){const e=yield function(e,t){return Te(this,void 0,void 0,(function*(){const{Popup:n,POPUP_RESULT:r}=SillyTavern.getContext();if(!t.trim())return toastr.warning("No schema content to save"),{success:!1};const s=H(t);if(!s.valid)return toastr.error(`Invalid schema: ${s.error}`),{success:!1};const a=yield n.show.input("Save Schema Preset","Enter a name for this preset:",`Custom ${i[e]} Schema`);if(null===a||a===r.CANCELLED)return{success:!1};if(!a.trim())return toastr.warning("Preset name cannot be empty"),{success:!1};try{const t=T({name:a.trim(),schema:s.schema,stages:[e]});return toastr.success(`Schema preset "${a}" saved`),{success:!0,presetId:t.id}}catch(e){return toastr.error(`Failed to save preset: ${e.message}`),{success:!1}}}))}(vt.activeStageView,t.value);e.success&&e.presetId&&(vt.pipeline=re(vt.pipeline,vt.activeStageView,{schemaPresetId:e.presetId,customSchema:""}),jt())}return}if(n.closest(`#${e}_generate_schema_btn`)&&vt){const t=yield Re();if(t){const n=null==yt?void 0:yt.querySelector(`#${e}_custom_schema`);n&&(n.value=t,vt.pipeline=re(vt.pipeline,vt.activeStageView,{customSchema:t,schemaPresetId:null}),jt())}return}if(n.closest(`#${e}_validate_schema_btn`)&&vt){const t=null==yt?void 0:yt.querySelector(`#${e}_custom_schema`);return void(t&&(yield function(e){return Te(this,void 0,void 0,(function*(){var t,n;if(!e.trim())return void toastr.warning("No schema to validate");const r=H(e);if(!r.valid)return void toastr.error(`Invalid: ${r.error}`);const{Popup:s,POPUP_TYPE:i}=SillyTavern.getContext();if(null===(t=r.warnings)||void 0===t?void 0:t.length)if(r.warnings.length>2){const e=`\n                <h3>Schema Valid with Warnings</h3>\n                <ul>\n                    ${r.warnings.map((e=>`<li>${e}</li>`)).join("")}\n                </ul>\n            `;yield new s(e,i.TEXT,"",{wide:!1}).show()}else toastr.warning(`Valid with ${r.warnings.length} warning(s):\n${r.warnings.join("\n")}`);else if(null===(n=r.info)||void 0===n?void 0:n.length)if(r.info.length>2){const e=`\n                <h3>Schema Valid</h3>\n                <ul>\n                    ${r.info.map((e=>`<li>${e}</li>`)).join("")}\n                </ul>\n            `;yield new s(e,i.TEXT,"",{wide:!1}).show()}else toastr.success(`Valid!\n${r.info.join("\n")}`);else toastr.success("Schema is valid!")}))}(t.value)))}if(n.closest(`#${e}_fix_schema_btn`)&&vt){const t=null==yt?void 0:yt.querySelector(`#${e}_custom_schema`);if(t){const e=function(e){var t;if(!e.trim())return toastr.warning("No schema to fix"),null;const n=H(e);if(!n.schema)return toastr.error("Cannot fix: schema is not valid JSON or missing required structure"),null;try{const e=G(n.schema),r=JSON.stringify(e,null,2),s=H(r);return s.valid?(null===(t=s.warnings)||void 0===t?void 0:t.length)?toastr.info(`Fixed! ${s.warnings.length} warning(s) remain`):toastr.success("Schema fixed successfully!"):toastr.warning("Auto-fix applied but schema still has issues"),r}catch(e){return toastr.error(`Fix failed: ${e.message}`),null}}(t.value);e&&(t.value=e,vt.pipeline=re(vt.pipeline,vt.activeStageView,{customSchema:e,schemaPresetId:null}),jt())}return}if(n.closest(`#${e}_format_schema_btn`)&&vt){const t=null==yt?void 0:yt.querySelector(`#${e}_custom_schema`);if(t){const e=function(e){if(!e.trim())return toastr.warning("No schema to format"),null;try{const t=JSON.parse(e),n=JSON.stringify(t,null,2);return toastr.success("Schema formatted"),n}catch(e){return toastr.error(`Cannot format: ${e.message}`),null}}(t.value);e&&(t.value=e,vt.pipeline=re(vt.pipeline,vt.activeStageView,{customSchema:e,schemaPresetId:null}),jt())}}else;}))))}());const u=yt.querySelector(`#${e}_results_container`);u&&(u.innerHTML=(d=vt.activeStageView,p=vt.pipeline.results[vt.activeStageView],f=vt.pipeline.stageStatus[vt.activeStageView],vt.isGenerating&&"running"===f?Ke(d):p?Qe(d,p):Ze(d,f)),function(){if(!yt||!vt)return;const t=yt.querySelector(`#${e}_results_container`);if(!t)return;t.addEventListener("click",(t=>_t(this,void 0,void 0,(function*(){const n=t.target;if(n.closest(`#${e}_regenerate_btn`)&&vt&&(vt.pipeline=function(e,t){return v("state","Stage result cleared",{stage:t}),Object.assign(Object.assign({},e),{results:Object.assign(Object.assign({},e.results),{[t]:null}),stageStatus:Object.assign(Object.assign({},e.stageStatus),{[t]:"pending"})})}(vt.pipeline,vt.activeStageView),At(vt.activeStageView)),n.closest(`#${e}_lock_btn`)&&vt&&(vt.pipeline=function(e,t){const n=e.results[t];return n?(v("state","Stage locked",{stage:t}),Object.assign(Object.assign({},e),{results:Object.assign(Object.assign({},e.results),{[t]:Object.assign(Object.assign({},n),{locked:!0})})})):e}(vt.pipeline,vt.activeStageView),Nt()),n.closest(`#${e}_unlock_btn`)&&vt&&(vt.pipeline=function(e,t){const n=e.results[t];return n?(v("state","Stage unlocked",{stage:t}),Object.assign(Object.assign({},e),{results:Object.assign(Object.assign({},e.results),{[t]:Object.assign(Object.assign({},n),{locked:!1})})})):e}(vt.pipeline,vt.activeStageView),Nt()),n.closest(`#${e}_continue_btn`)&&vt){const e=le(vt.pipeline,vt.activeStageView);e&&(vt.activeStageView=e,Lt(),Nt(),Mt())}var s;if(n.closest(`#${e}_apply_btn`)&&vt&&(yield function(){return _t(this,void 0,void 0,(function*(){if(!vt||!vt.pipeline.results.rewrite||!vt.pipeline.character)return void toastr.warning("No rewrite to apply");const{Popup:t,POPUP_TYPE:n,POPUP_RESULT:s}=SillyTavern.getContext(),{DOMPurify:i}=SillyTavern.libs,a=oe(vt.pipeline.results.rewrite.response);let o=`<div class="${e}_apply_preview">`;if(o+=`<p><strong>Parse method:</strong> ${a.parseMethod}</p>`,0===a.fields.length)o+=`<p class="${e}_apply_warning">\n            <i class="fa-solid fa-triangle-exclamation"></i>\n            No recognized character fields found in the rewrite output.\n            The raw content will be copied to clipboard instead.\n        </p>`,o+=`<details><summary>Raw content preview</summary><pre>${i.sanitize(a.raw.substring(0,500))}...</pre></details>`;else{o+=`<p><strong>Fields to update (${a.fields.length}):</strong></p>`,o+="<ul>";for(const e of a.fields){const t=e.value.substring(0,100);o+=`<li><strong>${i.sanitize(e.label)}:</strong> ${i.sanitize(t)}${e.value.length>100?"...":""}</li>`}o+="</ul>"}o+="</div>";const c=new t(`\n        <h3>Apply Rewrite to Character?</h3>\n        <p>This will update <strong>${i.sanitize(vt.pipeline.character.name)}</strong> with the rewritten content.</p>\n        ${o}\n    `,n.CONFIRM,"",{wide:!0,okButton:a.fields.length>0?"Apply Changes":"Copy Raw Content",cancelButton:"Cancel"});if((yield c.show())!==s.AFFIRMATIVE)return;if(0===a.fields.length)return navigator.clipboard.writeText(a.raw),void toastr.info("Raw content copied to clipboard");const l=yield function(e,t){return K(this,void 0,void 0,(function*(){if(!e.character||null===e.characterIndex)return{success:!1,error:"No character selected",updatedFields:[]};const{characters:n,unshallowCharacter:s,getRequestHeaders:i}=SillyTavern.getContext();try{yield s(e.characterIndex);const a=n[e.characterIndex];if(!a)return{success:!1,error:"Character not found after unshallow",updatedFields:[]};const o={},c=[];for(const e of t)r.find((t=>t.key===e.key))&&e.value.trim()&&(o[e.key]=e.value.trim(),c.push(e.label));if(0===c.length)return{success:!1,error:"No valid fields to update",updatedFields:[]};Object.assign(a,o);const l=yield fetch("/api/characters/edit",{method:"POST",headers:i(),body:JSON.stringify(Object.assign({avatar_url:a.avatar},a))});if(!l.ok){const e=yield l.text();return y("Failed to save character",{status:l.status,error:e}),{success:!1,error:`Save failed: ${l.status}`,updatedFields:[]}}return v("info","Character updated successfully",{name:a.name,updatedFields:c}),{success:!0,updatedFields:c}}catch(e){return y("Error applying rewrite to character",e),{success:!1,error:e.message,updatedFields:[]}}}))}(vt.pipeline,a.fields);if(l.success){toastr.success(`Updated ${l.updatedFields.length} fields: ${l.updatedFields.join(", ")}`);const{eventSource:e}=SillyTavern.getContext();yield e.emit("character_tools_rewrite_applied",{characterName:vt.pipeline.character.name,characterIndex:vt.pipeline.characterIndex,updatedFields:l.updatedFields,iterationCount:vt.pipeline.iterationCount}),wt()}else toastr.error(l.error||"Failed to apply changes")}))}()),n.closest(`#${e}_refine_btn`)&&vt&&function(){_t(this,void 0,void 0,(function*(){if(!vt||vt.isGenerating||vt.isRefining)return;if(!ve())return void toastr.error("API is not connected");const t=ne(vt.pipeline);if(!t.canRun)return void toastr.warning(t.reason||"Cannot refine");const n=function(e){const t=[],n=[];e.character||t.push("No character selected"),e.results.rewrite||t.push("No rewrite to refine"),e.results.analyze||t.push("Run analyze first to identify issues");const{onlineStatus:r}=SillyTavern.getContext();"Valid"!==r&&"Connected"!==r&&t.push("API is not connected");const s=e.iterationHistory.length>0?e.iterationHistory[e.iterationHistory.length-1]:null;return"accept"===(null==s?void 0:s.verdict)&&n.push("Last analysis suggested accepting the rewrite"),e.iterationCount>=5&&n.push(`Already at iteration ${e.iterationCount+1} - consider accepting or starting fresh`),{valid:0===t.length,errors:t,warnings:n}}(vt.pipeline);if(!n.valid)return void toastr.error(n.errors.join("\n"));n.warnings.length>0&&toastr.warning(n.warnings.join("\n"));const r={iterationCount:vt.pipeline.iterationCount,iterationHistory:[...vt.pipeline.iterationHistory]};vt.pipeline=ae(vt.pipeline),vt.isRefining=!0,vt.abortController=new AbortController;const s=null==yt?void 0:yt.querySelector(`#${e}_results_container`);var i;s&&(s.innerHTML=(i=vt.pipeline.iterationCount,`\n    <div class="${e}_results_loading">\n      <i class="fa-solid fa-spinner fa-spin fa-2x"></i>\n      <p>Refining (Iteration #${i+1})...</p>\n      <button id="${e}_cancel_btn" class="menu_button">\n        <i class="fa-solid fa-stop"></i>\n        <span>Cancel</span>\n      </button>\n    </div>\n  `)),qt(),Dt();try{const e=yield function(e,t){return he(this,void 0,void 0,(function*(){const n=SillyTavern.getContext(),r=S();if(null==t?void 0:t.aborted)return{success:!1,error:"Generation cancelled"};if(!e.character)return{success:!1,error:"No character selected"};if(!e.results.rewrite||!e.results.analyze)return{success:!1,error:"Refinement requires both rewrite and analyze results"};if(!ve())return y("API not ready",{onlineStatus:n.onlineStatus}),{success:!1,error:"API is not connected. Check your connection settings."};const s=pe(e);if(!s)return{success:!1,error:"Failed to build refinement prompt"};const i=we(s,e.character.name,n.name1||"User");return v("info","Starting refinement generation",{iteration:e.iterationCount+1,character:e.character.name,promptLength:i.length}),yield be(r.systemPrompt,i,null,t,r.useCurrentSettings)}))}(vt.pipeline,vt.abortController.signal);e.success?(vt.pipeline=function(e,t){const n=Object.assign(Object.assign({},t),{timestamp:Date.now(),locked:!1});return v("state","Refinement completed",{iteration:e.iterationCount,responseLength:t.response.length}),Object.assign(Object.assign({},e),{currentStage:null,results:Object.assign(Object.assign({},e.results),{rewrite:n}),stageStatus:Object.assign(Object.assign({},e.stageStatus),{rewrite:"complete",analyze:"pending"})})}(vt.pipeline,{response:e.response,isStructured:!1,promptUsed:"[Refinement prompt]",schemaUsed:null}),toastr.success(`Refinement #${vt.pipeline.iterationCount} complete`),vt.pipeline.character&&(yield ht(vt.pipeline.character,vt.pipeline.iterationHistory)),vt.activeStageView="analyze"):(vt.pipeline=Object.assign(Object.assign({},vt.pipeline),{iterationCount:r.iterationCount,iterationHistory:r.iterationHistory}),"Generation cancelled"!==e.error&&toastr.error(e.error))}catch(e){vt.pipeline=Object.assign(Object.assign({},vt.pipeline),{iterationCount:r.iterationCount,iterationHistory:r.iterationHistory}),toastr.error(e.message)}finally{vt.isRefining=!1,vt.abortController=null,Tt()}}))}(),n.closest(`#${e}_accept_btn`)&&vt&&(vt.pipeline=(s=vt.pipeline).results.rewrite?(v("state","Rewrite accepted as final",{iteration:s.iterationCount}),Object.assign(Object.assign({},s),{results:Object.assign(Object.assign({},s.results),{rewrite:Object.assign(Object.assign({},s.results.rewrite),{locked:!0})}),isRefining:!1})):s,toastr.success("Rewrite accepted as final"),Tt()),n.closest(`#${e}_copy_btn`)&&vt){const e=vt.pipeline.results[vt.activeStageView];e&&(navigator.clipboard.writeText(e.response),toastr.success("Copied to clipboard"))}n.closest(`#${e}_export_btn`)&&vt&&(vt.pipeline=ge(vt.pipeline),vt.pipeline.exportData&&(navigator.clipboard.writeText(vt.pipeline.exportData),toastr.success("Export copied to clipboard"))),n.closest(`#${e}_cancel_btn`)&&(null==vt?void 0:vt.abortController)&&vt.abortController.abort()}))))}());var d,p,f;const m=yt.querySelector(`#${e}_iteration_history_container`);m&&(m.innerHTML=tt(vt.pipeline.iterationHistory,vt.pipeline.iterationCount,vt.historyLoaded),function(){if(!yt||!vt)return;const t=yt.querySelector(`#${e}_iteration_history_container`);if(!t)return;t.addEventListener("click",(t=>_t(this,void 0,void 0,(function*(){const n=t.target,r=n.closest(`.${e}_iteration_revert_btn`);if(r&&vt){const e=parseInt(r.getAttribute("data-index")||"-1",10);e>=0&&(yield function(e){return _t(this,void 0,void 0,(function*(){if(!vt)return;const{Popup:t,POPUP_RESULT:n}=SillyTavern.getContext();(yield t.show.confirm("Revert to Previous Iteration?",`This will restore the rewrite from iteration #${e+1} and discard later changes.`))===n.AFFIRMATIVE&&(vt.pipeline=function(e,t){if(t<0||t>=e.iterationHistory.length)return y("Invalid iteration index",{iterationIndex:t,historyLength:e.iterationHistory.length}),e;const n=e.iterationHistory[t];v("state","Reverting to iteration",{iteration:n.iteration});const r={response:n.rewriteResponse,isStructured:!1,promptUsed:"[Restored from iteration history]",schemaUsed:null,timestamp:Date.now(),locked:!1},s=e.iterationHistory.slice(0,t);return Object.assign(Object.assign({},e),{results:Object.assign(Object.assign({},e.results),{rewrite:r,analyze:null}),stageStatus:Object.assign(Object.assign({},e.stageStatus),{rewrite:"complete",analyze:"pending"}),iterationCount:n.iteration,iterationHistory:s,isRefining:!0})}(vt.pipeline,e),toastr.info(`Reverted to iteration #${e+1}`),vt.pipeline.character&&(yield ht(vt.pipeline.character,vt.pipeline.iterationHistory)),Tt())}))}(e))}const s=n.closest(`.${e}_iteration_view_btn`);if(s&&vt){const t=parseInt(s.getAttribute("data-index")||"-1",10);t>=0&&t<vt.pipeline.iterationHistory.length&&function(t){_t(this,void 0,void 0,(function*(){const{Popup:n,POPUP_TYPE:r}=SillyTavern.getContext(),{DOMPurify:s}=SillyTavern.libs,i=function(t){const{moment:n}=SillyTavern.libs;return`\n    <div class="${e}_iteration_view">\n      <div class="${e}_iteration_view_header">\n        <h3>Iteration #${t.iteration+1}</h3>\n        <span class="${e}_iteration_verdict ${st(t.verdict)}">\n          <i class="fa-solid ${rt(t.verdict)}"></i>\n          ${it(t.verdict)}\n        </span>\n        <span class="${e}_iteration_time">${n(t.timestamp).format("YYYY-MM-DD HH:mm:ss")}</span>\n      </div>\n\n      <div class="${e}_iteration_view_section">\n        <h4>Rewrite</h4>\n        <div class="${e}_iteration_view_content">\n          ${at(t.rewriteResponse)}\n        </div>\n      </div>\n\n      <div class="${e}_iteration_view_section">\n        <h4>Analysis</h4>\n        <div class="${e}_iteration_view_content">\n          ${at(t.analysisResponse)}\n        </div>\n      </div>\n    </div>\n  `}(t),a=new n(s.sanitize(i),r.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:"Close",cancelButton:!1});yield a.show()}))}(vt.pipeline.iterationHistory[t])}}))))}());null===(n=yt.querySelector(`#${e}_settings_btn`))||void 0===n||n.addEventListener("click",(()=>{ct((()=>{vt&&function(){if(!vt)return;for(const e of s){const t=vt.pipeline.configs[e];t.promptPresetId&&!P(t.promptPresetId)&&(v("info","Clearing deleted prompt preset reference",{stage:e,presetId:t.promptPresetId}),vt.pipeline=re(vt.pipeline,e,{promptPresetId:null})),t.schemaPresetId&&!k(t.schemaPresetId)&&(v("info","Clearing deleted schema preset reference",{stage:e,presetId:t.schemaPresetId}),vt.pipeline=re(vt.pipeline,e,{schemaPresetId:null}))}}(),Tt()}))})),null===(a=yt.querySelector(`#${e}_close_btn`))||void 0===a||a.addEventListener("click",(()=>{const e=null==yt?void 0:yt.closest(".popup");if(e){const t=e.querySelector(".popup-button-cancel, .popup-button-ok");null==t||t.click()}}))}(u),Tt(),v("info","Popup opened",{characterCount:u.length})}))}function Ot(t,n){return _t(this,void 0,void 0,(function*(){if(!vt)return;vt.pipeline=Q(vt.pipeline,t,n),vt.historyLoaded=!1,Tt();const r=yield function(e){return mt(this,void 0,void 0,(function*(){const{localforage:t}=SillyTavern.libs,n=gt(e);try{const r=yield t.getItem(n);return r?r.characterName!==e.name||r.characterAvatar!==e.avatar?(v("info","Iteration history key collision, ignoring",{key:n,storedName:r.characterName,currentName:e.name}),null):(v("info","Iteration history loaded",{key:n,characterName:e.name,historyLength:r.history.length,savedAt:new Date(r.savedAt).toISOString()}),r.history):(v("info","No iteration history found",{key:n}),null)}catch(e){return y("Failed to load iteration history",{key:n,error:e}),null}}))}(t);vt&&vt.pipeline.character===t&&(r&&r.length>0&&(vt.pipeline=Object.assign(Object.assign({},vt.pipeline),{iterationHistory:r,iterationCount:r.length}),v("info","Loaded iteration history",{count:r.length})),vt.historyLoaded=!0,Dt()),setTimeout((()=>_t(this,void 0,void 0,(function*(){if(!yt||!(null==vt?void 0:vt.pipeline.character))return;const t=yt.querySelector(`#${e}_character_select_container`);if(t){const n=Ae(vt.pipeline.character);yield function(t,n){return Ce(this,void 0,void 0,(function*(){const{getTokenCountAsync:r}=SillyTavern.getContext(),s=n.map((e=>Ce(this,void 0,void 0,(function*(){const t=function(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return`${t}_${e.length}`}(e.value);if(xe.has(t))return{field:e,tokens:xe.get(t)};try{const n=yield r(e.value);return xe.set(t,n),{field:e,tokens:n}}catch(t){return{field:e,tokens:null}}})))),i=yield Promise.all(s);let a=0;for(const{field:n,tokens:r}of i){const s=t.querySelector(`.${e}_field_tokens[data-field="${n.key}"]`);s&&(null!==r?(a+=r,s.textContent=`${r.toLocaleString()}t`):s.textContent="?")}const o=t.querySelector(`#${e}_total_tokens`);o&&(o.textContent=`${a.toLocaleString()} tokens`)}))}(t,n)}}))),50),v("info","Character selected",{name:t.name,index:n})}))}function At(e){return _t(this,void 0,void 0,(function*(){if(!vt||vt.isGenerating||vt.isRefining)return;if(!ve())return void toastr.error("API is not connected");const t=function(e,t){var n;if(!e.character)return{canRun:!1,reason:"No character selected"};switch(t){case"score":return{canRun:!0};case"rewrite":return e.selectedStages.includes("score")&&!(null===(n=e.results.score)||void 0===n?void 0:n.locked)?{canRun:!0,reason:"Score stage not complete - rewrite will run without score feedback"}:{canRun:!0};case"analyze":return e.results.rewrite?{canRun:!0}:{canRun:!1,reason:"Analyze requires rewrite results to compare"};default:return{canRun:!1,reason:"Unknown stage"}}}(vt.pipeline,e);if(!t.canRun)return void toastr.warning(t.reason||"Cannot run this stage");t.reason&&toastr.info(t.reason),vt.isGenerating=!0,vt.abortController=new AbortController,vt.pipeline=function(e,t){return v("state","Stage started",{stage:t}),Object.assign(Object.assign({},e),{currentStage:t,stageStatus:Object.assign(Object.assign({},e.stageStatus),{[t]:"running"})})}(vt.pipeline,e),Tt();const n=de(vt.pipeline,e)||"",r=me(vt.pipeline,e);try{const t=yield $e(vt.pipeline,e,vt.abortController.signal);t.success?(vt.pipeline=function(e,t,n){const r=Object.assign(Object.assign({},n),{timestamp:Date.now(),locked:!1});v("state","Stage completed",{stage:t,responseLength:n.response.length,isStructured:n.isStructured});const s="analyze"===t&&null!==e.results.rewrite;return Object.assign(Object.assign({},e),{currentStage:null,stageStatus:Object.assign(Object.assign({},e.stageStatus),{[t]:"complete"}),results:Object.assign(Object.assign({},e.results),{[t]:r}),isRefining:s})}(vt.pipeline,e,{response:t.response,isStructured:t.isStructured,promptUsed:n,schemaUsed:r}),toastr.success(`${i[e]} complete`)):(vt.pipeline=se(vt.pipeline,e,t.error),"Generation cancelled"!==t.error&&toastr.error(t.error))}catch(t){vt.pipeline=se(vt.pipeline,e,t.message),toastr.error(t.message)}finally{vt.isGenerating=!1,vt.abortController=null,Tt()}}))}function kt(){return _t(this,void 0,void 0,(function*(){if(!vt||vt.isGenerating||vt.isRefining)return;if(!ve())return void toastr.error("API is not connected");const e=function(e){const t=[],n=[];e.character||t.push("No character selected"),0===e.selectedStages.length&&t.push("No stages selected");for(const r of e.selectedStages)J(e.configs[r]).trim()||t.push(`${r}: No prompt configured`),"rewrite"===r&&!e.results.score&&e.selectedStages.includes("score")&&n.push("Rewrite will run without score feedback (score not complete)"),"analyze"!==r||e.results.rewrite||t.push("Analyze requires rewrite results");const{onlineStatus:r}=SillyTavern.getContext();return"Valid"!==r&&"Connected"!==r&&t.push("API is not connected"),{valid:0===t.length,errors:t,warnings:n}}(vt.pipeline);if(e.valid){e.warnings.length>0&&toastr.warning(e.warnings.join("\n"));for(const e of vt.pipeline.selectedStages){const t=vt.pipeline.stageStatus[e];if("complete"===t||"skipped"===t)continue;if(vt.activeStageView=e,Lt(),yield At(e),!vt)break;if("complete"!==vt.pipeline.stageStatus[e])break}}else toastr.error(e.errors.join("\n"))}))}function Tt(){Rt(),It(),Lt(),Nt(),Mt(),qt(),Dt()}function Rt(){if(!yt||!vt)return;const t=yt.querySelector(`#${e}_character_select_container`);t&&function(t,n,r){const s=t.querySelector(`.${e}_search_wrapper`),i=t.querySelector(`#${e}_char_preview`);if(n){if(null==s||s.classList.add("hidden"),!i){const r=Ee(n),s=t.querySelector(`.${e}_search_wrapper`);s&&s.insertAdjacentHTML("afterend",r)}}else{null==s||s.classList.remove("hidden"),null==i||i.remove();const n=t.querySelector(`#${e}_char_search`);n&&(n.value="")}}(t,vt.pipeline.character,vt.pipeline.characterIndex)}function It(){if(!yt||!vt)return;const t=yt.querySelector(`#${e}_pipeline_nav_container`);t&&function(t,n,r,i,a,o){for(const a of s){const s=t.querySelector(`#${e}_stage_cb_${a}`),o=t.querySelector(`.${e}_stage_btn[data-stage="${a}"]`),c=t.querySelector(`.${e}_stage_node:has([data-stage="${a}"])`);if(s&&(s.checked=n.includes(a)),o&&o.classList.toggle("active",a===i),c){c.classList.toggle("active",a===i);for(const t of["pending","running","complete","skipped"])c.classList.toggle(`${e}_stage_${t}`,r[a]===t)}const l=null==c?void 0:c.querySelector(`.${e}_stage_connector`);null==l||l.classList.toggle("active",n.includes(a))}const c=t.querySelector(`#${e}_run_selected_btn`),l=t.querySelector(`#${e}_run_all_btn`),u=t.querySelector(`#${e}_reset_pipeline_btn`);c&&(c.disabled=!a||o),l&&(l.disabled=!a||o),u&&(u.disabled=o)}(t,vt.pipeline.selectedStages,vt.pipeline.stageStatus,vt.activeStageView,!!vt.pipeline.character&&ve(),vt.isGenerating||vt.isRefining)}function Lt(){if(!yt||!vt)return;const t=yt.querySelector(`#${e}_stage_icon`),n=yt.querySelector(`#${e}_stage_title`);t&&(t.className=`fa-solid ${a[vt.activeStageView]}`),n&&(n.textContent=i[vt.activeStageView]),jt()}function jt(){if(!yt||!vt)return;const t=yt.querySelector(`#${e}_stage_config_container`);t&&Le(t,vt.activeStageView,vt.pipeline.configs[vt.activeStageView],vt.isGenerating||vt.isRefining)}function Nt(){if(!yt||!vt)return;const t=yt.querySelector(`#${e}_results_container`);t&&et(t,vt.activeStageView,vt.pipeline.results[vt.activeStageView],vt.pipeline.stageStatus[vt.activeStageView],vt.isGenerating,le(vt.pipeline,vt.activeStageView),vt.pipeline)}function qt(){if(!yt||!vt)return;const t=yt.querySelector(`#${e}_iteration_indicator`);t&&(vt.pipeline.iterationCount>0||vt.pipeline.isRefining?(t.classList.remove("hidden"),t.innerHTML=`\n      <i class="fa-solid fa-arrows-rotate"></i>\n      Iteration #${vt.pipeline.iterationCount+1}\n    `):t.classList.add("hidden"))}function Dt(){if(!yt||!vt)return;const t=yt.querySelector(`#${e}_iteration_history_container`);t&&function(t,n,r,s){const i=t.querySelector(`#${e}_iteration_history`);if(!i&&(n.length>0||r>0)){const e=tt(n,r,s);t.insertAdjacentHTML("beforeend",e)}else if(i){const t=i.querySelector(`.${e}_iteration_count`);t&&(t.textContent=r>0?`Current: #${r+1}`:"Initial");const a=i.querySelector(`.${e}_iteration_list`);a&&(s?0===n.length?a.innerHTML=`<div class="${e}_iteration_empty">No previous iterations</div>`:a.innerHTML=n.map(((e,t)=>nt(e,t))).join(""):a.innerHTML=`<div class="${e}_iteration_loading">\n                    <i class="fa-solid fa-spinner fa-spin"></i>\n                    <span>Loading history...</span>\n                </div>`)}}(t,vt.pipeline.iterationHistory,vt.pipeline.iterationCount,vt.historyLoaded)}function Mt(){return _t(this,void 0,void 0,(function*(){if(!yt||!vt)return;const t=yt.querySelector(`#${e}_token_estimate`);if(!t)return;if(!vt.pipeline.character)return t.innerHTML='<i class="fa-solid fa-microchip"></i> Select a character',void(t.className=`${e}_token_estimate`);let n;if(t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>',t.className=`${e}_token_estimate`,n=vt.pipeline.isRefining&&vt.pipeline.results.rewrite&&vt.pipeline.results.analyze?yield function(e){return he(this,void 0,void 0,(function*(){const{getTokenCountAsync:t,maxContext:n}=SillyTavern.getContext(),r=S();if(!e.character||!e.results.rewrite||!e.results.analyze)return null;try{const s=pe(e);if(!s)return null;const i=r.systemPrompt+"\n\n"+s,a=yield t(i);return{promptTokens:a,contextSize:n,percentage:Math.round(a/n*100)}}catch(e){return y("Refinement token count failed",e),null}}))}(vt.pipeline):yield function(e,t){return he(this,void 0,void 0,(function*(){const{getTokenCountAsync:n,maxContext:r}=SillyTavern.getContext(),s=S();if(!e.character)return null;try{const i=de(e,t);if(!i)return null;const a=s.systemPrompt+"\n\n"+i,o=yield n(a);return{promptTokens:o,contextSize:r,percentage:Math.round(o/r*100)}}catch(e){return y("Token count failed",e),null}}))}(vt.pipeline,vt.activeStageView),!vt||!yt)return;if(!n)return t.innerHTML='<i class="fa-solid fa-microchip"></i> --',void(t.className=`${e}_token_estimate`);let r="";n.percentage>100?r="danger":n.percentage>80&&(r="warning"),t.innerHTML=`<i class="fa-solid fa-microchip"></i> ${n.promptTokens.toLocaleString()}t (${n.percentage}%)`,t.className=`${e}_token_estimate ${r}`}))}var Ht=function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function o(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((r=r.apply(e,t||[])).next())}))};function Ft(){return Ht(this,void 0,void 0,(function*(){const{renderExtensionTemplateAsync:n}=SillyTavern.getContext(),r=document.getElementById("extensions_settings");if(r)try{const s=yield n(t,"templates/panel",{},!0),i=document.createElement("div");i.id=`${e}_wrapper`,i.innerHTML=s,r.appendChild(i),function(){const t=document.getElementById(`${e}_open_btn`);null==t||t.addEventListener("click",(()=>{Pt()}));const n=document.getElementById(`${e}_debug_toggle`);n&&(n.checked=S().debugMode,n.addEventListener("change",(()=>{x(n.checked),toastr.info("Debug mode "+(n.checked?"enabled":"disabled"))})))}(),v("info","Panel initialized",null)}catch(e){y("Failed to load panel template",e)}else y("Extensions container not found",null)}))}const{eventSource:zt,eventTypes:Vt}=SillyTavern.getContext();zt.on(Vt.APP_READY,(function(){try{v("info","Extension initializing",{version:"1.0.0"}),Ft(),function(){const{eventSource:e,eventTypes:t}=SillyTavern.getContext();e.on(t.CHATCOMPLETION_SOURCE_CHANGED,(()=>{v("info","Chat completion source changed",null)})),e.on(t.CHATCOMPLETION_MODEL_CHANGED,(()=>{v("info","Chat completion model changed",null)})),v("info","Event listeners registered",null)}(),v("info","Extension loaded",S())}catch(e){y("Extension initialization failed",e),toastr.error("Character Tools failed to initialize. Check console for details.")}}))})();