{"version":3,"file":"index.js","mappings":"mBAgBO,MAAM,EAAc,kBACdA,EAAiB,yCACjBC,EAAmB,EAMnBC,EAA8CC,OAAOC,OAAO,CACrE,CAAEC,IAAK,cAAeC,MAAO,cAAeC,WAAW,GACvD,CAAEF,IAAK,cAAeC,MAAO,cAAeC,WAAW,GACvD,CAAEF,IAAK,YAAaC,MAAO,gBAAiBC,WAAW,GACvD,CAAEF,IAAK,WAAYC,MAAO,WAAYC,WAAW,GACjD,CAAEF,IAAK,cAAeC,MAAO,mBAAoBC,WAAW,GAC5D,CAAEF,IAAK,gBAAiBC,MAAO,gBAAiBC,WAAW,GAC3D,CAAEF,IAAK,4BAA6BC,MAAO,4BAA6BC,WAAW,GACnF,CAAEF,IAAK,gBAAiBC,MAAO,gBAAiBC,WAAW,KAOlD,EAA+BJ,OAAOC,OAAO,CAAC,QAAS,UAAW,YAElEI,EAA0C,CACnDC,MAAO,QACPC,QAAS,UACTC,QAAS,WAGAC,EAAyC,CAClDH,MAAO,sBACPC,QAAS,eACTC,QAAS,6BAaAE,EAAwB,40BAgBxBC,EAA4B,u6BAmC5BC,EAAkDZ,OAAOC,OAAO,CACzE,CACIY,GAAI,wBACJC,KAAM,gBACNC,OAAQ,CAAC,SACTC,WAAW,EACXC,UAAW,EACXC,UAAW,EACXC,OAAQ,0mBAcZ,CACIN,GAAI,sBACJC,KAAM,cACNC,OAAQ,CAAC,SACTC,WAAW,EACXC,UAAW,EACXC,UAAW,EACXC,OAAQ,+LASZ,CACIN,GAAI,0BACJC,KAAM,kBACNC,OAAQ,CAAC,WACTC,WAAW,EACXC,UAAW,EACXC,UAAW,EACXC,OAAQ,iqBAcZ,CACIN,GAAI,+BACJC,KAAM,uBACNC,OAAQ,CAAC,WACTC,WAAW,EACXC,UAAW,EACXC,UAAW,EACXC,OAAQ,scAaZ,CACIN,GAAI,4BACJC,KAAM,oBACNC,OAAQ,CAAC,WACTC,WAAW,EACXC,UAAW,EACXC,UAAW,EACXC,OAAQ,qcAaZ,CACIN,GAAI,0BACJC,KAAM,kBACNC,OAAQ,CAAC,WACTC,WAAW,EACXC,UAAW,EACXC,UAAW,EACXC,OAAQ,mjCAqCZ,CACIN,GAAI,4BACJC,KAAM,oBACNC,OAAQ,CAAC,WACTC,WAAW,EACXC,UAAW,EACXC,UAAW,EACXC,OAAQ,wrCAyCZ,CACIN,GAAI,wBACJC,KAAM,gBACNC,OAAQ,CAAC,WACTC,WAAW,EACXC,UAAW,EACXC,UAAW,EACXC,OAAQ,oPAWZ,CACIN,GAAI,mBACJC,KAAM,WACNC,OAAQ,GACRC,WAAW,EACXC,UAAW,EACXC,UAAW,EACXC,OAAQ,2CAwGHC,EAAkDpB,OAAOC,OAAO,CACzE,CACIY,GAAI,uBACJC,KAAM,gBACNC,OAAQ,CAAC,SACTC,WAAW,EACXC,UAAW,EACXC,UAAW,EACXG,OAxGqC,CACzCP,KAAM,iBACNQ,QAAQ,EACRC,MAAO,CACHC,QAAS,0CACTC,KAAM,SACNC,sBAAsB,EACtBC,WAAY,CACRC,YAAa,CACTH,KAAM,QACNI,MAAO,CACHJ,KAAM,SACNC,sBAAsB,EACtBC,WAAY,CACRG,MAAO,CAAEL,KAAM,UACfnB,MAAO,CAAEmB,KAAM,UACfM,UAAW,CAAEN,KAAM,UACnBO,WAAY,CAAEP,KAAM,UACpBQ,YAAa,CAAER,KAAM,WAEzBS,SAAU,CAAC,QAAS,QAAS,YAAa,aAAc,iBAGhEC,aAAc,CAAEV,KAAM,UACtBW,qBAAsB,CAClBX,KAAM,QACNI,MAAO,CAAEJ,KAAM,WAEnBY,QAAS,CAAEZ,KAAM,WAErBS,SAAU,CAAC,cAAe,eAAgB,uBAAwB,cA4EtE,CACIrB,GAAI,6BACJC,KAAM,cACNC,OAAQ,CAAC,SACTC,WAAW,EACXC,UAAW,EACXC,UAAW,EACXG,OA/E2C,CAC/CP,KAAM,aACNQ,QAAQ,EACRC,MAAO,CACHC,QAAS,0CACTC,KAAM,SACNC,sBAAsB,EACtBC,WAAY,CACRQ,aAAc,CAAEV,KAAM,UACtBM,UAAW,CACPN,KAAM,QACNI,MAAO,CAAEJ,KAAM,WAEnBO,WAAY,CACRP,KAAM,QACNI,MAAO,CAAEJ,KAAM,WAEnBY,QAAS,CAAEZ,KAAM,WAErBS,SAAU,CAAC,eAAgB,YAAa,aAAc,cA8D1D,CACIrB,GAAI,yBACJC,KAAM,kBACNC,OAAQ,CAAC,WACTC,WAAW,EACXC,UAAW,EACXC,UAAW,EACXG,OAjEuC,CAC3CP,KAAM,oBACNQ,QAAQ,EACRC,MAAO,CACHC,QAAS,0CACTC,KAAM,SACNC,sBAAsB,EACtBC,WAAY,CACRW,UAAW,CACPb,KAAM,QACNI,MAAO,CAAEJ,KAAM,WAEnBc,KAAM,CACFd,KAAM,QACNI,MAAO,CAAEJ,KAAM,WAEnBe,OAAQ,CACJf,KAAM,QACNI,MAAO,CAAEJ,KAAM,WAEnBgB,sBAAuB,CAAEhB,KAAM,UAC/BiB,eAAgB,CAAEjB,KAAM,UACxBkB,QAAS,CACLlB,KAAM,SACNmB,KAAM,CAAC,SAAU,mBAAoB,eAEzCC,gBAAiB,CACbpB,KAAM,QACNI,MAAO,CAAEJ,KAAM,WAEnBqB,gBAAiB,CACbrB,KAAM,QACNI,MAAO,CAAEJ,KAAM,YAGvBS,SAAU,CAAC,YAAa,OAAQ,SAAU,wBAAyB,iBAAkB,UAAW,kBAAmB,wBAsC9G,EAA2D,CACpE5B,MAAO,CACHyC,eAAgB,wBAChBC,aAAc,GACdC,eAAgB,uBAChBC,aAAc,GACdC,qBAAqB,GAEzB5C,QAAS,CACLwC,eAAgB,0BAChBC,aAAc,GACdC,eAAgB,KAChBC,aAAc,GACdC,qBAAqB,GAEzB3C,QAAS,CACLuC,eAAgB,0BAChBC,aAAc,GACdC,eAAgB,yBAChBC,aAAc,GACdC,qBAAqB,IAQhBC,EAA8C,CACvDC,OAAQ,aACRC,MAAO,4BACPC,YAAa,EACbC,UAAW,KACXC,iBAAkB,EAClBC,gBAAiB,EACjBC,KAAM,GAOGC,EAA6B5D,OAAOC,OAAO,CACpD4D,oBAAoB,EACpBC,iBAAkBV,EAClBW,aAAcrD,EACdsD,cAAe,IAAIpD,GACnBqD,cAAe,IAAI7C,GACnB8C,cAAe,EACfC,iBAAkBxD,EAClByD,WAAW,EACXC,gBAAiBvE,IAgCRwE,EAAwB,CACjCC,mBAAoB,yBACpBC,cAAe,oBACfC,gBAAiB,sBACjBC,gBAAiB,sBACjBC,iBAAkB,uBAClBC,iBAAkB,uBAClBC,eAAgB,gBAChBC,UAAW,iBAkBFC,EAAwB,IACxBC,EAAwB,GCtjBrC,MAAMC,EAA8B,GAqB7B,SAAS,EAASxD,EAAoBtB,EAAe+E,GACxD,MAAMC,EAAuB,CACzBC,UAAW,IAAIC,KACf5D,OACAtB,QACA+E,QAUJ,GANAD,EAAWK,QAAQH,GACfF,EAAWM,OAASR,GACpBE,EAAWO,MAIF,UAAT/D,GAMJ,GAjCG,WACH,IACI,OAAO,IAAc2C,SACzB,CAAE,SAEE,OAAO,CACX,CACJ,CA0BQqB,GAAe,CACf,MAAMC,EAAS,IAAI,KAAejE,EAAKkE,iBACvC,OAAQlE,GACJ,IAAK,UACL,IAAK,WACDmE,QAAQC,MAAMH,EAAQvF,EAAO+E,GAC7B,MAGJ,QACIU,QAAQE,IAAIJ,EAAQvF,EAAO+E,GAEvC,OAjBIU,QAAQG,MAAM,IAAI,WAAsB5F,EAAO+E,EAkBvD,CAMO,SAAS,EAAS/E,EAAe+E,GACpC,EAAS,QAAS/E,EAAO+E,EAC7B,CAkHO,SAASc,IACZ,OAAOC,KAAKC,UA/CT,W,sBACH,MAAMC,EAAUC,YAAYC,aAE5B,IAAIC,EACJ,IACIA,EAAW,GACf,CAAE,SACEA,EAAW,CAAEP,MAAO,0BACxB,CAEA,MAAO,CACHQ,UAAW,CACPD,SAAU,CACNzC,mBAAoByC,EAASzC,mBAC7BO,UAAWkC,EAASlC,UACpBN,iBAAkBwC,EAASxC,iBAC3B0C,oBAAyC,QAArB,EAAAF,EAASvC,oBAAY,eAAEwB,SAAU,EACrDkB,mBAAyC,QAAtB,EAAAH,EAAStC,qBAAa,eAAEuB,SAAU,EACrDmB,mBAAyC,QAAtB,EAAAJ,EAASrC,qBAAa,eAAEsB,SAAU,IAG7DoB,YAAa,CACTC,QAAST,EAAQS,QACjBC,aAAcV,EAAQU,aACtBC,qBAAoD,QAA9B,EAAAX,EAAQY,8BAAsB,eAAEC,uBACtDC,cAA4C,QAA9B,EAAAd,EAAQY,8BAAsB,eAAEG,oBACR,QAA9B,EAAAf,EAAQY,8BAAsB,eAAEI,qBACxCC,WAAYjB,EAAQiB,WACpBC,eAA0C,QAA1B,EAAkB,QAAlB,EAAAlB,EAAQmB,kBAAU,eAAE/B,cAAM,QAAI,EAC9CgC,iBAA6B,QAAZ,EAAApB,EAAQqB,YAAI,eAAEjC,SAEnCkC,KAAM,CACFC,MAAOzC,EAAWM,OAClBoC,OAAQ1C,EAAW2C,QAAOC,GAAgB,UAAXA,EAAEpG,OAAkB8D,OACnDuC,OAAQ7C,EAAW8C,MAAM,EAAG,IAAIC,KAAIH,IAAK,CACrCpG,KAAMoG,EAAEpG,KACRtB,MAAO0H,EAAE1H,MACT8H,KAAMJ,EAAEzC,UAAU8C,mBAIlC,CAM0BC,GAAoB,KAAM,EACpD,CCjKA,MAAMC,EAA0C,CAE5C,EAAI9B,IAEA,MAAM+B,EAAc/B,OACWgC,IAA3BD,EAAYE,aACZjC,EAASzC,oBAAsBwE,EAAYE,kBACpCF,EAAYE,iBAIQD,IAA3BD,EAAYG,mBACLH,EAAYG,gBAIiBF,IAApCD,EAAYlF,sBACPmD,EAASpC,gBACVoC,EAASpC,cAAgBuE,gBAAgB,IAE7CnC,EAASpC,cAAe5D,MAAM6C,sBAAwBkF,EAAYlF,2BAC3DkF,EAAYlF,oBACvB,EAIJ,EAAImD,IACKA,EAASnC,mBACVmC,EAASnC,iBAAmBxD,EAChC,GA8BD,SAAS,IACZ,MAAM,kBAAE+H,EAAiB,sBAAEC,GAA0BvC,YAAYC,cAC3D,OAAEuC,GAAWxC,YAAYyC,KAE/B,IAAKH,EAAkB,GAInB,OAHA,EAAS,OAAQ,sCAAuC,MACxDA,EAAkB,GAAeD,gBAAgB7E,GACjD+E,IACOD,EAAkB,GAG7B,MAAMI,EAAWJ,EAAkB,GAC7BK,EAAaD,EAASzE,iBAAmB,EAC/C,IAAI2E,GAAY,EAGZD,EAAajJ,IACbkJ,EAxCR,SAAuB1C,EAA6ByC,GAChD,IAAIE,GAAW,EAEf,IAAK,IAAIC,EAAIH,EAAa,EAAGG,GAAKpJ,EAAkBoJ,IAAK,CACrD,MAAMC,EAAYf,EAAWc,GACzBC,IACA,EAAS,OAAQ,yBAAyBD,IAAK,MAC/CC,EAAU7C,GACV2C,GAAW,EAEnB,CAEA,OAAOA,CACX,CA2BoBG,CAAcN,EAAUC,GACpCD,EAASzE,gBAAkBvE,GAK/B,MAAMuJ,EAAST,EAAOU,MAClBb,gBAAgB7E,GAChBkF,GAIES,EAgBV,SAA8BjD,GAC1B,IAAIkD,GAAW,EAGf,MAAMC,EAAoB,IAAIC,IAAIpD,EAAStC,cAAcgE,KAAI2B,GAAKA,EAAE9I,MACpE,IAAK,MAAM+I,KAAWhJ,EACb6I,EAAkBI,IAAID,EAAQ/I,MAC/ByF,EAAStC,cAAc8F,KAAKrB,gBAAgBmB,IAC5CJ,GAAW,GAKnB,MAAMO,EAAoB,IAAIL,IAAIpD,EAASrC,cAAc+D,KAAI2B,GAAKA,EAAE9I,MACpE,IAAK,MAAM+I,KAAWxI,EACb2I,EAAkBF,IAAID,EAAQ/I,MAC/ByF,EAASrC,cAAc6F,KAAKrB,gBAAgBmB,IAC5CJ,GAAW,GAInB,OAAOA,CACX,CAtC0BQ,CAAqBX,GAU3C,OATAL,EAAYA,GAAaO,EAGzBb,EAAkB,GAAeW,EAE7BL,GACAL,IAGGU,CACX,CAoCO,SAASY,EAAwC/J,EAAQqB,GAC5D,MAAM,kBAAEmH,EAAiB,sBAAEC,GAA0BvC,YAAYC,aAChDqC,EAAkB,GAC1BxI,GAAOqB,EAChBoH,IACA,EAAS,OAAQ,kBAAmB,CAAEzI,MAAKqB,MAAwB,iBAAVA,EAAqB,WAAaA,GAC/F,CAKO,SAAS2I,EAAuBC,GACnC,MAAM,kBAAEzB,EAAiB,sBAAEC,GAA0BvC,YAAYC,aAC3DC,EAAWoC,EAAkB,GAE9BpC,EAASxC,mBACVwC,EAASxC,iBAAmB2E,gBAAgBrF,IAGhDkD,EAASxC,iBAAmB,OAAH,wBAAQwC,EAASxC,kBAAqBqG,GAC/DxB,IACA,EAAS,OAAQ,4BAA6BwB,EAClD,CAqEO,SAASC,EAAaC,GACzBJ,EAAc,YAAaI,EAC/B,CASO,SAAS,EAAiBC,GAC7B,MAAMhE,EAAW,IAEjB,OAAKgE,EAIEhE,EAAStC,cAAc4D,QAAO+B,GACb,IAApBA,EAAE5I,OAAOwE,QAAgBoE,EAAE5I,OAAOwJ,SAASD,KAJpChE,EAAStC,aAMxB,CAKO,SAAS,EAAgBnD,GAE5B,OADiB,IACDmD,cAAcwG,MAAKb,GAAKA,EAAE9I,KAAOA,KAAO,IAC5D,CAKO,SAAS4J,EAAiBC,GAC7B,MAAM,kBAAEhC,EAAiB,sBAAEC,GAA0BvC,YAAYC,aAC3DC,EAAWoC,EAAkB,IAC7B,OAAEiC,GAAWvE,YAAYC,aAEzBuE,EAAMvF,KAAKuF,MACXC,EAAS,+BACRH,GAAM,CACT7J,GAAI,iBAAiB8J,MACrB3J,WAAW,EACXC,UAAW2J,EACX1J,UAAW0J,IAOf,OAJAtE,EAAStC,cAAc8F,KAAKe,GAC5BlC,IACA,EAAS,OAAQ,sBAAuB,CAAE9H,GAAIgK,EAAUhK,GAAIC,KAAM+J,EAAU/J,OAErE+J,CACX,CA+DO,SAAS,EAAiBP,GAC7B,MAAMhE,EAAW,IAEjB,OAAKgE,EAIEhE,EAASrC,cAAc2D,QAAO+B,GACb,IAApBA,EAAE5I,OAAOwE,QAAgBoE,EAAE5I,OAAOwJ,SAASD,KAJpChE,EAASrC,aAMxB,CAKO,SAAS,EAAgBpD,GAE5B,OADiB,IACDoD,cAAcuG,MAAKb,GAAKA,EAAE9I,KAAOA,KAAO,IAC5D,CAKO,SAASiK,EAAiBJ,GAC7B,MAAM,kBAAEhC,EAAiB,sBAAEC,GAA0BvC,YAAYC,aAC3DC,EAAWoC,EAAkB,IAC7B,OAAEiC,GAAWvE,YAAYC,aAGzB0E,EAAcC,EAAoCN,EAAOrJ,QAEzDuJ,EAAMvF,KAAKuF,MACXC,EAAS,+BACRH,GAAM,CACTrJ,OAAQ0J,EACRlK,GAAI,iBAAiB8J,MACrB3J,WAAW,EACXC,UAAW2J,EACX1J,UAAW0J,IAOf,OAJAtE,EAASrC,cAAc6F,KAAKe,GAC5BlC,IACA,EAAS,OAAQ,sBAAuB,CAAE9H,GAAIgK,EAAUhK,GAAIC,KAAM+J,EAAU/J,OAErE+J,CACX,CAwEA,SAASG,EAAoC3J,GACzC,MAAM4J,EAAQxC,gBAAgBpH,GAE9B,OADA6J,EAA8BD,EAAM1J,OAC7B0J,CACX,CAEA,SAASC,EAA8BC,GACnC,GAAkB,WAAdA,EAAK1J,OACL0J,EAAKzJ,sBAAuB,EAExByJ,EAAKxJ,YAAyC,iBAApBwJ,EAAKxJ,YAC/B,IAAK,MAAMyJ,KAAQpL,OAAOqL,OAAOF,EAAKxJ,YAC9ByJ,GAAwB,iBAATA,GACfF,EAA8BE,GAmC9C,GA7BkB,UAAdD,EAAK1J,MAAoB0J,EAAKtJ,OAA+B,iBAAfsJ,EAAKtJ,QAC9CyJ,MAAMC,QAAQJ,EAAKtJ,OAGpBsJ,EAAKtJ,MAAM2J,SAAQC,IACXA,GAAwB,iBAATA,GACfP,EAA8BO,EAClC,IALJP,EAA8BC,EAAKtJ,QAUvCsJ,EAAKO,OAASJ,MAAMC,QAAQJ,EAAKO,QACjCP,EAAKO,MAAMF,SAAQG,IACXA,GAA8B,iBAAZA,GAClBT,EAA8BS,EAClC,IAIJR,EAAKS,OAASN,MAAMC,QAAQJ,EAAKS,QACjCT,EAAKS,MAAMJ,SAAQG,IACXA,GAA8B,iBAAZA,GAClBT,EAA8BS,EAClC,IAKJR,EAAKU,OAA+B,iBAAfV,EAAKU,MAC1B,IAAK,MAAMC,KAAO9L,OAAOqL,OAAOF,EAAKU,OAC7BC,GAAsB,iBAARA,GACdZ,EAA8BY,GAK1C,GAAIX,EAAKY,aAA2C,iBAArBZ,EAAKY,YAChC,IAAK,MAAMD,KAAO9L,OAAOqL,OAAOF,EAAKY,aAC7BD,GAAsB,iBAARA,GACdZ,EAA8BY,EAI9C,C,0SCjiBA,MAAME,EAAmB,CACrBC,mBAAoB,EACpBC,SAAU,IACVC,kBAAmB,GACnBC,0BAA2B,IAC3BC,gBAAiB,IACjBC,yBAA0B,CACtB,YAAa,OAAQ,OAAQ,WAC7B,QAAS,WAAY,MAAO,OAAQ,OAAQ,QAEhDC,uBAAwB,CAAC,EAAG,IAI1BC,EAAsB,CACxBC,QAAS,CAAC,UAAW,UAAW,mBAAoB,mBAAoB,cACxEC,OAAQ,CAAC,YAAa,aACtBC,MAAO,CAAC,WAAY,cAAe,WAAY,cAAe,eAC9DC,OAAQ,CAAC,gBAAiB,gBAAiB,gBAAiB,sBAI1DC,EAAuB,CACzB,KAAM,OAAQ,OACd,MACA,QACA,oBACA,mBACA,wBACA,mBACA,cACA,kBAIEC,EAA6B,CAC/B,CAAEC,QAAS,YAAajM,KAAM,mCAC9B,CAAEiM,QAAS,UAAWjM,KAAM,kBAC5B,CAAEiM,QAAS,SAAUjM,KAAM,oBAyBzBkM,EAA2B,gqBAqF1B,SAAS,EAAeC,G,MAE3B,IAAKA,EAAMC,OACP,MAAO,CAAEC,OAAO,EAAM9L,YAAQiH,GAIlC,IAAI8E,EACJ,IACIA,EAASnH,KAAKoH,MAAMJ,EACxB,CAAE,MAAOpF,GACL,MAAM9B,EAAQ8B,aAAayF,MAAQzF,EAAE0F,QAAU,eAEzCC,EAAQzH,EAAMyH,MAAM,kBAE1B,MAAO,CAAEL,OAAO,EAAOpH,MAAO,oBADbyH,EAAQ,eAAeA,EAAM,MAAQ,OACSzH,IACnE,CAGA,GAAsB,iBAAXqH,GAAkC,OAAXA,GAAmB9B,MAAMC,QAAQ6B,GAC/D,MAAO,CAAED,OAAO,EAAOpH,MAAO,sCAAwCuF,MAAMC,QAAQ6B,GAAU,eAAiBA,IAGnH,MAAMK,EAAML,EAKZ,GAAwB,iBAAbK,EAAI3M,KACX,MAAO,CAAEqM,OAAO,EAAOpH,MAAO,6CAElC,IAAK0H,EAAI3M,KAAKoM,OACV,MAAO,CAAEC,OAAO,EAAOpH,MAAO,0BAElC,IAAK,2BAA2B2H,KAAKD,EAAI3M,MACrC,MAAO,CAAEqM,OAAO,EAAOpH,MAAO,2CAA2C0H,EAAI3M,+EAIjF,GAAyB,iBAAd2M,EAAIlM,OAAoC,OAAdkM,EAAIlM,OAAkB+J,MAAMC,QAAQkC,EAAIlM,OACzE,MAAO,CAAE4L,OAAO,EAAOpH,MAAO,wDAGlC,MAAMxE,EAAQkM,EAAIlM,MAElB,GAA0B,iBAAfA,EAAME,OAAsBF,EAAMmK,QAAUnK,EAAMqK,QAAUrK,EAAMoM,KACzE,MAAO,CAAER,OAAO,EAAOpH,MAAO,2DAIlC,QAAmBuC,IAAfmF,EAAInM,QAA8C,kBAAfmM,EAAInM,OACvC,MAAO,CAAE6L,OAAO,EAAOpH,MAAO,0CAKlC,MAAM6H,EAAyB,CAC3BjG,OAAQ,GACRkG,SAAU,GACVC,KAAM,GACNC,MAAO,CACHC,SAAU,EACVC,WAAY,EACZC,mBAAoB,EACpBC,SAAU,EACVC,cAAe,EACfC,mBAAoB,EACpBC,UAAW,GAEfC,aAAc,EACdC,SAAU,IAAI9E,IACd+E,KAAM,CAAC,GAoBX,GAhBIlN,EAAMsK,OAAgC,iBAAhBtK,EAAMsK,OAC5B+B,EAAIa,KAAOlN,EAAMsK,MACjB+B,EAAIG,MAAMC,SAAWhO,OAAO0O,KAAKd,EAAIa,MAAMlJ,QACpChE,EAAMwK,aAA4C,iBAAtBxK,EAAMwK,cACzC6B,EAAIa,KAAOlN,EAAMwK,YACjB6B,EAAIG,MAAMC,SAAWhO,OAAO0O,KAAKd,EAAIa,MAAMlJ,QAG3CqI,EAAIG,MAAMC,SAAWhC,EAAiBE,UACtC0B,EAAIjG,OAAOmC,KAAK,yBAAyB8D,EAAIG,MAAMC,oBAAoBhC,EAAiBE,aAI5FyC,EAAmBpN,EAAO,QAASqM,GAG/BA,EAAIG,MAAMM,mBAAqB,EAAG,CAClC,MAAMO,EAAiBhB,EAAIG,MAAMM,mBAC3BQ,EAAcjB,EAAIG,MAAMG,mBAAsC,EAAjBU,EAE/CA,EAAiB,IACjBhB,EAAIC,SAAS/D,KACT,GAAG8E,+HAKPC,EAAc,IACdjB,EAAIC,SAAS/D,KACT,sBAAsB+E,gFAIlC,CAIA,GAAIjB,EAAIjG,OAAOpC,OAAS,EACpB,MAAO,CACH4H,OAAO,EACPpH,MAAO6H,EAAIjG,OAAOmH,KAAK,MACvBjB,SAAUD,EAAIC,SAAStI,OAAS,EAAIqI,EAAIC,cAAWvF,GAI3D,MAAMjH,EAAiC,CACnCP,KAAM2M,EAAI3M,KACVQ,OAAyC,QAAjC,EAAAmM,EAAInM,cAA6B,SACzCC,MAAOA,GAYX,OARAqM,EAAIE,KAAKhE,KACL,iBAAiB8D,EAAIG,MAAMK,6BAC5BR,EAAIG,MAAMC,yBACVJ,EAAIG,MAAME,4BACVL,EAAIG,MAAMM,iDACAT,EAAIG,MAAMI,YAGhB,CACHhB,OAAO,EACP9L,SACAwM,SAAUD,EAAIC,SAAStI,OAAS,EAAIqI,EAAIC,cAAWvF,EACnDwF,KAAMF,EAAIE,KAAKvI,OAAS,EAAIqI,EAAIE,UAAOxF,EAE/C,CAMA,SAASqG,EACLxD,EACA4D,EACAnB,GAMA,GAJAA,EAAIW,eACJX,EAAIG,MAAMI,SAAWa,KAAKC,IAAIrB,EAAIG,MAAMI,SAAUP,EAAIW,cAGlDX,EAAIW,aAAevC,EAAiBG,kBAGpC,OAFAyB,EAAIjG,OAAOmC,KAAK,GAAGiF,uCAA0C/C,EAAiBG,0BAC9EyB,EAAIW,eAKR,IAAK,MAAMW,KAAWrC,OACIvE,IAAlB6C,EAAK+D,IACLtB,EAAIjG,OAAOmC,KAAK,GAAGiF,OAAUG,uBAKrC,IAAK,MAAMhP,KAAOsM,EAAoBC,aAChBnE,IAAd6C,EAAKjL,IACL0N,EAAIC,SAAS/D,KAAK,GAAGiF,OAAU7O,sCAGvC,IAAK,MAAMA,KAAOsM,EAAoBE,YAChBpE,IAAd6C,EAAKjL,IACL0N,EAAIC,SAAS/D,KAAK,GAAGiF,OAAU7O,sCAGvC,IAAK,MAAMA,KAAOsM,EAAoBG,WAChBrE,IAAd6C,EAAKjL,IACL0N,EAAIC,SAAS/D,KAAK,GAAGiF,OAAU7O,sCAGvC,IAAK,MAAMA,KAAOsM,EAAoBI,YAChBtE,IAAd6C,EAAKjL,IACL0N,EAAIC,SAAS/D,KAAK,GAAGiF,OAAU7O,sCAKvC,GAAIiL,EAAKwC,MAA6B,iBAAdxC,EAAKwC,KAGzB,OAqJR,SAAqBwB,EAAaJ,EAAcnB,GAE5C,GAAIuB,EAAIC,WAAW,YAAcD,EAAIC,WAAW,YAE5C,YADAxB,EAAIjG,OAAOmC,KAAK,GAAGiF,oCAAuCI,OAK9D,GAAIvB,EAAIY,SAAS3E,IAAIsF,GAGjB,YADAvB,EAAIE,KAAKhE,KAAK,GAAGiF,6BAAgCI,MAIrDvB,EAAIY,SAASa,IAAIF,GAGjB,MAAMG,EAAUH,EAAII,QAAQ,6BAA8B,IACrD3B,EAAIa,KAAKa,IACV1B,EAAIjG,OAAOmC,KAAK,GAAGiF,iBAAoBI,8BAE/C,CA5KQK,CAAYrE,EAAKwC,KAAMoB,EAAMnB,QAC7BA,EAAIW,eAKR,MAAMkB,EAAQnE,MAAMC,QAAQJ,EAAK1J,MAAQ0J,EAAK1J,KAAO,CAAC0J,EAAK1J,MAE3D,IAAK,MAAMA,KAAQgO,EACf,OAAQhO,GACJ,IAAK,SACDiO,EAAmBvE,EAAM4D,EAAMnB,GAC/B,MACJ,IAAK,QACD+B,EAAkBxE,EAAM4D,EAAMnB,GAC9B,MACJ,IAAK,SACDgC,EAAmBzE,EAAM4D,EAAMnB,GAC/B,MACJ,IAAK,SACL,IAAK,UACmBzC,EAAM4D,EAAMnB,EAChC,MACJ,IAAK,UACL,IAAK,OAED,MACJ,SACQnM,GAAS0J,EAAKO,OAAUP,EAAKS,OAC7BgC,EAAIC,SAAS/D,KAAK,GAAGiF,oBAAuBtN,MAMxD0J,EAAKO,OAASJ,MAAMC,QAAQJ,EAAKO,QA2IzC,SAAuBmE,EAAqBd,EAAcnB,GACtDA,EAAIG,MAAME,aACVL,EAAIG,MAAMG,oBAAsB2B,EAAStK,OAErCsK,EAAStK,OAASyG,EAAiBC,oBACnC2B,EAAIjG,OAAOmC,KACP,GAAGiF,gBAAmBc,EAAStK,yBAAyByG,EAAiBC,uBAIjF,GAAwB,IAApB4D,EAAStK,OAET,YADAqI,EAAIjG,OAAOmC,KAAK,GAAGiF,4BAIvBc,EAASrE,SAAQ,CAACG,EAASmE,KACnBnE,GAA8B,iBAAZA,GAClBgD,EAAmBhD,EAA4B,GAAGoD,WAAce,KAAMlC,EAC1E,GAER,CA9JQmC,CAAc5E,EAAKO,MAAOqD,EAAMnB,GAIhCzC,EAAKS,OAASN,MAAMC,QAAQJ,EAAKS,QA4JzC,SAAuBiE,EAAqBd,EAAcnB,GACtD,GAAwB,IAApBiC,EAAStK,OAET,YADAqI,EAAIjG,OAAOmC,KAAK,GAAGiF,4BAIvBc,EAASrE,SAAQ,CAACG,EAASmE,KACvB,GAAInE,GAA8B,iBAAZA,EAAsB,CACxC,MAAMzC,EAAIyC,EAGNzC,EAAEyE,MACFC,EAAIjG,OAAOmC,KAAK,GAAGiF,WAAce,qCAGrCnB,EAAmBzF,EAAsB,GAAG6F,WAAce,KAAMlC,EACpE,IAER,CA7KQoC,CAAc7E,EAAKS,MAAOmD,EAAMnB,GAIhCzC,EAAKvI,MAAQ0I,MAAMC,QAAQJ,EAAKvI,OA2KxC,SAAsByI,EAAmB0D,EAAcnB,GAGnD,GAFAA,EAAIG,MAAMO,YAEY,IAAlBjD,EAAO9F,OAEP,YADAqI,EAAIjG,OAAOmC,KAAK,GAAGiF,2BAInB1D,EAAO9F,OAASyG,EAAiBK,iBACjCuB,EAAIC,SAAS/D,KACT,GAAGiF,eAAkB1D,EAAO9F,+BAKpC,IAAK,IAAIuK,EAAI,EAAGA,EAAIzE,EAAO9F,OAAQuK,IAAK,CACpC,MAAMG,EAAM5E,EAAOyE,GACbI,SAAWD,EAEjB,GAAU,WAANC,GAAwB,WAANA,GAAwB,YAANA,GAA2B,OAARD,EAAc,CACrErC,EAAIjG,OAAOmC,KACP,GAAGiF,UAAae,6CAA6CI,qDAGjE,KACJ,CACJ,CAGA,MAAMC,EAAO,IAAIzG,IACjB,IAAK,MAAMuG,KAAO5E,EAAQ,CACtB,MAAMnL,EAAM+F,KAAKC,UAAU+J,GAC3B,GAAIE,EAAKtG,IAAI3J,GAAM,CACf0N,EAAIC,SAAS/D,KAAK,GAAGiF,+BAAkC7O,KACvD,KACJ,CACAiQ,EAAKd,IAAInP,EACb,CACJ,CAhNQkQ,CAAajF,EAAKvI,KAAMmM,EAAMnB,QAIftF,IAAf6C,EAAKkF,OA8Mb,SAAuB9O,EAAgBwN,EAAcnB,GACjD,MAAMsC,SAAW3O,EACP,WAAN2O,GAAwB,WAANA,GAAwB,YAANA,GAA6B,OAAV3O,GACvDqM,EAAIjG,OAAOmC,KACP,GAAGiF,0DAA6DmB,KAG5E,CApNQI,CAAcnF,EAAKkF,MAAOtB,EAAMnB,GAGpCA,EAAIW,cACR,CAMA,SAASmB,EAAmBvE,EAAuB4D,EAAcnB,GAO7D,IALkC,IAA9BzC,EAAKzJ,sBACLkM,EAAIC,SAAS/D,KAAK,GAAGiF,qEAIrB5D,EAAKxJ,YAAyC,iBAApBwJ,EAAKxJ,WAAyB,CACxD,MAAM4O,EAAQpF,EAAKxJ,WACb6O,EAAYxQ,OAAO0O,KAAK6B,GAAOhL,OACrCqI,EAAIG,MAAMK,eAAiBoC,EAEvBA,EAAYxE,EAAiBI,2BAC7BwB,EAAIC,SAAS/D,KACT,GAAGiF,MAASyB,kDAKpB,MAAMtO,EAAYiJ,EAAKjJ,UAAyB,GAChD,IAAK,MAAOhC,EAAKkL,KAASpL,OAAOyQ,QAAQF,GAChCrO,EAASqI,SAASrK,IACnB0N,EAAIG,MAAMM,qBAGVjD,GAAwB,iBAATA,GACfuD,EAAmBvD,EAAM,GAAG2D,KAAQ7O,IAAO0N,EAGvD,CACJ,CAEA,SAAS+B,EAAkBxE,EAAuB4D,EAAcnB,GAE5D,QAAsBtF,IAAlB6C,EAAKuF,SAAwB,CACb1E,EAAiBO,uBACpBhC,SAASY,EAAKuF,WACvB9C,EAAIC,SAAS/D,KACT,GAAGiF,iBAAoB5D,EAAKuF,gDAGxC,CAGIvF,EAAKtJ,QACqB,iBAAfsJ,EAAKtJ,OAAuByJ,MAAMC,QAAQJ,EAAKtJ,OAE/CyJ,MAAMC,QAAQJ,EAAKtJ,QAE1BsJ,EAAKtJ,MAAM2J,SAAQ,CAACC,EAAMqE,KAClBrE,GAAwB,iBAATA,GACfkD,EAAmBlD,EAAyB,GAAGsD,WAAce,KAAMlC,EACvE,IANJe,EAAmBxD,EAAKtJ,MAA0B,GAAGkN,UAAcnB,IAYvEzC,EAAKwF,aAAerF,MAAMC,QAAQJ,EAAKwF,cACvCxF,EAAKwF,YAAYnF,SAAQ,CAACC,EAAMqE,KACxBrE,GAAwB,iBAATA,GACfkD,EAAmBlD,EAAyB,GAAGsD,iBAAoBe,KAAMlC,EAC7E,GAGZ,CAEA,SAASgC,EAAmBzE,EAAuB4D,EAAcnB,GAE7D,GAAIzC,EAAKyF,QAAiC,iBAAhBzF,EAAKyF,OAAqB,CAChD,MAAMC,EAAY7E,EAAiBM,yBAC9BuE,EAAUtG,SAASY,EAAKyF,SACzBhD,EAAIC,SAAS/D,KACT,GAAGiF,cAAiB5D,EAAKyF,4CACnBC,EAAU/B,KAAK,QAGjC,CAGI3D,EAAK4B,SAAmC,iBAAjB5B,EAAK4B,SA4HpC,SAA8BA,EAAiBgC,EAAcnB,GAEzD,IAAK,MAAQb,QAAS+D,EAAK,KAAEhQ,KAAUgM,EAC/BgE,EAAMpD,KAAKX,IACXa,EAAIjG,OAAOmC,KAAK,GAAGiF,8CAAiDjO,KAK5E,IACI,IAAIiQ,OAAOhE,EACf,CAAE,MAAOlF,GACL,MAAMmJ,EAAMnJ,aAAayF,MAAQzF,EAAE0F,QAAU,gBAC7CK,EAAIjG,OAAOmC,KAAK,GAAGiF,6BAAgCiC,IACvD,CAGA,MAAMC,EAAoB,mBAC1B,IAAIzD,EACJ,KAAqD,QAA7CA,EAAQyD,EAAkBC,KAAKnE,KAAoB,CACvD,MAAMoE,EAAMC,SAAS5D,EAAM,GAAI,IACzByB,EAAMmC,SAAS5D,EAAM,GAAI,IAC3ByB,EAAMkC,EAAM,KACZvD,EAAIC,SAAS/D,KACT,GAAGiF,8BAAiCoC,KAAOlC,sBAGvD,CACJ,CAvJQoC,CAAqBlG,EAAK4B,QAASgC,EAAMnB,EAEjD,CAiKO,SAAS0D,EAAcjQ,GAC1B,MAAM4J,EAAQxC,gBAAgBpH,GAU9B,YAPqBiH,IAAjB2C,EAAM3J,SACN2J,EAAM3J,QAAS,GAInBiQ,EAActG,EAAM1J,OAEb0J,CACX,CAEA,SAASsG,EAAcpG,GAEnB,GAAkB,WAAdA,EAAK1J,OACL0J,EAAKzJ,sBAAuB,EAExByJ,EAAKxJ,YAAyC,iBAApBwJ,EAAKxJ,YAC/B,IAAK,MAAMyJ,KAAQpL,OAAOqL,OAAOF,EAAKxJ,YAC9ByJ,GAAwB,iBAATA,GACfmG,EAAcnG,GAOZ,UAAdD,EAAK1J,MAAoB0J,EAAKtJ,OAA+B,iBAAfsJ,EAAKtJ,QAC9CyJ,MAAMC,QAAQJ,EAAKtJ,OAGpBsJ,EAAKtJ,MAAM2J,SAAQC,IACXA,GAAwB,iBAATA,GACf8F,EAAc9F,EAClB,IALJ8F,EAAcpG,EAAKtJ,QAWvBsJ,EAAKO,OAASJ,MAAMC,QAAQJ,EAAKO,QACjCP,EAAKO,MAAMF,SAAQG,IACXA,GAA8B,iBAAZA,GAClB4F,EAAc5F,EAClB,IAKJR,EAAKS,OAASN,MAAMC,QAAQJ,EAAKS,QACjCT,EAAKS,MAAMJ,SAAQG,IACXA,GAA8B,iBAAZA,GAClB4F,EAAc5F,EAClB,IAKR,MAAM6F,EAAwB,GAE9B,IAAK,MAAMtR,KAAOsM,EAAoBC,aAChBnE,IAAd6C,EAAKjL,KACLsR,EAAY1H,KAAK,GAAG5J,MAAQiL,EAAKjL,aAC1BiL,EAAKjL,IAIpB,IAAK,MAAMA,KAAOsM,EAAoBE,YAChBpE,IAAd6C,EAAKjL,KACLsR,EAAY1H,KAAK,GAAG5J,MAAQiL,EAAKjL,aAC1BiL,EAAKjL,IAIpB,IAAK,MAAMA,KAAOsM,EAAoBG,WAChBrE,IAAd6C,EAAKjL,KACLsR,EAAY1H,KAAK,GAAG5J,MAAQiL,EAAKjL,aAC1BiL,EAAKjL,IAKpB,QAAsBoI,IAAlB6C,EAAKuF,UAA4C,OAAlBvF,EAAKuF,SAAmB,CACvD,MAAMA,EAAWvF,EAAKuF,SACL,IAAbA,GAA+B,IAAbA,IAClBc,EAAY1H,KAAK,aAAa4G,KAC9BvF,EAAKuF,SAAWA,EAAW,EAAI,EAAI,EAE3C,CAGA,GAAIc,EAAYjM,OAAS,EAAG,CACxB,MAAMkM,EAAiB,iBAAiBD,EAAY1C,KAAK,SACrD3D,EAAKuG,YACLvG,EAAKuG,YAAc,GAAGvG,EAAKuG,eAAeD,IAE1CtG,EAAKuG,YAAcD,CAE3B,CACJ,CClsBO,SAASE,EAAcC,GAC1B,GAAIA,EAAO7O,eAAgB,CACvB,MAAM2H,EAAS,EAAgBkH,EAAO7O,gBACtC,GAAI2H,EACA,OAAOA,EAAOvJ,OAElB,EAAS,QAAS,0BAA2B,CAAEN,GAAI+Q,EAAO7O,gBAC9D,CAEA,OAAO6O,EAAO5O,YAClB,CAkCO,SAAS,EAA8BsH,GAC1C,MACMuH,EADW,IACS3N,cAAcoG,GAExC,MAAO,CACHvH,eAAgB8O,EAAS9O,eACzBC,aAAc6O,EAAS7O,aACvBC,eAAgB4O,EAAS5O,eACzBC,aAAc2O,EAAS3O,aACvBC,oBAAqB0O,EAAS1O,oBAEtC,CA2BO,SAAS2O,EAAsB3Q,EAAgBgF,GAClD,MAAM,OAAEyC,GAAWxC,YAAYyC,MAGzB,iBAAEkJ,GAAqB3L,YAAYC,aACzC,IAAI2L,EAAYD,EAAiB5Q,GAyEjC,OAtEA6Q,EA4EJ,SAAkC7Q,EAAgBgF,GAE9C,MAAM8L,EAAmB,8CAEzB,OAAO9Q,EAAOoO,QAAQ0C,GAAkB,CAACC,EAAQC,EAAUC,K,cAIvD,IAAIC,GAAW,EAEf,OALgBF,EAASG,eAMrB,IAAK,gBACDD,KAAiC,QAApB,EAAAlM,EAAQoM,oBAAY,eAAErF,QACnC,MACJ,IAAK,kBACDmF,KAAmC,QAAtB,EAAAlM,EAAQqM,sBAAc,eAAEtF,QACrC,MACJ,IAAK,kBACDmF,KAAmC,QAAtB,EAAAlM,EAAQsM,sBAAc,eAAEvF,QACrC,MACJ,IAAK,mBACDmF,KAAoC,QAAvB,EAAAlM,EAAQuM,uBAAe,eAAExF,QACtC,MACJ,IAAK,qBACDmF,KAAsC,QAAzB,EAAAlM,EAAQwM,yBAAiB,eAAEzF,QACxC,MACJ,IAAK,mBACDmF,IAAalM,EAAQyM,iBAA+C,MAA5BzM,EAAQyM,gBAChD,MACJ,QACIP,GAAW,EAGnB,OAAOA,EAAWD,EAAU,EAAE,GAEtC,CA/GgBS,CAAyBb,EAAW7L,QAGdmC,IAA9BnC,EAAQwM,oBACRX,EAAYA,EAAUzC,QAClB,IAAIwB,OAAOnI,EAAOkK,aAAaxO,EAAsBC,oBAAqB,MAC1E4B,EAAQwM,yBAIarK,IAAzBnC,EAAQoM,eACRP,EAAYA,EAAUzC,QAClB,IAAIwB,OAAOnI,EAAOkK,aAAaxO,EAAsBE,eAAgB,MACrE2B,EAAQoM,oBAIejK,IAA3BnC,EAAQqM,iBACRR,EAAYA,EAAUzC,QAClB,IAAIwB,OAAOnI,EAAOkK,aAAaxO,EAAsBG,iBAAkB,MACvE0B,EAAQqM,sBAIelK,IAA3BnC,EAAQsM,iBACRT,EAAYA,EAAUzC,QAClB,IAAIwB,OAAOnI,EAAOkK,aAAaxO,EAAsBI,iBAAkB,MACvEyB,EAAQsM,sBAIgBnK,IAA5BnC,EAAQuM,kBACRV,EAAYA,EAAUzC,QAClB,IAAIwB,OAAOnI,EAAOkK,aAAaxO,EAAsBK,kBAAmB,MACxEwB,EAAQuM,uBAIgBpK,IAA5BnC,EAAQyM,kBACRZ,EAAYA,EAAUzC,QAClB,IAAIwB,OAAOnI,EAAOkK,aAAaxO,EAAsBM,kBAAmB,MACxEuB,EAAQyM,uBAKStK,IAArBnC,EAAQ4M,WACRf,EAAYA,EAAUzC,QAClB,IAAIwB,OAAOnI,EAAOkK,aAAaxO,EAAsBO,gBAAiB,MACtEsB,EAAQ4M,gBAKSzK,IAArBnC,EAAQ6M,WACRhB,EAAYA,EAAUzC,QAClB,IAAIwB,OAAOnI,EAAOkK,aAAaxO,EAAsBQ,WAAY,MACjEqB,EAAQ6M,gBAKS1K,IAArBnC,EAAQ4M,WACRf,EAAYA,EAAUzC,QAAQ,iBAAkBpJ,EAAQ4M,gBAGnCzK,IAArBnC,EAAQ6M,WACRhB,EAAYA,EAAUzC,QAAQ,iBAAkBpJ,EAAQ6M,WAGrDhB,CACX,CA6CO,SAASiB,EAAsB9R,GAClC,MAAM+R,EAAkB,GAExB,IAAK,MAAOhT,EAAKiT,KAAgBnT,OAAOyQ,QAAQnM,GACxCnD,EAAOmR,cAAc/H,SAAS4I,EAAYb,gBAC1CY,EAAMpJ,KAAK5J,GAInB,OAAOgT,CACX,C,0SC1OO,SAASE,IACZ,MAAO,CACHC,UAAW,KACXC,eAAgB,KAEhBC,QAAS,CACLjT,MAAO,KACPC,QAAS,KACTC,QAAS,MAGbgT,QAAS,CACLlT,MAAO,EAA8B,SACrCC,QAAS,EAA8B,WACvCC,QAAS,EAA8B,YAG3CiT,eAAgB,CAAC,QAAS,WAC1BC,aAAc,KACdC,YAAa,CACTrT,MAAO,UACPC,QAAS,UACTC,QAAS,WAIboT,eAAgB,EAChBC,iBAAkB,GAClBC,YAAY,EAEZC,WAAY,KAEpB,CAwBO,SAASC,EAAaC,EAAsBZ,EAA6Ba,GAE5E,GAAID,EAAMX,iBAAmBY,GAAmB,OAAVA,EAClC,OAAOD,EAGX,MAAME,EAAQ,+BACPF,GAAK,CACRZ,YACAC,eAAgBY,EAEhBX,QAAS,CACLjT,MAAO,KACPC,QAAS,KACTC,QAAS,MAEbmT,YAAa,CACTrT,MAAO,UACPC,QAAS,UACTC,QAAS,WAEbkT,aAAc,KAEdE,eAAgB,EAChBC,iBAAkB,GAClBC,YAAY,EACZC,WAAY,OAShB,OANA,EAAS,QAAS,gBAAiB,CAC/BjT,KAAMuS,aAAS,EAATA,EAAWvS,KACjBoT,QACAE,gBAAiBf,EAAYgB,GAAmBhB,GAAW9N,OAAS,IAGjE4O,CACX,CAKO,SAASE,GAAmBC,GAC/B,OAAOvU,EACF6H,QAAO9F,IACJ,MAAMmO,EAAMqE,EAAKxS,EAAM5B,KACvB,OAAO+P,GAAsB,iBAARA,GAAoBA,EAAI/C,OAAO3H,OAAS,CAAC,IAEjEyC,KAAIlG,IACD,MAAMP,EAAS+S,EAAKxS,EAAM5B,KAAgBgN,OAC1C,MAAO,CACHhN,IAAK4B,EAAM5B,IACXC,MAAO2B,EAAM3B,MACboB,QACAgT,UAAWhT,EAAMgE,OACjBnF,UAAW0B,EAAM1B,UACpB,GAEb,CAKO,SAASoU,GAAsBF,GAClC,MAEMG,EAFSJ,GAAmBC,GAEVtM,KAAI0M,GAAK,OAAOA,EAAEvU,UAAUuU,EAAEnT,UAEtD,MAAO,gBAAgB+S,EAAKxT,WAAW2T,EAAS3F,KAAK,SACzD,CA4FO,SAAS6F,GAAUV,GACtB,OAAKA,EAAMZ,UAINY,EAAMV,QAAQhT,QAId0T,EAAMV,QAAQ/S,QAIZ,CAAEoU,QAAQ,GAHN,CAAEA,QAAQ,EAAOC,OAAQ,wCAJzB,CAAED,QAAQ,EAAOC,OAAQ,wBAJzB,CAAED,QAAQ,EAAOC,OAAQ,wBAYxC,CASO,SAASC,GACZb,EACA3J,EACAH,GAEA,OAAO,OAAP,wBACO8J,GAAK,CACRT,QAAS,OAAF,wBACAS,EAAMT,SAAO,CAChB,CAAClJ,GAAQ,OAAF,wBACA2J,EAAMT,QAAQlJ,IACdH,MAInB,CA4EO,SAAS4K,GAAUd,EAAsB3J,EAAkB0K,GAG9D,OAFA,EAAS,QAAS,eAAgB,CAAE1K,QAAOvE,MAAOiP,IAE3C,OAAP,wBACOf,GAAK,CACRP,aAAc,KACdC,YAAa,OAAF,wBACJM,EAAMN,aAAW,CACpB,CAACrJ,GAAQ,aAGrB,CAqFO,SAAS2K,GAAeC,GAC3B,MAAMC,EAAQD,EAAiBvP,cAG/B,GAAIwP,EAAM5K,SAAS,YAAc4K,EAAM5K,SAAS,aAAc,CAC1D,GAAI4K,EAAM5K,SAAS,YAAc4K,EAAM5K,SAAS,SAC5C,MAAO,SAEX,GAAI4K,EAAM5K,SAAS,cACf,MAAO,aAEX,GAAI4K,EAAM5K,SAAS,qBAAuB4K,EAAM5K,SAAS,oBACrD,MAAO,kBAEf,CAGA,OAAI4K,EAAM5K,SAAS,iBAAmB4K,EAAM5K,SAAS,sBAC1C,SAEP4K,EAAM5K,SAAS,eAAiB4K,EAAM5K,SAAS,kBAAoB4K,EAAM5K,SAAS,aAC3E,cAIP4K,EAAM5K,SAAS,UAAY4K,EAAM5K,SAAS,YAAc4K,EAAM5K,SAAS,cAChE,mBAIf,CA6BO,SAAS6K,GAAgBnB,GAC5B,MAAMoB,EAzBH,SAAiCpB,GACpC,IAAKA,EAAMV,QAAQhT,UAAY0T,EAAMV,QAAQ/S,QACzC,OAAO,KAGX,MAAMmC,EAAUsS,GAAehB,EAAMV,QAAQ/S,QAAQ8U,UAErD,MAAO,CACHC,UAAWtB,EAAML,eACjB4B,gBAAiBvB,EAAMV,QAAQhT,QAAQ+U,SACvCG,eAAgBxB,EAAMV,QAAQhT,QAAQ+U,SAASI,UAAU,EAAG,KAC5DR,iBAAkBjB,EAAMV,QAAQ/S,QAAQ8U,SACxCK,gBAAiB1B,EAAMV,QAAQ/S,QAAQ8U,SAASI,UAAU,EAAG,KAC7D/S,UACAyC,UAAWC,KAAKuF,MAExB,CASqBgL,CAAwB3B,GAEzC,IAAKoB,EAED,OADA,EAAS,uDAAwD,MAC1DpB,EAIX,MAAM4B,EAAa,IAAI5B,EAAMJ,iBAAkBwB,GAU/C,OATIQ,EAAWtQ,OAASP,GACpB6Q,EAAWC,QAGf,EAAS,QAAS,gCAAiC,CAC/CP,UAAWtB,EAAML,eAAiB,EAClCmC,gBAAiBV,EAAS1S,UAGvB,OAAP,wBACOsR,GAAK,CACRJ,iBAAkBgC,EAClBjC,eAAgBK,EAAML,eAAiB,EAEvCL,QAAS,OAAF,wBACAU,EAAMV,SAAO,CAChB/S,QAAS,OAEbmT,YAAa,OAAF,wBACJM,EAAMN,aAAW,CACpBnT,QAAS,YAEbsT,YAAY,GAEpB,CAoHO,SAASkC,GAAqBV,GAEjC,MAAMW,EA6BV,SAAwBX,GACpB,IAEI,IAAIlI,EACJ,IACIA,EAASnH,KAAKoH,MAAMiI,EACxB,CAAE,SAEE,MAAMY,EAAiBZ,EAAS9H,MAAM,gCACtC,IAAK0I,EAAgB,OAAO,KAC5B9I,EAASnH,KAAKoH,MAAM6I,EAAe,GAAGhJ,OAC1C,CAEA,GAAsB,iBAAXE,GAAkC,OAAXA,GAAmB9B,MAAMC,QAAQ6B,GAC/D,OAAO,KAGX,MAAM+I,EAA+B,GAErC,IAAK,MAAOjW,EAAKqB,KAAUvB,OAAOyQ,QAAQrD,GACtC,GAAqB,iBAAV7L,GAAsBA,EAAM2L,OAAQ,CAC3C,MAAMkJ,EAAWrW,EAAiByK,MAAKkK,GACnCA,EAAExU,MAAQA,GAAOwU,EAAEvU,MAAMmS,gBAAkBpS,EAAIoS,gBAGnD6D,EAAOrM,KAAK,CACR5J,KAAKkW,aAAQ,EAARA,EAAUlW,MAAOA,EACtBC,OAAOiW,aAAQ,EAARA,EAAUjW,QAASkW,GAAiBnW,GAC3CqB,MAAOA,EAAM2L,QAErB,CAGJ,OAAsB,IAAlBiJ,EAAO5Q,OAAqB,KAEzB,CACH4Q,SACAG,IAAKhB,EACLiB,YAAa,OAErB,CAAE,SACE,OAAO,IACX,CACJ,CAxEuBC,CAAelB,GAClC,GAAIW,EACA,OAAOA,EAIX,MAAMQ,EAoEV,SAA4BnB,G,QAExB,MAAMoB,EAAgB,qBAChBC,EAAU,IAAIrB,EAASsB,SAASF,IAEtC,GAAuB,IAAnBC,EAAQpR,OAAc,OAAO,KAEjC,MAAM4Q,EAA+B,GAErC,IAAK,IAAIrG,EAAI,EAAGA,EAAI6G,EAAQpR,OAAQuK,IAAK,CACrC,MAAMtC,EAAQmJ,EAAQ7G,GAChB+G,EAAarJ,EAAM,GAAGN,OACtB4J,EAAatJ,EAAM0G,MAAS1G,EAAM,GAAGjI,OACrCwR,EAAgC,QAArB,EAAc,QAAd,EAAAJ,EAAQ7G,EAAI,UAAE,eAAEoE,aAAK,QAAIoB,EAAS/P,OAC7C6M,EAAUkD,EAASvN,MAAM+O,EAAYC,GAAU7J,OAErD,IAAKkF,EAAS,SAGd,MAAMgE,EAAWrW,EAAiByK,MAAKkK,GACnCA,EAAEvU,MAAMmS,gBAAkBuE,EAAWvE,eACrCoC,EAAExU,MAAQ2W,EAAWvE,cAAc/C,QAAQ,OAAQ,QAKlD6G,GADe,CAAC,UAAW,QAAS,UAAW,UAAW,YAClCY,MAAKC,GAAKJ,EAAWvE,cAAc/H,SAAS0M,MAIzEd,EAAOrM,KAAK,CACR5J,KAAKkW,aAAQ,EAARA,EAAUlW,MAAO2W,EAAWvE,cAAc/C,QAAQ,OAAQ,KAC/DpP,OAAOiW,aAAQ,EAARA,EAAUjW,QAAS0W,EAC1BtV,MAAO6Q,GAEf,CAEA,OAAsB,IAAlB+D,EAAO5Q,OAAqB,KAEzB,CACH4Q,SACAG,IAAKhB,EACLiB,YAAa,WAErB,CAhH2BW,CAAmB5B,GAC1C,GAAImB,EACA,OAAOA,EAIX,MAAMU,EA4GV,SAAgC7B,GAC5B,MAAMa,EAA+B,GAGrC,IAAK,MAAMC,KAAYrW,EAAkB,CACrC,MAAMqX,EAAW,CACb,IAAIrG,OAAO,SAASqF,EAASjW,gDAAiD,KAC9E,IAAI4Q,OAAO,GAAGqF,EAASjW,8CAA+C,KACtE,IAAI4Q,OAAO,MAAMqF,EAASjW,yCAA0C,MAGxE,IAAK,MAAM4M,KAAWqK,EAAU,CAC5B,MAAM5J,EAAQ8H,EAAS9H,MAAMT,GAC7B,GAAIS,GAASA,EAAM,GAAGN,OAAQ,CAC1BiJ,EAAOrM,KAAK,CACR5J,IAAKkW,EAASlW,IACdC,MAAOiW,EAASjW,MAChBoB,MAAOiM,EAAM,GAAGN,SAEpB,KACJ,CACJ,CACJ,CAEA,OAAsB,IAAlBiJ,EAAO5Q,OAAqB,KAEzB,CACH4Q,SACAG,IAAKhB,EACLiB,YAAa,YAErB,CA3I4Bc,CAAuB/B,GAC/C,OAAI6B,GAKG,CACHhB,OAAQ,CAAC,CACLjW,IAAK,UACLC,MAAO,UACPoB,MAAO+T,EAASpI,SAEpBoJ,IAAKhB,EACLiB,YAAa,MAErB,CA8HA,SAASF,GAAiBnW,GACtB,OAAOA,EACFqP,QAAQ,KAAM,KACdA,QAAQ,kBAAmB,SAC3BA,QAAQ,SAAS+H,GAAKA,EAAE3R,eACjC,CAuFO,SAAS4R,GAAatD,EAAsBP,GAC/C,MAAM8D,EAAevD,EAAMR,eAAegE,QAAQ/D,GAClD,OAAsB,IAAlB8D,GAAuBA,GAAgBvD,EAAMR,eAAelO,OAAS,EAC9D,KAEJ0O,EAAMR,eAAe+D,EAAe,EAC/C,CAuCO,SAASE,GAAUzD,GAEtB,QAASA,EAAMV,QAAQhT,OAC3B,CAUO,SAASoX,GAAiB1D,EAAsB3J,G,YACnD,IAAK2J,EAAMZ,UACP,OAAO,KAGX,MACMuE,EAAajG,EADJsC,EAAMT,QAAQlJ,IAG7B,IAAKsN,EAAW1K,OACZ,OAAO,KAIX,MAAM2K,EAAmBrD,GAAsBP,EAAMZ,YAG/C,MAAEyE,GAAU1R,YAAYC,aAExBF,EAAU,CACZwM,kBAAmBkF,EACnBtF,cAAiC,QAAnB,EAAA0B,EAAMV,QAAQjT,aAAK,eAAEgV,WAAY,GAC/C9C,gBAAqC,QAArB,EAAAyB,EAAMV,QAAQhT,eAAO,eAAE+U,WAAY,GACnD7C,gBAAqC,QAArB,EAAAwB,EAAMV,QAAQhT,eAAO,eAAE+U,WAAY,GACnD5C,iBAAsC,QAArB,EAAAuB,EAAMV,QAAQ/S,eAAO,eAAE8U,WAAY,GACpD1C,gBAAiBmF,OAAO9D,EAAML,eAAiB,GAC/Cb,SAAUkB,EAAMZ,UAAUvS,KAC1BkS,SAAU8E,GAAS,QAIjBE,EAAoB/E,EAAsB2E,GAC1CK,EAAoBD,EAAkBzS,OAAS,EAG/C2S,EAAkBpG,EAAsB8F,EAAYzR,GAG1D,GAAI8R,EAAmB,CAKnB,OAHiCD,EAAkBzN,SAAS,sBAIjD2N,EAIJC,GAAsB7N,EAAO2J,EAAO4D,EAAkBK,EACjE,CAIA,OADA,EAAS,OAAQ,4DAA6D,CAAE5N,UACzE6N,GAAsB7N,EAAO2J,EAAO4D,EAAkBK,EACjE,CAKO,SAASE,GAAsBnE,G,MAClC,IAAKA,EAAMZ,YAAcY,EAAMV,QAAQhT,UAAY0T,EAAMV,QAAQ/S,QAC7D,OAAO,KAGX,MACMoX,EADW,IACWzT,iBAEtB0T,EAAmBrD,GAAsBP,EAAMZ,YAC/C,MAAEyE,GAAU1R,YAAYC,aAa9B,OAAOyL,EAAsB8F,EAXb,CACZjF,kBAAmBkF,EACnBtF,cAAiC,QAAnB,EAAA0B,EAAMV,QAAQjT,aAAK,eAAEgV,WAAY,GAC/C9C,eAAgByB,EAAMV,QAAQhT,QAAQ+U,SACtC7C,eAAgBwB,EAAMV,QAAQhT,QAAQ+U,SACtC5C,gBAAiBuB,EAAMV,QAAQ/S,QAAQ8U,SACvC1C,gBAAiBmF,OAAO9D,EAAML,eAAiB,GAC/Cb,SAAUkB,EAAMZ,UAAUvS,KAC1BkS,SAAU8E,GAAS,QAI3B,CAKA,SAASK,GACL7N,EACA2J,EACA4D,EACAQ,G,UAEA,MAAMC,EAAkB,GAGlBC,EAAwB,UAAVjO,EAAoB,UAAsB,YAAVA,EAAsB,UAAY,UAItF,OAHAgO,EAAMxO,KAAK,kBAAkByO,IAAe,GAAIV,GAGxCvN,GACJ,IAAK,QAED,MAEJ,IAAK,WAEsB,QAAnB,EAAA2J,EAAMV,QAAQjT,aAAK,eAAEgV,WACrBgD,EAAMxO,KAAK,GAAI,MAAO,GAAI,mBAAoB,GAAI,2CAA4C,GAAImK,EAAMV,QAAQjT,MAAMgV,UAE1H,MAEJ,IAAK,WAEwB,QAArB,EAAArB,EAAMV,QAAQhT,eAAO,eAAE+U,WACvBgD,EAAMxO,KAAK,GAAI,MAAO,GAAI,sBAAuB,GAAI,qCAAsC,GAAImK,EAAMV,QAAQhT,QAAQ+U,WAIlG,QAAnB,EAAArB,EAAMV,QAAQjT,aAAK,eAAEgV,WACrBgD,EAAMxO,KAAK,GAAI,MAAO,GAAI,4BAA6B,GAAI,4DAA6D,GAAImK,EAAMV,QAAQjT,MAAMgV,UAQ5J,OAFAgD,EAAMxO,KAAK,GAAI,MAAO,GAAI,iBAAkB,GAAIuO,GAEzCC,EAAMxJ,KAAK,KACtB,CAKO,SAAS0J,GAAevE,EAAsB3J,GAEjD,ODjhCG,SAAuBsH,GAC1B,IAAKA,EAAOzO,oBACR,OAAO,KAGX,GAAIyO,EAAO3O,eAAgB,CACvB,MAAMyH,EAAS,EAAgBkH,EAAO3O,gBACtC,GAAIyH,EACA,OAAOA,EAAOrJ,OAElB,EAAS,QAAS,0BAA2B,CAAER,GAAI+Q,EAAO3O,gBAC9D,CAGA,GAAI2O,EAAO1O,aAAc,CACrB,MAAMuV,EAAS,EAAe7G,EAAO1O,cACrC,GAAIuV,EAAOtL,OAASsL,EAAOpX,OACvB,OAAOoX,EAAOpX,OAElB,EAAS,QAAS,wBAAyB,CAAE0E,MAAO0S,EAAO1S,OAC/D,CAEA,OAAO,IACX,CC0/BW2S,CADQzE,EAAMT,QAAQlJ,GAEjC,CA4EO,SAASqO,GAAc1E,GAC1B,MAAMF,EApEH,SAA4BE,GAC/B,IAAKA,EAAMV,QAAQhT,UAAY0T,EAAMZ,UACjC,OAAO,KAGX,MAAMmC,EAAkBvB,EAAMV,QAAQhT,QAAQ+U,SAExCsD,EAAc,CAChB,KAAK3E,EAAMZ,UAAUvS,mBACrB,GACA,eAAc,IAAIuE,MAAOwT,mBACzB,eAAe5E,EAAML,iBACrB,GACA,MACA,GACA4B,GA4BJ,GAxBIvB,EAAMV,QAAQ/S,SACdoY,EAAY9O,KACR,GACA,MACA,GACA,oBACA,GACAmK,EAAMV,QAAQ/S,QAAQ8U,UAK1BrB,EAAMV,QAAQjT,OACdsY,EAAY9O,KACR,GACA,MACA,GACA,oBACA,GACAmK,EAAMV,QAAQjT,MAAMgV,UAKxBrB,EAAMJ,iBAAiBtO,OAAS,EAAG,CACnCqT,EAAY9O,KACR,GACA,MACA,GACA,uBACA,IAGJ,IAAK,MAAMgP,KAAQ7E,EAAMJ,iBACrB+E,EAAY9O,KACR,iBAAiBgP,EAAKvD,UAAY,OAAOuD,EAAKnW,QAAQgD,gBACtD,GAAG,IAAIN,KAAKyT,EAAK1T,WAAWyT,mBAC5B,GAGZ,CAEA,OAAOD,EAAY9J,KAAK,KAC5B,CAMuBiK,CAAmB9E,GAEtC,OAAO,OAAP,wBACOA,GAAK,CACRF,cAER,C,yxBC5oCO,SAASiF,KACZ,MAAM,aAAEnS,GAAiBT,YAAYC,aACrC,MAAwB,UAAjBQ,GAA6C,cAAjBA,CACvC,CAKO,SAASoS,K,UACZ,MAAM9S,EAAUC,YAAYC,aACtBC,EAAW,IAEjB,OAAIA,EAASzC,mBACF,CACHR,QAAsC,QAA9B,EAAA8C,EAAQY,8BAAsB,eAAEC,yBAA0Bb,EAAQS,SAAW,UACrFtD,OAAqC,QAA9B,EAAA6C,EAAQY,8BAAsB,eAAEG,oBACR,QAA9B,EAAAf,EAAQY,8BAAsB,eAAEI,sBAChC,UACD+R,QAASF,MAIV,CACH3V,OAAQiD,EAASxC,iBAAiBT,OAClCC,MAAOgD,EAASxC,iBAAiBR,MACjC4V,QAASF,KAEjB,CAYO,SAAeG,GAClBlF,EACA3J,EACA8O,G,0CAEA,MAAMjT,EAAUC,YAAYC,aACtBC,EAAW,IAGjB,GAAI8S,aAAM,EAANA,EAAQC,QACR,MAAO,CAAEC,SAAS,EAAOvT,MAAO,wBAGpC,IAAKkO,EAAMZ,UACP,MAAO,CAAEiG,SAAS,EAAOvT,MAAO,yBAGpC,IAAKiT,KAED,OADA,EAAS,gBAAiB,CAAEnS,aAAcV,EAAQU,eAC3C,CAAEyS,SAAS,EAAOvT,MAAO,yDAIpC,MAAMwT,EAAa5B,GAAiB1D,EAAO3J,GAC3C,IAAKiP,EACD,MAAO,CAAED,SAAS,EAAOvT,MAAO,uCAIpC,MACMyC,EADSyL,EAAMT,QAAQlJ,GACHnH,oBAAsBqV,GAAevE,EAAO3J,GAAS,KAGzE4N,EAAkBsB,GACpBD,EACAtF,EAAMZ,UAAUvS,KAChBqF,EAAQ2R,OAAS,QAGrB,EAAS,OAAQ,4BAA6B,CAC1CxN,QACA+I,UAAWY,EAAMZ,UAAUvS,KAC3B+C,mBAAoByC,EAASzC,mBAC7B4V,gBAAiBjR,EACjBkR,WAAYlR,aAAU,EAAVA,EAAY1H,KACxB6Y,aAAczB,EAAgB3S,SAGlC,MAAMkT,QAAemB,GACjBtT,EAASvC,aACTmU,EACA1P,EACA4Q,EACA9S,EAASzC,oBAIb,OAAI4U,EAAOa,SAAW9Q,EAsE1B,SACI8M,EACAjU,GAEA,IACI,MAAM+L,EAASnH,KAAKoH,MAAMiI,GAG1B,GAAIjU,EAAOE,MAAMW,UAAYoJ,MAAMC,QAAQlK,EAAOE,MAAMW,UAAW,CAC/D,MAAM2X,EAAUxY,EAAOE,MAAMW,SAAS0F,QAClC9F,KAAWA,KAASsL,KAGxB,GAAIyM,EAAQtU,OAAS,EAMjB,OALA,EAAS,OAAQ,yEAA0E,CACvFsU,UACAH,WAAYrY,EAAOP,OAGhB,CACHwY,SAAS,EACThE,WACAwE,cAAc,EAG1B,CAGA,MAAO,CACHR,SAAS,EACThE,WACAwE,cAAc,EAEtB,CAAE,MAAOjS,GAQL,OAPA,EAAS,OAAQ,iEAAkE,CAC/E9B,MAAQ8B,EAAY0F,QACpBmM,WAAYrY,EAAOP,KACnBiZ,gBAAiBzE,EAASI,UAAU,EAAG,OAIpC,CACH4D,SAAS,EACThE,WACAwE,cAAc,EAEtB,CACJ,CApHeE,CAA2BvB,EAAOnD,SAAU9M,GAGhDiQ,CACX,G,CAqHA,SAAemB,GACX7V,EACAwV,EACA/Q,EACA4Q,EACAvV,G,0CAEA,IACI,IAAIyR,EAmBJ,OAhBIA,EADAzR,QA2DZ,SACIE,EACAwV,EACA/Q,EACA4Q,G,0CAEA,MAAM,YAAEa,EAAW,iBAAElI,GAAqB3L,YAAYC,aAGhD6T,EAAwBnI,EAAiBhO,GAS/C,GAPA,EAAS,UAAW,sBAAuB,CACvCoW,YAAa3R,EACbkR,WAAYlR,aAAU,EAAVA,EAAY1H,KACxB0F,mBAAoB0T,EAAsB3U,OAC1C6U,iBAAkBb,EAAWhU,SAG7B6T,aAAM,EAANA,EAAQC,QACR,MAAM,IAAIgB,aAAa,UAAW,cAGtC,MAAMC,QAAoBL,EAAY,CAClC9Y,OAAQ,CACJ,CAAEoZ,KAAM,SAAUnI,QAAS8H,GAC3B,CAAEK,KAAM,OAAQnI,QAASmH,IAE7B/Q,WAAYA,IAGhB,GAAI4Q,aAAM,EAANA,EAAQC,QACR,MAAM,IAAIgB,aAAa,UAAW,cAGtC,MAAM/E,EAAWkF,GAAaF,GAQ9B,OANA,EAAS,WAAY,uBAAwB,CACzC7Y,YAAa6Y,EACb/U,OAAQ+P,EAAS/P,OACjBkV,QAASnF,EAASI,UAAU,EAAG,OAG5BJ,CACX,G,CArG6BoF,CACb3W,EACAwV,EACA/Q,EACA4Q,SAsGhB,SACIrV,EACAwV,EACA/Q,EACA4Q,G,0CAEA,MAAM,sBAAEuB,EAAqB,iBAAE5I,GAAqB3L,YAAYC,aAE1DuL,EADW,IACO9N,iBAKlB8W,EAA0C,CAC5CC,QAAQ,EACRC,SAAU,CACN,CAAEP,KAAM,SAAUnI,QALIL,EAAiBhO,IAMvC,CAAEwW,KAAM,OAAQnI,QAASmH,IAE7BvS,uBAAwB4K,EAAOvO,OAC/BC,MAAOsO,EAAOtO,MACdC,YAAaqO,EAAOrO,YACpBwX,WAAYnJ,EAAOpO,UACnBwX,kBAAmBpJ,EAAOnO,iBAC1BwX,iBAAkBrJ,EAAOlO,gBACzBwX,MAAOtJ,EAAOjO,MAclB,GAXI6E,IACAoS,EAAeO,YAAc3S,GAGjC,EAAS,UAAW,gCAAiC,CACjDnF,OAAQuO,EAAOvO,OACfC,MAAOsO,EAAOtO,MACduX,QAAQ,EACRV,YAAa3R,IAGb4Q,aAAM,EAANA,EAAQC,QACR,MAAM,IAAIgB,aAAa,UAAW,cAGtC,MAAM5B,QAAekC,EAAsBS,YAAYR,GAQvD,IAAItF,EAGJ,GATA,EAAS,WAAY,oCAAqC,CACtD7T,YAAagX,EACb4C,WAA8B,mBAAX5C,EACnB6C,YAAa7C,GAA4B,iBAAXA,GAAuB8C,OAAOC,iBAAiB/C,IAM3D,mBAAXA,EACPnD,QAyBR,SACImG,EACArC,G,sDAEA,IAAIsC,EAAY,GAEhB,IACI,MAAMC,EAAYF,I,IAElB,IAA0B,IAAS,EAAT,UAAAE,KAAS,gCAAE,CAAX,eAAf,MAAMC,EAAK,EAElB,GAAIxC,aAAM,EAANA,EAAQC,QAER,MADA,EAAS,OAAQ,iBAAkB,CAAEwC,UAAWH,EAAUnW,SACpD,IAAI8U,aAAa,UAAW,cAGtC,MAAMyB,EAAWF,EAMjB,GAJ6B,iBAAlBE,EAASC,OAChBL,EAAYI,EAASC,MAGrBD,EAAS/V,MACT,MAAM,IAAIuH,MAAMkN,GAAasB,EAAS/V,OAE9C,C,qGACJ,CAAE,MAAOiW,GACL,GAA4B,eAAvBA,EAAclb,KACf,MAAMkb,EASV,GANA,EAAS,2BAA4B,CACjCjW,MAAOiW,EACPH,UAAWH,EAAUnW,SAIrBmW,EAIA,OAHA,EAAS,OAAQ,gDAAiD,CAC9DnW,OAAQmW,EAAUnW,SAEfmW,EAGX,MAAMM,CACV,CAGA,OADA,EAAS,OAAQ,kBAAmB,CAAEC,YAAaP,EAAUnW,SACtDmW,CACX,G,CA1EyBQ,CAAuBzD,EAAQW,QAC7C,GAAIX,GAA4B,iBAAXA,EAAqB,CAC7C,MAAM0D,EAAY1D,EAElB,GAAI0D,EAAUpW,MAEV,MADA,EAAS,qBAAsB0S,GACzB,IAAInL,MAAM,cAAcrH,KAAKC,UAAUuS,MAGjDnD,EAAWkF,GAAa2B,EAAU/J,SAAWqG,EACjD,MACInD,EAAWkF,GAAa/B,GAQ5B,OALA,EAAS,WAAY,iBAAkB,CACnClT,OAAQ+P,EAAS/P,OACjBkV,QAASnF,EAASI,UAAU,EAAG,OAG5BJ,CACX,G,CA9K6B8G,CACbrY,EACAwV,EACA/Q,EACA4Q,IAKJA,aAAM,EAANA,EAAQC,SACD,CAAEC,SAAS,EAAOvT,MAAO,wBAG/BuP,GAAgC,KAApBA,EAASpI,QAK1B,EAAS,OAAQ,sBAAuB,CACpCmP,eAAgB/G,EAAS/P,OACzBuU,eAAgBtR,IAGb,CACH8Q,SAAS,EACThE,WACAwE,eAAgBtR,KAZhB,EAAS,iBAAkB,MACpB,CAAE8Q,SAAS,EAAOvT,MAAO,2BAaxC,CAAE,MAAOiW,GAEL,GAA4B,eAAvBA,EAAclb,OAAyBsY,aAAM,EAANA,EAAQC,SAEhD,OADA,EAAS,OAAQ,qBAAsB,MAChC,CAAEC,SAAS,EAAOvT,MAAO,wBAGpC,EAAS,uBAAwB,CAC7BwH,QAASyO,aAAe1O,MAAQ0O,EAAIzO,QAAUwK,OAAOiE,KAIzD,MAAO,CAAE1C,SAAS,EAAOvT,MADJiW,aAAe1O,MAAQ0O,EAAIzO,QAAUwK,OAAOiE,GAErE,CACJ,G,CAoQA,SAASxB,GAAajZ,GAClB,GAAqB,iBAAVA,EAAoB,OAAOA,EACtC,GAAIA,QAAuC,MAAO,GAClD,GAAqB,iBAAVA,EACP,IACI,OAAO0E,KAAKC,UAAU3E,EAC1B,CAAE,SACE,OAAOwW,OAAOxW,EAClB,CAEJ,OAAOwW,OAAOxW,EAClB,CAMA,SAASiY,GACLuC,EACAhJ,EACAC,GAEA,OAAO+I,EACFxM,QAAQ,iBAAkBwD,GAC1BxD,QAAQ,iBAAkByD,EACnC,C,2SCjkBA,MAAMsJ,GAAa,IAAIC,IAoDvB,SAASC,GAAuBlI,GAC5B,MAAM,gBAAEmI,GAAoBrW,YAAYC,aAClC8P,EAAS9B,GAAmBC,GAE5BoI,EAASD,EAAgB,SAAUnI,EAAKoI,QAE9C,MAAO,qBACO,uBAAiC,uCAC/B,mDAED,kCACFA,qGAIK,wCACE,gBAA0BC,GAAWrI,EAAKxT,sCAC1C,8BACVqV,EAAO5Q,6BAA6B,6FAG5B,wBAAkC,2IAKpC,4BACV4Q,EAAOnO,KAAI0M,IAAKkI,MAUf,qBACO,oCACE,kBAA4B,gCAHxB9a,EATiB4S,GAYsDxU,kFAExE,kBAA4B4B,EAAM3B,sCAClC,+BAAyC2B,EAAM5B,oDAElD,+BAAyC,mBAA6B4B,EAAM5B,8BAC1E,iBAA2Byc,GAAW7a,EAAMP,6CATlE,IAAwBO,CATmB,IAAEgN,KAAK,mCAIlD,CA6GO,SAAS+N,GACZtJ,EACAuJ,EACAC,GAEA,MAAM,gBAAEN,GAAoBrW,YAAYC,aAExC,GAAuB,IAAnBkN,EAAQhO,QAsBZ,GAjBAuX,EAASE,UAAYzJ,EAAQvL,KAAI,EAAGsM,OAAMJ,SAASpE,KAC/C,MAAM4M,EAASD,EAAgB,SAAUnI,EAAKoI,QACxCO,EAAanN,IAAMiN,EACnBG,GAAe5I,EAAK5C,aAAe,kBAAkBgE,UAAU,EAAG,IAExE,MAAO,uBACK,mBAA6BuH,EAAa,WAAa,mBAAmB/I,4BACxE,2BAAqCwI,qEACrC,6CACG,oBAA8BC,GAAWrI,EAAKxT,wCAC9C,oBAA8B6b,GAAWO,KAAeA,EAAY3X,QAAU,GAAK,MAAQ,+CAG/G,IACEuJ,KAAK,IAGJiO,GAAiB,EAAG,CACpB,MAAMI,EAAeL,EAASM,cAAc,IAAI,4BAChDD,SAAAA,EAAcE,eAAe,CAAEC,MAAO,WAC1C,OAxBIR,EAASE,UAAY,eAAe,6CAyB5C,CAMA,SAASL,GAAWpb,GAChB,MAAM,UAAEgc,GAAcnX,YAAYyC,KAC5B2U,EAAuB,iBAAVjc,EAAqBA,EAAQwW,OAAOxW,QAAAA,EAAS,IAChE,OAAOgc,EAAUE,SAASD,EAAK,CAAEE,aAAc,IACnD,CCzOO,SAAS,GAAmBpJ,GAC/B,OAAOvU,EACF6H,QAAO9F,IACJ,MAAMmO,EAAMqE,EAAKxS,EAAM5B,KACvB,OAAO+P,GAAsB,iBAARA,GAAoBA,EAAI/C,OAAO3H,OAAS,CAAC,IAEjEyC,KAAIlG,IACD,MAAMP,EAAS+S,EAAKxS,EAAM5B,KAAgBgN,OAC1C,MAAO,CACHhN,IAAK4B,EAAM5B,IACXC,MAAO2B,EAAM3B,MACboB,QACAgT,UAAWhT,EAAMgE,OACjBnF,UAAW0B,EAAM1B,UACpB,GAEb,CChBO,SAASud,GACZlK,EACAE,EACAiK,EACAC,GAEA,MAAO,qBACO,6EAEE,0BACV,EAAO7V,KAAI,CAACsC,EAAOwF,IA0C7B,SACIxF,EACA2S,EACAa,EACAC,EACAC,GAEA,MAAMC,EAyBV,SAAuBH,GACnB,OAAQA,GACJ,IAAK,WAAY,MAAO,WACxB,IAAK,UAAW,MAAO,qBACvB,IAAK,UAAW,MAAO,aACvB,QAAS,OAAO,KAExB,CAhCuBI,CAAcJ,GAEjC,MAAO,qBACO,gBAA0BC,EAAW,SAAW,MAAM,WAAqBD,8DAG5E,kCACH,cAAwBxT,2BAChBA,eACZ2S,EAAa,UAAY,8CAGlB,eAAyBc,EAAW,SAAW,4BAC1CzT,sBACLjK,EAAaiK,4CAED7J,EAAY6J,2BACzBjK,EAAaiK,sBACnB2T,EAAa,sBAAsBA,KAAc,sBAAkC,8BAErFD,EAAe,eAAe,qBAA+Bf,EAAa,SAAW,aAAe,oBAG5G,CAxEmCkB,CAC3B7T,EACAmJ,EAAelJ,SAASD,GACxBqJ,EAAYrJ,GACZA,IAAUsT,EACV9N,EAAI,EAAOvK,OAAS,KACrBuJ,KAAK,+EAIQ,wDAEJ,iEAEH+O,EAA4B,GAAb,6JAMZ,4DAEHA,EAA4B,GAAb,2JAMZ,mMAShB,C,2SCyIO,SAAeO,K,0CAClB,MAAM,MAAEC,EAAK,aAAEC,GAAiBlY,YAAYC,aAEtCqL,QAAoB2M,EAAME,KAAKtR,MACjC,kBACA,sHACA,IAGJ,GAAoB,OAAhByE,GAAwBA,IAAgB4M,EAAaE,YAAc9M,EAAYxE,OAC/E,OAAO,KAIXuR,IAA4B,GAE5B,IACIC,OAAO5Q,KAAK,wBAEZ,MAAM2K,QPpIP,SAA6C/G,G,+CAKhD,MAAM,YAAEuI,GAAgB7T,YAAYC,aAEpC,IAAKqL,EAAYxE,OACb,MAAO,CAAEoM,SAAS,EAAOvT,MAAO,+CAGpC,IAOI,IAAI4Y,SANmB1E,EAAY,CAC/B9Y,OAAQ,GAAG6L,QAA+B0E,IAC1C3N,aAAc,yEAIKmJ,OACnByR,EAAQvP,WAAW,SACnBuP,EAAUA,EAAQpP,QAAQ,mBAAoB,IAAIA,QAAQ,UAAW,KAIzE,MAAMqP,EAAa,EAAeD,GAElC,IAAKC,EAAWzR,MACZ,MAAO,CACHmM,SAAS,EACTvT,MAAO,gCAAgC6Y,EAAW7Y,QAClD1E,OAAQsd,GAKhB,GAAuB,QAAnB,EAAAC,EAAW/Q,gBAAQ,eAAEtI,OAAQ,CAC7B,MAAM0F,EAAQqG,EAAcsN,EAAWvd,QACvC,MAAO,CACHiY,SAAS,EACTjY,OAAQ4E,KAAKC,UAAU+E,EAAO,KAAM,GAE5C,CAEA,MAAO,CACHqO,SAAS,EACTjY,OAAQ4E,KAAKC,UAAU0Y,EAAWvd,OAAQ,KAAM,GAExD,CAAE,MAAOwG,GACL,MAAO,CACHyR,SAAS,EACTvT,MAAO,sBAAuB8B,EAAY0F,UAElD,CACJ,G,CO+E6BsR,CAA8BnN,GAEnD,OAAI+G,EAAOa,SACPoF,OAAOpF,QAAQ,qBACRb,EAAOpX,SAEdqd,OAAO3Y,MAAM0S,EAAO1S,OAAS,qBAEtB0S,EAAOpX,QAAU,KAEhC,C,QACIod,IAA4B,EAChC,CACJ,G,CAKA,SAASA,GAA4BF,GACjC,MAAMO,EAAkBC,SAAS3B,cAAc,IAAI,qBAEnD,GAAImB,IAASO,EAAiB,CAC1B,MAAME,EAAUD,SAASE,cAAc,OACvCD,EAAQE,UAAY,GAAG,oBACvBF,EAAQhC,UAAY,6BACF,oKAKlB+B,SAASI,KAAKC,YAAYJ,EAC9B,MAAYT,GAAQO,GAChBA,EAAgBO,QAExB,CAEO,SAASC,GACZC,EACAjV,EACAsH,EACA4N,GAEA,MAAMxb,EAAgB,EAAiBsG,GACjCrG,EAAgB,EAAiBqG,GAGjCmV,EAAeF,EAAUnC,cAAc,IAAI,0BAC7CqC,IACAA,EAAazC,UAAY,mCAAmC0C,GAAoB1b,EAAe4N,EAAO7O,kBACtG0c,EAAale,MAAQqQ,EAAO7O,gBAAkB,GAC9C0c,EAAaE,SAAWH,GAI5B,MAAMI,EAAiBL,EAAUnC,cAAc,IAAI,mBACnD,GAAIwC,EAAgB,CAChB,IAAIC,EAAgBjO,EAAO5O,aAC3B,GAAI4O,EAAO7O,eAAgB,CACvB,MAAM2H,EAAS,EAAgBkH,EAAO7O,gBAClC2H,IAAQmV,EAAgBnV,EAAOvJ,OACvC,CAEIye,EAAere,QAAUse,IACzBD,EAAere,MAAQse,GAE3BD,EAAeD,SAAWH,EAG1B,MAAMjL,EAAYgL,EAAUnC,cAAc,IAAI,gBAC1C7I,IACAA,EAAUuL,YAAc,GAAGD,EAActa,OAAOsT,yBAExD,CAGA,MAAMkH,EAAmBR,EAAUnC,cAAc,IAAI,oBACjD2C,IACAA,EAAiBC,QAAUpO,EAAOzO,oBAClC4c,EAAiBJ,SAAWH,GAIhC,MAAMS,EAAgBV,EAAUnC,cAAc,IAAI,oBAC9C6C,GACAA,EAAcC,UAAUC,OAAO,UAAWvO,EAAOzO,qBAIrD,MAAMid,EAAeb,EAAUnC,cAAc,IAAI,0BAC7CgD,IACAA,EAAapD,UAAY,mCAAmC0C,GAAoBzb,EAAe2N,EAAO3O,kBACtGmd,EAAa7e,MAAQqQ,EAAO3O,gBAAkB,GAC9Cmd,EAAaT,SAAWH,GAI5B,MAAMa,EAAiBd,EAAUnC,cAAc,IAAI,mBACnD,GAAIiD,EAAgB,CAChB,IAAIC,EAAgB1O,EAAO1O,aAC3B,GAAI0O,EAAO3O,eAAgB,CACvB,MAAMyH,EAAS,EAAgBkH,EAAO3O,gBAClCyH,IAAQ4V,EAAgBra,KAAKC,UAAUwE,EAAOrJ,OAAQ,KAAM,GACpE,CACIgf,EAAe9e,QAAU+e,IACzBD,EAAe9e,MAAQ+e,GAE3BD,EAAeV,SAAWH,CAC9B,CAGI5N,EAAOzO,qBAuSf,SAAgCoc,EAAwBe,G,MAEpD,MAAMC,EAAiBhB,EAAUnC,cAAc,IAAI,mBAC/CmD,GACAA,EAAelB,SAGnB,IAAKiB,EAAcpT,OACf,OAGJ,MAAM0R,EAAa,EAAe0B,GAClC,IAAIE,EAAa,GAKbA,EAHC5B,EAAWzR,OAEc,QAAnB,EAAAyR,EAAW/Q,gBAAQ,eAAEtI,QACf,eAAe,6EAAuFqZ,EAAW/Q,SAAStI,0BAE1H,eAAe,uFAJf,eAAe,mEAA6E,GAAWqZ,EAAW7Y,OAAS,0BAO5I,MAAMsa,EAAiBd,EAAUnC,cAAc,IAAI,mBAC/CiD,GACAA,EAAeI,mBAAmB,WAAYD,EAEtD,CAhUQE,CAAuBnB,GAAWc,aAAc,EAAdA,EAAgB9e,QAAS,IAyBnE,SAAmCge,EAAwBe,G,QACvD,MAAMK,EAAcpB,EAAUnC,cAAc,IAAI,yBAC1CwD,EAASrB,EAAUnC,cAAc,IAAI,oBACrCyD,EAAYtB,EAAUnC,cAAc,IAAI,uBAExC0D,EAAaR,EAAcpT,OAAO3H,OAAS,EAE7Cob,IACAA,EAAYhB,UAAYmB,GAGxBD,IACAA,EAAUlB,UAAYmB,GAG1B,GAAIF,GAAUE,EAAY,CACtB,MAAMlC,EAAa,EAAe0B,GAE5BS,GAAuC,QAA3B,EAAmB,QAAnB,EAAAnC,EAAW/Q,gBAAQ,eAAEtI,cAAM,QAAI,GAAK,IAAMqZ,EAAWzR,MACvEyT,EAAOjB,UAAYoB,CACvB,MAAWH,IACPA,EAAOjB,UAAW,EAE1B,CA5CIqB,CAA0BzB,GAAWc,aAAc,EAAdA,EAAgB9e,QAAS,IAG9D,MAAM0f,EAAS1B,EAAUnC,cAAc,IAAI,mBACvC6D,IACAA,EAAOtB,SAAWH,EAEdyB,EAAOjE,UADPwC,EACmB,yDAEA,wCAAwCnf,EAAaiK,4BAkJpF,SAAiCiV,EAAwB3N,G,QACrD,MAAMgO,EAAiBL,EAAUnC,cAAc,IAAI,mBAC7CiD,EAAiBd,EAAUnC,cAAc,IAAI,mBAE7C8D,EAAgB3B,EAAUnC,cAAc,IAAI,4BAC5C+D,EAAgB5B,EAAUnC,cAAc,IAAI,4BAElD,GAAI8D,GAAiBtB,EAAgB,CACjC,MAAMwB,EAAgBxB,EAAere,MAAM2L,OACrCmU,EAAezP,EAAO7O,iBACgB,QAAtC,IAAgB6O,EAAO7O,uBAAe,eAAE5B,SACxC,GAGA2f,EAAaM,EAAc7b,OAAS,EACpC+b,EAAcF,IAAkBC,EACtCH,EAAcvB,UAAYmB,GAAyC,OAA1BlP,EAAO7O,iBAA4Bue,CAChF,CAEA,GAAIH,GAAiBd,EAAgB,CACjC,MAAMkB,EAAgBlB,EAAe9e,MAAM2L,OACrCsU,EAAe5P,EAAO3O,eACtBgD,KAAKC,UAAgD,QAAtC,IAAgB0L,EAAO3O,uBAAe,eAAE5B,OAAQ,KAAM,GACrE,GAGAyf,EAAaS,EAAchc,OAAS,EACpC+b,EAAcC,IAAkBC,EAChCC,IAAUX,GAAa,EAAeS,GAAepU,MAC3DgU,EAAcxB,UAAYmB,IAAeW,GAAsC,OAA1B7P,EAAO3O,iBAA4Bqe,CAC5F,CACJ,CA5KII,CAAwBnC,EAAW3N,EACvC,CA2QA,SAAS8N,GAAoBiC,EAA0CC,GACnE,OAAOD,EAAQ3Z,KAAI2B,IACf,MAAMkY,EAAWlY,EAAE9I,KAAO+gB,EAAa,WAAa,GAC9CE,EAAOnY,EAAE3I,UAAY,KAAO,KAClC,MAAO,kBAAkB2I,EAAE9I,OAAOghB,KAAYC,KAAQ,GAAWnY,EAAE7I,gBAAgB,IACpFgO,KAAK,GACZ,CA8BA,SAAS,GAAWiN,GAChB,MAAM,UAAEwB,GAAcnX,YAAYyC,KAClC,OAAO0U,EAAUE,SAAS1B,EAAM,CAAE2B,aAAc,IACpD,CChoBO,SAASqE,GAAezM,EAAkB0M,GAC7C,MAAM,SAAEC,EAAQ,UAAE1E,GAAcnX,YAAYyC,KACtCkT,EAA2B,iBAAbzG,EAAwBA,EAAWyC,OAAOzC,QAAAA,EAAY,IAgBpE4M,EAAU,eAAeF,uBAdb,IAAIC,EAASE,UAAU,CACrCC,QAAQ,EACRC,eAAe,EACfC,kBAAkB,EAClBC,iBAAkB,EAClBC,cAAc,EACdC,WAAW,EACXC,sBAAsB,EACtBC,OAAO,EACPC,oBAAoB,EACpBC,oBAAoB,IAGDC,SAAS/G,WAGhC,OAAOwB,EAAUE,SAASyE,EAC9B,CAKO,SAASa,GACZzN,EACAjU,EACA2gB,G,MAEA,MAAM,UAAEzE,GAAcnX,YAAYyC,KAC5BkT,EAA2B,iBAAbzG,EAAwBA,EAAWyC,OAAOzC,QAAAA,EAAY,IAEpElI,EAeH,SAAiCkI,GACpC,IACI,OAAOrP,KAAKoH,MAAMiI,EACtB,CAAE,SAEE,MAAMY,EAAiBZ,EAAS9H,MAAM,gCACtC,GAAI0I,EACA,IACI,OAAOjQ,KAAKoH,MAAM6I,EAAe,GAAGhJ,OACxC,CAAE,SACE,OAAO,IACX,CAEJ,OAAO,IACX,CACJ,CA9BmB,CAAwB6O,GAEvC,IAAK3O,GAA4B,iBAAXA,EAClB,OAAO2U,GAAehG,EAAMiG,GAGhC,MACMgB,EAqDV,SACI9d,EACA7D,EACA2gB,GAEA,MAAMiB,EA4TV,SAAqB/d,GACjB,MAAMge,EAAe,CAAC,eAAgB,aAAc,UAAW,QAAS,QAAS,UAEjF,IAAK,MAAMnW,KAAWmW,EAClB,IAAK,MAAMhjB,KAAOF,OAAO0O,KAAKxJ,GAC1B,GAAIhF,EAAIoS,cAAc/C,QAAQ,KAAM,MAAQxC,GAAgC,iBAAd7H,EAAKhF,GAC/D,OAAOA,EAKnB,OAAO,IACX,CAxUoBijB,CAAYje,GACtBke,EAAYH,EAAU/d,EAAK+d,GAAW,KAEtCxO,EAAqB,GAGvBwO,GAAgC,iBAAdG,GAClB3O,EAAS3K,KAmBjB,SAAoB5J,EAAaqB,EAAeygB,GAC5C,MAAM7hB,EAAQkjB,GAAYnjB,GACpBojB,EAAQC,GAAchiB,EAAQ,GAAKA,EAAQ,GAAKA,GAChDiiB,EAAUC,OAAOC,UAAUniB,GAASA,EAAQA,EAAMoiB,QAAQ,GAC1D1U,EAAM1N,EAAQ,GAAK,IAAM,GAE/B,MAAO,qBACOygB,+BACEA,iBAA0B,GAAW7hB,+BACrC6hB,+BAAwCsB,gBAClDE,iBAAuBxB,gBAAyB/S,wCAI1D,CAjCsB2U,CAAWX,EAASG,EAAWpB,IAIjD,MAAMrgB,EAAcN,EAAOM,YAAc,CAAC,EACpC+M,EAAO1O,OAAO0O,KAAK/M,GAAY4D,OAAS,EAAIvF,OAAO0O,KAAK/M,GAAc3B,OAAO0O,KAAKxJ,GAExF,IAAK,MAAMhF,KAAOwO,EAAM,CACpB,GAAIxO,IAAQ+iB,EAAS,SACrB,MAAM1hB,EAAQ2D,EAAKhF,GACnB,QAAcoI,IAAV/G,EAAqB,SAEzB,MAAMsiB,EAAaliB,EAAWzB,IAAQ,CAAEuB,KAAMqiB,GAAUviB,IACxDkT,EAAS3K,KAAKia,GAAY7jB,EAAKqB,EAAOsiB,EAA+B7B,EAAY,GACrF,CAEA,MAAO,eAAeA,yBAAkCvN,EAAS3F,KAAK,WAC1E,CAlFiBkV,CAAqB5W,EADD,QAAb,EAAA/L,aAAM,EAANA,EAAQE,aAAK,QAAI0iB,GAAY7W,GACiC4U,GAElF,OAAOzE,EAAUE,SAASuF,EAC9B,CA0BA,SAASiB,GAAY/e,GACjB,GAAa,OAATA,EAAe,MAAO,CAAEzD,KAAM,QAClC,GAAI6J,MAAMC,QAAQrG,GACd,MAAO,CACHzD,KAAM,QACNI,MAAOqD,EAAKK,OAAS,EAAI0e,GAAY/e,EAAK,IAAM,CAAEzD,KAAM,WAGhE,GAAoB,iBAATyD,EAAmB,CAC1B,MAAMvD,EAA8C,CAAC,EACrD,IAAK,MAAOzB,EAAKqB,KAAUvB,OAAOyQ,QAAQvL,GACtCvD,EAAWzB,GAAO+jB,GAAY1iB,GAElC,MAAO,CAAEE,KAAM,SAAUE,aAC7B,CACA,MAAO,CAAEF,YAAayD,EAC1B,CAMA,MAAMgf,GAAY,EAiDlB,SAASH,GACL7jB,EACAqB,EACAF,EACA2gB,EACAmC,GAEA,GAAIA,EAAQD,GACR,OAwOR,SAAoBhf,EAAe8c,GAC/B,MAAM,KAAEoC,GAAShe,YAAYyC,KACvBwb,EAAOpe,KAAKC,UAAUhB,EAAM,KAAM,GAClCof,EAAcF,EAAKG,UAAUF,EAAM,CAAEG,SAAU,SAAUjjB,MAC/D,MAAO,eAAeygB,8BAAuCsC,gBACjE,CA7OeG,CAAWljB,EAAOygB,GAG7B,MAAM7hB,EAAQkjB,GAAYnjB,GACpBuB,EAAOJ,EAAOI,MAAQqiB,GAAUviB,GAEtC,GAAa,UAATE,GAAoB6J,MAAMC,QAAQhK,GAClC,OAiBR,SACIpB,EACA0B,EACAR,EACA2gB,EACAmC,GAEA,GAAqB,IAAjBtiB,EAAM0D,OACN,MAAO,uBACKyc,kCACEA,kBAA2B,GAAW7hB,iCACtC6hB,iBAA0BA,4CAK5C,MAAM0C,EAAcrjB,EAAOQ,OAAS,CAAEJ,KAAMqiB,GAAUjiB,EAAM,KAG5D,GAAIA,EAAM8iB,MAAMC,IAAgB,CAC5B,MAAMC,EAAYhjB,EAAMmG,KAAIyD,GAAQ,OAkL5C,SAA2BvG,EAAe8c,GACtC,GAAoB,kBAAT9c,EACP,OAAO4f,GAAc5f,EAAM8c,GAE/B,GAAoB,iBAAT9c,EACP,MAAO,gBAAgB8c,UAAmB9c,EAAK2T,0BAEnD,OAAO,GAAWd,OAAO7S,GAC7B,CA1LmD6f,CAAkBtZ,EAAMuW,YAAoBlT,KAAK,IAC5F,MAAO,uBACKkT,kCACEA,kBAA2B,GAAW7hB,gCACvC6hB,WAAoB6C,4BAGrC,CAGA,MAAMG,EAAQnjB,EAAMmG,KAAI,CAACyD,EAAMyI,IACP,iBAATzI,GAA8B,OAATA,EAcxC,SACIvG,EACA7D,EACA2gB,EACAmC,EACAc,GAEA,MAAMtjB,EAAcN,EAAOM,YAAc,CAAC,EACpC+M,EAAO1O,OAAO0O,KAAK/M,GAAY4D,OAAS,EAAIvF,OAAO0O,KAAK/M,GAAc3B,OAAO0O,KAAKxJ,GAGlFggB,EAAWxW,EAAKlE,MAAK2a,GAAwB,iBAAZjgB,EAAKigB,IAAoBjgB,EAAKigB,GAAc5f,OAAS,MACtF6f,EAAW1W,EAAKlE,MAAK2a,GAAwB,iBAAZjgB,EAAKigB,IAAqBjgB,EAAKigB,IAAiB,GAAMjgB,EAAKigB,IAAiB,MAC7GE,EAAU3W,EAAKlE,MAAK2a,GAAwB,iBAAZjgB,EAAKigB,IAAoBjgB,EAAKigB,GAAc5f,QAAU,IAAM4f,IAAMD,IAExG,IAAII,EAAS,GACb,GAAIJ,GAAYE,EAAU,CACtB,MAAMG,EAAYL,EACZ,gBAAgBlD,iBAA0B,GAAWjK,OAAO7S,EAAKggB,cACjE,GACAM,EAAYJ,EACZK,GAAYvgB,EAAKkgB,GAAqBpD,GACtC,GACNsD,EAAS,eAAetD,kBAA2BuD,IAAYC,SACnE,CAEA,IAAIrG,EAAO,GACPkG,IACAlG,EAAO,eAAe6C,gBAAyB0D,GAAe3N,OAAO7S,EAAKmgB,IAAWrD,YAGzF,MACM2D,EADgBjX,EAAK9G,QAAOud,GAAKA,IAAMD,GAAYC,IAAMC,GAAYD,IAAME,IACjDrd,KAAImd,IAChC,MAAMjc,EAAIhE,EAAKigB,GACf,QAAU7c,IAANY,EAAiB,MAAO,GAE5B,OAAO6a,GAAYoB,EAAGjc,EADHvH,EAAWwjB,IAAM,CAAE1jB,KAAMqiB,GAAU5a,IACE8Y,EAAYmC,EAAQ,EAAE,IAC/Evc,OAAOge,SAAS9W,KAAK,IAElB+W,EAAQF,EAAY,eAAe3D,iBAA0B2D,UAAoB,GAEvF,MAAO,eAAe3D,WAAoBsD,IAASnG,IAAO0G,SAC9D,CAvDmBC,CAAWra,EAAiCiZ,EAAY1C,EAAYmC,EAAQ,GAEhF,eAAenC,WAAoB+D,GAAYta,EAAMiZ,EAAY1C,aACzElT,KAAK,IAER,MAAO,qBACOkT,gCACEA,kBAA2B,GAAW7hB,+BACtC6hB,YAAqBgD,yBAGzC,CA5DegB,CAAiB7lB,EAAOoB,EAAOF,EAAQ2gB,EAAYmC,GAG9D,GAAa,WAAT1iB,GAAsC,iBAAVF,GAAgC,OAAVA,EAClD,OAsGR,SACIpB,EACA+E,EACA7D,EACA2gB,EACAmC,GAEA,MAAMxiB,EAAcN,EAAOM,YAAc,CAAC,EAGpCwU,GAFOnW,OAAO0O,KAAK/M,GAAY4D,OAAS,EAAIvF,OAAO0O,KAAK/M,GAAc3B,OAAO0O,KAAKxJ,IAEpE8C,KAAImd,IACpB,MAAMjc,EAAIhE,EAAKigB,GACf,QAAU7c,IAANY,EAAiB,MAAO,GAE5B,OAAO6a,GAAYoB,EAAGjc,EADHvH,EAAWwjB,IAAM,CAAE1jB,KAAMqiB,GAAU5a,IACE8Y,EAAYmC,EAAQ,EAAE,IAC/Evc,OAAOge,SAAS9W,KAAK,IAExB,MAAO,qBACOkT,gCACEA,kBAA2B,GAAW7hB,+BACtC6hB,aAAsB7L,yBAG1C,CA7He8P,CAAkB9lB,EAAOoB,EAAkCF,EAAQ2gB,EAAYmC,GAG1F,MAAM+B,EAAWH,GAAYxkB,EAAOF,EAAQ2gB,EAAY9hB,GAExD,MAAO,qBACO8hB,gCACEA,kBAA2B,GAAW7hB,+BACtC6hB,kBAA2BkE,yBAG/C,CAoHA,SAASH,GACLxkB,EACAF,EACA2gB,EACAmE,GAEA,GAAI5kB,QACA,MAAO,gBAAgBygB,mBAK3B,OAFa3gB,EAAOI,MAAQqiB,GAAUviB,IAGlC,IAAK,SACD,OAWZ,SAAsB2D,EAAc7D,EAAyB2gB,GACzD,IAAK9c,EAAKgI,OACN,MAAO,gBAAgB8U,0BAG3B,MAAMpR,EAASvP,EAAOuP,OAEtB,GAAe,QAAXA,GAA+B,QAAXA,IA4Hb4M,EA5HuCtY,EA6H3C,gBAAgBwI,KAAK8P,IA7H6B,CACrD,MAAMgG,EAAUte,EAAKK,OAAS,GAAKL,EAAKwQ,UAAU,EAAG,IAAM,MAAQxQ,EACnE,MAAO,YAAY,GAAWA,6CAAgD8c,WAAoB,GAAWwB,QACjH,CAyHJ,IAAehG,EAvHX,GAAe,UAAX5M,GA2HR,SAAiB4M,GACb,MAAO,6BAA6B9P,KAAK8P,EAC7C,CA7H8B4I,CAAQlhB,GAC9B,MAAO,mBAAmB,GAAWA,cAAiB8c,WAAoB,GAAW9c,SAGzF,GAAIA,EAAKK,OAAS,KAAOL,EAAKqF,SAAS,MACnC,OAAOmb,GAAexgB,EAAM8c,GAGhC,MAAO,SAAS,GAAW9c,WAC/B,CAhCmBmhB,CAAa9kB,EAAiBF,EAAQ2gB,GACjD,IAAK,SACL,IAAK,UACD,OAoCZ,SACI9c,EACA7D,EACA2gB,EACAmE,GAEA,MAAMhmB,EAAQ4X,OAAO1W,EAAOilB,OAASjlB,EAAOqQ,aAAeyU,GAAa,IAAI7T,cAE5E,GAiFJ,SAAwBnS,EAAeoB,GAEnC,QADmB,CAAC,QAAS,SAAU,OAAQ,QAAS,QAAS,aAAc,WAChEyV,MAAKuP,GAAQpmB,EAAMoK,SAASgc,UACvChlB,GAAS,GAAKA,GAAS,IAAMkiB,OAAO+C,SAASjlB,QAC7CA,GAAS,GAAKA,GAAS,KAAOkiB,OAAOC,UAAUniB,IAEvD,CAvFQklB,CAAetmB,EAAO+E,GACtB,OAAOugB,GAAYvgB,EAAM8c,GAG7B,MAAM0E,EAAYxhB,EAAK2T,oBAAevQ,EAAW,CAAEqe,sBAAuB,IAC1E,MAAO,gBAAgB3E,UAAmB0E,UAC9C,CAlDmBE,CAAarlB,EAAiBF,EAAQ2gB,EAAYmE,GAC7D,IAAK,UACD,OAAOrB,GAAcvjB,EAAkBygB,GAC3C,QACI,MAAO,SAAS,GAAWjK,OAAOxW,aAE9C,CAyBA,SAASmkB,GAAexgB,EAAc8c,GAElC,MAAO,eAAeA,WADJD,GAAe7c,EAAM8c,UAE3C,CAkBA,SAASyD,GAAYvgB,EAAc8c,GAM/B,MAAO,gBAAgBA,0BAJTuB,GADKre,EAAO,GAAKA,EAAO,GAAKA,OAE3Bue,OAAOC,UAAUxe,GAAQA,EAAOA,EAAKye,QAAQ,kBAG8B3B,iBAF/E9c,EAAO,GAAK,IAAM,kBAGlC,CAEA,SAAS4f,GAAc5f,EAAe8c,GAGlC,MAAO,gBADK9c,EAAO,GAAG8c,QAAmB,GAAGA,8BAD/B9c,EAAO,kBAAoB,2BAEwBA,EAAO,MAAQ,aACnF,CAuBA,SAAS,GAAW3D,GAChB,MAAM,UAAEgc,GAAcnX,YAAYyC,KAC5B2U,EAAuB,iBAAVjc,EAAqBA,EAAQwW,OAAOxW,QAAAA,EAAS,IAChE,OAAOgc,EAAUE,SAASD,EAAK,CAAEE,aAAc,IACnD,CAEA,SAASoG,GAAUviB,GACf,OAAc,OAAVA,EAAuB,OACvB+J,MAAMC,QAAQhK,GAAe,eACnBA,CAClB,CAEA,SAASqjB,GAAcrjB,GACnB,MAAwB,iBAAVA,GAAuC,iBAAVA,GAAuC,kBAAVA,GAAiC,OAAVA,CACnG,CAEA,SAAS8hB,GAAYnjB,GACjB,OAAOA,EACFqP,QAAQ,KAAM,KACdA,QAAQ,kBAAmB,SAC3BA,QAAQ,SAAS+H,GAAKA,EAAE3R,eACjC,CAwBA,SAAS4d,GAAcjjB,GACnB,OAAIA,GAAS,EAAU,0BACnBA,GAAS,EAAU,0BAChB,yBACX,CCraA,SAASumB,GAAcvc,GACnB,MAAO,qBACO,kGAECjK,EAAaiK,gCACZ,4IAMpB,CAkBA,SAASwc,GAAkBxc,EAAkBwT,GACzC,IAAIvQ,EAAU,OAAOlN,EAAaiK,oBAC9BwX,EAAO,UAOX,MALe,YAAXhE,IACAvQ,EAAU,GAAGlN,EAAaiK,iBAC1BwX,EAAO,cAGJ,qBACO,qDACSA,qBAChBvU,uBAGX,CAEA,SAASwZ,GAAazc,EAAkBmO,GACpC,MAAMuO,EAAmBvO,EAAOqB,aAC1BiJ,GAAyBtK,EAAOnD,SAAU,KAAM,GAChDyM,GAAetJ,EAAOnD,SAAU,GAEhClQ,EAAY,IAAIC,KAAKoT,EAAOrT,WAAW6hB,qBAG7C,IAAIC,EAAe,GACnB,GAAc,YAAV5c,EAAqB,CAErB4c,EAwCR,SAA4BvkB,GAaxB,MAAO,sBACQ,WAAqB,mBAA6B,aAAuBA,iCAbxC,CAC5CwkB,OAAQ,kBACRC,iBAAkB,YAClBC,WAAY,iBAWa1kB,mBARoB,CAC7CwkB,OAAQ,SACRC,iBAAkB,aAClBC,WAAY,cAML1kB,qBAGf,CA3DuB2kB,CADCrS,GAAewD,EAAOnD,UAE1C,CAEA,MAAO,qBACO,wEAEE,4CACE,4CACG,YAAsBjV,EAAaiK,wBAChD4c,6BACa,mBAA6B9hB,uBAC1CqT,EAAO8O,OAAS,gBAAgB,WAAqB,iEAA6E,2CAExH,2IAEE,sBAAgC,cAAwB9O,EAAO8O,OAAS,SAAW,sHAGnF,wBAAkC,cAAwB9O,EAAO8O,OAAS,GAAK,wIAG/E,sBAAgC,8LAOpC,6BACVP,6EAIU,yBAAmC,+GAKvD,CA8BO,SAASQ,GACZjI,EACAjV,EACAmO,EACAqF,EACA0B,EACAiI,EACAC,G,MAEA,MAAMC,EAAoBnI,GAA2B,YAAX1B,EACpC8J,EAAmBnP,IAAWkP,EAC9BE,GAAyBpP,IAAWkP,EAG1C,GAAIA,EAEA,YADApI,EAAUvC,UAAY6J,GAAcvc,IAIxC,GAAIud,EAEA,YADAtI,EAAUvC,UAAY8J,GAAkBxc,EAAOwT,IAInD,GAAI8J,EAAkB,CAElB,MAAME,EAAkBvI,EAAUnC,cAAc,IAAI,qBAC9C2K,EAA2E,QAAvD,EAAAxI,EAAUnC,cAAc,IAAI,yBAA2B,eAAE0C,YAC7EkI,EAAe,IAAI3iB,KAAKoT,EAAOrT,WAAW6hB,qBAE3Ca,GAAmBC,IAAsBC,IAC1CzI,EAAUvC,UAAY+J,GAAazc,EAAOmO,GAElD,CAGA,MAAMwP,EAAS1I,EAAUnC,cAAc,IAAI,oBACvC6K,GAAUxP,IACVwP,EAAOjL,UAaf,SACI1S,EACAmO,EACAgP,EACAC,GAEA,MAAMQ,EAAoB,GAGrBzP,EAAO8O,QACRW,EAAQpe,KAAK,uBACD,8IAQF,YAAVQ,GAAuBod,EAASrU,WAEhC6U,EAAQpe,KAAK,uBACD,mCAA6C,mIAO7D,GAAc,YAAVQ,EAAqB,CACrB,MAAM3H,EAAUsS,GAAewD,EAAOnD,UAItC,GAHwBX,GAAU+S,GAGd9S,OAAQ,CACxB,MAAMuT,EAA4B,qBAAZxlB,EACtBulB,EAAQpe,KAAK,yBACH,oCAA8Cqe,EAAgB,EAAc,sBAAwB,uGAG9GT,EAAS9T,eAAiB,EAAI,gBAAgB,uBAAiC8T,EAAS9T,eAAiB,WAAa,gCAG1H,CAGA,GAAI8T,EAASnU,QAAQhT,UAAYmnB,EAASnU,QAAQhT,QAAQgnB,OAAQ,CAC9D,MAAMY,EAA4B,WAAZxlB,EACtBulB,EAAQpe,KAAK,yBACH,oCAA8Cqe,EAAgB,EAAc,sBAAwB,sHAKlH,CACJ,CAGIV,GAAuB,YAAVnd,GACb4d,EAAQpe,KAAK,uBACD,sCAAgD,gGAExCzJ,EAAaonB,oCAMjC/P,GAAUgQ,IACVQ,EAAQpe,KAAK,uBACD,2IAOhB,MAAO,eAAe,qBAA+Boe,EAAQpZ,KAAK,WACtE,CA3F2BsZ,CAAoB9d,EAAOmO,EAAQgP,EAAWC,IAIrE,MAAMW,EAAU9I,EAAUnC,cAAc,IAAI,cACtCkL,EAAY/I,EAAUnC,cAAc,IAAI,gBAE1CiL,GAAWC,IACXD,EAAQnI,UAAUC,OAAO,YAAY1H,aAAM,EAANA,EAAQ8O,SAC7Ce,EAAUpI,UAAUC,OAAO,WAAW1H,aAAM,EAANA,EAAQ8O,SAEtD,CC9LO,SAASgB,GACZC,EACAC,EACAC,GAEA,GAAuB,IAAnBF,EAAQjjB,QAAqC,IAArBkjB,EACxB,MAAO,GAIX,MAAME,EAAeD,EAKI,IAAnBF,EAAQjjB,OACJ,eAAe,kDACfijB,EAAQxgB,KAAI,CAAC8Q,EAAMhJ,IAAM8Y,GAAoB9P,EAAMhJ,KAAIhB,KAAK,IANhE,eAAe,mJAQrB,MAAO,qBACO,4BAAsC,4CACpC,6IAGG,sBAAgC2Z,EAAmB,EAAI,aAAaA,EAAmB,IAAM,qDAEhG,+BACVE,iCAIV,CAEA,SAASC,GAAoB9P,EAAyB5E,GAClD,MAAM2U,EAAcC,GAAehQ,EAAKnW,SAClComB,EAAeC,GAAgBlQ,EAAKnW,SACpCsF,EAAO,IAAI5C,KAAKyT,EAAK1T,WAAW6hB,qBAEtC,MAAO,qBACO,oBAA8B8B,kBAA6B7U,0BACzD,mDACG,qBAA+B4E,EAAKvD,UAAY,kCAChD,uDACQsT,sBACnBI,GAAcnQ,EAAKnW,mDAER,qBAA+BsF,6CAElC,kCACV,GAAW6Q,EAAKrD,uDAEN,4DAED,8DACKvB,sLAOL,4DACKA,gKASxB,CAEA,SAAS4U,GAAenmB,GACpB,OAAQA,GACJ,IAAK,SAAU,MAAO,kBACtB,IAAK,mBAAoB,MAAO,YAChC,IAAK,aAAc,MAAO,gBAC1B,QAAS,MAAO,qBAExB,CAEA,SAASqmB,GAAgBrmB,GACrB,MAAO,GAAG,aAAuBA,GACrC,CAEA,SAASsmB,GAActmB,GACnB,OAAQA,GACJ,IAAK,SAAU,MAAO,WACtB,IAAK,mBAAoB,MAAO,aAChC,IAAK,aAAc,MAAO,aAC1B,QAAS,MAAO,UAExB,CAkFA,SAAS,GAAWpB,GAChB,MAAM,UAAEgc,GAAcnX,YAAYyC,KAC5B2U,EAAuB,iBAAVjc,EAAqBA,EAAQwW,OAAOxW,QAAAA,EAAS,IAChE,OAAOgc,EAAUE,SAASD,EAAK,CAAEE,aAAc,IACnD,C,2SCrKO,SAAewL,GAAkBC,G,0CACpC,MAAM,MAAE9K,EAAK,WAAE+K,GAAehjB,YAAYC,cACpC,UAAEkX,GAAcnX,YAAYyC,KAE5BuJ,EA4BV,WACI,MAAM9L,EAAW,IACXsL,EAAStL,EAASxC,kBAClB,OAAEulB,GAAWjjB,YAAYyC,KAE/B,MAAO,qBACO,yBAAmC,yCACjC,6LAMA,6CACE,0JAKA,6CACI,4FAGN,0CACJvC,EAASzC,mBAAqB,UAAY,wIAMvC,+BAAyCyC,EAASzC,mBAAqB,SAAW,+BAC7E,8CACE,sFAEE,0FAEF,qFAEE,2GAIJ,mBAA6B,gDAC3B,iGAEe,wCAAkD+N,EAAOrO,yFAExE,uGAEe,0CAAoDqO,EAAOpO,6FAE1E,qGAEe,wCAAkDoO,EAAOnO,+FAExE,qGAEe,wCAAkDmO,EAAOlO,8FAExE,kGAEe,yCAAmDkO,EAAOjO,mKAO/E,6CACE,yJAKF,oGAGJ,gDACa,2DAElB,GAAW2C,EAASvC,mDAET,gDACA,0BAAoCuC,EAASvC,aAAawB,OAAOsT,wDAC/D,uOAQJ,6CACE,mKAKF,wNAGJ,oDACa,2DAElB,GAAWvS,EAASnC,uDAET,gDACA,8BAAwCmC,EAASnC,iBAAiBoB,OAAOsT,wDACvE,2OAQJ,6CACE,sJAKA,2CACE,gFAED,iCAA2C,kCAClDyQ,GAAiB,0EAGT,gFAED,iCAA2C,kCAClDA,GAAiB,0FAKX,kDACE,sKAIA,oOAQJ,6CACE,iKAKA,6CACE,0JAIA,iMAQJ,6CACE,+IAKA,6CACI,4FAGN,gCACJhjB,EAASlC,UAAY,UAAY,+HAM3B,4CACE,sJAIA,oJAIA,yKAML,8BAAwC,mDACtC,4BAAsC,gDACtC,8BAAwC,gIAKzC,6CACG,8CAAwDilB,IAASzY,OAAO,6DAI/F,CAjPoB2Y,GAEF,IAAIlL,EAAMd,EAAUE,SAASrL,GAAUgX,EAAWI,KAAM,GAAI,CACtEC,MAAM,EACNC,OAAO,EACPC,wBAAwB,EACxBC,SAAU,eACVC,cAAc,IAGZtL,OAAOuL,MAAK,KACdX,SAAAA,IACA,EAAS,OAAQ,wBAAyB,KAAK,UAI7C,IAAIY,SAAcC,GAAWC,WAAWD,EAAS,KA6P3D,WACI,MAAME,EAAQnL,SAASoL,eAAe,GAAG,oBACzC,IAAKD,EAAO,OAGZ,MAAME,EAAqBF,EAAM9M,cAAc,IAAI,0BAC7CiN,EAAeH,EAAM9M,cAAc,IAAI,uBAE7CgN,SAAAA,EAAoBE,iBAAiB,UAAU,KAC3CrgB,EAAc,qBAAsBmgB,EAAmBpK,SACvDqK,SAAAA,EAAcnK,UAAUC,OAAO,SAAUiK,EAAmBpK,QAAQ,IAIxE,MAAMuK,EAAYL,EAAM9M,cAAc,IAAI,gBACpCoN,EAAWN,EAAM9M,cAAc,IAAI,eACnCqN,EAAUP,EAAM9M,cAAc,IAAI,cAClCsN,EAAYR,EAAM9M,cAAc,IAAI,gBACpCuN,EAAUT,EAAM9M,cAAc,IAAI,cAClCwN,EAAUV,EAAM9M,cAAc,IAAI,cAClCyN,EAAUX,EAAM9M,cAAc,IAAI,eAExCmN,SAAAA,EAAWD,iBAAiB,UAAU,KAClCpgB,EAAuB,CAAE7G,OAAQknB,EAAUhpB,QAC3CupB,GAAoBP,EAAUhpB,MAAM,IAGxCipB,SAAAA,EAAUF,iBAAiB,UAAU,KACjCpgB,EAAuB,CAAE5G,MAAOknB,EAASjpB,OAAQ,IAGrD,MAAMwpB,EAAoB,CAAC9d,EAAyB/M,EAA6B8qB,GAAQ,KACrF/d,SAAAA,EAAOqd,iBAAiB,UAAU,KAC9B,MAAMra,EAAM+a,EAAQ5Z,SAASnE,EAAM1L,MAAO,IAAM0pB,WAAWhe,EAAM1L,OAC5D2pB,MAAMjb,IACP/F,EAAuB,CAAE,CAAChK,GAAM+P,GACpC,GACF,EAGN8a,EAAkBN,EAAS,eAC3BM,EAAkBL,EAAW,aAAa,GAC1CK,EAAkBJ,EAAS,oBAC3BI,EAAkBH,EAAS,mBAC3BG,EAAkBF,EAAS,QAG3B,MAAMM,EAAuBjB,EAAM9M,cAAc,IAAI,mBAC/CgO,EAAoBlB,EAAM9M,cAAc,IAAI,yBAC5CiO,EAAuBnB,EAAM9M,cAAc,IAAI,yBAErD+N,SAAAA,EAAsBb,iBAAiB,SAAS,KZlKhDrgB,EAAc,eYmKSkhB,EAAqB5pB,OACpC6pB,IACAA,EAAkBtL,YAAc,GAAGqL,EAAqB5pB,MAAMgE,OAAOsT,yBACzE,IAGJwS,SAAAA,EAAsBf,iBAAiB,SAAS,KZlKhDrgB,EAAc,eAAgBvJ,GYoKtByqB,IACAA,EAAqB5pB,MAAQb,GAE7B0qB,IACAA,EAAkBtL,YAAc,GAAGpf,EAAsB6E,OAAOsT,0BAEpE6F,OAAO5Q,KAAK,iCAAiC,IAIjD,MAAMwd,EAA2BpB,EAAM9M,cAAc,IAAI,uBACnDmO,EAAwBrB,EAAM9M,cAAc,IAAI,6BAChDoO,EAA2BtB,EAAM9M,cAAc,IAAI,6BAEzDkO,SAAAA,EAA0BhB,iBAAiB,SAAS,KZ3KpDrgB,EAAc,mBY4KaqhB,EAAyB/pB,OAC5CgqB,IACAA,EAAsBzL,YAAc,GAAGwL,EAAyB/pB,MAAMgE,OAAOsT,yBACjF,IAGJ2S,SAAAA,EAA0BlB,iBAAiB,SAAS,KZ3KpDrgB,EAAc,mBAAoBtJ,GY6K1B2qB,IACAA,EAAyB/pB,MAAQZ,GAEjC4qB,IACAA,EAAsBzL,YAAc,GAAGnf,EAA0B4E,OAAOsT,0BAE5E6F,OAAO5Q,KAAK,qCAAqC,IAIrDoc,EAAMI,iBAAiB,SAAUziB,IAC7B,MAAM4jB,EAAa5jB,EAAE6jB,OAAuBC,QAAQ,IAAI,mBACxD,GAAIF,EAAW,CACX,MAAMhqB,EAAOgqB,EAAUG,aAAa,aAC9B/qB,EAAK4qB,EAAUG,aAAa,WAC9BnqB,GAAQZ,GA8DxB,SAA4BY,EAA2BZ,GACnD,MAAMgrB,EAAqB,WAATpqB,EZ3Hf,SAA4BZ,G,MAC/B,MAAM,kBAAE6H,EAAiB,sBAAEC,GAA0BvC,YAAYC,aAC3DC,EAAWoC,EAAkB,GAE7BwL,EAAQ5N,EAAStC,cAAc8nB,WAAUniB,GAAKA,EAAE9I,KAAOA,IAC7D,IAAe,IAAXqT,EAAc,OAAO,KAGzB,GADe5N,EAAStC,cAAckQ,GAC3BlT,UAEP,OADA,EAAS,QAAS,+BAAgC,CAAEH,OAC7C,KAGXyF,EAAStC,cAAc+nB,OAAO7X,EAAO,GAGrC,IAAK,MAAM5J,IAAS,CAAC,QAAS,UAAW,YACJ,QAA7B,EAAAhE,EAASpC,cAAcoG,UAAM,eAAEvH,kBAAmBlC,IAClDyF,EAASpC,cAAcoG,GAAOvH,eAAiB,MAMvD,OAFA4F,IACA,EAAS,OAAQ,wBAAyB,CAAE9H,OACrCA,CACX,CYkG0CmrB,CAAmBnrB,GZTtD,SAA4BA,G,MAC/B,MAAM,kBAAE6H,EAAiB,sBAAEC,GAA0BvC,YAAYC,aAC3DC,EAAWoC,EAAkB,GAE7BwL,EAAQ5N,EAASrC,cAAc6nB,WAAUniB,GAAKA,EAAE9I,KAAOA,IAC7D,IAAe,IAAXqT,EAAc,OAAO,KAGzB,GADe5N,EAASrC,cAAciQ,GAC3BlT,UAEP,OADA,EAAS,QAAS,+BAAgC,CAAEH,OAC7C,KAGXyF,EAASrC,cAAc8nB,OAAO7X,EAAO,GAGrC,IAAK,MAAM5J,IAAS,CAAC,QAAS,UAAW,YACJ,QAA7B,EAAAhE,EAASpC,cAAcoG,UAAM,eAAErH,kBAAmBpC,IAClDyF,EAASpC,cAAcoG,GAAOrH,eAAiB,MAMvD,OAFA0F,IACA,EAAS,OAAQ,wBAAyB,CAAE9H,OACrCA,CACX,CYhBmEorB,CAAmBprB,GAE9EgrB,GACAnN,OAAOpF,QAAQ,kBACf4S,MAEAxN,OAAO3Y,MAAM,+BAErB,CAtEgBomB,CAAmB1qB,EAAMZ,EAEjC,KAGJ,MAAMurB,EAAmBlC,EAAM9M,cAAc,IAAI,oBAC3CiP,EAAmBnC,EAAM9M,cAAc,IAAI,oBAEjDgP,SAAAA,EAAkB9B,iBAAiB,SAAS,KACxC,MAAMjG,EZsJP,WACH,MAAM/d,EAAW,IAEXgmB,EAAgBhmB,EAAStC,cAAc4D,QAAO+B,IAAMA,EAAE3I,YACtDurB,EAAgBjmB,EAASrC,cAAc2D,QAAO+B,IAAMA,EAAE3I,YAE5D,OAAOiF,KAAKC,UAAU,CAClBsmB,QAAS1sB,EACT2sB,YAAY,IAAIpnB,MAAO6C,cACvBlE,cAAesoB,EACfroB,cAAesoB,GAChB,KAAM,EACb,CYlKqBG,GACbC,UAAUC,UAAUC,UAAUxI,GAC9B3F,OAAOpF,QAAQ,qCAAqC,IAGxD+S,SAAAA,EAAkB/B,iBAAiB,SAAS,IAAY,mCACpD,IACI,MACM7R,EZ+JX,SAAuB4L,GAC1B,MAAM1c,EAAmB,GACzB,IAAImlB,EAAkB,EAClBC,EAAkB,EAEtB,IACI,MAAM7nB,EAAOe,KAAKoH,MAAMgX,GAExB,GAAInf,EAAKlB,eAAiBsH,MAAMC,QAAQrG,EAAKlB,eACzC,IAAK,MAAM0G,KAAUxF,EAAKlB,cACtB,IACQ0G,EAAO5J,MAAQ4J,EAAOvJ,SACtBsJ,EAAiB,CACb3J,KAAM4J,EAAO5J,KACbK,OAAQuJ,EAAOvJ,OACfJ,OAAQ2J,EAAO3J,QAAU,KAE7B+rB,IAER,CAAE,MAAOjlB,GACLF,EAAOmC,KAAK,4BAA4BY,EAAO5J,UAAU+G,IAC7D,CAIR,GAAI3C,EAAKjB,eAAiBqH,MAAMC,QAAQrG,EAAKjB,eACzC,IAAK,MAAMyG,KAAUxF,EAAKjB,cACtB,IACQyG,EAAO5J,MAAQ4J,EAAOrJ,SACtByJ,EAAiB,CACbhK,KAAM4J,EAAO5J,KACbO,OAAQqJ,EAAOrJ,OACfN,OAAQ2J,EAAO3J,QAAU,KAE7BgsB,IAER,CAAE,MAAOllB,GACLF,EAAOmC,KAAK,4BAA4BY,EAAO5J,UAAU+G,IAC7D,CAGZ,CAAE,MAAOA,GACLF,EAAOmC,KAAK,yBAAyBjC,IACzC,CAGA,OADA,EAAS,OAAQ,mBAAoB,CAAEilB,kBAAiBC,kBAAiBplB,WAClE,CAAEqlB,QAASF,EAAiBG,QAASF,EAAiBplB,SACjE,CY9M2BulB,OADIP,UAAUC,UAAUO,YAGnC1U,EAAO9Q,OAAOpC,OAAS,EACvBmZ,OAAO3Y,MAAM0S,EAAO9Q,OAAOmH,KAAK,QAEhC4P,OAAOpF,QAAQ,YAAYb,EAAOuU,oBAAoBvU,EAAOwU,mBAC7Df,KAER,CAAE,SACExN,OAAO3Y,MAAM,2BACjB,CACJ,MAGA,MAAMqnB,EAAoBlD,EAAM9M,cAAc,IAAI,gBAC5CiQ,EAAcnD,EAAM9M,cAAc,IAAI,eACtCkQ,EAAepD,EAAM9M,cAAc,IAAI,gBACvCmQ,EAAerD,EAAM9M,cAAc,IAAI,qBACvCoQ,EAAYtD,EAAM9M,cAAc,IAAI,sBAE1CgQ,SAAAA,EAAmB9C,iBAAiB,UAAU,KAC1ClgB,EAAagjB,EAAkBpN,SAC/BtB,OAAO5Q,KAAK,eAAcsf,EAAkBpN,QAAU,UAAY,YAAa,IAGnFqN,SAAAA,EAAa/C,iBAAiB,SAAS,KACnCkD,SAAAA,EAAWtN,UAAUC,OAAO,WACvBqN,aAAS,EAATA,EAAWtN,UAAUuN,SAAS,YAC/BC,IACJ,IAGJJ,SAAAA,EAAchD,iBAAiB,SAAS,KbjWxCrlB,EAAWM,OAAS,EamWhBmoB,KACAhP,OAAO5Q,KAAK,qBAAqB,IAGrCyf,SAAAA,EAAcjD,iBAAiB,SAAS,KACpCqC,UAAUC,UAAUC,UAAU7mB,KAC9B0Y,OAAOpF,QAAQ,iCAAiC,GAExD,CAzZIqU,GAwdJ,WACI,MAAMrnB,EAAW,KAKrB,SAA8BsnB,GAC1B,MAAM1D,EAAQnL,SAASoL,eAAe,GAAG,oBACnC0D,EAAe3D,aAAK,EAALA,EAAO9M,cAAc,IAAI,gBAC9C,IAAKyQ,EAAc,OAEnBA,EAAa7Q,UAAY,GAEzB,MAAM8Q,EAAiB/O,SAASoL,eAAe,0BAE3C2D,GACAxiB,MAAMyiB,KAAKD,EAAeE,SAASxiB,SAASyiB,IACxC,GAAIA,EAAI1sB,MAAO,CACX,MAAM2sB,EAASnP,SAASE,cAAc,UACtCiP,EAAO3sB,MAAQ0sB,EAAI1sB,MACnB2sB,EAAOpO,YAAcmO,EAAInO,aAAemO,EAAI1sB,MAC5CssB,EAAazO,YAAY8O,EAC7B,KAI4B,IAAhCL,EAAaG,QAAQzoB,QACrB,CAAC,aAAc,SAAU,SAAU,aAAc,YAAa,QAAQiG,SAAQ2iB,IAC1E,MAAMD,EAASnP,SAASE,cAAc,UACtCiP,EAAO3sB,MAAQ4sB,EACfD,EAAOpO,YAAcqO,EACrBN,EAAazO,YAAY8O,EAAO,IAIxCL,EAAatsB,MAAQqsB,CACzB,EAlCIQ,CAAqB9nB,EAASxC,iBAAiBT,QAC/CynB,GAAoBxkB,EAASxC,iBAAiBT,OAAQiD,EAASxC,iBAAiBR,MACpF,CA3dI+qB,GAEA,EAAS,OAAQ,wBAAyB,KAC9C,G,CA6NA,SAAS/E,GAAiB7nB,GACtB,MAAMkgB,EAAmB,WAATlgB,EAAoB,IAAqB,IAEzD,OAAuB,IAAnBkgB,EAAQpc,OACD,eAAe,mCAGnBoc,EAAQ3Z,KAAI0C,GAAU,qBACf,iBAA2BA,EAAO1J,UAAY,UAAY,gBAAgB0J,EAAO7J,4BAC9E,4BACX6J,EAAO1J,UAAY,mCAAqC,eACxD,GAAW0J,EAAO5J,+BAEnB4J,EAAO1J,UAIN,GAJkB,4BACH,+BAAyCS,eAAkBiJ,EAAO7J,kHAKtFiO,KAAK,GACV,CAiLA,SAASod,KACL,MAAMhC,EAAQnL,SAASoL,eAAe,GAAG,oBACzC,IAAKD,EAAO,OAEZ,MAAMoE,EAAapE,EAAM9M,cAAc,IAAI,yBACrCmR,EAAarE,EAAM9M,cAAc,IAAI,yBAEvCkR,IACAA,EAAWtR,UAAYsM,GAAiB,WAExCiF,IACAA,EAAWvR,UAAYsM,GAAiB,UAEhD,CAEA,SAASoE,KACL,MAAMxD,EAAQnL,SAASoL,eAAe,GAAG,oBACzC,IAAKD,EAAO,OAEZ,MAAMsE,EAAUtE,EAAM9M,cAAc,IAAI,oBAClCqR,EAAYvE,EAAM9M,cAAc,IAAI,sBAE1C,IAAKoR,IAAYC,EAAW,OAE5B,MAAMhnB,Eb9ZC,IAAIxC,GagaXupB,EAAQxR,UAAYvV,EAAKlC,OACnBkC,EAAKO,KAAI,CAAC7C,EAAO2K,IAAM,yBACX,kCAA4CA,kBb1Y3D,SAAwB3K,GAC3B,MAAM8C,EAAO9C,EAAMC,UAAU6hB,qBAS7B,MAAO,GARM,CACTyH,QAAS,KACTpZ,SAAU,KACVvP,MAAO,IACP+H,KAAM,KACNmG,MAAO,MACT9O,EAAM1D,UAEWwG,MAAS9C,EAAMhF,OACtC,CagYYwuB,CAAexpB,+BAElB2J,KAAK,IACJ,eAAe,mCAGrB0f,EAAQI,iBAAiB,IAAI,qBAA+BpjB,SAAQqjB,IAChEA,EAAGvE,iBAAiB,SAAS,KACzB,MAAMpW,EAAQ9C,SAAUyd,EAAmBC,QAAQ5a,OAAS,IAAK,IAC3D/O,EAAQsC,EAAKyM,GACf/O,GAASspB,IACTA,EAAU3O,YbtYnB,SAAuB5a,GAC1B,IACI,OAAa,OAATA,EAAsB,YACboD,IAATpD,EAA2B,YACX,iBAATA,EAA0BA,EAC9Be,KAAKC,UAAUhB,EAAM,KAAM,EACtC,CAAE,SACE,OAAO6S,OAAO7S,EAClB,CACJ,Ca6XwC6pB,CAAc5pB,EAAMD,MAChD,GACF,GAEV,CA4CA,SAAS4lB,GAAoBznB,EAAgB4D,GACzC,MAAMijB,EAAQnL,SAASoL,eAAe,GAAG,oBACnC6E,EAAc9E,aAAK,EAALA,EAAO9M,cAAc,IAAI,eAC7C,IAAK4R,EAAa,OAElBA,EAAYhS,UAAY,GAExB,MAAMiS,EAAsC,CACxCC,WAAY,0BACZC,OAAQ,sBACRC,OAAQ,sBACRC,WAAY,sBACZC,OAAQ,sBACRC,UAAW,yBACXC,OAAQ,sBACRC,WAAY,0BACZC,KAAM,oBACNC,KAAM,oBACNC,SAAU,wBACVC,OAAQ,uBAGNC,EAAWb,EAAY5rB,GAAU0b,SAASoL,eAAe8E,EAAY5rB,IAAgC,KAE3G,GAAIysB,aAAQ,EAARA,EAAU9B,QAAQzoB,OAClB+F,MAAMyiB,KAAK+B,EAAS9B,SAASxiB,SAASyiB,IAClC,GAAIA,EAAI1sB,MAAO,CACX,MAAM2sB,EAASnP,SAASE,cAAc,UACtCiP,EAAO3sB,MAAQ0sB,EAAI1sB,MACnB2sB,EAAOpO,YAAcmO,EAAInO,aAAemO,EAAI1sB,MAC5CytB,EAAY5P,YAAY8O,EAC5B,SAED,CACH,MAAMA,EAASnP,SAASE,cAAc,UACtCiP,EAAO3sB,MAAQ0F,GAAgB,GAC/BinB,EAAOpO,YAAc7Y,GAAgB,iBAAiB5D,IACtD2rB,EAAY5P,YAAY8O,EAC5B,CAEIjnB,GAAgBqE,MAAMyiB,KAAKiB,EAAYhB,SAAShX,MAAK+Y,GAAKA,EAAExuB,QAAU0F,IACtE+nB,EAAYztB,MAAQ0F,EACb+nB,EAAYhB,QAAQzoB,SAC3BypB,EAAYztB,MAAQytB,EAAYhB,QAAQ,GAAGzsB,MAC3C2I,EAAuB,CAAE5G,MAAO0rB,EAAYhB,QAAQ,GAAGzsB,QAE/D,CAMA,SAAS,GAAWA,GAChB,MAAM,UAAEgc,GAAcnX,YAAYyC,KAC5B2U,EAAuB,iBAAVjc,EAAqBA,EAAQwW,OAAOxW,QAAAA,EAAS,IAChE,OAAOgc,EAAUE,SAASD,EAAK,CAAEE,aAAc,IACnD,C,2SC1lBO,SAASsS,GAAgB3c,GAE5B,MAAM4c,EAAgB5c,EAAUvS,KAAKyO,QAAQ,kBAAmB,KAC1D2gB,EAAkB7c,EAAUqJ,OAAOnN,QAAQ,kBAAmB,KACpE,MAAO,GAAG,aAAuB2gB,KAAmBD,GACxD,CASO,SAAeE,GAClB9c,EACAmV,G,0CAEA,MAAM,YAAE4H,GAAgBhqB,YAAYyC,KAC9B3I,EAAM8vB,GAAgB3c,GAE5B,IAcI,aAbM+c,EAAYC,QAAQnwB,EAAK,CAC3BowB,cAAejd,EAAUvS,KACzByvB,gBAAiBld,EAAUqJ,OAC3B8L,UACAgI,QAASnrB,KAAKuF,QAGlB,EAAS,OAAQ,0BAA2B,CACxC1K,MACAowB,cAAejd,EAAUvS,KACzB2vB,cAAejI,EAAQjjB,UAGpB,CACX,CAAE,MAAOsC,GAEL,OADA,EAAS,mCAAoC,CAAE3H,MAAK6F,MAAO8B,KACpD,CACX,CACJ,G,4SCCA,IAAI6oB,GASO,KAEPC,GAAmC,KAMvC,MAAMC,GAAkC,GAExC,SAASC,KACL,MAAM,YAAEC,EAAW,WAAEC,GAAe3qB,YAAYC,aAE1C2qB,EACc,KACZ,EAAS,OAAQ,qBAAsB,CAAE9X,QAASF,OAClDiY,IAAiB,EAHnBD,EAMe,KACb,EAAS,OAAQ,mBAAoB,MACrCC,KACAC,IAAqB,EATvBF,EAYa9rB,I,UAEX,MAAMmO,EAAkC,QAAtB,EAAW,QAAX,EAAAnO,EAAKisB,cAAM,eAAE9d,iBAAS,QAAInO,EAAKmO,UAC3CxS,OAAyByH,KAAT,QAAX,EAAApD,EAAKisB,cAAM,eAAEtwB,IAAmBuQ,SAASlM,EAAKisB,OAAOtwB,GAAI,IAAMqE,EAAKrE,GAE/E,EAAS,OAAQ,8BAA+B,CAAEA,KAAIC,KAAMuS,aAAS,EAATA,EAAWvS,OACvEswB,GAAyBvwB,EAAa,EAlBxCmwB,EAqBc9rB,IAEZ,EAAS,OAAQ,oBAAqB,CAAErE,GAAIqE,EAAKrE,KAwG7D,SAAgCgrB,GAC5B,IAAK6E,GAAY,OAEjB,MAAMlZ,EAAekZ,GAAWhJ,SAASpU,eAEzC,GAAqB,OAAjBkE,EAAuB,OAE3B,GAAIA,IAAiBqU,EACjBwF,KACA3S,OAAO4S,QAAQ,uCACZ,GAAI9Z,EAAeqU,EAAW,CAEjC,MAAM,WAAEvkB,GAAelB,YAAYC,aAC7BkrB,EAAWjqB,EAEXkqB,EAAWha,EAAe,EAE5Bga,GAAY,GAAKA,EAAWD,EAAShsB,QACrCmrB,GAAWhJ,SAAW,OAAH,wBACZgJ,GAAWhJ,UAAQ,CACtBpU,eAAgBke,EAChBne,UAAWke,EAASC,KAExB,EAAS,OAAQ,0CAA2C,CAAEC,SAAUja,EAAcga,cAEtFH,IAER,CACJ,CAnIYK,CAAuBxsB,EAAKrE,GAAG,EAxBjCmwB,EA2Be,KACb,EAAS,OAAQ,qBAAsB,MACnCN,IACAQ,IACJ,EA/BFF,EAkCe,KACb,EAAS,OAAQ,iCAAkC,MACnDC,KACAC,IAAqB,EArCvBF,EAwCc,KACZ,EAAS,OAAQ,gCAAiC,MAClDC,KACAC,IAAqB,EAI7BJ,EAAYa,GAAGZ,EAAWa,sBAAuBZ,GACjDF,EAAYa,GAAGZ,EAAWc,iBAAkBb,GAC5CF,EAAYa,GAAGZ,EAAWe,iBAAkBd,GAC5CF,EAAYa,GAAGZ,EAAWgB,kBAAmBf,GAC7CF,EAAYa,GAAGZ,EAAWiB,yBAA0BhB,GACpDF,EAAYa,GAAGZ,EAAWkB,8BAA+BjB,GACzDF,EAAYa,GAAGZ,EAAWmB,6BAA8BlB,GAExDJ,GAAa9mB,MACT,IAAMgnB,EAAYqB,eAAepB,EAAWa,sBAAuBZ,KACnE,IAAMF,EAAYqB,eAAepB,EAAWc,iBAAkBb,KAC9D,IAAMF,EAAYqB,eAAepB,EAAWe,iBAAkBd,KAC9D,IAAMF,EAAYqB,eAAepB,EAAWgB,kBAAmBf,KAC/D,IAAMF,EAAYqB,eAAepB,EAAWiB,yBAA0BhB,KACtE,IAAMF,EAAYqB,eAAepB,EAAWkB,8BAA+BjB,KAC3E,IAAMF,EAAYqB,eAAepB,EAAWmB,6BAA8BlB,KAG9E,EAAS,OAAQ,6BAA8B,CAAEoB,MAAOxB,GAAarrB,QACzE,CAYA,SAAS0rB,KACL,IAAKN,GAAc,OAEnB,MAAM0B,EAAUpZ,KACVqZ,EAAW3B,GAAavT,cAAc,IAAI,gBAEhD,GAAIkV,EAAU,CACVA,EAASpT,UAAY,GAAG,gBAA0BmT,EAAQnZ,QAAU,YAAc,iBAClF,MAAMqZ,EAAWD,EAASlV,cAAc,QACpCmV,IACAA,EAASzS,YAAcuS,EAAQhvB,OAEvC,CAEAmvB,IACJ,CAEA,SAASpB,GAAyBqB,G,MAC9B,IAAK/B,IAAqD,OAAvCA,GAAWhJ,SAASpU,eAAyB,OAGhE,MAAM,WAAEhM,GAAelB,YAAYC,aAC7BkrB,EAAWjqB,EACX4M,EAAQwc,GAAWhJ,SAASpU,eAGlC,QAAiBhL,IAAbmqB,GAA0BA,IAAave,EAI3C,GAAIA,GAAS,GAAKA,EAAQqd,EAAShsB,OAAQ,CACvC,MAAMmtB,EAAcnB,EAASrd,GAEzBwe,EAAY5xB,QAAsC,QAA7B,EAAA4vB,GAAWhJ,SAASrU,iBAAS,eAAEvS,OACpD4vB,GAAWhJ,SAAW,OAAH,wBACZgJ,GAAWhJ,UAAQ,CACtBrU,UAAWqf,IAEfC,KACAzB,KACA,EAAS,OAAQ,sBAAuB,CAAEpwB,KAAM4xB,EAAY5xB,QAE5DuwB,IAER,MACIA,IAER,CAgCA,SAASA,KACAX,KAEL,EAAS,OAAQ,4CAA6C,MAE9DA,GAAWhJ,SAAW1T,EAAa0c,GAAWhJ,SAAU,KAAM,MAC9DgJ,GAAWhI,eAAgB,EAC3BkK,KACAlU,OAAO5Q,KAAK,+BAChB,CAMA,IAAI+kB,GAAyD,KACzDC,GAAuD,KA4CpD,SAAeC,K,0CAClB,MAAM,MAAE1U,EAAK,WAAE+K,GAAehjB,YAAYC,cACpC,UAAEkX,GAAcnX,YAAYyC,KAElC6nB,GAAa,CACThJ,SAAUtU,IACVoM,cAAc,EACd1L,YAAY,EACZkf,gBAAiB,KACjBC,gBAAiB,QACjBvK,eAAe,EACfwK,mBAAoB,IAGxB,MAAM9gB,EA0CV,WACI,MAAMigB,EAAUpZ,KAEhB,MAAO,qBACO,gBAA0B,6DAExB,yCACE,2JAIA,iDACE,gBAA0BoZ,EAAQnZ,QAAU,YAAc,uFAE9DmZ,EAAQhvB,0DAEJ,0BAAoC,2HAGpC,uBAAiC,6LAOrC,kBAA4B,8CAC1B,sIAIH,kHAIC,kBAA4B,6CAC1B,gJAIH,kHAIC,kBAA4B,0CAC1B,oDACS5C,EAAYH,cAAc,2CACnC,iEAEH,6GAIC,aAAuB,uBAAiC,4CACtD,6HAGA,iCAA2C,2EAE9C,iDACA,qEAInB,CA1GoB6yB,GAEF,IAAI9U,EAAMd,EAAUE,SAASrL,GAAUgX,EAAWI,KAAM,GAAI,CACtEC,MAAM,EACNC,OAAO,EACPC,wBAAwB,EACxBC,UAAU,EACVC,cAAc,IAGZtL,OAAOuL,MAAK,MACV4G,cAAU,EAAVA,GAAYsC,kBACZtC,GAAWsC,gBAAgBI,QAE/B1C,GAAa,KACbC,GAAe,KAjLnBC,GAAaplB,SAAQ6nB,GAAMA,MAC3BzC,GAAarrB,OAAS,EACtB,EAAS,OAAQ,+BAAgC,MA8H7CutB,KACA/T,SAASuU,oBAAoB,UAAWR,IACxCA,GAAkB,MAElBD,KACA9T,SAASuU,oBAAoB,QAAST,IACtCA,GAAuB,OAIvBnC,cAAU,EAAVA,GAAYwC,sBACZxC,GAAWwC,mBAAmB1nB,SAAQ6nB,GAAMA,EAAGE,WAC/C7C,GAAWwC,mBAAqB,IAwChC,EAAS,OAAQ,eAAgB,KAAK,UAGpC,IAAInJ,SAAcC,GAAWC,WAAWD,EAAS,KAEvD2G,GAAe5R,SAASoL,eAAe,GAAG,WAE1C0G,KAhFAiC,GAAmBjrB,IACV6oB,KAGS,UAAV7oB,EAAE3H,MAAoB2H,EAAE2rB,SAAW3rB,EAAE4rB,WACrC5rB,EAAE6rB,iBACGhD,GAAWlR,cAAiBkR,GAAW5c,YACxC6f,GAAejD,GAAWuC,kBAKpB,WAAVprB,EAAE3H,MAAqBwwB,GAAWlR,cAAgBkR,GAAW5c,aAAe4c,GAAWsC,iBACvFtC,GAAWsC,gBAAgBI,QAC/B,EAGJrU,SAASuL,iBAAiB,UAAWwI,IAmErC,MAAM,WAAExrB,GAAelB,YAAYC,aAC7BkrB,EAAWjqB,GAkFrB,SAAwBA,G,QACpB,IAAKopB,KAAeC,GAAc,OAGlC,MAAMiD,EAAgBjD,GAAavT,cAAc,IAAI,gCACjDwW,IACAA,EAAc5W,UT7Yf,SACH1V,EACAyV,GAEA,MAAM8W,EAAiC,OAAlB9W,EAAyBzV,EAAWyV,GAAiB,KAE1E,MAAO,qBACO,mEAEE,oBAA8B8W,EAAe,SAAW,6BACtD,gEACmB,mFAGvB,gDACa,kJAKZ,2BAAqC,qGAIhDA,EAAerX,GAAuBqX,GAAgB,oBAG9D,CSkXkCC,CAAsBxsB,EAAYopB,GAAWhJ,SAASpU,gBAqGxF,WACI,IAAKqd,KAAiBD,GAAY,OAElC,MAAM,KAAEqD,EAAI,OAAEnrB,GAAWxC,YAAYyC,KAE/B0W,EAAYoR,GAAavT,cAAc,IAAI,gCACjD,IAAKmC,EAAW,OAEhB,MAAMyU,EAAczU,EAAUnC,cAAc,IAAI,iBAC1CN,EAAWyC,EAAUnC,cAAc,IAAI,mBAE7C,IAAK4W,IAAgBlX,EAAU,OAE/B,IAAIC,GAAiB,EACjBkX,EAA4D,GAEhE,MAAMC,EAAe,KAEjB,MAAM,WAAE5sB,GAAelB,YAAYC,aAG7B8tB,EAFe7sB,EAGhBU,KAAI,CAACsM,EAAMJ,KAAU,CAAGI,OAAMJ,YAC9BtM,QAAO,EAAG0M,UAAWA,aAAI,EAAJA,EAAMxT,OAE1BszB,EAAO,IAAIL,EAAKI,EAAiB,CACnCzlB,KAAM,CAAC,YAAa,oBACpB2lB,UAAW,GACXC,cAAc,EACdC,mBAAoB,IAGlBC,EAAQR,EAAYzyB,MAAM2L,OAEhC,IAAKsnB,EAGD,OAFA1X,EAASoD,UAAU7Q,IAAI,eACvB4kB,EAAiB,IAIrB,MAAM1gB,EAAU6gB,EAAKK,OAAOD,EAAO,CAAEE,MAAO,KAG5C,GAFAT,EAAiB1gB,EAAQvL,KAAK2sB,GAAoDA,EAAElpB,OAEtD,IAA1BwoB,EAAe1uB,OAGf,OAFAuX,EAASE,UAAY,eAAe,mDACpCF,EAASoD,UAAUb,OAAO,UAI9BtC,GAAiB,EACjBF,GAAoBoX,EAAgBnX,GAAW,GAC/CA,EAASoD,UAAUb,OAAO,SAAS,EAGjCuV,EAAkBhsB,EAAOisB,SAASX,EAAc,KACtDxD,GAAWwC,mBAAmBppB,KAAK8qB,GACnCZ,EAAY1J,iBAAiB,QAASsK,GAEtCZ,EAAY1J,iBAAiB,WAAYziB,IACP,IAA1BosB,EAAe1uB,SAEL,cAAVsC,EAAE3H,KACF2H,EAAE6rB,iBACF3W,EAAgB/N,KAAKmC,IAAI4L,EAAgB,EAAGkX,EAAe1uB,OAAS,GACpEsX,GAAoBoX,EAAgBnX,EAAUC,IAC7B,YAAVlV,EAAE3H,KACT2H,EAAE6rB,iBACF3W,EAAgB/N,KAAKC,IAAI8N,EAAgB,EAAG,GAC5CF,GAAoBoX,EAAgBnX,EAAUC,IAC7B,UAAVlV,EAAE3H,KAAmB6c,GAAiB,GAC7ClV,EAAE6rB,iBACFoB,GAAgBb,EAAelX,GAAezI,KAAM2f,EAAelX,GAAe7I,OAClF4I,EAASoD,UAAU7Q,IAAI,UACvB2kB,EAAYzyB,MAAQ,IACH,WAAVsG,EAAE3H,MACT4c,EAASoD,UAAU7Q,IAAI,UACvB2kB,EAAYzyB,MAAQ,IACxB,IAGJsxB,GAAwBhrB,IACfmsB,EAAYvG,SAAS5lB,EAAE6jB,SAAoB5O,EAAS2Q,SAAS5lB,EAAE6jB,SAChE5O,EAASoD,UAAU7Q,IAAI,SAC3B,EAEJ0P,SAASuL,iBAAiB,QAASuI,IAEnC/V,EAASwN,iBAAiB,SAAUziB,IAChC,MAAM4D,EAAQ5D,EAAE6jB,OAAuBC,QAAQ,IAAI,mBACnD,GAAIlgB,EAAM,CACN,MAAMyI,EAAQ9C,SAAS3F,EAAKmgB,aAAa,eAAiB,KAAM,IAC1DmJ,EAAWd,EAAezpB,MAAK8M,GAAKA,EAAEpD,QAAUA,IAClD6gB,IACAD,GAAgBC,EAASzgB,KAAMygB,EAAS7gB,OACxC4I,EAASoD,UAAU7Q,IAAI,UACvB2kB,EAAYzyB,MAAQ,GAE5B,KAGJge,EAAU+K,iBAAiB,SAAUziB,IACjC,MAAM6jB,EAAS7jB,EAAE6jB,OAEjB,GAAIA,EAAOC,QAAQ,IAAI,gBAA2B,CAC9C,IAAK+E,GAAY,OAIjB,OAHAA,GAAWhJ,SAAW1T,EAAa0c,GAAWhJ,SAAU,KAAM,MAC9DgJ,GAAWhI,eAAgB,OAC3BkK,IAEJ,CAEA,MAAMzS,EAASuL,EAAOC,QAAQ,IAAI,kBAClC,GAAIxL,EAAQ,CACR,MAAM6U,EAAW7U,EAAOyL,aAAa,cAC/BxZ,EAAUmN,EAAUnC,cAAc,IAAI,mBAA6B4X,KACnElT,EAAO3B,EAAO/C,cAAc,KAE9BhL,GAAW0P,IACX1P,EAAQ8N,UAAUC,OAAO,UACzB2B,EAAK5B,UAAUC,OAAO,oBACtB2B,EAAK5B,UAAUC,OAAO,mBAE9B,IAER,CAhOQ8U,IAIJ,MAAMC,EAAoBvE,GAAavT,cAAc,IAAI,4BACrD8X,IACAA,EAAkBlY,UAAYW,GAC1B+S,GAAWhJ,SAASjU,eACpBid,GAAWhJ,SAAS/T,YACpB+c,GAAWuC,kBACTvC,GAAWhJ,SAASrU,WAgQlC,WACI,IAAKsd,KAAiBD,GAAY,OAElC,MAAMnR,EAAYoR,GAAavT,cAAc,IAAI,4BACjD,IAAKmC,EAAW,OAEhBA,EAAU+K,iBAAiB,UAAWziB,IAClC,MAAMstB,EAAWttB,EAAE6jB,OACnB,GAAIyJ,EAASjV,UAAUuN,SAAS,GAAG,oBAA+B,CAC9D,MAAMnjB,EAAQ6qB,EAASvJ,aAAa,cAChCthB,GAASomB,KACTA,GAAWhJ,SX/hBpB,SAAqBzT,EAAsB3J,GAC9C,MAAMuX,EAAW,IAAInY,IAAIuK,EAAMR,gBAE3BoO,EAAShY,IAAIS,GACbuX,EAASuT,OAAO9qB,GAEhBuX,EAASxS,IAAI/E,GAIjB,MAAM+qB,EAAkB,EAAOztB,QAAOqP,GAAK4K,EAAShY,IAAIoN,KAIxD,OAFA,EAAS,QAAS,gBAAiB,CAAE3M,QAAOuX,SAAUwT,IAE/C,OAAP,wBACOphB,GAAK,CACRR,eAAgB4hB,GAExB,CW6gBsCC,CAAY5E,GAAWhJ,SAAUpd,GACvDkoB,KAER,KAGJjT,EAAU+K,iBAAiB,SAAgBziB,GAAM,mCAC7C,MAAM0tB,EAAO1tB,EAAE6jB,OAAuBC,QAAQ,IAAI,eAClD,GAAI4J,GAAO7E,GAAY,CACnB,MAAMpmB,EAAQirB,EAAI3J,aAAa,cAC3BthB,IACAomB,GAAWuC,gBAAkB3oB,EAC7BkrB,KACAC,KACAvE,KACAsB,KAER,CAEgB3qB,EAAE6jB,OAAuBC,QAAQ,IAAI,uBAEjD+J,KAGe7tB,EAAE6jB,OAAuBC,QAAQ,IAAI,kBAshBhE,W,mCACS+E,KAELA,GAAWhJ,SAASjU,eAAiB,IAAI,GACzC+e,WAEMkD,KACV,G,CA3hBYC,GAIJ,GADkB9tB,EAAE6jB,OAAuBC,QAAQ,IAAI,yBACvC+E,GAAY,CAExB,MAAM,MAAErS,EAAK,aAAEC,GAAiBlY,YAAYC,aAM5C,UALwBgY,EAAME,KAAKqX,QAC/B,kBACA,mEAGctX,EAAauX,YAAa,OAE5CnF,GAAWhJ,SXvqBhB,SAAuBzT,EAAsB6hB,GAAyB,GACzE,MAAMC,EAAQ3iB,IAQd,OANI0iB,GAAiB7hB,EAAMZ,YACvB0iB,EAAM1iB,UAAYY,EAAMZ,UACxB0iB,EAAMziB,eAAiBW,EAAMX,gBAGjC,EAAS,QAAS,iBAAkB,CAAEwiB,gBAAejY,eAAgBkY,EAAM1iB,YACpE0iB,CACX,CW6pBkCC,CAActF,GAAWhJ,UAAU,GACzDgJ,GAAWhI,eAAgB,EAC3BkK,IACJ,CACJ,KACJ,CAtTQqD,IAIJ,MAAMC,EAAiBvF,GAAavT,cAAc,IAAI,4BAClD8Y,IACAA,EAAelZ,UNnbhB,SACH1S,EACAsH,EACAukB,G,YAEA,MAAMnyB,EAAgB,EAAiBsG,GACjCrG,EAAgB,EAAiBqG,GAGvC,IAAIuV,EAAgBjO,EAAO5O,aAC3B,GAAI4O,EAAO7O,eAAgB,CACvB,MAAM2H,EAAS,EAAgBkH,EAAO7O,gBAClC2H,IAAQmV,EAAgBnV,EAAOvJ,OACvC,CAGA,IAAImf,EAAgB1O,EAAO1O,aAC3B,GAAI0O,EAAO3O,eAAgB,CACvB,MAAMyH,EAAS,EAAgBkH,EAAO3O,gBAClCyH,IAAQ4V,EAAgBra,KAAKC,UAAUwE,EAAOrJ,OAAQ,KAAM,GACpE,CAGA,IAAI+0B,EAAe,GACfC,EAA4E,CAAElpB,OAAO,GACrFyE,EAAOzO,qBAAuBmd,EAAcpT,SAC5CmpB,EAAmB,EAAe/V,GAI9B8V,EAHCC,EAAiBlpB,OAEc,QAAzB,EAAAkpB,EAAiBxoB,gBAAQ,eAAEtI,QACnB,eAAe,6EAAuF8wB,EAAiBxoB,SAAStI,0BAEhI,eAAe,uFAJf,eAAe,mEAA6E,GAAW8wB,EAAiBtwB,OAAS,2BASxJ,IAAIuwB,EAAe,2DACfC,EAAa,GACbJ,IACAG,EAAe,0CAA0CH,EAAcK,OAAO3d,4BAA4Bsd,EAAcM,eACpHN,EAAcM,WAAa,GAAIF,EAAa,SACvCJ,EAAcM,WAAa,KAAIF,EAAa,YAIzD,MAAMG,EAA0B9kB,EAAO7O,gBACK,QAAtC,IAAgB6O,EAAO7O,uBAAe,eAAE5B,UAAW0e,EACnDA,EAAc3S,OAAO3H,OAAS,EAE9BoxB,EAA0B/kB,EAAO3O,eACjCgD,KAAKC,UAAgD,QAAtC,IAAgB0L,EAAO3O,uBAAe,eAAE5B,OAAQ,KAAM,KAAOif,EAC5EA,EAAcpT,OAAO3H,OAAS,EAG9BqxB,EAAgBhlB,EAAOzO,qBAAuBmd,EAAcpT,UACpC,QAAzB,EAAAmpB,EAAiBxoB,gBAAQ,eAAEtI,UAAW8wB,EAAiBlpB,OAE5D,MAAO,qBACO,4EAEE,yCACE,6CACG,wDACD,qEAEJ,mDACG,oEAENupB,EAAuC,GAAb,oIAIjB,kCAA4C,oFAEtDhX,GAAoB1b,EAAe4N,EAAO7O,8GAK1C,sCACG,kFACgC1C,EAAaiK,0BACrD,GAAWuV,sCACA,6CACG,iBAA2BA,EAActa,OAAOsT,mIAKrD,2CACI,sFAGN,kCACJjH,EAAOzO,oBAAsB,UAAY,yKAOnC,oBAA8ByO,EAAOzO,oBAAsB,GAAK,mCAC9D,6CACG,6DACD,qEAEJ,mDACG,oEAENwzB,GAA4BrW,EAAcpT,OAAsB,GAAb,oIAI1C,kCAA4C,oFAEtDwS,GAAoBzb,EAAe2N,EAAO3O,8GAK1C,sCACG,0HAER,GAAWqd,0BACZ8V,mEAGY,0DAEJ,wSAQA,8HAGH9V,EAAcpT,OAAsB,GAAb,6KAMpB,kKAGH0pB,EAA6B,GAAb,uKAMb,iIAGHtW,EAAcpT,OAAsB,GAAb,sNASlB,wCACD,4BAAsC,oBAA8BqpB,kBAC3ED,iDAKZ,CMoQmCO,CACvBnG,GAAWuC,gBACXvC,GAAWhJ,SAASlU,QAAQkd,GAAWuC,iBACvC,MAmTZ,WACI,IAAKtC,KAAiBD,GAAY,OAElC,MAAMnR,EAAYoR,GAAavT,cAAc,IAAI,4BACjD,IAAKmC,EAAW,OAEhBA,EAAU+K,iBAAiB,UAAWziB,IAClC,MAAMivB,EAASjvB,EAAE6jB,OAEjB,GAAIoL,EAAOj2B,KAAO,GAAG,0BAAsC6vB,GAAY,CACnE,MAAMnvB,EAAQu1B,EAAOv1B,OAAS,KAC9BmvB,GAAWhJ,SAAW,GAA0BgJ,GAAWhJ,SAAUgJ,GAAWuC,gBAAiB,CAC7FlwB,eAAgBxB,IAEpBw1B,KACA7F,IACJ,CAEA,GAAI4F,EAAOj2B,KAAO,GAAG,0BAAsC6vB,GAAY,CACnE,MAAMnvB,EAAQu1B,EAAOv1B,OAAS,KAC9BmvB,GAAWhJ,SAAW,GAA0BgJ,GAAWhJ,SAAUgJ,GAAWuC,gBAAiB,CAC7FhwB,eAAgB1B,IAEpBw1B,IACJ,KAGJ,MAAM,OAAEnuB,GAAWxC,YAAYyC,KAEzBmuB,EAAwBpuB,EAAOisB,UAAUhtB,IAC3C,MAAMovB,EAAWpvB,EAAE6jB,OAEfuL,EAASp2B,KAAO,GAAG,mBAA+B6vB,KAClDA,GAAWhJ,SAAW,GAA0BgJ,GAAWhJ,SAAUgJ,GAAWuC,gBAAiB,CAC7FjwB,aAAci0B,EAAS11B,MACvBwB,eAAgB,OAEpBmuB,KACA6F,MAGAE,EAASp2B,KAAO,GAAG,mBAA+B6vB,KAClDA,GAAWhJ,SAAW,GAA0BgJ,GAAWhJ,SAAUgJ,GAAWuC,gBAAiB,CAC7F/vB,aAAc+zB,EAAS11B,MACvB0B,eAAgB,OAEpB8zB,KACJ,GACD,KAEHrG,GAAWwC,mBAAmBppB,KAAKktB,GACnCzX,EAAU+K,iBAAiB,QAAS0M,GAEpCzX,EAAU+K,iBAAiB,UAAWziB,IAClC,MAAMstB,EAAWttB,EAAE6jB,OACfyJ,EAASt0B,KAAO,GAAG,oBAAgC6vB,KACnDA,GAAWhJ,SAAW,GAA0BgJ,GAAWhJ,SAAUgJ,GAAWuC,gBAAiB,CAC7F9vB,oBAAqBgyB,EAASnV,UAElC+W,KACJ,IAGJxX,EAAU+K,iBAAiB,SAAgBziB,GAAM,mCAC7C,MAAM6jB,EAAS7jB,EAAE6jB,OAGjB,GADeA,EAAOC,QAAQ,IAAI,oBACpB+E,GAEV,YADAiD,GAAejD,GAAWuC,iBAK9B,GADsBvH,EAAOC,QAAQ,IAAI,6BACpB+E,GAAY,CAC7B,MAAM9Q,EAAiB+Q,cAAY,EAAZA,GAAcvT,cAAc,IAAI,mBACvD,GAAIwC,EAAgB,CAChB,MAAMnH,QNjTf,SAAsCnO,EAAkBuV,G,0CAC3D,MAAM,MAAExB,EAAK,aAAEC,GAAiBlY,YAAYC,aAE5C,IAAKwZ,EAAc3S,OAEf,OADAwR,OAAO4S,QAAQ,6BACR,CAAEhY,SAAS,GAGtB,MAAMxY,QAAaud,EAAME,KAAKtR,MAC1B,qBACA,gCACA,UAAU5M,EAAaiK,aAG3B,GAAa,OAATxJ,GAAiBA,IAASwd,EAAaE,UACvC,MAAO,CAAElF,SAAS,GAGtB,IAAKxY,EAAKoM,OAEN,OADAwR,OAAO4S,QAAQ,+BACR,CAAEhY,SAAS,GAGtB,IACI,MAAMzO,EAAYJ,EAAiB,CAC/B3J,KAAMA,EAAKoM,OACX/L,OAAQ0e,EACR9e,OAAQ,CAACuJ,KAGb,OADAoU,OAAOpF,QAAQ,kBAAkBxY,YAC1B,CAAEwY,SAAS,EAAM4d,SAAUrsB,EAAUhK,GAChD,CAAE,MAAOgH,GAEL,OADA6W,OAAO3Y,MAAM,0BAA2B8B,EAAY0F,WAC7C,CAAE+L,SAAS,EACtB,CACJ,G,CM8QqC6d,CAAuBzG,GAAWuC,gBAAiBrT,EAAere,OACnFkX,EAAOa,SAAWb,EAAOye,WACzBxG,GAAWhJ,SAAW,GAA0BgJ,GAAWhJ,SAAUgJ,GAAWuC,gBAAiB,CAC7FlwB,eAAgB0V,EAAOye,SACvBl0B,aAAc,KAElB+zB,KAER,CACA,MACJ,CAGA,GADsBrL,EAAOC,QAAQ,IAAI,6BACpB+E,GAAY,CAC7B,MAAMrQ,EAAiBsQ,cAAY,EAAZA,GAAcvT,cAAc,IAAI,mBACvD,GAAIiD,EAAgB,CAChB,MAAM5H,QN5Rf,SAAsCnO,EAAkBgW,G,0CAC3D,MAAM,MAAEjC,EAAK,aAAEC,GAAiBlY,YAAYC,aAE5C,IAAKia,EAAcpT,OAEf,OADAwR,OAAO4S,QAAQ,6BACR,CAAEhY,SAAS,GAItB,MAAMsF,EAAa,EAAe0B,GAClC,IAAK1B,EAAWzR,MAEZ,OADAuR,OAAO3Y,MAAM,mBAAmB6Y,EAAW7Y,SACpC,CAAEuT,SAAS,GAGtB,MAAMxY,QAAaud,EAAME,KAAKtR,MAC1B,qBACA,gCACA,UAAU5M,EAAaiK,aAG3B,GAAa,OAATxJ,GAAiBA,IAASwd,EAAaE,UACvC,MAAO,CAAElF,SAAS,GAGtB,IAAKxY,EAAKoM,OAEN,OADAwR,OAAO4S,QAAQ,+BACR,CAAEhY,SAAS,GAGtB,IACI,MAAMzO,EAAYC,EAAiB,CAC/BhK,KAAMA,EAAKoM,OACX7L,OAAQud,EAAWvd,OACnBN,OAAQ,CAACuJ,KAGb,OADAoU,OAAOpF,QAAQ,kBAAkBxY,YAC1B,CAAEwY,SAAS,EAAM4d,SAAUrsB,EAAUhK,GAChD,CAAE,MAAOgH,GAEL,OADA6W,OAAO3Y,MAAM,0BAA2B8B,EAAY0F,WAC7C,CAAE+L,SAAS,EACtB,CACJ,G,CMkPqC8d,CAAuB1G,GAAWuC,gBAAiB5S,EAAe9e,OACnFkX,EAAOa,SAAWb,EAAOye,WACzBxG,GAAWhJ,SAAW,GAA0BgJ,GAAWhJ,SAAUgJ,GAAWuC,gBAAiB,CAC7FhwB,eAAgBwV,EAAOye,SACvBh0B,aAAc,KAElB6zB,KAER,CACA,MACJ,CAGA,GADoBrL,EAAOC,QAAQ,IAAI,0BACpB+E,GAAY,CAC3B,MAAM2G,QAAkBjZ,KACxB,GAAIiZ,EAAW,CACX,MAAMhX,EAAiBsQ,cAAY,EAAZA,GAAcvT,cAAc,IAAI,mBACnDiD,IACAA,EAAe9e,MAAQ81B,EACvB3G,GAAWhJ,SAAW,GAA0BgJ,GAAWhJ,SAAUgJ,GAAWuC,gBAAiB,CAC7F/vB,aAAcm0B,EACdp0B,eAAgB,OAEpB8zB,KAER,CACA,MACJ,CAGA,GADoBrL,EAAOC,QAAQ,IAAI,0BACpB+E,GAAY,CAC3B,MAAMrQ,EAAiBsQ,cAAY,EAAZA,GAAcvT,cAAc,IAAI,mBAIvD,YAHIiD,UNpfT,SAAoCC,G,kDACvC,IAAKA,EAAcpT,OAEf,YADAwR,OAAO4S,QAAQ,yBAInB,MAAM1S,EAAa,EAAe0B,GAElC,IAAK1B,EAAWzR,MAEZ,YADAuR,OAAO3Y,MAAM,YAAY6Y,EAAW7Y,SAKxC,MAAM,MAAEsY,EAAK,WAAE+K,GAAehjB,YAAYC,aAE1C,GAAuB,QAAnB,EAAAuY,EAAW/Q,gBAAQ,eAAEtI,OACrB,GAAIqZ,EAAW/Q,SAAStI,OAAS,EAAG,CAChC,MAAM6M,EAAU,oGAGNwM,EAAW/Q,SAAS7F,KAAIsvB,GAAK,OAAOA,WAAUxoB,KAAK,iDAGvD,IAAIuP,EAAMjM,EAASgX,EAAWI,KAAM,GAAI,CAAEC,MAAM,IAASlL,MACnE,MACIG,OAAO4S,QAAQ,cAAc1S,EAAW/Q,SAAStI,uBAAuBqZ,EAAW/Q,SAASiB,KAAK,cAKzG,GAAmB,QAAf,EAAA8P,EAAW9Q,YAAI,eAAEvI,OACjB,GAAIqZ,EAAW9Q,KAAKvI,OAAS,EAAG,CAC5B,MAAM6M,EAAU,sFAGNwM,EAAW9Q,KAAK9F,KAAI8H,GAAK,OAAOA,WAAUhB,KAAK,iDAGnD,IAAIuP,EAAMjM,EAASgX,EAAWI,KAAM,GAAI,CAAEC,MAAM,IAASlL,MACnE,MACIG,OAAOpF,QAAQ,WAAWsF,EAAW9Q,KAAKgB,KAAK,cAGnD4P,OAAOpF,QAAQ,mBAEvB,G,CMucsBie,CAAqBlX,EAAe9e,QAGlD,CAGA,GADemqB,EAAOC,QAAQ,IAAI,qBACpB+E,GAAY,CACtB,MAAMrQ,EAAiBsQ,cAAY,EAAZA,GAAcvT,cAAc,IAAI,mBACvD,GAAIiD,EAAgB,CAChB,MAAMpV,EN9cf,SAAyBqV,G,MAC5B,IAAKA,EAAcpT,OAEf,OADAwR,OAAO4S,QAAQ,oBACR,KAIX,MAAM1S,EAAa,EAAe0B,GAElC,IAAK1B,EAAWvd,OAEZ,OADAqd,OAAO3Y,MAAM,sEACN,KAGX,IACI,MAAMkF,EAAQqG,EAAcsN,EAAWvd,QACjCm2B,EAAYvxB,KAAKC,UAAU+E,EAAO,KAAM,GAGxCwsB,EAAe,EAAeD,GAUpC,OARKC,EAAatqB,OAEc,QAArB,EAAAsqB,EAAa5pB,gBAAQ,eAAEtI,QAC9BmZ,OAAO5Q,KAAK,UAAU2pB,EAAa5pB,SAAStI,4BAE5CmZ,OAAOpF,QAAQ,8BAJfoF,OAAO4S,QAAQ,gDAOZkG,CACX,CAAE,MAAO3vB,GAEL,OADA6W,OAAO3Y,MAAM,eAAgB8B,EAAY0F,WAClC,IACX,CACJ,CM4a8BmqB,CAAgBrX,EAAe9e,OACzC0J,IACAoV,EAAe9e,MAAQ0J,EACvBylB,GAAWhJ,SAAW,GAA0BgJ,GAAWhJ,SAAUgJ,GAAWuC,gBAAiB,CAC7F/vB,aAAc+H,EACdhI,eAAgB,OAEpB8zB,KAER,CACA,MACJ,CAGA,GADkBrL,EAAOC,QAAQ,IAAI,wBACpB+E,GAAjB,CACI,MAAMrQ,EAAiBsQ,cAAY,EAAZA,GAAcvT,cAAc,IAAI,mBACvD,GAAIiD,EAAgB,CAChB,MAAMqG,EN3bf,SAA4BpG,GAC/B,IAAKA,EAAcpT,OAEf,OADAwR,OAAO4S,QAAQ,uBACR,KAGX,IACI,MAAMlkB,EAASnH,KAAKoH,MAAMiT,GACpBoG,EAAYzgB,KAAKC,UAAUkH,EAAQ,KAAM,GAE/C,OADAsR,OAAOpF,QAAQ,oBACRoN,CACX,CAAE,MAAO7e,GAEL,OADA6W,OAAO3Y,MAAM,kBAAmB8B,EAAY0F,WACrC,IACX,CACJ,CM4akCoqB,CAAmBtX,EAAe9e,OAChDmlB,IACArG,EAAe9e,MAAQmlB,EACvBgK,GAAWhJ,SAAW,GAA0BgJ,GAAWhJ,SAAUgJ,GAAWuC,gBAAiB,CAC7F/vB,aAAcwjB,EACdzjB,eAAgB,OAEpB8zB,KAER,CAEJ,MACJ,KACJ,CArdQa,IAIJ,MAAMC,EAAmBlH,GAAavT,cAAc,IAAI,uBACpDya,IACAA,EAAiB7a,WJ1brB1S,EI2bQomB,GAAWuC,gBJ1bnBxa,EI2bQiY,GAAWhJ,SAASnU,QAAQmd,GAAWuC,iBJ1b/CnV,EI2bQ4S,GAAWhJ,SAAS/T,YAAY+c,GAAWuC,iBAC3CvC,GAAWlR,cJzbY,YAAX1B,EACT+I,GAAcvc,GAGpBmO,EAIEsO,GAAazc,EAAOmO,GAHhBqO,GAAkBxc,EAAOwT,IIq4BxC,WACI,IAAK6S,KAAiBD,GAAY,OAElC,MAAMnR,EAAYoR,GAAavT,cAAc,IAAI,uBACjD,IAAKmC,EAAW,OAEhBA,EAAU+K,iBAAiB,SAAgBziB,GAAM,mCAC7C,MAAM6jB,EAAS7jB,EAAE6jB,OAoBjB,GAjBIA,EAAOC,QAAQ,IAAI,qBAAiC+E,KACpDA,GAAWhJ,SXzfhB,SAA0BzT,EAAsB3J,GAGnD,OAFA,EAAS,QAAS,uBAAwB,CAAEA,UAErC,OAAP,wBACO2J,GAAK,CACRV,QAAS,OAAF,wBACAU,EAAMV,SAAO,CAChB,CAACjJ,GAAQ,OAEbqJ,YAAa,OAAF,wBACJM,EAAMN,aAAW,CACpB,CAACrJ,GAAQ,aAGrB,CW2ekCwtB,CAAiBpH,GAAWhJ,SAAUgJ,GAAWuC,iBACvEU,GAAejD,GAAWuC,kBAI1BvH,EAAOC,QAAQ,IAAI,eAA2B+E,KAC9CA,GAAWhJ,SXziBhB,SAAyBzT,EAAsB3J,GAClD,MAAMmO,EAASxE,EAAMV,QAAQjJ,GAC7B,OAAKmO,GAEL,EAAS,QAAS,eAAgB,CAAEnO,UAE7B,OAAP,wBACO2J,GAAK,CACRV,QAAS,OAAF,wBACAU,EAAMV,SAAO,CAChB,CAACjJ,GAAQ,OAAF,wBACAmO,GAAM,CACT8O,QAAQ,SAVAtT,CAcxB,CWyhBkC8jB,CAAgBrH,GAAWhJ,SAAUgJ,GAAWuC,iBACtEwC,MAGA/J,EAAOC,QAAQ,IAAI,iBAA6B+E,KAChDA,GAAWhJ,SXzhBhB,SAA2BzT,EAAsB3J,GACpD,MAAMmO,EAASxE,EAAMV,QAAQjJ,GAC7B,OAAKmO,GAEL,EAAS,QAAS,iBAAkB,CAAEnO,UAE/B,OAAP,wBACO2J,GAAK,CACRV,QAAS,OAAF,wBACAU,EAAMV,SAAO,CAChB,CAACjJ,GAAQ,OAAF,wBACAmO,GAAM,CACT8O,QAAQ,SAVAtT,CAcxB,CWygBkC+jB,CAAkBtH,GAAWhJ,SAAUgJ,GAAWuC,iBACxEwC,MAIA/J,EAAOC,QAAQ,IAAI,mBAA+B+E,GAAY,CAC9D,MAAMjJ,EAAYlQ,GAAamZ,GAAWhJ,SAAUgJ,GAAWuC,iBAC3DxL,IACAiJ,GAAWuC,gBAAkBxL,EAC7B+N,KACAC,KACAvE,KAER,CXzUD,IAAuBjd,EW6VtB,GAjBIyX,EAAOC,QAAQ,IAAI,gBAA4B+E,WA6C3D,W,0CACI,IAAKA,KAAeA,GAAWhJ,SAASnU,QAAQhT,UAAYmwB,GAAWhJ,SAASrU,UAE5E,YADAqL,OAAO4S,QAAQ,uBAInB,MAAM,MAAEjT,EAAK,WAAE+K,EAAU,aAAE9K,GAAiBlY,YAAYC,cAClD,UAAEkX,GAAcnX,YAAYyC,KAG5BuE,EAAS4I,GADS0a,GAAWhJ,SAASnU,QAAQhT,QAAQ+U,UAI5D,IAAI2iB,EAAc,eAAe,oBAGjC,GAFAA,GAAe,qCAAqC7qB,EAAOmJ,kBAE9B,IAAzBnJ,EAAO+I,OAAO5Q,OACd0yB,GAAe,aAAa,2OAK5BA,GAAe,uDAAuD1a,EAAUE,SAASrQ,EAAOkJ,IAAIZ,UAAU,EAAG,+BAC9G,CACHuiB,GAAe,gCAAgC7qB,EAAO+I,OAAO5Q,wBAC7D0yB,GAAe,OACf,IAAK,MAAMn2B,KAASsL,EAAO+I,OAAQ,CAC/B,MAAMsE,EAAU3Y,EAAMP,MAAMmU,UAAU,EAAG,KACzCuiB,GAAe,eAAe1a,EAAUE,SAAS3b,EAAM3B,oBAAoBod,EAAUE,SAAShD,KAAW3Y,EAAMP,MAAMgE,OAAS,IAAM,MAAQ,SAChJ,CACA0yB,GAAe,OACnB,CACAA,GAAe,SAGf,MAMMC,EAAQ,IAAI7Z,EANK,uFAEWd,EAAUE,SAASiT,GAAWhJ,SAASrU,UAAUvS,2DAC7Em3B,UAGkC7O,EAAW+O,QAAS,GAAI,CAC5D1O,MAAM,EACNG,SAAUxc,EAAO+I,OAAO5Q,OAAS,EAAI,gBAAkB,mBACvDskB,aAAc,WAKlB,UAFqBqO,EAAM3Z,UAEZD,EAAauX,YACxB,OAIJ,GAA6B,IAAzBzoB,EAAO+I,OAAO5Q,OAGd,OAFAonB,UAAUC,UAAUC,UAAUzf,EAAOkJ,UACrCoI,OAAO5Q,KAAK,mCAKhB,MAAMsqB,QX5OH,SACHnkB,EACAokB,G,yCAEA,IAAKpkB,EAAMZ,WAAsC,OAAzBY,EAAMX,eAC1B,MAAO,CAAEgG,SAAS,EAAOvT,MAAO,wBAAyBuyB,cAAe,IAG5E,MAAM,WAAEhxB,EAAU,mBAAEixB,EAAkB,kBAAEC,GAAsBpyB,YAAYC,aAE1E,UAEUkyB,EAAmBtkB,EAAMX,gBAG/B,MACMD,EADW/L,EACU2M,EAAMX,gBAEjC,IAAKD,EACD,MAAO,CAAEiG,SAAS,EAAOvT,MAAO,sCAAuCuyB,cAAe,IAI1F,MAAMnuB,EAA8B,CAAC,EAC/BmuB,EAA0B,GAEhC,IAAK,MAAMx2B,KAASu2B,EAECt4B,EAAiByK,MAAKkK,GAAKA,EAAExU,MAAQ4B,EAAM5B,OAC5C4B,EAAMP,MAAM2L,SACvB/C,EAAmCrI,EAAM5B,KAAO4B,EAAMP,MAAM2L,OAC7DorB,EAAcxuB,KAAKhI,EAAM3B,QAIjC,GAA6B,IAAzBm4B,EAAc/yB,OACd,MAAO,CAAE+T,SAAS,EAAOvT,MAAO,4BAA6BuyB,cAAe,IAIhFt4B,OAAOy4B,OAAOplB,EAAWlJ,GAGzB,MAAMuuB,QAAqBC,MAAM,uBAAwB,CACrDC,OAAQ,OACRC,QAASL,IACTrZ,KAAMlZ,KAAKC,UAAU,OAAD,QAChB4yB,WAAYzlB,EAAUqJ,QACnBrJ,MAIX,IAAKqlB,EAAaK,GAAI,CAClB,MAAMC,QAAkBN,EAAa3c,OAErC,OADA,EAAS,2BAA4B,CAAE+B,OAAQ4a,EAAa5a,OAAQ/X,MAAOizB,IACpE,CAAE1f,SAAS,EAAOvT,MAAO,gBAAgB2yB,EAAa5a,SAAUwa,cAAe,GAC1F,CAOA,OALA,EAAS,OAAQ,iCAAkC,CAC/Cx3B,KAAMuS,EAAUvS,KAChBw3B,kBAGG,CAAEhf,SAAS,EAAMgf,gBAC5B,CAAE,MAAOzwB,GAEL,OADA,EAAS,sCAAuCA,GACzC,CAAEyR,SAAS,EAAOvT,MAAQ8B,EAAY0F,QAAS+qB,cAAe,GACzE,CACJ,G,CWwK8BW,CAAwBvI,GAAWhJ,SAAUta,EAAO+I,QAE9E,GAAIiiB,EAAY9e,QAAS,CACrBoF,OAAOpF,QAAQ,WAAW8e,EAAYE,cAAc/yB,kBAAkB6yB,EAAYE,cAAcxpB,KAAK,SAGrG,MAAM,YAAEgiB,GAAgB1qB,YAAYC,mBAC9ByqB,EAAYoI,KAAK,kCAAmC,CACtD5I,cAAeI,GAAWhJ,SAASrU,UAAUvS,KAC7CwS,eAAgBod,GAAWhJ,SAASpU,eACpCglB,cAAeF,EAAYE,cAC3B1kB,eAAgB8c,GAAWhJ,SAAS9T,iBAIxCwd,IACJ,MACI1S,OAAO3Y,MAAMqyB,EAAYryB,OAAS,0BAE1C,G,CA5HkBozB,IAINzN,EAAOC,QAAQ,IAAI,iBAA6B+E,IA+S5D,W,mCACI,IAAKA,IAAcA,GAAWlR,cAAgBkR,GAAW5c,WAAY,OAErE,IAAKkF,KAED,YADA0F,OAAO3Y,MAAM,wBAIjB,MAAMqzB,EAAkBzkB,GAAU+b,GAAWhJ,UAC7C,IAAK0R,EAAgBxkB,OAEjB,YADA8J,OAAO4S,QAAQ8H,EAAgBvkB,QAAU,iBAI7C,MAAM+J,EX+BH,SAA4B3K,GAC/B,MAAMtM,EAAmB,GACnBkG,EAAqB,GAEtBoG,EAAMZ,WACP1L,EAAOmC,KAAK,yBAGXmK,EAAMV,QAAQhT,SACfoH,EAAOmC,KAAK,wBAGXmK,EAAMV,QAAQ/S,SACfmH,EAAOmC,KAAK,wCAIhB,MAAM,aAAEjD,GAAiBT,YAAYC,aAChB,UAAjBQ,GAA6C,cAAjBA,GAC5Bc,EAAOmC,KAAK,wBAIhB,MAAMuvB,EAAeplB,EAAMJ,iBAAiBtO,OAAS,EAC/C0O,EAAMJ,iBAAiBI,EAAMJ,iBAAiBtO,OAAS,GACvD,KAUN,MAR8B,YAA1B8zB,aAAY,EAAZA,EAAc12B,UACdkL,EAAS/D,KAAK,iDAGdmK,EAAML,gBAAkB,GACxB/F,EAAS/D,KAAK,wBAAwBmK,EAAML,eAAiB,4CAG1D,CACHzG,MAAyB,IAAlBxF,EAAOpC,OACdoC,SACAkG,WAER,CWvEuByrB,CAAmB5I,GAAWhJ,UACjD,IAAK9I,EAAWzR,MAEZ,YADAuR,OAAO3Y,MAAM6Y,EAAWjX,OAAOmH,KAAK,OAIpC8P,EAAW/Q,SAAStI,OAAS,GAC7BmZ,OAAO4S,QAAQ1S,EAAW/Q,SAASiB,KAAK,OAI5C,MAAMyqB,EAAqB,CACvB3lB,eAAgB8c,GAAWhJ,SAAS9T,eACpCC,iBAAkB,IAAI6c,GAAWhJ,SAAS7T,mBAI9C6c,GAAWhJ,SAAWtS,GAAgBsb,GAAWhJ,UACjDgJ,GAAW5c,YAAa,EACxB4c,GAAWsC,gBAAkB,IAAIwG,gBAGjC,MAAM3B,EAAmBlH,cAAY,EAAZA,GAAcvT,cAAc,IAAI,uBJ7uCtD,IAAiC7H,EI8uChCsiB,IACAA,EAAiB7a,WJ/uCezH,EI+uCqBmb,GAAWhJ,SAAS9T,eJ9uCtE,qBACO,+GAEc2B,EAAY,gCACxB,+II6uChBkkB,KACAC,KAEA,IACI,MAAMjhB,QVhqCP,SACHxE,EACAmF,G,0CAEA,MAAMjT,EAAUC,YAAYC,aACtBC,EAAW,IAGjB,GAAI8S,aAAM,EAANA,EAAQC,QACR,MAAO,CAAEC,SAAS,EAAOvT,MAAO,wBAGpC,IAAKkO,EAAMZ,UACP,MAAO,CAAEiG,SAAS,EAAOvT,MAAO,yBAGpC,IAAKkO,EAAMV,QAAQhT,UAAY0T,EAAMV,QAAQ/S,QACzC,MAAO,CAAE8Y,SAAS,EAAOvT,MAAO,wDAGpC,IAAKiT,KAED,OADA,EAAS,gBAAiB,CAAEnS,aAAcV,EAAQU,eAC3C,CAAEyS,SAAS,EAAOvT,MAAO,yDAIpC,MAAMwT,EAAanB,GAAsBnE,GACzC,IAAKsF,EACD,MAAO,CAAED,SAAS,EAAOvT,MAAO,qCAIpC,MAAMmS,EAAkBsB,GACpBD,EACAtF,EAAMZ,UAAUvS,KAChBqF,EAAQ2R,OAAS,QAUrB,OAPA,EAAS,OAAQ,iCAAkC,CAC/CvC,UAAWtB,EAAML,eAAiB,EAClCP,UAAWY,EAAMZ,UAAUvS,KAC3B6Y,aAAczB,EAAgB3S,eAIrBqU,GACTtT,EAASvC,aACTmU,EACA,KACAkB,EACA9S,EAASzC,mBAEjB,G,CU4mC6B81B,CACjBjJ,GAAWhJ,SACXgJ,GAAWsC,gBAAgB5Z,QAG3BX,EAAOa,SACPoX,GAAWhJ,SXjwBhB,SACHzT,EACA2lB,GAEA,MAAMC,EAAW,+BACVD,GAAc,CACjBx0B,UAAWC,KAAKuF,MAChB2c,QAAQ,IAQZ,OALA,EAAS,QAAS,uBAAwB,CACtChS,UAAWtB,EAAML,eACjByI,eAAgBud,EAAetkB,SAAS/P,SAGrC,OAAP,wBACO0O,GAAK,CACRP,aAAc,KACdH,QAAS,OAAF,wBACAU,EAAMV,SAAO,CAChBhT,QAASs5B,IAGblmB,YAAa,OAAF,wBACJM,EAAMN,aAAW,CACpBpT,QAAS,WACTC,QAAS,aAGrB,CWouBkCs5B,CAAmBpJ,GAAWhJ,SAAU,CAC1DpS,SAAUmD,EAAOnD,SACjBwE,cAAc,EACdigB,WAAY,sBACZC,WAAY,OAGhBtb,OAAOpF,QAAQ,eAAeoX,GAAWhJ,SAAS9T,2BAG9C8c,GAAWhJ,SAASrU,kBACd8c,GAAqBO,GAAWhJ,SAASrU,UAAWqd,GAAWhJ,SAAS7T,mBAIlF6c,GAAWuC,gBAAkB,YAG7BvC,GAAWhJ,SAAW,OAAH,wBACZgJ,GAAWhJ,UAAQ,CACtB9T,eAAgB2lB,EAAmB3lB,eACnCC,iBAAkB0lB,EAAmB1lB,mBAGpB,yBAAjB4E,EAAO1S,OACP2Y,OAAO3Y,MAAM0S,EAAO1S,OAGhC,CAAE,MAAO8B,GAEL6oB,GAAWhJ,SAAW,OAAH,wBACZgJ,GAAWhJ,UAAQ,CACtB9T,eAAgB2lB,EAAmB3lB,eACnCC,iBAAkB0lB,EAAmB1lB,mBAGzC6K,OAAO3Y,MAAO8B,EAAY0F,QAC9B,C,QACImjB,GAAW5c,YAAa,EACxB4c,GAAWsC,gBAAkB,KAC7BJ,IACJ,CACJ,G,CA3YYqH,GAIAvO,EAAOC,QAAQ,IAAI,iBAA6B+E,KAChDA,GAAWhJ,UXvVOzT,EWuVkByc,GAAWhJ,UXtV5CnU,QAAQhT,SAInB,EAAS,QAAS,4BAA6B,CAAEgV,UAAWtB,EAAML,iBAE3D,OAAP,wBACOK,GAAK,CACRV,QAAS,OAAF,wBACAU,EAAMV,SAAO,CAChBhT,QAAS,OAAF,wBACA0T,EAAMV,QAAQhT,SAAO,CACxBgnB,QAAQ,MAGhBzT,YAAY,KAdLG,EWsVHyK,OAAOpF,QAAQ,6BACfsZ,MAIAlH,EAAOC,QAAQ,IAAI,eAA2B+E,GAAY,CAC1D,MAAMjY,EAASiY,GAAWhJ,SAASnU,QAAQmd,GAAWuC,iBAClDxa,IACAkU,UAAUC,UAAUC,UAAUpU,EAAOnD,UACrCoJ,OAAOpF,QAAQ,uBAEvB,CAGIoS,EAAOC,QAAQ,IAAI,iBAA6B+E,KAChDA,GAAWhJ,SAAW/O,GAAc+X,GAAWhJ,UAC3CgJ,GAAWhJ,SAAS3T,aACpB4Y,UAAUC,UAAUC,UAAU6D,GAAWhJ,SAAS3T,YAClD2K,OAAOpF,QAAQ,gCAKnBoS,EAAOC,QAAQ,IAAI,kBAA6B+E,cAAU,EAAVA,GAAYsC,kBAC5DtC,GAAWsC,gBAAgBI,OAEnC,KACJ,CA5hBQ8G,IJjcD,IACH5vB,EACAmO,EACAqF,EIkcA,MAAMqc,EAAmBxJ,GAAavT,cAAc,IAAI,iCACpD+c,IACAA,EAAiBnd,UAAYuL,GACzBmI,GAAWhJ,SAAS7T,iBACpB6c,GAAWhJ,SAAS9T,eACpB8c,GAAWhI,eA+mBvB,WACI,IAAKiI,KAAiBD,GAAY,OAElC,MAAMnR,EAAYoR,GAAavT,cAAc,IAAI,iCACjD,IAAKmC,EAAW,OAEhBA,EAAU+K,iBAAiB,SAAgBziB,GAAM,mCAC7C,MAAM6jB,EAAS7jB,EAAE6jB,OAGX0O,EAAY1O,EAAOC,QAAQ,IAAI,0BACrC,GAAIyO,GAAa1J,GAAY,CACzB,MAAMxc,EAAQ9C,SAASgpB,EAAUxO,aAAa,eAAiB,KAAM,IACjE1X,GAAS,UAgBzB,SAAuCA,G,0CACnC,IAAKwc,GAAY,OAEjB,MAAM,MAAErS,EAAK,aAAEC,GAAiBlY,YAAYC,oBAEpBgY,EAAME,KAAKqX,QAC/B,gCACA,iDAAiD1hB,EAAQ,mCAG3CoK,EAAauX,cAE/BnF,GAAWhJ,SXpiBR,SAA2BzT,EAAsBomB,GACpD,GAAIA,EAAiB,GAAKA,GAAkBpmB,EAAMJ,iBAAiBtO,OAE/D,OADA,EAAS,0BAA2B,CAAE80B,iBAAgB5J,cAAexc,EAAMJ,iBAAiBtO,SACrF0O,EAGX,MAAMoB,EAAWpB,EAAMJ,iBAAiBwmB,GAExC,EAAS,QAAS,yBAA0B,CAAE9kB,UAAWF,EAASE,YAGlE,MAAM+kB,EAA+B,CACjChlB,SAAUD,EAASG,gBACnBsE,cAAc,EACdigB,WAAY,oCACZC,WAAY,KACZ50B,UAAWC,KAAKuF,MAChB2c,QAAQ,GAINgT,EAAiBtmB,EAAMJ,iBAAiB9L,MAAM,EAAGsyB,GAEvD,OAAO,OAAP,wBACOpmB,GAAK,CACRV,QAAS,OAAF,wBACAU,EAAMV,SAAO,CAChBhT,QAAS+5B,EACT95B,QAAS,OAEbmT,YAAa,OAAF,wBACJM,EAAMN,aAAW,CACpBpT,QAAS,WACTC,QAAS,YAEboT,eAAgByB,EAASE,UACzB1B,iBAAkB0mB,EAClBzmB,YAAY,GAEpB,CW6f0B0mB,CAAkB9J,GAAWhJ,SAAUxT,GAC7DwK,OAAO5Q,KAAK,0BAA0BoG,EAAQ,KAG1Cwc,GAAWhJ,SAASrU,kBACd8c,GAAqBO,GAAWhJ,SAASrU,UAAWqd,GAAWhJ,SAAS7T,mBAGlF+e,KACJ,G,CApCsB6H,CAAwBvmB,GAEtC,CAGA,MAAMwmB,EAAUhP,EAAOC,QAAQ,IAAI,wBACnC,GAAI+O,GAAWhK,GAAY,CACvB,MAAMxc,EAAQ9C,SAASspB,EAAQ9O,aAAa,eAAiB,KAAM,IAC/D1X,GAAS,GAAKA,EAAQwc,GAAWhJ,SAAS7T,iBAAiBtO,QA8B3E,SAAiCuT,G,mCAC7B,MAAM,MAAEuF,EAAK,WAAE+K,GAAehjB,YAAYC,cACpC,UAAEkX,GAAcnX,YAAYyC,KAE5BuJ,EHp+BH,SAAoC0G,GACvC,MAAM,OAAEuQ,GAAWjjB,YAAYyC,KAE/B,MAAO,qBACO,yCACE,qDACKiQ,EAAKvD,UAAY,gCACnB,uBAAiCyT,GAAgBlQ,EAAKnW,4CAC9CmmB,GAAehQ,EAAKnW,6BACvCsmB,GAAcnQ,EAAKnW,mDAER,qBAA+B0mB,EAAOvQ,EAAK1T,WAAWwL,OAAO,oEAGhE,6EAEE,yCACV,GAAWkI,EAAKtD,uEAIR,8EAEE,yCACV,GAAWsD,EAAK5D,iEAK5B,CGu8BoBylB,CAA2B7hB,GAErCof,EAAQ,IAAI7Z,EAAMd,EAAUE,SAASrL,GAAUgX,EAAWI,KAAM,GAAI,CACtEC,MAAM,EACNC,OAAO,EACPC,wBAAwB,EACxBC,SAAU,QACVC,cAAc,UAGZqO,EAAM3Z,MAChB,G,CA5CgBqc,CAAkBlK,GAAWhJ,SAAS7T,iBAAiBK,GAE/D,CACJ,KACJ,CAxoBQ2mB,IAIsD,QAA1D,EAAAlK,GAAavT,cAAc,IAAI,yBAA2B,SAAEkN,iBAAiB,SAAS,KAClFpB,IAAkB,KAEVwH,IAmBhB,WACI,IAAKA,GAAY,OAEjB,IAAK,MAAMpmB,KAAS,EAAQ,CACxB,MAAMsH,EAAS8e,GAAWhJ,SAASlU,QAAQlJ,GAGvCsH,EAAO7O,iBAAmB,EAAgB6O,EAAO7O,kBACjD,EAAS,OAAQ,2CAA4C,CAAEuH,QAAO4sB,SAAUtlB,EAAO7O,iBACvF2tB,GAAWhJ,SAAW,GAA0BgJ,GAAWhJ,SAAUpd,EAAO,CACxEvH,eAAgB,QAKpB6O,EAAO3O,iBAAmB,EAAgB2O,EAAO3O,kBACjD,EAAS,OAAQ,2CAA4C,CAAEqH,QAAO4sB,SAAUtlB,EAAO3O,iBACvFytB,GAAWhJ,SAAW,GAA0BgJ,GAAWhJ,SAAUpd,EAAO,CACxErH,eAAgB,OAG5B,CACJ,CAxCgB63B,GAEJlI,IAAqB,GACvB,IAGiD,QAAvD,EAAAjC,GAAavT,cAAc,IAAI,sBAAwB,SAAEkN,iBAAiB,SAAS,KAC/E,MAAMyQ,EAASpK,cAAY,EAAZA,GAAchF,QAAQ,UACrC,GAAIoP,EAAQ,CACR,MAAMC,EAAYD,EAAO3d,cAAc,0CACvC4d,SAAAA,EAAWC,OACf,IAER,CA1JIC,CAAe3J,GACfqB,KAEA,EAAS,OAAQ,eAAgB,CAAEvrB,eAAgBkqB,EAAShsB,QAChE,G,CAqTA,SAAeuvB,GAAgBxgB,EAAiBJ,G,0CAC5C,IAAKwc,GAAY,OAEjBA,GAAWhJ,SAAW1T,EAAa0c,GAAWhJ,SAAUpT,EAAMJ,GAC9Dwc,GAAWhI,eAAgB,EAC3BkK,KAGA,MAAMpK,QD1lBH,SACHnV,G,0CAEA,MAAM,YAAE+c,GAAgBhqB,YAAYyC,KAC9B3I,EAAM8vB,GAAgB3c,GAE5B,IACI,MAAMnO,QAAakrB,EAAY+K,QAAQj7B,GAOvC,OAAKgF,EAMDA,EAAKorB,gBAAkBjd,EAAUvS,MAAQoE,EAAKqrB,kBAAoBld,EAAUqJ,QAC5E,EAAS,OAAQ,4CAA6C,CAC1Dxc,MACAk7B,WAAYl2B,EAAKorB,cACjB+K,YAAahoB,EAAUvS,OAEpB,OAGX,EAAS,OAAQ,2BAA4B,CACzCZ,MACAowB,cAAejd,EAAUvS,KACzB2vB,cAAevrB,EAAKsjB,QAAQjjB,OAC5BirB,QAAS,IAAInrB,KAAKH,EAAKsrB,SAAStoB,gBAG7BhD,EAAKsjB,UArBR,EAAS,OAAQ,6BAA8B,CAAEtoB,QAC1C,KAqBf,CAAE,MAAO2H,GAEL,OADA,EAAS,mCAAoC,CAAE3H,MAAK6F,MAAO8B,IACpD,IACX,CACJ,G,CCijB0ByzB,CAAqBhnB,GACvCoc,IAAcA,GAAWhJ,SAASrU,YAAciB,IAC5CkU,GAAWA,EAAQjjB,OAAS,IAC5BmrB,GAAWhJ,SAAW,OAAH,wBACZgJ,GAAWhJ,UAAQ,CACtB7T,iBAAkB2U,EAClB5U,eAAgB4U,EAAQjjB,SAE5B,EAAS,OAAQ,2BAA4B,CAAE6sB,MAAO5J,EAAQjjB,UAElEmrB,GAAWhI,eAAgB,EAC3BgR,MAIJzP,YAAW,IAAY,mCACnB,IAAK0G,MAAiBD,cAAU,EAAVA,GAAYhJ,SAASrU,WAAW,OAEtD,MAAMkM,EAAYoR,GAAavT,cAAc,IAAI,gCACjD,GAAImC,EAAW,CACX,MAAMpJ,EAAS,GAAmBua,GAAWhJ,SAASrU,iBTjhB3D,SAAsCkM,EAAwBpJ,G,0CACjE,MAAM,mBAAEolB,GAAuBn1B,YAAYC,aAGrCm1B,EAAgBrlB,EAAOnO,KAAWlG,GAAU,mCAC9C,MAAM25B,EAlJd,SAA0BrpB,GAEtB,IAAIspB,EAAO,EACX,IAAK,IAAI5rB,EAAI,EAAGA,EAAIsC,EAAQ7M,OAAQuK,IAEhC4rB,GAASA,GAAQ,GAAKA,EADTtpB,EAAQupB,WAAW7rB,GAEhC4rB,GAAOA,EAEX,MAAO,GAAGA,KAAQtpB,EAAQ7M,QAC9B,CAyIyBq2B,CAAiB95B,EAAMP,OAGxC,GAAI+a,GAAWzS,IAAI4xB,GACf,MAAO,CAAE35B,QAAO00B,OAAQla,GAAWuf,IAAIJ,IAG3C,IACI,MAAMjF,QAAe+E,EAAmBz5B,EAAMP,OAE9C,OADA+a,GAAWwf,IAAIL,EAAUjF,GAClB,CAAE10B,QAAO00B,SACpB,CAAE,SACE,MAAO,CAAE10B,QAAO00B,OAAQ,KAC5B,CACJ,MAGMjjB,QAAgBwW,QAAQgS,IAAIP,GAGlC,IAAIQ,EAAc,EAElB,IAAK,MAAM,MAAEl6B,EAAK,OAAE00B,KAAYjjB,EAAS,CACrC,MAAM0oB,EAAY1c,EAAUnC,cAAc,IAAI,8BAAwCtb,EAAM5B,SACxF+7B,IACe,OAAXzF,GACAwF,GAAexF,EACfyF,EAAUnc,YAAc,GAAG0W,EAAO3d,qBAElCojB,EAAUnc,YAAc,IAGpC,CAGA,MAAMoc,EAAY3c,EAAUnC,cAAc,IAAI,kBAC1C8e,IACAA,EAAUpc,YAAc,GAAGkc,EAAYnjB,0BAE/C,G,CSsekBsjB,CAAuB5c,EAA0BpJ,EAC3D,CACJ,KAAG,IAEH,EAAS,OAAQ,qBAAsB,CAAErV,KAAMwT,EAAKxT,KAAMoT,SAC9D,G,CAgeA,SAAeyf,GAAerpB,G,0CAC1B,IAAKomB,IAAcA,GAAWlR,cAAgBkR,GAAW5c,WAAY,OAErE,IAAKkF,KAED,YADA0F,OAAO3Y,MAAM,wBAIjB,MAAM6O,EXx8BH,SAAqBX,EAAsB3J,G,MAC9C,IAAK2J,EAAMZ,UACP,MAAO,CAAEuB,QAAQ,EAAOC,OAAQ,yBAIpC,OAAQvK,GACJ,IAAK,QAED,MAAO,CAAEsK,QAAQ,GAErB,IAAK,UAGD,OAAIX,EAAMR,eAAelJ,SAAS,YAAgC,QAAnB,EAAA0J,EAAMV,QAAQjT,aAAK,eAAEinB,QACzD,CACH3S,QAAQ,EACRC,OAAQ,sEAGT,CAAED,QAAQ,GAErB,IAAK,UAED,OAAKX,EAAMV,QAAQhT,QAGZ,CAAEqU,QAAQ,GAFN,CAAEA,QAAQ,EAAOC,OAAQ,+CAIxC,QACI,MAAO,CAAED,QAAQ,EAAOC,OAAQ,iBAE5C,CWw6BmBunB,CAAY1L,GAAWhJ,SAAUpd,GAChD,IAAKsK,EAAOA,OAER,YADA8J,OAAO4S,QAAQ1c,EAAOC,QAAU,yBAIhCD,EAAOC,QACP6J,OAAO5Q,KAAK8G,EAAOC,QAGvB6b,GAAWlR,cAAe,EAC1BkR,GAAWsC,gBAAkB,IAAIwG,gBACjC9I,GAAWhJ,SXn3BR,SAAoBzT,EAAsB3J,GAG7C,OAFA,EAAS,QAAS,gBAAiB,CAAEA,UAE9B,OAAP,wBACO2J,GAAK,CACRP,aAAcpJ,EACdqJ,YAAa,OAAF,wBACJM,EAAMN,aAAW,CACpB,CAACrJ,GAAQ,aAGrB,CWw2B0B+xB,CAAW3L,GAAWhJ,SAAUpd,GACtDsoB,KAEA,MAAMmH,EAAapiB,GAAiB+Y,GAAWhJ,SAAUpd,IAAU,GAC7D0vB,EAAaxhB,GAAekY,GAAWhJ,SAAUpd,GAEvD,IACI,MAAMmO,QAAeU,GACjBuX,GAAWhJ,SACXpd,EACAomB,GAAWsC,gBAAgB5Z,QAG3BX,EAAOa,SACPoX,GAAWhJ,SXj3BhB,SACHzT,EACA3J,EACAmO,GAEA,MAAMohB,EAAW,+BACVphB,GAAM,CACTrT,UAAWC,KAAKuF,MAChB2c,QAAQ,IAGZ,EAAS,QAAS,kBAAmB,CACjCjd,QACA+R,eAAgB5D,EAAOnD,SAAS/P,OAChCuU,aAAcrB,EAAOqB,eAIzB,MAAMhG,EAAuB,YAAVxJ,GAAiD,OAA1B2J,EAAMV,QAAQhT,QAExD,OAAO,OAAP,wBACO0T,GAAK,CACRP,aAAc,KACdC,YAAa,OAAF,wBACJM,EAAMN,aAAW,CACpB,CAACrJ,GAAQ,aAEbiJ,QAAS,OAAF,wBACAU,EAAMV,SAAO,CAChB,CAACjJ,GAAQuvB,IAEb/lB,cAER,CWg1BkCwoB,CAAc5L,GAAWhJ,SAAUpd,EAAO,CAC5DgL,SAAUmD,EAAOnD,SACjBwE,aAAcrB,EAAOqB,aACrBigB,aACAC,eAEJtb,OAAOpF,QAAQ,GAAGjZ,EAAaiK,iBAE/BomB,GAAWhJ,SAAW3S,GAAU2b,GAAWhJ,SAAUpd,EAAOmO,EAAO1S,OAC9C,yBAAjB0S,EAAO1S,OACP2Y,OAAO3Y,MAAM0S,EAAO1S,OAGhC,CAAE,MAAO8B,GACL6oB,GAAWhJ,SAAW3S,GAAU2b,GAAWhJ,SAAUpd,EAAQzC,EAAY0F,SACzEmR,OAAO3Y,MAAO8B,EAAY0F,QAC9B,C,QACImjB,GAAWlR,cAAe,EAC1BkR,GAAWsC,gBAAkB,KAC7BJ,IACJ,CACJ,G,CAEA,SAAe8C,K,0CACX,IAAKhF,IAAcA,GAAWlR,cAAgBkR,GAAW5c,WAAY,OAErE,IAAKkF,KAED,YADA0F,OAAO3Y,MAAM,wBAIjB,MAAM6Y,EXmCH,SAA0B3K,GAC7B,MAAMtM,EAAmB,GACnBkG,EAAqB,GAGtBoG,EAAMZ,WACP1L,EAAOmC,KAAK,yBAIoB,IAAhCmK,EAAMR,eAAelO,QACrBoC,EAAOmC,KAAK,sBAIhB,IAAK,MAAMQ,KAAS2J,EAAMR,eAEP9B,EADAsC,EAAMT,QAAQlJ,IAGjB4C,QACRvF,EAAOmC,KAAK,GAAGQ,2BAIL,YAAVA,IAAwB2J,EAAMV,QAAQjT,OAAS2T,EAAMR,eAAelJ,SAAS,UAC7EsD,EAAS/D,KAAK,gEAGJ,YAAVQ,GAAwB2J,EAAMV,QAAQhT,SACtCoH,EAAOmC,KAAK,oCAKpB,MAAM,aAAEjD,GAAiBT,YAAYC,aAKrC,MAJqB,UAAjBQ,GAA6C,cAAjBA,GAC5Bc,EAAOmC,KAAK,wBAGT,CACHqD,MAAyB,IAAlBxF,EAAOpC,OACdoC,SACAkG,WAER,CW/EuB0uB,CAAiB7L,GAAWhJ,UAC/C,GAAK9I,EAAWzR,MAAhB,CAKIyR,EAAW/Q,SAAStI,OAAS,GAC7BmZ,OAAO4S,QAAQ1S,EAAW/Q,SAASiB,KAAK,OAG5C,IAAK,MAAMxE,KAASomB,GAAWhJ,SAASjU,eAAgB,CACpD,MAAMqK,EAAS4S,GAAWhJ,SAAS/T,YAAYrJ,GAC/C,GAAe,aAAXwT,GAAoC,YAAXA,EACzB,SAQJ,GALA4S,GAAWuC,gBAAkB3oB,EAC7BkrB,WAEM7B,GAAerpB,IAEhBomB,GAAY,MAGjB,GAAkB,aADAA,GAAWhJ,SAAS/T,YAAYrJ,GAE9C,KAER,CAvBA,MAFIoU,OAAO3Y,MAAM6Y,EAAWjX,OAAOmH,KAAK,MA0B5C,G,CA8GA,SAAS8jB,KACLD,KACAH,KACAgD,KACAC,KACAvE,KACAuI,KACAC,IACJ,CAEA,SAAS/G,KACL,IAAKhC,KAAiBD,GAAY,OAElC,MAAMnR,EAAYoR,GAAavT,cAAc,IAAI,gCAC7CmC,GTjvCD,SACHA,EACAlM,EACAmpB,GAEA,MAAMC,EAAgBld,EAAUnC,cAAc,IAAI,oBAC5Csf,EAAkBnd,EAAUnC,cAAc,IAAI,kBAEpD,GAAI/J,GAGA,GAFAopB,SAAAA,EAAevc,UAAU7Q,IAAI,WAExBqtB,EAAiB,CAClB,MAAMzE,EAAczb,GAAuBnJ,GACrCspB,EAAWpd,EAAUnC,cAAc,IAAI,oBACzCuf,GACAA,EAASlc,mBAAmB,WAAYwX,EAEhD,MACG,CACHwE,SAAAA,EAAevc,UAAUb,OAAO,UAChCqd,SAAAA,EAAiBrd,SAEjB,MAAM2U,EAAczU,EAAUnC,cAAc,IAAI,iBAC5C4W,IACAA,EAAYzyB,MAAQ,GAE5B,CACJ,CSutCQq7B,CACIrd,EACAmR,GAAWhJ,SAASrU,UACpBqd,GAAWhJ,SAASpU,eAGhC,CAEA,SAASkf,KACL,IAAK7B,KAAiBD,GAAY,OAElC,MAAMnR,EAAYoR,GAAavT,cAAc,IAAI,4BAC7CmC,GPtwCD,SACHA,EACA9L,EACAE,EACAiK,EACAC,EACA2B,GAGA,IAAK,MAAMlV,KAAS,EAAQ,CACxB,MAAM6qB,EAAW5V,EAAUnC,cAAc,IAAI,cAAwB9S,KAC/DirB,EAAMhW,EAAUnC,cAAc,IAAI,2BAAqC9S,OACvEa,EAAOoU,EAAUnC,cAAc,IAAI,iCAA2C9S,QAUpF,GARI6qB,IACAA,EAASnV,QAAUvM,EAAelJ,SAASD,IAG3CirB,GACAA,EAAIrV,UAAUC,OAAO,SAAU7V,IAAUsT,GAGzCzS,EAAM,CACNA,EAAK+U,UAAUC,OAAO,SAAU7V,IAAUsT,GAG1C,IAAK,MAAM3G,IAAK,CAAC,UAAW,UAAW,WAAY,WAC/C9L,EAAK+U,UAAUC,OAAO,GAAG,WAAqBlJ,IAAKtD,EAAYrJ,KAAW2M,EAElF,CAGA,MAAM4lB,EAAY1xB,aAAI,EAAJA,EAAMiS,cAAc,IAAI,qBAC1Cyf,SAAAA,EAAW3c,UAAUC,OAAO,SAAU1M,EAAelJ,SAASD,GAClE,CAGA,MAAMwyB,EAAiBvd,EAAUnC,cAAc,IAAI,sBAC7C2f,EAAYxd,EAAUnC,cAAc,IAAI,iBACxC4f,EAAWzd,EAAUnC,cAAc,IAAI,wBAEzC0f,IAAgBA,EAAend,UAAY9B,GAAgB2B,GAC3Dud,IAAWA,EAAUpd,UAAY9B,GAAgB2B,GACjDwd,IAAUA,EAASrd,SAAWH,EACtC,CO2tCQyd,CACI1d,EACAmR,GAAWhJ,SAASjU,eACpBid,GAAWhJ,SAAS/T,YACpB+c,GAAWuC,kBACTvC,GAAWhJ,SAASrU,WAAa2F,KACnC0X,GAAWlR,cAAgBkR,GAAW5c,WAGlD,CAEA,SAAS0hB,KACL,IAAK7E,KAAiBD,GAAY,OAElC,MAAM5O,EAAO6O,GAAavT,cAAc,IAAI,gBACtCkJ,EAAQqK,GAAavT,cAAc,IAAI,iBAEzC0E,IACAA,EAAK5C,UAAY,YAAYze,EAAYiwB,GAAWuC,oBAEpD3M,IACAA,EAAMxG,YAAczf,EAAaqwB,GAAWuC,kBAGhD8D,IACJ,CAEA,SAASA,KACL,IAAKpG,KAAiBD,GAAY,OAElC,MAAMnR,EAAYoR,GAAavT,cAAc,IAAI,4BAC7CmC,GACAD,GACIC,EACAmR,GAAWuC,gBACXvC,GAAWhJ,SAASlU,QAAQkd,GAAWuC,iBACvCvC,GAAWlR,cAAgBkR,GAAW5c,WAGlD,CAEA,SAAS2hB,KACL,IAAK9E,KAAiBD,GAAY,OAElC,MAAMnR,EAAYoR,GAAavT,cAAc,IAAI,uBAC7CmC,GACAiI,GACIjI,EACAmR,GAAWuC,gBACXvC,GAAWhJ,SAASnU,QAAQmd,GAAWuC,iBACvCvC,GAAWhJ,SAAS/T,YAAY+c,GAAWuC,iBAC3CvC,GAAWlR,aACXjI,GAAamZ,GAAWhJ,SAAUgJ,GAAWuC,iBAC7CvC,GAAWhJ,SAGvB,CAEA,SAAS+R,KACL,IAAK9I,KAAiBD,GAAY,OAElC,MAAMwM,EAAYvM,GAAavT,cAAc,IAAI,yBAC5C8f,IAEDxM,GAAWhJ,SAAS9T,eAAiB,GAAK8c,GAAWhJ,SAAS5T,YAC9DopB,EAAUhd,UAAUb,OAAO,UAC3B6d,EAAUlgB,UAAY,uEAEX0T,GAAWhJ,SAAS9T,eAAiB,WAGhDspB,EAAUhd,UAAU7Q,IAAI,UAEhC,CAEA,SAASqqB,KACL,IAAK/I,KAAiBD,GAAY,OAElC,MAAMnR,EAAYoR,GAAavT,cAAc,IAAI,iCAC7CmC,GHj1CD,SACHA,EACAiJ,EACAC,EACAC,GAEA,MAAMyU,EAAY5d,EAAUnC,cAAc,IAAI,uBAE9C,IAAK+f,IAAc3U,EAAQjjB,OAAS,GAAKkjB,EAAmB,GAAI,CAE5D,MAAMzF,EAAOuF,GAAuBC,EAASC,EAAkBC,GAC/DnJ,EAAUkB,mBAAmB,YAAauC,EAC9C,MAAO,GAAIma,EAAW,CAElB,MAAMC,EAAUD,EAAU/f,cAAc,IAAI,qBACxCggB,IACAA,EAAQtd,YAAc2I,EAAmB,EAAI,aAAaA,EAAmB,IAAM,WAGvF,MAAM4U,EAASF,EAAU/f,cAAc,IAAI,oBACvCigB,IACK3U,EAKyB,IAAnBF,EAAQjjB,OACf83B,EAAOrgB,UAAY,eAAe,kDAElCqgB,EAAOrgB,UAAYwL,EAAQxgB,KAAI,CAAC8Q,EAAMhJ,IAAM8Y,GAAoB9P,EAAMhJ,KAAIhB,KAAK,IAP/EuuB,EAAOrgB,UAAY,eAAe,sKAU9C,CACJ,CGizCQsgB,CACI/d,EACAmR,GAAWhJ,SAAS7T,iBACpB6c,GAAWhJ,SAAS9T,eACpB8c,GAAWhI,cAGvB,CAEA,SAAewI,K,0CACX,IAAKP,KAAiBD,GAAY,OAElC,MAAM6M,EAAU5M,GAAavT,cAAc,IAAI,oBAC/C,IAAKmgB,EAAS,OAEd,IAAK7M,GAAWhJ,SAASrU,UAGrB,OAFAkqB,EAAQvgB,UAAY,gEACpBugB,EAAQre,UAAY,GAAG,oBAQ3B,IAAIse,EAOJ,GAXAD,EAAQvgB,UAAY,8CACpBugB,EAAQre,UAAY,GAAG,mBAKnBse,EADA9M,GAAWhJ,SAAS5T,YAAc4c,GAAWhJ,SAASnU,QAAQhT,SAAWmwB,GAAWhJ,SAASnU,QAAQ/S,cVj9BtG,SACHyT,G,0CAEA,MAAM,mBAAEsnB,EAAkB,WAAEn0B,GAAehB,YAAYC,aACjDC,EAAW,IAEjB,IAAK2N,EAAMZ,YAAcY,EAAMV,QAAQhT,UAAY0T,EAAMV,QAAQ/S,QAAS,OAAO,KAEjF,IACI,MAAMW,EAASiX,GAAsBnE,GACrC,IAAK9S,EAAQ,OAAO,KAEpB,MAAMs8B,EAAan3B,EAASvC,aAAe,OAAS5C,EAC9Cu8B,QAAqBnC,EAAmBkC,GAG9C,MAAO,CACHC,eACAC,YAAav2B,EACbqvB,WALeznB,KAAK4uB,MAAOF,EAAet2B,EAAc,KAOhE,CAAE,MAAOS,GAEL,OADA,EAAS,gCAAiCA,GACnC,IACX,CACJ,G,CUy7BuBg2B,CAAwBnN,GAAWhJ,gBVj/BnD,SACHzT,EACA3J,G,0CAEA,MAAM,mBAAEixB,EAAkB,WAAEn0B,GAAehB,YAAYC,aACjDC,EAAW,IAEjB,IAAK2N,EAAMZ,UAAW,OAAO,KAE7B,IACI,MAAMlS,EAASwW,GAAiB1D,EAAO3J,GACvC,IAAKnJ,EAAQ,OAAO,KAEpB,MAAMs8B,EAAan3B,EAASvC,aAAe,OAAS5C,EAC9Cu8B,QAAqBnC,EAAmBkC,GAG9C,MAAO,CACHC,eACAC,YAAav2B,EACbqvB,WALeznB,KAAK4uB,MAAOF,EAAet2B,EAAc,KAOhE,CAAE,MAAOS,GAEL,OADA,EAAS,qBAAsBA,GACxB,IACX,CACJ,G,CUy9BuBi2B,CAAmBpN,GAAWhJ,SAAUgJ,GAAWuC,kBAGjEvC,KAAeC,GAAc,OAElC,IAAK6M,EAGD,OAFAD,EAAQvgB,UAAY,gDACpBugB,EAAQre,UAAY,GAAG,oBAI3B,IAAI6e,EAAa,GACbP,EAAO/G,WAAa,IAAKsH,EAAa,SACjCP,EAAO/G,WAAa,KAAIsH,EAAa,WAE9CR,EAAQvgB,UAAY,yCAAyCwgB,EAAOE,aAAa7kB,sBAAsB2kB,EAAO/G,eAC9G8G,EAAQre,UAAY,GAAG,oBAA8B6e,GACzD,G,4SCv+CO,SAAeC,K,0CAClB,MAAM,6BAAEC,GAAiC73B,YAAYC,aAE/CkZ,EAAYR,SAASoL,eAAe,uBAC1C,GAAK5K,EAKL,IACI,MAAMyD,QAAaib,EAA6Bp+B,EAAgB,kBAAmB,CAAC,GAAG,GAEjFq+B,EAAUnf,SAASE,cAAc,OACvCif,EAAQr9B,GAAK,GAAG,YAChBq9B,EAAQlhB,UAAYgG,EACpBzD,EAAUH,YAAY8e,GAc9B,WAEI,MAAMC,EAAUpf,SAASoL,eAAe,GAAG,cAC3CgU,SAAAA,EAAS7T,iBAAiB,SAAS,KAC/ByI,IAAe,IAInB,MAAMqL,EAAcrf,SAASoL,eAAe,GAAG,kBAC3CiU,IACAA,EAAYpe,QAAU,IAAc5b,UACpCg6B,EAAY9T,iBAAiB,UAAU,KACnClgB,EAAag0B,EAAYpe,SACzBtB,OAAO5Q,KAAK,eAAcswB,EAAYpe,QAAU,UAAY,YAAa,IAGrF,CA5BQqe,GAEA,EAAS,OAAQ,oBAAqB,KAC1C,CAAE,MAAOt4B,GACL,EAAS,gCAAiCA,EAC9C,MAjBI,EAAS,iCAAkC,KAkBnD,G,CCDA,MAAM,YAAE+qB,GAAW,WAAEC,IAAe3qB,YAAYC,aAChDyqB,GAAYa,GAAGZ,GAAWuN,WA/B1B,WACI,IACI,EAAS,OAAQ,yBAA0B,CAAE9R,QAAS,UAEtDwR,KAUR,WACI,MAAM,YAAElN,EAAW,WAAEC,GAAe3qB,YAAYC,aAGhDyqB,EAAYa,GAAGZ,EAAWkB,+BAA+B,KACrD,EAAS,OAAQ,iCAAkC,KAAK,IAG5DnB,EAAYa,GAAGZ,EAAWmB,8BAA8B,KACpD,EAAS,OAAQ,gCAAiC,KAAK,IAG3D,EAAS,OAAQ,6BAA8B,KACnD,CAtBQqM,GAEA,EAAS,OAAQ,mBAAoB,IACzC,CAAE,MAAOx4B,GACL,EAAS,kCAAmCA,GAC5C2Y,OAAO3Y,MAAM,mEACjB,CACJ,G","sources":["webpack://extension-webpack-template/./src/constants.ts","webpack://extension-webpack-template/./src/debug.ts","webpack://extension-webpack-template/./src/settings.ts","webpack://extension-webpack-template/./src/schema.ts","webpack://extension-webpack-template/./src/presets.ts","webpack://extension-webpack-template/./src/pipeline.ts","webpack://extension-webpack-template/./src/generator.ts","webpack://extension-webpack-template/./src/ui/components/character-select.ts","webpack://extension-webpack-template/./src/character.ts","webpack://extension-webpack-template/./src/ui/components/pipeline-nav.ts","webpack://extension-webpack-template/./src/ui/components/stage-config.ts","webpack://extension-webpack-template/./src/ui/formatter.ts","webpack://extension-webpack-template/./src/ui/components/results-panel.ts","webpack://extension-webpack-template/./src/ui/components/iteration-history.ts","webpack://extension-webpack-template/./src/ui/settings-modal.ts","webpack://extension-webpack-template/./src/persistence.ts","webpack://extension-webpack-template/./src/ui/popup.ts","webpack://extension-webpack-template/./src/ui/panel.ts","webpack://extension-webpack-template/./src/index.ts"],"sourcesContent":["// src/constants.ts\nimport type {\n    CharacterField,\n    StructuredOutputSchema,\n    PromptPreset,\n    SchemaPreset,\n    StageDefaults,\n    StageName,\n    GenerationConfig,\n    Settings,\n} from './types';\n\n// ============================================================================\n// MODULE INFO\n// ============================================================================\n\nexport const MODULE_NAME = 'character_tools';\nexport const EXTENSION_PATH = 'third-party/SillyTavern-CharacterTools';\nexport const SETTINGS_VERSION = 3;\n\n// ============================================================================\n// CHARACTER FIELDS\n// ============================================================================\n\nexport const CHARACTER_FIELDS: readonly CharacterField[] = Object.freeze([\n    { key: 'description', label: 'Description', scoreable: true },\n    { key: 'personality', label: 'Personality', scoreable: true },\n    { key: 'first_mes', label: 'First Message', scoreable: true },\n    { key: 'scenario', label: 'Scenario', scoreable: true },\n    { key: 'mes_example', label: 'Example Messages', scoreable: true },\n    { key: 'system_prompt', label: 'System Prompt', scoreable: true },\n    { key: 'post_history_instructions', label: 'Post-History Instructions', scoreable: false },\n    { key: 'creator_notes', label: 'Creator Notes', scoreable: false },\n]);\n\n// ============================================================================\n// STAGE DEFINITIONS\n// ============================================================================\n\nexport const STAGES: readonly StageName[] = Object.freeze(['score', 'rewrite', 'analyze']);\n\nexport const STAGE_LABELS: Record<StageName, string> = {\n    score: 'Score',\n    rewrite: 'Rewrite',\n    analyze: 'Analyze',\n};\n\nexport const STAGE_ICONS: Record<StageName, string> = {\n    score: 'fa-star-half-stroke',\n    rewrite: 'fa-pen-fancy',\n    analyze: 'fa-magnifying-glass-chart',\n};\n\nexport const STAGE_DESCRIPTIONS: Record<StageName, string> = {\n    score: 'Rate and critique the character card',\n    rewrite: 'Generate an improved version',\n    analyze: 'Compare original vs rewrite, check for soul loss',\n};\n\n// ============================================================================\n// DEFAULT SYSTEM PROMPT\n// ============================================================================\n\nexport const DEFAULT_SYSTEM_PROMPT = `You are a creative writing assistant specializing in character development for roleplay and fiction. Analyze character cards and provide thoughtful, actionable feedback.\n\nAdapt your response style to the task:\n- For scoring: Be critical but fair, rate 1-10 with specific justifications\n- For rewrites: Preserve the character's core identity while improving weak areas\n- For analysis: Compare versions objectively, identify what was lost or gained\n- For refinement: Address specific issues from analysis while keeping improvements\n\nFocus on: writing quality, character depth, consistency, roleplay usability, and potential issues (contradictions, clichs, underdeveloped areas).\n\nAlways maintain the character's essential personality and unique traits. Improvements should enhance, not replace, what makes the character interesting.`;\n\n// ============================================================================\n// DEFAULT REFINEMENT PROMPT\n// ============================================================================\n\nexport const DEFAULT_REFINEMENT_PROMPT = `You are refining a character card rewrite based on analysis feedback.\n\n## Original Character (Ground Truth)\n{{original_character}}\n\n## Current Rewrite (Iteration {{iteration_number}})\n{{current_rewrite}}\n\n## Analysis of Current Rewrite\n{{current_analysis}}\n\n{{#if score_results}}\n## Original Score Feedback (Reference)\n{{score_results}}\n{{/if}}\n\n---\n\n## Your Task\n\nCreate an improved version that:\n\n1. **Addresses Issues**: Fix the specific problems identified in the analysis\n2. **Preserves Wins**: Keep what the analysis said was working well\n3. **Maintains Soul**: The character must still feel like the original, just better\n4. **Avoids Regression**: Don't reintroduce problems that were already fixed\n\nOutput the complete refined character card with all fields. Mark significantly changed sections with [REFINED] at the start.\n\nDo NOT explain your changes - just output the improved character card.`;\n\n// ============================================================================\n// BUILTIN PROMPT PRESETS\n// ============================================================================\n\nexport const BUILTIN_PROMPT_PRESETS: readonly PromptPreset[] = Object.freeze([\n    {\n        id: 'builtin_score_default',\n        name: 'Default Score',\n        stages: ['score'],\n        isBuiltin: true,\n        createdAt: 0,\n        updatedAt: 0,\n        prompt: `Rate this character card on a scale of 1-10 for each populated field. For each field, provide:\n\n1. **Score** (1-10)\n2. **Strengths** - What works well\n3. **Weaknesses** - What needs improvement\n4. **Specific Suggestions** - Concrete changes to improve it\n\nAfter scoring all fields, provide:\n- **Overall Score** (weighted average, with First Message and Description weighted higher)\n- **Top 3 Priority Improvements** - The changes that would have the biggest impact\n- **Summary** - A brief overall assessment\n\nBe critical but constructive. Vague praise is useless. Specific, actionable feedback is gold.`,\n    },\n    {\n        id: 'builtin_score_quick',\n        name: 'Quick Score',\n        stages: ['score'],\n        isBuiltin: true,\n        createdAt: 0,\n        updatedAt: 0,\n        prompt: `Give a quick assessment of this character card:\n\n1. Overall score (1-10)\n2. Three biggest strengths\n3. Three areas needing work\n4. One-sentence summary\n\nKeep it concise but useful.`,\n    },\n    {\n        id: 'builtin_rewrite_default',\n        name: 'Default Rewrite',\n        stages: ['rewrite'],\n        isBuiltin: true,\n        createdAt: 0,\n        updatedAt: 0,\n        prompt: `Based on the scoring feedback, rewrite this character card to address the identified weaknesses while preserving its strengths.\n\nGuidelines:\n- Maintain the character's core personality and unique traits\n- Improve weak areas identified in the score\n- Keep the same general length unless brevity/expansion was specifically noted\n- Preserve any distinctive voice or style that works\n- Fix contradictions and fill gaps\n- Make the character more engaging for roleplay\n\nOutput the complete rewritten character card with all fields, using the same field structure as the original. Mark significantly changed sections with [REVISED] at the start.\n\n{{score_results}}`,\n    },\n    {\n        id: 'builtin_rewrite_conservative',\n        name: 'Conservative Rewrite',\n        stages: ['rewrite'],\n        isBuiltin: true,\n        createdAt: 0,\n        updatedAt: 0,\n        prompt: `Make minimal, surgical improvements to this character card. Only change what's clearly broken or weak.\n\nRules:\n- Change as little as possible\n- Preserve the author's voice completely\n- Only fix obvious issues (contradictions, grammar, clarity)\n- Do NOT add new content unless filling a critical gap\n- Do NOT change style or tone\n\nOutput only the fields you changed, with [ORIGINAL] and [REVISED] versions for comparison.\n\n{{score_results}}`,\n    },\n    {\n        id: 'builtin_rewrite_expansive',\n        name: 'Expansive Rewrite',\n        stages: ['rewrite'],\n        isBuiltin: true,\n        createdAt: 0,\n        updatedAt: 0,\n        prompt: `Significantly expand and enhance this character card. Add depth, detail, and richness.\n\nGoals:\n- Flesh out underdeveloped areas\n- Add sensory details and specific examples\n- Deepen personality with quirks, contradictions, history\n- Improve example messages with more variety\n- Make the character feel more three-dimensional\n\nDon't change the core concept, but make it shine. Output the complete expanded character card.\n\n{{score_results}}`,\n    },\n    {\n        id: 'builtin_analyze_default',\n        name: 'Default Analyze',\n        stages: ['analyze'],\n        isBuiltin: true,\n        createdAt: 0,\n        updatedAt: 0,\n        prompt: `Compare the original character card with the rewritten version. Analyze:\n\n## What Was Preserved\n- Core personality traits that remained intact\n- Distinctive elements that were kept\n- Voice and style consistency\n\n## What Was Lost\n- Any personality aspects that were diminished or removed\n- Unique quirks that disappeared\n- Tone shifts that changed the character's feel\n\n## What Was Gained\n- New depth or detail added\n- Improvements that enhance the character\n- Better clarity or consistency\n\n## Soul Check\nDoes the rewritten version still feel like the same character? Rate the \"soul preservation\" from 1-10 and explain.\n\n## Verdict\nState clearly: **ACCEPT** (ready to use), **NEEDS REFINEMENT** (good progress but has issues), or **REGRESSION** (worse than before).\n\n## Specific Issues to Address\nIf verdict is NEEDS REFINEMENT, list the specific problems that should be fixed in the next iteration.\n\n---\n\n### Original Character:\n{{original_character}}\n\n### Rewritten Version:\n{{rewrite_results}}\n\n### Score Feedback:\n{{score_results}}`,\n    },\n    {\n        id: 'builtin_analyze_iteration',\n        name: 'Iteration Analyze',\n        stages: ['analyze'],\n        isBuiltin: true,\n        createdAt: 0,\n        updatedAt: 0,\n        prompt: `This is iteration {{iteration_number}} of refinement. Compare the current rewrite against the original.\n\n## Progress Check\n- What issues from previous analysis were addressed?\n- What new issues (if any) were introduced?\n- Is this version better, worse, or lateral move from the last?\n\n## Current State Assessment\n\n### Preserved from Original\nCore traits and elements that remain intact.\n\n### Still Missing or Lost\nThings from the original that should be restored.\n\n### Successfully Improved\nWhat's genuinely better now.\n\n### New Problems\nAny issues introduced by this iteration.\n\n## Soul Preservation Score\nRate 1-10: Does this still feel like the original character?\n\n## Verdict\n**ACCEPT** - Ready to use, no more iterations needed\n**NEEDS REFINEMENT** - Making progress, but specific issues remain\n**REGRESSION** - This iteration made things worse, consider reverting\n\n## Next Steps\nIf NEEDS REFINEMENT: List exactly what the next iteration should fix.\nIf REGRESSION: Explain what went wrong and what to preserve from previous version.\n\n---\n\n### Original Character:\n{{original_character}}\n\n### Current Rewrite (Iteration {{iteration_number}}):\n{{rewrite_results}}`,\n    },\n    {\n        id: 'builtin_analyze_quick',\n        name: 'Quick Analyze',\n        stages: ['analyze'],\n        isBuiltin: true,\n        createdAt: 0,\n        updatedAt: 0,\n        prompt: `Quick comparison of original vs rewrite:\n\n1. Soul preserved? (Yes/Partially/No)\n2. Best improvement made\n3. Biggest thing lost (if any)\n4. Verdict: ACCEPT / NEEDS REFINEMENT / REGRESSION\n\n{{original_character}}\n\n{{rewrite_results}}`,\n    },\n    {\n        id: 'builtin_freeform',\n        name: 'Freeform',\n        stages: [],  // Available for all stages\n        isBuiltin: true,\n        createdAt: 0,\n        updatedAt: 0,\n        prompt: '[Enter your custom instructions here]',\n    },\n]);\n\n// ============================================================================\n// BUILTIN SCHEMA PRESETS\n// ============================================================================\n\nconst SCORE_SCHEMA: StructuredOutputSchema = {\n    name: 'CharacterScore',\n    strict: true,\n    value: {\n        $schema: 'http://json-schema.org/draft-04/schema#',\n        type: 'object',\n        additionalProperties: false,\n        properties: {\n            fieldScores: {\n                type: 'array',\n                items: {\n                    type: 'object',\n                    additionalProperties: false,\n                    properties: {\n                        field: { type: 'string' },\n                        score: { type: 'number' },\n                        strengths: { type: 'string' },\n                        weaknesses: { type: 'string' },\n                        suggestions: { type: 'string' },\n                    },\n                    required: ['field', 'score', 'strengths', 'weaknesses', 'suggestions'],\n                },\n            },\n            overallScore: { type: 'number' },\n            priorityImprovements: {\n                type: 'array',\n                items: { type: 'string' },\n            },\n            summary: { type: 'string' },\n        },\n        required: ['fieldScores', 'overallScore', 'priorityImprovements', 'summary'],\n    },\n};\n\nconst QUICK_SCORE_SCHEMA: StructuredOutputSchema = {\n    name: 'QuickScore',\n    strict: true,\n    value: {\n        $schema: 'http://json-schema.org/draft-04/schema#',\n        type: 'object',\n        additionalProperties: false,\n        properties: {\n            overallScore: { type: 'number' },\n            strengths: {\n                type: 'array',\n                items: { type: 'string' },\n            },\n            weaknesses: {\n                type: 'array',\n                items: { type: 'string' },\n            },\n            summary: { type: 'string' },\n        },\n        required: ['overallScore', 'strengths', 'weaknesses', 'summary'],\n    },\n};\n\nconst ANALYZE_SCHEMA: StructuredOutputSchema = {\n    name: 'CharacterAnalysis',\n    strict: true,\n    value: {\n        $schema: 'http://json-schema.org/draft-04/schema#',\n        type: 'object',\n        additionalProperties: false,\n        properties: {\n            preserved: {\n                type: 'array',\n                items: { type: 'string' },\n            },\n            lost: {\n                type: 'array',\n                items: { type: 'string' },\n            },\n            gained: {\n                type: 'array',\n                items: { type: 'string' },\n            },\n            soulPreservationScore: { type: 'number' },\n            soulAssessment: { type: 'string' },\n            verdict: {\n                type: 'string',\n                enum: ['ACCEPT', 'NEEDS_REFINEMENT', 'REGRESSION'],\n            },\n            issuesToAddress: {\n                type: 'array',\n                items: { type: 'string' },\n            },\n            recommendations: {\n                type: 'array',\n                items: { type: 'string' },\n            },\n        },\n        required: ['preserved', 'lost', 'gained', 'soulPreservationScore', 'soulAssessment', 'verdict', 'issuesToAddress', 'recommendations'],\n    },\n};\n\nexport const BUILTIN_SCHEMA_PRESETS: readonly SchemaPreset[] = Object.freeze([\n    {\n        id: 'builtin_schema_score',\n        name: 'Default Score',\n        stages: ['score'],\n        isBuiltin: true,\n        createdAt: 0,\n        updatedAt: 0,\n        schema: SCORE_SCHEMA,\n    },\n    {\n        id: 'builtin_schema_quick_score',\n        name: 'Quick Score',\n        stages: ['score'],\n        isBuiltin: true,\n        createdAt: 0,\n        updatedAt: 0,\n        schema: QUICK_SCORE_SCHEMA,\n    },\n    {\n        id: 'builtin_schema_analyze',\n        name: 'Default Analyze',\n        stages: ['analyze'],\n        isBuiltin: true,\n        createdAt: 0,\n        updatedAt: 0,\n        schema: ANALYZE_SCHEMA,\n    },\n]);\n\n// ============================================================================\n// DEFAULT STAGE CONFIGS\n// ============================================================================\n\nexport const DEFAULT_STAGE_DEFAULTS: Record<StageName, StageDefaults> = {\n    score: {\n        promptPresetId: 'builtin_score_default',\n        customPrompt: '',\n        schemaPresetId: 'builtin_schema_score',\n        customSchema: '',\n        useStructuredOutput: false,  // Off by default, user can enable\n    },\n    rewrite: {\n        promptPresetId: 'builtin_rewrite_default',\n        customPrompt: '',\n        schemaPresetId: null,  // Rewrite typically doesn't use structured output\n        customSchema: '',\n        useStructuredOutput: false,\n    },\n    analyze: {\n        promptPresetId: 'builtin_analyze_default',\n        customPrompt: '',\n        schemaPresetId: 'builtin_schema_analyze',\n        customSchema: '',\n        useStructuredOutput: false,\n    },\n};\n\n// ============================================================================\n// DEFAULT GENERATION CONFIG\n// ============================================================================\n\nexport const DEFAULT_GENERATION_CONFIG: GenerationConfig = {\n    source: 'openrouter',\n    model: 'anthropic/claude-sonnet-4',\n    temperature: 1,\n    maxTokens: 4096,\n    frequencyPenalty: 0,\n    presencePenalty: 0,\n    topP: 1,\n};\n\n// ============================================================================\n// COMPLETE DEFAULT SETTINGS\n// ============================================================================\n\nexport const DEFAULT_SETTINGS: Settings = Object.freeze({\n    useCurrentSettings: true,\n    generationConfig: DEFAULT_GENERATION_CONFIG,\n    systemPrompt: DEFAULT_SYSTEM_PROMPT,\n    promptPresets: [...BUILTIN_PROMPT_PRESETS],\n    schemaPresets: [...BUILTIN_SCHEMA_PRESETS],\n    stageDefaults: DEFAULT_STAGE_DEFAULTS,\n    refinementPrompt: DEFAULT_REFINEMENT_PROMPT,\n    debugMode: false,\n    settingsVersion: SETTINGS_VERSION,\n});\n\n// ============================================================================\n// TEMPLATE PLACEHOLDERS\n// ============================================================================\n\n/**\n * Template placeholders that can be used in prompts.\n * These are replaced at runtime with actual values.\n *\n * @property ORIGINAL_CHARACTER - The full character card being analyzed/rewritten.\n *           Includes all populated fields formatted as markdown sections.\n *\n * @property SCORE_RESULTS - Output from the Score stage. Available in Rewrite and Analyze stages.\n *           Empty string if Score stage wasn't run.\n *\n * @property REWRITE_RESULTS - Output from the Rewrite stage. Available in Analyze stage.\n *           Empty string if Rewrite stage wasn't run.\n *\n * @property CURRENT_REWRITE - Alias for REWRITE_RESULTS, used in refinement context.\n *\n * @property CURRENT_ANALYSIS - Output from the Analyze stage. Used in refinement prompts.\n *           Empty string if Analyze stage wasn't run.\n *\n * @property ITERATION_NUMBER - Current refinement iteration number (1-based).\n *           \"1\" for first iteration, increments with each refinement cycle.\n *\n * @property CHARACTER_NAME - The character's name (e.g., \"Luna\").\n *\n * @property USER_NAME - The user's configured name in SillyTavern.\n */\nexport const TEMPLATE_PLACEHOLDERS = {\n    ORIGINAL_CHARACTER: '{{original_character}}',\n    SCORE_RESULTS: '{{score_results}}',\n    REWRITE_RESULTS: '{{rewrite_results}}',\n    CURRENT_REWRITE: '{{current_rewrite}}',\n    CURRENT_ANALYSIS: '{{current_analysis}}',\n    ITERATION_NUMBER: '{{iteration_number}}',\n    CHARACTER_NAME: '{{char_name}}',\n    USER_NAME: '{{user_name}}',\n} as const;\n\n// ============================================================================\n// UI CONSTANTS\n// ============================================================================\n\nexport const TOKEN_WARNING_THRESHOLD = 0.5;   // 50% of context\nexport const TOKEN_DANGER_THRESHOLD = 0.8;    // 80% of context\n\nexport const DEBOUNCE_DELAY = {\n    SEARCH: 150,\n    TOKEN_ESTIMATE: 300,\n    SAVE: 500,\n    VALIDATE: 500,\n} as const;\n\nexport const MAX_DROPDOWN_RESULTS = 10;\nexport const MAX_DEBUG_LOG_ENTRIES = 100;\nexport const MAX_ITERATION_HISTORY = 20;  // Don't keep more than this many snapshots\n\n// ============================================================================\n// CSS CLASS PREFIX\n// ============================================================================\n\n// All CSS classes should use this prefix\nexport const CSS_PREFIX = 'character_tools';\n\n// Helper to generate prefixed class names\nexport function css(...names: string[]): string {\n    return names.map(n => `${CSS_PREFIX}_${n}`).join(' ');\n}\n\n// Helper for BEM-style classes\nexport function bem(block: string, element?: string, modifier?: string): string {\n    let className = `${CSS_PREFIX}_${block}`;\n    if (element) className += `__${element}`;\n    if (modifier) className += `--${modifier}`;\n    return className;\n}\n","// src/debug.ts\n//\n// Debug logging and diagnostics for the extension.\n\nimport { MODULE_NAME, MAX_DEBUG_LOG_ENTRIES } from './constants';\nimport { getSettings } from './settings';\nimport type { DebugLogEntry, DebugLogType } from './types';\n\n// ============================================================================\n// LOG STORAGE\n// ============================================================================\n\nconst logEntries: DebugLogEntry[] = [];\n\n// ============================================================================\n// LOGGING\n// ============================================================================\n\n/**\n * Check if debug mode is enabled\n */\nexport function isDebugMode(): boolean {\n    try {\n        return getSettings().debugMode;\n    } catch {\n        // Settings might not be initialized yet\n        return false;\n    }\n}\n\n/**\n * Log a debug entry\n */\nexport function debugLog(type: DebugLogType, label: string, data: unknown): void {\n    const entry: DebugLogEntry = {\n        timestamp: new Date(),\n        type,\n        label,\n        data,\n    };\n\n    // Always store (for later viewing even if debug mode was off)\n    logEntries.unshift(entry);\n    if (logEntries.length > MAX_DEBUG_LOG_ENTRIES) {\n        logEntries.pop();\n    }\n\n    // Errors always log to console regardless of debug mode\n    if (type === 'error') {\n        console.error(`[${MODULE_NAME}:ERROR]`, label, data);\n        return;\n    }\n\n    // Other types only log if debug mode is on\n    if (isDebugMode()) {\n        const prefix = `[${MODULE_NAME}:${type.toUpperCase()}]`;\n        switch (type) {\n            case 'request':\n            case 'response':\n                console.debug(prefix, label, data);\n                break;\n            case 'state':\n            case 'info':\n            default:\n                console.log(prefix, label, data);\n        }\n    }\n}\n\n/**\n * Log an error - always outputs to console and stores in debug log.\n * Use this for errors that should never be silently swallowed.\n */\nexport function logError(label: string, data: unknown): void {\n    debugLog('error', label, data);\n}\n\n// ============================================================================\n// LOG ACCESS\n// ============================================================================\n\n/**\n * Get all debug logs\n */\nexport function getDebugLogs(): DebugLogEntry[] {\n    return [...logEntries];\n}\n\n/**\n * Get logs filtered by type\n */\nexport function getDebugLogsByType(type: DebugLogType): DebugLogEntry[] {\n    return logEntries.filter(e => e.type === type);\n}\n\n/**\n * Clear all debug logs\n */\nexport function clearDebugLogs(): void {\n    logEntries.length = 0;\n}\n\n// ============================================================================\n// FORMATTING\n// ============================================================================\n\n/**\n * Format a log entry for display\n */\nexport function formatLogEntry(entry: DebugLogEntry): string {\n    const time = entry.timestamp.toLocaleTimeString();\n    const icon = {\n        request: '',\n        response: '',\n        error: '',\n        info: '',\n        state: '',\n    }[entry.type];\n\n    return `${icon} [${time}] ${entry.label}`;\n}\n\n/**\n * Format log data for display\n */\nexport function formatLogData(data: unknown): string {\n    try {\n        if (data === null) return 'null';\n        if (data === undefined) return 'undefined';\n        if (typeof data === 'string') return data;\n        return JSON.stringify(data, null, 2);\n    } catch {\n        return String(data);\n    }\n}\n\n// ============================================================================\n// DIAGNOSTICS\n// ============================================================================\n\n/**\n * Collect debug info for current state\n */\nexport function collectDebugInfo(): Record<string, unknown> {\n    const context = SillyTavern.getContext();\n\n    let settings;\n    try {\n        settings = getSettings();\n    } catch {\n        settings = { error: 'Failed to load settings' };\n    }\n\n    return {\n        extension: {\n            settings: {\n                useCurrentSettings: settings.useCurrentSettings,\n                debugMode: settings.debugMode,\n                generationConfig: settings.generationConfig,\n                systemPromptLength: settings.systemPrompt?.length || 0,\n                promptPresetCount: settings.promptPresets?.length || 0,\n                schemaPresetCount: settings.schemaPresets?.length || 0,\n            },\n        },\n        sillytavern: {\n            mainApi: context.mainApi,\n            onlineStatus: context.onlineStatus,\n            chatCompletionSource: context.chatCompletionSettings?.chat_completion_source,\n            currentModel: context.chatCompletionSettings?.openrouter_model ||\n                    context.chatCompletionSettings?.model_openai_select,\n            maxContext: context.maxContext,\n            characterCount: context.characters?.length ?? 0,\n            hasActiveChat: !!context.chat?.length,\n        },\n        logs: {\n            total: logEntries.length,\n            errors: logEntries.filter(e => e.type === 'error').length,\n            recent: logEntries.slice(0, 10).map(e => ({\n                type: e.type,\n                label: e.label,\n                time: e.timestamp.toISOString(),\n            })),\n        },\n    };\n}\n\n/**\n * Export debug info as JSON string\n */\nexport function exportDebugInfo(): string {\n    return JSON.stringify(collectDebugInfo(), null, 2);\n}\n","// src/settings.ts\nimport {\n    MODULE_NAME,\n    DEFAULT_SETTINGS,\n    DEFAULT_SYSTEM_PROMPT,\n    DEFAULT_GENERATION_CONFIG,\n    DEFAULT_STAGE_DEFAULTS,\n    DEFAULT_REFINEMENT_PROMPT,\n    BUILTIN_PROMPT_PRESETS,\n    BUILTIN_SCHEMA_PRESETS,\n    SETTINGS_VERSION,\n} from './constants';\nimport type {\n    Settings,\n    GenerationConfig,\n    StageName,\n    StageDefaults,\n    PromptPreset,\n    SchemaPreset,\n    StructuredOutputSchema,\n    JsonSchemaValue,\n} from './types';\nimport { debugLog } from './debug';\n\n// ============================================================================\n// MIGRATION REGISTRY\n// ============================================================================\n\ntype MigrationFn = (settings: Partial<Settings>) => void;\n\nconst migrations: Record<number, MigrationFn> = {\n    // v1 -> v2: Add preset system, stage defaults\n    2: (settings) => {\n        // Handle old useRawMode -> useCurrentSettings\n        const oldSettings = settings as Record<string, unknown>;\n        if (oldSettings.useRawMode !== undefined) {\n            settings.useCurrentSettings = !oldSettings.useRawMode;\n            delete oldSettings.useRawMode;\n        }\n\n        // Handle old jsonSchema -> discard (can't migrate custom schemas reliably)\n        if (oldSettings.jsonSchema !== undefined) {\n            delete oldSettings.jsonSchema;\n        }\n\n        // Handle old useStructuredOutput -> apply to score stage\n        if (oldSettings.useStructuredOutput !== undefined) {\n            if (!settings.stageDefaults) {\n                settings.stageDefaults = structuredClone(DEFAULT_STAGE_DEFAULTS);\n            }\n            settings.stageDefaults!.score.useStructuredOutput = !!oldSettings.useStructuredOutput;\n            delete oldSettings.useStructuredOutput;\n        }\n    },\n\n    // v2 -> v3: Add refinement prompt\n    3: (settings) => {\n        if (!settings.refinementPrompt) {\n            settings.refinementPrompt = DEFAULT_REFINEMENT_PROMPT;\n        }\n    },\n};\n\n/**\n * Run all migrations from oldVersion to current version\n */\nfunction runMigrations(settings: Partial<Settings>, oldVersion: number): boolean {\n    let migrated = false;\n\n    for (let v = oldVersion + 1; v <= SETTINGS_VERSION; v++) {\n        const migration = migrations[v];\n        if (migration) {\n            debugLog('info', `Running migration to v${v}`, null);\n            migration(settings);\n            migrated = true;\n        }\n    }\n\n    return migrated;\n}\n\n// ============================================================================\n// SETTINGS ACCESS\n// ============================================================================\n\n/**\n * Get current settings, initializing with defaults if needed.\n * Handles migrations from older versions.\n */\nexport function getSettings(): Settings {\n    const { extensionSettings, saveSettingsDebounced } = SillyTavern.getContext();\n    const { lodash } = SillyTavern.libs;\n\n    if (!extensionSettings[MODULE_NAME]) {\n        debugLog('info', 'Initializing settings with defaults', null);\n        extensionSettings[MODULE_NAME] = structuredClone(DEFAULT_SETTINGS);\n        saveSettingsDebounced();\n        return extensionSettings[MODULE_NAME] as Settings;\n    }\n\n    const existing = extensionSettings[MODULE_NAME] as Partial<Settings>;\n    const oldVersion = existing.settingsVersion || 1;\n    let needsSave = false;\n\n    // Run migrations if version is old\n    if (oldVersion < SETTINGS_VERSION) {\n        needsSave = runMigrations(existing, oldVersion);\n        existing.settingsVersion = SETTINGS_VERSION;\n    }\n\n    // Merge with defaults to ensure all fields exist\n    // lodash.merge does deep merge, existing values override defaults\n    const merged = lodash.merge(\n        structuredClone(DEFAULT_SETTINGS),\n        existing,\n    ) as Settings;\n\n    // Ensure builtin presets exist (they might be missing if user has old settings)\n    const builtinsAdded = ensureBuiltinPresets(merged);\n    needsSave = needsSave || builtinsAdded;\n\n    // Write back merged settings\n    extensionSettings[MODULE_NAME] = merged;\n\n    if (needsSave) {\n        saveSettingsDebounced();\n    }\n\n    return merged;\n}\n\n/**\n * Ensure all builtin presets exist in settings\n */\nfunction ensureBuiltinPresets(settings: Settings): boolean {\n    let modified = false;\n\n    // Ensure prompt presets\n    const existingPromptIds = new Set(settings.promptPresets.map(p => p.id));\n    for (const builtin of BUILTIN_PROMPT_PRESETS) {\n        if (!existingPromptIds.has(builtin.id)) {\n            settings.promptPresets.push(structuredClone(builtin));\n            modified = true;\n        }\n    }\n\n    // Ensure schema presets\n    const existingSchemaIds = new Set(settings.schemaPresets.map(p => p.id));\n    for (const builtin of BUILTIN_SCHEMA_PRESETS) {\n        if (!existingSchemaIds.has(builtin.id)) {\n            settings.schemaPresets.push(structuredClone(builtin));\n            modified = true;\n        }\n    }\n\n    return modified;\n}\n\n// ============================================================================\n// SETTINGS UPDATES\n// ============================================================================\n\n/**\n * Update a single setting value\n */\nexport function updateSetting<K extends keyof Settings>(key: K, value: Settings[K]): void {\n    const { extensionSettings, saveSettingsDebounced } = SillyTavern.getContext();\n    const settings = extensionSettings[MODULE_NAME] as Settings;\n    settings[key] = value;\n    saveSettingsDebounced();\n    debugLog('info', 'Setting updated', { key, value: typeof value === 'object' ? '[object]' : value });\n}\n\n/**\n * Update generation config (partial update)\n */\nexport function updateGenerationConfig(updates: Partial<GenerationConfig>): void {\n    const { extensionSettings, saveSettingsDebounced } = SillyTavern.getContext();\n    const settings = extensionSettings[MODULE_NAME] as Settings;\n\n    if (!settings.generationConfig) {\n        settings.generationConfig = structuredClone(DEFAULT_GENERATION_CONFIG);\n    }\n\n    settings.generationConfig = { ...settings.generationConfig, ...updates };\n    saveSettingsDebounced();\n    debugLog('info', 'Generation config updated', updates);\n}\n\n/**\n * Update system prompt\n */\nexport function updateSystemPrompt(prompt: string): void {\n    updateSetting('systemPrompt', prompt);\n}\n\n/**\n * Reset system prompt to default\n */\nexport function resetSystemPrompt(): void {\n    updateSetting('systemPrompt', DEFAULT_SYSTEM_PROMPT);\n}\n\n/**\n * Update refinement prompt\n */\nexport function updateRefinementPrompt(prompt: string): void {\n    updateSetting('refinementPrompt', prompt);\n}\n\n/**\n * Reset refinement prompt to default\n */\nexport function resetRefinementPrompt(): void {\n    updateSetting('refinementPrompt', DEFAULT_REFINEMENT_PROMPT);\n}\n\n/**\n * Update stage defaults\n */\nexport function updateStageDefaults(stage: StageName, updates: Partial<StageDefaults>): void {\n    const { extensionSettings, saveSettingsDebounced } = SillyTavern.getContext();\n    const settings = extensionSettings[MODULE_NAME] as Settings;\n\n    if (!settings.stageDefaults) {\n        settings.stageDefaults = structuredClone(DEFAULT_STAGE_DEFAULTS);\n    }\n\n    if (!settings.stageDefaults[stage]) {\n        settings.stageDefaults[stage] = structuredClone(DEFAULT_STAGE_DEFAULTS[stage]);\n    }\n\n    settings.stageDefaults[stage] = { ...settings.stageDefaults[stage], ...updates };\n    saveSettingsDebounced();\n    debugLog('info', 'Stage defaults updated', { stage, updates });\n}\n\n/**\n * Reset stage defaults to builtin values\n */\nexport function resetStageDefaults(stage: StageName): void {\n    const { extensionSettings, saveSettingsDebounced } = SillyTavern.getContext();\n    const settings = extensionSettings[MODULE_NAME] as Settings;\n\n    if (!settings.stageDefaults) {\n        settings.stageDefaults = structuredClone(DEFAULT_STAGE_DEFAULTS);\n    }\n\n    settings.stageDefaults[stage] = structuredClone(DEFAULT_STAGE_DEFAULTS[stage]);\n    saveSettingsDebounced();\n    debugLog('info', 'Stage defaults reset', { stage });\n}\n\n/**\n * Set debug mode\n */\nexport function setDebugMode(enabled: boolean): void {\n    updateSetting('debugMode', enabled);\n}\n\n// ============================================================================\n// PRESET MANAGEMENT\n// ============================================================================\n\n/**\n * Get all prompt presets, optionally filtered by stage\n */\nexport function getPromptPresets(stage?: StageName): PromptPreset[] {\n    const settings = getSettings();\n\n    if (!stage) {\n        return settings.promptPresets;\n    }\n\n    return settings.promptPresets.filter(p =>\n        p.stages.length === 0 || p.stages.includes(stage),\n    );\n}\n\n/**\n * Get a specific prompt preset by ID\n */\nexport function getPromptPreset(id: string): PromptPreset | null {\n    const settings = getSettings();\n    return settings.promptPresets.find(p => p.id === id) || null;\n}\n\n/**\n * Save a new prompt preset\n */\nexport function savePromptPreset(preset: Omit<PromptPreset, 'id' | 'isBuiltin' | 'createdAt' | 'updatedAt'>): PromptPreset {\n    const { extensionSettings, saveSettingsDebounced } = SillyTavern.getContext();\n    const settings = extensionSettings[MODULE_NAME] as Settings;\n    const { uuidv4 } = SillyTavern.getContext();\n\n    const now = Date.now();\n    const newPreset: PromptPreset = {\n        ...preset,\n        id: `custom_prompt_${uuidv4()}`,\n        isBuiltin: false,\n        createdAt: now,\n        updatedAt: now,\n    };\n\n    settings.promptPresets.push(newPreset);\n    saveSettingsDebounced();\n    debugLog('info', 'Prompt preset saved', { id: newPreset.id, name: newPreset.name });\n\n    return newPreset;\n}\n\n/**\n * Update an existing prompt preset (only custom presets)\n */\nexport function updatePromptPreset(id: string, updates: Partial<Omit<PromptPreset, 'id' | 'isBuiltin' | 'createdAt'>>): boolean {\n    const { extensionSettings, saveSettingsDebounced } = SillyTavern.getContext();\n    const settings = extensionSettings[MODULE_NAME] as Settings;\n\n    const index = settings.promptPresets.findIndex(p => p.id === id);\n    if (index === -1) return false;\n\n    const preset = settings.promptPresets[index];\n    if (preset.isBuiltin) {\n        debugLog('error', 'Cannot update builtin preset', { id });\n        return false;\n    }\n\n    settings.promptPresets[index] = {\n        ...preset,\n        ...updates,\n        updatedAt: Date.now(),\n    };\n\n    saveSettingsDebounced();\n    debugLog('info', 'Prompt preset updated', { id });\n    return true;\n}\n\n/**\n * Delete a prompt preset (only custom presets)\n * Returns the deleted preset ID if successful, null otherwise\n */\nexport function deletePromptPreset(id: string): string | null {\n    const { extensionSettings, saveSettingsDebounced } = SillyTavern.getContext();\n    const settings = extensionSettings[MODULE_NAME] as Settings;\n\n    const index = settings.promptPresets.findIndex(p => p.id === id);\n    if (index === -1) return null;\n\n    const preset = settings.promptPresets[index];\n    if (preset.isBuiltin) {\n        debugLog('error', 'Cannot delete builtin preset', { id });\n        return null;\n    }\n\n    settings.promptPresets.splice(index, 1);\n\n    // Clear any stage defaults that reference this preset\n    for (const stage of ['score', 'rewrite', 'analyze'] as const) {\n        if (settings.stageDefaults[stage]?.promptPresetId === id) {\n            settings.stageDefaults[stage].promptPresetId = null;\n        }\n    }\n\n    saveSettingsDebounced();\n    debugLog('info', 'Prompt preset deleted', { id });\n    return id;\n}\n\n/**\n * Get all schema presets, optionally filtered by stage\n */\nexport function getSchemaPresets(stage?: StageName): SchemaPreset[] {\n    const settings = getSettings();\n\n    if (!stage) {\n        return settings.schemaPresets;\n    }\n\n    return settings.schemaPresets.filter(p =>\n        p.stages.length === 0 || p.stages.includes(stage),\n    );\n}\n\n/**\n * Get a specific schema preset by ID\n */\nexport function getSchemaPreset(id: string): SchemaPreset | null {\n    const settings = getSettings();\n    return settings.schemaPresets.find(p => p.id === id) || null;\n}\n\n/**\n * Save a new schema preset\n */\nexport function saveSchemaPreset(preset: Omit<SchemaPreset, 'id' | 'isBuiltin' | 'createdAt' | 'updatedAt'>): SchemaPreset {\n    const { extensionSettings, saveSettingsDebounced } = SillyTavern.getContext();\n    const settings = extensionSettings[MODULE_NAME] as Settings;\n    const { uuidv4 } = SillyTavern.getContext();\n\n    // Auto-fix schema before saving\n    const fixedSchema = ensureSchemaHasAdditionalProperties(preset.schema);\n\n    const now = Date.now();\n    const newPreset: SchemaPreset = {\n        ...preset,\n        schema: fixedSchema,\n        id: `custom_schema_${uuidv4()}`,\n        isBuiltin: false,\n        createdAt: now,\n        updatedAt: now,\n    };\n\n    settings.schemaPresets.push(newPreset);\n    saveSettingsDebounced();\n    debugLog('info', 'Schema preset saved', { id: newPreset.id, name: newPreset.name });\n\n    return newPreset;\n}\n\n/**\n * Update an existing schema preset (only custom presets)\n */\nexport function updateSchemaPreset(id: string, updates: Partial<Omit<SchemaPreset, 'id' | 'isBuiltin' | 'createdAt'>>): boolean {\n    const { extensionSettings, saveSettingsDebounced } = SillyTavern.getContext();\n    const settings = extensionSettings[MODULE_NAME] as Settings;\n\n    const index = settings.schemaPresets.findIndex(p => p.id === id);\n    if (index === -1) return false;\n\n    const preset = settings.schemaPresets[index];\n    if (preset.isBuiltin) {\n        debugLog('error', 'Cannot update builtin preset', { id });\n        return false;\n    }\n\n    // Auto-fix schema if provided\n    if (updates.schema) {\n        updates.schema = ensureSchemaHasAdditionalProperties(updates.schema);\n    }\n\n    settings.schemaPresets[index] = {\n        ...preset,\n        ...updates,\n        updatedAt: Date.now(),\n    };\n\n    saveSettingsDebounced();\n    debugLog('info', 'Schema preset updated', { id });\n    return true;\n}\n\n/**\n * Delete a schema preset (only custom presets)\n * Returns the deleted preset ID if successful, null otherwise\n */\nexport function deleteSchemaPreset(id: string): string | null {\n    const { extensionSettings, saveSettingsDebounced } = SillyTavern.getContext();\n    const settings = extensionSettings[MODULE_NAME] as Settings;\n\n    const index = settings.schemaPresets.findIndex(p => p.id === id);\n    if (index === -1) return null;\n\n    const preset = settings.schemaPresets[index];\n    if (preset.isBuiltin) {\n        debugLog('error', 'Cannot delete builtin preset', { id });\n        return null;\n    }\n\n    settings.schemaPresets.splice(index, 1);\n\n    // Clear any stage defaults that reference this preset\n    for (const stage of ['score', 'rewrite', 'analyze'] as const) {\n        if (settings.stageDefaults[stage]?.schemaPresetId === id) {\n            settings.stageDefaults[stage].schemaPresetId = null;\n        }\n    }\n\n    saveSettingsDebounced();\n    debugLog('info', 'Schema preset deleted', { id });\n    return id;\n}\n\n// ============================================================================\n// SCHEMA HELPERS\n// ============================================================================\n\n/**\n * Recursively add additionalProperties: false to all object types in a schema\n */\nfunction ensureSchemaHasAdditionalProperties(schema: StructuredOutputSchema): StructuredOutputSchema {\n    const fixed = structuredClone(schema);\n    addAdditionalPropertiesToNode(fixed.value);\n    return fixed;\n}\n\nfunction addAdditionalPropertiesToNode(node: JsonSchemaValue): void {\n    if (node.type === 'object') {\n        node.additionalProperties = false;\n\n        if (node.properties && typeof node.properties === 'object') {\n            for (const prop of Object.values(node.properties)) {\n                if (prop && typeof prop === 'object') {\n                    addAdditionalPropertiesToNode(prop as JsonSchemaValue);\n                }\n            }\n        }\n    }\n\n    if (node.type === 'array' && node.items && typeof node.items === 'object') {\n        if (!Array.isArray(node.items)) {\n            addAdditionalPropertiesToNode(node.items as JsonSchemaValue);\n        } else {\n            node.items.forEach(item => {\n                if (item && typeof item === 'object') {\n                    addAdditionalPropertiesToNode(item as JsonSchemaValue);\n                }\n            });\n        }\n    }\n\n    if (node.anyOf && Array.isArray(node.anyOf)) {\n        node.anyOf.forEach(variant => {\n            if (variant && typeof variant === 'object') {\n                addAdditionalPropertiesToNode(variant as JsonSchemaValue);\n            }\n        });\n    }\n\n    if (node.allOf && Array.isArray(node.allOf)) {\n        node.allOf.forEach(variant => {\n            if (variant && typeof variant === 'object') {\n                addAdditionalPropertiesToNode(variant as JsonSchemaValue);\n            }\n        });\n    }\n\n    // Handle $defs\n    if (node.$defs && typeof node.$defs === 'object') {\n        for (const def of Object.values(node.$defs)) {\n            if (def && typeof def === 'object') {\n                addAdditionalPropertiesToNode(def);\n            }\n        }\n    }\n\n    if (node.definitions && typeof node.definitions === 'object') {\n        for (const def of Object.values(node.definitions)) {\n            if (def && typeof def === 'object') {\n                addAdditionalPropertiesToNode(def as JsonSchemaValue);\n            }\n        }\n    }\n}\n\n// ============================================================================\n// EXPORT HELPERS\n// ============================================================================\n\n/**\n * Export all custom presets as JSON (for backup/sharing)\n */\nexport function exportCustomPresets(): string {\n    const settings = getSettings();\n\n    const customPrompts = settings.promptPresets.filter(p => !p.isBuiltin);\n    const customSchemas = settings.schemaPresets.filter(p => !p.isBuiltin);\n\n    return JSON.stringify({\n        version: SETTINGS_VERSION,\n        exportedAt: new Date().toISOString(),\n        promptPresets: customPrompts,\n        schemaPresets: customSchemas,\n    }, null, 2);\n}\n\n/**\n * Import presets from JSON\n */\nexport function importPresets(json: string): { prompts: number; schemas: number; errors: string[] } {\n    const errors: string[] = [];\n    let promptsImported = 0;\n    let schemasImported = 0;\n\n    try {\n        const data = JSON.parse(json);\n\n        if (data.promptPresets && Array.isArray(data.promptPresets)) {\n            for (const preset of data.promptPresets) {\n                try {\n                    if (preset.name && preset.prompt) {\n                        savePromptPreset({\n                            name: preset.name,\n                            prompt: preset.prompt,\n                            stages: preset.stages || [],\n                        });\n                        promptsImported++;\n                    }\n                } catch (e) {\n                    errors.push(`Failed to import prompt \"${preset.name}\": ${e}`);\n                }\n            }\n        }\n\n        if (data.schemaPresets && Array.isArray(data.schemaPresets)) {\n            for (const preset of data.schemaPresets) {\n                try {\n                    if (preset.name && preset.schema) {\n                        saveSchemaPreset({\n                            name: preset.name,\n                            schema: preset.schema,\n                            stages: preset.stages || [],\n                        });\n                        schemasImported++;\n                    }\n                } catch (e) {\n                    errors.push(`Failed to import schema \"${preset.name}\": ${e}`);\n                }\n            }\n        }\n    } catch (e) {\n        errors.push(`Failed to parse JSON: ${e}`);\n    }\n\n    debugLog('info', 'Presets imported', { promptsImported, schemasImported, errors });\n    return { prompts: promptsImported, schemas: schemasImported, errors };\n}\n","// src/schema.ts\nimport type { StructuredOutputSchema, SchemaValidationResult, JsonSchemaValue } from './types';\n\n// ============================================================================\n// PROVIDER LIMITS\n// ============================================================================\n\n// Anthropic limits (strictest - design for these)\nconst ANTHROPIC_LIMITS = {\n    MAX_ANYOF_VARIANTS: 8,\n    MAX_DEFS: 100,\n    MAX_NESTING_DEPTH: 10,\n    MAX_PROPERTIES_PER_OBJECT: 100,\n    MAX_ENUM_VALUES: 500,\n    SUPPORTED_STRING_FORMATS: [\n        'date-time', 'time', 'date', 'duration',\n        'email', 'hostname', 'uri', 'ipv4', 'ipv6', 'uuid',\n    ] as const,\n    SUPPORTED_MINMAX_ITEMS: [0, 1] as const,\n} as const;\n\n// Features that will be silently ignored (not errors, but won't work)\nconst IGNORED_CONSTRAINTS = {\n    numeric: ['minimum', 'maximum', 'exclusiveMinimum', 'exclusiveMaximum', 'multipleOf'],\n    string: ['minLength', 'maxLength'],\n    array: ['maxItems', 'uniqueItems', 'contains', 'minContains', 'maxContains'],\n    object: ['minProperties', 'maxProperties', 'propertyNames', 'patternProperties'],\n} as const;\n\n// Completely unsupported features (will cause errors)\nconst UNSUPPORTED_FEATURES = [\n    'if', 'then', 'else',           // Conditional schemas\n    'not',                           // Negation\n    'oneOf',                         // Use anyOf instead\n    'dependentRequired',             // Dependent requirements\n    'dependentSchemas',              // Dependent schemas\n    'unevaluatedProperties',         // OpenAPI 3.1 feature\n    'unevaluatedItems',              // OpenAPI 3.1 feature\n    '$dynamicRef',                   // Dynamic references\n    '$dynamicAnchor',                // Dynamic anchors\n] as const;\n\n// Regex features NOT supported\nconst UNSUPPORTED_REGEX_FEATURES = [\n    { pattern: /\\(\\?[=!<]/, name: 'lookahead/lookbehind assertions' },\n    { pattern: /\\\\[1-9]/, name: 'backreferences' },\n    { pattern: /\\\\[bB]/, name: 'word boundaries' },\n] as const;\n\n// ============================================================================\n// VALIDATION TYPES\n// ============================================================================\n\ninterface ValidationContext {\n    errors: string[];\n    warnings: string[];\n    info: string[];\n    stats: {\n        defCount: number;\n        anyOfCount: number;\n        totalAnyOfVariants: number;\n        maxDepth: number;\n        propertyCount: number;\n        optionalFieldCount: number;\n        enumCount: number;\n    };\n    currentDepth: number;\n    seenRefs: Set<string>;\n    defs: Record<string, JsonSchemaValue>;\n}\n\nconst SCHEMA_GENERATION_PROMPT = `Generate a JSON Schema for structured LLM output based on the user's description.\n\nRequirements:\n- Output ONLY valid JSON, no markdown, no explanation\n- Use this exact wrapper format: {\"name\": \"SchemaName\", \"strict\": true, \"value\": {...}}\n- The \"value\" must be a valid JSON Schema with \"type\": \"object\"\n- Add \"additionalProperties\": false to ALL object types (required for Anthropic)\n- All object properties should be in a \"required\" array unless explicitly optional\n- Use simple types: string, number, integer, boolean, array, object\n- For arrays, always specify \"items\" with a schema\n- Keep it minimal - only what the user asked for\n\nUser's description:`;\n\nexport async function generateSchemaFromDescription(description: string): Promise<{\n    success: boolean;\n    schema?: string;\n    error?: string;\n}> {\n    const { generateRaw } = SillyTavern.getContext();\n\n    if (!description.trim()) {\n        return { success: false, error: 'Please describe what you want in the schema' };\n    }\n\n    try {\n        const response = await generateRaw({\n            prompt: `${SCHEMA_GENERATION_PROMPT}\\n\\n${description}`,\n            systemPrompt: 'You are a JSON Schema expert. Output only valid JSON, nothing else.',\n        });\n\n        // Clean up response - strip markdown code blocks if present\n        let cleaned = response.trim();\n        if (cleaned.startsWith('```')) {\n            cleaned = cleaned.replace(/^```(?:json)?\\s*/, '').replace(/\\s*```$/, '');\n        }\n\n        // Validate what we got\n        const validation = validateSchema(cleaned);\n\n        if (!validation.valid) {\n            return {\n                success: false,\n                error: `Generated schema is invalid: ${validation.error}`,\n                schema: cleaned, // Return it anyway so user can fix\n            };\n        }\n\n        // Auto-fix if needed\n        if (validation.warnings?.length) {\n            const fixed = autoFixSchema(validation.schema!);\n            return {\n                success: true,\n                schema: JSON.stringify(fixed, null, 2),\n            };\n        }\n\n        return {\n            success: true,\n            schema: JSON.stringify(validation.schema, null, 2),\n        };\n    } catch (e) {\n        return {\n            success: false,\n            error: `Generation failed: ${(e as Error).message}`,\n        };\n    }\n}\n\n// ============================================================================\n// MAIN VALIDATION FUNCTION\n// ============================================================================\n\n/**\n * Validates a JSON schema for Anthropic/OpenRouter structured output compatibility.\n *\n * Checks:\n * - JSON syntax validity\n * - Required ST wrapper structure (name, value)\n * - Anthropic-specific limits (anyOf variants, nesting depth, etc.)\n * - Required additionalProperties: false on all objects\n * - Unsupported JSON Schema features\n * - Regex pattern compatibility\n * - Optional field count (spawns anyOf with null)\n */\nexport function validateSchema(input: string): SchemaValidationResult {\n    // Empty input = disable structured output\n    if (!input.trim()) {\n        return { valid: true, schema: undefined };\n    }\n\n    // Parse JSON\n    let parsed: unknown;\n    try {\n        parsed = JSON.parse(input);\n    } catch (e) {\n        const error = e instanceof Error ? e.message : 'Invalid JSON';\n        // Try to give helpful position info\n        const match = error.match(/position (\\d+)/);\n        const position = match ? ` (character ${match[1]})` : '';\n        return { valid: false, error: `JSON syntax error${position}: ${error}` };\n    }\n\n    // Must be an object\n    if (typeof parsed !== 'object' || parsed === null || Array.isArray(parsed)) {\n        return { valid: false, error: 'Schema must be a JSON object, not ' + (Array.isArray(parsed) ? 'array' : typeof parsed) };\n    }\n\n    const obj = parsed as Record<string, unknown>;\n\n    // ========== ST WRAPPER VALIDATION ==========\n\n    // Required: name (string, non-empty, valid identifier)\n    if (typeof obj.name !== 'string') {\n        return { valid: false, error: 'Missing required \\'name\\' property (string)' };\n    }\n    if (!obj.name.trim()) {\n        return { valid: false, error: '\\'name\\' cannot be empty' };\n    }\n    if (!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(obj.name)) {\n        return { valid: false, error: `'name' must be a valid identifier (got '${obj.name}'). Use letters, numbers, underscores; start with letter or underscore.` };\n    }\n\n    // Required: value (object with type)\n    if (typeof obj.value !== 'object' || obj.value === null || Array.isArray(obj.value)) {\n        return { valid: false, error: 'Missing or invalid \\'value\\' property (must be object)' };\n    }\n\n    const value = obj.value as JsonSchemaValue;\n\n    if (typeof value.type !== 'string' && !value.anyOf && !value.allOf && !value.$ref) {\n        return { valid: false, error: '\\'value\\' must have a \\'type\\', \\'anyOf\\', \\'allOf\\', or \\'$ref\\'' };\n    }\n\n    // Optional: strict (boolean)\n    if (obj.strict !== undefined && typeof obj.strict !== 'boolean') {\n        return { valid: false, error: '\\'strict\\' must be a boolean if provided' };\n    }\n\n    // ========== DEEP SCHEMA VALIDATION ==========\n\n    const ctx: ValidationContext = {\n        errors: [],\n        warnings: [],\n        info: [],\n        stats: {\n            defCount: 0,\n            anyOfCount: 0,\n            totalAnyOfVariants: 0,\n            maxDepth: 0,\n            propertyCount: 0,\n            optionalFieldCount: 0,\n            enumCount: 0,\n        },\n        currentDepth: 0,\n        seenRefs: new Set(),\n        defs: {},\n    };\n\n    // Extract $defs/definitions first\n    if (value.$defs && typeof value.$defs === 'object') {\n        ctx.defs = value.$defs as Record<string, JsonSchemaValue>;\n        ctx.stats.defCount = Object.keys(ctx.defs).length;\n    } else if (value.definitions && typeof value.definitions === 'object') {\n        ctx.defs = value.definitions as Record<string, JsonSchemaValue>;\n        ctx.stats.defCount = Object.keys(ctx.defs).length;\n    }\n\n    if (ctx.stats.defCount > ANTHROPIC_LIMITS.MAX_DEFS) {\n        ctx.errors.push(`Too many definitions: ${ctx.stats.defCount} (limit: ${ANTHROPIC_LIMITS.MAX_DEFS})`);\n    }\n\n    // Validate the schema tree\n    validateSchemaNode(value, 'value', ctx);\n\n    // Check optional field explosion\n    if (ctx.stats.optionalFieldCount > 0) {\n        const implicitAnyOfs = ctx.stats.optionalFieldCount;\n        const totalAnyOfs = ctx.stats.totalAnyOfVariants + implicitAnyOfs * 2; // Each optional spawns anyOf[type, null]\n\n        if (implicitAnyOfs > 10) {\n            ctx.warnings.push(\n                `${implicitAnyOfs} optional fields detected. Each spawns an implicit anyOf with null. ` +\n        'Consider making fields required or reducing optionals.',\n            );\n        }\n\n        if (totalAnyOfs > 50) {\n            ctx.warnings.push(\n                `High anyOf count (~${totalAnyOfs} including implicit nullables). ` +\n        'May cause slow schema compilation or errors.',\n            );\n        }\n    }\n\n    // ========== BUILD RESULT ==========\n\n    if (ctx.errors.length > 0) {\n        return {\n            valid: false,\n            error: ctx.errors.join('\\n'),\n            warnings: ctx.warnings.length > 0 ? ctx.warnings : undefined,\n        };\n    }\n\n    const schema: StructuredOutputSchema = {\n        name: obj.name,\n        strict: obj.strict as boolean | undefined ?? true, // Default to strict\n        value: value,\n    };\n\n    // Add stats as info\n    ctx.info.push(\n        `Schema stats: ${ctx.stats.propertyCount} properties, ` +\n    `${ctx.stats.defCount} definitions, ` +\n    `${ctx.stats.anyOfCount} anyOf blocks, ` +\n    `${ctx.stats.optionalFieldCount} optional fields, ` +\n    `max depth ${ctx.stats.maxDepth}`,\n    );\n\n    return {\n        valid: true,\n        schema,\n        warnings: ctx.warnings.length > 0 ? ctx.warnings : undefined,\n        info: ctx.info.length > 0 ? ctx.info : undefined,\n    };\n}\n\n// ============================================================================\n// RECURSIVE NODE VALIDATION\n// ============================================================================\n\nfunction validateSchemaNode(\n    node: JsonSchemaValue,\n    path: string,\n    ctx: ValidationContext,\n): void {\n    ctx.currentDepth++;\n    ctx.stats.maxDepth = Math.max(ctx.stats.maxDepth, ctx.currentDepth);\n\n    // Check nesting depth\n    if (ctx.currentDepth > ANTHROPIC_LIMITS.MAX_NESTING_DEPTH) {\n        ctx.errors.push(`${path}: Exceeds maximum nesting depth of ${ANTHROPIC_LIMITS.MAX_NESTING_DEPTH}`);\n        ctx.currentDepth--;\n        return;\n    }\n\n    // Check for completely unsupported features\n    for (const feature of UNSUPPORTED_FEATURES) {\n        if (node[feature] !== undefined) {\n            ctx.errors.push(`${path}: '${feature}' is not supported`);\n        }\n    }\n\n    // Check for ignored constraints (warn, don't error)\n    for (const key of IGNORED_CONSTRAINTS.numeric) {\n        if (node[key] !== undefined) {\n            ctx.warnings.push(`${path}: '${key}' will be ignored (not supported)`);\n        }\n    }\n    for (const key of IGNORED_CONSTRAINTS.string) {\n        if (node[key] !== undefined) {\n            ctx.warnings.push(`${path}: '${key}' will be ignored (not supported)`);\n        }\n    }\n    for (const key of IGNORED_CONSTRAINTS.array) {\n        if (node[key] !== undefined) {\n            ctx.warnings.push(`${path}: '${key}' will be ignored (not supported)`);\n        }\n    }\n    for (const key of IGNORED_CONSTRAINTS.object) {\n        if (node[key] !== undefined) {\n            ctx.warnings.push(`${path}: '${key}' will be ignored (not supported)`);\n        }\n    }\n\n    // Handle $ref\n    if (node.$ref && typeof node.$ref === 'string') {\n        validateRef(node.$ref, path, ctx);\n        ctx.currentDepth--;\n        return; // $ref replaces the node\n    }\n\n    // Handle type-specific validation\n    const types = Array.isArray(node.type) ? node.type : [node.type];\n\n    for (const type of types) {\n        switch (type) {\n            case 'object':\n                validateObjectNode(node, path, ctx);\n                break;\n            case 'array':\n                validateArrayNode(node, path, ctx);\n                break;\n            case 'string':\n                validateStringNode(node, path, ctx);\n                break;\n            case 'number':\n            case 'integer':\n                validateNumericNode(node, path, ctx);\n                break;\n            case 'boolean':\n            case 'null':\n                // No special validation needed\n                break;\n            default:\n                if (type && !node.anyOf && !node.allOf) {\n                    ctx.warnings.push(`${path}: Unknown type '${type}'`);\n                }\n        }\n    }\n\n    // Handle anyOf\n    if (node.anyOf && Array.isArray(node.anyOf)) {\n        validateAnyOf(node.anyOf, path, ctx);\n    }\n\n    // Handle allOf\n    if (node.allOf && Array.isArray(node.allOf)) {\n        validateAllOf(node.allOf, path, ctx);\n    }\n\n    // Handle enum\n    if (node.enum && Array.isArray(node.enum)) {\n        validateEnum(node.enum, path, ctx);\n    }\n\n    // Handle const\n    if (node.const !== undefined) {\n        validateConst(node.const, path, ctx);\n    }\n\n    ctx.currentDepth--;\n}\n\n// ============================================================================\n// TYPE-SPECIFIC VALIDATORS\n// ============================================================================\n\nfunction validateObjectNode(node: JsonSchemaValue, path: string, ctx: ValidationContext): void {\n    // CRITICAL: additionalProperties must be false\n    if (node.additionalProperties !== false) {\n        ctx.warnings.push(`${path}: Missing 'additionalProperties: false' (REQUIRED for Anthropic)`);\n    }\n\n    // Validate properties\n    if (node.properties && typeof node.properties === 'object') {\n        const props = node.properties as Record<string, JsonSchemaValue>;\n        const propCount = Object.keys(props).length;\n        ctx.stats.propertyCount += propCount;\n\n        if (propCount > ANTHROPIC_LIMITS.MAX_PROPERTIES_PER_OBJECT) {\n            ctx.warnings.push(\n                `${path}: ${propCount} properties (may be slow, consider splitting)`,\n            );\n        }\n\n        // Track optional fields\n        const required = (node.required as string[]) || [];\n        for (const [key, prop] of Object.entries(props)) {\n            if (!required.includes(key)) {\n                ctx.stats.optionalFieldCount++;\n            }\n\n            if (prop && typeof prop === 'object') {\n                validateSchemaNode(prop, `${path}.${key}`, ctx);\n            }\n        }\n    }\n}\n\nfunction validateArrayNode(node: JsonSchemaValue, path: string, ctx: ValidationContext): void {\n    // minItems only supports 0 or 1\n    if (node.minItems !== undefined) {\n        const allowed = ANTHROPIC_LIMITS.SUPPORTED_MINMAX_ITEMS as readonly number[];\n        if (!allowed.includes(node.minItems as number)) {\n            ctx.warnings.push(\n                `${path}: 'minItems: ${node.minItems}' not supported (only 0 or 1 allowed)`,\n            );\n        }\n    }\n\n    // Validate items schema\n    if (node.items) {\n        if (typeof node.items === 'object' && !Array.isArray(node.items)) {\n            validateSchemaNode(node.items as JsonSchemaValue, `${path}.items`, ctx);\n        } else if (Array.isArray(node.items)) {\n            // Tuple validation (array of schemas)\n            node.items.forEach((item, i) => {\n                if (item && typeof item === 'object') {\n                    validateSchemaNode(item as JsonSchemaValue, `${path}.items[${i}]`, ctx);\n                }\n            });\n        }\n    }\n\n    // prefixItems (JSON Schema draft 2020-12)\n    if (node.prefixItems && Array.isArray(node.prefixItems)) {\n        node.prefixItems.forEach((item, i) => {\n            if (item && typeof item === 'object') {\n                validateSchemaNode(item as JsonSchemaValue, `${path}.prefixItems[${i}]`, ctx);\n            }\n        });\n    }\n}\n\nfunction validateStringNode(node: JsonSchemaValue, path: string, ctx: ValidationContext): void {\n    // Check format\n    if (node.format && typeof node.format === 'string') {\n        const supported = ANTHROPIC_LIMITS.SUPPORTED_STRING_FORMATS as readonly string[];\n        if (!supported.includes(node.format)) {\n            ctx.warnings.push(\n                `${path}: format '${node.format}' may not be supported. ` +\n        `Supported: ${supported.join(', ')}`,\n            );\n        }\n    }\n\n    // Check pattern (regex)\n    if (node.pattern && typeof node.pattern === 'string') {\n        validateRegexPattern(node.pattern, path, ctx);\n    }\n}\n\nfunction validateNumericNode(_node: JsonSchemaValue, _path: string, _ctx: ValidationContext): void {\n    // All numeric constraints are ignored, already warned above\n    // Nothing additional to check\n}\n\nfunction validateRef(ref: string, path: string, ctx: ValidationContext): void {\n    // External refs not supported\n    if (ref.startsWith('http://') || ref.startsWith('https://')) {\n        ctx.errors.push(`${path}: External $ref not supported ('${ref}')`);\n        return;\n    }\n\n    // Check for circular refs\n    if (ctx.seenRefs.has(ref)) {\n        // Not necessarily an error, but worth noting\n        ctx.info.push(`${path}: Circular reference to '${ref}'`);\n        return;\n    }\n\n    ctx.seenRefs.add(ref);\n\n    // Validate the referenced definition exists\n    const refPath = ref.replace(/^#\\/(\\$defs|definitions)\\//, '');\n    if (!ctx.defs[refPath]) {\n        ctx.errors.push(`${path}: Reference '${ref}' not found in definitions`);\n    }\n}\n\nfunction validateAnyOf(variants: unknown[], path: string, ctx: ValidationContext): void {\n    ctx.stats.anyOfCount++;\n    ctx.stats.totalAnyOfVariants += variants.length;\n\n    if (variants.length > ANTHROPIC_LIMITS.MAX_ANYOF_VARIANTS) {\n        ctx.errors.push(\n            `${path}: anyOf has ${variants.length} variants (max: ${ANTHROPIC_LIMITS.MAX_ANYOF_VARIANTS})`,\n        );\n    }\n\n    if (variants.length === 0) {\n        ctx.errors.push(`${path}: anyOf cannot be empty`);\n        return;\n    }\n\n    variants.forEach((variant, i) => {\n        if (variant && typeof variant === 'object') {\n            validateSchemaNode(variant as JsonSchemaValue, `${path}.anyOf[${i}]`, ctx);\n        }\n    });\n}\n\nfunction validateAllOf(variants: unknown[], path: string, ctx: ValidationContext): void {\n    if (variants.length === 0) {\n        ctx.errors.push(`${path}: allOf cannot be empty`);\n        return;\n    }\n\n    variants.forEach((variant, i) => {\n        if (variant && typeof variant === 'object') {\n            const v = variant as Record<string, unknown>;\n\n            // allOf with $ref not supported\n            if (v.$ref) {\n                ctx.errors.push(`${path}.allOf[${i}]: allOf with $ref not supported`);\n            }\n\n            validateSchemaNode(v as JsonSchemaValue, `${path}.allOf[${i}]`, ctx);\n        }\n    });\n}\n\nfunction validateEnum(values: unknown[], path: string, ctx: ValidationContext): void {\n    ctx.stats.enumCount++;\n\n    if (values.length === 0) {\n        ctx.errors.push(`${path}: enum cannot be empty`);\n        return;\n    }\n\n    if (values.length > ANTHROPIC_LIMITS.MAX_ENUM_VALUES) {\n        ctx.warnings.push(\n            `${path}: enum has ${values.length} values (may be slow)`,\n        );\n    }\n\n    // Check for complex types (not allowed)\n    for (let i = 0; i < values.length; i++) {\n        const val = values[i];\n        const t = typeof val;\n\n        if (t !== 'string' && t !== 'number' && t !== 'boolean' && val !== null) {\n            ctx.errors.push(\n                `${path}.enum[${i}]: Complex type not allowed in enum (got ${t}). ` +\n        'Only string, number, boolean, null permitted.',\n            );\n            break; // One error is enough\n        }\n    }\n\n    // Check for duplicates\n    const seen = new Set();\n    for (const val of values) {\n        const key = JSON.stringify(val);\n        if (seen.has(key)) {\n            ctx.warnings.push(`${path}: Duplicate value in enum: ${key}`);\n            break;\n        }\n        seen.add(key);\n    }\n}\n\nfunction validateConst(value: unknown, path: string, ctx: ValidationContext): void {\n    const t = typeof value;\n    if (t !== 'string' && t !== 'number' && t !== 'boolean' && value !== null) {\n        ctx.errors.push(\n            `${path}: const must be string, number, boolean, or null (got ${t})`,\n        );\n    }\n}\n\nfunction validateRegexPattern(pattern: string, path: string, ctx: ValidationContext): void {\n    // Check for unsupported regex features\n    for (const { pattern: check, name } of UNSUPPORTED_REGEX_FEATURES) {\n        if (check.test(pattern)) {\n            ctx.errors.push(`${path}: Regex pattern uses unsupported feature: ${name}`);\n        }\n    }\n\n    // Try to compile the regex to catch syntax errors\n    try {\n        new RegExp(pattern);\n    } catch (e) {\n        const msg = e instanceof Error ? e.message : 'Invalid regex';\n        ctx.errors.push(`${path}: Invalid regex pattern: ${msg}`);\n    }\n\n    // Warn about complex quantifiers\n    const complexQuantifier = /\\{(\\d+),(\\d+)\\}/g;\n    let match;\n    while ((match = complexQuantifier.exec(pattern)) !== null) {\n        const min = parseInt(match[1], 10);\n        const max = parseInt(match[2], 10);\n        if (max - min > 100) {\n            ctx.warnings.push(\n                `${path}: Large quantifier range {${min},${max}} may cause issues`,\n            );\n        }\n    }\n}\n\n// ============================================================================\n// AUTO-FIX FUNCTIONS\n// ============================================================================\n\n/**\n * Auto-fixes a schema by:\n * 1. Adding additionalProperties: false to all objects\n * 2. Removing unsupported constraints (with description updates)\n * 3. Setting strict: true if not set\n */\nexport function autoFixSchema(schema: StructuredOutputSchema): StructuredOutputSchema {\n    const fixed = structuredClone(schema);\n\n    // Ensure strict mode\n    if (fixed.strict === undefined) {\n        fixed.strict = true;\n    }\n\n    // Fix the value recursively\n    fixSchemaNode(fixed.value);\n\n    return fixed;\n}\n\nfunction fixSchemaNode(node: JsonSchemaValue): void {\n    // Fix objects\n    if (node.type === 'object') {\n        node.additionalProperties = false;\n\n        if (node.properties && typeof node.properties === 'object') {\n            for (const prop of Object.values(node.properties)) {\n                if (prop && typeof prop === 'object') {\n                    fixSchemaNode(prop as JsonSchemaValue);\n                }\n            }\n        }\n    }\n\n    // Fix arrays\n    if (node.type === 'array' && node.items && typeof node.items === 'object') {\n        if (!Array.isArray(node.items)) {\n            fixSchemaNode(node.items as JsonSchemaValue);\n        } else {\n            node.items.forEach(item => {\n                if (item && typeof item === 'object') {\n                    fixSchemaNode(item as JsonSchemaValue);\n                }\n            });\n        }\n    }\n\n    // Fix anyOf\n    if (node.anyOf && Array.isArray(node.anyOf)) {\n        node.anyOf.forEach(variant => {\n            if (variant && typeof variant === 'object') {\n                fixSchemaNode(variant as JsonSchemaValue);\n            }\n        });\n    }\n\n    // Fix allOf\n    if (node.allOf && Array.isArray(node.allOf)) {\n        node.allOf.forEach(variant => {\n            if (variant && typeof variant === 'object') {\n                fixSchemaNode(variant as JsonSchemaValue);\n            }\n        });\n    }\n\n    // Move unsupported constraints to description\n    const constraints: string[] = [];\n\n    for (const key of IGNORED_CONSTRAINTS.numeric) {\n        if (node[key] !== undefined) {\n            constraints.push(`${key}: ${node[key]}`);\n            delete node[key];\n        }\n    }\n\n    for (const key of IGNORED_CONSTRAINTS.string) {\n        if (node[key] !== undefined) {\n            constraints.push(`${key}: ${node[key]}`);\n            delete node[key];\n        }\n    }\n\n    for (const key of IGNORED_CONSTRAINTS.array) {\n        if (node[key] !== undefined) {\n            constraints.push(`${key}: ${node[key]}`);\n            delete node[key];\n        }\n    }\n\n    // Fix minItems if invalid\n    if (node.minItems !== undefined && node.minItems !== null) {\n        const minItems = node.minItems as number;\n        if (minItems !== 0 && minItems !== 1) {\n            constraints.push(`minItems: ${minItems}`);\n            node.minItems = minItems > 0 ? 1 : 0;\n        }\n    }\n\n    // Append constraints to description\n    if (constraints.length > 0) {\n        const constraintNote = `[Constraints: ${constraints.join(', ')}]`;\n        if (node.description) {\n            node.description = `${node.description} ${constraintNote}`;\n        } else {\n            node.description = constraintNote;\n        }\n    }\n}\n\n// ============================================================================\n// UTILITY FUNCTIONS\n// ============================================================================\n\n/**\n * Formats a schema object as a pretty-printed JSON string.\n */\nexport function formatSchema(schema: StructuredOutputSchema | null): string {\n    if (!schema) return '';\n    return JSON.stringify(schema, null, 2);\n}\n\n/**\n * Attempts to parse a structured output response.\n * Returns the parsed object or null if parsing fails.\n * Optionally validates against a schema and returns partial results with warnings.\n */\nexport function parseStructuredResponse(\n    response: string,\n    schema?: StructuredOutputSchema,\n): { data: unknown; warnings: string[] } | null {\n    let parsed: unknown;\n\n    try {\n        parsed = JSON.parse(response);\n    } catch {\n        // Try to extract JSON from markdown code blocks\n        const codeBlockMatch = response.match(/```(?:json)?\\s*([\\s\\S]*?)```/);\n        if (codeBlockMatch) {\n            try {\n                parsed = JSON.parse(codeBlockMatch[1].trim());\n            } catch {\n                return null;\n            }\n        } else {\n            return null;\n        }\n    }\n\n    const warnings: string[] = [];\n\n    // If schema provided, validate required fields\n    if (schema && schema.value.required && Array.isArray(schema.value.required)) {\n        const missing = schema.value.required.filter(\n            field => !(field in (parsed as Record<string, unknown>)),\n        );\n\n        if (missing.length > 0) {\n            warnings.push(`Missing required fields: ${missing.join(', ')}`);\n        }\n    }\n\n    return { data: parsed, warnings };\n}\n\n/**\n * Counts optional fields in a schema (fields not in 'required' array).\n * Each optional field spawns an implicit anyOf with null.\n */\nexport function countOptionalFields(schema: JsonSchemaValue): number {\n    let count = 0;\n\n    function walk(node: JsonSchemaValue): void {\n        if (node.type === 'object' && node.properties) {\n            const required = (node.required as string[]) || [];\n            const props = node.properties as Record<string, JsonSchemaValue>;\n\n            for (const [key, prop] of Object.entries(props)) {\n                if (!required.includes(key)) {\n                    count++;\n                }\n                if (prop && typeof prop === 'object') {\n                    walk(prop);\n                }\n            }\n        }\n\n        if (node.type === 'array' && node.items && typeof node.items === 'object') {\n            if (!Array.isArray(node.items)) {\n                walk(node.items as JsonSchemaValue);\n            }\n        }\n\n        if (node.anyOf && Array.isArray(node.anyOf)) {\n            node.anyOf.forEach(v => {\n                if (v && typeof v === 'object') walk(v as JsonSchemaValue);\n            });\n        }\n\n        if (node.allOf && Array.isArray(node.allOf)) {\n            node.allOf.forEach(v => {\n                if (v && typeof v === 'object') walk(v as JsonSchemaValue);\n            });\n        }\n    }\n\n    walk(schema);\n    return count;\n}\n\n/**\n * Estimates schema complexity for UI feedback.\n */\nexport function estimateSchemaComplexity(schema: StructuredOutputSchema): {\n    level: 'simple' | 'moderate' | 'complex' | 'extreme';\n    score: number;\n    factors: string[];\n} {\n    const factors: string[] = [];\n    let score = 0;\n\n    const result = validateSchema(JSON.stringify(schema));\n    if (!result.valid) {\n        return { level: 'extreme', score: 100, factors: ['Invalid schema'] };\n    }\n\n    // Count various complexity factors\n    const value = schema.value;\n\n    function countNodes(node: JsonSchemaValue): number {\n        let count = 1;\n        if (node.properties) {\n            count += Object.keys(node.properties).length;\n            for (const prop of Object.values(node.properties)) {\n                if (prop && typeof prop === 'object') {\n                    count += countNodes(prop as JsonSchemaValue);\n                }\n            }\n        }\n        if (node.items && typeof node.items === 'object' && !Array.isArray(node.items)) {\n            count += countNodes(node.items as JsonSchemaValue);\n        }\n        if (node.anyOf && Array.isArray(node.anyOf)) count += node.anyOf.length * 2;\n        if (node.allOf && Array.isArray(node.allOf)) count += node.allOf.length * 2;\n        return count;\n    }\n\n    const nodeCount = countNodes(value);\n    const optionalCount = countOptionalFields(value);\n    const defCount = Object.keys(value.$defs || value.definitions || {}).length;\n\n    if (nodeCount > 50) {\n        score += 30;\n        factors.push(`${nodeCount} schema nodes`);\n    } else if (nodeCount > 20) {\n        score += 15;\n        factors.push(`${nodeCount} schema nodes`);\n    }\n\n    if (optionalCount > 10) {\n        score += 25;\n        factors.push(`${optionalCount} optional fields (implicit anyOf)`);\n    } else if (optionalCount > 5) {\n        score += 10;\n        factors.push(`${optionalCount} optional fields`);\n    }\n\n    if (defCount > 10) {\n        score += 20;\n        factors.push(`${defCount} definitions`);\n    } else if (defCount > 5) {\n        score += 10;\n        factors.push(`${defCount} definitions`);\n    }\n\n    // Determine level\n    let level: 'simple' | 'moderate' | 'complex' | 'extreme';\n    if (score >= 60) {\n        level = 'extreme';\n    } else if (score >= 35) {\n        level = 'complex';\n    } else if (score >= 15) {\n        level = 'moderate';\n    } else {\n        level = 'simple';\n    }\n\n    if (factors.length === 0) {\n        factors.push('Simple schema');\n    }\n\n    return { level, score, factors };\n}\n","// src/presets.ts\n//\n// This module provides higher-level preset operations and utilities.\n// Basic CRUD is in settings.ts; this handles resolution, validation, and UI helpers.\n\nimport type {\n    StageName,\n    StageConfig,\n    PromptPreset,\n    SchemaPreset,\n    StructuredOutputSchema,\n} from './types';\nimport {\n    getSettings,\n    getPromptPreset,\n    getSchemaPreset,\n    getPromptPresets,\n    getSchemaPresets,\n} from './settings';\nimport { validateSchema, formatSchema } from './schema';\nimport { TEMPLATE_PLACEHOLDERS } from './constants';\nimport { debugLog } from './debug';\n\n// ============================================================================\n// STAGE CONFIG RESOLUTION\n// ============================================================================\n\n/**\n * Get the effective stage config, resolving presets to actual values.\n * Returns a StageConfig with resolved prompt and schema.\n */\nexport function getStageConfig(stage: StageName): StageConfig {\n    const settings = getSettings();\n    const defaults = settings.stageDefaults[stage];\n\n    return {\n        promptPresetId: defaults.promptPresetId,\n        customPrompt: defaults.customPrompt,\n        schemaPresetId: defaults.schemaPresetId,\n        customSchema: defaults.customSchema,\n        useStructuredOutput: defaults.useStructuredOutput,\n    };\n}\n\n/**\n * Resolve a stage config to get the actual prompt text.\n * If a preset is selected, returns the preset's prompt.\n * Otherwise returns the custom prompt.\n */\nexport function resolvePrompt(config: StageConfig): string {\n    if (config.promptPresetId) {\n        const preset = getPromptPreset(config.promptPresetId);\n        if (preset) {\n            return preset.prompt;\n        }\n        debugLog('error', 'Prompt preset not found', { id: config.promptPresetId });\n    }\n\n    return config.customPrompt;\n}\n\n/**\n * Resolve a stage config to get the actual schema.\n * Returns null if structured output is disabled or no schema is configured.\n */\nexport function resolveSchema(config: StageConfig): StructuredOutputSchema | null {\n    if (!config.useStructuredOutput) {\n        return null;\n    }\n\n    if (config.schemaPresetId) {\n        const preset = getSchemaPreset(config.schemaPresetId);\n        if (preset) {\n            return preset.schema;\n        }\n        debugLog('error', 'Schema preset not found', { id: config.schemaPresetId });\n    }\n\n    // Try to parse custom schema\n    if (config.customSchema) {\n        const result = validateSchema(config.customSchema);\n        if (result.valid && result.schema) {\n            return result.schema;\n        }\n        debugLog('error', 'Custom schema invalid', { error: result.error });\n    }\n\n    return null;\n}\n\n/**\n * Create a fresh StageConfig from defaults\n */\nexport function createStageConfigFromDefaults(stage: StageName): StageConfig {\n    const settings = getSettings();\n    const defaults = settings.stageDefaults[stage];\n\n    return {\n        promptPresetId: defaults.promptPresetId,\n        customPrompt: defaults.customPrompt,\n        schemaPresetId: defaults.schemaPresetId,\n        customSchema: defaults.customSchema,\n        useStructuredOutput: defaults.useStructuredOutput,\n    };\n}\n\n// ============================================================================\n// PROMPT TEMPLATE PROCESSING\n// ============================================================================\n\nexport interface TemplateContext {\n    originalCharacter?: string;\n    scoreResults?: string;\n    rewriteResults?: string;\n    currentRewrite?: string;\n    currentAnalysis?: string;\n    iterationNumber?: string;\n    charName?: string;\n    userName?: string;\n}\n\n/**\n * Process a prompt template, replacing placeholders with actual values.\n *\n * Order of operations:\n * 1. Run ST's substituteParams for standard macros ({{time}}, {{date}}, etc.)\n * 2. Replace our custom placeholders ({{original_character}}, {{score_results}}, etc.)\n * 3. Replace {{char}} and {{user}} with our specific character/user names\n *    (This overrides ST's substitution which uses the active chat character)\n * 4. Handle conditional blocks {{#if score_results}}...{{/if}}\n */\nexport function processPromptTemplate(prompt: string, context: TemplateContext): string {\n    const { lodash } = SillyTavern.libs;\n\n    // First, run ST's macro substitution for standard macros\n    const { substituteParams } = SillyTavern.getContext();\n    let processed = substituteParams(prompt);\n\n    // Handle conditional blocks first\n    processed = processConditionalBlocks(processed, context);\n\n    // Now replace our custom placeholders using lodash.escapeRegExp\n    if (context.originalCharacter !== undefined) {\n        processed = processed.replace(\n            new RegExp(lodash.escapeRegExp(TEMPLATE_PLACEHOLDERS.ORIGINAL_CHARACTER), 'gi'),\n            context.originalCharacter,\n        );\n    }\n\n    if (context.scoreResults !== undefined) {\n        processed = processed.replace(\n            new RegExp(lodash.escapeRegExp(TEMPLATE_PLACEHOLDERS.SCORE_RESULTS), 'gi'),\n            context.scoreResults,\n        );\n    }\n\n    if (context.rewriteResults !== undefined) {\n        processed = processed.replace(\n            new RegExp(lodash.escapeRegExp(TEMPLATE_PLACEHOLDERS.REWRITE_RESULTS), 'gi'),\n            context.rewriteResults,\n        );\n    }\n\n    if (context.currentRewrite !== undefined) {\n        processed = processed.replace(\n            new RegExp(lodash.escapeRegExp(TEMPLATE_PLACEHOLDERS.CURRENT_REWRITE), 'gi'),\n            context.currentRewrite,\n        );\n    }\n\n    if (context.currentAnalysis !== undefined) {\n        processed = processed.replace(\n            new RegExp(lodash.escapeRegExp(TEMPLATE_PLACEHOLDERS.CURRENT_ANALYSIS), 'gi'),\n            context.currentAnalysis,\n        );\n    }\n\n    if (context.iterationNumber !== undefined) {\n        processed = processed.replace(\n            new RegExp(lodash.escapeRegExp(TEMPLATE_PLACEHOLDERS.ITERATION_NUMBER), 'gi'),\n            context.iterationNumber,\n        );\n    }\n\n    // Replace {{char_name}} with our specific character\n    if (context.charName !== undefined) {\n        processed = processed.replace(\n            new RegExp(lodash.escapeRegExp(TEMPLATE_PLACEHOLDERS.CHARACTER_NAME), 'gi'),\n            context.charName,\n        );\n    }\n\n    // Replace {{user_name}} with our specific user\n    if (context.userName !== undefined) {\n        processed = processed.replace(\n            new RegExp(lodash.escapeRegExp(TEMPLATE_PLACEHOLDERS.USER_NAME), 'gi'),\n            context.userName,\n        );\n    }\n\n    // IMPORTANT: Also replace {{char}} and {{user}} with our specific names\n    if (context.charName !== undefined) {\n        processed = processed.replace(/\\{\\{char\\}\\}/gi, context.charName);\n    }\n\n    if (context.userName !== undefined) {\n        processed = processed.replace(/\\{\\{user\\}\\}/gi, context.userName);\n    }\n\n    return processed;\n}\n\n/**\n * Process conditional blocks like {{#if score_results}}...{{/if}}\n */\nfunction processConditionalBlocks(prompt: string, context: TemplateContext): string {\n    // Match {{#if variable}}...{{/if}} blocks\n    const conditionalRegex = /\\{\\{#if\\s+(\\w+)\\}\\}([\\s\\S]*?)\\{\\{\\/if\\}\\}/gi;\n\n    return prompt.replace(conditionalRegex, (_match, variable, content) => {\n        const varName = variable.toLowerCase();\n\n        // Check if the variable has a truthy value\n        let hasValue = false;\n\n        switch (varName) {\n            case 'score_results':\n                hasValue = !!context.scoreResults?.trim();\n                break;\n            case 'rewrite_results':\n                hasValue = !!context.rewriteResults?.trim();\n                break;\n            case 'current_rewrite':\n                hasValue = !!context.currentRewrite?.trim();\n                break;\n            case 'current_analysis':\n                hasValue = !!context.currentAnalysis?.trim();\n                break;\n            case 'original_character':\n                hasValue = !!context.originalCharacter?.trim();\n                break;\n            case 'iteration_number':\n                hasValue = !!context.iterationNumber && context.iterationNumber !== '0';\n                break;\n            default:\n                hasValue = false;\n        }\n\n        return hasValue ? content : '';\n    });\n}\n\n/**\n * Check if a prompt contains any template placeholders\n */\nexport function promptHasPlaceholders(prompt: string): string[] {\n    const found: string[] = [];\n\n    for (const [key, placeholder] of Object.entries(TEMPLATE_PLACEHOLDERS)) {\n        if (prompt.toLowerCase().includes(placeholder.toLowerCase())) {\n            found.push(key);\n        }\n    }\n\n    return found;\n}\n\n/**\n * Get placeholders that are used but won't have values for a given stage\n */\nexport function getUnfilledPlaceholders(prompt: string, stage: StageName, hasScore: boolean, hasRewrite: boolean): string[] {\n    const used = promptHasPlaceholders(prompt);\n    const unfilled: string[] = [];\n\n    for (const placeholder of used) {\n        switch (placeholder) {\n            case 'SCORE_RESULTS':\n                if (!hasScore && stage !== 'score') {\n                    unfilled.push('{{score_results}} - no score results available');\n                }\n                break;\n            case 'REWRITE_RESULTS':\n            case 'CURRENT_REWRITE':\n                if (!hasRewrite && stage !== 'rewrite') {\n                    unfilled.push('{{rewrite_results}} - no rewrite results available');\n                }\n                break;\n            case 'CURRENT_ANALYSIS':\n                // Only available during refinement\n                unfilled.push('{{current_analysis}} - only available during refinement');\n                break;\n            // ORIGINAL_CHARACTER is always available if we have a character\n            // CHAR_NAME and USER_NAME are always available\n            // ITERATION_NUMBER is always available\n        }\n    }\n\n    return unfilled;\n}\n\n// ============================================================================\n// PRESET UI HELPERS\n// ============================================================================\n\nexport interface PresetOption {\n    id: string;\n    name: string;\n    isBuiltin: boolean;\n    isSelected: boolean;\n}\n\n/**\n * Get prompt presets formatted for a dropdown, with selection state\n */\nexport function getPromptPresetOptions(stage: StageName, selectedId: string | null): PresetOption[] {\n    const presets = getPromptPresets(stage);\n\n    return presets.map(p => ({\n        id: p.id,\n        name: p.isBuiltin ? `${p.name} (builtin)` : p.name,\n        isBuiltin: p.isBuiltin,\n        isSelected: p.id === selectedId,\n    }));\n}\n\n/**\n * Get schema presets formatted for a dropdown, with selection state\n */\nexport function getSchemaPresetOptions(stage: StageName, selectedId: string | null): PresetOption[] {\n    const presets = getSchemaPresets(stage);\n\n    return presets.map(p => ({\n        id: p.id,\n        name: p.isBuiltin ? `${p.name} (builtin)` : p.name,\n        isBuiltin: p.isBuiltin,\n        isSelected: p.id === selectedId,\n    }));\n}\n\n/**\n * Get the display name for a preset (handles null/missing)\n */\nexport function getPresetDisplayName(type: 'prompt' | 'schema', id: string | null): string {\n    if (!id) {\n        return 'Custom';\n    }\n\n    const preset = type === 'prompt' ? getPromptPreset(id) : getSchemaPreset(id);\n    if (!preset) {\n        return 'Unknown';\n    }\n\n    return preset.name;\n}\n\n// ============================================================================\n// SCHEMA HELPERS\n// ============================================================================\n\n/**\n * Get the schema JSON string for editing, either from preset or custom\n */\nexport function getSchemaForEditing(config: StageConfig): string {\n    if (config.schemaPresetId) {\n        const preset = getSchemaPreset(config.schemaPresetId);\n        if (preset) {\n            return formatSchema(preset.schema);\n        }\n    }\n\n    return config.customSchema;\n}\n\n/**\n * Validate a schema string and return user-friendly result\n */\nexport interface SchemaValidationUIResult {\n    isValid: boolean;\n    isEmpty: boolean;\n    errorMessage: string | null;\n    warnings: string[];\n    info: string[];\n}\n\nexport function validateSchemaForUI(schemaJson: string): SchemaValidationUIResult {\n    if (!schemaJson.trim()) {\n        return {\n            isValid: true,\n            isEmpty: true,\n            errorMessage: null,\n            warnings: [],\n            info: ['Empty schema = structured output disabled'],\n        };\n    }\n\n    const result = validateSchema(schemaJson);\n\n    return {\n        isValid: result.valid,\n        isEmpty: false,\n        errorMessage: result.error || null,\n        warnings: result.warnings || [],\n        info: result.info || [],\n    };\n}\n\n// ============================================================================\n// PRESET VALIDATION\n// ============================================================================\n\n/**\n * Validate a prompt preset before saving\n */\nexport interface PresetValidationResult {\n    valid: boolean;\n    errors: string[];\n    warnings: string[];\n}\n\nexport function validatePromptPreset(preset: Partial<PromptPreset>): PresetValidationResult {\n    const errors: string[] = [];\n    const warnings: string[] = [];\n\n    if (!preset.name?.trim()) {\n        errors.push('Name is required');\n    } else if (preset.name.length > 100) {\n        errors.push('Name must be 100 characters or less');\n    }\n\n    if (!preset.prompt?.trim()) {\n        errors.push('Prompt is required');\n    } else if (preset.prompt.length > 50000) {\n        errors.push('Prompt is too long (max 50,000 characters)');\n    }\n\n    // Check for common issues - but don't error if no placeholders\n    if (preset.prompt) {\n        const hasDoubleBraces = preset.prompt.includes('{{');\n        const foundPlaceholders = promptHasPlaceholders(preset.prompt);\n\n        if (hasDoubleBraces && foundPlaceholders.length === 0) {\n            // Has {{ but no recognized placeholders - might be intentional (custom macros)\n            debugLog('info', 'Prompt has {{ but no recognized placeholders', {\n                promptPreview: preset.prompt.substring(0, 100),\n            });\n        }\n    }\n\n    return {\n        valid: errors.length === 0,\n        errors,\n        warnings,\n    };\n}\n\n/**\n * Validate a schema preset before saving\n */\nexport function validateSchemaPreset(preset: Partial<SchemaPreset>): PresetValidationResult {\n    const errors: string[] = [];\n    const warnings: string[] = [];\n\n    if (!preset.name?.trim()) {\n        errors.push('Name is required');\n    } else if (preset.name.length > 100) {\n        errors.push('Name must be 100 characters or less');\n    }\n\n    if (!preset.schema) {\n        errors.push('Schema is required');\n    } else {\n        const schemaJson = typeof preset.schema === 'string'\n            ? preset.schema\n            : JSON.stringify(preset.schema);\n\n        const result = validateSchema(schemaJson);\n        if (!result.valid) {\n            errors.push(result.error || 'Invalid schema');\n        }\n        if (result.warnings) {\n            warnings.push(...result.warnings);\n        }\n    }\n\n    return {\n        valid: errors.length === 0,\n        errors,\n        warnings,\n    };\n}\n\n// ============================================================================\n// UTILITIES\n// ============================================================================\n\n/**\n * Check if a preset name is unique (for validation)\n */\nexport function isPresetNameUnique(type: 'prompt' | 'schema', name: string, excludeId?: string): boolean {\n    const presets = type === 'prompt' ? getPromptPresets() : getSchemaPresets();\n\n    return !presets.some(p =>\n        p.name.toLowerCase() === name.toLowerCase() && p.id !== excludeId,\n    );\n}\n\n/**\n * Generate a unique preset name by appending a number if needed\n */\nexport function generateUniquePresetName(type: 'prompt' | 'schema', baseName: string): string {\n    let name = baseName;\n    let counter = 1;\n\n    while (!isPresetNameUnique(type, name)) {\n        name = `${baseName} (${counter})`;\n        counter++;\n    }\n\n    return name;\n}\n","// src/pipeline.ts\n//\n// Pipeline state machine for managing the character analysis workflow.\n// Handles stage progression, state transitions, result management, and iteration.\n\nimport type {\n    StageName,\n    StageStatus,\n    StageResult,\n    StageConfig,\n    PipelineState,\n    Character,\n    PopulatedField,\n    StructuredOutputSchema,\n    IterationSnapshot,\n    IterationVerdict,\n    ParsedRewrite,\n    ParsedRewriteField,\n} from './types';\nimport { STAGES, CHARACTER_FIELDS, MAX_ITERATION_HISTORY } from './constants';\nimport { createStageConfigFromDefaults, resolvePrompt, resolveSchema, processPromptTemplate, promptHasPlaceholders } from './presets';\nimport { getSettings } from './settings';\nimport { debugLog, logError } from './debug';\n\n// ============================================================================\n// PIPELINE STATE FACTORY\n// ============================================================================\n\n/**\n * Create a fresh pipeline state\n */\nexport function createPipelineState(): PipelineState {\n    return {\n        character: null,\n        characterIndex: null,\n\n        results: {\n            score: null,\n            rewrite: null,\n            analyze: null,\n        },\n\n        configs: {\n            score: createStageConfigFromDefaults('score'),\n            rewrite: createStageConfigFromDefaults('rewrite'),\n            analyze: createStageConfigFromDefaults('analyze'),\n        },\n\n        selectedStages: ['score', 'rewrite'],  // Default pipeline\n        currentStage: null,\n        stageStatus: {\n            score: 'pending',\n            rewrite: 'pending',\n            analyze: 'pending',\n        },\n\n        // Iteration system\n        iterationCount: 0,\n        iterationHistory: [],\n        isRefining: false,\n\n        exportData: null,\n    };\n}\n\n/**\n * Reset pipeline state while optionally keeping character selection\n */\nexport function resetPipeline(state: PipelineState, keepCharacter: boolean = false): PipelineState {\n    const fresh = createPipelineState();\n\n    if (keepCharacter && state.character) {\n        fresh.character = state.character;\n        fresh.characterIndex = state.characterIndex;\n    }\n\n    debugLog('state', 'Pipeline reset', { keepCharacter, hasCharacter: !!fresh.character });\n    return fresh;\n}\n\n// ============================================================================\n// CHARACTER MANAGEMENT\n// ============================================================================\n\n/**\n * Set the selected character and reset results\n */\nexport function setCharacter(state: PipelineState, character: Character | null, index: number | null): PipelineState {\n    // If same character, don't reset\n    if (state.characterIndex === index && index !== null) {\n        return state;\n    }\n\n    const newState: PipelineState = {\n        ...state,\n        character,\n        characterIndex: index,\n        // Reset results when character changes\n        results: {\n            score: null,\n            rewrite: null,\n            analyze: null,\n        },\n        stageStatus: {\n            score: 'pending',\n            rewrite: 'pending',\n            analyze: 'pending',\n        },\n        currentStage: null,\n        // Reset iteration state\n        iterationCount: 0,\n        iterationHistory: [],\n        isRefining: false,\n        exportData: null,\n    };\n\n    debugLog('state', 'Character set', {\n        name: character?.name,\n        index,\n        fieldsPopulated: character ? getPopulatedFields(character).length : 0,\n    });\n\n    return newState;\n}\n\n/**\n * Get populated fields from a character\n */\nexport function getPopulatedFields(char: Character): PopulatedField[] {\n    return CHARACTER_FIELDS\n        .filter(field => {\n            const val = char[field.key];\n            return val && typeof val === 'string' && val.trim().length > 0;\n        })\n        .map(field => {\n            const value = (char[field.key] as string).trim();\n            return {\n                key: field.key,\n                label: field.label,\n                value,\n                charCount: value.length,\n                scoreable: field.scoreable,\n            };\n        });\n}\n\n/**\n * Build character summary for prompts\n */\nexport function buildCharacterSummary(char: Character): string {\n    const fields = getPopulatedFields(char);\n\n    const sections = fields.map(f => `### ${f.label}\\n${f.value}`);\n\n    return `# CHARACTER: ${char.name}\\n\\n${sections.join('\\n\\n')}`;\n}\n\n// ============================================================================\n// STAGE SELECTION\n// ============================================================================\n\n/**\n * Toggle a stage in the selected stages list\n */\nexport function toggleStage(state: PipelineState, stage: StageName): PipelineState {\n    const selected = new Set(state.selectedStages);\n\n    if (selected.has(stage)) {\n        selected.delete(stage);\n    } else {\n        selected.add(stage);\n    }\n\n    // Maintain order based on STAGES constant\n    const orderedSelected = STAGES.filter(s => selected.has(s));\n\n    debugLog('state', 'Stage toggled', { stage, selected: orderedSelected });\n\n    return {\n        ...state,\n        selectedStages: orderedSelected,\n    };\n}\n\n/**\n * Set all selected stages at once\n */\nexport function setSelectedStages(state: PipelineState, stages: StageName[]): PipelineState {\n    // Maintain order based on STAGES constant\n    const orderedSelected = STAGES.filter(s => stages.includes(s));\n\n    return {\n        ...state,\n        selectedStages: orderedSelected,\n    };\n}\n\n/**\n * Select all stages\n */\nexport function selectAllStages(state: PipelineState): PipelineState {\n    return {\n        ...state,\n        selectedStages: [...STAGES],\n    };\n}\n\n/**\n * Check if a stage can be run (has required dependencies)\n */\nexport function canRunStage(state: PipelineState, stage: StageName): { canRun: boolean; reason?: string } {\n    if (!state.character) {\n        return { canRun: false, reason: 'No character selected' };\n    }\n\n    // Check stage-specific dependencies\n    switch (stage) {\n        case 'score':\n            // Score can always run if we have a character\n            return { canRun: true };\n\n        case 'rewrite':\n            // Rewrite can run standalone OR with score results\n            // If score is in selected stages and not complete, warn but allow\n            if (state.selectedStages.includes('score') && !state.results.score?.locked) {\n                return {\n                    canRun: true,\n                    reason: 'Score stage not complete - rewrite will run without score feedback',\n                };\n            }\n            return { canRun: true };\n\n        case 'analyze':\n            // Analyze needs rewrite results to compare\n            if (!state.results.rewrite) {\n                return { canRun: false, reason: 'Analyze requires rewrite results to compare' };\n            }\n            return { canRun: true };\n\n        default:\n            return { canRun: false, reason: 'Unknown stage' };\n    }\n}\n\n/**\n * Check if refinement can be run\n */\nexport function canRefine(state: PipelineState): { canRun: boolean; reason?: string } {\n    if (!state.character) {\n        return { canRun: false, reason: 'No character selected' };\n    }\n\n    if (!state.results.rewrite) {\n        return { canRun: false, reason: 'No rewrite to refine' };\n    }\n\n    if (!state.results.analyze) {\n        return { canRun: false, reason: 'Run analyze first to identify issues' };\n    }\n\n    return { canRun: true };\n}\n\n// ============================================================================\n// STAGE CONFIG MANAGEMENT\n// ============================================================================\n\n/**\n * Update a stage's config\n */\nexport function updateStageConfig(\n    state: PipelineState,\n    stage: StageName,\n    updates: Partial<StageConfig>,\n): PipelineState {\n    return {\n        ...state,\n        configs: {\n            ...state.configs,\n            [stage]: {\n                ...state.configs[stage],\n                ...updates,\n            },\n        },\n    };\n}\n\n/**\n * Reset a stage's config to defaults\n */\nexport function resetStageConfig(state: PipelineState, stage: StageName): PipelineState {\n    return {\n        ...state,\n        configs: {\n            ...state.configs,\n            [stage]: createStageConfigFromDefaults(stage),\n        },\n    };\n}\n\n// ============================================================================\n// STAGE EXECUTION\n// ============================================================================\n\n/**\n * Mark a stage as running\n */\nexport function startStage(state: PipelineState, stage: StageName): PipelineState {\n    debugLog('state', 'Stage started', { stage });\n\n    return {\n        ...state,\n        currentStage: stage,\n        stageStatus: {\n            ...state.stageStatus,\n            [stage]: 'running' as StageStatus,\n        },\n    };\n}\n\n/**\n * Complete a stage with results\n */\nexport function completeStage(\n    state: PipelineState,\n    stage: StageName,\n    result: Omit<StageResult, 'timestamp' | 'locked'>,\n): PipelineState {\n    const stageResult: StageResult = {\n        ...result,\n        timestamp: Date.now(),\n        locked: false,\n    };\n\n    debugLog('state', 'Stage completed', {\n        stage,\n        responseLength: result.response.length,\n        isStructured: result.isStructured,\n    });\n\n    // If this is analyze completing, we're now in refinement mode\n    const isRefining = stage === 'analyze' && state.results.rewrite !== null;\n\n    return {\n        ...state,\n        currentStage: null,\n        stageStatus: {\n            ...state.stageStatus,\n            [stage]: 'complete' as StageStatus,\n        },\n        results: {\n            ...state.results,\n            [stage]: stageResult,\n        },\n        isRefining,\n    };\n}\n\n/**\n * Mark a stage as failed (resets to pending)\n */\nexport function failStage(state: PipelineState, stage: StageName, _error: string): PipelineState {\n    debugLog('state', 'Stage failed', { stage, error: _error });\n\n    return {\n        ...state,\n        currentStage: null,\n        stageStatus: {\n            ...state.stageStatus,\n            [stage]: 'pending' as StageStatus,\n        },\n    };\n}\n\n/**\n * Skip a stage\n */\nexport function skipStage(state: PipelineState, stage: StageName): PipelineState {\n    debugLog('state', 'Stage skipped', { stage });\n\n    return {\n        ...state,\n        stageStatus: {\n            ...state.stageStatus,\n            [stage]: 'skipped' as StageStatus,\n        },\n    };\n}\n\n/**\n * Lock a stage result (user accepted it)\n */\nexport function lockStageResult(state: PipelineState, stage: StageName): PipelineState {\n    const result = state.results[stage];\n    if (!result) return state;\n\n    debugLog('state', 'Stage locked', { stage });\n\n    return {\n        ...state,\n        results: {\n            ...state.results,\n            [stage]: {\n                ...result,\n                locked: true,\n            },\n        },\n    };\n}\n\n/**\n * Unlock a stage result (user wants to regenerate)\n */\nexport function unlockStageResult(state: PipelineState, stage: StageName): PipelineState {\n    const result = state.results[stage];\n    if (!result) return state;\n\n    debugLog('state', 'Stage unlocked', { stage });\n\n    return {\n        ...state,\n        results: {\n            ...state.results,\n            [stage]: {\n                ...result,\n                locked: false,\n            },\n        },\n    };\n}\n\n/**\n * Clear a stage result (for regeneration)\n */\nexport function clearStageResult(state: PipelineState, stage: StageName): PipelineState {\n    debugLog('state', 'Stage result cleared', { stage });\n\n    return {\n        ...state,\n        results: {\n            ...state.results,\n            [stage]: null,\n        },\n        stageStatus: {\n            ...state.stageStatus,\n            [stage]: 'pending' as StageStatus,\n        },\n    };\n}\n\n// ============================================================================\n// ITERATION SYSTEM\n// ============================================================================\n\n/**\n * Extract verdict from analysis response\n */\nexport function extractVerdict(analysisResponse: string): IterationVerdict {\n    const upper = analysisResponse.toUpperCase();\n\n    // Check for explicit verdict markers\n    if (upper.includes('VERDICT') || upper.includes('\"VERDICT\"')) {\n        if (upper.includes('ACCEPT') && !upper.includes('NEEDS')) {\n            return 'accept';\n        }\n        if (upper.includes('REGRESSION')) {\n            return 'regression';\n        }\n        if (upper.includes('NEEDS_REFINEMENT') || upper.includes('NEEDS REFINEMENT')) {\n            return 'needs_refinement';\n        }\n    }\n\n    // Fallback heuristics\n    if (upper.includes('READY TO USE') || upper.includes('NO MORE ITERATIONS')) {\n        return 'accept';\n    }\n    if (upper.includes('WORSE THAN') || upper.includes('STEP BACKWARD') || upper.includes('LOST MORE')) {\n        return 'regression';\n    }\n\n    // Default to needs refinement if we have any issues mentioned\n    if (upper.includes('ISSUE') || upper.includes('PROBLEM') || upper.includes('SHOULD FIX')) {\n        return 'needs_refinement';\n    }\n\n    return 'needs_refinement';\n}\n\n/**\n * Create a snapshot of the current iteration before refining\n */\nexport function createIterationSnapshot(state: PipelineState): IterationSnapshot | null {\n    if (!state.results.rewrite || !state.results.analyze) {\n        return null;\n    }\n\n    const verdict = extractVerdict(state.results.analyze.response);\n\n    return {\n        iteration: state.iterationCount,\n        rewriteResponse: state.results.rewrite.response,\n        rewritePreview: state.results.rewrite.response.substring(0, 200),\n        analysisResponse: state.results.analyze.response,\n        analysisPreview: state.results.analyze.response.substring(0, 200),\n        verdict,\n        timestamp: Date.now(),\n    };\n}\n\n/**\n * Start a refinement iteration\n * - Snapshots current state\n * - Clears analyze result\n * - Increments iteration count\n */\nexport function startRefinement(state: PipelineState): PipelineState {\n    const snapshot = createIterationSnapshot(state);\n\n    if (!snapshot) {\n        logError('Cannot start refinement - missing rewrite or analyze', null);\n        return state;\n    }\n\n    // Add snapshot to history, trim if needed\n    const newHistory = [...state.iterationHistory, snapshot];\n    if (newHistory.length > MAX_ITERATION_HISTORY) {\n        newHistory.shift();\n    }\n\n    debugLog('state', 'Starting refinement iteration', {\n        iteration: state.iterationCount + 1,\n        previousVerdict: snapshot.verdict,\n    });\n\n    return {\n        ...state,\n        iterationHistory: newHistory,\n        iterationCount: state.iterationCount + 1,\n        // Clear analyze so user must re-analyze after refinement\n        results: {\n            ...state.results,\n            analyze: null,\n        },\n        stageStatus: {\n            ...state.stageStatus,\n            analyze: 'pending',\n        },\n        isRefining: true,\n    };\n}\n\n/**\n * Complete a refinement (new rewrite generated)\n * The refinement result replaces the current rewrite\n */\nexport function completeRefinement(\n    state: PipelineState,\n    refinedRewrite: Omit<StageResult, 'timestamp' | 'locked'>,\n): PipelineState {\n    const stageResult: StageResult = {\n        ...refinedRewrite,\n        timestamp: Date.now(),\n        locked: false,\n    };\n\n    debugLog('state', 'Refinement completed', {\n        iteration: state.iterationCount,\n        responseLength: refinedRewrite.response.length,\n    });\n\n    return {\n        ...state,\n        currentStage: null,\n        results: {\n            ...state.results,\n            rewrite: stageResult,\n            // analyze stays null - user must run it\n        },\n        stageStatus: {\n            ...state.stageStatus,\n            rewrite: 'complete',\n            analyze: 'pending',\n        },\n    };\n}\n\n/**\n * Revert to a previous iteration\n */\nexport function revertToIteration(state: PipelineState, iterationIndex: number): PipelineState {\n    if (iterationIndex < 0 || iterationIndex >= state.iterationHistory.length) {\n        logError('Invalid iteration index', { iterationIndex, historyLength: state.iterationHistory.length });\n        return state;\n    }\n\n    const snapshot = state.iterationHistory[iterationIndex];\n\n    debugLog('state', 'Reverting to iteration', { iteration: snapshot.iteration });\n\n    // Restore the rewrite from that iteration\n    const restoredRewrite: StageResult = {\n        response: snapshot.rewriteResponse,\n        isStructured: false,\n        promptUsed: '[Restored from iteration history]',\n        schemaUsed: null,\n        timestamp: Date.now(),\n        locked: false,\n    };\n\n    // Trim history to that point\n    const trimmedHistory = state.iterationHistory.slice(0, iterationIndex);\n\n    return {\n        ...state,\n        results: {\n            ...state.results,\n            rewrite: restoredRewrite,\n            analyze: null,\n        },\n        stageStatus: {\n            ...state.stageStatus,\n            rewrite: 'complete',\n            analyze: 'pending',\n        },\n        iterationCount: snapshot.iteration,\n        iterationHistory: trimmedHistory,\n        isRefining: true,\n    };\n}\n\n/**\n * Accept current rewrite as final (exit refinement loop)\n */\nexport function acceptRewrite(state: PipelineState): PipelineState {\n    if (!state.results.rewrite) {\n        return state;\n    }\n\n    debugLog('state', 'Rewrite accepted as final', { iteration: state.iterationCount });\n\n    return {\n        ...state,\n        results: {\n            ...state.results,\n            rewrite: {\n                ...state.results.rewrite,\n                locked: true,\n            },\n        },\n        isRefining: false,\n    };\n}\n\n// ============================================================================\n// REWRITE PARSING\n// ============================================================================\n\n/**\n * Parse a rewrite response into field key/value pairs.\n * Supports multiple formats with fallback chain:\n * 1. JSON object with field keys\n * 2. Markdown headers (### Field Name)\n * 3. Heuristic field detection\n * 4. Raw content as single field\n */\nexport function parseRewriteResponse(response: string): ParsedRewrite {\n    // Try JSON first\n    const jsonResult = tryParseAsJson(response);\n    if (jsonResult) {\n        return jsonResult;\n    }\n\n    // Try markdown headers\n    const markdownResult = tryParseAsMarkdown(response);\n    if (markdownResult) {\n        return markdownResult;\n    }\n\n    // Try heuristic detection\n    const heuristicResult = tryParseWithHeuristics(response);\n    if (heuristicResult) {\n        return heuristicResult;\n    }\n\n    // Fallback: return raw content\n    return {\n        fields: [{\n            key: 'content',\n            label: 'Content',\n            value: response.trim(),\n        }],\n        raw: response,\n        parseMethod: 'raw',\n    };\n}\n\nfunction tryParseAsJson(response: string): ParsedRewrite | null {\n    try {\n        // Try direct parse\n        let parsed: Record<string, unknown>;\n        try {\n            parsed = JSON.parse(response);\n        } catch {\n            // Try extracting from code block\n            const codeBlockMatch = response.match(/```(?:json)?\\s*([\\s\\S]*?)```/);\n            if (!codeBlockMatch) return null;\n            parsed = JSON.parse(codeBlockMatch[1].trim());\n        }\n\n        if (typeof parsed !== 'object' || parsed === null || Array.isArray(parsed)) {\n            return null;\n        }\n\n        const fields: ParsedRewriteField[] = [];\n\n        for (const [key, value] of Object.entries(parsed)) {\n            if (typeof value === 'string' && value.trim()) {\n                const fieldDef = CHARACTER_FIELDS.find(f =>\n                    f.key === key || f.label.toLowerCase() === key.toLowerCase(),\n                );\n\n                fields.push({\n                    key: fieldDef?.key || key,\n                    label: fieldDef?.label || formatFieldLabel(key),\n                    value: value.trim(),\n                });\n            }\n        }\n\n        if (fields.length === 0) return null;\n\n        return {\n            fields,\n            raw: response,\n            parseMethod: 'json',\n        };\n    } catch {\n        return null;\n    }\n}\n\nfunction tryParseAsMarkdown(response: string): ParsedRewrite | null {\n    // Match ### Header or ## Header patterns\n    const headerPattern = /^#{2,3}\\s+(.+?)$/gm;\n    const matches = [...response.matchAll(headerPattern)];\n\n    if (matches.length === 0) return null;\n\n    const fields: ParsedRewriteField[] = [];\n\n    for (let i = 0; i < matches.length; i++) {\n        const match = matches[i];\n        const headerText = match[1].trim();\n        const startIndex = match.index! + match[0].length;\n        const endIndex = matches[i + 1]?.index ?? response.length;\n        const content = response.slice(startIndex, endIndex).trim();\n\n        if (!content) continue;\n\n        // Try to match header to known field\n        const fieldDef = CHARACTER_FIELDS.find(f =>\n            f.label.toLowerCase() === headerText.toLowerCase() ||\n            f.key === headerText.toLowerCase().replace(/\\s+/g, '_'),\n        );\n\n        // Skip non-character fields like \"Summary\" or \"Notes\"\n        const skipHeaders = ['summary', 'notes', 'changes', 'revised', 'original'];\n        if (!fieldDef && skipHeaders.some(s => headerText.toLowerCase().includes(s))) {\n            continue;\n        }\n\n        fields.push({\n            key: fieldDef?.key || headerText.toLowerCase().replace(/\\s+/g, '_'),\n            label: fieldDef?.label || headerText,\n            value: content,\n        });\n    }\n\n    if (fields.length === 0) return null;\n\n    return {\n        fields,\n        raw: response,\n        parseMethod: 'markdown',\n    };\n}\n\nfunction tryParseWithHeuristics(response: string): ParsedRewrite | null {\n    const fields: ParsedRewriteField[] = [];\n\n    // Look for patterns like \"Description:\" or \"**Description:**\"\n    for (const fieldDef of CHARACTER_FIELDS) {\n        const patterns = [\n            new RegExp(`\\\\*\\\\*${fieldDef.label}:\\\\*\\\\*\\\\s*([\\\\s\\\\S]*?)(?=\\\\*\\\\*[A-Z]|$)`, 'i'),\n            new RegExp(`${fieldDef.label}:\\\\s*([\\\\s\\\\S]*?)(?=\\\\n[A-Z][a-z]+:|$)`, 'i'),\n            new RegExp(`\\\\[${fieldDef.label}\\\\]\\\\s*([\\\\s\\\\S]*?)(?=\\\\[[A-Z]|$)`, 'i'),\n        ];\n\n        for (const pattern of patterns) {\n            const match = response.match(pattern);\n            if (match && match[1].trim()) {\n                fields.push({\n                    key: fieldDef.key,\n                    label: fieldDef.label,\n                    value: match[1].trim(),\n                });\n                break;\n            }\n        }\n    }\n\n    if (fields.length === 0) return null;\n\n    return {\n        fields,\n        raw: response,\n        parseMethod: 'heuristic',\n    };\n}\n\nfunction formatFieldLabel(key: string): string {\n    return key\n        .replace(/_/g, ' ')\n        .replace(/([a-z])([A-Z])/g, '$1 $2')\n        .replace(/\\b\\w/g, c => c.toUpperCase());\n}\n\n// ============================================================================\n// APPLY REWRITE TO CHARACTER\n// ============================================================================\n\n/**\n * Apply parsed rewrite fields to a character.\n * Returns the updated character data or null on failure.\n */\nexport async function applyRewriteToCharacter(\n    state: PipelineState,\n    parsedFields: ParsedRewriteField[],\n): Promise<{ success: boolean; error?: string; updatedFields: string[] }> {\n    if (!state.character || state.characterIndex === null) {\n        return { success: false, error: 'No character selected', updatedFields: [] };\n    }\n\n    const { characters, unshallowCharacter, getRequestHeaders } = SillyTavern.getContext();\n\n    try {\n        // Ensure character data is fully loaded\n        await unshallowCharacter(state.characterIndex);\n\n        // Get fresh character reference after unshallow\n        const charList = characters as Character[];\n        const character = charList[state.characterIndex];\n\n        if (!character) {\n            return { success: false, error: 'Character not found after unshallow', updatedFields: [] };\n        }\n\n        // Build update object\n        const updates: Partial<Character> = {};\n        const updatedFields: string[] = [];\n\n        for (const field of parsedFields) {\n            // Only update known character fields\n            const fieldDef = CHARACTER_FIELDS.find(f => f.key === field.key);\n            if (fieldDef && field.value.trim()) {\n                (updates as Record<string, string>)[field.key] = field.value.trim();\n                updatedFields.push(field.label);\n            }\n        }\n\n        if (updatedFields.length === 0) {\n            return { success: false, error: 'No valid fields to update', updatedFields: [] };\n        }\n\n        // Apply updates to character object\n        Object.assign(character, updates);\n\n        // Save to server\n        const saveResponse = await fetch('/api/characters/edit', {\n            method: 'POST',\n            headers: getRequestHeaders(),\n            body: JSON.stringify({\n                avatar_url: character.avatar,\n                ...character,\n            }),\n        });\n\n        if (!saveResponse.ok) {\n            const errorText = await saveResponse.text();\n            logError('Failed to save character', { status: saveResponse.status, error: errorText });\n            return { success: false, error: `Save failed: ${saveResponse.status}`, updatedFields: [] };\n        }\n\n        debugLog('info', 'Character updated successfully', {\n            name: character.name,\n            updatedFields,\n        });\n\n        return { success: true, updatedFields };\n    } catch (e) {\n        logError('Error applying rewrite to character', e);\n        return { success: false, error: (e as Error).message, updatedFields: [] };\n    }\n}\n\n// ============================================================================\n// PIPELINE NAVIGATION\n// ============================================================================\n\n/**\n * Get the next stage in the selected pipeline\n */\nexport function getNextStage(state: PipelineState, currentStage: StageName): StageName | null {\n    const currentIndex = state.selectedStages.indexOf(currentStage);\n    if (currentIndex === -1 || currentIndex >= state.selectedStages.length - 1) {\n        return null;\n    }\n    return state.selectedStages[currentIndex + 1];\n}\n\n/**\n * Get the previous stage in the selected pipeline\n */\nexport function getPreviousStage(state: PipelineState, currentStage: StageName): StageName | null {\n    const currentIndex = state.selectedStages.indexOf(currentStage);\n    if (currentIndex <= 0) {\n        return null;\n    }\n    return state.selectedStages[currentIndex - 1];\n}\n\n/**\n * Get the first incomplete stage in the pipeline\n */\nexport function getFirstIncompleteStage(state: PipelineState): StageName | null {\n    for (const stage of state.selectedStages) {\n        const status = state.stageStatus[stage];\n        if (status === 'pending' || status === 'running') {\n            return stage;\n        }\n    }\n    return null;\n}\n\n/**\n * Check if all selected stages are complete\n */\nexport function isPipelineComplete(state: PipelineState): boolean {\n    return state.selectedStages.every(stage => {\n        const status = state.stageStatus[stage];\n        return status === 'complete' || status === 'skipped';\n    });\n}\n\n/**\n * Check if pipeline is ready for export\n */\nexport function canExport(state: PipelineState): boolean {\n    // Need at least rewrite results to export\n    return !!state.results.rewrite;\n}\n\n// ============================================================================\n// PROMPT BUILDING\n// ============================================================================\n\n/**\n * Build the complete prompt for a stage, including template substitution.\n * If no placeholders are detected, prepends character data automatically.\n */\nexport function buildStagePrompt(state: PipelineState, stage: StageName): string | null {\n    if (!state.character) {\n        return null;\n    }\n\n    const config = state.configs[stage];\n    const basePrompt = resolvePrompt(config);\n\n    if (!basePrompt.trim()) {\n        return null;\n    }\n\n    // Build character summary\n    const characterSummary = buildCharacterSummary(state.character);\n\n    // Build template context with all available data\n    const { name1 } = SillyTavern.getContext();\n\n    const context = {\n        originalCharacter: characterSummary,\n        scoreResults: state.results.score?.response || '',\n        rewriteResults: state.results.rewrite?.response || '',\n        currentRewrite: state.results.rewrite?.response || '',\n        currentAnalysis: state.results.analyze?.response || '',\n        iterationNumber: String(state.iterationCount + 1),\n        charName: state.character.name,\n        userName: name1 || 'User',\n    };\n\n    // Check which placeholders are used in the prompt\n    const foundPlaceholders = promptHasPlaceholders(basePrompt);\n    const hasAnyPlaceholder = foundPlaceholders.length > 0;\n\n    // Process template placeholders in the prompt\n    const processedPrompt = processPromptTemplate(basePrompt, context);\n\n    // If prompt has placeholders, trust that user knows what they're doing\n    if (hasAnyPlaceholder) {\n        // But still check if critical data is missing\n        const usesCharacterPlaceholder = foundPlaceholders.includes('ORIGINAL_CHARACTER');\n\n        // If they use character placeholder, just return processed prompt\n        if (usesCharacterPlaceholder) {\n            return processedPrompt;\n        }\n\n        // If they use other placeholders but not character, prepend character data\n        return buildStructuredPrompt(stage, state, characterSummary, processedPrompt);\n    }\n\n    // No placeholders detected - prepend all relevant data automatically\n    debugLog('info', 'No placeholders in prompt, auto-prepending character data', { stage });\n    return buildStructuredPrompt(stage, state, characterSummary, processedPrompt);\n}\n\n/**\n * Build the refinement prompt\n */\nexport function buildRefinementPrompt(state: PipelineState): string | null {\n    if (!state.character || !state.results.rewrite || !state.results.analyze) {\n        return null;\n    }\n\n    const settings = getSettings();\n    const basePrompt = settings.refinementPrompt;\n\n    const characterSummary = buildCharacterSummary(state.character);\n    const { name1 } = SillyTavern.getContext();\n\n    const context = {\n        originalCharacter: characterSummary,\n        scoreResults: state.results.score?.response || '',\n        rewriteResults: state.results.rewrite.response,\n        currentRewrite: state.results.rewrite.response,\n        currentAnalysis: state.results.analyze.response,\n        iterationNumber: String(state.iterationCount + 1),\n        charName: state.character.name,\n        userName: name1 || 'User',\n    };\n\n    return processPromptTemplate(basePrompt, context);\n}\n\n/**\n * Build a structured prompt with all relevant data prepended\n */\nfunction buildStructuredPrompt(\n    stage: StageName,\n    state: PipelineState,\n    characterSummary: string,\n    instructions: string,\n): string {\n    const parts: string[] = [];\n\n    // Always include character\n    const stageAction = stage === 'score' ? 'Analyze' : stage === 'rewrite' ? 'Rewrite' : 'Compare';\n    parts.push(`# Character to ${stageAction}`, '', characterSummary);\n\n    // Stage-specific data\n    switch (stage) {\n        case 'score':\n            // Score only needs character - already added above\n            break;\n\n        case 'rewrite':\n            // Include score results if available\n            if (state.results.score?.response) {\n                parts.push('', '---', '', '# Score Feedback', '', 'Use this feedback to guide your rewrite:', '', state.results.score.response);\n            }\n            break;\n\n        case 'analyze':\n            // Include rewrite results\n            if (state.results.rewrite?.response) {\n                parts.push('', '---', '', '# Rewritten Version', '', 'Compare this against the original:', '', state.results.rewrite.response);\n            }\n\n            // Include score results if available\n            if (state.results.score?.response) {\n                parts.push('', '---', '', '# Original Score Feedback', '', 'Reference for what was identified as needing improvement:', '', state.results.score.response);\n            }\n            break;\n    }\n\n    // Add the instructions/prompt\n    parts.push('', '---', '', '# Instructions', '', instructions);\n\n    return parts.join('\\n');\n}\n\n/**\n * Get the schema for a stage (if structured output is enabled)\n */\nexport function getStageSchema(state: PipelineState, stage: StageName): StructuredOutputSchema | null {\n    const config = state.configs[stage];\n    return resolveSchema(config);\n}\n\n// ============================================================================\n// EXPORT\n// ============================================================================\n\n/**\n * Generate export data from rewrite results\n */\nexport function generateExportData(state: PipelineState): string | null {\n    if (!state.results.rewrite || !state.character) {\n        return null;\n    }\n\n    const rewriteResponse = state.results.rewrite.response;\n\n    const exportLines = [\n        `# ${state.character.name} (Rewritten)`,\n        '',\n        `Generated: ${new Date().toLocaleString()}`,\n        `Iterations: ${state.iterationCount}`,\n        '',\n        '---',\n        '',\n        rewriteResponse,\n    ];\n\n    // If we have analyze results, include them as notes\n    if (state.results.analyze) {\n        exportLines.push(\n            '',\n            '---',\n            '',\n            '## Final Analysis',\n            '',\n            state.results.analyze.response,\n        );\n    }\n\n    // If we have score results, include summary\n    if (state.results.score) {\n        exportLines.push(\n            '',\n            '---',\n            '',\n            '## Original Score',\n            '',\n            state.results.score.response,\n        );\n    }\n\n    // Include iteration history summary if we have any\n    if (state.iterationHistory.length > 0) {\n        exportLines.push(\n            '',\n            '---',\n            '',\n            '## Iteration History',\n            '',\n        );\n\n        for (const snap of state.iterationHistory) {\n            exportLines.push(\n                `### Iteration ${snap.iteration + 1} - ${snap.verdict.toUpperCase()}`,\n                `${new Date(snap.timestamp).toLocaleString()}`,\n                '',\n            );\n        }\n    }\n\n    return exportLines.join('\\n');\n}\n\n/**\n * Set export data in state\n */\nexport function setExportData(state: PipelineState): PipelineState {\n    const exportData = generateExportData(state);\n\n    return {\n        ...state,\n        exportData,\n    };\n}\n\n// ============================================================================\n// STATE QUERIES\n// ============================================================================\n\n/**\n * Get a summary of pipeline state for debugging/display\n */\nexport function getPipelineSummary(state: PipelineState): {\n    hasCharacter: boolean;\n    characterName: string | null;\n    selectedStages: StageName[];\n    stageStatuses: Record<StageName, StageStatus>;\n    completedStages: StageName[];\n    lockedStages: StageName[];\n    currentStage: StageName | null;\n    canExport: boolean;\n    isComplete: boolean;\n    iterationCount: number;\n    isRefining: boolean;\n    lastVerdict: IterationVerdict | null;\n} {\n    const completedStages = STAGES.filter(s => state.stageStatus[s] === 'complete');\n    const lockedStages = STAGES.filter(s => state.results[s]?.locked);\n\n    const lastSnapshot = state.iterationHistory.length > 0\n        ? state.iterationHistory[state.iterationHistory.length - 1]\n        : null;\n\n    return {\n        hasCharacter: !!state.character,\n        characterName: state.character?.name || null,\n        selectedStages: state.selectedStages,\n        stageStatuses: { ...state.stageStatus },\n        completedStages,\n        lockedStages,\n        currentStage: state.currentStage,\n        canExport: canExport(state),\n        isComplete: isPipelineComplete(state),\n        iterationCount: state.iterationCount,\n        isRefining: state.isRefining,\n        lastVerdict: lastSnapshot?.verdict || null,\n    };\n}\n\n/**\n * Check if a specific stage has results (complete or not)\n */\nexport function hasStageResult(state: PipelineState, stage: StageName): boolean {\n    return !!state.results[stage];\n}\n\n/**\n * Check if a specific stage result is locked\n */\nexport function isStageResultLocked(state: PipelineState, stage: StageName): boolean {\n    return !!state.results[stage]?.locked;\n}\n\n/**\n * Get stage result if available\n */\nexport function getStageResult(state: PipelineState, stage: StageName): StageResult | null {\n    return state.results[stage];\n}\n\n// ============================================================================\n// VALIDATION\n// ============================================================================\n\n/**\n * Validate pipeline state before running\n */\nexport interface PipelineValidation {\n    valid: boolean;\n    errors: string[];\n    warnings: string[];\n}\n\nexport function validatePipeline(state: PipelineState): PipelineValidation {\n    const errors: string[] = [];\n    const warnings: string[] = [];\n\n    // Must have character\n    if (!state.character) {\n        errors.push('No character selected');\n    }\n\n    // Must have at least one stage selected\n    if (state.selectedStages.length === 0) {\n        errors.push('No stages selected');\n    }\n\n    // Check each selected stage\n    for (const stage of state.selectedStages) {\n        const config = state.configs[stage];\n        const prompt = resolvePrompt(config);\n\n        if (!prompt.trim()) {\n            errors.push(`${stage}: No prompt configured`);\n        }\n\n        // Warn about missing dependencies (but don't error - we auto-include now)\n        if (stage === 'rewrite' && !state.results.score && state.selectedStages.includes('score')) {\n            warnings.push('Rewrite will run without score feedback (score not complete)');\n        }\n\n        if (stage === 'analyze' && !state.results.rewrite) {\n            errors.push('Analyze requires rewrite results');\n        }\n    }\n\n    // Check API readiness\n    const { onlineStatus } = SillyTavern.getContext();\n    if (onlineStatus !== 'Valid' && onlineStatus !== 'Connected') {\n        errors.push('API is not connected');\n    }\n\n    return {\n        valid: errors.length === 0,\n        errors,\n        warnings,\n    };\n}\n\n/**\n * Validate refinement before running\n */\nexport function validateRefinement(state: PipelineState): PipelineValidation {\n    const errors: string[] = [];\n    const warnings: string[] = [];\n\n    if (!state.character) {\n        errors.push('No character selected');\n    }\n\n    if (!state.results.rewrite) {\n        errors.push('No rewrite to refine');\n    }\n\n    if (!state.results.analyze) {\n        errors.push('Run analyze first to identify issues');\n    }\n\n    // Check API readiness\n    const { onlineStatus } = SillyTavern.getContext();\n    if (onlineStatus !== 'Valid' && onlineStatus !== 'Connected') {\n        errors.push('API is not connected');\n    }\n\n    // Warn if last verdict was accept\n    const lastSnapshot = state.iterationHistory.length > 0\n        ? state.iterationHistory[state.iterationHistory.length - 1]\n        : null;\n\n    if (lastSnapshot?.verdict === 'accept') {\n        warnings.push('Last analysis suggested accepting the rewrite');\n    }\n\n    if (state.iterationCount >= 5) {\n        warnings.push(`Already at iteration ${state.iterationCount + 1} - consider accepting or starting fresh`);\n    }\n\n    return {\n        valid: errors.length === 0,\n        errors,\n        warnings,\n    };\n}\n\n// ============================================================================\n// SERIALIZATION (for potential future persistence)\n// ============================================================================\n\n/**\n * Serialize pipeline state to JSON-safe object\n */\nexport function serializePipelineState(state: PipelineState): Record<string, unknown> {\n    return {\n        characterIndex: state.characterIndex,\n        results: state.results,\n        configs: state.configs,\n        selectedStages: state.selectedStages,\n        stageStatus: state.stageStatus,\n        iterationCount: state.iterationCount,\n        iterationHistory: state.iterationHistory,\n        isRefining: state.isRefining,\n        exportData: state.exportData,\n        // Don't serialize character - will be re-fetched by index\n    };\n}\n\n/**\n * Deserialize pipeline state (would need character list to restore character)\n */\nexport function deserializePipelineState(\n    data: Record<string, unknown>,\n    characters: Character[],\n): PipelineState | null {\n    try {\n        const characterIndex = data.characterIndex as number | null;\n        const character = characterIndex !== null ? characters[characterIndex] : null;\n\n        return {\n            character,\n            characterIndex,\n            results: data.results as PipelineState['results'],\n            configs: data.configs as PipelineState['configs'],\n            selectedStages: data.selectedStages as StageName[],\n            currentStage: null,  // Always reset to null on restore\n            stageStatus: data.stageStatus as Record<StageName, StageStatus>,\n            iterationCount: (data.iterationCount as number) || 0,\n            iterationHistory: (data.iterationHistory as IterationSnapshot[]) || [],\n            isRefining: (data.isRefining as boolean) || false,\n            exportData: data.exportData as string | null,\n        };\n    } catch (e) {\n        logError('Failed to deserialize pipeline state', e);\n        return null;\n    }\n}\n","// src/generator.ts\n//\n// Handles LLM generation for pipeline stages and refinement.\n// Supports both ST's current settings and custom API configuration.\n//\n// NOTE: Abort/cancel only works between API calls, not during active streaming.\n// Once a streaming request starts, it will complete or error - the abort signal\n// is checked before starting and after completion, but cannot interrupt mid-stream.\n\nimport { getSettings } from './settings';\nimport { debugLog, logError } from './debug';\nimport type {\n    StructuredOutputSchema,\n    GenerationResult,\n    PipelineState,\n    StageName,\n} from './types';\nimport { buildStagePrompt, buildRefinementPrompt, getStageSchema } from './pipeline';\n\n// ============================================================================\n// API STATUS\n// ============================================================================\n\n/**\n * Check if the API is ready for generation\n */\nexport function isApiReady(): boolean {\n    const { onlineStatus } = SillyTavern.getContext();\n    return onlineStatus === 'Valid' || onlineStatus === 'Connected';\n}\n\n/**\n * Get current API info for display\n */\nexport function getApiInfo(): { source: string; model: string; isReady: boolean } {\n    const context = SillyTavern.getContext();\n    const settings = getSettings();\n\n    if (settings.useCurrentSettings) {\n        return {\n            source: context.chatCompletionSettings?.chat_completion_source || context.mainApi || 'unknown',\n            model: context.chatCompletionSettings?.openrouter_model ||\n             context.chatCompletionSettings?.model_openai_select ||\n             'unknown',\n            isReady: isApiReady(),\n        };\n    }\n\n    return {\n        source: settings.generationConfig.source,\n        model: settings.generationConfig.model,\n        isReady: isApiReady(),\n    };\n}\n\n// ============================================================================\n// MAIN GENERATION FUNCTION\n// ============================================================================\n\n/**\n * Run generation for a pipeline stage.\n *\n * NOTE: The abort signal is checked before and after generation, but cannot\n * interrupt an active streaming request mid-stream.\n */\nexport async function runStageGeneration(\n    state: PipelineState,\n    stage: StageName,\n    signal?: AbortSignal,\n): Promise<GenerationResult> {\n    const context = SillyTavern.getContext();\n    const settings = getSettings();\n\n    // Pre-flight checks\n    if (signal?.aborted) {\n        return { success: false, error: 'Generation cancelled' };\n    }\n\n    if (!state.character) {\n        return { success: false, error: 'No character selected' };\n    }\n\n    if (!isApiReady()) {\n        logError('API not ready', { onlineStatus: context.onlineStatus });\n        return { success: false, error: 'API is not connected. Check your connection settings.' };\n    }\n\n    // Build prompt\n    const userPrompt = buildStagePrompt(state, stage);\n    if (!userPrompt) {\n        return { success: false, error: 'No prompt configured for this stage' };\n    }\n\n    // Get schema if structured output is enabled\n    const config = state.configs[stage];\n    const jsonSchema = config.useStructuredOutput ? getStageSchema(state, stage) : null;\n\n    // Substitute character placeholders in the prompt\n    const processedPrompt = substituteCharacterPlaceholders(\n        userPrompt,\n        state.character.name,\n        context.name1 || 'User',\n    );\n\n    debugLog('info', 'Starting stage generation', {\n        stage,\n        character: state.character.name,\n        useCurrentSettings: settings.useCurrentSettings,\n        useStructured: !!jsonSchema,\n        schemaName: jsonSchema?.name,\n        promptLength: processedPrompt.length,\n    });\n\n    const result = await executeGeneration(\n        settings.systemPrompt,\n        processedPrompt,\n        jsonSchema,\n        signal,\n        settings.useCurrentSettings,\n    );\n\n    // If structured output was requested, validate the response\n    if (result.success && jsonSchema) {\n        return validateStructuredResponse(result.response, jsonSchema);\n    }\n\n    return result;\n}\n\n/**\n * Run refinement generation.\n *\n * NOTE: The abort signal is checked before and after generation, but cannot\n * interrupt an active streaming request mid-stream.\n */\nexport async function runRefinementGeneration(\n    state: PipelineState,\n    signal?: AbortSignal,\n): Promise<GenerationResult> {\n    const context = SillyTavern.getContext();\n    const settings = getSettings();\n\n    // Pre-flight checks\n    if (signal?.aborted) {\n        return { success: false, error: 'Generation cancelled' };\n    }\n\n    if (!state.character) {\n        return { success: false, error: 'No character selected' };\n    }\n\n    if (!state.results.rewrite || !state.results.analyze) {\n        return { success: false, error: 'Refinement requires both rewrite and analyze results' };\n    }\n\n    if (!isApiReady()) {\n        logError('API not ready', { onlineStatus: context.onlineStatus });\n        return { success: false, error: 'API is not connected. Check your connection settings.' };\n    }\n\n    // Build refinement prompt\n    const userPrompt = buildRefinementPrompt(state);\n    if (!userPrompt) {\n        return { success: false, error: 'Failed to build refinement prompt' };\n    }\n\n    // Substitute character placeholders\n    const processedPrompt = substituteCharacterPlaceholders(\n        userPrompt,\n        state.character.name,\n        context.name1 || 'User',\n    );\n\n    debugLog('info', 'Starting refinement generation', {\n        iteration: state.iterationCount + 1,\n        character: state.character.name,\n        promptLength: processedPrompt.length,\n    });\n\n    // Refinement doesn't use structured output - we want free-form character card\n    return await executeGeneration(\n        settings.systemPrompt,\n        processedPrompt,\n        null,\n        signal,\n        settings.useCurrentSettings,\n    );\n}\n\n/**\n * Validate structured response and fall back gracefully if parsing fails\n */\nfunction validateStructuredResponse(\n    response: string,\n    schema: StructuredOutputSchema,\n): GenerationResult {\n    try {\n        const parsed = JSON.parse(response);\n\n        // Basic structure validation - check required fields exist\n        if (schema.value.required && Array.isArray(schema.value.required)) {\n            const missing = schema.value.required.filter(\n                field => !(field in parsed),\n            );\n\n            if (missing.length > 0) {\n                debugLog('info', 'Structured response missing required fields, returning as unstructured', {\n                    missing,\n                    schemaName: schema.name,\n                });\n                // Return as unstructured rather than failing\n                return {\n                    success: true,\n                    response,\n                    isStructured: false,\n                };\n            }\n        }\n\n        // Valid structured response\n        return {\n            success: true,\n            response,\n            isStructured: true,\n        };\n    } catch (e) {\n        debugLog('info', 'Failed to parse structured response, returning as unstructured', {\n            error: (e as Error).message,\n            schemaName: schema.name,\n            responsePreview: response.substring(0, 200),\n        });\n\n        // Fall back to unstructured rather than failing\n        return {\n            success: true,\n            response,\n            isStructured: false,\n        };\n    }\n}\n\n/**\n * Core generation execution\n */\nasync function executeGeneration(\n    systemPrompt: string,\n    userPrompt: string,\n    jsonSchema: StructuredOutputSchema | null,\n    signal: AbortSignal | undefined,\n    useCurrentSettings: boolean,\n): Promise<GenerationResult> {\n    try {\n        let response: string;\n\n        if (useCurrentSettings) {\n            response = await generateWithCurrentSettings(\n                systemPrompt,\n                userPrompt,\n                jsonSchema,\n                signal,\n            );\n        } else {\n            response = await generateWithCustomSettings(\n                systemPrompt,\n                userPrompt,\n                jsonSchema,\n                signal,\n            );\n        }\n\n        // Check abort after generation\n        if (signal?.aborted) {\n            return { success: false, error: 'Generation cancelled' };\n        }\n\n        if (!response || response.trim() === '') {\n            logError('Empty response', null);\n            return { success: false, error: 'Empty response from API' };\n        }\n\n        debugLog('info', 'Generation complete', {\n            responseLength: response.length,\n            isStructured: !!jsonSchema,\n        });\n\n        return {\n            success: true,\n            response,\n            isStructured: !!jsonSchema,\n        };\n    } catch (err) {\n        // Handle abort errors gracefully\n        if ((err as Error).name === 'AbortError' || signal?.aborted) {\n            debugLog('info', 'Generation aborted', null);\n            return { success: false, error: 'Generation cancelled' };\n        }\n\n        logError('Generation exception', {\n            message: err instanceof Error ? err.message : String(err),\n        });\n\n        const errorMessage = err instanceof Error ? err.message : String(err);\n        return { success: false, error: errorMessage };\n    }\n}\n\n// ============================================================================\n// GENERATION METHODS\n// ============================================================================\n\n/**\n * Generate using ST's current API settings\n */\nasync function generateWithCurrentSettings(\n    systemPrompt: string,\n    userPrompt: string,\n    jsonSchema: StructuredOutputSchema | null,\n    signal?: AbortSignal,\n): Promise<string> {\n    const { generateRaw, substituteParams } = SillyTavern.getContext();\n\n    // Run ST's macro substitution on system prompt\n    const processedSystemPrompt = substituteParams(systemPrompt);\n\n    debugLog('request', 'generateRaw request', {\n        hasSchema: !!jsonSchema,\n        schemaName: jsonSchema?.name,\n        systemPromptLength: processedSystemPrompt.length,\n        userPromptLength: userPrompt.length,\n    });\n\n    if (signal?.aborted) {\n        throw new DOMException('Aborted', 'AbortError');\n    }\n\n    const rawResponse = await generateRaw({\n        prompt: [\n            { role: 'system', content: processedSystemPrompt },\n            { role: 'user', content: userPrompt },\n        ],\n        jsonSchema: jsonSchema as StructuredOutputSchema | null,\n    });\n\n    if (signal?.aborted) {\n        throw new DOMException('Aborted', 'AbortError');\n    }\n\n    const response = ensureString(rawResponse);\n\n    debugLog('response', 'generateRaw response', {\n        type: typeof rawResponse,\n        length: response.length,\n        preview: response.substring(0, 200),\n    });\n\n    return response;\n}\n\n/**\n * Generate using custom API settings\n */\nasync function generateWithCustomSettings(\n    systemPrompt: string,\n    userPrompt: string,\n    jsonSchema: StructuredOutputSchema | null,\n    signal?: AbortSignal,\n): Promise<string> {\n    const { ChatCompletionService, substituteParams } = SillyTavern.getContext();\n    const settings = getSettings();\n    const config = settings.generationConfig;\n\n    // Run ST's macro substitution on system prompt\n    const processedSystemPrompt = substituteParams(systemPrompt);\n\n    const requestOptions: Record<string, unknown> = {\n        stream: true,\n        messages: [\n            { role: 'system', content: processedSystemPrompt },\n            { role: 'user', content: userPrompt },\n        ],\n        chat_completion_source: config.source,\n        model: config.model,\n        temperature: config.temperature,\n        max_tokens: config.maxTokens,\n        frequency_penalty: config.frequencyPenalty,\n        presence_penalty: config.presencePenalty,\n        top_p: config.topP,\n    };\n\n    if (jsonSchema) {\n        requestOptions.json_schema = jsonSchema;\n    }\n\n    debugLog('request', 'ChatCompletionService request', {\n        source: config.source,\n        model: config.model,\n        stream: true,\n        hasSchema: !!jsonSchema,\n    });\n\n    if (signal?.aborted) {\n        throw new DOMException('Aborted', 'AbortError');\n    }\n\n    const result = await ChatCompletionService.sendRequest(requestOptions);\n\n    debugLog('response', 'ChatCompletionService result type', {\n        type: typeof result,\n        isFunction: typeof result === 'function',\n        isGenerator: result && typeof result === 'object' && Symbol.asyncIterator in result,\n    });\n\n    let response: string;\n\n    // When stream: true, result is a generator function - consume it\n    if (typeof result === 'function') {\n        response = await consumeStreamGenerator(result, signal);\n    } else if (result && typeof result === 'object') {\n        const resultObj = result as Record<string, unknown>;\n\n        if (resultObj.error) {\n            logError('API returned error', result);\n            throw new Error(`API error: ${JSON.stringify(result)}`);\n        }\n\n        response = ensureString(resultObj.content || result);\n    } else {\n        response = ensureString(result);\n    }\n\n    debugLog('response', 'Final response', {\n        length: response.length,\n        preview: response.substring(0, 200),\n    });\n\n    return response;\n}\n\n/**\n * Consume a streaming generator and return the final accumulated text\n */\nasync function consumeStreamGenerator(\n    generatorFn: () => AsyncGenerator<unknown>,\n    signal?: AbortSignal,\n): Promise<string> {\n    let finalText = '';\n\n    try {\n        const generator = generatorFn();\n\n        for await (const chunk of generator) {\n            // Check abort during streaming\n            if (signal?.aborted) {\n                debugLog('info', 'Stream aborted', { textSoFar: finalText.length });\n                throw new DOMException('Aborted', 'AbortError');\n            }\n\n            const chunkObj = chunk as Record<string, unknown>;\n\n            if (typeof chunkObj.text === 'string') {\n                finalText = chunkObj.text;\n            }\n\n            if (chunkObj.error) {\n                throw new Error(ensureString(chunkObj.error));\n            }\n        }\n    } catch (err) {\n        if ((err as Error).name === 'AbortError') {\n            throw err;\n        }\n\n        logError('Stream consumption error', {\n            error: err,\n            textSoFar: finalText.length,\n        });\n\n        // Return partial response if we have one\n        if (finalText) {\n            debugLog('info', 'Returning partial response after stream error', {\n                length: finalText.length,\n            });\n            return finalText;\n        }\n\n        throw err;\n    }\n\n    debugLog('info', 'Stream consumed', { finalLength: finalText.length });\n    return finalText;\n}\n\n// ============================================================================\n// TOKEN ESTIMATION\n// ============================================================================\n\n/**\n * Get accurate token count for a stage\n */\nexport async function getStageTokenCount(\n    state: PipelineState,\n    stage: StageName,\n): Promise<{ promptTokens: number; contextSize: number; percentage: number } | null> {\n    const { getTokenCountAsync, maxContext } = SillyTavern.getContext();\n    const settings = getSettings();\n\n    if (!state.character) return null;\n\n    try {\n        const prompt = buildStagePrompt(state, stage);\n        if (!prompt) return null;\n\n        const fullPrompt = settings.systemPrompt + '\\n\\n' + prompt;\n        const promptTokens = await getTokenCountAsync(fullPrompt);\n        const percentage = Math.round((promptTokens / maxContext) * 100);\n\n        return {\n            promptTokens,\n            contextSize: maxContext,\n            percentage,\n        };\n    } catch (e) {\n        logError('Token count failed', e);\n        return null;\n    }\n}\n\n/**\n * Get token count for refinement prompt\n */\nexport async function getRefinementTokenCount(\n    state: PipelineState,\n): Promise<{ promptTokens: number; contextSize: number; percentage: number } | null> {\n    const { getTokenCountAsync, maxContext } = SillyTavern.getContext();\n    const settings = getSettings();\n\n    if (!state.character || !state.results.rewrite || !state.results.analyze) return null;\n\n    try {\n        const prompt = buildRefinementPrompt(state);\n        if (!prompt) return null;\n\n        const fullPrompt = settings.systemPrompt + '\\n\\n' + prompt;\n        const promptTokens = await getTokenCountAsync(fullPrompt);\n        const percentage = Math.round((promptTokens / maxContext) * 100);\n\n        return {\n            promptTokens,\n            contextSize: maxContext,\n            percentage,\n        };\n    } catch (e) {\n        logError('Refinement token count failed', e);\n        return null;\n    }\n}\n\n// ============================================================================\n// UTILITIES\n// ============================================================================\n\n/**\n * Safely convert response to string\n */\nfunction ensureString(value: unknown): string {\n    if (typeof value === 'string') return value;\n    if (value === null || value === undefined) return '';\n    if (typeof value === 'object') {\n        try {\n            return JSON.stringify(value);\n        } catch {\n            return String(value);\n        }\n    }\n    return String(value);\n}\n\n/**\n * Replace {{char}} and {{user}} placeholders with actual names.\n * This is needed because we're not in a chat context where ST auto-substitutes.\n */\nfunction substituteCharacterPlaceholders(\n    text: string,\n    charName: string,\n    userName: string,\n): string {\n    return text\n        .replace(/\\{\\{char\\}\\}/gi, charName)\n        .replace(/\\{\\{user\\}\\}/gi, userName);\n}\n","// src/ui/components/character-select.ts\n//\n// Character search and preview component\n\nimport { MODULE_NAME } from '../../constants';\nimport { getPopulatedFields } from '../../pipeline';\nimport type { Character, PopulatedField } from '../../types';\n\n// ============================================================================\n// TOKEN CACHE\n// ============================================================================\n\nconst tokenCache = new Map<string, number>();\n\nfunction getTokenCacheKey(content: string): string {\n    // Simple hash for cache key\n    let hash = 0;\n    for (let i = 0; i < content.length; i++) {\n        const char = content.charCodeAt(i);\n        hash = ((hash << 5) - hash) + char;\n        hash = hash & hash;\n    }\n    return `${hash}_${content.length}`;\n}\n\n// ============================================================================\n// RENDER\n// ============================================================================\n\n/**\n * Render the character select component\n */\nexport function renderCharacterSelect(\n    characters: Character[],\n    selectedIndex: number | null,\n): string {\n    const selectedChar = selectedIndex !== null ? characters[selectedIndex] : null;\n\n    return `\n    <div class=\"${MODULE_NAME}_char_select\">\n      <!-- Search -->\n      <div class=\"${MODULE_NAME}_search_wrapper ${selectedChar ? 'hidden' : ''}\">\n        <div class=\"${MODULE_NAME}_search_container\">\n          <i class=\"fa-solid fa-search ${MODULE_NAME}_search_icon\"></i>\n          <input\n            type=\"text\"\n            id=\"${MODULE_NAME}_char_search\"\n            class=\"text_pole ${MODULE_NAME}_search_input\"\n            placeholder=\"Search characters...\"\n            autocomplete=\"off\"\n          >\n        </div>\n        <div id=\"${MODULE_NAME}_char_dropdown\" class=\"${MODULE_NAME}_dropdown hidden\"></div>\n      </div>\n\n      <!-- Selected Character Preview -->\n      ${selectedChar ? renderCharacterPreview(selectedChar) : ''}\n    </div>\n  `;\n}\n\n/**\n * Render character preview with expandable fields\n */\nfunction renderCharacterPreview(char: Character): string {\n    const { getThumbnailUrl } = SillyTavern.getContext();\n    const fields = getPopulatedFields(char);\n\n    const avatar = getThumbnailUrl('avatar', char.avatar);\n\n    return `\n    <div class=\"${MODULE_NAME}_char_preview\" id=\"${MODULE_NAME}_char_preview\">\n      <div class=\"${MODULE_NAME}_char_header\">\n        <img\n          class=\"${MODULE_NAME}_char_avatar\"\n          src=\"${avatar}\"\n          alt=\"\"\n          onerror=\"this.src='/img/ai4.png'\"\n        >\n        <div class=\"${MODULE_NAME}_char_info\">\n          <div class=\"${MODULE_NAME}_char_name\">${escapeHtml(char.name)}</div>\n          <div class=\"${MODULE_NAME}_char_meta\">\n            ${fields.length} fields  <span id=\"${MODULE_NAME}_total_tokens\">counting...</span>\n          </div>\n        </div>\n        <button id=\"${MODULE_NAME}_char_clear\" class=\"${MODULE_NAME}_icon_btn\" title=\"Clear selection\">\n          <i class=\"fa-solid fa-xmark\"></i>\n        </button>\n      </div>\n\n      <div class=\"${MODULE_NAME}_char_fields\">\n        ${fields.map(f => renderFieldRow(f)).join('')}\n      </div>\n    </div>\n  `;\n}\n\n/**\n * Render a single field row with expand/collapse\n */\nfunction renderFieldRow(field: PopulatedField): string {\n    return `\n    <div class=\"${MODULE_NAME}_field_row\">\n      <div class=\"${MODULE_NAME}_field_header ${MODULE_NAME}_field_toggle\" data-field=\"${field.key}\">\n        <i class=\"fa-solid fa-chevron-right\"></i>\n        <span class=\"${MODULE_NAME}_field_label\">${field.label}</span>\n        <span class=\"${MODULE_NAME}_field_tokens\" data-field=\"${field.key}\">...</span>\n      </div>\n      <div class=\"${MODULE_NAME}_field_content hidden\" id=\"${MODULE_NAME}_field_content_${field.key}\">\n        <div class=\"${MODULE_NAME}_field_text\">${escapeHtml(field.value)}</div>\n      </div>\n    </div>\n  `;\n}\n\n// ============================================================================\n// UPDATE\n// ============================================================================\n\n/**\n * Update character select state without full re-render\n */\nexport function updateCharacterSelectState(\n    container: HTMLElement,\n    character: Character | null,\n    _characterIndex: number | null,\n): void {\n    const searchWrapper = container.querySelector(`.${MODULE_NAME}_search_wrapper`);\n    const existingPreview = container.querySelector(`#${MODULE_NAME}_char_preview`);\n\n    if (character) {\n        searchWrapper?.classList.add('hidden');\n\n        if (!existingPreview) {\n            const previewHtml = renderCharacterPreview(character);\n            const searchEl = container.querySelector(`.${MODULE_NAME}_search_wrapper`);\n            if (searchEl) {\n                searchEl.insertAdjacentHTML('afterend', previewHtml);\n            }\n        }\n    } else {\n        searchWrapper?.classList.remove('hidden');\n        existingPreview?.remove();\n\n        const searchInput = container.querySelector(`#${MODULE_NAME}_char_search`) as HTMLInputElement;\n        if (searchInput) {\n            searchInput.value = '';\n        }\n    }\n}\n\n/**\n * Update token counts for character fields and total.\n * Uses parallel execution and caching for performance.\n */\nexport async function updateFieldTokenCounts(container: HTMLElement, fields: PopulatedField[]): Promise<void> {\n    const { getTokenCountAsync } = SillyTavern.getContext();\n\n    // Build array of promises for parallel execution\n    const tokenPromises = fields.map(async (field) => {\n        const cacheKey = getTokenCacheKey(field.value);\n\n        // Check cache first\n        if (tokenCache.has(cacheKey)) {\n            return { field, tokens: tokenCache.get(cacheKey)! };\n        }\n\n        try {\n            const tokens = await getTokenCountAsync(field.value);\n            tokenCache.set(cacheKey, tokens);\n            return { field, tokens };\n        } catch {\n            return { field, tokens: null };\n        }\n    });\n\n    // Execute all in parallel\n    const results = await Promise.all(tokenPromises);\n\n    // Update UI with results\n    let totalTokens = 0;\n\n    for (const { field, tokens } of results) {\n        const tokenSpan = container.querySelector(`.${MODULE_NAME}_field_tokens[data-field=\"${field.key}\"]`);\n        if (tokenSpan) {\n            if (tokens !== null) {\n                totalTokens += tokens;\n                tokenSpan.textContent = `${tokens.toLocaleString()}t`;\n            } else {\n                tokenSpan.textContent = '?';\n            }\n        }\n    }\n\n    // Update total\n    const totalSpan = container.querySelector(`#${MODULE_NAME}_total_tokens`);\n    if (totalSpan) {\n        totalSpan.textContent = `${totalTokens.toLocaleString()} tokens`;\n    }\n}\n\n/**\n * Render dropdown items - called from popup.ts\n */\nexport function renderDropdownItems(\n    results: Array<{ char: Character; index: number }>,\n    dropdown: HTMLElement,\n    selectedIndex: number,\n): void {\n    const { getThumbnailUrl } = SillyTavern.getContext();\n\n    if (results.length === 0) {\n        dropdown.innerHTML = `<div class=\"${MODULE_NAME}_dropdown_empty\">No characters found</div>`;\n        return;\n    }\n\n    dropdown.innerHTML = results.map(({ char, index }, i) => {\n        const avatar = getThumbnailUrl('avatar', char.avatar);\n        const isSelected = i === selectedIndex;\n        const descPreview = (char.description || 'No description').substring(0, 80);\n\n        return `\n      <div class=\"${MODULE_NAME}_dropdown_item ${isSelected ? 'selected' : ''}\" data-index=\"${index}\">\n        <img class=\"${MODULE_NAME}_dropdown_avatar\" src=\"${avatar}\" alt=\"\" onerror=\"this.src='/img/ai4.png'\">\n        <div class=\"${MODULE_NAME}_dropdown_info\">\n          <span class=\"${MODULE_NAME}_dropdown_name\">${escapeHtml(char.name)}</span>\n          <span class=\"${MODULE_NAME}_dropdown_desc\">${escapeHtml(descPreview)}${descPreview.length >= 80 ? '...' : ''}</span>\n        </div>\n      </div>\n    `;\n    }).join('');\n\n    // Scroll selected item into view\n    if (selectedIndex >= 0) {\n        const selectedItem = dropdown.querySelector(`.${MODULE_NAME}_dropdown_item.selected`);\n        selectedItem?.scrollIntoView({ block: 'nearest' });\n    }\n}\n\n// ============================================================================\n// UTILITIES\n// ============================================================================\n\nfunction escapeHtml(value: unknown): string {\n    const { DOMPurify } = SillyTavern.libs;\n    const str = typeof value === 'string' ? value : String(value ?? '');\n    return DOMPurify.sanitize(str, { ALLOWED_TAGS: [] });\n}\n","// src/character.ts\n//\n// Character utilities - field extraction, formatting, etc.\n\nimport { CHARACTER_FIELDS } from './constants';\nimport type { Character, PopulatedField } from './types';\n\n// ============================================================================\n// FIELD EXTRACTION\n// ============================================================================\n\n/**\n * Get all populated fields from a character\n */\nexport function getPopulatedFields(char: Character): PopulatedField[] {\n    return CHARACTER_FIELDS\n        .filter(field => {\n            const val = char[field.key];\n            return val && typeof val === 'string' && val.trim().length > 0;\n        })\n        .map(field => {\n            const value = (char[field.key] as string).trim();\n            return {\n                key: field.key,\n                label: field.label,\n                value,\n                charCount: value.length,\n                scoreable: field.scoreable,\n            };\n        });\n}\n\n/**\n * Get total character count across all fields\n */\nexport function getTotalCharCount(char: Character): number {\n    return getPopulatedFields(char).reduce((sum, f) => sum + f.charCount, 0);\n}\n\n/**\n * Get count of populated fields\n */\nexport function getPopulatedFieldCount(char: Character): number {\n    return getPopulatedFields(char).length;\n}\n\n// ============================================================================\n// FORMATTING\n// ============================================================================\n\n/**\n * Build a formatted character summary for prompts\n */\nexport function buildCharacterSummary(char: Character): string {\n    const fields = getPopulatedFields(char);\n    const sections = fields.map(f => `### ${f.label}\\n${f.value}`);\n    return `# CHARACTER: ${char.name}\\n\\n${sections.join('\\n\\n')}`;\n}\n\n/**\n * Build a compact character summary (for display)\n */\nexport function buildCompactSummary(char: Character): string {\n    const fields = getPopulatedFields(char);\n    return `${char.name} - ${fields.length} fields, ${getTotalCharCount(char).toLocaleString()} chars`;\n}\n\n/**\n * Get a preview of a field value (truncated)\n */\nexport function getFieldPreview(value: string, maxLength: number = 100): string {\n    if (value.length <= maxLength) {\n        return value;\n    }\n    return value.substring(0, maxLength - 3) + '...';\n}\n\n// ============================================================================\n// VALIDATION\n// ============================================================================\n\n/**\n * Check if a character has enough content to analyze\n */\nexport function hasAnalyzableContent(char: Character): boolean {\n    const fields = getPopulatedFields(char);\n    return fields.length > 0;\n}\n\n/**\n * Get validation issues with a character\n */\nexport function validateCharacter(char: Character): string[] {\n    const issues: string[] = [];\n\n    if (!char.name?.trim()) {\n        issues.push('Character has no name');\n    }\n\n    const fields = getPopulatedFields(char);\n    if (fields.length === 0) {\n        issues.push('Character has no populated fields');\n    }\n\n    // Check for very short fields\n    for (const field of fields) {\n        if (field.charCount < 20 && field.scoreable) {\n            issues.push(`${field.label} is very short (${field.charCount} chars)`);\n        }\n    }\n\n    return issues;\n}\n\n// ============================================================================\n// SEARCH\n// ============================================================================\n\n/**\n * Prepare character data for fuzzy search\n */\nexport function prepareForSearch(chars: Character[]): Array<{ char: Character; index: number; searchText: string }> {\n    return chars\n        .map((char, index) => ({\n            char,\n            index,\n            searchText: [\n                char.name,\n                char.description?.substring(0, 200),\n                char.personality?.substring(0, 100),\n            ].filter(Boolean).join(' ').toLowerCase(),\n        }))\n        .filter(item => item.char?.name);\n}\n","// src/ui/components/pipeline-nav.ts\n//\n// Pipeline stage selection and navigation component\n\nimport { MODULE_NAME, STAGES, STAGE_LABELS, STAGE_ICONS } from '../../constants';\nimport type { StageName, StageStatus } from '../../types';\n\n// ============================================================================\n// RENDER\n// ============================================================================\n\n/**\n * Render the pipeline navigation component\n */\nexport function renderPipelineNav(\n    selectedStages: StageName[],\n    stageStatus: Record<StageName, StageStatus>,\n    activeStage: StageName,\n    hasCharacter: boolean,\n): string {\n    return `\n    <div class=\"${MODULE_NAME}_pipeline_nav\">\n      <!-- Stage Selection -->\n      <div class=\"${MODULE_NAME}_stage_row\">\n        ${STAGES.map((stage, i) => renderStageNode(\n        stage,\n        selectedStages.includes(stage),\n        stageStatus[stage],\n        stage === activeStage,\n        i < STAGES.length - 1,\n    )).join('')}\n      </div>\n\n      <!-- Action Buttons -->\n      <div class=\"${MODULE_NAME}_pipeline_actions\">\n        <button\n          id=\"${MODULE_NAME}_run_selected_btn\"\n          class=\"menu_button\"\n          ${!hasCharacter ? 'disabled' : ''}\n        >\n          <i class=\"fa-solid fa-play\"></i>\n          <span>Run Selected</span>\n        </button>\n        <button\n          id=\"${MODULE_NAME}_run_all_btn\"\n          class=\"menu_button\"\n          ${!hasCharacter ? 'disabled' : ''}\n        >\n          <i class=\"fa-solid fa-forward\"></i>\n          <span>Run All</span>\n        </button>\n        <button\n          id=\"${MODULE_NAME}_reset_pipeline_btn\"\n          class=\"menu_button\"\n        >\n          <i class=\"fa-solid fa-rotate-left\"></i>\n          <span>Reset</span>\n        </button>\n      </div>\n    </div>\n  `;\n}\n\n/**\n * Render a single stage node\n */\nfunction renderStageNode(\n    stage: StageName,\n    isSelected: boolean,\n    status: StageStatus,\n    isActive: boolean,\n    hasConnector: boolean,\n): string {\n    const statusIcon = getStatusIcon(status);\n\n    return `\n    <div class=\"${MODULE_NAME}_stage_node ${isActive ? 'active' : ''} ${MODULE_NAME}_stage_${status}\">\n      <input\n        type=\"checkbox\"\n        class=\"${MODULE_NAME}_stage_checkbox\"\n        id=\"${MODULE_NAME}_stage_cb_${stage}\"\n        data-stage=\"${stage}\"\n        ${isSelected ? 'checked' : ''}\n      >\n      <button\n        class=\"${MODULE_NAME}_stage_btn ${isActive ? 'active' : ''}\"\n        data-stage=\"${stage}\"\n        title=\"${STAGE_LABELS[stage]}\"\n      >\n        <i class=\"fa-solid ${STAGE_ICONS[stage]}\"></i>\n        <span>${STAGE_LABELS[stage]}</span>\n        ${statusIcon ? `<i class=\"fa-solid ${statusIcon} ${MODULE_NAME}_status_icon\"></i>` : ''}\n      </button>\n      ${hasConnector ? `<div class=\"${MODULE_NAME}_stage_connector ${isSelected ? 'active' : ''}\"></div>` : ''}\n    </div>\n  `;\n}\n\nfunction getStatusIcon(status: StageStatus): string | null {\n    switch (status) {\n        case 'complete': return 'fa-check';\n        case 'running': return 'fa-spinner fa-spin';\n        case 'skipped': return 'fa-forward';\n        default: return null;\n    }\n}\n\n// ============================================================================\n// UPDATE\n// ============================================================================\n\n/**\n * Update pipeline nav state without full re-render\n */\nexport function updatePipelineNavState(\n    container: HTMLElement,\n    selectedStages: StageName[],\n    stageStatus: Record<StageName, StageStatus>,\n    activeStage: StageName,\n    hasCharacter: boolean,\n    isGenerating: boolean,\n): void {\n    // Update checkboxes and buttons\n    for (const stage of STAGES) {\n        const checkbox = container.querySelector(`#${MODULE_NAME}_stage_cb_${stage}`) as HTMLInputElement;\n        const btn = container.querySelector(`.${MODULE_NAME}_stage_btn[data-stage=\"${stage}\"]`);\n        const node = container.querySelector(`.${MODULE_NAME}_stage_node:has([data-stage=\"${stage}\"])`);\n\n        if (checkbox) {\n            checkbox.checked = selectedStages.includes(stage);\n        }\n\n        if (btn) {\n            btn.classList.toggle('active', stage === activeStage);\n        }\n\n        if (node) {\n            node.classList.toggle('active', stage === activeStage);\n\n            // Update status classes\n            for (const s of ['pending', 'running', 'complete', 'skipped']) {\n                node.classList.toggle(`${MODULE_NAME}_stage_${s}`, stageStatus[stage] === s);\n            }\n        }\n\n        // Update connector\n        const connector = node?.querySelector(`.${MODULE_NAME}_stage_connector`);\n        connector?.classList.toggle('active', selectedStages.includes(stage));\n    }\n\n    // Update action buttons\n    const runSelectedBtn = container.querySelector(`#${MODULE_NAME}_run_selected_btn`) as HTMLButtonElement;\n    const runAllBtn = container.querySelector(`#${MODULE_NAME}_run_all_btn`) as HTMLButtonElement;\n    const resetBtn = container.querySelector(`#${MODULE_NAME}_reset_pipeline_btn`) as HTMLButtonElement;\n\n    if (runSelectedBtn) runSelectedBtn.disabled = !hasCharacter || isGenerating;\n    if (runAllBtn) runAllBtn.disabled = !hasCharacter || isGenerating;\n    if (resetBtn) resetBtn.disabled = isGenerating;\n}\n","// src/ui/components/stage-config.ts\n//\n// Stage configuration component - prompt/schema selection and editing\n\nimport { MODULE_NAME, STAGE_LABELS } from '../../constants';\nimport { getPromptPresets, getSchemaPresets, getPromptPreset, getSchemaPreset, savePromptPreset, saveSchemaPreset } from '../../settings';\nimport { validateSchema, autoFixSchema, generateSchemaFromDescription } from '../../schema';\nimport type { StageName, StageConfig, PromptPreset, SchemaPreset } from '../../types';\n\n// ============================================================================\n// RENDER\n// ============================================================================\n\nexport function renderStageConfig(\n    stage: StageName,\n    config: StageConfig,\n    tokenEstimate: { tokens: number; percentage: number } | null,\n): string {\n    const promptPresets = getPromptPresets(stage);\n    const schemaPresets = getSchemaPresets(stage);\n\n    // Get current prompt content\n    let promptContent = config.customPrompt;\n    if (config.promptPresetId) {\n        const preset = getPromptPreset(config.promptPresetId);\n        if (preset) promptContent = preset.prompt;\n    }\n\n    // Get current schema content\n    let schemaContent = config.customSchema;\n    if (config.schemaPresetId) {\n        const preset = getSchemaPreset(config.schemaPresetId);\n        if (preset) schemaContent = JSON.stringify(preset.schema, null, 2);\n    }\n\n    // Validate schema if present\n    let schemaStatus = '';\n    let schemaValidation: { valid: boolean; error?: string; warnings?: string[] } = { valid: true };\n    if (config.useStructuredOutput && schemaContent.trim()) {\n        schemaValidation = validateSchema(schemaContent);\n        if (!schemaValidation.valid) {\n            schemaStatus = `<div class=\"${MODULE_NAME}_schema_status error\"><i class=\"fa-solid fa-circle-xmark\"></i> ${escapeHtml(schemaValidation.error || 'Invalid schema')}</div>`;\n        } else if (schemaValidation.warnings?.length) {\n            schemaStatus = `<div class=\"${MODULE_NAME}_schema_status warning\"><i class=\"fa-solid fa-triangle-exclamation\"></i> ${schemaValidation.warnings.length} warning(s)</div>`;\n        } else {\n            schemaStatus = `<div class=\"${MODULE_NAME}_schema_status success\"><i class=\"fa-solid fa-circle-check\"></i> Valid schema</div>`;\n        }\n    }\n\n    // Token estimate display\n    let tokenDisplay = '<i class=\"fa-solid fa-microchip\"></i> Select a character';\n    let tokenClass = '';\n    if (tokenEstimate) {\n        tokenDisplay = `<i class=\"fa-solid fa-microchip\"></i> ~${tokenEstimate.tokens.toLocaleString()} tokens (${tokenEstimate.percentage}%)`;\n        if (tokenEstimate.percentage > 80) tokenClass = 'danger';\n        else if (tokenEstimate.percentage > 50) tokenClass = 'warning';\n    }\n\n    // Check if current content differs from selected preset (for save button state)\n    const promptDiffersFromPreset = config.promptPresetId\n        ? getPromptPreset(config.promptPresetId)?.prompt !== promptContent\n        : promptContent.trim().length > 0;\n\n    const schemaDiffersFromPreset = config.schemaPresetId\n        ? JSON.stringify(getSchemaPreset(config.schemaPresetId)?.schema, null, 2) !== schemaContent\n        : schemaContent.trim().length > 0;\n\n    // Show fix button if schema has warnings or is invalid but parseable\n    const showFixButton = config.useStructuredOutput && schemaContent.trim() &&\n        (schemaValidation.warnings?.length || !schemaValidation.valid);\n\n    return `\n    <div class=\"${MODULE_NAME}_stage_config\">\n      <!-- Prompt Section -->\n      <div class=\"${MODULE_NAME}_config_group\">\n        <div class=\"${MODULE_NAME}_config_header\">\n          <span class=\"${MODULE_NAME}_config_label\">Prompt</span>\n          <div class=\"${MODULE_NAME}_config_header_actions\">\n            <button\n              id=\"${MODULE_NAME}_save_prompt_preset_btn\"\n              class=\"${MODULE_NAME}_icon_btn\"\n              title=\"Save as Preset\"\n              ${!promptDiffersFromPreset ? 'disabled' : ''}\n            >\n              <i class=\"fa-solid fa-floppy-disk\"></i>\n            </button>\n            <select id=\"${MODULE_NAME}_prompt_preset_select\" class=\"${MODULE_NAME}_preset_select\">\n              <option value=\"\">Custom</option>\n              ${renderPresetOptions(promptPresets, config.promptPresetId)}\n            </select>\n          </div>\n        </div>\n        <textarea\n          id=\"${MODULE_NAME}_custom_prompt\"\n          class=\"${MODULE_NAME}_prompt_textarea text_pole\"\n          placeholder=\"Enter your prompt for the ${STAGE_LABELS[stage]} stage...\"\n        >${escapeHtml(promptContent)}</textarea>\n        <div class=\"${MODULE_NAME}_config_footer\">\n          <span class=\"${MODULE_NAME}_char_count\">${promptContent.length.toLocaleString()} chars</span>\n        </div>\n      </div>\n\n      <!-- Structured Output Toggle -->\n      <div class=\"${MODULE_NAME}_config_group\">\n        <label class=\"${MODULE_NAME}_checkbox_label\">\n          <input\n            type=\"checkbox\"\n            id=\"${MODULE_NAME}_use_structured\"\n            ${config.useStructuredOutput ? 'checked' : ''}\n          >\n          <span>Use Structured Output (JSON Schema)</span>\n        </label>\n      </div>\n\n      <!-- Schema Section -->\n      <div class=\"${MODULE_NAME}_schema_section ${config.useStructuredOutput ? '' : 'hidden'}\">\n        <div class=\"${MODULE_NAME}_config_header\">\n          <span class=\"${MODULE_NAME}_config_label\">JSON Schema</span>\n          <div class=\"${MODULE_NAME}_config_header_actions\">\n            <button\n              id=\"${MODULE_NAME}_save_schema_preset_btn\"\n              class=\"${MODULE_NAME}_icon_btn\"\n              title=\"Save as Preset\"\n              ${!schemaDiffersFromPreset || !schemaContent.trim() ? 'disabled' : ''}\n            >\n              <i class=\"fa-solid fa-floppy-disk\"></i>\n            </button>\n            <select id=\"${MODULE_NAME}_schema_preset_select\" class=\"${MODULE_NAME}_preset_select\">\n              <option value=\"\">Custom</option>\n              ${renderPresetOptions(schemaPresets, config.schemaPresetId)}\n            </select>\n          </div>\n        </div>\n        <textarea\n          id=\"${MODULE_NAME}_custom_schema\"\n          class=\"${MODULE_NAME}_schema_textarea text_pole\"\n          placeholder='{\"name\": \"MySchema\", \"value\": {\"type\": \"object\", ...}}'\n        >${escapeHtml(schemaContent)}</textarea>\n        ${schemaStatus}\n\n        <!-- Schema Actions -->\n        <div class=\"${MODULE_NAME}_schema_actions\">\n          <button\n            id=\"${MODULE_NAME}_generate_schema_btn\"\n            class=\"menu_button menu_button_icon\"\n            title=\"Generate schema from description\"\n          >\n            <i class=\"fa-solid fa-wand-magic-sparkles\"></i>\n            <span>Generate</span>\n          </button>\n          <button\n            id=\"${MODULE_NAME}_validate_schema_btn\"\n            class=\"menu_button menu_button_icon\"\n            title=\"Validate schema\"\n            ${!schemaContent.trim() ? 'disabled' : ''}\n          >\n            <i class=\"fa-solid fa-check-double\"></i>\n            <span>Validate</span>\n          </button>\n          <button\n            id=\"${MODULE_NAME}_fix_schema_btn\"\n            class=\"menu_button menu_button_icon\"\n            title=\"Auto-fix schema (adds additionalProperties: false, etc.)\"\n            ${!showFixButton ? 'disabled' : ''}\n          >\n            <i class=\"fa-solid fa-wrench\"></i>\n            <span>Auto-Fix</span>\n          </button>\n          <button\n            id=\"${MODULE_NAME}_format_schema_btn\"\n            class=\"menu_button menu_button_icon\"\n            title=\"Format/prettify JSON\"\n            ${!schemaContent.trim() ? 'disabled' : ''}\n          >\n            <i class=\"fa-solid fa-align-left\"></i>\n            <span>Format</span>\n          </button>\n        </div>\n      </div>\n\n      <!-- Actions -->\n      <div class=\"${MODULE_NAME}_config_actions\">\n        <div id=\"${MODULE_NAME}_token_estimate\" class=\"${MODULE_NAME}_token_estimate ${tokenClass}\">\n          ${tokenDisplay}\n        </div>\n      </div>\n    </div>\n  `;\n}\n\n\n// ============================================================================\n// UPDATE STATE\n// ============================================================================\n\n/**\n * Handle schema generation from description\n */\nexport async function handleGenerateSchema(): Promise<string | null> {\n    const { Popup, POPUP_RESULT } = SillyTavern.getContext();\n\n    const description = await Popup.show.input(\n        'Generate Schema',\n        'Describe the structure you want (e.g., <q>\"scores for each field 1-10, list of suggestions, overall rating\"</q>):\\n',\n        '',\n    );\n\n    if (description === null || description === POPUP_RESULT.CANCELLED || !description.trim()) {\n        return null;\n    }\n\n    // Show loading overlay\n    showSchemaGenerationLoading(true);\n\n    try {\n        toastr.info('Generating schema...');\n\n        const result = await generateSchemaFromDescription(description);\n\n        if (result.success) {\n            toastr.success('Schema generated!');\n            return result.schema!;\n        } else {\n            toastr.error(result.error || 'Generation failed');\n            // Return the broken schema anyway so they can see/fix it\n            return result.schema || null;\n        }\n    } finally {\n        showSchemaGenerationLoading(false);\n    }\n}\n\n/**\n * Show/hide loading overlay for schema generation\n */\nfunction showSchemaGenerationLoading(show: boolean): void {\n    const existingOverlay = document.querySelector(`.${MODULE_NAME}_loading_overlay`);\n\n    if (show && !existingOverlay) {\n        const overlay = document.createElement('div');\n        overlay.className = `${MODULE_NAME}_loading_overlay`;\n        overlay.innerHTML = `\n            <div class=\"${MODULE_NAME}_loading_content\">\n                <i class=\"fa-solid fa-spinner fa-spin fa-2x\"></i>\n                <p>Generating schema...</p>\n            </div>\n        `;\n        document.body.appendChild(overlay);\n    } else if (!show && existingOverlay) {\n        existingOverlay.remove();\n    }\n}\n\nexport function updateStageConfigState(\n    container: HTMLElement,\n    stage: StageName,\n    config: StageConfig,\n    isGenerating: boolean,\n): void {\n    const promptPresets = getPromptPresets(stage);\n    const schemaPresets = getSchemaPresets(stage);\n\n    // Update prompt preset select\n    const promptSelect = container.querySelector(`#${MODULE_NAME}_prompt_preset_select`) as HTMLSelectElement;\n    if (promptSelect) {\n        promptSelect.innerHTML = `<option value=\"\">Custom</option>${renderPresetOptions(promptPresets, config.promptPresetId)}`;\n        promptSelect.value = config.promptPresetId || '';\n        promptSelect.disabled = isGenerating;\n    }\n\n    // Update prompt textarea\n    const promptTextarea = container.querySelector(`#${MODULE_NAME}_custom_prompt`) as HTMLTextAreaElement;\n    if (promptTextarea) {\n        let promptContent = config.customPrompt;\n        if (config.promptPresetId) {\n            const preset = getPromptPreset(config.promptPresetId);\n            if (preset) promptContent = preset.prompt;\n        }\n        // Only update if different to preserve cursor position\n        if (promptTextarea.value !== promptContent) {\n            promptTextarea.value = promptContent;\n        }\n        promptTextarea.disabled = isGenerating;\n\n        // Update char count\n        const charCount = container.querySelector(`.${MODULE_NAME}_char_count`);\n        if (charCount) {\n            charCount.textContent = `${promptContent.length.toLocaleString()} chars`;\n        }\n    }\n\n    // Update structured output toggle\n    const structuredToggle = container.querySelector(`#${MODULE_NAME}_use_structured`) as HTMLInputElement;\n    if (structuredToggle) {\n        structuredToggle.checked = config.useStructuredOutput;\n        structuredToggle.disabled = isGenerating;\n    }\n\n    // Update schema section visibility\n    const schemaSection = container.querySelector(`.${MODULE_NAME}_schema_section`);\n    if (schemaSection) {\n        schemaSection.classList.toggle('hidden', !config.useStructuredOutput);\n    }\n\n    // Update schema preset select\n    const schemaSelect = container.querySelector(`#${MODULE_NAME}_schema_preset_select`) as HTMLSelectElement;\n    if (schemaSelect) {\n        schemaSelect.innerHTML = `<option value=\"\">Custom</option>${renderPresetOptions(schemaPresets, config.schemaPresetId)}`;\n        schemaSelect.value = config.schemaPresetId || '';\n        schemaSelect.disabled = isGenerating;\n    }\n\n    // Update schema textarea\n    const schemaTextarea = container.querySelector(`#${MODULE_NAME}_custom_schema`) as HTMLTextAreaElement;\n    if (schemaTextarea) {\n        let schemaContent = config.customSchema;\n        if (config.schemaPresetId) {\n            const preset = getSchemaPreset(config.schemaPresetId);\n            if (preset) schemaContent = JSON.stringify(preset.schema, null, 2);\n        }\n        if (schemaTextarea.value !== schemaContent) {\n            schemaTextarea.value = schemaContent;\n        }\n        schemaTextarea.disabled = isGenerating;\n    }\n\n    // Update schema validation status\n    if (config.useStructuredOutput) {\n        updateSchemaValidation(container, schemaTextarea?.value || '');\n    }\n\n    // Update schema action buttons\n    updateSchemaActionButtons(container, schemaTextarea?.value || '');\n\n    // Update run button\n    const runBtn = container.querySelector(`#${MODULE_NAME}_run_stage_btn`) as HTMLButtonElement;\n    if (runBtn) {\n        runBtn.disabled = isGenerating;\n        if (isGenerating) {\n            runBtn.innerHTML = '<i class=\"fa-solid fa-spinner fa-spin\"></i> Running...';\n        } else {\n            runBtn.innerHTML = `<i class=\"fa-solid fa-play\"></i> Run ${STAGE_LABELS[stage]} <kbd>Ctrl+Enter</kbd>`;\n        }\n    }\n\n    // Update save preset buttons\n    updateSavePresetButtons(container, config);\n}\n\n// ============================================================================\n// SCHEMA ACTION BUTTONS\n// ============================================================================\n\nfunction updateSchemaActionButtons(container: HTMLElement, schemaContent: string): void {\n    const validateBtn = container.querySelector(`#${MODULE_NAME}_validate_schema_btn`) as HTMLButtonElement;\n    const fixBtn = container.querySelector(`#${MODULE_NAME}_fix_schema_btn`) as HTMLButtonElement;\n    const formatBtn = container.querySelector(`#${MODULE_NAME}_format_schema_btn`) as HTMLButtonElement;\n\n    const hasContent = schemaContent.trim().length > 0;\n\n    if (validateBtn) {\n        validateBtn.disabled = !hasContent;\n    }\n\n    if (formatBtn) {\n        formatBtn.disabled = !hasContent;\n    }\n\n    if (fixBtn && hasContent) {\n        const validation = validateSchema(schemaContent);\n        // Enable fix button if there are warnings or if it's invalid but might be fixable\n        const needsFix = (validation.warnings?.length ?? 0) > 0 || !validation.valid;\n        fixBtn.disabled = !needsFix;\n    } else if (fixBtn) {\n        fixBtn.disabled = true;\n    }\n}\n\n// ============================================================================\n// SCHEMA ACTION HANDLERS (called from popup.ts)\n// ============================================================================\n\nexport async function handleValidateSchema(schemaContent: string): Promise<void> {\n    if (!schemaContent.trim()) {\n        toastr.warning('No schema to validate');\n        return;\n    }\n\n    const validation = validateSchema(schemaContent);\n\n    if (!validation.valid) {\n        toastr.error(`Invalid: ${validation.error}`);\n        return;\n    }\n\n    // For warnings/info with more than 2 items, use Popup instead of toastr\n    const { Popup, POPUP_TYPE } = SillyTavern.getContext();\n\n    if (validation.warnings?.length) {\n        if (validation.warnings.length > 2) {\n            const content = `\n                <h3>Schema Valid with Warnings</h3>\n                <ul>\n                    ${validation.warnings.map(w => `<li>${w}</li>`).join('')}\n                </ul>\n            `;\n            await new Popup(content, POPUP_TYPE.TEXT, '', { wide: false }).show();\n        } else {\n            toastr.warning(`Valid with ${validation.warnings.length} warning(s):\\n${validation.warnings.join('\\n')}`);\n        }\n        return;\n    }\n\n    if (validation.info?.length) {\n        if (validation.info.length > 2) {\n            const content = `\n                <h3>Schema Valid</h3>\n                <ul>\n                    ${validation.info.map(i => `<li>${i}</li>`).join('')}\n                </ul>\n            `;\n            await new Popup(content, POPUP_TYPE.TEXT, '', { wide: false }).show();\n        } else {\n            toastr.success(`Valid!\\n${validation.info.join('\\n')}`);\n        }\n    } else {\n        toastr.success('Schema is valid!');\n    }\n}\n\nexport function handleFixSchema(schemaContent: string): string | null {\n    if (!schemaContent.trim()) {\n        toastr.warning('No schema to fix');\n        return null;\n    }\n\n    // First try to parse it\n    const validation = validateSchema(schemaContent);\n\n    if (!validation.schema) {\n        toastr.error('Cannot fix: schema is not valid JSON or missing required structure');\n        return null;\n    }\n\n    try {\n        const fixed = autoFixSchema(validation.schema);\n        const fixedJson = JSON.stringify(fixed, null, 2);\n\n        // Validate the fixed version\n        const revalidation = validateSchema(fixedJson);\n\n        if (!revalidation.valid) {\n            toastr.warning('Auto-fix applied but schema still has issues');\n        } else if (revalidation.warnings?.length) {\n            toastr.info(`Fixed! ${revalidation.warnings.length} warning(s) remain`);\n        } else {\n            toastr.success('Schema fixed successfully!');\n        }\n\n        return fixedJson;\n    } catch (e) {\n        toastr.error(`Fix failed: ${(e as Error).message}`);\n        return null;\n    }\n}\n\nexport function handleFormatSchema(schemaContent: string): string | null {\n    if (!schemaContent.trim()) {\n        toastr.warning('No schema to format');\n        return null;\n    }\n\n    try {\n        const parsed = JSON.parse(schemaContent);\n        const formatted = JSON.stringify(parsed, null, 2);\n        toastr.success('Schema formatted');\n        return formatted;\n    } catch (e) {\n        toastr.error(`Cannot format: ${(e as Error).message}`);\n        return null;\n    }\n}\n\n// ============================================================================\n// SAVE PRESET BUTTONS\n// ============================================================================\n\nfunction updateSavePresetButtons(container: HTMLElement, config: StageConfig): void {\n    const promptTextarea = container.querySelector(`#${MODULE_NAME}_custom_prompt`) as HTMLTextAreaElement;\n    const schemaTextarea = container.querySelector(`#${MODULE_NAME}_custom_schema`) as HTMLTextAreaElement;\n\n    const savePromptBtn = container.querySelector(`#${MODULE_NAME}_save_prompt_preset_btn`) as HTMLButtonElement;\n    const saveSchemaBtn = container.querySelector(`#${MODULE_NAME}_save_schema_preset_btn`) as HTMLButtonElement;\n\n    if (savePromptBtn && promptTextarea) {\n        const currentPrompt = promptTextarea.value.trim();\n        const presetPrompt = config.promptPresetId\n            ? getPromptPreset(config.promptPresetId)?.prompt || ''\n            : '';\n\n        // Enable if there's content and it differs from the selected preset\n        const hasContent = currentPrompt.length > 0;\n        const isDifferent = currentPrompt !== presetPrompt;\n        savePromptBtn.disabled = !hasContent || (config.promptPresetId !== null && !isDifferent);\n    }\n\n    if (saveSchemaBtn && schemaTextarea) {\n        const currentSchema = schemaTextarea.value.trim();\n        const presetSchema = config.schemaPresetId\n            ? JSON.stringify(getSchemaPreset(config.schemaPresetId)?.schema, null, 2)\n            : '';\n\n        // Enable if there's valid content and it differs from the selected preset\n        const hasContent = currentSchema.length > 0;\n        const isDifferent = currentSchema !== presetSchema;\n        const isValid = hasContent ? validateSchema(currentSchema).valid : false;\n        saveSchemaBtn.disabled = !hasContent || !isValid || (config.schemaPresetId !== null && !isDifferent);\n    }\n}\n\n// ============================================================================\n// SAVE PRESET HANDLERS (called from popup.ts)\n// ============================================================================\n\nexport interface SavePresetResult {\n    success: boolean;\n    presetId?: string;\n}\n\nexport async function handleSavePromptPreset(stage: StageName, promptContent: string): Promise<SavePresetResult> {\n    const { Popup, POPUP_RESULT } = SillyTavern.getContext();\n\n    if (!promptContent.trim()) {\n        toastr.warning('No prompt content to save');\n        return { success: false };\n    }\n\n    const name = await Popup.show.input(\n        'Save Prompt Preset',\n        'Enter a name for this preset:',\n        `Custom ${STAGE_LABELS[stage]} Prompt`,\n    );\n\n    if (name === null || name === POPUP_RESULT.CANCELLED) {\n        return { success: false };\n    }\n\n    if (!name.trim()) {\n        toastr.warning('Preset name cannot be empty');\n        return { success: false };\n    }\n\n    try {\n        const newPreset = savePromptPreset({\n            name: name.trim(),\n            prompt: promptContent,\n            stages: [stage],\n        });\n        toastr.success(`Prompt preset \"${name}\" saved`);\n        return { success: true, presetId: newPreset.id };\n    } catch (e) {\n        toastr.error(`Failed to save preset: ${(e as Error).message}`);\n        return { success: false };\n    }\n}\n\nexport async function handleSaveSchemaPreset(stage: StageName, schemaContent: string): Promise<SavePresetResult> {\n    const { Popup, POPUP_RESULT } = SillyTavern.getContext();\n\n    if (!schemaContent.trim()) {\n        toastr.warning('No schema content to save');\n        return { success: false };\n    }\n\n    // Validate first\n    const validation = validateSchema(schemaContent);\n    if (!validation.valid) {\n        toastr.error(`Invalid schema: ${validation.error}`);\n        return { success: false };\n    }\n\n    const name = await Popup.show.input(\n        'Save Schema Preset',\n        'Enter a name for this preset:',\n        `Custom ${STAGE_LABELS[stage]} Schema`,\n    );\n\n    if (name === null || name === POPUP_RESULT.CANCELLED) {\n        return { success: false };\n    }\n\n    if (!name.trim()) {\n        toastr.warning('Preset name cannot be empty');\n        return { success: false };\n    }\n\n    try {\n        const newPreset = saveSchemaPreset({\n            name: name.trim(),\n            schema: validation.schema!,\n            stages: [stage],\n        });\n        toastr.success(`Schema preset \"${name}\" saved`);\n        return { success: true, presetId: newPreset.id };\n    } catch (e) {\n        toastr.error(`Failed to save preset: ${(e as Error).message}`);\n        return { success: false };\n    }\n}\n\n// ============================================================================\n// HELPERS\n// ============================================================================\n\nfunction renderPresetOptions(presets: (PromptPreset | SchemaPreset)[], selectedId: string | null): string {\n    return presets.map(p => {\n        const selected = p.id === selectedId ? 'selected' : '';\n        const icon = p.isBuiltin ? '' : '';\n        return `<option value=\"${p.id}\" ${selected}>${icon} ${escapeHtml(p.name)}</option>`;\n    }).join('');\n}\n\nfunction updateSchemaValidation(container: HTMLElement, schemaContent: string): void {\n    // Remove existing status\n    const existingStatus = container.querySelector(`.${MODULE_NAME}_schema_status`);\n    if (existingStatus) {\n        existingStatus.remove();\n    }\n\n    if (!schemaContent.trim()) {\n        return;\n    }\n\n    const validation = validateSchema(schemaContent);\n    let statusHtml = '';\n\n    if (!validation.valid) {\n        statusHtml = `<div class=\"${MODULE_NAME}_schema_status error\"><i class=\"fa-solid fa-circle-xmark\"></i> ${escapeHtml(validation.error || 'Invalid schema')}</div>`;\n    } else if (validation.warnings?.length) {\n        statusHtml = `<div class=\"${MODULE_NAME}_schema_status warning\"><i class=\"fa-solid fa-triangle-exclamation\"></i> ${validation.warnings.length} warning(s)</div>`;\n    } else {\n        statusHtml = `<div class=\"${MODULE_NAME}_schema_status success\"><i class=\"fa-solid fa-circle-check\"></i> Valid schema</div>`;\n    }\n\n    const schemaTextarea = container.querySelector(`#${MODULE_NAME}_custom_schema`);\n    if (schemaTextarea) {\n        schemaTextarea.insertAdjacentHTML('afterend', statusHtml);\n    }\n}\n\nfunction escapeHtml(text: string): string {\n    const { DOMPurify } = SillyTavern.libs;\n    return DOMPurify.sanitize(text, { ALLOWED_TAGS: [] });\n}\n","// src/ui/formatter.ts\n//\n// Response formatting for display\n\nimport type { StructuredOutputSchema, JsonSchemaValue } from '../types';\n\n// ============================================================================\n// MAIN ENTRY POINTS\n// ============================================================================\n\n/**\n * Format a plain text/markdown response\n */\nexport function formatResponse(response: string, moduleName: string): string {\n    const { showdown, DOMPurify } = SillyTavern.libs;\n    const text = typeof response === 'string' ? response : String(response ?? '');\n\n    const converter = new showdown.Converter({\n        tables: true,\n        strikethrough: true,\n        simpleLineBreaks: false,\n        headerLevelStart: 1,\n        ghCodeBlocks: true,\n        tasklists: true,\n        openLinksInNewWindow: true,\n        emoji: true,\n        parseImgDimensions: true,\n        simplifiedAutoLink: true,\n    });\n\n    const html = converter.makeHtml(text);\n    const wrapped = `<div class=\"${moduleName}_markdown_content\">${html}</div>`;\n\n    return DOMPurify.sanitize(wrapped);\n}\n\n/**\n * Format a structured JSON response\n */\nexport function formatStructuredResponse(\n    response: string,\n    schema: StructuredOutputSchema | null,\n    moduleName: string,\n): string {\n    const { DOMPurify } = SillyTavern.libs;\n    const text = typeof response === 'string' ? response : String(response ?? '');\n\n    const parsed = parseStructuredResponse(text);\n\n    if (!parsed || typeof parsed !== 'object') {\n        return formatResponse(text, moduleName);\n    }\n\n    const schemaValue = schema?.value ?? inferSchema(parsed);\n    const html = renderStructuredRoot(parsed as Record<string, unknown>, schemaValue, moduleName);\n\n    return DOMPurify.sanitize(html);\n}\n\n/**\n * Parse a structured response (handles JSON and code blocks)\n */\nexport function parseStructuredResponse(response: string): unknown | null {\n    try {\n        return JSON.parse(response);\n    } catch {\n        // Try to extract JSON from markdown code blocks\n        const codeBlockMatch = response.match(/```(?:json)?\\s*([\\s\\S]*?)```/);\n        if (codeBlockMatch) {\n            try {\n                return JSON.parse(codeBlockMatch[1].trim());\n            } catch {\n                return null;\n            }\n        }\n        return null;\n    }\n}\n\n// ============================================================================\n// SCHEMA INFERENCE\n// ============================================================================\n\nfunction inferSchema(data: unknown): JsonSchemaValue {\n    if (data === null) return { type: 'null' };\n    if (Array.isArray(data)) {\n        return {\n            type: 'array',\n            items: data.length > 0 ? inferSchema(data[0]) : { type: 'string' },\n        };\n    }\n    if (typeof data === 'object') {\n        const properties: Record<string, JsonSchemaValue> = {};\n        for (const [key, value] of Object.entries(data as Record<string, unknown>)) {\n            properties[key] = inferSchema(value);\n        }\n        return { type: 'object', properties };\n    }\n    return { type: typeof data as 'string' | 'number' | 'boolean' };\n}\n\n// ============================================================================\n// STRUCTURED RENDERING\n// ============================================================================\n\nconst MAX_DEPTH = 8;\n\nfunction renderStructuredRoot(\n    data: Record<string, unknown>,\n    schema: JsonSchemaValue,\n    moduleName: string,\n): string {\n    const heroKey = findHeroKey(data);\n    const heroValue = heroKey ? data[heroKey] : null;\n\n    const sections: string[] = [];\n\n    // Hero score at top\n    if (heroKey && typeof heroValue === 'number') {\n        sections.push(renderHero(heroKey, heroValue, moduleName));\n    }\n\n    // Render all fields\n    const properties = (schema.properties || {}) as Record<string, JsonSchemaValue>;\n    const keys = Object.keys(properties).length > 0 ? Object.keys(properties) : Object.keys(data);\n\n    for (const key of keys) {\n        if (key === heroKey) continue;\n        const value = data[key];\n        if (value === undefined) continue;\n\n        const propSchema = properties[key] || { type: inferType(value) };\n        sections.push(renderField(key, value, propSchema as JsonSchemaValue, moduleName, 0));\n    }\n\n    return `<div class=\"${moduleName}_structured_content\">${sections.join('')}</div>`;\n}\n\nfunction renderHero(key: string, value: number, moduleName: string): string {\n    const label = formatLabel(key);\n    const color = getScoreColor(value > 10 ? value / 10 : value);\n    const display = Number.isInteger(value) ? value : value.toFixed(1);\n    const max = value > 10 ? 100 : 10;\n\n    return `\n    <div class=\"${moduleName}_hero\">\n      <div class=\"${moduleName}_hero_label\">${escapeHtml(label)}</div>\n      <div class=\"${moduleName}_hero_value\" style=\"color: ${color}\">\n        ${display}<span class=\"${moduleName}_hero_max\">/${max}</span>\n      </div>\n    </div>\n  `;\n}\n\nfunction renderField(\n    key: string,\n    value: unknown,\n    schema: JsonSchemaValue,\n    moduleName: string,\n    depth: number,\n): string {\n    if (depth > MAX_DEPTH) {\n        return renderJson(value, moduleName);\n    }\n\n    const label = formatLabel(key);\n    const type = schema.type || inferType(value);\n\n    if (type === 'array' && Array.isArray(value)) {\n        return renderArrayField(label, value, schema, moduleName, depth);\n    }\n\n    if (type === 'object' && typeof value === 'object' && value !== null) {\n        return renderObjectField(label, value as Record<string, unknown>, schema, moduleName, depth);\n    }\n\n    const rendered = renderValue(value, schema, moduleName, key);\n\n    return `\n    <div class=\"${moduleName}_field\">\n      <div class=\"${moduleName}_field_label\">${escapeHtml(label)}</div>\n      <div class=\"${moduleName}_field_value\">${rendered}</div>\n    </div>\n  `;\n}\n\nfunction renderArrayField(\n    label: string,\n    items: unknown[],\n    schema: JsonSchemaValue,\n    moduleName: string,\n    depth: number,\n): string {\n    if (items.length === 0) {\n        return `\n      <div class=\"${moduleName}_field\">\n        <div class=\"${moduleName}_field_label\">${escapeHtml(label)}</div>\n        <div class=\"${moduleName}_field_value ${moduleName}_empty\">(none)</div>\n      </div>\n    `;\n    }\n\n    const itemSchema = (schema.items || { type: inferType(items[0]) }) as JsonSchemaValue;\n\n    // Simple values as list\n    if (items.every(isSimpleValue)) {\n        const listItems = items.map(item => `<li>${renderSimpleValue(item, moduleName)}</li>`).join('');\n        return `\n      <div class=\"${moduleName}_field\">\n        <div class=\"${moduleName}_field_label\">${escapeHtml(label)}</div>\n        <ol class=\"${moduleName}_list\">${listItems}</ol>\n      </div>\n    `;\n    }\n\n    // Complex values as cards\n    const cards = items.map((item, index) => {\n        if (typeof item === 'object' && item !== null) {\n            return renderCard(item as Record<string, unknown>, itemSchema, moduleName, depth + 1, index);\n        }\n        return `<div class=\"${moduleName}_card\">${renderValue(item, itemSchema, moduleName)}</div>`;\n    }).join('');\n\n    return `\n    <div class=\"${moduleName}_field\">\n      <div class=\"${moduleName}_field_label\">${escapeHtml(label)}</div>\n      <div class=\"${moduleName}_cards\">${cards}</div>\n    </div>\n  `;\n}\n\nfunction renderCard(\n    data: Record<string, unknown>,\n    schema: JsonSchemaValue,\n    moduleName: string,\n    depth: number,\n    _index: number,\n): string {\n    const properties = (schema.properties || {}) as Record<string, JsonSchemaValue>;\n    const keys = Object.keys(properties).length > 0 ? Object.keys(properties) : Object.keys(data);\n\n    // Find title, score, and body fields\n    const titleKey = keys.find(k => typeof data[k] === 'string' && (data[k] as string).length < 100);\n    const scoreKey = keys.find(k => typeof data[k] === 'number' && ((data[k] as number) >= 0 && (data[k] as number) <= 100));\n    const bodyKey = keys.find(k => typeof data[k] === 'string' && (data[k] as string).length >= 50 && k !== titleKey);\n\n    let header = '';\n    if (titleKey || scoreKey) {\n        const titlePart = titleKey\n            ? `<span class=\"${moduleName}_card_title\">${escapeHtml(String(data[titleKey]))}</span>`\n            : '';\n        const scorePart = scoreKey\n            ? renderScore(data[scoreKey] as number, moduleName)\n            : '';\n        header = `<div class=\"${moduleName}_card_header\">${titlePart}${scorePart}</div>`;\n    }\n\n    let body = '';\n    if (bodyKey) {\n        body = `<div class=\"${moduleName}_card_body\">${renderLongText(String(data[bodyKey]), moduleName)}</div>`;\n    }\n\n    const remainingKeys = keys.filter(k => k !== titleKey && k !== scoreKey && k !== bodyKey);\n    const remaining = remainingKeys.map(k => {\n        const v = data[k];\n        if (v === undefined) return '';\n        const propSchema = properties[k] || { type: inferType(v) };\n        return renderField(k, v, propSchema as JsonSchemaValue, moduleName, depth + 1);\n    }).filter(Boolean).join('');\n\n    const extra = remaining ? `<div class=\"${moduleName}_card_extra\">${remaining}</div>` : '';\n\n    return `<div class=\"${moduleName}_card\">${header}${body}${extra}</div>`;\n}\n\nfunction renderObjectField(\n    label: string,\n    data: Record<string, unknown>,\n    schema: JsonSchemaValue,\n    moduleName: string,\n    depth: number,\n): string {\n    const properties = (schema.properties || {}) as Record<string, JsonSchemaValue>;\n    const keys = Object.keys(properties).length > 0 ? Object.keys(properties) : Object.keys(data);\n\n    const fields = keys.map(k => {\n        const v = data[k];\n        if (v === undefined) return '';\n        const propSchema = properties[k] || { type: inferType(v) };\n        return renderField(k, v, propSchema as JsonSchemaValue, moduleName, depth + 1);\n    }).filter(Boolean).join('');\n\n    return `\n    <div class=\"${moduleName}_field\">\n      <div class=\"${moduleName}_field_label\">${escapeHtml(label)}</div>\n      <div class=\"${moduleName}_nested\">${fields}</div>\n    </div>\n  `;\n}\n\nfunction renderValue(\n    value: unknown,\n    schema: JsonSchemaValue,\n    moduleName: string,\n    fieldName?: string,\n): string {\n    if (value === null || value === undefined) {\n        return `<span class=\"${moduleName}_null\"></span>`;\n    }\n\n    const type = schema.type || inferType(value);\n\n    switch (type) {\n        case 'string':\n            return renderString(value as string, schema, moduleName);\n        case 'number':\n        case 'integer':\n            return renderNumber(value as number, schema, moduleName, fieldName);\n        case 'boolean':\n            return renderBoolean(value as boolean, moduleName);\n        default:\n            return `<span>${escapeHtml(String(value))}</span>`;\n    }\n}\n\nfunction renderString(data: string, schema: JsonSchemaValue, moduleName: string): string {\n    if (!data.trim()) {\n        return `<span class=\"${moduleName}_empty\">(empty)</span>`;\n    }\n\n    const format = schema.format as string | undefined;\n\n    if (format === 'uri' || format === 'url' || isUrl(data)) {\n        const display = data.length > 50 ? data.substring(0, 47) + '...' : data;\n        return `<a href=\"${escapeHtml(data)}\" target=\"_blank\" rel=\"noopener\" class=\"${moduleName}_link\">${escapeHtml(display)}</a>`;\n    }\n\n    if (format === 'email' || isEmail(data)) {\n        return `<a href=\"mailto:${escapeHtml(data)}\" class=\"${moduleName}_link\">${escapeHtml(data)}</a>`;\n    }\n\n    if (data.length > 100 || data.includes('\\n')) {\n        return renderLongText(data, moduleName);\n    }\n\n    return `<span>${escapeHtml(data)}</span>`;\n}\n\nfunction renderLongText(data: string, moduleName: string): string {\n    const formatted = formatResponse(data, moduleName);\n    return `<div class=\"${moduleName}_text\">${formatted}</div>`;\n}\n\nfunction renderNumber(\n    data: number,\n    schema: JsonSchemaValue,\n    moduleName: string,\n    fieldName?: string,\n): string {\n    const label = String(schema.title || schema.description || fieldName || '').toLowerCase();\n\n    if (looksLikeScore(label, data)) {\n        return renderScore(data, moduleName);\n    }\n\n    const formatted = data.toLocaleString(undefined, { maximumFractionDigits: 2 });\n    return `<span class=\"${moduleName}_num\">${formatted}</span>`;\n}\n\nfunction renderScore(data: number, moduleName: string): string {\n    const normalized = data > 10 ? data / 10 : data;\n    const color = getScoreColor(normalized);\n    const display = Number.isInteger(data) ? data : data.toFixed(1);\n    const max = data > 10 ? 100 : 10;\n\n    return `<span class=\"${moduleName}_score\" style=\"color: ${color}\">${display}<span class=\"${moduleName}_score_max\">/${max}</span></span>`;\n}\n\nfunction renderBoolean(data: boolean, moduleName: string): string {\n    const icon = data ? 'fa-check-circle' : 'fa-times-circle';\n    const cls = data ? `${moduleName}_yes` : `${moduleName}_no`;\n    return `<span class=\"${cls}\"><i class=\"fa-solid ${icon}\"></i> ${data ? 'Yes' : 'No'}</span>`;\n}\n\nfunction renderSimpleValue(data: unknown, moduleName: string): string {\n    if (typeof data === 'boolean') {\n        return renderBoolean(data, moduleName);\n    }\n    if (typeof data === 'number') {\n        return `<span class=\"${moduleName}_num\">${data.toLocaleString()}</span>`;\n    }\n    return escapeHtml(String(data));\n}\n\nfunction renderJson(data: unknown, moduleName: string): string {\n    const { hljs } = SillyTavern.libs;\n    const json = JSON.stringify(data, null, 2);\n    const highlighted = hljs.highlight(json, { language: 'json' }).value;\n    return `<pre class=\"${moduleName}_json\"><code class=\"hljs\">${highlighted}</code></pre>`;\n}\n\n// ============================================================================\n// HELPERS\n// ============================================================================\n\nfunction escapeHtml(value: unknown): string {\n    const { DOMPurify } = SillyTavern.libs;\n    const str = typeof value === 'string' ? value : String(value ?? '');\n    return DOMPurify.sanitize(str, { ALLOWED_TAGS: [] });\n}\n\nfunction inferType(value: unknown): string {\n    if (value === null) return 'null';\n    if (Array.isArray(value)) return 'array';\n    return typeof value;\n}\n\nfunction isSimpleValue(value: unknown): boolean {\n    return typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean' || value === null;\n}\n\nfunction formatLabel(key: string): string {\n    return key\n        .replace(/_/g, ' ')\n        .replace(/([a-z])([A-Z])/g, '$1 $2')\n        .replace(/\\b\\w/g, c => c.toUpperCase());\n}\n\nfunction findHeroKey(data: Record<string, unknown>): string | null {\n    const heroPatterns = ['overallscore', 'totalscore', 'overall', 'total', 'score', 'rating'];\n\n    for (const pattern of heroPatterns) {\n        for (const key of Object.keys(data)) {\n            if (key.toLowerCase().replace(/_/g, '') === pattern && typeof data[key] === 'number') {\n                return key;\n            }\n        }\n    }\n\n    return null;\n}\n\nfunction looksLikeScore(label: string, value: number): boolean {\n    const scoreWords = ['score', 'rating', 'rank', 'grade', 'level', 'confidence', 'quality'];\n    if (scoreWords.some(word => label.includes(word))) return true;\n    if (value >= 0 && value <= 10 && Number.isFinite(value)) return true;\n    if (value >= 0 && value <= 100 && Number.isInteger(value)) return true;\n    return false;\n}\n\nfunction getScoreColor(score: number): string {\n    if (score >= 8) return 'var(--success, #2ecc71)';\n    if (score >= 5) return 'var(--warning, #f39c12)';\n    return 'var(--failure, #e74c3c)';\n}\n\nfunction isUrl(str: string): boolean {\n    return /^https?:\\/\\//i.test(str);\n}\n\nfunction isEmail(str: string): boolean {\n    return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(str);\n}\n","// src/ui/components/results-panel.ts\n//\n// Results display and actions component\n\nimport { MODULE_NAME, STAGE_LABELS } from '../../constants';\nimport { formatResponse, formatStructuredResponse } from '../formatter';\nimport { canExport, canRefine, extractVerdict } from '../../pipeline';\nimport type { StageName, StageStatus, StageResult, PipelineState, IterationVerdict } from '../../types';\n\n// ============================================================================\n// RENDER\n// ============================================================================\n\n/**\n * Render the results panel\n */\nexport function renderResultsPanel(\n    stage: StageName,\n    result: StageResult | null,\n    status: StageStatus,\n    isGenerating: boolean,\n): string {\n    if (isGenerating && status === 'running') {\n        return renderLoading(stage);\n    }\n\n    if (!result) {\n        return renderPlaceholder(stage, status);\n    }\n\n    return renderResult(stage, result);\n}\n\nfunction renderLoading(stage: StageName): string {\n    return `\n    <div class=\"${MODULE_NAME}_results_loading\">\n      <i class=\"fa-solid fa-spinner fa-spin fa-2x\"></i>\n      <p>Running ${STAGE_LABELS[stage]}...</p>\n      <button id=\"${MODULE_NAME}_cancel_btn\" class=\"menu_button\">\n        <i class=\"fa-solid fa-stop\"></i>\n        <span>Cancel</span>\n      </button>\n    </div>\n  `;\n}\n\n/**\n * Render loading state for refinement\n */\nexport function renderRefinementLoading(iteration: number): string {\n    return `\n    <div class=\"${MODULE_NAME}_results_loading\">\n      <i class=\"fa-solid fa-spinner fa-spin fa-2x\"></i>\n      <p>Refining (Iteration #${iteration + 1})...</p>\n      <button id=\"${MODULE_NAME}_cancel_btn\" class=\"menu_button\">\n        <i class=\"fa-solid fa-stop\"></i>\n        <span>Cancel</span>\n      </button>\n    </div>\n  `;\n}\n\nfunction renderPlaceholder(stage: StageName, status: StageStatus): string {\n    let message = `Run ${STAGE_LABELS[stage]} to see results`;\n    let icon = 'fa-play';\n\n    if (status === 'skipped') {\n        message = `${STAGE_LABELS[stage]} was skipped`;\n        icon = 'fa-forward';\n    }\n\n    return `\n    <div class=\"${MODULE_NAME}_results_placeholder\">\n      <i class=\"fa-solid ${icon}\"></i>\n      <p>${message}</p>\n    </div>\n  `;\n}\n\nfunction renderResult(stage: StageName, result: StageResult): string {\n    const formattedContent = result.isStructured\n        ? formatStructuredResponse(result.response, null, MODULE_NAME)\n        : formatResponse(result.response, MODULE_NAME);\n\n    const timestamp = new Date(result.timestamp).toLocaleTimeString();\n\n    // Extract verdict if this is an analyze result\n    let verdictBadge = '';\n    if (stage === 'analyze') {\n        const verdict = extractVerdict(result.response);\n        verdictBadge = renderVerdictBadge(verdict);\n    }\n\n    return `\n    <div class=\"${MODULE_NAME}_results_content\">\n      <!-- Toolbar -->\n      <div class=\"${MODULE_NAME}_results_toolbar\">\n        <div class=\"${MODULE_NAME}_results_info\">\n          <span class=\"${MODULE_NAME}_badge\">${STAGE_LABELS[stage]}</span>\n          ${verdictBadge}\n          <span class=\"${MODULE_NAME}_results_time\">${timestamp}</span>\n          ${result.locked ? `<span class=\"${MODULE_NAME}_badge ${MODULE_NAME}_badge_locked\"><i class=\"fa-solid fa-lock\"></i> Locked</span>` : ''}\n        </div>\n        <div class=\"${MODULE_NAME}_results_actions\">\n          <!-- Always render BOTH buttons, use hidden class based on locked state -->\n          <button id=\"${MODULE_NAME}_lock_btn\" class=\"${MODULE_NAME}_icon_btn ${result.locked ? 'hidden' : ''}\" title=\"Lock result\">\n            <i class=\"fa-solid fa-lock\"></i>\n          </button>\n          <button id=\"${MODULE_NAME}_unlock_btn\" class=\"${MODULE_NAME}_icon_btn ${result.locked ? '' : 'hidden'}\" title=\"Unlock for editing\">\n            <i class=\"fa-solid fa-lock-open\"></i>\n          </button>\n          <button id=\"${MODULE_NAME}_copy_btn\" class=\"${MODULE_NAME}_icon_btn\" title=\"Copy to clipboard\">\n            <i class=\"fa-solid fa-copy\"></i>\n          </button>\n        </div>\n      </div>\n\n      <!-- Content -->\n      <div class=\"${MODULE_NAME}_results_body\">\n        ${formattedContent}\n      </div>\n\n      <!-- Footer Actions -->\n      <div class=\"${MODULE_NAME}_results_footer\" id=\"${MODULE_NAME}_results_footer\">\n        <!-- Populated by updateResultsPanelState -->\n      </div>\n    </div>\n  `;\n}\n\nfunction renderVerdictBadge(verdict: IterationVerdict): string {\n    const icons: Record<IterationVerdict, string> = {\n        accept: 'fa-check-circle',\n        needs_refinement: 'fa-wrench',\n        regression: 'fa-arrow-down',\n    };\n\n    const labels: Record<IterationVerdict, string> = {\n        accept: 'Accept',\n        needs_refinement: 'Needs Work',\n        regression: 'Regression',\n    };\n\n    return `\n    <span class=\"${MODULE_NAME}_badge ${MODULE_NAME}_verdict_badge ${MODULE_NAME}_verdict_${verdict}\">\n      <i class=\"fa-solid ${icons[verdict]}\"></i>\n      ${labels[verdict]}\n    </span>\n  `;\n}\n\n// ============================================================================\n// UPDATE\n// ============================================================================\n\n/**\n * Update results panel state\n */\nexport function updateResultsPanelState(\n    container: HTMLElement,\n    stage: StageName,\n    result: StageResult | null,\n    status: StageStatus,\n    isGenerating: boolean,\n    nextStage: StageName | null,\n    pipeline: PipelineState,\n): void {\n    const shouldShowLoading = isGenerating && status === 'running';\n    const shouldShowResult = result && !shouldShowLoading;\n    const shouldShowPlaceholder = !result && !shouldShowLoading;\n\n    // Always re-render if state type changes OR if showing placeholder (stage name might have changed)\n    if (shouldShowLoading) {\n        container.innerHTML = renderLoading(stage);\n        return;\n    }\n\n    if (shouldShowPlaceholder) {\n        container.innerHTML = renderPlaceholder(stage, status);\n        return;\n    }\n\n    if (shouldShowResult) {\n        // Only re-render result if we don't have content or timestamp changed\n        const existingContent = container.querySelector(`.${MODULE_NAME}_results_content`);\n        const existingTimestamp = container.querySelector(`.${MODULE_NAME}_results_time`)?.textContent;\n        const newTimestamp = new Date(result.timestamp).toLocaleTimeString();\n\n        if (!existingContent || existingTimestamp !== newTimestamp) {\n            container.innerHTML = renderResult(stage, result);\n        }\n    }\n\n    // Update footer actions\n    const footer = container.querySelector(`#${MODULE_NAME}_results_footer`);\n    if (footer && result) {\n        footer.innerHTML = renderFooterActions(stage, result, nextStage, pipeline);\n    }\n\n    // Update lock/unlock button visibility\n    const lockBtn = container.querySelector(`#${MODULE_NAME}_lock_btn`);\n    const unlockBtn = container.querySelector(`#${MODULE_NAME}_unlock_btn`);\n\n    if (lockBtn && unlockBtn) {\n        lockBtn.classList.toggle('hidden', !!result?.locked);\n        unlockBtn.classList.toggle('hidden', !result?.locked);\n    }\n}\n\nfunction renderFooterActions(\n    stage: StageName,\n    result: StageResult,\n    nextStage: StageName | null,\n    pipeline: PipelineState,\n): string {\n    const actions: string[] = [];\n\n    // Regenerate (if not locked)\n    if (!result.locked) {\n        actions.push(`\n      <button id=\"${MODULE_NAME}_regenerate_btn\" class=\"menu_button\">\n        <i class=\"fa-solid fa-rotate\"></i>\n        <span>Regenerate</span>\n      </button>\n    `);\n    }\n\n    // Stage-specific actions\n    if (stage === 'rewrite' && pipeline.character) {\n        // Apply to Character button - the primary action for rewrite stage\n        actions.push(`\n      <button id=\"${MODULE_NAME}_apply_btn\" class=\"menu_button ${MODULE_NAME}_apply_btn\">\n        <i class=\"fa-solid fa-check-double\"></i>\n        <span>Apply to Character</span>\n      </button>\n    `);\n    }\n\n    if (stage === 'analyze') {\n        const verdict = extractVerdict(result.response);\n        const canRefineResult = canRefine(pipeline);\n\n        // Refine button (if we can refine)\n        if (canRefineResult.canRun) {\n            const isRecommended = verdict === 'needs_refinement';\n            actions.push(`\n        <button id=\"${MODULE_NAME}_refine_btn\" class=\"menu_button ${isRecommended ? MODULE_NAME + '_refine_recommended' : ''}\">\n          <i class=\"fa-solid fa-arrows-rotate\"></i>\n          <span>Refine</span>\n          ${pipeline.iterationCount > 0 ? `<span class=\"${MODULE_NAME}_iteration_badge\">#${pipeline.iterationCount + 1}</span>` : ''}\n        </button>\n      `);\n        }\n\n        // Accept button (if we have a rewrite)\n        if (pipeline.results.rewrite && !pipeline.results.rewrite.locked) {\n            const isRecommended = verdict === 'accept';\n            actions.push(`\n        <button id=\"${MODULE_NAME}_accept_btn\" class=\"menu_button ${isRecommended ? MODULE_NAME + '_accept_recommended' : ''}\">\n          <i class=\"fa-solid fa-check\"></i>\n          <span>Accept Rewrite</span>\n        </button>\n      `);\n        }\n    }\n\n    // Continue to next stage (not on analyze - use refine/accept instead)\n    if (nextStage && stage !== 'analyze') {\n        actions.push(`\n      <button id=\"${MODULE_NAME}_continue_btn\" class=\"menu_button ${MODULE_NAME}_continue_btn\">\n        <i class=\"fa-solid fa-arrow-right\"></i>\n        <span>Continue to ${STAGE_LABELS[nextStage]}</span>\n      </button>\n    `);\n    }\n\n    // Export (if we have rewrite results)\n    if (canExport(pipeline)) {\n        actions.push(`\n      <button id=\"${MODULE_NAME}_export_btn\" class=\"menu_button\">\n        <i class=\"fa-solid fa-file-export\"></i>\n        <span>Export</span>\n      </button>\n    `);\n    }\n\n    return `<div class=\"${MODULE_NAME}_footer_actions\">${actions.join('')}</div>`;\n}\n","// src/ui/components/iteration-history.ts\n//\n// Iteration history display component\n\nimport { MODULE_NAME } from '../../constants';\nimport type { IterationSnapshot, IterationVerdict } from '../../types';\n\n// ============================================================================\n// RENDER\n// ============================================================================\n\n/**\n * Render the iteration history panel\n * @param history - Array of iteration snapshots\n * @param currentIteration - Current iteration number\n * @param historyLoaded - Whether history has been loaded from persistence\n */\nexport function renderIterationHistory(\n    history: IterationSnapshot[],\n    currentIteration: number,\n    historyLoaded: boolean,\n): string {\n    if (history.length === 0 && currentIteration === 0) {\n        return '';\n    }\n\n    // Show loading state while history is being loaded from localforage\n    const listContent = !historyLoaded\n        ? `<div class=\"${MODULE_NAME}_iteration_loading\">\n             <i class=\"fa-solid fa-spinner fa-spin\"></i>\n             <span>Loading history...</span>\n           </div>`\n        : history.length === 0\n            ? `<div class=\"${MODULE_NAME}_iteration_empty\">No previous iterations</div>`\n            : history.map((snap, i) => renderIterationItem(snap, i)).join('');\n\n    return `\n    <div class=\"${MODULE_NAME}_iteration_history\" id=\"${MODULE_NAME}_iteration_history\">\n      <div class=\"${MODULE_NAME}_iteration_header\">\n        <i class=\"fa-solid fa-clock-rotate-left\"></i>\n        <span>Iteration History</span>\n        <span class=\"${MODULE_NAME}_iteration_count\">${currentIteration > 0 ? `Current: #${currentIteration + 1}` : 'Initial'}</span>\n      </div>\n      <div class=\"${MODULE_NAME}_iteration_list\">\n        ${listContent}\n      </div>\n    </div>\n  `;\n}\n\nfunction renderIterationItem(snap: IterationSnapshot, index: number): string {\n    const verdictIcon = getVerdictIcon(snap.verdict);\n    const verdictClass = getVerdictClass(snap.verdict);\n    const time = new Date(snap.timestamp).toLocaleTimeString();\n\n    return `\n    <div class=\"${MODULE_NAME}_iteration_item ${verdictClass}\" data-index=\"${index}\">\n      <div class=\"${MODULE_NAME}_iteration_item_header\">\n        <span class=\"${MODULE_NAME}_iteration_num\">#${snap.iteration + 1}</span>\n        <span class=\"${MODULE_NAME}_iteration_verdict\">\n          <i class=\"fa-solid ${verdictIcon}\"></i>\n          ${formatVerdict(snap.verdict)}\n        </span>\n        <span class=\"${MODULE_NAME}_iteration_time\">${time}</span>\n      </div>\n      <div class=\"${MODULE_NAME}_iteration_preview\">\n        ${escapeHtml(snap.rewritePreview)}...\n      </div>\n      <div class=\"${MODULE_NAME}_iteration_actions\">\n        <button\n          class=\"${MODULE_NAME}_iteration_revert_btn menu_button\"\n          data-index=\"${index}\"\n          title=\"Revert to this version\"\n        >\n          <i class=\"fa-solid fa-rotate-left\"></i>\n          Revert\n        </button>\n        <button\n          class=\"${MODULE_NAME}_iteration_view_btn menu_button\"\n          data-index=\"${index}\"\n          title=\"View full content\"\n        >\n          <i class=\"fa-solid fa-eye\"></i>\n          View\n        </button>\n      </div>\n    </div>\n  `;\n}\n\nfunction getVerdictIcon(verdict: IterationVerdict): string {\n    switch (verdict) {\n        case 'accept': return 'fa-check-circle';\n        case 'needs_refinement': return 'fa-wrench';\n        case 'regression': return 'fa-arrow-down';\n        default: return 'fa-question-circle';\n    }\n}\n\nfunction getVerdictClass(verdict: IterationVerdict): string {\n    return `${MODULE_NAME}_verdict_${verdict}`;\n}\n\nfunction formatVerdict(verdict: IterationVerdict): string {\n    switch (verdict) {\n        case 'accept': return 'Accepted';\n        case 'needs_refinement': return 'Needs Work';\n        case 'regression': return 'Regression';\n        default: return 'Unknown';\n    }\n}\n\n// ============================================================================\n// UPDATE\n// ============================================================================\n\n/**\n * Update iteration history state\n */\nexport function updateIterationHistoryState(\n    container: HTMLElement,\n    history: IterationSnapshot[],\n    currentIteration: number,\n    historyLoaded: boolean,\n): void {\n    const historyEl = container.querySelector(`#${MODULE_NAME}_iteration_history`);\n\n    if (!historyEl && (history.length > 0 || currentIteration > 0)) {\n        // Need to add history panel\n        const html = renderIterationHistory(history, currentIteration, historyLoaded);\n        container.insertAdjacentHTML('beforeend', html);\n    } else if (historyEl) {\n        // Update existing\n        const countEl = historyEl.querySelector(`.${MODULE_NAME}_iteration_count`);\n        if (countEl) {\n            countEl.textContent = currentIteration > 0 ? `Current: #${currentIteration + 1}` : 'Initial';\n        }\n\n        const listEl = historyEl.querySelector(`.${MODULE_NAME}_iteration_list`);\n        if (listEl) {\n            if (!historyLoaded) {\n                listEl.innerHTML = `<div class=\"${MODULE_NAME}_iteration_loading\">\n                    <i class=\"fa-solid fa-spinner fa-spin\"></i>\n                    <span>Loading history...</span>\n                </div>`;\n            } else if (history.length === 0) {\n                listEl.innerHTML = `<div class=\"${MODULE_NAME}_iteration_empty\">No previous iterations</div>`;\n            } else {\n                listEl.innerHTML = history.map((snap, i) => renderIterationItem(snap, i)).join('');\n            }\n        }\n    }\n}\n\n/**\n * Render iteration view modal content\n */\nexport function renderIterationViewContent(snap: IterationSnapshot): string {\n    const { moment } = SillyTavern.libs;\n\n    return `\n    <div class=\"${MODULE_NAME}_iteration_view\">\n      <div class=\"${MODULE_NAME}_iteration_view_header\">\n        <h3>Iteration #${snap.iteration + 1}</h3>\n        <span class=\"${MODULE_NAME}_iteration_verdict ${getVerdictClass(snap.verdict)}\">\n          <i class=\"fa-solid ${getVerdictIcon(snap.verdict)}\"></i>\n          ${formatVerdict(snap.verdict)}\n        </span>\n        <span class=\"${MODULE_NAME}_iteration_time\">${moment(snap.timestamp).format('YYYY-MM-DD HH:mm:ss')}</span>\n      </div>\n\n      <div class=\"${MODULE_NAME}_iteration_view_section\">\n        <h4>Rewrite</h4>\n        <div class=\"${MODULE_NAME}_iteration_view_content\">\n          ${escapeHtml(snap.rewriteResponse)}\n        </div>\n      </div>\n\n      <div class=\"${MODULE_NAME}_iteration_view_section\">\n        <h4>Analysis</h4>\n        <div class=\"${MODULE_NAME}_iteration_view_content\">\n          ${escapeHtml(snap.analysisResponse)}\n        </div>\n      </div>\n    </div>\n  `;\n}\n\n// ============================================================================\n// UTILITIES\n// ============================================================================\n\nfunction escapeHtml(value: unknown): string {\n    const { DOMPurify } = SillyTavern.libs;\n    const str = typeof value === 'string' ? value : String(value ?? '');\n    return DOMPurify.sanitize(str, { ALLOWED_TAGS: [] });\n}\n","// src/ui/settings-modal.ts\n//\n// Settings modal popup\n\nimport { MODULE_NAME, DEFAULT_SYSTEM_PROMPT, DEFAULT_REFINEMENT_PROMPT } from '../constants';\nimport {\n    getSettings,\n    updateSetting,\n    updateGenerationConfig,\n    updateSystemPrompt,\n    resetSystemPrompt,\n    updateRefinementPrompt,\n    resetRefinementPrompt,\n    setDebugMode,\n    getPromptPresets,\n    getSchemaPresets,\n    deletePromptPreset,\n    deleteSchemaPreset,\n    exportCustomPresets,\n    importPresets,\n} from '../settings';\nimport { debugLog, getDebugLogs, clearDebugLogs, formatLogEntry, formatLogData, exportDebugInfo } from '../debug';\nimport type { GenerationConfig } from '../types';\n\n// ============================================================================\n// MAIN ENTRY\n// ============================================================================\n\n/**\n * Open the settings modal\n */\nexport async function openSettingsModal(onClose?: () => void): Promise<void> {\n    const { Popup, POPUP_TYPE } = SillyTavern.getContext();\n    const { DOMPurify } = SillyTavern.libs;\n\n    const content = buildSettingsContent();\n\n    const popup = new Popup(DOMPurify.sanitize(content), POPUP_TYPE.TEXT, '', {\n        wide: true,\n        large: true,\n        allowVerticalScrolling: true,\n        okButton: 'Save & Close',\n        cancelButton: false,\n    });\n\n    popup.show().then(() => {\n        onClose?.();\n        debugLog('info', 'Settings modal closed', null);\n    });\n\n    // Wait for DOM\n    await new Promise<void>(resolve => setTimeout(resolve, 0));\n\n    initSettingsListeners();\n    refreshModelSelects();\n\n    debugLog('info', 'Settings modal opened', null);\n}\n\n// ============================================================================\n// BUILD CONTENT\n// ============================================================================\n\nfunction buildSettingsContent(): string {\n    const settings = getSettings();\n    const config = settings.generationConfig;\n    const { moment } = SillyTavern.libs;\n\n    return `\n    <div class=\"${MODULE_NAME}_settings_modal\" id=\"${MODULE_NAME}_settings_modal\">\n      <div class=\"${MODULE_NAME}_settings_header\">\n        <i class=\"fa-solid fa-gear\"></i>\n        <span>Character Tools Settings</span>\n      </div>\n\n      <!-- Generation Settings -->\n      <div class=\"${MODULE_NAME}_settings_section\">\n        <div class=\"${MODULE_NAME}_settings_section_header\">\n          <i class=\"fa-solid fa-microchip\"></i>\n          <span>Generation</span>\n        </div>\n\n        <div class=\"${MODULE_NAME}_settings_row\">\n          <label class=\"${MODULE_NAME}_checkbox_label\">\n            <input\n              type=\"checkbox\"\n              id=\"${MODULE_NAME}_use_current_settings\"\n              ${settings.useCurrentSettings ? 'checked' : ''}\n            >\n            <span>Use Current SillyTavern Settings</span>\n          </label>\n        </div>\n\n        <div id=\"${MODULE_NAME}_custom_gen_config\" class=\"${settings.useCurrentSettings ? 'hidden' : ''}\">\n          <div class=\"${MODULE_NAME}_settings_grid\">\n            <div class=\"${MODULE_NAME}_settings_field\">\n              <label>Source</label>\n              <select id=\"${MODULE_NAME}_gen_source\" class=\"text_pole\"></select>\n            </div>\n            <div class=\"${MODULE_NAME}_settings_field\">\n              <label>Model</label>\n              <select id=\"${MODULE_NAME}_gen_model\" class=\"text_pole\"></select>\n            </div>\n          </div>\n\n          <div class=\"${MODULE_NAME}_settings_grid ${MODULE_NAME}_settings_grid_5\">\n            <div class=\"${MODULE_NAME}_settings_field\">\n              <label>Temp</label>\n              <input type=\"number\" id=\"${MODULE_NAME}_gen_temp\" class=\"text_pole\" value=\"${config.temperature}\" min=\"0\" max=\"2\" step=\"0.1\">\n            </div>\n            <div class=\"${MODULE_NAME}_settings_field\">\n              <label>Max Tokens</label>\n              <input type=\"number\" id=\"${MODULE_NAME}_gen_tokens\" class=\"text_pole\" value=\"${config.maxTokens}\" min=\"100\" max=\"32000\" step=\"100\">\n            </div>\n            <div class=\"${MODULE_NAME}_settings_field\">\n              <label>Freq Pen</label>\n              <input type=\"number\" id=\"${MODULE_NAME}_gen_freq\" class=\"text_pole\" value=\"${config.frequencyPenalty}\" min=\"-2\" max=\"2\" step=\"0.1\">\n            </div>\n            <div class=\"${MODULE_NAME}_settings_field\">\n              <label>Pres Pen</label>\n              <input type=\"number\" id=\"${MODULE_NAME}_gen_pres\" class=\"text_pole\" value=\"${config.presencePenalty}\" min=\"-2\" max=\"2\" step=\"0.1\">\n            </div>\n            <div class=\"${MODULE_NAME}_settings_field\">\n              <label>Top P</label>\n              <input type=\"number\" id=\"${MODULE_NAME}_gen_top_p\" class=\"text_pole\" value=\"${config.topP}\" min=\"0\" max=\"1\" step=\"0.05\">\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <!-- System Prompt -->\n      <div class=\"${MODULE_NAME}_settings_section\">\n        <div class=\"${MODULE_NAME}_settings_section_header\">\n          <i class=\"fa-solid fa-message\"></i>\n          <span>System Prompt</span>\n        </div>\n\n        <p class=\"${MODULE_NAME}_settings_hint\">Base instructions applied to all stages</p>\n\n        <textarea\n          id=\"${MODULE_NAME}_system_prompt\"\n          class=\"text_pole ${MODULE_NAME}_system_prompt_textarea\"\n          rows=\"6\"\n        >${escapeHtml(settings.systemPrompt)}</textarea>\n\n        <div class=\"${MODULE_NAME}_settings_row_spread\">\n          <span id=\"${MODULE_NAME}_system_prompt_chars\">${settings.systemPrompt.length.toLocaleString()} chars</span>\n          <button id=\"${MODULE_NAME}_reset_system_prompt\" class=\"menu_button\">\n            <i class=\"fa-solid fa-rotate-left\"></i>\n            Reset\n          </button>\n        </div>\n      </div>\n\n      <!-- Refinement Prompt -->\n      <div class=\"${MODULE_NAME}_settings_section\">\n        <div class=\"${MODULE_NAME}_settings_section_header\">\n          <i class=\"fa-solid fa-arrows-rotate\"></i>\n          <span>Refinement Prompt</span>\n        </div>\n\n        <p class=\"${MODULE_NAME}_settings_hint\">Template for iterative refinement. Placeholders: {{original_character}}, {{current_rewrite}}, {{current_analysis}}, {{score_results}}, {{iteration_number}}</p>\n\n        <textarea\n          id=\"${MODULE_NAME}_refinement_prompt\"\n          class=\"text_pole ${MODULE_NAME}_system_prompt_textarea\"\n          rows=\"8\"\n        >${escapeHtml(settings.refinementPrompt)}</textarea>\n\n        <div class=\"${MODULE_NAME}_settings_row_spread\">\n          <span id=\"${MODULE_NAME}_refinement_prompt_chars\">${settings.refinementPrompt.length.toLocaleString()} chars</span>\n          <button id=\"${MODULE_NAME}_reset_refinement_prompt\" class=\"menu_button\">\n            <i class=\"fa-solid fa-rotate-left\"></i>\n            Reset\n          </button>\n        </div>\n      </div>\n\n      <!-- Preset Management -->\n      <div class=\"${MODULE_NAME}_settings_section\">\n        <div class=\"${MODULE_NAME}_settings_section_header\">\n          <i class=\"fa-solid fa-bookmark\"></i>\n          <span>Presets</span>\n        </div>\n\n        <div class=\"${MODULE_NAME}_presets_grid\">\n          <div class=\"${MODULE_NAME}_preset_column\">\n            <h4>Prompt Presets</h4>\n            <div id=\"${MODULE_NAME}_prompt_presets_list\" class=\"${MODULE_NAME}_preset_list\">\n              ${renderPresetList('prompt')}\n            </div>\n          </div>\n          <div class=\"${MODULE_NAME}_preset_column\">\n            <h4>Schema Presets</h4>\n            <div id=\"${MODULE_NAME}_schema_presets_list\" class=\"${MODULE_NAME}_preset_list\">\n              ${renderPresetList('schema')}\n            </div>\n          </div>\n        </div>\n\n        <div class=\"${MODULE_NAME}_settings_row_spread\">\n          <button id=\"${MODULE_NAME}_export_presets\" class=\"menu_button\">\n            <i class=\"fa-solid fa-file-export\"></i>\n            Export Custom\n          </button>\n          <button id=\"${MODULE_NAME}_import_presets\" class=\"menu_button\">\n            <i class=\"fa-solid fa-file-import\"></i>\n            Import\n          </button>\n        </div>\n      </div>\n\n      <!-- Keyboard Shortcuts -->\n      <div class=\"${MODULE_NAME}_settings_section\">\n        <div class=\"${MODULE_NAME}_settings_section_header\">\n          <i class=\"fa-solid fa-keyboard\"></i>\n          <span>Keyboard Shortcuts</span>\n        </div>\n\n        <div class=\"${MODULE_NAME}_shortcuts_list\">\n          <div class=\"${MODULE_NAME}_shortcut_item\">\n            <kbd>Ctrl</kbd> + <kbd>Enter</kbd>\n            <span>Run current stage</span>\n          </div>\n          <div class=\"${MODULE_NAME}_shortcut_item\">\n            <kbd>Escape</kbd>\n            <span>Cancel generation</span>\n          </div>\n        </div>\n      </div>\n\n      <!-- Debug -->\n      <div class=\"${MODULE_NAME}_settings_section\">\n        <div class=\"${MODULE_NAME}_settings_section_header\">\n          <i class=\"fa-solid fa-bug\"></i>\n          <span>Debug</span>\n        </div>\n\n        <div class=\"${MODULE_NAME}_settings_row\">\n          <label class=\"${MODULE_NAME}_checkbox_label\">\n            <input\n              type=\"checkbox\"\n              id=\"${MODULE_NAME}_debug_mode\"\n              ${settings.debugMode ? 'checked' : ''}\n            >\n            <span>Enable Debug Logging</span>\n          </label>\n        </div>\n\n        <div class=\"${MODULE_NAME}_debug_actions\">\n          <button id=\"${MODULE_NAME}_view_logs\" class=\"menu_button\">\n            <i class=\"fa-solid fa-list\"></i>\n            View Logs\n          </button>\n          <button id=\"${MODULE_NAME}_clear_logs\" class=\"menu_button\">\n            <i class=\"fa-solid fa-trash\"></i>\n            Clear\n          </button>\n          <button id=\"${MODULE_NAME}_copy_debug_info\" class=\"menu_button\">\n            <i class=\"fa-solid fa-copy\"></i>\n            Copy Info\n          </button>\n        </div>\n\n        <div id=\"${MODULE_NAME}_debug_log_viewer\" class=\"${MODULE_NAME}_debug_log_viewer hidden\">\n          <div id=\"${MODULE_NAME}_debug_log_list\" class=\"${MODULE_NAME}_debug_log_list\"></div>\n          <pre id=\"${MODULE_NAME}_debug_log_detail\" class=\"${MODULE_NAME}_debug_log_detail\">Select a log entry</pre>\n        </div>\n      </div>\n\n      <!-- Footer -->\n      <div class=\"${MODULE_NAME}_settings_footer\">\n        <span class=\"${MODULE_NAME}_settings_version\">v1.0.0  Last updated: ${moment().format('YYYY-MM-DD HH:mm:ss')}</span>\n      </div>\n    </div>\n  `;\n}\n\nfunction renderPresetList(type: 'prompt' | 'schema'): string {\n    const presets = type === 'prompt' ? getPromptPresets() : getSchemaPresets();\n\n    if (presets.length === 0) {\n        return `<div class=\"${MODULE_NAME}_preset_empty\">No presets</div>`;\n    }\n\n    return presets.map(preset => `\n    <div class=\"${MODULE_NAME}_preset_item ${preset.isBuiltin ? 'builtin' : ''}\" data-id=\"${preset.id}\">\n      <span class=\"${MODULE_NAME}_preset_name\">\n        ${preset.isBuiltin ? '<i class=\"fa-solid fa-lock\"></i>' : ''}\n        ${escapeHtml(preset.name)}\n      </span>\n      ${!preset.isBuiltin ? `\n        <button class=\"${MODULE_NAME}_preset_delete\" data-type=\"${type}\" data-id=\"${preset.id}\" title=\"Delete\">\n          <i class=\"fa-solid fa-trash\"></i>\n        </button>\n      ` : ''}\n    </div>\n  `).join('');\n}\n\n// ============================================================================\n// EVENT LISTENERS\n// ============================================================================\n\nfunction initSettingsListeners(): void {\n    const modal = document.getElementById(`${MODULE_NAME}_settings_modal`);\n    if (!modal) return;\n\n    // Use current settings toggle\n    const useCurrentCheckbox = modal.querySelector(`#${MODULE_NAME}_use_current_settings`) as HTMLInputElement;\n    const customConfig = modal.querySelector(`#${MODULE_NAME}_custom_gen_config`);\n\n    useCurrentCheckbox?.addEventListener('change', () => {\n        updateSetting('useCurrentSettings', useCurrentCheckbox.checked);\n        customConfig?.classList.toggle('hidden', useCurrentCheckbox.checked);\n    });\n\n    // Generation config inputs\n    const genSource = modal.querySelector(`#${MODULE_NAME}_gen_source`) as HTMLSelectElement;\n    const genModel = modal.querySelector(`#${MODULE_NAME}_gen_model`) as HTMLSelectElement;\n    const genTemp = modal.querySelector(`#${MODULE_NAME}_gen_temp`) as HTMLInputElement;\n    const genTokens = modal.querySelector(`#${MODULE_NAME}_gen_tokens`) as HTMLInputElement;\n    const genFreq = modal.querySelector(`#${MODULE_NAME}_gen_freq`) as HTMLInputElement;\n    const genPres = modal.querySelector(`#${MODULE_NAME}_gen_pres`) as HTMLInputElement;\n    const genTopP = modal.querySelector(`#${MODULE_NAME}_gen_top_p`) as HTMLInputElement;\n\n    genSource?.addEventListener('change', () => {\n        updateGenerationConfig({ source: genSource.value });\n        populateModelSelect(genSource.value);\n    });\n\n    genModel?.addEventListener('change', () => {\n        updateGenerationConfig({ model: genModel.value });\n    });\n\n    const handleNumberInput = (input: HTMLInputElement, key: keyof GenerationConfig, isInt = false) => {\n        input?.addEventListener('change', () => {\n            const val = isInt ? parseInt(input.value, 10) : parseFloat(input.value);\n            if (!isNaN(val)) {\n                updateGenerationConfig({ [key]: val });\n            }\n        });\n    };\n\n    handleNumberInput(genTemp, 'temperature');\n    handleNumberInput(genTokens, 'maxTokens', true);\n    handleNumberInput(genFreq, 'frequencyPenalty');\n    handleNumberInput(genPres, 'presencePenalty');\n    handleNumberInput(genTopP, 'topP');\n\n    // System prompt\n    const systemPromptTextarea = modal.querySelector(`#${MODULE_NAME}_system_prompt`) as HTMLTextAreaElement;\n    const systemPromptChars = modal.querySelector(`#${MODULE_NAME}_system_prompt_chars`);\n    const resetSystemPromptBtn = modal.querySelector(`#${MODULE_NAME}_reset_system_prompt`);\n\n    systemPromptTextarea?.addEventListener('input', () => {\n        updateSystemPrompt(systemPromptTextarea.value);\n        if (systemPromptChars) {\n            systemPromptChars.textContent = `${systemPromptTextarea.value.length.toLocaleString()} chars`;\n        }\n    });\n\n    resetSystemPromptBtn?.addEventListener('click', () => {\n        resetSystemPrompt();\n        if (systemPromptTextarea) {\n            systemPromptTextarea.value = DEFAULT_SYSTEM_PROMPT;\n        }\n        if (systemPromptChars) {\n            systemPromptChars.textContent = `${DEFAULT_SYSTEM_PROMPT.length.toLocaleString()} chars`;\n        }\n        toastr.info('System prompt reset to default');\n    });\n\n    // Refinement prompt\n    const refinementPromptTextarea = modal.querySelector(`#${MODULE_NAME}_refinement_prompt`) as HTMLTextAreaElement;\n    const refinementPromptChars = modal.querySelector(`#${MODULE_NAME}_refinement_prompt_chars`);\n    const resetRefinementPromptBtn = modal.querySelector(`#${MODULE_NAME}_reset_refinement_prompt`);\n\n    refinementPromptTextarea?.addEventListener('input', () => {\n        updateRefinementPrompt(refinementPromptTextarea.value);\n        if (refinementPromptChars) {\n            refinementPromptChars.textContent = `${refinementPromptTextarea.value.length.toLocaleString()} chars`;\n        }\n    });\n\n    resetRefinementPromptBtn?.addEventListener('click', () => {\n        resetRefinementPrompt();\n        if (refinementPromptTextarea) {\n            refinementPromptTextarea.value = DEFAULT_REFINEMENT_PROMPT;\n        }\n        if (refinementPromptChars) {\n            refinementPromptChars.textContent = `${DEFAULT_REFINEMENT_PROMPT.length.toLocaleString()} chars`;\n        }\n        toastr.info('Refinement prompt reset to default');\n    });\n\n    // Preset management\n    modal.addEventListener('click', (e) => {\n        const deleteBtn = (e.target as HTMLElement).closest(`.${MODULE_NAME}_preset_delete`);\n        if (deleteBtn) {\n            const type = deleteBtn.getAttribute('data-type') as 'prompt' | 'schema';\n            const id = deleteBtn.getAttribute('data-id');\n            if (type && id) {\n                handleDeletePreset(type, id);\n            }\n        }\n    });\n\n    const exportPresetsBtn = modal.querySelector(`#${MODULE_NAME}_export_presets`);\n    const importPresetsBtn = modal.querySelector(`#${MODULE_NAME}_import_presets`);\n\n    exportPresetsBtn?.addEventListener('click', () => {\n        const json = exportCustomPresets();\n        navigator.clipboard.writeText(json);\n        toastr.success('Custom presets copied to clipboard');\n    });\n\n    importPresetsBtn?.addEventListener('click', async () => {\n        try {\n            const json = await navigator.clipboard.readText();\n            const result = importPresets(json);\n\n            if (result.errors.length > 0) {\n                toastr.error(result.errors.join('\\n'));\n            } else {\n                toastr.success(`Imported ${result.prompts} prompts, ${result.schemas} schemas`);\n                refreshPresetLists();\n            }\n        } catch {\n            toastr.error('Failed to read clipboard');\n        }\n    });\n\n    // Debug\n    const debugModeCheckbox = modal.querySelector(`#${MODULE_NAME}_debug_mode`) as HTMLInputElement;\n    const viewLogsBtn = modal.querySelector(`#${MODULE_NAME}_view_logs`);\n    const clearLogsBtn = modal.querySelector(`#${MODULE_NAME}_clear_logs`);\n    const copyDebugBtn = modal.querySelector(`#${MODULE_NAME}_copy_debug_info`);\n    const logViewer = modal.querySelector(`#${MODULE_NAME}_debug_log_viewer`);\n\n    debugModeCheckbox?.addEventListener('change', () => {\n        setDebugMode(debugModeCheckbox.checked);\n        toastr.info(`Debug mode ${debugModeCheckbox.checked ? 'enabled' : 'disabled'}`);\n    });\n\n    viewLogsBtn?.addEventListener('click', () => {\n        logViewer?.classList.toggle('hidden');\n        if (!logViewer?.classList.contains('hidden')) {\n            refreshDebugLogs();\n        }\n    });\n\n    clearLogsBtn?.addEventListener('click', () => {\n        clearDebugLogs();\n        refreshDebugLogs();\n        toastr.info('Debug logs cleared');\n    });\n\n    copyDebugBtn?.addEventListener('click', () => {\n        navigator.clipboard.writeText(exportDebugInfo());\n        toastr.success('Debug info copied to clipboard');\n    });\n}\n\nfunction handleDeletePreset(type: 'prompt' | 'schema', id: string): void {\n    const deletedId = type === 'prompt' ? deletePromptPreset(id) : deleteSchemaPreset(id);\n\n    if (deletedId) {\n        toastr.success('Preset deleted');\n        refreshPresetLists();\n    } else {\n        toastr.error('Cannot delete builtin preset');\n    }\n}\n\nfunction refreshPresetLists(): void {\n    const modal = document.getElementById(`${MODULE_NAME}_settings_modal`);\n    if (!modal) return;\n\n    const promptList = modal.querySelector(`#${MODULE_NAME}_prompt_presets_list`);\n    const schemaList = modal.querySelector(`#${MODULE_NAME}_schema_presets_list`);\n\n    if (promptList) {\n        promptList.innerHTML = renderPresetList('prompt');\n    }\n    if (schemaList) {\n        schemaList.innerHTML = renderPresetList('schema');\n    }\n}\n\nfunction refreshDebugLogs(): void {\n    const modal = document.getElementById(`${MODULE_NAME}_settings_modal`);\n    if (!modal) return;\n\n    const logList = modal.querySelector(`#${MODULE_NAME}_debug_log_list`);\n    const logDetail = modal.querySelector(`#${MODULE_NAME}_debug_log_detail`);\n\n    if (!logList || !logDetail) return;\n\n    const logs = getDebugLogs();\n\n    logList.innerHTML = logs.length\n        ? logs.map((entry, i) => `\n        <div class=\"${MODULE_NAME}_debug_log_entry\" data-index=\"${i}\">\n          ${formatLogEntry(entry)}\n        </div>\n      `).join('')\n        : `<div class=\"${MODULE_NAME}_debug_log_empty\">No logs</div>`;\n\n    // Click handler for log entries\n    logList.querySelectorAll(`.${MODULE_NAME}_debug_log_entry`).forEach(el => {\n        el.addEventListener('click', () => {\n            const index = parseInt((el as HTMLElement).dataset.index || '0', 10);\n            const entry = logs[index];\n            if (entry && logDetail) {\n                logDetail.textContent = formatLogData(entry.data);\n            }\n        });\n    });\n}\n\n// ============================================================================\n// MODEL SELECTS\n// ============================================================================\n\nfunction refreshModelSelects(): void {\n    const settings = getSettings();\n    populateSourceSelect(settings.generationConfig.source);\n    populateModelSelect(settings.generationConfig.source, settings.generationConfig.model);\n}\n\nfunction populateSourceSelect(currentSource: string): void {\n    const modal = document.getElementById(`${MODULE_NAME}_settings_modal`);\n    const sourceSelect = modal?.querySelector(`#${MODULE_NAME}_gen_source`) as HTMLSelectElement;\n    if (!sourceSelect) return;\n\n    sourceSelect.innerHTML = '';\n\n    const stSourceSelect = document.getElementById('chat_completion_source') as HTMLSelectElement;\n\n    if (stSourceSelect) {\n        Array.from(stSourceSelect.options).forEach((opt: HTMLOptionElement) => {\n            if (opt.value) {\n                const option = document.createElement('option');\n                option.value = opt.value;\n                option.textContent = opt.textContent || opt.value;\n                sourceSelect.appendChild(option);\n            }\n        });\n    }\n\n    if (sourceSelect.options.length === 0) {\n        ['openrouter', 'openai', 'claude', 'makersuite', 'mistralai', 'groq'].forEach(src => {\n            const option = document.createElement('option');\n            option.value = src;\n            option.textContent = src;\n            sourceSelect.appendChild(option);\n        });\n    }\n\n    sourceSelect.value = currentSource;\n}\n\nfunction populateModelSelect(source: string, currentModel?: string): void {\n    const modal = document.getElementById(`${MODULE_NAME}_settings_modal`);\n    const modelSelect = modal?.querySelector(`#${MODULE_NAME}_gen_model`) as HTMLSelectElement;\n    if (!modelSelect) return;\n\n    modelSelect.innerHTML = '';\n\n    const selectIdMap: Record<string, string> = {\n        openrouter: 'model_openrouter_select',\n        openai: 'model_openai_select',\n        claude: 'model_claude_select',\n        makersuite: 'model_google_select',\n        google: 'model_google_select',\n        mistralai: 'model_mistralai_select',\n        cohere: 'model_cohere_select',\n        perplexity: 'model_perplexity_select',\n        groq: 'model_groq_select',\n        ai21: 'model_ai21_select',\n        deepseek: 'model_deepseek_select',\n        custom: 'model_custom_select',\n    };\n\n    const stSelect = selectIdMap[source] ? document.getElementById(selectIdMap[source]) as HTMLSelectElement : null;\n\n    if (stSelect?.options.length) {\n        Array.from(stSelect.options).forEach((opt: HTMLOptionElement) => {\n            if (opt.value) {\n                const option = document.createElement('option');\n                option.value = opt.value;\n                option.textContent = opt.textContent || opt.value;\n                modelSelect.appendChild(option);\n            }\n        });\n    } else {\n        const option = document.createElement('option');\n        option.value = currentModel || '';\n        option.textContent = currentModel || `No models for ${source}`;\n        modelSelect.appendChild(option);\n    }\n\n    if (currentModel && Array.from(modelSelect.options).some(o => o.value === currentModel)) {\n        modelSelect.value = currentModel;\n    } else if (modelSelect.options.length) {\n        modelSelect.value = modelSelect.options[0].value;\n        updateGenerationConfig({ model: modelSelect.options[0].value });\n    }\n}\n\n// ============================================================================\n// UTILITIES\n// ============================================================================\n\nfunction escapeHtml(value: unknown): string {\n    const { DOMPurify } = SillyTavern.libs;\n    const str = typeof value === 'string' ? value : String(value ?? '');\n    return DOMPurify.sanitize(str, { ALLOWED_TAGS: [] });\n}\n","// src/persistence.ts\n//\n// Persistence layer for iteration history using localforage.\n// Stores iteration history per-character so users can resume work across sessions.\n\nimport { MODULE_NAME } from './constants';\nimport { debugLog, logError } from './debug';\nimport type { Character, IterationSnapshot } from './types';\n\n// ============================================================================\n// KEY GENERATION\n// ============================================================================\n\n/**\n * Generate a unique key for a character.\n * Uses avatar + name since avatar alone isn't unique.\n */\nexport function getCharacterKey(character: Character): string {\n    // Sanitize for storage key - remove special chars\n    const sanitizedName = character.name.replace(/[^a-zA-Z0-9_-]/g, '_');\n    const sanitizedAvatar = character.avatar.replace(/[^a-zA-Z0-9_-]/g, '_');\n    return `${MODULE_NAME}_history_${sanitizedAvatar}_${sanitizedName}`;\n}\n\n// ============================================================================\n// ITERATION HISTORY PERSISTENCE\n// ============================================================================\n\n/**\n * Save iteration history for a character\n */\nexport async function saveIterationHistory(\n    character: Character,\n    history: IterationSnapshot[],\n): Promise<boolean> {\n    const { localforage } = SillyTavern.libs;\n    const key = getCharacterKey(character);\n\n    try {\n        await localforage.setItem(key, {\n            characterName: character.name,\n            characterAvatar: character.avatar,\n            history,\n            savedAt: Date.now(),\n        });\n\n        debugLog('info', 'Iteration history saved', {\n            key,\n            characterName: character.name,\n            historyLength: history.length,\n        });\n\n        return true;\n    } catch (e) {\n        logError('Failed to save iteration history', { key, error: e });\n        return false;\n    }\n}\n\n/**\n * Load iteration history for a character\n */\nexport async function loadIterationHistory(\n    character: Character,\n): Promise<IterationSnapshot[] | null> {\n    const { localforage } = SillyTavern.libs;\n    const key = getCharacterKey(character);\n\n    try {\n        const data = await localforage.getItem(key) as {\n            characterName: string;\n            characterAvatar: string;\n            history: IterationSnapshot[];\n            savedAt: number;\n        } | null;\n\n        if (!data) {\n            debugLog('info', 'No iteration history found', { key });\n            return null;\n        }\n\n        // Verify it's for the same character (in case of key collision)\n        if (data.characterName !== character.name || data.characterAvatar !== character.avatar) {\n            debugLog('info', 'Iteration history key collision, ignoring', {\n                key,\n                storedName: data.characterName,\n                currentName: character.name,\n            });\n            return null;\n        }\n\n        debugLog('info', 'Iteration history loaded', {\n            key,\n            characterName: character.name,\n            historyLength: data.history.length,\n            savedAt: new Date(data.savedAt).toISOString(),\n        });\n\n        return data.history;\n    } catch (e) {\n        logError('Failed to load iteration history', { key, error: e });\n        return null;\n    }\n}\n\n/**\n * Clear iteration history for a character\n */\nexport async function clearIterationHistory(character: Character): Promise<boolean> {\n    const { localforage } = SillyTavern.libs;\n    const key = getCharacterKey(character);\n\n    try {\n        await localforage.removeItem(key);\n\n        debugLog('info', 'Iteration history cleared', {\n            key,\n            characterName: character.name,\n        });\n\n        return true;\n    } catch (e) {\n        logError('Failed to clear iteration history', { key, error: e });\n        return false;\n    }\n}\n\n/**\n * Get all stored iteration history keys (for debugging/cleanup)\n */\nexport async function getAllHistoryKeys(): Promise<string[]> {\n    const { localforage } = SillyTavern.libs;\n\n    try {\n        const allKeys = await localforage.keys();\n        return allKeys.filter((key: string) => key.startsWith(`${MODULE_NAME}_history_`));\n    } catch (e) {\n        logError('Failed to get history keys', { error: e });\n        return [];\n    }\n}\n\n/**\n * Clear all iteration history (for debugging/cleanup)\n */\nexport async function clearAllIterationHistory(): Promise<number> {\n    const keys = await getAllHistoryKeys();\n    const { localforage } = SillyTavern.libs;\n\n    let cleared = 0;\n    for (const key of keys) {\n        try {\n            await localforage.removeItem(key);\n            cleared++;\n        } catch (e) {\n            logError('Failed to clear history key', { key, error: e });\n        }\n    }\n\n    debugLog('info', 'All iteration history cleared', { cleared, total: keys.length });\n    return cleared;\n}\n","// src/ui/popup.ts\n//\n// Main popup controller - orchestrates all components and manages state.\n\nimport { MODULE_NAME, STAGES, STAGE_LABELS, STAGE_ICONS } from '../constants';\nimport { debugLog } from '../debug';\nimport {\n    createPipelineState,\n    resetPipeline,\n    setCharacter,\n    toggleStage,\n    updateStageConfig as pipelineUpdateStageConfig,\n    startStage,\n    completeStage,\n    failStage,\n    lockStageResult,\n    unlockStageResult,\n    clearStageResult,\n    getNextStage,\n    canRunStage,\n    canRefine,\n    validatePipeline,\n    validateRefinement,\n    setExportData,\n    buildStagePrompt,\n    getStageSchema,\n    startRefinement,\n    completeRefinement,\n    acceptRewrite,\n    revertToIteration,\n    parseRewriteResponse,\n    applyRewriteToCharacter,\n} from '../pipeline';\nimport { getPromptPreset, getSchemaPreset } from '../settings';\nimport { runStageGeneration, runRefinementGeneration, getStageTokenCount, getRefinementTokenCount, getApiInfo, isApiReady } from '../generator';\nimport { renderCharacterSelect, updateCharacterSelectState, renderDropdownItems, updateFieldTokenCounts } from './components/character-select';\nimport { getPopulatedFields } from '../character';\nimport { renderPipelineNav, updatePipelineNavState } from './components/pipeline-nav';\nimport {\n    renderStageConfig,\n    updateStageConfigState,\n    handleSavePromptPreset,\n    handleSaveSchemaPreset,\n    handleValidateSchema,\n    handleFixSchema,\n    handleFormatSchema,\n    handleGenerateSchema,\n} from './components/stage-config';\nimport { renderResultsPanel, updateResultsPanelState, renderRefinementLoading } from './components/results-panel';\nimport { renderIterationHistory, updateIterationHistoryState, renderIterationViewContent } from './components/iteration-history';\nimport { openSettingsModal } from './settings-modal';\nimport { saveIterationHistory, loadIterationHistory } from '../persistence';\nimport type { PipelineState, StageName, Character, IterationSnapshot } from '../types';\n\n// ============================================================================\n// STATE\n// ============================================================================\n\nlet popupState: {\n    pipeline: PipelineState;\n    isGenerating: boolean;\n    isRefining: boolean;\n    abortController: AbortController | null;\n    activeStageView: StageName;\n    historyLoaded: boolean;\n    // Store debounced functions for cleanup\n    debouncedFunctions: Array<{ cancel: () => void }>;\n} | null = null;\n\nlet popupElement: HTMLElement | null = null;\n\n// ============================================================================\n// EVENT MANAGEMENT\n// ============================================================================\n\nconst eventCleanup: Array<() => void> = [];\n\nfunction subscribeEvents(): void {\n    const { eventSource, eventTypes } = SillyTavern.getContext();\n\n    const handlers = {\n        onStatusChange: () => {\n            debugLog('info', 'API status changed', { isReady: isApiReady() });\n            updateApiStatus();\n        },\n\n        onMainApiChange: () => {\n            debugLog('info', 'Main API changed', null);\n            updateApiStatus();\n            updateTokenEstimate();\n        },\n\n        onCharEdited: (data: { detail?: { character: Character; id: string }; character?: Character; id?: number }) => {\n            // Handle both payload formats - CHARACTER_EDITED uses { detail: { character, id: string } }\n            const character = data.detail?.character ?? data.character;\n            const id = data.detail?.id !== undefined ? parseInt(data.detail.id, 10) : data.id;\n\n            debugLog('info', 'Character edited externally', { id, name: character?.name });\n            refreshSelectedCharacter(id as number);\n        },\n\n        onCharDeleted: (data: { id: number; character: Character }) => {\n            // CHARACTER_DELETED uses flat { id: number, character }\n            debugLog('info', 'Character deleted', { id: data.id });\n            handleCharacterDeleted(data.id);\n        },\n\n        onPresetChanged: () => {\n            debugLog('info', 'OAI preset changed', null);\n            if (popupState) {\n                updateTokenEstimate();\n            }\n        },\n\n        onSourceChanged: () => {\n            debugLog('info', 'Chat completion source changed', null);\n            updateApiStatus();\n            updateTokenEstimate();\n        },\n\n        onModelChanged: () => {\n            debugLog('info', 'Chat completion model changed', null);\n            updateApiStatus();\n            updateTokenEstimate();\n        },\n    };\n\n    eventSource.on(eventTypes.ONLINE_STATUS_CHANGED, handlers.onStatusChange);\n    eventSource.on(eventTypes.MAIN_API_CHANGED, handlers.onMainApiChange);\n    eventSource.on(eventTypes.CHARACTER_EDITED, handlers.onCharEdited);\n    eventSource.on(eventTypes.CHARACTER_DELETED, handlers.onCharDeleted);\n    eventSource.on(eventTypes.OAI_PRESET_CHANGED_AFTER, handlers.onPresetChanged);\n    eventSource.on(eventTypes.CHATCOMPLETION_SOURCE_CHANGED, handlers.onSourceChanged);\n    eventSource.on(eventTypes.CHATCOMPLETION_MODEL_CHANGED, handlers.onModelChanged);\n\n    eventCleanup.push(\n        () => eventSource.removeListener(eventTypes.ONLINE_STATUS_CHANGED, handlers.onStatusChange),\n        () => eventSource.removeListener(eventTypes.MAIN_API_CHANGED, handlers.onMainApiChange),\n        () => eventSource.removeListener(eventTypes.CHARACTER_EDITED, handlers.onCharEdited),\n        () => eventSource.removeListener(eventTypes.CHARACTER_DELETED, handlers.onCharDeleted),\n        () => eventSource.removeListener(eventTypes.OAI_PRESET_CHANGED_AFTER, handlers.onPresetChanged),\n        () => eventSource.removeListener(eventTypes.CHATCOMPLETION_SOURCE_CHANGED, handlers.onSourceChanged),\n        () => eventSource.removeListener(eventTypes.CHATCOMPLETION_MODEL_CHANGED, handlers.onModelChanged),\n    );\n\n    debugLog('info', 'Event listeners subscribed', { count: eventCleanup.length });\n}\n\nfunction unsubscribeEvents(): void {\n    eventCleanup.forEach(fn => fn());\n    eventCleanup.length = 0;\n    debugLog('info', 'Event listeners unsubscribed', null);\n}\n\n// ============================================================================\n// EVENT HANDLERS\n// ============================================================================\n\nfunction updateApiStatus(): void {\n    if (!popupElement) return;\n\n    const apiInfo = getApiInfo();\n    const statusEl = popupElement.querySelector(`.${MODULE_NAME}_api_status`);\n\n    if (statusEl) {\n        statusEl.className = `${MODULE_NAME}_api_status ${apiInfo.isReady ? 'connected' : 'disconnected'}`;\n        const textSpan = statusEl.querySelector('span');\n        if (textSpan) {\n            textSpan.textContent = apiInfo.source;\n        }\n    }\n\n    updatePipelineNav();\n}\n\nfunction refreshSelectedCharacter(editedId?: number): void {\n    if (!popupState || popupState.pipeline.characterIndex === null) return;\n\n    // Get fresh characters from context - don't use cached\n    const { characters } = SillyTavern.getContext();\n    const charList = characters as Character[];\n    const index = popupState.pipeline.characterIndex;\n\n    // If a specific character was edited and it's not ours, ignore\n    if (editedId !== undefined && editedId !== index) {\n        return;\n    }\n\n    if (index >= 0 && index < charList.length) {\n        const updatedChar = charList[index];\n\n        if (updatedChar.name === popupState.pipeline.character?.name) {\n            popupState.pipeline = {\n                ...popupState.pipeline,\n                character: updatedChar,\n            };\n            updateCharacterSelect();\n            updateTokenEstimate();\n            debugLog('info', 'Character refreshed', { name: updatedChar.name });\n        } else {\n            handleCharacterInvalidated();\n        }\n    } else {\n        handleCharacterInvalidated();\n    }\n}\n\nfunction handleCharacterDeleted(deletedId: number): void {\n    if (!popupState) return;\n\n    const currentIndex = popupState.pipeline.characterIndex;\n\n    if (currentIndex === null) return;\n\n    if (currentIndex === deletedId) {\n        handleCharacterInvalidated();\n        toastr.warning('Selected character was deleted');\n    } else if (currentIndex > deletedId) {\n        // Get fresh characters from context\n        const { characters } = SillyTavern.getContext();\n        const charList = characters as Character[];\n\n        const newIndex = currentIndex - 1;\n\n        if (newIndex >= 0 && newIndex < charList.length) {\n            popupState.pipeline = {\n                ...popupState.pipeline,\n                characterIndex: newIndex,\n                character: charList[newIndex],\n            };\n            debugLog('info', 'Character index adjusted after deletion', { oldIndex: currentIndex, newIndex });\n        } else {\n            handleCharacterInvalidated();\n        }\n    }\n}\n\nfunction handleCharacterInvalidated(): void {\n    if (!popupState) return;\n\n    debugLog('info', 'Character invalidated, clearing selection', null);\n\n    popupState.pipeline = setCharacter(popupState.pipeline, null, null);\n    popupState.historyLoaded = false;\n    updateAllComponents();\n    toastr.info('Character selection cleared');\n}\n\n// ============================================================================\n// GLOBAL LISTENERS\n// ============================================================================\n\nlet documentClickHandler: ((e: MouseEvent) => void) | null = null;\nlet keyboardHandler: ((e: KeyboardEvent) => void) | null = null;\n\nfunction initGlobalListeners(): void {\n    keyboardHandler = (e: KeyboardEvent) => {\n        if (!popupState) return;\n\n        // Ctrl+Enter to run current stage\n        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {\n            e.preventDefault();\n            if (!popupState.isGenerating && !popupState.isRefining) {\n                runSingleStage(popupState.activeStageView);\n            }\n        }\n\n        // Escape to cancel generation\n        if (e.key === 'Escape' && (popupState.isGenerating || popupState.isRefining) && popupState.abortController) {\n            popupState.abortController.abort();\n        }\n    };\n\n    document.addEventListener('keydown', keyboardHandler);\n}\n\nfunction removeGlobalListeners(): void {\n    if (keyboardHandler) {\n        document.removeEventListener('keydown', keyboardHandler);\n        keyboardHandler = null;\n    }\n    if (documentClickHandler) {\n        document.removeEventListener('click', documentClickHandler);\n        documentClickHandler = null;\n    }\n\n    // Cancel any pending debounced operations\n    if (popupState?.debouncedFunctions) {\n        popupState.debouncedFunctions.forEach(fn => fn.cancel());\n        popupState.debouncedFunctions = [];\n    }\n}\n\n// ============================================================================\n// MAIN ENTRY\n// ============================================================================\n\nexport async function openMainPopup(): Promise<void> {\n    const { Popup, POPUP_TYPE } = SillyTavern.getContext();\n    const { DOMPurify } = SillyTavern.libs;\n\n    popupState = {\n        pipeline: createPipelineState(),\n        isGenerating: false,\n        isRefining: false,\n        abortController: null,\n        activeStageView: 'score',\n        historyLoaded: false,\n        debouncedFunctions: [],\n    };\n\n    const content = buildPopupContent();\n\n    const popup = new Popup(DOMPurify.sanitize(content), POPUP_TYPE.TEXT, '', {\n        wide: true,\n        large: true,\n        allowVerticalScrolling: true,\n        okButton: false,\n        cancelButton: false,\n    });\n\n    popup.show().then(() => {\n        if (popupState?.abortController) {\n            popupState.abortController.abort();\n        }\n        popupState = null;\n        popupElement = null;\n        unsubscribeEvents();\n        removeGlobalListeners();\n        debugLog('info', 'Popup closed', null);\n    });\n\n    await new Promise<void>(resolve => setTimeout(resolve, 0));\n\n    popupElement = document.getElementById(`${MODULE_NAME}_popup`);\n\n    subscribeEvents();\n    initGlobalListeners();\n\n    // Get fresh characters from context\n    const { characters } = SillyTavern.getContext();\n    const charList = characters as Character[];\n\n    initComponents(charList);\n    updateAllComponents();\n\n    debugLog('info', 'Popup opened', { characterCount: charList.length });\n}\n\n// ============================================================================\n// POPUP HTML\n// ============================================================================\n\nfunction buildPopupContent(): string {\n    const apiInfo = getApiInfo();\n\n    return `\n    <div class=\"${MODULE_NAME}_popup\" id=\"${MODULE_NAME}_popup\">\n      <!-- Header -->\n      <div class=\"${MODULE_NAME}_popup_header\">\n        <div class=\"${MODULE_NAME}_popup_title\">\n          <i class=\"fa-solid fa-wand-magic-sparkles\"></i>\n          <span>Character Tools</span>\n        </div>\n        <div class=\"${MODULE_NAME}_popup_header_right\">\n          <div class=\"${MODULE_NAME}_api_status ${apiInfo.isReady ? 'connected' : 'disconnected'}\">\n            <i class=\"fa-solid fa-circle\"></i>\n            <span>${apiInfo.source}</span>\n          </div>\n          <button id=\"${MODULE_NAME}_settings_btn\" class=\"${MODULE_NAME}_icon_btn\" title=\"Settings\">\n            <i class=\"fa-solid fa-gear\"></i>\n          </button>\n          <button id=\"${MODULE_NAME}_close_btn\" class=\"${MODULE_NAME}_icon_btn\" title=\"Close\">\n            <i class=\"fa-solid fa-xmark\"></i>\n          </button>\n        </div>\n      </div>\n\n      <!-- Character Section -->\n      <div class=\"${MODULE_NAME}_section\" id=\"${MODULE_NAME}_character_section\">\n        <div class=\"${MODULE_NAME}_section_header\">\n          <i class=\"fa-solid fa-user\"></i>\n          <span>Character</span>\n        </div>\n        <div id=\"${MODULE_NAME}_character_select_container\"></div>\n      </div>\n\n      <!-- Pipeline Section -->\n      <div class=\"${MODULE_NAME}_section\" id=\"${MODULE_NAME}_pipeline_section\">\n        <div class=\"${MODULE_NAME}_section_header\">\n          <i class=\"fa-solid fa-diagram-project\"></i>\n          <span>Pipeline</span>\n        </div>\n        <div id=\"${MODULE_NAME}_pipeline_nav_container\"></div>\n      </div>\n\n      <!-- Stage Config Section -->\n      <div class=\"${MODULE_NAME}_section\" id=\"${MODULE_NAME}_stage_section\">\n        <div class=\"${MODULE_NAME}_section_header\">\n          <i class=\"fa-solid ${STAGE_ICONS.score}\" id=\"${MODULE_NAME}_stage_icon\"></i>\n          <span id=\"${MODULE_NAME}_stage_title\">Score</span>\n        </div>\n        <div id=\"${MODULE_NAME}_stage_config_container\"></div>\n      </div>\n\n      <!-- Results Section -->\n      <div class=\"${MODULE_NAME}_section ${MODULE_NAME}_section_grow\" id=\"${MODULE_NAME}_results_section\">\n        <div class=\"${MODULE_NAME}_section_header\">\n          <i class=\"fa-solid fa-file-lines\"></i>\n          <span>Results</span>\n          <span id=\"${MODULE_NAME}_iteration_indicator\" class=\"${MODULE_NAME}_iteration_indicator hidden\"></span>\n        </div>\n        <div id=\"${MODULE_NAME}_results_container\"></div>\n        <div id=\"${MODULE_NAME}_iteration_history_container\"></div>\n      </div>\n    </div>\n  `;\n}\n\n// ============================================================================\n// COMPONENT INITIALIZATION\n// ============================================================================\n\nfunction initComponents(characters: Character[]): void {\n    if (!popupState || !popupElement) return;\n\n    // Character select\n    const charContainer = popupElement.querySelector(`#${MODULE_NAME}_character_select_container`);\n    if (charContainer) {\n        charContainer.innerHTML = renderCharacterSelect(characters, popupState.pipeline.characterIndex);\n        initCharacterSelectListeners();\n    }\n\n    // Pipeline nav\n    const pipelineContainer = popupElement.querySelector(`#${MODULE_NAME}_pipeline_nav_container`);\n    if (pipelineContainer) {\n        pipelineContainer.innerHTML = renderPipelineNav(\n            popupState.pipeline.selectedStages,\n            popupState.pipeline.stageStatus,\n            popupState.activeStageView,\n            !!popupState.pipeline.character,\n        );\n        initPipelineNavListeners();\n    }\n\n    // Stage config\n    const stageContainer = popupElement.querySelector(`#${MODULE_NAME}_stage_config_container`);\n    if (stageContainer) {\n        stageContainer.innerHTML = renderStageConfig(\n            popupState.activeStageView,\n            popupState.pipeline.configs[popupState.activeStageView],\n            null,\n        );\n        initStageConfigListeners();\n    }\n\n    // Results panel\n    const resultsContainer = popupElement.querySelector(`#${MODULE_NAME}_results_container`);\n    if (resultsContainer) {\n        resultsContainer.innerHTML = renderResultsPanel(\n            popupState.activeStageView,\n            popupState.pipeline.results[popupState.activeStageView],\n            popupState.pipeline.stageStatus[popupState.activeStageView],\n            popupState.isGenerating,\n        );\n        initResultsPanelListeners();\n    }\n\n    // Iteration history\n    const historyContainer = popupElement.querySelector(`#${MODULE_NAME}_iteration_history_container`);\n    if (historyContainer) {\n        historyContainer.innerHTML = renderIterationHistory(\n            popupState.pipeline.iterationHistory,\n            popupState.pipeline.iterationCount,\n            popupState.historyLoaded,\n        );\n        initIterationHistoryListeners();\n    }\n\n    // Header buttons\n    popupElement.querySelector(`#${MODULE_NAME}_settings_btn`)?.addEventListener('click', () => {\n        openSettingsModal(() => {\n            // After settings close, check if any deleted presets were in use\n            if (popupState) {\n                checkForDeletedPresetReferences();\n            }\n            updateAllComponents();\n        });\n    });\n\n    popupElement.querySelector(`#${MODULE_NAME}_close_btn`)?.addEventListener('click', () => {\n        const dialog = popupElement?.closest('.popup');\n        if (dialog) {\n            const cancelBtn = dialog.querySelector('.popup-button-cancel, .popup-button-ok') as HTMLElement;\n            cancelBtn?.click();\n        }\n    });\n}\n\n/**\n * Check if current pipeline configs reference deleted presets and clear them\n */\nfunction checkForDeletedPresetReferences(): void {\n    if (!popupState) return;\n\n    for (const stage of STAGES) {\n        const config = popupState.pipeline.configs[stage];\n\n        // Check prompt preset\n        if (config.promptPresetId && !getPromptPreset(config.promptPresetId)) {\n            debugLog('info', 'Clearing deleted prompt preset reference', { stage, presetId: config.promptPresetId });\n            popupState.pipeline = pipelineUpdateStageConfig(popupState.pipeline, stage, {\n                promptPresetId: null,\n            });\n        }\n\n        // Check schema preset\n        if (config.schemaPresetId && !getSchemaPreset(config.schemaPresetId)) {\n            debugLog('info', 'Clearing deleted schema preset reference', { stage, presetId: config.schemaPresetId });\n            popupState.pipeline = pipelineUpdateStageConfig(popupState.pipeline, stage, {\n                schemaPresetId: null,\n            });\n        }\n    }\n}\n\n// ============================================================================\n// CHARACTER SELECT LISTENERS\n// ============================================================================\n\nfunction initCharacterSelectListeners(): void {\n    if (!popupElement || !popupState) return;\n\n    const { Fuse, lodash } = SillyTavern.libs;\n\n    const container = popupElement.querySelector(`#${MODULE_NAME}_character_select_container`);\n    if (!container) return;\n\n    const searchInput = container.querySelector(`#${MODULE_NAME}_char_search`) as HTMLInputElement;\n    const dropdown = container.querySelector(`#${MODULE_NAME}_char_dropdown`) as HTMLElement;\n\n    if (!searchInput || !dropdown) return;\n\n    let selectedIndex = -1;\n    let currentResults: Array<{ char: Character; index: number }> = [];\n\n    const handleSearch = () => {\n        // Get fresh characters from context\n        const { characters } = SillyTavern.getContext();\n        const currentChars = characters as Character[];\n\n        const currentCharData = currentChars\n            .map((char, index) => ({ char, index }))\n            .filter(({ char }) => char?.name);\n\n        const fuse = new Fuse(currentCharData, {\n            keys: ['char.name', 'char.description'],\n            threshold: 0.4,\n            includeScore: true,\n            minMatchCharLength: 1,\n        });\n\n        const query = searchInput.value.trim();\n\n        if (!query) {\n            dropdown.classList.add('hidden');\n            currentResults = [];\n            return;\n        }\n\n        const results = fuse.search(query, { limit: 10 });\n        currentResults = results.map((r: { item: { char: Character; index: number } }) => r.item);\n\n        if (currentResults.length === 0) {\n            dropdown.innerHTML = `<div class=\"${MODULE_NAME}_dropdown_empty\">No characters found</div>`;\n            dropdown.classList.remove('hidden');\n            return;\n        }\n\n        selectedIndex = -1;\n        renderDropdownItems(currentResults, dropdown, -1);\n        dropdown.classList.remove('hidden');\n    };\n\n    const debouncedSearch = lodash.debounce(handleSearch, 150);\n    popupState.debouncedFunctions.push(debouncedSearch);\n    searchInput.addEventListener('input', debouncedSearch);\n\n    searchInput.addEventListener('keydown', (e) => {\n        if (currentResults.length === 0) return;\n\n        if (e.key === 'ArrowDown') {\n            e.preventDefault();\n            selectedIndex = Math.min(selectedIndex + 1, currentResults.length - 1);\n            renderDropdownItems(currentResults, dropdown, selectedIndex);\n        } else if (e.key === 'ArrowUp') {\n            e.preventDefault();\n            selectedIndex = Math.max(selectedIndex - 1, 0);\n            renderDropdownItems(currentResults, dropdown, selectedIndex);\n        } else if (e.key === 'Enter' && selectedIndex >= 0) {\n            e.preventDefault();\n            selectCharacter(currentResults[selectedIndex].char, currentResults[selectedIndex].index);\n            dropdown.classList.add('hidden');\n            searchInput.value = '';\n        } else if (e.key === 'Escape') {\n            dropdown.classList.add('hidden');\n            searchInput.value = '';\n        }\n    });\n\n    documentClickHandler = (e: MouseEvent) => {\n        if (!searchInput.contains(e.target as Node) && !dropdown.contains(e.target as Node)) {\n            dropdown.classList.add('hidden');\n        }\n    };\n    document.addEventListener('click', documentClickHandler);\n\n    dropdown.addEventListener('click', (e) => {\n        const item = (e.target as HTMLElement).closest(`.${MODULE_NAME}_dropdown_item`);\n        if (item) {\n            const index = parseInt(item.getAttribute('data-index') || '-1', 10);\n            const charItem = currentResults.find(c => c.index === index);\n            if (charItem) {\n                selectCharacter(charItem.char, charItem.index);\n                dropdown.classList.add('hidden');\n                searchInput.value = '';\n            }\n        }\n    });\n\n    container.addEventListener('click', (e) => {\n        const target = e.target as HTMLElement;\n\n        if (target.closest(`#${MODULE_NAME}_char_clear`)) {\n            if (!popupState) return;\n            popupState.pipeline = setCharacter(popupState.pipeline, null, null);\n            popupState.historyLoaded = false;\n            updateAllComponents();\n            return;\n        }\n\n        const toggle = target.closest(`.${MODULE_NAME}_field_toggle`);\n        if (toggle) {\n            const fieldKey = toggle.getAttribute('data-field');\n            const content = container.querySelector(`#${MODULE_NAME}_field_content_${fieldKey}`);\n            const icon = toggle.querySelector('i');\n\n            if (content && icon) {\n                content.classList.toggle('hidden');\n                icon.classList.toggle('fa-chevron-right');\n                icon.classList.toggle('fa-chevron-down');\n            }\n        }\n    });\n}\n\nasync function selectCharacter(char: Character, index: number): Promise<void> {\n    if (!popupState) return;\n\n    popupState.pipeline = setCharacter(popupState.pipeline, char, index);\n    popupState.historyLoaded = false;\n    updateAllComponents();\n\n    // Load iteration history for this character\n    const history = await loadIterationHistory(char);\n    if (popupState && popupState.pipeline.character === char) {\n        if (history && history.length > 0) {\n            popupState.pipeline = {\n                ...popupState.pipeline,\n                iterationHistory: history,\n                iterationCount: history.length,\n            };\n            debugLog('info', 'Loaded iteration history', { count: history.length });\n        }\n        popupState.historyLoaded = true;\n        updateIterationHistory();\n    }\n\n    // Update token counts\n    setTimeout(async () => {\n        if (!popupElement || !popupState?.pipeline.character) return;\n\n        const container = popupElement.querySelector(`#${MODULE_NAME}_character_select_container`);\n        if (container) {\n            const fields = getPopulatedFields(popupState.pipeline.character);\n            await updateFieldTokenCounts(container as HTMLElement, fields);\n        }\n    }, 50);\n\n    debugLog('info', 'Character selected', { name: char.name, index });\n}\n\n// ============================================================================\n// PIPELINE NAV LISTENERS\n// ============================================================================\n\nfunction initPipelineNavListeners(): void {\n    if (!popupElement || !popupState) return;\n\n    const container = popupElement.querySelector(`#${MODULE_NAME}_pipeline_nav_container`);\n    if (!container) return;\n\n    container.addEventListener('change', (e) => {\n        const checkbox = e.target as HTMLInputElement;\n        if (checkbox.classList.contains(`${MODULE_NAME}_stage_checkbox`)) {\n            const stage = checkbox.getAttribute('data-stage') as StageName;\n            if (stage && popupState) {\n                popupState.pipeline = toggleStage(popupState.pipeline, stage);\n                updatePipelineNav();\n            }\n        }\n    });\n\n    container.addEventListener('click', async (e) => {\n        const btn = (e.target as HTMLElement).closest(`.${MODULE_NAME}_stage_btn`);\n        if (btn && popupState) {\n            const stage = btn.getAttribute('data-stage') as StageName;\n            if (stage) {\n                popupState.activeStageView = stage;\n                updateStageSection();\n                updateResultsPanel();\n                updateTokenEstimate();\n                updatePipelineNav();\n            }\n        }\n\n        const runBtn = (e.target as HTMLElement).closest(`#${MODULE_NAME}_run_selected_btn`);\n        if (runBtn) {\n            runSelectedStages();\n        }\n\n        const runAllBtn = (e.target as HTMLElement).closest(`#${MODULE_NAME}_run_all_btn`);\n        if (runAllBtn) {\n            runAllStages();\n        }\n\n        const resetBtn = (e.target as HTMLElement).closest(`#${MODULE_NAME}_reset_pipeline_btn`);\n        if (resetBtn && popupState) {\n            // Confirm before reset\n            const { Popup, POPUP_RESULT } = SillyTavern.getContext();\n            const confirmed = await Popup.show.confirm(\n                'Reset Pipeline?',\n                'This will clear all results and iteration history. Continue?',\n            );\n\n            if (confirmed !== POPUP_RESULT.AFFIRMATIVE) return;\n\n            popupState.pipeline = resetPipeline(popupState.pipeline, true);\n            popupState.historyLoaded = true; // No history to load after reset\n            updateAllComponents();\n        }\n    });\n}\n\n// ============================================================================\n// STAGE CONFIG LISTENERS\n// ============================================================================\n\nfunction initStageConfigListeners(): void {\n    if (!popupElement || !popupState) return;\n\n    const container = popupElement.querySelector(`#${MODULE_NAME}_stage_config_container`);\n    if (!container) return;\n\n    container.addEventListener('change', (e) => {\n        const select = e.target as HTMLSelectElement;\n\n        if (select.id === `${MODULE_NAME}_prompt_preset_select` && popupState) {\n            const value = select.value || null;\n            popupState.pipeline = pipelineUpdateStageConfig(popupState.pipeline, popupState.activeStageView, {\n                promptPresetId: value,\n            });\n            updateStageConfigUI();\n            updateTokenEstimate();\n        }\n\n        if (select.id === `${MODULE_NAME}_schema_preset_select` && popupState) {\n            const value = select.value || null;\n            popupState.pipeline = pipelineUpdateStageConfig(popupState.pipeline, popupState.activeStageView, {\n                schemaPresetId: value,\n            });\n            updateStageConfigUI();\n        }\n    });\n\n    const { lodash } = SillyTavern.libs;\n\n    const debouncedInputHandler = lodash.debounce((e: Event) => {\n        const textarea = e.target as HTMLTextAreaElement;\n\n        if (textarea.id === `${MODULE_NAME}_custom_prompt` && popupState) {\n            popupState.pipeline = pipelineUpdateStageConfig(popupState.pipeline, popupState.activeStageView, {\n                customPrompt: textarea.value,\n                promptPresetId: null,\n            });\n            updateTokenEstimate();\n            updateStageConfigUI();\n        }\n\n        if (textarea.id === `${MODULE_NAME}_custom_schema` && popupState) {\n            popupState.pipeline = pipelineUpdateStageConfig(popupState.pipeline, popupState.activeStageView, {\n                customSchema: textarea.value,\n                schemaPresetId: null,\n            });\n            updateStageConfigUI();\n        }\n    }, 300);\n\n    popupState.debouncedFunctions.push(debouncedInputHandler);\n    container.addEventListener('input', debouncedInputHandler);\n\n    container.addEventListener('change', (e) => {\n        const checkbox = e.target as HTMLInputElement;\n        if (checkbox.id === `${MODULE_NAME}_use_structured` && popupState) {\n            popupState.pipeline = pipelineUpdateStageConfig(popupState.pipeline, popupState.activeStageView, {\n                useStructuredOutput: checkbox.checked,\n            });\n            updateStageConfigUI();\n        }\n    });\n\n    container.addEventListener('click', async (e) => {\n        const target = e.target as HTMLElement;\n\n        const runBtn = target.closest(`#${MODULE_NAME}_run_stage_btn`);\n        if (runBtn && popupState) {\n            runSingleStage(popupState.activeStageView);\n            return;\n        }\n\n        const savePromptBtn = target.closest(`#${MODULE_NAME}_save_prompt_preset_btn`);\n        if (savePromptBtn && popupState) {\n            const promptTextarea = popupElement?.querySelector(`#${MODULE_NAME}_custom_prompt`) as HTMLTextAreaElement;\n            if (promptTextarea) {\n                const result = await handleSavePromptPreset(popupState.activeStageView, promptTextarea.value);\n                if (result.success && result.presetId) {\n                    popupState.pipeline = pipelineUpdateStageConfig(popupState.pipeline, popupState.activeStageView, {\n                        promptPresetId: result.presetId,\n                        customPrompt: '',\n                    });\n                    updateStageConfigUI();\n                }\n            }\n            return;\n        }\n\n        const saveSchemaBtn = target.closest(`#${MODULE_NAME}_save_schema_preset_btn`);\n        if (saveSchemaBtn && popupState) {\n            const schemaTextarea = popupElement?.querySelector(`#${MODULE_NAME}_custom_schema`) as HTMLTextAreaElement;\n            if (schemaTextarea) {\n                const result = await handleSaveSchemaPreset(popupState.activeStageView, schemaTextarea.value);\n                if (result.success && result.presetId) {\n                    popupState.pipeline = pipelineUpdateStageConfig(popupState.pipeline, popupState.activeStageView, {\n                        schemaPresetId: result.presetId,\n                        customSchema: '',\n                    });\n                    updateStageConfigUI();\n                }\n            }\n            return;\n        }\n\n        const generateBtn = target.closest(`#${MODULE_NAME}_generate_schema_btn`);\n        if (generateBtn && popupState) {\n            const generated = await handleGenerateSchema();\n            if (generated) {\n                const schemaTextarea = popupElement?.querySelector(`#${MODULE_NAME}_custom_schema`) as HTMLTextAreaElement;\n                if (schemaTextarea) {\n                    schemaTextarea.value = generated;\n                    popupState.pipeline = pipelineUpdateStageConfig(popupState.pipeline, popupState.activeStageView, {\n                        customSchema: generated,\n                        schemaPresetId: null,\n                    });\n                    updateStageConfigUI();\n                }\n            }\n            return;\n        }\n\n        const validateBtn = target.closest(`#${MODULE_NAME}_validate_schema_btn`);\n        if (validateBtn && popupState) {\n            const schemaTextarea = popupElement?.querySelector(`#${MODULE_NAME}_custom_schema`) as HTMLTextAreaElement;\n            if (schemaTextarea) {\n                await handleValidateSchema(schemaTextarea.value);\n            }\n            return;\n        }\n\n        const fixBtn = target.closest(`#${MODULE_NAME}_fix_schema_btn`);\n        if (fixBtn && popupState) {\n            const schemaTextarea = popupElement?.querySelector(`#${MODULE_NAME}_custom_schema`) as HTMLTextAreaElement;\n            if (schemaTextarea) {\n                const fixed = handleFixSchema(schemaTextarea.value);\n                if (fixed) {\n                    schemaTextarea.value = fixed;\n                    popupState.pipeline = pipelineUpdateStageConfig(popupState.pipeline, popupState.activeStageView, {\n                        customSchema: fixed,\n                        schemaPresetId: null,\n                    });\n                    updateStageConfigUI();\n                }\n            }\n            return;\n        }\n\n        const formatBtn = target.closest(`#${MODULE_NAME}_format_schema_btn`);\n        if (formatBtn && popupState) {\n            const schemaTextarea = popupElement?.querySelector(`#${MODULE_NAME}_custom_schema`) as HTMLTextAreaElement;\n            if (schemaTextarea) {\n                const formatted = handleFormatSchema(schemaTextarea.value);\n                if (formatted) {\n                    schemaTextarea.value = formatted;\n                    popupState.pipeline = pipelineUpdateStageConfig(popupState.pipeline, popupState.activeStageView, {\n                        customSchema: formatted,\n                        schemaPresetId: null,\n                    });\n                    updateStageConfigUI();\n                }\n            }\n            return;\n        }\n    });\n}\n\n// ============================================================================\n// RESULTS PANEL LISTENERS\n// ============================================================================\n\nfunction initResultsPanelListeners(): void {\n    if (!popupElement || !popupState) return;\n\n    const container = popupElement.querySelector(`#${MODULE_NAME}_results_container`);\n    if (!container) return;\n\n    container.addEventListener('click', async (e) => {\n        const target = e.target as HTMLElement;\n\n        // Regenerate\n        if (target.closest(`#${MODULE_NAME}_regenerate_btn`) && popupState) {\n            popupState.pipeline = clearStageResult(popupState.pipeline, popupState.activeStageView);\n            runSingleStage(popupState.activeStageView);\n        }\n\n        // Lock/Unlock\n        if (target.closest(`#${MODULE_NAME}_lock_btn`) && popupState) {\n            popupState.pipeline = lockStageResult(popupState.pipeline, popupState.activeStageView);\n            updateResultsPanel();\n        }\n\n        if (target.closest(`#${MODULE_NAME}_unlock_btn`) && popupState) {\n            popupState.pipeline = unlockStageResult(popupState.pipeline, popupState.activeStageView);\n            updateResultsPanel();\n        }\n\n        // Continue to next stage\n        if (target.closest(`#${MODULE_NAME}_continue_btn`) && popupState) {\n            const nextStage = getNextStage(popupState.pipeline, popupState.activeStageView);\n            if (nextStage) {\n                popupState.activeStageView = nextStage;\n                updateStageSection();\n                updateResultsPanel();\n                updateTokenEstimate();\n            }\n        }\n\n        // Apply to Character\n        if (target.closest(`#${MODULE_NAME}_apply_btn`) && popupState) {\n            await handleApplyToCharacter();\n        }\n\n        // Refine\n        if (target.closest(`#${MODULE_NAME}_refine_btn`) && popupState) {\n            runRefinement();\n        }\n\n        // Accept rewrite\n        if (target.closest(`#${MODULE_NAME}_accept_btn`) && popupState) {\n            popupState.pipeline = acceptRewrite(popupState.pipeline);\n            toastr.success('Rewrite accepted as final');\n            updateAllComponents();\n        }\n\n        // Copy\n        if (target.closest(`#${MODULE_NAME}_copy_btn`) && popupState) {\n            const result = popupState.pipeline.results[popupState.activeStageView];\n            if (result) {\n                navigator.clipboard.writeText(result.response);\n                toastr.success('Copied to clipboard');\n            }\n        }\n\n        // Export\n        if (target.closest(`#${MODULE_NAME}_export_btn`) && popupState) {\n            popupState.pipeline = setExportData(popupState.pipeline);\n            if (popupState.pipeline.exportData) {\n                navigator.clipboard.writeText(popupState.pipeline.exportData);\n                toastr.success('Export copied to clipboard');\n            }\n        }\n\n        // Cancel generation\n        if (target.closest(`#${MODULE_NAME}_cancel_btn`) && popupState?.abortController) {\n            popupState.abortController.abort();\n        }\n    });\n}\n\n// ============================================================================\n// APPLY TO CHARACTER\n// ============================================================================\n\nasync function handleApplyToCharacter(): Promise<void> {\n    if (!popupState || !popupState.pipeline.results.rewrite || !popupState.pipeline.character) {\n        toastr.warning('No rewrite to apply');\n        return;\n    }\n\n    const { Popup, POPUP_TYPE, POPUP_RESULT } = SillyTavern.getContext();\n    const { DOMPurify } = SillyTavern.libs;\n\n    const rewriteResponse = popupState.pipeline.results.rewrite.response;\n    const parsed = parseRewriteResponse(rewriteResponse);\n\n    // Build preview content\n    let previewHtml = `<div class=\"${MODULE_NAME}_apply_preview\">`;\n    previewHtml += `<p><strong>Parse method:</strong> ${parsed.parseMethod}</p>`;\n\n    if (parsed.fields.length === 0) {\n        previewHtml += `<p class=\"${MODULE_NAME}_apply_warning\">\n            <i class=\"fa-solid fa-triangle-exclamation\"></i>\n            No recognized character fields found in the rewrite output.\n            The raw content will be copied to clipboard instead.\n        </p>`;\n        previewHtml += `<details><summary>Raw content preview</summary><pre>${DOMPurify.sanitize(parsed.raw.substring(0, 500))}...</pre></details>`;\n    } else {\n        previewHtml += `<p><strong>Fields to update (${parsed.fields.length}):</strong></p>`;\n        previewHtml += '<ul>';\n        for (const field of parsed.fields) {\n            const preview = field.value.substring(0, 100);\n            previewHtml += `<li><strong>${DOMPurify.sanitize(field.label)}:</strong> ${DOMPurify.sanitize(preview)}${field.value.length > 100 ? '...' : ''}</li>`;\n        }\n        previewHtml += '</ul>';\n    }\n    previewHtml += '</div>';\n\n    // Show confirmation\n    const confirmContent = `\n        <h3>Apply Rewrite to Character?</h3>\n        <p>This will update <strong>${DOMPurify.sanitize(popupState.pipeline.character.name)}</strong> with the rewritten content.</p>\n        ${previewHtml}\n    `;\n\n    const popup = new Popup(confirmContent, POPUP_TYPE.CONFIRM, '', {\n        wide: true,\n        okButton: parsed.fields.length > 0 ? 'Apply Changes' : 'Copy Raw Content',\n        cancelButton: 'Cancel',\n    });\n\n    const result = await popup.show();\n\n    if (result !== POPUP_RESULT.AFFIRMATIVE) {\n        return;\n    }\n\n    // If no fields parsed, just copy raw content\n    if (parsed.fields.length === 0) {\n        navigator.clipboard.writeText(parsed.raw);\n        toastr.info('Raw content copied to clipboard');\n        return;\n    }\n\n    // Apply the changes\n    const applyResult = await applyRewriteToCharacter(popupState.pipeline, parsed.fields);\n\n    if (applyResult.success) {\n        toastr.success(`Updated ${applyResult.updatedFields.length} fields: ${applyResult.updatedFields.join(', ')}`);\n\n        // Emit custom event for other extensions\n        const { eventSource } = SillyTavern.getContext();\n        await eventSource.emit('character_tools_rewrite_applied', {\n            characterName: popupState.pipeline.character.name,\n            characterIndex: popupState.pipeline.characterIndex,\n            updatedFields: applyResult.updatedFields,\n            iterationCount: popupState.pipeline.iterationCount,\n        });\n\n        // Refresh character data\n        refreshSelectedCharacter();\n    } else {\n        toastr.error(applyResult.error || 'Failed to apply changes');\n    }\n}\n\n// ============================================================================\n// ITERATION HISTORY LISTENERS\n// ============================================================================\n\nfunction initIterationHistoryListeners(): void {\n    if (!popupElement || !popupState) return;\n\n    const container = popupElement.querySelector(`#${MODULE_NAME}_iteration_history_container`);\n    if (!container) return;\n\n    container.addEventListener('click', async (e) => {\n        const target = e.target as HTMLElement;\n\n        // Revert button\n        const revertBtn = target.closest(`.${MODULE_NAME}_iteration_revert_btn`);\n        if (revertBtn && popupState) {\n            const index = parseInt(revertBtn.getAttribute('data-index') || '-1', 10);\n            if (index >= 0) {\n                await handleRevertToIteration(index);\n            }\n        }\n\n        // View button\n        const viewBtn = target.closest(`.${MODULE_NAME}_iteration_view_btn`);\n        if (viewBtn && popupState) {\n            const index = parseInt(viewBtn.getAttribute('data-index') || '-1', 10);\n            if (index >= 0 && index < popupState.pipeline.iterationHistory.length) {\n                showIterationView(popupState.pipeline.iterationHistory[index]);\n            }\n        }\n    });\n}\n\nasync function handleRevertToIteration(index: number): Promise<void> {\n    if (!popupState) return;\n\n    const { Popup, POPUP_RESULT } = SillyTavern.getContext();\n\n    const confirmed = await Popup.show.confirm(\n        'Revert to Previous Iteration?',\n        `This will restore the rewrite from iteration #${index + 1} and discard later changes.`,\n    );\n\n    if (confirmed !== POPUP_RESULT.AFFIRMATIVE) return;\n\n    popupState.pipeline = revertToIteration(popupState.pipeline, index);\n    toastr.info(`Reverted to iteration #${index + 1}`);\n\n    // Save updated history\n    if (popupState.pipeline.character) {\n        await saveIterationHistory(popupState.pipeline.character, popupState.pipeline.iterationHistory);\n    }\n\n    updateAllComponents();\n}\n\nasync function showIterationView(snap: IterationSnapshot): Promise<void> {\n    const { Popup, POPUP_TYPE } = SillyTavern.getContext();\n    const { DOMPurify } = SillyTavern.libs;\n\n    const content = renderIterationViewContent(snap);\n\n    const popup = new Popup(DOMPurify.sanitize(content), POPUP_TYPE.TEXT, '', {\n        wide: true,\n        large: true,\n        allowVerticalScrolling: true,\n        okButton: 'Close',\n        cancelButton: false,\n    });\n\n    await popup.show();\n}\n\n// ============================================================================\n// GENERATION\n// ============================================================================\n\nasync function runSingleStage(stage: StageName): Promise<void> {\n    if (!popupState || popupState.isGenerating || popupState.isRefining) return;\n\n    if (!isApiReady()) {\n        toastr.error('API is not connected');\n        return;\n    }\n\n    const canRun = canRunStage(popupState.pipeline, stage);\n    if (!canRun.canRun) {\n        toastr.warning(canRun.reason || 'Cannot run this stage');\n        return;\n    }\n\n    if (canRun.reason) {\n        toastr.info(canRun.reason);\n    }\n\n    popupState.isGenerating = true;\n    popupState.abortController = new AbortController();\n    popupState.pipeline = startStage(popupState.pipeline, stage);\n    updateAllComponents();\n\n    const promptUsed = buildStagePrompt(popupState.pipeline, stage) || '';\n    const schemaUsed = getStageSchema(popupState.pipeline, stage);\n\n    try {\n        const result = await runStageGeneration(\n            popupState.pipeline,\n            stage,\n            popupState.abortController.signal,\n        );\n\n        if (result.success) {\n            popupState.pipeline = completeStage(popupState.pipeline, stage, {\n                response: result.response,\n                isStructured: result.isStructured,\n                promptUsed,\n                schemaUsed,\n            });\n            toastr.success(`${STAGE_LABELS[stage]} complete`);\n        } else {\n            popupState.pipeline = failStage(popupState.pipeline, stage, result.error);\n            if (result.error !== 'Generation cancelled') {\n                toastr.error(result.error);\n            }\n        }\n    } catch (e) {\n        popupState.pipeline = failStage(popupState.pipeline, stage, (e as Error).message);\n        toastr.error((e as Error).message);\n    } finally {\n        popupState.isGenerating = false;\n        popupState.abortController = null;\n        updateAllComponents();\n    }\n}\n\nasync function runSelectedStages(): Promise<void> {\n    if (!popupState || popupState.isGenerating || popupState.isRefining) return;\n\n    if (!isApiReady()) {\n        toastr.error('API is not connected');\n        return;\n    }\n\n    const validation = validatePipeline(popupState.pipeline);\n    if (!validation.valid) {\n        toastr.error(validation.errors.join('\\n'));\n        return;\n    }\n\n    if (validation.warnings.length > 0) {\n        toastr.warning(validation.warnings.join('\\n'));\n    }\n\n    for (const stage of popupState.pipeline.selectedStages) {\n        const status = popupState.pipeline.stageStatus[stage];\n        if (status === 'complete' || status === 'skipped') {\n            continue;\n        }\n\n        popupState.activeStageView = stage;\n        updateStageSection();\n\n        await runSingleStage(stage);\n\n        if (!popupState) break;\n\n        const newStatus = popupState.pipeline.stageStatus[stage];\n        if (newStatus !== 'complete') {\n            break;\n        }\n    }\n}\n\nasync function runAllStages(): Promise<void> {\n    if (!popupState) return;\n\n    popupState.pipeline.selectedStages = [...STAGES];\n    updatePipelineNav();\n\n    await runSelectedStages();\n}\n\nasync function runRefinement(): Promise<void> {\n    if (!popupState || popupState.isGenerating || popupState.isRefining) return;\n\n    if (!isApiReady()) {\n        toastr.error('API is not connected');\n        return;\n    }\n\n    const canRefineResult = canRefine(popupState.pipeline);\n    if (!canRefineResult.canRun) {\n        toastr.warning(canRefineResult.reason || 'Cannot refine');\n        return;\n    }\n\n    const validation = validateRefinement(popupState.pipeline);\n    if (!validation.valid) {\n        toastr.error(validation.errors.join('\\n'));\n        return;\n    }\n\n    if (validation.warnings.length > 0) {\n        toastr.warning(validation.warnings.join('\\n'));\n    }\n\n    // Snapshot current state before starting refinement\n    const preRefinementState = {\n        iterationCount: popupState.pipeline.iterationCount,\n        iterationHistory: [...popupState.pipeline.iterationHistory],\n    };\n\n    // Start refinement - this snapshots current state\n    popupState.pipeline = startRefinement(popupState.pipeline);\n    popupState.isRefining = true;\n    popupState.abortController = new AbortController();\n\n    // Show refinement loading state\n    const resultsContainer = popupElement?.querySelector(`#${MODULE_NAME}_results_container`);\n    if (resultsContainer) {\n        resultsContainer.innerHTML = renderRefinementLoading(popupState.pipeline.iterationCount);\n    }\n\n    updateIterationIndicator();\n    updateIterationHistory();\n\n    try {\n        const result = await runRefinementGeneration(\n            popupState.pipeline,\n            popupState.abortController.signal,\n        );\n\n        if (result.success) {\n            popupState.pipeline = completeRefinement(popupState.pipeline, {\n                response: result.response,\n                isStructured: false,\n                promptUsed: '[Refinement prompt]',\n                schemaUsed: null,\n            });\n\n            toastr.success(`Refinement #${popupState.pipeline.iterationCount} complete`);\n\n            // Save iteration history\n            if (popupState.pipeline.character) {\n                await saveIterationHistory(popupState.pipeline.character, popupState.pipeline.iterationHistory);\n            }\n\n            // Switch to analyze view so user can review\n            popupState.activeStageView = 'analyze';\n        } else {\n            // Restore pre-refinement state on failure\n            popupState.pipeline = {\n                ...popupState.pipeline,\n                iterationCount: preRefinementState.iterationCount,\n                iterationHistory: preRefinementState.iterationHistory,\n            };\n\n            if (result.error !== 'Generation cancelled') {\n                toastr.error(result.error);\n            }\n        }\n    } catch (e) {\n        // Restore pre-refinement state on error\n        popupState.pipeline = {\n            ...popupState.pipeline,\n            iterationCount: preRefinementState.iterationCount,\n            iterationHistory: preRefinementState.iterationHistory,\n        };\n\n        toastr.error((e as Error).message);\n    } finally {\n        popupState.isRefining = false;\n        popupState.abortController = null;\n        updateAllComponents();\n    }\n}\n\n// ============================================================================\n// UPDATE FUNCTIONS\n// ============================================================================\n\nfunction updateAllComponents(): void {\n    updateCharacterSelect();\n    updatePipelineNav();\n    updateStageSection();\n    updateResultsPanel();\n    updateTokenEstimate();\n    updateIterationIndicator();\n    updateIterationHistory();\n}\n\nfunction updateCharacterSelect(): void {\n    if (!popupElement || !popupState) return;\n\n    const container = popupElement.querySelector(`#${MODULE_NAME}_character_select_container`);\n    if (container) {\n        updateCharacterSelectState(\n            container as HTMLElement,\n            popupState.pipeline.character,\n            popupState.pipeline.characterIndex,\n        );\n    }\n}\n\nfunction updatePipelineNav(): void {\n    if (!popupElement || !popupState) return;\n\n    const container = popupElement.querySelector(`#${MODULE_NAME}_pipeline_nav_container`);\n    if (container) {\n        updatePipelineNavState(\n            container as HTMLElement,\n            popupState.pipeline.selectedStages,\n            popupState.pipeline.stageStatus,\n            popupState.activeStageView,\n            !!popupState.pipeline.character && isApiReady(),\n            popupState.isGenerating || popupState.isRefining,\n        );\n    }\n}\n\nfunction updateStageSection(): void {\n    if (!popupElement || !popupState) return;\n\n    const icon = popupElement.querySelector(`#${MODULE_NAME}_stage_icon`);\n    const title = popupElement.querySelector(`#${MODULE_NAME}_stage_title`);\n\n    if (icon) {\n        icon.className = `fa-solid ${STAGE_ICONS[popupState.activeStageView]}`;\n    }\n    if (title) {\n        title.textContent = STAGE_LABELS[popupState.activeStageView];\n    }\n\n    updateStageConfigUI();\n}\n\nfunction updateStageConfigUI(): void {\n    if (!popupElement || !popupState) return;\n\n    const container = popupElement.querySelector(`#${MODULE_NAME}_stage_config_container`);\n    if (container) {\n        updateStageConfigState(\n            container as HTMLElement,\n            popupState.activeStageView,\n            popupState.pipeline.configs[popupState.activeStageView],\n            popupState.isGenerating || popupState.isRefining,\n        );\n    }\n}\n\nfunction updateResultsPanel(): void {\n    if (!popupElement || !popupState) return;\n\n    const container = popupElement.querySelector(`#${MODULE_NAME}_results_container`);\n    if (container) {\n        updateResultsPanelState(\n            container as HTMLElement,\n            popupState.activeStageView,\n            popupState.pipeline.results[popupState.activeStageView],\n            popupState.pipeline.stageStatus[popupState.activeStageView],\n            popupState.isGenerating,\n            getNextStage(popupState.pipeline, popupState.activeStageView),\n            popupState.pipeline,\n        );\n    }\n}\n\nfunction updateIterationIndicator(): void {\n    if (!popupElement || !popupState) return;\n\n    const indicator = popupElement.querySelector(`#${MODULE_NAME}_iteration_indicator`);\n    if (!indicator) return;\n\n    if (popupState.pipeline.iterationCount > 0 || popupState.pipeline.isRefining) {\n        indicator.classList.remove('hidden');\n        indicator.innerHTML = `\n      <i class=\"fa-solid fa-arrows-rotate\"></i>\n      Iteration #${popupState.pipeline.iterationCount + 1}\n    `;\n    } else {\n        indicator.classList.add('hidden');\n    }\n}\n\nfunction updateIterationHistory(): void {\n    if (!popupElement || !popupState) return;\n\n    const container = popupElement.querySelector(`#${MODULE_NAME}_iteration_history_container`);\n    if (container) {\n        updateIterationHistoryState(\n            container as HTMLElement,\n            popupState.pipeline.iterationHistory,\n            popupState.pipeline.iterationCount,\n            popupState.historyLoaded,\n        );\n    }\n}\n\nasync function updateTokenEstimate(): Promise<void> {\n    if (!popupElement || !popupState) return;\n\n    const tokenEl = popupElement.querySelector(`#${MODULE_NAME}_token_estimate`);\n    if (!tokenEl) return;\n\n    if (!popupState.pipeline.character) {\n        tokenEl.innerHTML = '<i class=\"fa-solid fa-microchip\"></i> Select a character';\n        tokenEl.className = `${MODULE_NAME}_token_estimate`;\n        return;\n    }\n\n    tokenEl.innerHTML = '<i class=\"fa-solid fa-spinner fa-spin\"></i>';\n    tokenEl.className = `${MODULE_NAME}_token_estimate`;\n\n    // Use refinement token count if we're in refinement mode\n    let counts;\n    if (popupState.pipeline.isRefining && popupState.pipeline.results.rewrite && popupState.pipeline.results.analyze) {\n        counts = await getRefinementTokenCount(popupState.pipeline);\n    } else {\n        counts = await getStageTokenCount(popupState.pipeline, popupState.activeStageView);\n    }\n\n    if (!popupState || !popupElement) return;\n\n    if (!counts) {\n        tokenEl.innerHTML = '<i class=\"fa-solid fa-microchip\"></i> --';\n        tokenEl.className = `${MODULE_NAME}_token_estimate`;\n        return;\n    }\n\n    let colorClass = '';\n    if (counts.percentage > 100) colorClass = 'danger';\n    else if (counts.percentage > 80) colorClass = 'warning';\n\n    tokenEl.innerHTML = `<i class=\"fa-solid fa-microchip\"></i> ${counts.promptTokens.toLocaleString()}t (${counts.percentage}%)`;\n    tokenEl.className = `${MODULE_NAME}_token_estimate ${colorClass}`;\n}\n","// src/ui/panel.ts\n//\n// Extension panel - minimal, just the launch button and settings access.\n\nimport { MODULE_NAME, EXTENSION_PATH } from '../constants';\nimport { getSettings, setDebugMode } from '../settings';\nimport { debugLog, logError } from '../debug';\nimport { openMainPopup } from './popup';\n\n// ============================================================================\n// INITIALIZATION\n// ============================================================================\n\n/**\n * Initialize the extension panel in ST's extensions settings\n */\nexport async function initPanel(): Promise<void> {\n    const { renderExtensionTemplateAsync } = SillyTavern.getContext();\n\n    const container = document.getElementById('extensions_settings');\n    if (!container) {\n        logError('Extensions container not found', null);\n        return;\n    }\n\n    try {\n        const html = await renderExtensionTemplateAsync(EXTENSION_PATH, 'templates/panel', {}, true);\n\n        const wrapper = document.createElement('div');\n        wrapper.id = `${MODULE_NAME}_wrapper`;\n        wrapper.innerHTML = html;\n        container.appendChild(wrapper);\n\n        initEventListeners();\n\n        debugLog('info', 'Panel initialized', null);\n    } catch (error) {\n        logError('Failed to load panel template', error);\n    }\n}\n\n// ============================================================================\n// EVENT LISTENERS\n// ============================================================================\n\nfunction initEventListeners(): void {\n    // Open button\n    const openBtn = document.getElementById(`${MODULE_NAME}_open_btn`);\n    openBtn?.addEventListener('click', () => {\n        openMainPopup();\n    });\n\n    // Debug toggle\n    const debugToggle = document.getElementById(`${MODULE_NAME}_debug_toggle`) as HTMLInputElement;\n    if (debugToggle) {\n        debugToggle.checked = getSettings().debugMode;\n        debugToggle.addEventListener('change', () => {\n            setDebugMode(debugToggle.checked);\n            toastr.info(`Debug mode ${debugToggle.checked ? 'enabled' : 'disabled'}`);\n        });\n    }\n}\n\n// ============================================================================\n// REFRESH\n// ============================================================================\n\n/**\n * Refresh panel state (called when settings change externally)\n */\nexport function refreshPanel(): void {\n    const debugToggle = document.getElementById(`${MODULE_NAME}_debug_toggle`) as HTMLInputElement;\n    if (debugToggle) {\n        debugToggle.checked = getSettings().debugMode;\n    }\n}\n","// src/index.ts\n//\n// Extension entry point\n\nimport { getSettings } from './settings';\nimport { initPanel } from './ui/panel';\nimport { debugLog, logError } from './debug';\n\nfunction init(): void {\n    try {\n        debugLog('info', 'Extension initializing', { version: '1.0.0' });\n\n        initPanel();\n        registerEventListeners();\n\n        debugLog('info', 'Extension loaded', getSettings());\n    } catch (error) {\n        logError('Extension initialization failed', error);\n        toastr.error('Character Tools failed to initialize. Check console for details.');\n    }\n}\n\nfunction registerEventListeners(): void {\n    const { eventSource, eventTypes } = SillyTavern.getContext();\n\n    // Log API changes for debugging\n    eventSource.on(eventTypes.CHATCOMPLETION_SOURCE_CHANGED, () => {\n        debugLog('info', 'Chat completion source changed', null);\n    });\n\n    eventSource.on(eventTypes.CHATCOMPLETION_MODEL_CHANGED, () => {\n        debugLog('info', 'Chat completion model changed', null);\n    });\n\n    debugLog('info', 'Event listeners registered', null);\n}\n\n// Wait for app ready\nconst { eventSource, eventTypes } = SillyTavern.getContext();\neventSource.on(eventTypes.APP_READY, init);\n"],"names":["EXTENSION_PATH","SETTINGS_VERSION","CHARACTER_FIELDS","Object","freeze","key","label","scoreable","STAGE_LABELS","score","rewrite","analyze","STAGE_ICONS","DEFAULT_SYSTEM_PROMPT","DEFAULT_REFINEMENT_PROMPT","BUILTIN_PROMPT_PRESETS","id","name","stages","isBuiltin","createdAt","updatedAt","prompt","BUILTIN_SCHEMA_PRESETS","schema","strict","value","$schema","type","additionalProperties","properties","fieldScores","items","field","strengths","weaknesses","suggestions","required","overallScore","priorityImprovements","summary","preserved","lost","gained","soulPreservationScore","soulAssessment","verdict","enum","issuesToAddress","recommendations","promptPresetId","customPrompt","schemaPresetId","customSchema","useStructuredOutput","DEFAULT_GENERATION_CONFIG","source","model","temperature","maxTokens","frequencyPenalty","presencePenalty","topP","DEFAULT_SETTINGS","useCurrentSettings","generationConfig","systemPrompt","promptPresets","schemaPresets","stageDefaults","refinementPrompt","debugMode","settingsVersion","TEMPLATE_PLACEHOLDERS","ORIGINAL_CHARACTER","SCORE_RESULTS","REWRITE_RESULTS","CURRENT_REWRITE","CURRENT_ANALYSIS","ITERATION_NUMBER","CHARACTER_NAME","USER_NAME","MAX_DEBUG_LOG_ENTRIES","MAX_ITERATION_HISTORY","logEntries","data","entry","timestamp","Date","unshift","length","pop","isDebugMode","prefix","toUpperCase","console","debug","log","error","exportDebugInfo","JSON","stringify","context","SillyTavern","getContext","settings","extension","systemPromptLength","promptPresetCount","schemaPresetCount","sillytavern","mainApi","onlineStatus","chatCompletionSource","chatCompletionSettings","chat_completion_source","currentModel","openrouter_model","model_openai_select","maxContext","characterCount","characters","hasActiveChat","chat","logs","total","errors","filter","e","recent","slice","map","time","toISOString","collectDebugInfo","migrations","oldSettings","undefined","useRawMode","jsonSchema","structuredClone","extensionSettings","saveSettingsDebounced","lodash","libs","existing","oldVersion","needsSave","migrated","v","migration","runMigrations","merged","merge","builtinsAdded","modified","existingPromptIds","Set","p","builtin","has","push","existingSchemaIds","ensureBuiltinPresets","updateSetting","updateGenerationConfig","updates","setDebugMode","enabled","stage","includes","find","savePromptPreset","preset","uuidv4","now","newPreset","saveSchemaPreset","fixedSchema","ensureSchemaHasAdditionalProperties","fixed","addAdditionalPropertiesToNode","node","prop","values","Array","isArray","forEach","item","anyOf","variant","allOf","$defs","def","definitions","ANTHROPIC_LIMITS","MAX_ANYOF_VARIANTS","MAX_DEFS","MAX_NESTING_DEPTH","MAX_PROPERTIES_PER_OBJECT","MAX_ENUM_VALUES","SUPPORTED_STRING_FORMATS","SUPPORTED_MINMAX_ITEMS","IGNORED_CONSTRAINTS","numeric","string","array","object","UNSUPPORTED_FEATURES","UNSUPPORTED_REGEX_FEATURES","pattern","SCHEMA_GENERATION_PROMPT","input","trim","valid","parsed","parse","Error","message","match","obj","test","$ref","ctx","warnings","info","stats","defCount","anyOfCount","totalAnyOfVariants","maxDepth","propertyCount","optionalFieldCount","enumCount","currentDepth","seenRefs","defs","keys","validateSchemaNode","implicitAnyOfs","totalAnyOfs","join","path","Math","max","feature","ref","startsWith","add","refPath","replace","validateRef","types","validateObjectNode","validateArrayNode","validateStringNode","variants","i","validateAnyOf","validateAllOf","val","t","seen","validateEnum","const","validateConst","props","propCount","entries","minItems","prefixItems","format","supported","check","RegExp","msg","complexQuantifier","exec","min","parseInt","validateRegexPattern","autoFixSchema","fixSchemaNode","constraints","constraintNote","description","resolvePrompt","config","defaults","processPromptTemplate","substituteParams","processed","conditionalRegex","_match","variable","content","hasValue","toLowerCase","scoreResults","rewriteResults","currentRewrite","currentAnalysis","originalCharacter","iterationNumber","processConditionalBlocks","escapeRegExp","charName","userName","promptHasPlaceholders","found","placeholder","createPipelineState","character","characterIndex","results","configs","selectedStages","currentStage","stageStatus","iterationCount","iterationHistory","isRefining","exportData","setCharacter","state","index","newState","fieldsPopulated","getPopulatedFields","char","charCount","buildCharacterSummary","sections","f","canRefine","canRun","reason","updateStageConfig","failStage","_error","extractVerdict","analysisResponse","upper","startRefinement","snapshot","response","iteration","rewriteResponse","rewritePreview","substring","analysisPreview","createIterationSnapshot","newHistory","shift","previousVerdict","parseRewriteResponse","jsonResult","codeBlockMatch","fields","fieldDef","formatFieldLabel","raw","parseMethod","tryParseAsJson","markdownResult","headerPattern","matches","matchAll","headerText","startIndex","endIndex","some","s","tryParseAsMarkdown","heuristicResult","patterns","tryParseWithHeuristics","c","getNextStage","currentIndex","indexOf","canExport","buildStagePrompt","basePrompt","characterSummary","name1","String","foundPlaceholders","hasAnyPlaceholder","processedPrompt","buildStructuredPrompt","buildRefinementPrompt","instructions","parts","stageAction","getStageSchema","result","resolveSchema","setExportData","exportLines","toLocaleString","snap","generateExportData","isApiReady","getApiInfo","isReady","runStageGeneration","signal","aborted","success","userPrompt","substituteCharacterPlaceholders","useStructured","schemaName","promptLength","executeGeneration","missing","isStructured","responsePreview","validateStructuredResponse","generateRaw","processedSystemPrompt","hasSchema","userPromptLength","DOMException","rawResponse","role","ensureString","preview","generateWithCurrentSettings","ChatCompletionService","requestOptions","stream","messages","max_tokens","frequency_penalty","presence_penalty","top_p","json_schema","sendRequest","isFunction","isGenerator","Symbol","asyncIterator","generatorFn","finalText","generator","chunk","textSoFar","chunkObj","text","err","finalLength","consumeStreamGenerator","resultObj","generateWithCustomSettings","responseLength","tokenCache","Map","renderCharacterPreview","getThumbnailUrl","avatar","escapeHtml","renderFieldRow","renderDropdownItems","dropdown","selectedIndex","innerHTML","isSelected","descPreview","selectedItem","querySelector","scrollIntoView","block","DOMPurify","str","sanitize","ALLOWED_TAGS","renderPipelineNav","activeStage","hasCharacter","status","isActive","hasConnector","statusIcon","getStatusIcon","renderStageNode","handleGenerateSchema","Popup","POPUP_RESULT","show","CANCELLED","showSchemaGenerationLoading","toastr","cleaned","validation","generateSchemaFromDescription","existingOverlay","document","overlay","createElement","className","body","appendChild","remove","updateStageConfigState","container","isGenerating","promptSelect","renderPresetOptions","disabled","promptTextarea","promptContent","textContent","structuredToggle","checked","schemaSection","classList","toggle","schemaSelect","schemaTextarea","schemaContent","existingStatus","statusHtml","insertAdjacentHTML","updateSchemaValidation","validateBtn","fixBtn","formatBtn","hasContent","needsFix","updateSchemaActionButtons","runBtn","savePromptBtn","saveSchemaBtn","currentPrompt","presetPrompt","isDifferent","currentSchema","presetSchema","isValid","updateSavePresetButtons","presets","selectedId","selected","icon","formatResponse","moduleName","showdown","wrapped","Converter","tables","strikethrough","simpleLineBreaks","headerLevelStart","ghCodeBlocks","tasklists","openLinksInNewWindow","emoji","parseImgDimensions","simplifiedAutoLink","makeHtml","formatStructuredResponse","html","heroKey","heroPatterns","findHeroKey","heroValue","formatLabel","color","getScoreColor","display","Number","isInteger","toFixed","renderHero","propSchema","inferType","renderField","renderStructuredRoot","inferSchema","MAX_DEPTH","depth","hljs","json","highlighted","highlight","language","renderJson","itemSchema","every","isSimpleValue","listItems","renderBoolean","renderSimpleValue","cards","_index","titleKey","k","scoreKey","bodyKey","header","titlePart","scorePart","renderScore","renderLongText","remaining","Boolean","extra","renderCard","renderValue","renderArrayField","renderObjectField","rendered","fieldName","isEmail","renderString","title","word","isFinite","looksLikeScore","formatted","maximumFractionDigits","renderNumber","renderLoading","renderPlaceholder","renderResult","formattedContent","toLocaleTimeString","verdictBadge","accept","needs_refinement","regression","renderVerdictBadge","locked","updateResultsPanelState","nextStage","pipeline","shouldShowLoading","shouldShowResult","shouldShowPlaceholder","existingContent","existingTimestamp","newTimestamp","footer","actions","isRecommended","renderFooterActions","lockBtn","unlockBtn","renderIterationHistory","history","currentIteration","historyLoaded","listContent","renderIterationItem","verdictIcon","getVerdictIcon","verdictClass","getVerdictClass","formatVerdict","openSettingsModal","onClose","POPUP_TYPE","moment","renderPresetList","buildSettingsContent","TEXT","wide","large","allowVerticalScrolling","okButton","cancelButton","then","Promise","resolve","setTimeout","modal","getElementById","useCurrentCheckbox","customConfig","addEventListener","genSource","genModel","genTemp","genTokens","genFreq","genPres","genTopP","populateModelSelect","handleNumberInput","isInt","parseFloat","isNaN","systemPromptTextarea","systemPromptChars","resetSystemPromptBtn","refinementPromptTextarea","refinementPromptChars","resetRefinementPromptBtn","deleteBtn","target","closest","getAttribute","deletedId","findIndex","splice","deletePromptPreset","deleteSchemaPreset","refreshPresetLists","handleDeletePreset","exportPresetsBtn","importPresetsBtn","customPrompts","customSchemas","version","exportedAt","exportCustomPresets","navigator","clipboard","writeText","promptsImported","schemasImported","prompts","schemas","importPresets","readText","debugModeCheckbox","viewLogsBtn","clearLogsBtn","copyDebugBtn","logViewer","contains","refreshDebugLogs","initSettingsListeners","currentSource","sourceSelect","stSourceSelect","from","options","opt","option","src","populateSourceSelect","refreshModelSelects","promptList","schemaList","logList","logDetail","request","formatLogEntry","querySelectorAll","el","dataset","formatLogData","modelSelect","selectIdMap","openrouter","openai","claude","makersuite","google","mistralai","cohere","perplexity","groq","ai21","deepseek","custom","stSelect","o","getCharacterKey","sanitizedName","sanitizedAvatar","saveIterationHistory","localforage","setItem","characterName","characterAvatar","savedAt","historyLength","popupState","popupElement","eventCleanup","subscribeEvents","eventSource","eventTypes","handlers","updateApiStatus","updateTokenEstimate","detail","refreshSelectedCharacter","handleCharacterInvalidated","warning","charList","newIndex","oldIndex","handleCharacterDeleted","on","ONLINE_STATUS_CHANGED","MAIN_API_CHANGED","CHARACTER_EDITED","CHARACTER_DELETED","OAI_PRESET_CHANGED_AFTER","CHATCOMPLETION_SOURCE_CHANGED","CHATCOMPLETION_MODEL_CHANGED","removeListener","count","apiInfo","statusEl","textSpan","updatePipelineNav","editedId","updatedChar","updateCharacterSelect","updateAllComponents","documentClickHandler","keyboardHandler","openMainPopup","abortController","activeStageView","debouncedFunctions","buildPopupContent","abort","fn","removeEventListener","cancel","ctrlKey","metaKey","preventDefault","runSingleStage","charContainer","selectedChar","renderCharacterSelect","Fuse","searchInput","currentResults","handleSearch","currentCharData","fuse","threshold","includeScore","minMatchCharLength","query","search","limit","r","debouncedSearch","debounce","selectCharacter","charItem","fieldKey","initCharacterSelectListeners","pipelineContainer","checkbox","delete","orderedSelected","toggleStage","btn","updateStageSection","updateResultsPanel","runSelectedStages","runAllStages","confirm","AFFIRMATIVE","keepCharacter","fresh","resetPipeline","initPipelineNavListeners","stageContainer","tokenEstimate","schemaStatus","schemaValidation","tokenDisplay","tokenClass","tokens","percentage","promptDiffersFromPreset","schemaDiffersFromPreset","showFixButton","renderStageConfig","select","updateStageConfigUI","debouncedInputHandler","textarea","presetId","handleSavePromptPreset","handleSaveSchemaPreset","generated","w","handleValidateSchema","fixedJson","revalidation","handleFixSchema","handleFormatSchema","initStageConfigListeners","resultsContainer","clearStageResult","lockStageResult","unlockStageResult","previewHtml","popup","CONFIRM","applyResult","parsedFields","updatedFields","unshallowCharacter","getRequestHeaders","assign","saveResponse","fetch","method","headers","avatar_url","ok","errorText","applyRewriteToCharacter","emit","handleApplyToCharacter","canRefineResult","lastSnapshot","validateRefinement","preRefinementState","AbortController","updateIterationIndicator","updateIterationHistory","runRefinementGeneration","refinedRewrite","stageResult","completeRefinement","promptUsed","schemaUsed","runRefinement","initResultsPanelListeners","historyContainer","revertBtn","iterationIndex","restoredRewrite","trimmedHistory","revertToIteration","handleRevertToIteration","viewBtn","renderIterationViewContent","showIterationView","initIterationHistoryListeners","checkForDeletedPresetReferences","dialog","cancelBtn","click","initComponents","getItem","storedName","currentName","loadIterationHistory","getTokenCountAsync","tokenPromises","cacheKey","hash","charCodeAt","getTokenCacheKey","get","set","all","totalTokens","tokenSpan","totalSpan","updateFieldTokenCounts","canRunStage","startStage","completeStage","validatePipeline","_characterIndex","searchWrapper","existingPreview","searchEl","updateCharacterSelectState","connector","runSelectedBtn","runAllBtn","resetBtn","updatePipelineNavState","indicator","historyEl","countEl","listEl","updateIterationHistoryState","tokenEl","counts","fullPrompt","promptTokens","contextSize","round","getRefinementTokenCount","getStageTokenCount","colorClass","initPanel","renderExtensionTemplateAsync","wrapper","openBtn","debugToggle","initEventListeners","APP_READY","registerEventListeners"],"sourceRoot":""}